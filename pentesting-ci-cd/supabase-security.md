# Seguridad de Supabase

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

Seg칰n su [**p치gina de inicio**](https://supabase.com/): Supabase es una alternativa de c칩digo abierto a Firebase. Inicia tu proyecto con una base de datos Postgres, Autenticaci칩n, APIs instant치neas, Funciones de borde, Suscripciones en tiempo real, Almacenamiento e Incrustaciones vectoriales.

### Subdominio

B치sicamente, cuando se crea un proyecto, el usuario recibir치 un subdominio de supabase.co como: **`jnanozjdybtpqgcwhdiz.supabase.co`**

## **Configuraci칩n de la base de datos**

{% hint style="success" %}
**Estos datos se pueden acceder desde un enlace como `https://supabase.com/dashboard/project/<project-id>/settings/database`**
{% endhint %}

Esta **base de datos** se desplegar치 en alguna regi칩n de AWS, y para conectarse a ella ser칤a posible hacerlo conectando a: `postgres://postgres.jnanozjdybtpqgcwhdiz:[TU-CONTRASE칌A]@aws-0-us-west-1.pooler.supabase.com:5432/postgres` (esto se cre칩 en us-west-1).\
La contrase침a es una **contrase침a que el usuario haya establecido** previamente.

Por lo tanto, dado que el subdominio es conocido y se utiliza como nombre de usuario y las regiones de AWS son limitadas, podr칤a ser posible intentar **forzar la contrase침a**.

Esta secci칩n tambi칠n contiene opciones para:

* Restablecer la contrase침a de la base de datos
* Configurar agrupamiento de conexiones
* Configurar SSL: Rechazar conexiones en texto plano (por defecto est치n habilitadas)
* Configurar tama침o de disco
* Aplicar restricciones de red y prohibiciones

## Configuraci칩n de la API

{% hint style="success" %}
**Estos datos se pueden acceder desde un enlace como `https://supabase.com/dashboard/project/<project-id>/settings/api`**
{% endhint %}

La URL para acceder a la API de Supabase en tu proyecto ser치 como: `https://jnanozjdybtpqgcwhdiz.supabase.co`.

### Claves de API an칩nimas

Tambi칠n generar치 una **clave de API an칩nima** (`rol: "anon"`), como: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk` que la aplicaci칩n necesitar치 usar para contactar con la clave de API expuesta en nuestro ejemplo en&#x20;

Es posible encontrar la API REST para contactar con esta API en la [**documentaci칩n**](https://supabase.com/docs/reference/self-hosting-auth/returns-the-configuration-settings-for-the-gotrue-server), pero los endpoints m치s interesantes ser칤an:

<details>

<summary>Registro (/auth/v1/signup)</summary>
```
POST /auth/v1/signup HTTP/2
Host: id.io.net
Content-Length: 90
X-Client-Info: supabase-js-web/2.39.2
Sec-Ch-Ua: "Not-A.Brand";v="99", "Chromium";v="124"
Sec-Ch-Ua-Mobile: ?0
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36
Content-Type: application/json;charset=UTF-8
Apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
Sec-Ch-Ua-Platform: "macOS"
Accept: */*
Origin: https://cloud.io.net
Sec-Fetch-Site: same-site
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://cloud.io.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Priority: u=1, i

{"email":"test@exmaple.com","password":"SomeCOmplexPwd239."}
```
</details>

<details>

<summary>Iniciar sesi칩n (/auth/v1/token?grant_type=password)</summary>
```
POST /auth/v1/token?grant_type=password HTTP/2
Host: hypzbtgspjkludjcnjxl.supabase.co
Content-Length: 80
X-Client-Info: supabase-js-web/2.39.2
Sec-Ch-Ua: "Not-A.Brand";v="99", "Chromium";v="124"
Sec-Ch-Ua-Mobile: ?0
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36
Content-Type: application/json;charset=UTF-8
Apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTQ5OTI3MTksImV4cCI6MjAzMDU2ODcxOX0.sRN0iMGM5J741pXav7UxeChyqBE9_Z-T0tLA9Zehvqk
Sec-Ch-Ua-Platform: "macOS"
Accept: */*
Origin: https://cloud.io.net
Sec-Fetch-Site: same-site
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://cloud.io.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Priority: u=1, i

{"email":"test@exmaple.com","password":"SomeCOmplexPwd239."}
```
</details>

Entonces, cada vez que descubras a un cliente usando supabase con el subdominio que se le otorg칩 (es posible que un subdominio de la empresa tenga un CNAME sobre su subdominio de supabase), podr칤as intentar **crear una nueva cuenta en la plataforma utilizando la API de supabase**.

### Claves de API secretas / de servicio

Tambi칠n se generar치 una clave de API secreta con **`role: "service_role"`**. Esta clave de API debe ser secreta porque podr치 evitar la **Seguridad a Nivel de Fila**.

La clave de API se ve as칤: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYW5vemRyb2J0cHFnY3doZGl6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNDk5MjcxOSwiZXhwIjoyMDMwNTY4NzE5fQ.0a8fHGp3N_GiPq0y0dwfs06ywd-zhTwsm486Tha7354`

### Secreto JWT

Tambi칠n se generar치 un **Secreto JWT** para que la aplicaci칩n pueda **crear y firmar tokens JWT personalizados**.

## Autenticaci칩n

### Registros

{% hint style="success" %}
Por **defecto**, supabase permitir치 que **los nuevos usuarios creen cuentas** en tu proyecto utilizando los puntos finales de la API mencionados anteriormente.
{% endhint %}

Sin embargo, estas nuevas cuentas, por defecto, **necesitar치n validar su direcci칩n de correo electr칩nico** para poder iniciar sesi칩n en la cuenta. Es posible habilitar **"Permitir registros an칩nimos"** para permitir que las personas inicien sesi칩n sin verificar su direcci칩n de correo electr칩nico. Esto podr칤a otorgar acceso a **datos inesperados** (obtienen los roles `public` y `authenticated`).\
Esto es una muy mala idea porque supabase cobra por usuario activo, por lo que las personas podr칤an crear usuarios e iniciar sesi칩n y supabase cobrar치 por ellos:

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### Contrase침as y sesiones

Es posible indicar la longitud m칤nima de la contrase침a (por defecto), requisitos (no por defecto) y prohibir el uso de contrase침as filtradas.\
Se recomienda **mejorar los requisitos ya que los predeterminados son d칠biles**.

* Sesiones de Usuario: Es posible configurar c칩mo funcionan las sesiones de usuario (tiempos de espera, 1 sesi칩n por usuario...)
* Protecci칩n contra Bots y Abusos: Es posible habilitar Captcha.

### Configuraci칩n SMTP

Es posible configurar un SMTP para enviar correos electr칩nicos.

### Configuraciones Avanzadas

* Establecer tiempo de vencimiento para tokens de acceso (3600 por defecto)
* Establecer para detectar y revocar tokens de actualizaci칩n potencialmente comprometidos y tiempo de espera
* MFA: Indicar cu치ntos factores MFA pueden inscribirse a la vez por usuario (10 por defecto)
* Conexiones Directas M치ximas a la Base de Datos: N칰mero m치ximo de conexiones utilizadas para la autenticaci칩n (10 por defecto)
* Duraci칩n M치xima de la Solicitud: Tiempo m치ximo permitido para que una solicitud de Autenticaci칩n dure (10s por defecto)

## Almacenamiento

{% hint style="success" %}
Supabase permite **almacenar archivos** y hacerlos accesibles a trav칠s de una URL (utiliza buckets de S3).
{% endhint %}

* Establecer el l칤mite de tama침o de archivo para cargar (por defecto es 50MB)
* La conexi칩n de S3 se da con una URL como: `https://jnanozjdybtpqgcwhdiz.supabase.co/storage/v1/s3`
* Es posible **solicitar claves de acceso de S3** que est치n formadas por un `ID de clave de acceso` (por ejemplo, `a37d96544d82ba90057e0e06131d0a7b`) y una `clave de acceso secreta` (por ejemplo, `58420818223133077c2cec6712a4f909aec93b4daeedae205aa8e30d5a860628`)

## Funciones de Borde

Es posible **almacenar secretos** en supabase tambi칠n que ser치n **accesibles por funciones de borde** (pueden crearse y eliminarse desde la web, pero no es posible acceder a su valor directamente).
