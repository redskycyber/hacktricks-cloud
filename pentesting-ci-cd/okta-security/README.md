# Seguridad de Okta

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

[Okta, Inc.](https://www.okta.com/) es reconocida en el sector de gesti贸n de identidad y acceso por sus soluciones de software basadas en la nube. Estas soluciones est谩n dise帽adas para agilizar y asegurar la autenticaci贸n de usuarios en diversas aplicaciones modernas. No solo se dirigen a empresas que buscan proteger sus datos sensibles, sino tambi茅n a desarrolladores interesados en integrar controles de identidad en aplicaciones, servicios web y dispositivos.

La oferta principal de Okta es la **Okta Identity Cloud**. Esta plataforma abarca una serie de productos, que incluyen pero no se limitan a:

- **Inicio de Sesi贸n nico (SSO)**: Simplifica el acceso de usuarios al permitir un conjunto de credenciales de inicio de sesi贸n en m煤ltiples aplicaciones.
- **Autenticaci贸n Multifactor (MFA)**: Mejora la seguridad al requerir m煤ltiples formas de verificaci贸n.
- **Gesti贸n del Ciclo de Vida**: Automatiza los procesos de creaci贸n, actualizaci贸n y desactivaci贸n de cuentas de usuario.
- **Directorio Universal**: Permite la gesti贸n centralizada de usuarios, grupos y dispositivos.
- **Gesti贸n de Acceso a API**: Asegura y gestiona el acceso a las APIs.

Estos servicios tienen como objetivo fortalecer la protecci贸n de datos y agilizar el acceso de usuarios, mejorando tanto la seguridad como la conveniencia. La versatilidad de las soluciones de Okta las convierte en una opci贸n popular en diversas industrias, beneficiando tanto a grandes empresas como a peque帽as compa帽铆as y desarrolladores individuales. Hasta la 煤ltima actualizaci贸n en septiembre de 2021, Okta es reconocida como una entidad prominente en el 谩mbito de Gesti贸n de Identidad y Acceso (IAM).

{% hint style="danger" %}
El objetivo principal de Okta es configurar el acceso de diferentes usuarios y grupos a aplicaciones externas. Si logras **comprometer privilegios de administrador en un entorno de Okta**, es muy probable que puedas **comprometer todas las dem谩s plataformas que la empresa est茅 utilizando**.
{% endhint %}

{% hint style="success" %}
Para realizar una revisi贸n de seguridad de un entorno de Okta, debes solicitar **acceso de solo lectura de administrador**.
{% endhint %}

### Resumen

Existen **usuarios** (que pueden estar **almacenados en Okta**, iniciados desde **Proveedores de Identidad** configurados o autenticados a trav茅s de **Active Directory** o LDAP).\
Estos usuarios pueden estar dentro de **grupos**.\
Tambi茅n existen **autenticadores**: diferentes opciones para autenticar como contrase帽a, y varios m茅todos de autenticaci贸n de dos factores como WebAuthn, correo electr贸nico, tel茅fono, Okta Verify (pueden estar habilitados o deshabilitados)...

Luego, hay **aplicaciones** sincronizadas con Okta. Cada aplicaci贸n tendr谩 un **mapeo con Okta** para compartir informaci贸n (como direcciones de correo electr贸nico, nombres...). Adem谩s, cada aplicaci贸n debe estar dentro de una **Pol铆tica de Autenticaci贸n**, que indica los **autenticadores necesarios** para que un usuario **acceda** a la aplicaci贸n.

{% hint style="danger" %}
El rol m谩s poderoso es el de **Super Administrador**.

Si un atacante compromete Okta con acceso de Administrador, es muy probable que todas las **aplicaciones que conf铆an en Okta** sean comprometidas.
{% endhint %}

## Ataques

### Localizaci贸n del Portal de Okta

Por lo general, el portal de una empresa estar谩 ubicado en **nombredelaempresa.okta.com**. Si no es as铆, prueba con **variaciones** simples de **nombredelaempresa**. Si no puedes encontrarlo, tambi茅n es posible que la organizaci贸n tenga un registro **CNAME** como **`okta.nombredelaempresa.com`** apuntando al **portal de Okta**.

### Inicio de Sesi贸n en Okta a trav茅s de Kerberos

Si **`nombredelaempresa.kerberos.okta.com`** est谩 activo, se utiliza **Kerberos para el acceso a Okta**, generalmente evitando la **MFA** para los usuarios de **Windows**. Para encontrar usuarios de Okta autenticados con Kerberos en AD, ejecuta **`getST.py`** con los **par谩metros apropiados**. Al obtener un **ticket de usuario de AD**, **in媒ectalo** en un host controlado usando herramientas como Rubeus o Mimikatz, asegur谩ndote de que **`clientname.kerberos.okta.com` est茅 en la zona "Intranet" de las "Opciones de Internet"**. Al acceder a una URL espec铆fica, deber铆a devolver una respuesta JSON "OK", indicando la aceptaci贸n del ticket de Kerberos y otorgando acceso al panel de control de Okta.

Comprometer la **cuenta de servicio de Okta con el SPN de delegaci贸n habilitado permite un ataque de Silver Ticket**. Sin embargo, el uso de **AES** por parte de Okta para la encriptaci贸n de tickets requiere poseer la clave AES o la contrase帽a en texto plano. Utiliza **`ticketer.py` para generar un ticket para el usuario v铆ctima** y entr茅galo a trav茅s del navegador para autenticarte con Okta.

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Secuestro del Agente de AD de Okta

Esta t茅cnica implica **acceder al Agente de AD de Okta en un servidor**, que **sincroniza usuarios y maneja la autenticaci贸n**. Al examinar y descifrar configuraciones en **`OktaAgentService.exe.config`**, especialmente el AgentToken utilizando **DPAPI**, un atacante potencialmente puede **interceptar y manipular datos de autenticaci贸n**. Esto permite no solo **monitorear** y **capturar credenciales de usuario** en texto plano durante el proceso de autenticaci贸n de Okta, sino tambi茅n **responder a intentos de autenticaci贸n**, lo que permite el acceso no autorizado o proporciona autenticaci贸n universal a trav茅s de Okta (similar a una 'llave maestra').

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Secuestro de AD como Administrador

Esta t茅cnica implica secuestrar un Agente de AD de Okta obteniendo primero un C贸digo OAuth, y luego solicitando un token de API. El token est谩 asociado con un dominio AD, y se nombra un **conector para establecer un agente de AD falso**. La inicializaci贸n permite que el agente **procese intentos de autenticaci贸n**, capturando credenciales a trav茅s de la API de Okta. Hay herramientas de automatizaci贸n disponibles para agilizar este proceso, ofreciendo un m茅todo fluido para interceptar y manejar datos de autenticaci贸n dentro del entorno de Okta.

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Proveedor SAML Falso de Okta

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

La t茅cnica implica **implementar un proveedor SAML falso**. Al integrar un Proveedor de Identidad externo (IdP) dentro del marco de Okta utilizando una cuenta privilegiada, los atacantes pueden **controlar el IdP, aprobando cualquier solicitud de autenticaci贸n a voluntad**. El proceso implica configurar un IdP SAML 2.0 en Okta, manipular la URL de Inicio de Sesi贸n nico del IdP para redirigir a trav茅s del archivo de hosts local, generar un certificado autofirmado y configurar los ajustes de Okta para que coincidan con el nombre de usuario o correo electr贸nico. Al ejecutar con 茅xito estos pasos, se permite la autenticaci贸n como cualquier usuario de Okta, evitando la necesidad de credenciales de usuario individuales, elevando significativamente el control de acceso de manera potencialmente desapercibida.

### Phishing al Portal de Okta con Evilgnix

En [**esta publicaci贸n de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) se explica c贸mo preparar una campa帽a de phishing contra un portal de Okta.

### Ataque de Suplantaci贸n de Colega

Los **atributos que cada usuario puede tener y modificar** (como correo electr贸nico o nombre) se pueden configurar en Okta. Si una **aplicaci贸n** conf铆a como ID en un **atributo** que el usuario puede **modificar**, podr谩 **suplantar a otros usuarios en esa plataforma**.

Por lo tanto, si la aplicaci贸n conf铆a en el campo **`userName`**, probablemente no podr谩s cambiarlo (porque generalmente no puedes cambiar ese campo), pero si conf铆a, por ejemplo, en **`primaryEmail`**, podr铆as ser capaz de **cambiarlo por la direcci贸n de correo electr贸nico de un colega** e impersonarlo (necesitar谩s tener acceso al correo electr贸nico y aceptar el cambio).

Ten en cuenta que esta suplantaci贸n depende de c贸mo se configur贸 cada aplicaci贸n. Solo las que conf铆en en el campo que modificaste y acepten actualizaciones ser谩n comprometidas.\
Por lo tanto, la aplicaci贸n debe tener este campo habilitado si existe:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tambi茅n he visto otras aplicaciones vulnerables pero que no ten铆an ese campo en la configuraci贸n de Okta (al final, las diferentes aplicaciones se configuran de manera diferente).

La mejor manera de averiguar si podr铆as suplantar a alguien en cada aplicaci贸n ser铆a 隆intentarlo!

## Evadir pol铆ticas de detecci贸n de comportamiento <a href="#id-9fde" id="id-9fde"></a>

Las pol铆ticas de detecci贸n de comportamiento en Okta pueden ser desconocidas hasta que se encuentran, pero **burlarlas** se puede lograr **dirigi茅ndose directamente a las aplicaciones de Okta**, evitando el panel principal de Okta. Con un **token de acceso de Okta**, reproduce el token en la **URL espec铆fica de la aplicaci贸n de Okta** en lugar de la p谩gina principal de inicio de sesi贸n.

Las recomendaciones clave incluyen:

* **Evitar el uso de** proxies anonimizadores populares y servicios VPN al reproducir tokens de acceso capturados.
* Asegurar **cadenas de agente de usuario consistentes** entre el cliente y los tokens de acceso reproducidos.
* **Abstenerse de reproducir** tokens de diferentes usuarios desde la misma direcci贸n IP.
* Tener precauci贸n al reproducir tokens contra el panel de control de Okta.
* Si se conocen las direcciones IP de la empresa v铆ctima, **restringir el tr谩fico** a esas IPs o su rango, bloqueando todo otro tr谩fico.

## Fortalecimiento de Okta

Okta tiene muchas configuraciones posibles, en esta p谩gina encontrar谩s c贸mo revisarlas para que sean lo m谩s seguras posible:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referencias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
