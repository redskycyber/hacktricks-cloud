# Okta Sicherheit

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

[Okta, Inc.](https://www.okta.com/) ist im Bereich Identit√§ts- und Zugriffsverwaltung f√ºr seine cloudbasierten Softwarel√∂sungen bekannt. Diese L√∂sungen sind darauf ausgelegt, die Benutzerauthentifizierung in verschiedenen modernen Anwendungen zu vereinfachen und zu sichern. Sie richten sich nicht nur an Unternehmen, die ihre sensiblen Daten sch√ºtzen m√∂chten, sondern auch an Entwickler, die Identit√§tskontrollen in Anwendungen, Webdienste und Ger√§te integrieren m√∂chten.

Das Flaggschiffangebot von Okta ist die **Okta Identity Cloud**. Diese Plattform umfasst eine Reihe von Produkten, darunter:

- **Single Sign-On (SSO)**: Vereinfacht den Benutzerzugriff, indem ein Satz von Anmeldeinformationen f√ºr mehrere Anwendungen verwendet wird.
- **Multi-Faktor-Authentifizierung (MFA)**: Erh√∂ht die Sicherheit durch die Anforderung mehrerer Verifizierungsformen.
- **Lebenszyklus-Management**: Automatisiert den Prozess der Benutzerkontenerstellung, -aktualisierung und -deaktivierung.
- **Universelles Verzeichnis**: Erm√∂glicht die zentrale Verwaltung von Benutzern, Gruppen und Ger√§ten.
- **API-Zugriffsverwaltung**: Sichert und verwaltet den Zugriff auf APIs.

Diese Dienste zielen gemeinsam darauf ab, den Datenschutz zu st√§rken und den Benutzerzugriff zu optimieren, wodurch sowohl die Sicherheit als auch die Bequemlichkeit verbessert werden. Die Vielseitigkeit der L√∂sungen von Okta macht sie zu einer beliebten Wahl in verschiedenen Branchen, von gro√üen Unternehmen √ºber kleine Unternehmen bis hin zu einzelnen Entwicklern. Bis zum letzten Update im September 2021 wird Okta als bedeutende Entit√§t im Bereich Identit√§ts- und Zugriffsverwaltung (IAM) anerkannt.

{% hint style="danger" %}
Das Hauptziel von Okta besteht darin, den Zugriff auf verschiedene Benutzer und Gruppen auf externe Anwendungen zu konfigurieren. Wenn es Ihnen gelingt, **Administratorrechte in einer Okta**-Umgebung zu kompromittieren, werden Sie h√∂chstwahrscheinlich in der Lage sein, **alle anderen Plattformen zu kompromittieren, die das Unternehmen verwendet**.
{% endhint %}

{% hint style="success" %}
Um eine Sicherheits√ºberpr√ºfung einer Okta-Umgebung durchzuf√ºhren, sollten Sie um **Administrator-Lesezugriff** bitten.
{% endhint %}

### Zusammenfassung

Es gibt **Benutzer** (die **in Okta gespeichert** sein k√∂nnen, von konfigurierten **Identit√§tsanbietern angemeldet** oder √ºber **Active Directory** oder LDAP authentifiziert werden).\
Diese Benutzer k√∂nnen in **Gruppen** sein.\
Es gibt auch **Authentifizierer**: verschiedene Optionen zur Authentifizierung wie Passwort und verschiedene 2FA-Methoden wie WebAuthn, E-Mail, Telefon, Okta Verify (sie k√∂nnen aktiviert oder deaktiviert sein)...

Dann gibt es **Anwendungen**, die mit Okta synchronisiert sind. Jede Anwendung wird einige **Zuordnungen mit Okta** haben, um Informationen auszutauschen (wie E-Mail-Adressen, Vornamen...). Dar√ºber hinaus muss jede Anwendung in einer **Authentifizierungsrichtlinie** enthalten sein, die die **erforderlichen Authentifizierer** f√ºr einen Benutzer angibt, um auf die Anwendung zuzugreifen.

{% hint style="danger" %}
Die m√§chtigste Rolle ist der **Superadministrator**.

Wenn ein Angreifer Okta mit Administratorzugriff kompromittiert, werden h√∂chstwahrscheinlich alle **Apps, die Okta vertrauen**, kompromittiert.
{% endhint %}

## Angriffe

### Lokalisierung des Okta-Portals

Normalerweise befindet sich das Portal eines Unternehmens unter **firmenname.okta.com**. Wenn nicht, versuchen Sie einfache **Varianten** von **firmenname**. Wenn Sie es nicht finden k√∂nnen, ist es auch m√∂glich, dass die Organisation einen **CNAME**-Eintrag wie **`okta.firmenname.com`** hat, der auf das **Okta-Portal** zeigt.

### Anmeldung bei Okta √ºber Kerberos

Wenn **`firmenname.kerberos.okta.com`** aktiv ist, wird **Kerberos f√ºr den Okta-Zugriff verwendet**, wodurch in der Regel die **MFA** f√ºr **Windows**-Benutzer umgangen wird. Um Kerberos-authentifizierte Okta-Benutzer in AD zu finden, f√ºhren Sie **`getST.py`** mit **geeigneten Parametern** aus. Nach Erhalt eines **AD-Benutzertickets** injizieren Sie es in einen kontrollierten Host mithilfe von Tools wie Rubeus oder Mimikatz und stellen sicher, dass **`clientname.kerberos.okta.com` in der Internetoption "Intranet"** enthalten ist. Der Zugriff auf eine bestimmte URL sollte eine JSON "OK"-Antwort zur√ºckgeben, die die Akzeptanz des Kerberos-Tickets anzeigt und den Zugriff auf das Okta-Dashboard gew√§hrt.

Die Kompromittierung des **Okta-Dienstkontos mit der Delegierung SPN erm√∂glicht einen Silver-Ticket-Angriff**. Die Verwendung von **AES** zur Ticketverschl√ºsselung durch Okta erfordert jedoch den Besitz des AES-Schl√ºssels oder des Klartextpassworts. Verwenden Sie **`ticketer.py`**, um ein Ticket f√ºr den Opferbenutzer zu generieren, und √ºbermitteln Sie es √ºber den Browser, um sich bei Okta zu authentifizieren.

**√úberpr√ºfen Sie den Angriff unter [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Entf√ºhrung des Okta-AD-Agenten

Diese Technik beinhaltet den **Zugriff auf den Okta-AD-Agenten auf einem Server**, der Benutzer synchronisiert und die Authentifizierung verwaltet. Durch Untersuchung und Entschl√ºsselung von Konfigurationen in **`OktaAgentService.exe.config`**, insbesondere des AgentToken unter Verwendung von **DPAPI**, kann ein Angreifer potenziell **Authentifizierungsdaten abfangen und manipulieren**. Dies erm√∂glicht nicht nur das **√úberwachen** und **Erfassen von Benutzeranmeldeinformationen** im Klartext w√§hrend des Okta-Authentifizierungsprozesses, sondern auch das **Reagieren auf Authentifizierungsversuche**, wodurch unbefugter Zugriff erm√∂glicht oder eine universelle Authentifizierung √ºber Okta bereitgestellt wird (√§hnlich einem 'Generalschl√ºssel').

**√úberpr√ºfen Sie den Angriff unter [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Entf√ºhrung von AD als Administrator

Diese Technik beinhaltet die Entf√ºhrung eines Okta-AD-Agenten durch den Erhalt eines OAuth-Codes, gefolgt von der Anforderung eines API-Tokens. Das Token ist mit einer AD-Dom√§ne verbunden, und ein **Connector wird benannt, um einen falschen AD-Agenten zu etablieren**. Die Initialisierung erm√∂glicht es dem Agenten, **Authentifizierungsversuche zu verarbeiten**, indem Anmeldeinformationen √ºber die Okta-API erfasst werden. Automatisierungstools stehen zur Verf√ºgung, um diesen Prozess zu optimieren und eine nahtlose Methode zum Abfangen und Verarbeiten von Authentifizierungsdaten innerhalb der Okta-Umgebung zu bieten.

**√úberpr√ºfen Sie den Angriff unter [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Okta Fake SAML-Anbieter

**√úberpr√ºfen Sie den Angriff unter [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

Die Technik beinhaltet das **Bereitstellen eines gef√§lschten SAML-Anbieters**. Durch die Integration eines externen Identit√§tsanbieters (IdP) in das Okta-Framework mithilfe eines privilegierten Kontos k√∂nnen Angreifer den IdP **kontrollieren und jede Authentifizierungsanfrage nach Belieben genehmigen**. Der Prozess umfasst die Einrichtung eines SAML 2.0 IdP in Okta, die Manipulation der IdP Single Sign-On-URL zur Umleitung √ºber die lokale Hosts-Datei, die Generierung eines selbstsignierten Zertifikats und die Konfiguration der Okta-Einstellungen zur √úbereinstimmung mit dem Benutzernamen oder der E-Mail. Durch erfolgreiche Ausf√ºhrung dieser Schritte ist eine Authentifizierung als beliebiger Okta-Benutzer m√∂glich, ohne die Notwendigkeit individueller Benutzeranmeldeinformationen, was die Zugriffskontrolle in einer potenziell unbemerkten Weise erheblich erh√∂ht.
### Phishing Okta Portal mit Evilgnix

In [**diesem Blog-Beitrag**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) wird erkl√§rt, wie man eine Phishing-Kampagne gegen ein Okta-Portal vorbereitet.

### Kollegenimitationsangriff

Die **Attribute, die jeder Benutzer haben und √§ndern kann** (wie E-Mail oder Vorname), k√∂nnen in Okta konfiguriert werden. Wenn eine **Anwendung** als ID ein **Attribut** vertraut, das der Benutzer **√§ndern kann**, wird er in der Lage sein, **andere Benutzer auf dieser Plattform zu imitieren**.

Daher, wenn die App das Feld **`userName`** vertraut, k√∂nnen Sie es wahrscheinlich nicht √§ndern (weil Sie dieses Feld normalerweise nicht √§ndern k√∂nnen), aber wenn sie zum Beispiel **`primaryEmail`** vertraut, k√∂nnten Sie es m√∂glicherweise **in die E-Mail-Adresse eines Kollegen √§ndern** und sie imitieren (Sie m√ºssen Zugriff auf die E-Mail haben und die √Ñnderung akzeptieren).

Beachten Sie, dass diese Imitation davon abh√§ngt, wie jede Anwendung konfiguriert wurde. Nur diejenigen, die dem von Ihnen ge√§nderten Feld vertrauen und Aktualisierungen akzeptieren, werden kompromittiert sein.\
Daher sollte die App dieses Feld aktiviert haben, wenn es existiert:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Ich habe auch andere Apps gesehen, die verwundbar waren, aber dieses Feld nicht in den Okta-Einstellungen hatten (letztendlich sind verschiedene Apps unterschiedlich konfiguriert).

Der beste Weg, um herauszufinden, ob Sie sich als jemand auf jeder App ausgeben k√∂nnten, w√§re es, es auszuprobieren!

## Umgehung von Verhaltenserkennungsrichtlinien <a href="#id-9fde" id="id-9fde"></a>

Verhaltenserkennungsrichtlinien in Okta sind m√∂glicherweise unbekannt, bis sie aufgetreten sind, aber **das Umgehen** von ihnen kann erreicht werden, indem **Okta-Anwendungen direkt angegriffen** werden, um das Haupt-Okta-Dashboard zu umgehen. Mit einem **Okta-Zugriffstoken** wiederholen Sie das Token an der **anwendungsspezifischen Okta-URL** anstelle der Haupt-Login-Seite.

Zu den wichtigsten Empfehlungen geh√∂ren:

* **Vermeiden Sie die Verwendung von** beliebten Anonymisierungsproxys und VPN-Diensten beim Wiederholen erfasster Zugriffstoken.
* Stellen Sie sicher, dass **konsistente Benutzer-Agent-Strings** zwischen dem Client und den wiederholten Zugriffstoken vorhanden sind.
* **Verzichten Sie darauf**, Tokens von verschiedenen Benutzern von derselben IP-Adresse wiederzugeben.
* Seien Sie vorsichtig beim Wiederholen von Tokens gegen das Okta-Dashboard.
* Wenn Sie die IP-Adressen des Opferunternehmens kennen, **beschr√§nken Sie den Datenverkehr** auf diese IPs oder deren Bereich und blockieren Sie den gesamten anderen Datenverkehr.

## Okta-H√§rtung

Okta bietet viele m√∂gliche Konfigurationen. Auf dieser Seite finden Sie, wie Sie sie √ºberpr√ºfen k√∂nnen, damit sie so sicher wie m√∂glich sind:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referenzen

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
