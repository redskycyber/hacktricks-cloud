# Bezpieczestwo Okta

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Okta, Inc.](https://www.okta.com/) jest uznawana w sektorze zarzdzania to偶samoci i dostpem za swoje rozwizania oprogramowania oparte na chmurze. Te rozwizania s zaprojektowane w celu usprawnienia i zabezpieczenia uwierzytelniania u偶ytkownik贸w w r贸偶nych nowoczesnych aplikacjach. S one przeznaczone nie tylko dla firm, kt贸re chc chroni swoje wra偶liwe dane, ale tak偶e dla programist贸w zainteresowanych integracj kontroli to偶samoci w aplikacje, usugi internetowe i urzdzenia.

Flagowym produktem Okta jest **Okta Identity Cloud**. Ta platforma obejmuje zestaw produkt贸w, w tym midzy innymi:

* **Single Sign-On (SSO)**: Uatwia dostp u偶ytkownik贸w, pozwalajc na jedno zestawienie danych logowania do wielu aplikacji.
* **Multi-Factor Authentication (MFA)**: Wzmacnia bezpieczestwo, wymagajc wielu form weryfikacji.
* **Zarzdzanie cyklem 偶ycia**: Automatyzuje procesy tworzenia, aktualizacji i dezaktywacji kont u偶ytkownik贸w.
* **Uniwersalny katalog**: Umo偶liwia scentralizowane zarzdzanie u偶ytkownikami, grupami i urzdzeniami.
* **Zarzdzanie dostpem do interfejsu API**: Zabezpiecza i zarzdza dostpem do interfejs贸w API.

Te usugi maj na celu wzmocnienie ochrony danych i usprawnienie dostpu u偶ytkownik贸w, poprawiajc zar贸wno bezpieczestwo, jak i wygod. Elastyczno rozwiza Okta sprawia, 偶e s one popularnym wyborem w r贸偶nych bran偶ach, korzystne zar贸wno dla du偶ych przedsibiorstw, maych firm, jak i indywidualnych programist贸w. Wedug ostatniej aktualizacji z wrzenia 2021 roku, Okta jest uznawana za prominentn jednostk w dziedzinie zarzdzania to偶samoci i dostpem (IAM).

{% hint style="danger" %}
G贸wnym celem Okta jest skonfigurowanie dostpu r贸偶nym u偶ytkownikom i grupom do zewntrznych aplikacji. Jeli uda ci si **skompromitowa uprawnienia administratora w rodowisku Okta**, bardzo prawdopodobne jest, 偶e bdziesz w stanie **skompromitowa wszystkie inne platformy, kt贸rych firma u偶ywa**.
{% endhint %}

{% hint style="success" %}
Aby przeprowadzi przegld bezpieczestwa rodowiska Okta, powiniene poprosi o **tylko do odczytu uprawnienia administratora**.
{% endhint %}

### Podsumowanie

Istniej **u偶ytkownicy** (kt贸rzy mog by **przechowywani w Okta**, zalogowani z skonfigurowanych **dostawc贸w to偶samoci** lub uwierzytelniani za pomoc **Active Directory** lub LDAP).\
Ci u偶ytkownicy mog znajdowa si w **grupach**.\
Istniej r贸wnie偶 **uwierzytelniacze**: r贸偶ne opcje uwierzytelniania, takie jak haso, oraz kilka form uwierzytelniania dwuetapowego, takie jak WebAuthn, e-mail, telefon, okta verify (mog by wczone lub wyczone)...

Nastpnie s **aplikacje** zsynchronizowane z Okta. Ka偶da aplikacja bdzie miaa pewne **mapowanie z Okta**, aby udostpnia informacje (takie jak adresy e-mail, imiona...). Ponadto, ka偶da aplikacja musi znajdowa si w **polityce uwierzytelniania**, kt贸ra okrela **potrzebne uwierzytelniacze** dla u偶ytkownika, aby **uzyska dostp** do aplikacji.

{% hint style="danger" %}
Najpot偶niejsz rol jest **Super Administrator**.

Jeli atakujcy skompromituje Okta z dostpem administratora, wszystkie **aplikacje zaufane Okta** bd bardzo prawdopodobnie **skompromitowane**.
{% endhint %}

## Ataki

### Lokalizowanie portalu Okta

Zwykle portal firmy bdzie znajdowa si pod adresem **nazwafirmy.okta.com**. Jeli nie, spr贸buj prostych **wariacji** nazwy firmy. Jeli nie mo偶esz go znale藕, mo偶liwe, 偶e organizacja ma rekord **CNAME** jak **`okta.nazwafirmy.com`** wskazujcy na **portal Okta**.

### Logowanie do Okta za pomoc Kerberos

Jeli **`nazwafirmy.kerberos.okta.com`** jest aktywne, **Kerberos jest u偶ywany do dostpu do Okta**, zazwyczaj omijajc **MFA** dla u偶ytkownik贸w **Windows**. Aby znale藕 u偶ytkownik贸w Okta uwierzytelnianych za pomoc Kerberos w AD, uruchom **`getST.py`** z **odpowiednimi parametrami**. Po uzyskaniu **biletu u偶ytkownika AD**, **wstrzyknij** go do kontrolowanego hosta za pomoc narzdzi takich jak Rubeus lub Mimikatz, upewniajc si, 偶e **`nazwa_klienta.kerberos.okta.com` znajduje si w strefie "Intranet" w opcjach Internetowych**. Dostp do okrelonego adresu URL powinien zwr贸ci odpowied藕 JSON "OK", co wskazuje na akceptacj biletu Kerberos i umo偶liwia dostp do pulpitu Okta.

Skompromitowanie **konta usugi Okta z SPN delegacji umo偶liwia atak Silver Ticket.** Jednak u偶ycie Okta **AES** do szyfrowania bilet贸w wymaga posiadania klucza AES lub hasa w tekcie jawnym. U偶yj **`ticketer.py`** do wygenerowania biletu dla u偶ytkownika ofiary i dostarcz go za pomoc przegldarki, aby uwierzytelnia si w Okta.

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przechwytywanie agenta Okta AD

Ta technika polega na **dostpie do agenta Okta AD na serwerze**, kt贸ry **synchronizuje u偶ytkownik贸w i obsuguje uwierzytelnianie**. Poprzez analiz i deszyfrowanie konfiguracji w **`OktaAgentService.exe.config`**, w szczeg贸lnoci AgentToken za pomoc **DPAPI**, atakujcy mo偶e potencjalnie **przechwytywa i manipulowa danymi uwierzytelniania**. Pozwala to nie tylko na **monitorowanie** i **przechwytywanie danych uwierzytelniania** w postaci tekstu jawnego podczas procesu uwierzytelniania w Okta, ale tak偶e na **odpowiadanie na pr贸by uwierzytelniania**, umo偶liwiajc tym samym nieautoryzowany dostp lub zapewnienie uniwersalnego uwierzytelniania za porednictwem Okta (podobnie jak 'klucz uniwersalny').

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przechwytywanie AD jako administrator

Ta technika polega na przejciu agenta Okta AD poprzez najpierw uzyskanie kodu OAuth, a nastpnie 偶danie tokenu API. Token jest powizany z domen AD, a **konnektor jest nazwany w celu utworzenia faszywego agenta AD**. Inicjowanie pozwala agentowi **przetwarza pr贸by uwierzytelniania**, przechwytujc dane uwierzytelniania za pomoc interfejsu API Okta. Dostpne s narzdzia automatyzacji, kt贸re uatwiaj ten proces, oferujc pynn metod przechwytywania i obsugi danych uwierzytelniania w rodowisku Okta.

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Faszywy dostawca SAML Okta

Ta technika polega na **wdro偶eniu faszywego dostawcy SAML**. Poprzez integracj zewntrznego dostawcy to偶samoci (IdP) w ramach struktury Okta za pomoc uprzywilejowanego konta, atakujcy mo偶e **kontrolowa IdP, zatwierdzajc dowolne 偶danie uwierzytelniania wedug wasnego uznania**. Proces ten polega na skonfigurowaniu IdP SAML 2.0 w Okta, manipulowaniu adresem URL jednokrotnego logowania IdP w celu przekierowania za pomoc pliku hosts lokalnie, generowaniu certyfikatu podpisanego przez siebie oraz konfigurowaniu ustawie Okta w celu dopasowania do nazwy u偶ytkownika lub adresu e-mail. Pomylne wykonanie tych krok贸w umo偶liwia uwierzytelnianie jako dowolny u偶ytkownik Okta, omijajc konieczno posiadania indywidualnych danych uwierzytelniajcych u偶ytkownika, znaczco podnoszc kontrol dostpu w potencjalnie niezauwa偶alny spos贸b.
### Phishing Okta Portal with Evilgnix

W [**tym wpisie na blogu**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) wyjaniono, jak przygotowa kampani phishingow przeciwko portalowi Okta.

### Atak na Podr贸偶nika Su偶bowego

**Atrybuty, kt贸re ka偶dy u偶ytkownik mo偶e mie i modyfikowa** (takie jak adres e-mail czy imi) mog by skonfigurowane w Okta. Jeli **aplikacja** ufa jako ID **atrybutowi**, kt贸ry u偶ytkownik mo偶e **modyfikowa**, bdzie on m贸g **podawa si za innych u偶ytkownik贸w na tej platformie**.

Dlatego jeli aplikacja ufa polu **`userName`**, prawdopodobnie nie bdziesz w stanie go zmieni (poniewa偶 zazwyczaj nie mo偶na zmieni tego pola), ale jeli ufa na przykad polu **`primaryEmail`**, mo偶esz by w stanie **zmieni go na adres e-mail kolegi** i poda si za niego (bdziesz musia mie dostp do tego adresu e-mail i zaakceptowa zmian).

Nale偶y zauwa偶y, 偶e to podawanie si za kogo zale偶y od tego, jak zostaa skonfigurowana ka偶da aplikacja. Skompromitowane bd tylko te aplikacje, kt贸re ufaj polu, kt贸re zmodyfikowae i akceptuj aktualizacje.\
Dlatego aplikacja powinna mie to pole wczone, jeli istnieje:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Widziaem tak偶e inne aplikacje, kt贸re byy podatne, ale nie miay tego pola w ustawieniach Okta (w kocu r贸偶ne aplikacje s konfigurowane w r贸偶ny spos贸b).

Najlepszym sposobem, aby dowiedzie si, czy mo偶esz poda si za kogo na ka偶dej aplikacji, byoby to po prostu sprawdzi!

## Unikanie polityk wykrywania zachowa <a href="#id-9fde" id="id-9fde"></a>

Polityki wykrywania zachowa w Okta mog by nieznane do momentu ich napotkania, ale **obejcie** ich mo偶na osign, **celujc bezporednio w aplikacje Okta**, unikajc g贸wnego pulpitu Okta. Za pomoc **tokena dostpu Okta**, odtw贸rz token na **adresie URL specyficznym dla aplikacji Okta** zamiast na g贸wnej stronie logowania.

G贸wne zalecenia obejmuj:

* **Unikaj korzystania z** popularnych anonimizujcych serwis贸w proxy i usug VPN podczas odtwarzania przechwyconych token贸w dostpu.
* Upewnij si, 偶e **cigi identyfikator贸w u偶ytkownika s sp贸jne** midzy klientem a odtwarzanymi tokenami dostpu.
* **Powstrzymaj si od odtwarzania** token贸w r贸偶nych u偶ytkownik贸w z tego samego adresu IP.
* Bd藕 ostro偶ny podczas odtwarzania token贸w na pulpicie Okta.
* Jeli znasz adresy IP firmy ofiary, **ogranicz ruch** do tych adres贸w IP lub ich zakresu, blokujc cay inny ruch.

## Zabezpieczenia Okta

Okta ma wiele mo偶liwych konfiguracji, na tej stronie znajdziesz, jak je przejrze, aby byy jak najbardziej bezpieczne:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Odnoniki

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
