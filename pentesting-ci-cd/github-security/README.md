# Seguridad de Github

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de Github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## 驴Qu茅 es Github?

(De [aqu铆](https://kinsta.com/knowledgebase/what-is-github/)) En t茅rminos generales, **GitHub es un sitio web y un servicio basado en la nube que ayuda a los desarrolladores a almacenar y administrar su c贸digo, as铆 como a rastrear y controlar los cambios en su c贸digo**.

### Informaci贸n b谩sica

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Recon externo

Los repositorios de Github se pueden configurar como p煤blicos, privados e internos.

* **Privado** significa que **solo** las personas de la **organizaci贸n** podr谩n acceder a ellos.
* **Interno** significa que **solo** las personas de la **empresa** (una empresa puede tener varias organizaciones) podr谩n acceder a 茅l.
* **P煤blico** significa que **todo internet** podr谩 acceder a 茅l.

En caso de que conozcas el **usuario, repositorio u organizaci贸n que deseas atacar**, puedes usar **dorks de Github** para encontrar informaci贸n confidencial o buscar **filtraciones de informaci贸n confidencial en cada repositorio**.

### Dorks de Github

Github permite **buscar algo especificando como alcance un usuario, un repositorio o una organizaci贸n**. Por lo tanto, con una lista de cadenas que van a aparecer cerca de informaci贸n confidencial, puedes **buscar f谩cilmente informaci贸n confidencial potencial en tu objetivo**.

Herramientas (cada herramienta contiene su lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Filtraciones de Github

Ten en cuenta que los dorks de Github tambi茅n est谩n destinados a buscar filtraciones utilizando opciones de b煤squeda de Github. Esta secci贸n est谩 dedicada a aquellas herramientas que **descargar谩n cada repositorio y buscar谩n informaci贸n confidencial en ellos** (incluso verificando cierta profundidad de confirmaciones).

Herramientas (cada herramienta contiene su lista de expresiones regulares):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Cuando busques filtraciones en un repositorio y ejecutes algo como `git log -p`, 隆no olvides que puede haber **otras ramas con otras confirmaciones** que contengan secretos!
{% endhint %}

### Forks externos

Es posible **comprometer repositorios abusando de las solicitudes de extracci贸n**. Para saber si un repositorio es vulnerable, principalmente necesitas leer las configuraciones yaml de Github Actions. [**M谩s informaci贸n sobre esto a continuaci贸n**](./#execution-from-a-external-fork).

## Fortalecimiento de la organizaci贸n

### Privilegios de los miembros

Hay algunos **privilegios predeterminados** que se pueden asignar a los **miembros** de la organizaci贸n. Estos se pueden controlar desde la p谩gina `https://github.com/organizations/<org_name>/settings/member_privileges` o desde la [**API de Organizaciones**](https://docs.github.com/en/rest/orgs/orgs).

* **Permisos base**: Los miembros tendr谩n los permisos Ninguno/Lectura/escritura/Administrador sobre los repositorios de la organizaci贸n. Se recomienda **Ninguno** o **Lectura**.
* **Creaci贸n de repositorios bifurcados**: Si no es necesario, es mejor **no permitir** a los miembros bifurcar los repositorios de la organizaci贸n.
* **Creaci贸n de p谩ginas**: Si no es necesario, es mejor **no permitir** a los miembros publicar p谩ginas desde los repositorios de la organizaci贸n. Si es necesario, puedes permitir crear p谩ginas p煤blicas o privadas.
* **Solicitudes de acceso a integraciones**: Con esto habilitado, los colaboradores externos podr谩n solicitar acceso para que las aplicaciones de GitHub o OAuth accedan a esta organizaci贸n y sus recursos. Por lo general, se necesita, pero si no, es mejor deshabilitarlo.
  * _No pude encontrar esta informaci贸n en la respuesta de las APIs, comparte si lo haces_
* **Cambio de visibilidad del repositorio**: Si est谩 habilitado, los **miembros** con permisos de **administrador** para el **repositorio** podr谩n **cambiar su visibilidad**. Si est谩 deshabilitado, solo los propietarios de la organizaci贸n pueden cambiar las visibilidades del repositorio. Si **no** quieres que las personas hagan cosas **p煤blicas**, aseg煤rate de que esto est茅 **deshabilitado**.
  * _No pude encontrar esta informaci贸n en la respuesta de las APIs, comparte si lo haces_
* **Eliminaci贸n y transferencia de repositorios**: Si est谩 habilitado, los miembros con permisos de **administrador** para el repositorio podr谩n **eliminar** o **transferir** repositorios **p煤blicos y privados**.
  * _No pude encontrar esta informaci贸n en la respuesta de las APIs, comparte si lo haces_
* **Permitir que los miembros creen equipos**: Si est谩 habilitado, cualquier **miembro** de la organizaci贸n podr谩 **crear** nuevos **equipos**. Si est谩 deshabilitado, solo los propietarios de la organizaci贸n pueden crear nuevos equipos. Es mejor tener esto deshabilitado.
  * _No pude encontrar esta informaci贸n en la respuesta de las APIs, comparte si lo haces_
* **Se pueden configurar m谩s cosas** en esta p谩gina, pero las anteriores son las m谩s relacionadas con la seguridad.

### Configuraci贸n de acciones

Se pueden configurar varias opciones de seguridad relacionadas con las acciones desde la p谩gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Ten en cuenta que todas estas configuraciones tambi茅n se pueden establecer en cada repositorio de forma independiente.
{% endhint %}

* **Pol铆ticas
### Con credenciales de usuario

Si ya tienes credenciales de un usuario dentro de una organizaci贸n, puedes **iniciar sesi贸n** y verificar qu茅 **roles de organizaci贸n y empresa tienes**, si eres un miembro crudo, verificar qu茅 **permisos tienen los miembros crudos**, en qu茅 **grupos** est谩s, qu茅 **permisos tienes** sobre qu茅 **repositorios** y **c贸mo est谩n protegidos los repositorios**.

Ten en cuenta que **se puede usar 2FA**, por lo que solo podr谩s acceder a esta informaci贸n si tambi茅n puedes **pasar esa verificaci贸n**.

{% hint style="info" %}
Ten en cuenta que si **logras robar la cookie `user_session`** (actualmente configurada con SameSite: Lax), puedes **suplantar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

Revisa la secci贸n a continuaci贸n sobre [**bypasses de protecci贸n de rama**](./#bypass-de-protecci贸n-de-rama) en caso de que sea 煤til.

### Con clave SSH de usuario

Github permite que los **usuarios** establezcan **claves SSH** que se utilizar谩n como **m茅todo de autenticaci贸n para implementar c贸digo** en su nombre (no se aplica 2FA).

Con esta clave, puedes realizar **cambios en los repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de Github para enumerar el entorno. Sin embargo, puedes obtener **configuraciones locales** para obtener informaci贸n sobre los repositorios y el usuario al que tienes acceso:

```bash
# Ir a la carpeta del repositorio
# Obtener la configuraci贸n del repositorio y el nombre de usuario y correo electr贸nico actual
git config --list
```

Si el usuario ha configurado su nombre de usuario como su nombre de usuario de Github, puedes acceder a las **claves p煤blicas que ha establecido** en su cuenta en _https://github.com/\<github\_username>.keys_, puedes verificar esto para confirmar que la clave privada que encontraste se puede usar.

Las **claves SSH** tambi茅n se pueden establecer en los repositorios como **claves de implementaci贸n**. Cualquier persona con acceso a esta clave podr谩 **lanzar proyectos desde un repositorio**. Por lo general, en un servidor con diferentes claves de implementaci贸n, el archivo local **`~/.ssh/config`** te dar谩 informaci贸n sobre la clave relacionada.

#### Claves GPG

Como se explica [**aqu铆**](broken-reference/), a veces es necesario firmar los commits o podr铆as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:

```shell
gpg --list-secret-keys --keyid-format=long
```

### Con token de usuario

Para obtener una introducci贸n sobre [**tokens de usuario, verifica la informaci贸n b谩sica**](basic-github-information.md#personal-access-tokens).

Se puede usar un token de usuario **en lugar de una contrase帽a** para Git sobre HTTPS, o se puede usar para [**autenticarse en la API mediante autenticaci贸n b谩sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependiendo de los privilegios adjuntos, es posible que pueda realizar diferentes acciones.

Un token de usuario se ve as铆: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Con aplicaci贸n Oauth

Para obtener una introducci贸n sobre [**aplicaciones Oauth de Github, verifica la informaci贸n b谩sica**](basic-github-information.md#oauth-applications).

Un atacante podr铆a crear una **aplicaci贸n Oauth maliciosa** para acceder a datos / acciones privilegiados de los usuarios que los aceptan, probablemente como parte de una campa帽a de phishing.

Estos son los [alcances que una aplicaci贸n Oauth puede solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Siempre se debe verificar los alcances solicitados antes de aceptarlos.

Adem谩s, como se explica en la informaci贸n b谩sica, **las organizaciones pueden otorgar / denegar acceso a aplicaciones de terceros** a informaci贸n / repositorios / acciones relacionados con la organizaci贸n.

### Con aplicaci贸n Github

Para obtener una introducci贸n sobre [**aplicaciones de Github, verifica la informaci贸n b谩sica**](basic-github-information.md#github-applications).

Un atacante podr铆a crear una **aplicaci贸n Github maliciosa** para acceder a datos / acciones privilegiados de los usuarios que los aceptan, probablemente como parte de una campa帽a de phishing.

Adem谩s, como se explica en la informaci贸n b谩sica, **las organizaciones pueden otorgar / denegar acceso a aplicaciones de terceros** a informaci贸n / repositorios / acciones relacionados con la organizaci贸n.

## Abusando de Github Action

Para obtener una introducci贸n sobre [**Github Actions, verifica la informaci贸n b谩sica**](basic-github-information.md#github-actions).

En caso de que puedas **ejecutar acciones de Github arbitrarias** en un **repositorio**, puedes **robar los secretos de ese repositorio**.

### Ejecuci贸n desde la creaci贸n del repositorio

En caso de que los miembros de una organizaci贸n puedan **crear nuevos repositorios** y puedas ejecutar acciones de Github, puedes **crear un nuevo repositorio y robar los secretos establecidos a nivel de organizaci贸n**.

### Ejecuci贸n desde una nueva rama

Si puedes **crear una nueva rama en un repositorio que ya contiene una acci贸n de Github** configurada, puedes **modificarla**, **cargar** el contenido y luego **ejecutar esa acci贸n desde la nueva rama**. De esta manera, puedes **filtrar secretos a nivel de repositorio y organizaci贸n** (pero necesitas saber c贸mo se llaman).

Puedes hacer que la acci贸n modificada sea ejecutable **manualmente**, cuando se **crea una solicitud de extracci贸n** o cuando se **env铆a alg煤n c贸digo** (dependiendo de cu谩n ruidoso quieras ser):

```yaml
on:
  workflow_dispatch: # Ejecutar manualmente
  pull_request: # Ejecutar cuando se crea una solicitud de extracci贸n a una rama
    branches:
      - master
  push: # Ejecutar cuando se realiza un push a una rama
    branches:
      - current_branch_name

# Usa '**' en lugar de un nombre de rama para activar la acci贸n en todas las ramas
```

### Ejecuci贸n desde un fork externo

Si un repositorio est谩 utilizando acciones de Github, un atacante podr铆a **crear una solicitud de extracci贸n desde un repositorio bifurcado** inyectando **c贸digo malicioso** en el **flujo de trabajo** de Github, y podr铆a **comprometer el repositorio de Github** de esa manera.

#### `pull_request`

El desencadenador de flujo de trabajo **`pull_request`** por defecto **evita los permisos de escritura** y el **acceso a secretos** en el repositorio de destino. Adem谩s, por defecto, si es la **primera vez** que est谩s **colaborando**, alg煤n **mantenedor** deber谩 **aprobar** la **ejecuci贸n** del flujo de trabajo:

<figure><img src="../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Como la limitaci贸n **predeterminada** es para **contribuyentes de primera vez**, podr铆as contribuir **solucionando un error v谩lido** y luego enviar **otras solicitudes de extracci贸n para abusar de tus nuevos privilegios de `pull_request`**.

**Prob茅 esto y no funciona**: ~~Otra opci贸n ser铆a crear una cuenta con el nombre de alguien que contribuy贸 al proyecto y elimin贸 su cuenta.~~
{% endhint %}

Sin embargo, para **evitar** la **compromiso** del **repositorio** a trav茅s de **`pull_request`**, esto se menciona en la [**documentaci贸n**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Con la excepci贸n de `GITHUB_TOKEN`, **no se pasan secretos al runner** cuando se activa un flujo de trabajo desde un repositorio bifurcado. El **`GITHUB_TOKEN` tiene permisos de solo lectura** en las solicitudes de extracci贸n **de los repositorios bifurcados**.

Un atacante podr铆a modificar la definici贸n de la Acci贸n de Github para ejecutar cosas arbitrarias y agregar acciones arbitrarias. Sin embargo, no podr谩 robar secretos o sobrescribir el repositorio debido a las limitaciones mencionadas.

Sin embargo, incluso si la acci贸n no menciona Artefactos, 驴podr铆a modificar un Artefacto del repositorio cambiando la acci贸n?? (TODO).

{% hint style="danger" %}
**S铆, si el atacante cambia en la PR la acci贸n de Github que se activar谩, su Acci贸n de Github ser谩 la que se usar谩 y no la del repositorio de origen.**
{% endhint %}

_Sin embargo, enviar una nueva acci贸n que se activa en pull\_request no se activar谩._
#### **`pull_request_target`**

Sin embargo, el desencadenador de flujo de trabajo **`pull_request_target`** tiene **permiso de escritura** en el repositorio de destino y **acceso a secretos** (y no solicita permiso).

Tenga en cuenta que el desencadenador de flujo de trabajo **`pull_request_target`** se ejecuta en el contexto base y no en el proporcionado por el PR (para no ejecutar c贸digo no confiable). Para obtener m谩s informaci贸n sobre `pull_request_target`, [**consulte la documentaci贸n**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target).\
Adem谩s, para obtener m谩s informaci贸n sobre este uso peligroso espec铆fico, consulte este [**post del blog de Github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Puede parecer que debido a que el flujo de trabajo ejecutado es el definido en la base y no en el PR, es seguro usar **`pull_request_target`**, pero hay algunos casos en los que no lo es.

#### Inyecci贸n de script a trav茅s de variables controladas por el atacante

Github establece [variables de entorno predeterminadas](https://docs.github.com/en/actions/learn-github-actions/environment-variables) y si se utilizan contextos, [incluye m谩s](https://docs.github.com/en/actions/learn-github-actions/contexts#github-context). Si alguno de esos **valores** se utiliza en un lugar **peligroso** dentro del flujo de trabajo y puede ser **controlado por el atacante**, podr铆a producirse una **inyecci贸n de comandos**.\
Esta vulnerabilidad tambi茅n se [**explica m谩s adelante en esta publicaci贸n**](./#understanding-the-risk-of-script-injections).

#### Ejecuci贸n de checkout no confiable

Si la v铆ctima est谩 usando **`pull_request`** o similar para desencadenar la acci贸n, no se aceptar谩 ning煤n PR de un fork **hasta que sea aprobado espec铆ficamente**. La acci贸n se ejecutar谩 entonces en el contexto del PR (bueno porque eso significa que ejecutar谩 el c贸digo dentro del fork de PR), pero **alguien debe aprobarlo primero**.

Si la v铆ctima configur贸 el checkout para usar expl铆citamente el desencadenador **`pull_request_target`**, siempre se ejecutar谩, pero utilizando el c贸digo del repositorio base (no el del PR), por lo que el atacante no puede controlar el c贸digo ejecutado.\
Sin embargo, si la acci贸n tiene un **checkout expl铆cito de PR** que **obtendr谩 el c贸digo del PR** (y no de la base), se utilizar谩 el c贸digo controlado por el atacante. Por ejemplo (ver l铆nea 12 donde se descarga el c贸digo PR):

```yaml
# INSEGURO. Proporcionado solo como ejemplo.
on:
  pull_request_target

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - uses: actions/setup-node@v1
    - run: |
        npm install
        npm build

    - uses: completely/fakeaction@v2
      with:
        arg1: ${{ secrets.supersecret }}

    - uses: fakerepo/comment-on-pr@v1
      with:
        message: |
          Thank you!
```

El c贸digo potencialmente **no confiable se est谩 ejecutando durante `npm install` o `npm build`** ya que los scripts de compilaci贸n y los paquetes de referencia est谩n controlados por el autor del PR.

{% hint style="danger" %}
Si la acci贸n se ejecuta en un runner autohospedado, el atacante podr铆a ser capaz de comprometerlo a煤n m谩s.
{% endhint %}

Un dork de Github para buscar acciones vulnerables es: `event.pull_request pull_request_target extension:yml`, sin embargo, hay diferentes formas de configurar los trabajos para que se ejecuten de manera segura incluso si la acci贸n est谩 configurada de manera insegura (como usar condicionales sobre qui茅n es el actor que genera el PR).

### Inyecci贸n/Backdoor de Github Action

En caso de que de alguna manera haya logrado **infiltrarse dentro de una Github Action**, si puede escalar privilegios, puede **robar secretos de los procesos donde se han establecido secretos**. En algunos casos, ni siquiera es necesario escalar privilegios.

```bash
cat /proc/<proc_number>/environ
cat /proc/*/environ | grep -i secret #Suponiendo que el nombre de la variable de entorno contiene "secret"
```

### Acceso de Github Action a AWS y GCP a trav茅s de OIDC

Consulte las siguientes p谩ginas:

{% content-ref url="../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Informaci贸n sensible en los registros de Github Actions

Incluso si **Github** intenta **detectar valores secretos** en los registros de acciones y **evitar mostrarlos**, **otros datos sensibles** que podr铆an haberse generado en la ejecuci贸n de la acci贸n no se ocultar谩n. Por ejemplo, un JWT firmado con un valor secreto no se ocultar谩 a menos que se [configure espec铆ficamente](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### GITHUB\_TOKEN

Este "**secreto**" (proveniente de `${{ secrets.GITHUB_TOKEN }}` y `${{ github.token }}`) se da por **defecto** permisos de lectura y **escritura** **al repositorio**. Este token es el mismo que usar谩 una **aplicaci贸n de Github**, por lo que puede acceder a los mismos endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github deber铆a lanzar un [**flujo**](https://github.com/github/roadmap/issues/74) que permita el acceso **entre repositorios** dentro de GitHub, para que un repositorio pueda acceder a otros repositorios internos usando el `GITHUB_TOKEN`.
{% endhint %}

Puede ver los posibles **permisos** de este token en: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Tenga en cuenta que el token **caduca despu茅s de que se completa el trabajo**.\
Estos tokens se ven as铆: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Algunas cosas interesantes que puede hacer con este token:

```bash
# Merge PR
curl -X PUT \
    https://api.github.com
#### Ejemplo de ataque de inyecci贸n de script <a href="#example-of-a-script-injection-attack" id="example-of-a-script-injection-attack"></a>

Un ataque de inyecci贸n de script puede ocurrir directamente dentro del script en l铆nea de un flujo de trabajo. En el siguiente ejemplo, una acci贸n utiliza una **expresi贸n para probar la validez del t铆tulo de una solicitud de extracci贸n**, pero tambi茅n agrega el riesgo de inyecci贸n de script:

```yaml
      - name: Check PR title
        run: |
          title="${{ github.event.pull_request.title }}"
          if [[ $title =~ ^octocat ]]; then
          echo "PR title starts with 'octocat'"
          exit 0
          else
          echo "PR title did not start with 'octocat'"
          exit 1
          fi
```

Antes de que se ejecute el script de shell, las expresiones dentro de `${{ }}` se **eval煤an** y luego se sustituyen por los valores resultantes, lo que puede hacerlo **vulnerable a la inyecci贸n de comandos de shell**.

Para inyectar comandos en este flujo de trabajo, el atacante podr铆a crear una solicitud de extracci贸n con un t铆tulo de `a"; ls $GITHUB_WORKSPACE"`:

![Ejemplo de inyecci贸n de script en el t铆tulo de la solicitud de extracci贸n](https://docs.github.com/assets/cb-24920/images/help/images/example-script-injection-pr-title.png)

En este ejemplo, el car谩cter `"` se utiliza para interrumpir la declaraci贸n `title="${{ github.event.pull_request.title }}"`, permitiendo que se ejecute el comando `ls` en el runner. Puede ver la salida del comando `ls` en el registro:

![Ejemplo de resultado de inyecci贸n de script](https://docs.github.com/assets/cb-28350/images/help/images/example-script-injection-result.png)

### Acceso a secretos <a href="#accessing-secrets" id="accessing-secrets"></a>

Si est谩 inyectando contenido en un script, es interesante saber c贸mo puede acceder a secretos:

* Si el secreto o token se establece en una **variable de entorno**, se puede acceder directamente a trav茅s del entorno usando **`printenv`**.
* Si el secreto se utiliza **directamente en una expresi贸n**, el script de shell generado se almacena **en disco** y es accesible.
*   Para una **acci贸n personalizada**, el riesgo puede variar seg煤n c贸mo un programa est茅 utilizando el secreto que obtuvo del **argumento**:

    ```
    uses: fakeaction/publish@v3
    with:
        key: ${{ secrets.PUBLISH_KEY }}
    ```

### Abuso de runners autohospedados

La forma de encontrar qu茅 **Acciones de Github se est谩n ejecutando en infraestructura no-Github** es buscar `runs-on: self-hosted` en la configuraci贸n yaml de la Acci贸n de Github.

Los runners **autohospedados** podr铆an tener acceso a **informaci贸n extra sensible**, a otros **sistemas de red** (驴puntos finales vulnerables en la red? 驴servicio de metadatos?) o, aunque est茅 aislado y destruido, **m谩s de una acci贸n podr铆a ejecutarse al mismo tiempo** y la malintencionada podr铆a **robar los secretos** de la otra.

### Envenenamiento de cach茅

Usar la acci贸n de Git [**action/cache**](https://github.com/actions/cache) en cualquier CI ejecutar谩 dos pasos: un paso tendr谩 lugar durante la **ejecuci贸n** del proceso cuando se llama y el otro tendr谩 lugar despu茅s del **flujo de trabajo** (si la acci贸n de ejecuci贸n devolvi贸 un cache-miss).

* **Acci贸n de ejecuci贸n** - se utiliza para buscar y recuperar la cach茅. La b煤squeda se realiza utilizando la clave de cach茅, y el resultado es una cach茅-hit (茅xito, se encontraron datos en la cach茅) o una cach茅-miss. Si se encuentra, los archivos y directorios se recuperan de la cach茅 para su uso activo. Si el resultado es una cach茅-miss, los archivos y directorios deseados se descargan como si fuera la primera vez que se llaman.
* **Acci贸n posterior al flujo de trabajo** - se utiliza para guardar la cach茅. Si el resultado de la llamada de cach茅 en la acci贸n de ejecuci贸n devuelve una cach茅-miss, esta acci贸n guardar谩 el estado actual de los directorios que queremos cachear con la clave proporcionada. Esta acci贸n se produce autom谩ticamente y no necesita ser llamada expl铆citamente.

Las **restricciones de acceso** proporcionan **aislamiento de cach茅** y seguridad al crear un **l铆mite l贸gico entre diferentes ramas** _(por ejemplo: una cach茅 creada para la rama **Feature-A** \[con la base principal] no ser铆a accesible para una solicitud de extracci贸n para la rama **Feature-B** \[con la base principal])_.

La acci贸n de cach茅 primero busca aciertos de cach茅 para una clave y restaura las claves en la rama que contiene la **ejecuci贸n del flujo de trabajo**. Si no hay aciertos en la rama actual, la acci贸n de cach茅 busca la clave y restaura las claves en la rama principal y las ramas ascendentes.

El acceso a una cach茅 est谩 limitado por rama (actual y principal), lo que significa que se proporciona acceso a todos los **flujos de trabajo** en todas las **ejecuciones** de dicha rama.

Otro dato importante es que GitHub no permite modificaciones una vez que se han enviado las entradas: las entradas de cach茅 son registros de solo lectura.

Utilizamos un ejemplo de CI que inclu铆a dos flujos de trabajo. Este ejemplo muestra c贸mo un ataque puede pivotar desde un flujo de trabajo de baja permisi贸n a uno de alta permisi贸n.

* **Flujo de trabajo de prueba unitaria** que ejecuta herramientas de prueba unitaria y cobertura de c贸digo. Suponemos que una de las herramientas es maliciosa o vulnerable a la ejecuci贸n remota de c贸digo. El flujo de trabajo no necesita usar la acci贸n de Git **action/cache**. Cualquier flujo de trabajo puede acceder a la cach茅.
* **Flujo de trabajo de lanzamiento** que construye y lanza el artefacto de la aplicaci贸n. Este flujo de trabajo utiliza una cach茅 para optimizar el uso de las dependencias de Golang.

El flujo de trabajo de **prueba unitaria** utiliza una acci贸n maliciosa que agrega una entrada de cach茅 con contenido malicioso cambiando una biblioteca de registro de Golang (**go.uber.org/zap@v1**) para agregar la cadena 'BAD library' a la descripci贸n del artefacto de la aplicaci贸n.

A continuaci贸n, el flujo de trabajo de **lanzamiento** utiliza esta entrada de cach茅 envenenada. Como resultado, el c贸digo malicioso se inyecta en el binario y la imagen de Golang construida. La cach茅 permanece envenenada hasta que se descarta la clave de entrada (generalmente desencadenada por actualizaciones de dependencias). La misma cach茅 envenenada afectar谩 a cualquier otro **flujo de trabajo**, **ejecuci贸n** y **rama secundaria** que utilice la misma clave de cach茅.

En la prueba que realizamos, logramos inyectar la cadena 'BAD library' en la descripci贸n de la imagen:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Esto fue en la versi贸n 0.4.1. A continuaci贸n, actualizamos la etiqueta y reconstruimos la imagen varias veces, y observamos que 'Bad library' segu铆a en la descripci贸n.

Esta t茅cnica fue tomada de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

### Envenenamiento de artefactos

Hay varias acciones de Github que permiten **descargar artefactos de otros repositorios**. Estos otros repositorios suelen tener una acci贸n de Github para **subir el artefacto** que luego se descargar谩.\
Si la **acci贸n de Github** del repositorio que carga el artefacto permite el **`pull_request`** o **`pull_request_target`** (usando el c贸digo del atacante), un atacante podr谩 activar la acci贸n que cargar谩 un artefacto creado a partir de su c贸digo, por lo que cualquier otro repositorio que descargue y ejecute el 煤ltimo artefacto ser谩 comprometido.

{% hint style="info" %}
Como se mencion贸 en una secci贸n de esta publicaci贸n, las **`pull_requests`** suelen **requerir una aprobaci贸n manual** de un mantenedor del repositorio.
{% endhint %}

Ejemplo de **descarga de artefactos de un repositorio diferente**:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Como se mencion贸 anteriormente, en un desencadenador de **`pull_request`**, la acci贸n definida en la PR es la que se ejecuta. Por lo tanto, un **atacante** podr铆a **definir** all铆 la **carga de artefactos** que le gustar铆a comprometer.

Por lo tanto, un atacante no necesita atacar un desencadenador de **`pull_request`** en la acci贸n de carga de artefactos, sino simplemente cualquier desencadenador de **`pull_request`**.
{% endhint %}

Para obtener m谩s informaci贸n y opciones de defensa (como codificar en duro el artefacto a descargar), consulte [https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust](https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust)
### Secuestro de repositorio de espacio de nombres eliminado

Este es un buen art铆culo para leer sobre vulnerabilidades corregidas que permitir铆an a un atacante robar un espacio de nombres eliminado para robar un repositorio famoso (potencialmente debido a un cambio de nombre del espacio de nombres): [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

### Registro de im谩genes Docker de Github

Es posible hacer acciones de Github que **compilen y almacenen una imagen Docker dentro de Github**.\
Un ejemplo se puede encontrar en el siguiente desplegable:

<details>

<summary>Acci贸n de Github para compilar y subir una imagen Docker</summary>

```yaml
[...]

- name: Set up Docker Buildx
  uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
  uses: docker/login-action@v1
  with:
    registry: ghcr.io
    username: ${{ github.repository_owner }}
    password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
  run: |
    sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
  uses: docker/build-push-action@v2
    with:
      context: .
      push: true
      tags: |
        ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
        ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```

</details>

Como se puede ver en el c贸digo anterior, el registro de Github est谩 alojado en **`ghcr.io`**.

Un usuario con permisos de lectura sobre el repositorio podr谩 descargar la imagen Docker usando un token de acceso personal:

```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```

Luego, el usuario podr铆a buscar **secretos filtrados en las capas de la imagen Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

## Bypass de protecci贸n de rama

* **Requerir un n煤mero de aprobaciones**: Si compromete varias cuentas, puede aceptar sus PR desde otras cuentas. Si solo tiene la cuenta desde la que cre贸 el PR, no puede aceptar su propio PR. Sin embargo, si tiene acceso a un entorno de **Github Action** dentro del repositorio, usando el **GITHUB\_TOKEN** podr铆a **aprobar su PR** y obtener 1 aprobaci贸n de esta manera.
  * _Nota para esto y para la restricci贸n de propietarios de c贸digo que generalmente un usuario no podr谩 aprobar sus propios PR, pero si lo hace, puede abusar de 茅l para aceptar sus PR._
* **Descartar aprobaciones cuando se empujan nuevos commits**: Si esto no est谩 configurado, puede enviar c贸digo leg铆timo, esperar a que alguien lo apruebe y poner c贸digo malicioso y fusionarlo en la rama protegida.
* **Requerir revisiones de los propietarios de c贸digo**: Si est谩 activado y es un propietario de c贸digo, podr铆a hacer que una **Github Action cree su PR y luego lo apruebe usted mismo**.
  * Cuando un archivo **CODEOWNER est谩 mal configurado**, Github no se queja pero no lo usa. Por lo tanto, si est谩 mal configurado, **no se aplica la protecci贸n de propietarios de c贸digo**.
* **Permitir que actores espec铆ficos eviten los requisitos de solicitud de extracci贸n**: Si es uno de estos actores, puede evitar las protecciones de solicitud de extracci贸n.
* **Incluir administradores**: Si esto no est谩 configurado y es administrador del repositorio, puede evitar estas protecciones de rama.
* **Secuestro de PR**: Podr铆a ser capaz de **modificar el PR de otra persona** agregando c贸digo malicioso, aprobando el PR resultante usted mismo y fusionando todo.
* **Eliminaci贸n de protecciones de rama**: Si es un **administrador del repositorio, puede desactivar las protecciones**, fusionar su PR y volver a establecer las protecciones.
* **Bypass de protecciones de empuje**: Si un repositorio **solo permite que ciertos usuarios** env铆en empujes (fusionar c贸digo) en ramas (la protecci贸n de rama podr铆a estar protegiendo todas las ramas especificando el comod铆n `*`).
  * Si tiene **permisos de escritura sobre el repositorio pero no se le permite enviar c贸digo** debido a la protecci贸n de la rama, a煤n puede **crear una nueva rama** y dentro de ella crear una **Github Action que se activa cuando se empuja c贸digo**. Como la **protecci贸n de rama no proteger谩 la rama hasta que se cree**, este primer empuje de c贸digo a la rama **ejecutar谩 la acci贸n de Github**.

## Bypass de protecciones de entornos

Para una introducci贸n sobre [**Github Environment, consulte la informaci贸n b谩sica**](basic-github-information.md#git-environments).

En caso de que se pueda **acceder a un entorno desde todas las ramas**, no est谩 **protegido** y puede acceder f谩cilmente a los secretos dentro del entorno. Tenga en cuenta que puede encontrar repositorios donde **todas las ramas est谩n protegidas** (especificando sus nombres o usando `*`) en ese escenario, **encuentre una rama donde pueda enviar c贸digo** y puede **filtrar** los secretos creando una nueva acci贸n de Github (o modificando una).

Tenga en cuenta que puede encontrar el caso extremo donde **todas las ramas est谩n protegidas** (a trav茅s del comod铆n `*`) se especifica **qui茅n puede enviar c贸digo a las ramas** (_puede especificarlo en la protecci贸n de la rama_) y **su usuario no est谩 permitido**. Todav铆a puede ejecutar una acci贸n personalizada de Github porque puede crear una rama y usar el disparador de empuje sobre s铆 misma. La **protecci贸n de la rama permite el empuje a una nueva rama, por lo que se activar谩 la acci贸n de Github**.

```yaml
  push: # Ejec煤telo cuando se realiza un empuje a una rama
    branches:
      - current_branch_name #Use '**' para ejecutar cuando se realiza un empuje a cualquier rama
```

Tenga en cuenta que **despu茅s de la creaci贸n** de la rama, la **protecci贸n de la rama se aplicar谩 a la nueva rama** y no podr谩 modificarla, pero para ese momento ya habr谩 filtrado los secretos.

## Persistencia

* Generar un **token de usuario**
* Robar **tokens de Github** de **secretos**
  * **Eliminaci贸n** de **resultados** de flujo de trabajo y **ramas**
* Dar **m谩s permisos a toda la organizaci贸n**
* Crear **webhooks** para filtrar informaci贸n
* Invitar a **colaboradores externos**
* **Eliminar** **webhooks** utilizados por el **SIEM**
* Crear/modificar **Github Action con una puerta trasera**
* Encontrar una **Github Action vulnerable a la inyecci贸n de comandos** a trav茅s de la modificaci贸n del valor **secreto**

### Commits de impostores - Puerta trasera a trav茅s de los commits del repositorio

En Github es posible **crear un PR a un repositorio desde un fork**. Incluso si el PR **no es aceptado**, se crear谩 un id de **commit** dentro del repositorio original para la versi贸n de fork del c贸digo. Por lo tanto, un atacante **podr铆a fijarse en usar un commit espec铆fico de un repositorio aparentemente leg铆timo que no fue creado por el propietario del repositorio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):

```yaml
name: example
on: [push]
jobs:
 commit:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
     - shell: bash
       run: |
         echo 'hello world!'
```

Para obtener m谩s informaci贸n, consulte [https://www.chainguard.dev/unchained/what-the-fork-imposter-comm