# Seguridad en Github

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Qu칠 es Github

(De [aqu칤](https://kinsta.com/knowledgebase/what-is-github/)) A un nivel alto, **Github es un sitio web y servicio basado en la nube que ayuda a los desarrolladores a almacenar y gestionar su c칩digo, as칤 como a rastrear y controlar los cambios en su c칩digo**.

### Informaci칩n B치sica

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconocimiento Externo

Los repositorios de Github pueden configurarse como p칰blicos, privados e internos.

* **Privado** significa que **solo** las personas de la **organizaci칩n** podr치n acceder a ellos.
* **Interno** significa que **solo** las personas de la **empresa** (una empresa puede tener varias organizaciones) podr치n acceder a 칠l.
* **P칰blico** significa que **todo internet** podr치 acceder a 칠l.

En caso de que conozcas el **usuario, repositorio u organizaci칩n que quieres atacar**, puedes usar **github dorks** para encontrar informaci칩n sensible o buscar **fugas de informaci칩n sensible** **en cada repositorio**.

### Github Dorks

Github permite **buscar algo especificando como 치mbito un usuario, un repositorio o una organizaci칩n**. Por lo tanto, con una lista de cadenas que van a aparecer cerca de informaci칩n sensible, puedes f치cilmente **buscar informaci칩n sensible potencial en tu objetivo**.

Herramientas (cada herramienta contiene su lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Fugas en Github

Por favor, ten en cuenta que los github dorks tambi칠n est치n destinados a buscar fugas utilizando las opciones de b칰squeda de github. Esta secci칩n est치 dedicada a aquellas herramientas que **descargar치n cada repositorio y buscar치n informaci칩n sensible en ellos** (incluso comprobando cierta profundidad de commits).

Herramientas (cada herramienta contiene su lista de expresiones regulares):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Cuando busques fugas en un repositorio y ejecutes algo como `git log -p`, no olvides que puede haber **otras ramas con otros commits** que contengan secretos.
{% endhint %}

### Forks Externos

Es posible **comprometer repositorios abusando de las pull requests**. Para saber si un repositorio es vulnerable, principalmente necesitas leer las configuraciones yaml de Github Actions. [**M치s informaci칩n sobre esto a continuaci칩n**](./#execution-from-a-external-fork).

## Fortalecimiento de la Organizaci칩n

### Privilegios de los Miembros

Hay algunos **privilegios predeterminados** que se pueden asignar a los **miembros** de la organizaci칩n. Estos se pueden controlar desde la p치gina `https://github.com/organizations/<org_name>/settings/member_privileges` o desde la [**API de Organizaciones**](https://docs.github.com/en/rest/orgs/orgs).

* **Permisos base**: Los miembros tendr치n el permiso Ninguno/Lectura/Escritura/Admin sobre los repositorios de la org. Se recomienda **Ninguno** o **Lectura**.
* **Forking de repositorios**: Si no es necesario, es mejor **no permitir** a los miembros hacer fork de los repositorios de la organizaci칩n.
* **Creaci칩n de p치ginas**: Si no es necesario, es mejor **no permitir** a los miembros publicar p치ginas desde los repos de la org. Si es necesario, puedes permitir crear p치ginas p칰blicas o privadas.
* **Solicitudes de acceso a integraciones**: Con esto habilitado, los colaboradores externos podr치n solicitar acceso para aplicaciones de GitHub o OAuth para acceder a esta organizaci칩n y sus recursos. Por lo general, es necesario, pero si no, es mejor deshabilitarlo.
* _No pude encontrar esta informaci칩n en la respuesta de las APIs, comparte si t칰 s칤_
* **Cambio de visibilidad del repositorio**: Si est치 habilitado, los **miembros** con permisos de **admin** para el **repositorio** podr치n **cambiar su visibilidad**. Si est치 deshabilitado, solo los propietarios de la organizaci칩n pueden cambiar las visibilidades de los repositorios. Si **no** quieres que la gente haga cosas **p칰blicas**, aseg칰rate de que esto est칠 **deshabilitado**.
* _No pude encontrar esta informaci칩n en la respuesta de las APIs, comparte si t칰 s칤_
* **Eliminaci칩n y transferencia de repositorios**: Si est치 habilitado, los miembros con permisos de **admin** para el repositorio podr치n **eliminar** o **transferir** repositorios **p칰blicos y privados**.
* _No pude encontrar esta informaci칩n en la respuesta de las APIs, comparte si t칰 s칤_
* **Permitir a los miembros crear equipos**: Si est치 habilitado, cualquier **miembro** de la organizaci칩n podr치 **crear** nuevos **equipos**. Si est치 deshabilitado, solo los propietarios de la organizaci칩n pueden crear nuevos equipos. Es mejor tener esto deshabilitado.
* _No pude encontrar esta informaci칩n en la respuesta de las APIs, comparte si t칰 s칤_
* **Se pueden configurar m치s cosas** en esta p치gina, pero las anteriores son las m치s relacionadas con la seguridad.
### Configuraciones de Actions

Varias configuraciones relacionadas con la seguridad pueden ser configuradas para actions desde la p치gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Nota que todas estas configuraciones tambi칠n pueden ser establecidas en cada repositorio de manera independiente.
{% endhint %}

* **Pol칤ticas de Github actions**: Te permite indicar qu칠 repositorios pueden ejecutar workflows y qu칠 workflows deben ser permitidos. Se recomienda **especificar qu칠 repositorios** deben ser permitidos y no permitir que todas las actions se ejecuten.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Workflows de pull request de forks por colaboradores externos**: Se recomienda **requerir aprobaci칩n para todos** los colaboradores externos.
* _No pude encontrar una API con esta informaci칩n, comparte si la tienes_
* **Ejecutar workflows de pull requests de forks**: Es **altamente desaconsejado ejecutar workflows de pull requests** ya que los mantenedores del fork original se les dar치 la capacidad de usar tokens con permisos de lectura en el repositorio fuente.
* _No pude encontrar una API con esta informaci칩n, comparte si la tienes_
* **Permisos de workflow**: Es altamente recomendado **dar solo permisos de lectura al repositorio**. Se desaconseja dar permisos de escritura y crear/aprobar pull requests para evitar el abuso del GITHUB\_TOKEN otorgado a los workflows en ejecuci칩n.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integraciones

_춰Hazme saber si conoces el punto de acceso API para esta informaci칩n!_

* **Pol칤tica de acceso a aplicaciones de terceros**: Se recomienda restringir el acceso a cada aplicaci칩n y permitir solo las necesarias (despu칠s de revisarlas).
* **GitHub Apps instaladas**: Se recomienda permitir solo las necesarias (despu칠s de revisarlas).

## Reconocimiento y Ataques abusando de credenciales

Para este escenario vamos a suponer que has obtenido alg칰n acceso a una cuenta de github.

### Con Credenciales de Usuario

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci칩n puedes **simplemente iniciar sesi칩n** y verificar qu칠 **roles de empresa y organizaci칩n tienes**, si eres un miembro b치sico, verifica qu칠 **permisos tienen los miembros b치sicos**, en qu칠 **grupos** est치s, qu칠 **permisos tienes** sobre qu칠 **repos,** y **c칩mo est치n protegidos los repos.**

Nota que **puede usarse 2FA** por lo que solo podr치s acceder a esta informaci칩n si tambi칠n puedes **superar esa verificaci칩n**.

{% hint style="info" %}
Nota que si logras **robar la cookie `user_session`** (actualmente configurada con SameSite: Lax) puedes **impersonar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

Revisa la secci칩n de abajo sobre [**bypass de protecciones de branch**](./#branch-protection-bypass) en caso de que sea 칰til.

### Con Clave SSH de Usuario

Github permite a los **usuarios** configurar **claves SSH** que ser치n usadas como **m칠todo de autenticaci칩n para desplegar c칩digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de github para enumerar el entorno. No obstante, puedes **enumerar configuraciones locales** para obtener informaci칩n sobre los repos y el usuario al que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de github, puedes acceder a las **claves p칰blicas que ha establecido** en su cuenta en _https://github.com/\<github\_username>.keys_, podr칤as verificar esto para confirmar que la clave privada que encontraste se puede utilizar.

Las **claves SSH** tambi칠n pueden configurarse en los repositorios como **claves de despliegue**. Cualquiera con acceso a esta clave podr치 **lanzar proyectos desde un repositorio**. Usualmente en un servidor con diferentes claves de despliegue, el archivo local **`~/.ssh/config`** te dar치 informaci칩n sobre qu칠 clave est치 relacionada.

#### Claves GPG

Como se explica [**aqu칤**](broken-reference/) a veces es necesario firmar los commits o podr칤as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para una introducci칩n sobre [**Tokens de Usuario consulta la informaci칩n b치sica**](basic-github-information.md#personal-access-tokens).

Un token de usuario puede ser utilizado **en lugar de una contrase침a** para Git sobre HTTPS, o puede ser usado para [**autenticarse en la API mediante Autenticaci칩n B치sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependiendo de los privilegios asociados, podr칤as ser capaz de realizar diferentes acciones.

Un token de usuario se ve as칤: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Con Aplicaci칩n Oauth

Para una introducci칩n sobre [**Aplicaciones Oauth de Github consulta la informaci칩n b치sica**](basic-github-information.md#oauth-applications).

Un atacante podr칤a crear una **Aplicaci칩n Oauth maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que las acepten, probablemente como parte de una campa침a de phishing.

Estos son los [alcances que una aplicaci칩n Oauth puede solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Siempre se debe verificar los alcances solicitados antes de aceptarlos.

Adem치s, como se explica en la informaci칩n b치sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci칩n/repositorios/acciones relacionadas con la organizaci칩n.

### Con Aplicaci칩n de Github

Para una introducci칩n sobre [**Aplicaciones de Github consulta la informaci칩n b치sica**](basic-github-information.md#github-applications).

Un atacante podr칤a crear una **Aplicaci칩n de Github maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que las acepten, probablemente como parte de una campa침a de phishing.

Adem치s, como se explica en la informaci칩n b치sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci칩n/repositorios/acciones relacionadas con la organizaci칩n.

## Comprometer y Abusar de Github Action

Hay varias t칠cnicas para comprometer y abusar de una Github Action, rev칤salas aqu칤:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Eludir la Protecci칩n de Ramas

* **Requerir un n칰mero de aprobaciones**: Si has comprometido varias cuentas, podr칤as simplemente aceptar tus PR desde otras cuentas. Si solo tienes la cuenta desde donde creaste el PR, no puedes aceptar tu propio PR. Sin embargo, si tienes acceso a un entorno de **Github Action** dentro del repositorio, utilizando el **GITHUB\_TOKEN** podr칤as ser capaz de **aprobar tu PR** y obtener 1 aprobaci칩n de esta manera.
* _Nota para esto y para la restricci칩n de Propietarios de C칩digo que usualmente un usuario no podr치 aprobar sus propios PRs, pero si puedes, puedes abusar de ello para aceptar tus PRs._
* **Descartar aprobaciones cuando se env칤an nuevos commits**: Si esto no est치 configurado, puedes enviar c칩digo leg칤timo, esperar a que alguien lo apruebe, y luego agregar c칩digo malicioso y fusionarlo en la rama protegida.
* **Requerir revisiones de Propietarios de C칩digo**: Si esto est치 activado y eres un Propietario de C칩digo, podr칤as hacer que una **Github Action cree tu PR y luego aprobarlo t칰 mismo**.
* Cuando un archivo **CODEOWNER est치 mal configurado** Github no se queja pero no lo utiliza. Por lo tanto, si est치 mal configurado, su protecci칩n de **Propietarios de C칩digo no se aplica**.
* **Permitir a actores especificados eludir los requisitos de pull request**: Si eres uno de estos actores puedes eludir las protecciones de pull request.
* **Incluir administradores**: Si esto no est치 configurado y eres administrador del repositorio, puedes eludir estas protecciones de rama.
* **Secuestro de PR**: Podr칤as ser capaz de **modificar el PR de alguien m치s** agregando c칩digo malicioso, aprobando el PR resultante t칰 mismo y fusionando todo.
* **Eliminar Protecciones de Rama**: Si eres un **administrador del repositorio puedes desactivar las protecciones**, fusionar tu PR y volver a establecer las protecciones.
* **Eludir protecciones de push**: Si un repositorio **solo permite a ciertos usuarios** enviar push (fusionar c칩digo) en ramas (la protecci칩n de rama podr칤a estar protegiendo todas las ramas especificando el comod칤n `*`).
* Si tienes **acceso de escritura sobre el repositorio pero no te est치 permitido enviar c칩digo** debido a la protecci칩n de rama, a칰n puedes **crear una nueva rama** y dentro de ella crear una **github action que se active cuando se env칤a c칩digo**. Como la **protecci칩n de rama no proteger치 la rama hasta que se cree**, este primer env칤o de c칩digo a la rama **ejecutar치 la github action**.

## Eludir Protecciones de Entornos

Para una introducci칩n sobre [**Entornos de Github consulta la informaci칩n b치sica**](basic-github-information.md#git-environments).

En caso de que un entorno pueda ser **accedido desde todas las ramas**, **no est치 protegido** y puedes acceder f치cilmente a los secretos dentro del entorno. Ten en cuenta que podr칤as encontrar repositorios donde **todas las ramas est치n protegidas** (especificando sus nombres o usando `*`) en ese escenario, **encuentra una rama donde puedas enviar c칩digo** y puedes **exfiltrar** los secretos creando una nueva github action (o modificando una).

Nota que podr칤as encontrar el caso l칤mite donde **todas las ramas est치n protegidas** (v칤a comod칤n `*`) se especifica **qui칠n puede enviar c칩digo a las ramas** (_puedes especificar eso en la protecci칩n de rama_) y **tu usuario no est치 permitido**. A칰n puedes ejecutar una github action personalizada porque puedes crear una rama y usar el disparador de push sobre s칤 misma. La **protecci칩n de rama permite el push a una nueva rama por lo que la github action se activar치**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Tenga en cuenta que **despu칠s de la creaci칩n** de la rama, la **protecci칩n de la rama se aplicar치 a la nueva rama** y no podr치 modificarla, pero para ese momento ya habr치 extra칤do los secretos.

## Persistencia

* Generar **token de usuario**
* Robar **tokens de github** de **secrets**
* **Eliminaci칩n** de **resultados** de workflow y **ramas**
* Dar **m치s permisos a toda la org**
* Crear **webhooks** para exfiltrar informaci칩n
* Invitar **colaboradores externos**
* **Eliminar** **webhooks** utilizados por el **SIEM**
* Crear/modificar **Github Action** con una **puerta trasera**
* Encontrar **Github Action vulnerable a inyecci칩n de comandos** a trav칠s de la modificaci칩n del valor de **secret**

### Imposter Commits - Puerta trasera a trav칠s de commits en el repositorio

En Github es posible **crear un PR a un repositorio desde un fork**. Incluso si el PR **no es aceptado**, se crear치 un id de **commit** dentro del repositorio original para la versi칩n del c칩digo del fork. Por lo tanto, un atacante **podr칤a fijar el uso de un commit espec칤fico de un repositorio aparentemente leg칤timo que no fue creado por el propietario del repositorio**.

Como [**esto**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para m치s informaci칩n, consulta [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
