# GH Actions - Envenenamiento de Cach茅

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Envenenamiento de Cach茅

El uso de la acci贸n de Git [**action/cache**](https://github.com/actions/cache) en cualquier parte de CI ejecutar谩 dos pasos: uno durante el proceso de **run** cuando se llama y otro despu茅s del **workflow** (si la acci贸n de ejecuci贸n devuelve un cache-miss).

* **Acci贸n de ejecuci贸n** - se utiliza para buscar y recuperar la cach茅. La b煤squeda se realiza utilizando la clave de cach茅, y el resultado puede ser un cache-hit (茅xito, datos encontrados en la cach茅) o un cache-miss. Si se encuentra, los archivos y directorios se recuperan de la cach茅 para su uso activo. Si el resultado es un cache-miss, los archivos y directorios deseados se descargan como si fuera la primera vez que se llaman.
* **Acci贸n posterior al workflow** - se utiliza para guardar la cach茅. Si el resultado de la llamada a la cach茅 en la acci贸n de ejecuci贸n devuelve un cache-miss, esta acci贸n guardar谩 el estado actual de los directorios que queremos cachear con la clave proporcionada. Esta acci贸n se realiza autom谩ticamente y no necesita ser llamada expl铆citamente.

Las **restricciones de acceso** proporcionan **aislamiento de cach茅** y seguridad al crear un **l铆mite l贸gico entre diferentes ramas** _(por ejemplo: una cach茅 creada para la rama **Feature-A** \[con la base main] no ser铆a accesible para una solicitud de extracci贸n de la rama **Feature-B** \[con la base main])_.

La acci贸n de cach茅 primero busca aciertos de cach茅 para una clave y restaura las claves en la rama que contiene la **ejecuci贸n del workflow**. Si no hay aciertos en la rama actual, la acci贸n de cach茅 busca la clave y restaura las claves en la rama principal y las ramas ascendentes.

El acceso a una cach茅 est谩 limitado por rama (actual y principal), lo que significa que se proporciona acceso a todos los **workflows** en todas las **ejecuciones** de dicha rama.

Otra nota importante es que GitHub no permite modificaciones una vez que se han enviado las entradas: las entradas de cach茅 son registros de solo lectura.

Utilizamos un ejemplo de CI que inclu铆a dos workflows. Este ejemplo muestra c贸mo un ataque puede pasar de un workflow de baja permisos a uno de alta permisos.

* Workflow **Unit-test** que ejecuta pruebas unitarias y herramientas de cobertura de c贸digo. Suponemos que una de las herramientas es maliciosa o vulnerable a la ejecuci贸n remota de c贸digo. El workflow no necesita utilizar la acci贸n de Git **action/cache**. Cualquier workflow puede acceder a la cach茅.
* Workflow **Release** que construye y lanza el artefacto de la aplicaci贸n. Este workflow utiliza una cach茅 para optimizar el uso de las dependencias de Golang.

El workflow **unit-test** utiliza una acci贸n maliciosa que agrega una entrada de cach茅 con contenido malicioso al cambiar una biblioteca de registro de Golang (**go.uber.org/zap@v1**) para agregar la cadena 'BAD library' a la descripci贸n del artefacto de la aplicaci贸n.

A continuaci贸n, el workflow **release** utiliza esta entrada de cach茅 envenenada. Como resultado, el c贸digo malicioso se inyecta en el binario y la imagen de Golang construidos. La cach茅 permanece envenenada hasta que se descarta la clave de entrada (generalmente desencadenada por actualizaciones de dependencias). La misma cach茅 envenenada afectar谩 a cualquier otro **workflow**, **ejecuci贸n** y **rama secundaria** que utilice la misma clave de cach茅.

En la prueba que realizamos, logramos inyectar la cadena 'BAD library' en la descripci贸n de la imagen:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Esto fue en la versi贸n 0.4.1. A continuaci贸n, actualizamos la etiqueta y reconstruimos la imagen varias veces, y observamos que 'Bad library' segu铆a apareciendo en la descripci贸n.

Esta t茅cnica fue tomada de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
