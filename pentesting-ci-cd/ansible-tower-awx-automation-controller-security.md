# Seguridad de Ansible Tower / AWX / Controlador de automatizaci贸n

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci贸n b谩sica

**Ansible Tower** o su versi贸n de c贸digo abierto [**AWX**](https://github.com/ansible/awx) tambi茅n se conoce como **interfaz de usuario, panel de control y API REST de Ansible**. Con control de acceso basado en roles, programaci贸n de trabajos y gesti贸n gr谩fica de inventarios, puedes administrar tu infraestructura de Ansible desde una interfaz moderna. La API REST y la interfaz de l铆nea de comandos de Tower facilitan su integraci贸n en herramientas y flujos de trabajo actuales.

**Automation Controller es una versi贸n m谩s nueva** de Ansible Tower con m谩s capacidades.

### Diferencias

Seg煤n [**esto**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), las principales diferencias entre Ansible Tower y AWS son el soporte recibido y que Ansible Tower tiene caracter铆sticas adicionales como control de acceso basado en roles, soporte para API personalizadas y flujos de trabajo definidos por el usuario.

### Pila tecnol贸gica

* **Interfaz web**: Esta es la interfaz gr谩fica donde los usuarios pueden administrar inventarios, credenciales, plantillas y trabajos. Est谩 dise帽ada para ser intuitiva y proporciona visualizaciones para ayudar a comprender el estado y los resultados de tus trabajos de automatizaci贸n.
* **API REST**: Todo lo que puedes hacer en la interfaz web, tambi茅n puedes hacerlo a trav茅s de la API REST. Esto significa que puedes integrar AWX/Tower con otros sistemas o realizar acciones de script que normalmente realizar铆as en la interfaz.
* **Base de datos**: AWX/Tower utiliza una base de datos (normalmente PostgreSQL) para almacenar su configuraci贸n, resultados de trabajos y otros datos operativos necesarios.
* **RabbitMQ**: Este es el sistema de mensajer铆a utilizado por AWX/Tower para comunicarse entre los diferentes componentes, especialmente entre el servicio web y los ejecutores de tareas.
* **Redis**: Redis sirve como cach茅 y backend para la cola de tareas.

### Componentes l贸gicos

* **Inventarios**: Un inventario es una **colecci贸n de hosts (o nodos)** contra los cuales se pueden **ejecutar trabajos** (playbooks de Ansible). AWX/Tower te permite definir y agrupar tus inventarios y tambi茅n admite inventarios din谩micos que pueden **obtener listas de hosts de otros sistemas** como AWS, Azure, etc.
* **Proyectos**: Un proyecto es esencialmente una **colecci贸n de playbooks de Ansible** obtenidos de un **sistema de control de versiones** (como Git) para extraer los 煤ltimos playbooks cuando sea necesario.
* **Plantillas**: Las plantillas de trabajo definen **c贸mo se ejecutar谩 un playbook en particular**, especificando el **inventario**, las **credenciales** y otros **par谩metros** para el trabajo.
* **Credenciales**: AWX/Tower proporciona una forma segura de **administrar y almacenar secretos, como claves SSH, contrase帽as y tokens de API**. Estas credenciales se pueden asociar con plantillas de trabajo para que los playbooks tengan el acceso necesario cuando se ejecutan.
* **Motor de tareas**: Aqu铆 es donde ocurre la magia. El motor de tareas est谩 construido sobre Ansible y es responsable de **ejecutar los playbooks**. Los trabajos se env铆an al motor de tareas, que luego ejecuta los playbooks de Ansible en el inventario designado utilizando las credenciales especificadas.
* **Planificadores y devoluciones de llamada**: Estas son caracter铆sticas avanzadas en AWX/Tower que permiten **programar trabajos** para que se ejecuten en momentos espec铆ficos o se activen por eventos externos.
* **Notificaciones**: AWX/Tower puede enviar notificaciones basadas en el 茅xito o el fracaso de los trabajos. Admite diversos medios de notificaci贸n como correos electr贸nicos, mensajes de Slack, webhooks, etc.
* **Playbooks de Ansible**: Los playbooks de Ansible son herramientas de configuraci贸n, implementaci贸n y orquestaci贸n. Describen el estado deseado de los sistemas de manera automatizada y repetible. Escritos en YAML, los playbooks utilizan el lenguaje de automatizaci贸n declarativo de Ansible para describir configuraciones, tareas y pasos que deben ejecutarse.

### Flujo de ejecuci贸n de trabajos

1. **Interacci贸n del usuario**: Un usuario puede interactuar con AWX/Tower a trav茅s de la **interfaz web** o la **API REST**. Estas proporcionan acceso frontal a todas las funcionalidades ofrecidas por AWX/Tower.
2. **Inicio del trabajo**:
* El usuario, a trav茅s de la interfaz web o la API, inicia un trabajo basado en una **plantilla de trabajo**.
* La plantilla de trabajo incluye referencias al **inventario**, **proyecto** (que contiene el playbook) y **credenciales**.
* Al iniciar el trabajo, se env铆a una solicitud al backend de AWX/Tower para encolar el trabajo para su ejecuci贸n.
3. **Cola de trabajos**:
* **RabbitMQ** maneja la mensajer铆a entre el componente web y los ejecutores de tareas. Una vez que se inicia un trabajo, se env铆a un mensaje al motor de tareas utilizando RabbitMQ.
* **Redis** act煤a como el backend para la cola de tareas, gestionando los trabajos en cola que esperan ser ejecutados.
4. **Ejecuci贸n del trabajo**:
* El **motor de tareas** recoge el trabajo en cola. Recupera la informaci贸n necesaria de la **base de datos** sobre el playbook, inventario y credenciales asociados al trabajo.
* Utilizando el playbook de Ansible recuperado del **proyecto** asociado, el motor de tareas ejecuta el playbook en los nodos del **inventario** especificado utilizando las **credenciales** proporcionadas.
* A medida que se ejecuta el playbook, su salida de ejecuci贸n (registros, hechos, etc.) se captura y almacena en la **base de datos**.
5. **Resultados del trabajo**:
* Una vez que el playbook termina de ejecutarse, los resultados (茅xito, fracaso, registros) se guardan en la **base de datos**.
* Los usuarios pueden ver los resultados a trav茅s de la interfaz web o consultarlos a trav茅s de la API REST.
* Seg煤n los resultados del trabajo, se pueden enviar **notificaciones** para informar a los usuarios o sistemas externos sobre el estado del trabajo. Las notificaciones pueden ser correos electr贸nicos, mensajes de Slack, webhooks, etc.
6. **Integraci贸n con sistemas externos**:
* Los **inventarios** se pueden obtener din谩micamente de sistemas externos, lo que permite que AWX/Tower obtenga hosts de fuentes como AWS, Azure, VMware y m谩s.
* Los **proyectos** (playbooks) se pueden obtener de sistemas de control de versiones, lo que garantiza el uso de playbooks actualizados durante la ejecuci贸n del trabajo.
* Los **planificadores y devoluciones de llamada** se pueden utilizar para integrarse con otros sistemas o herramientas, lo que permite que AWX/Tower reaccione a disparadores externos o ejecute trabajos en momentos predeterminados.
### Creaci贸n de laboratorio AWX para pruebas

[**Siguiendo la documentaci贸n**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md), es posible utilizar docker-compose para ejecutar AWX:

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### Roles compatibles

El rol m谩s privilegiado se llama **Administrador del sistema**. Cualquier persona con este rol puede **modificar cualquier cosa**.

Desde una revisi贸n de seguridad de **caja blanca**, necesitar铆as el rol de **Auditor del sistema**, que permite **ver todos los datos del sistema** pero no puede realizar cambios. Otra opci贸n ser铆a obtener el rol de **Auditor de la organizaci贸n**, pero ser铆a mejor obtener el otro.

<details>

<summary>Expande esto para obtener una descripci贸n detallada de los roles disponibles</summary>

1. **Administrador del sistema**:
* Este es el rol de superusuario con permisos para acceder y modificar cualquier recurso en el sistema.
* Pueden gestionar todas las organizaciones, equipos, proyectos, inventarios, plantillas de trabajo, etc.
2. **Auditor del sistema**:
* Los usuarios con este rol pueden ver todos los datos del sistema pero no pueden realizar cambios.
* Este rol est谩 dise帽ado para el cumplimiento y la supervisi贸n.
3. **Roles de la organizaci贸n**:
* **Admin**: Control total sobre los recursos de la organizaci贸n.
* **Auditor**: Acceso de solo lectura a los recursos de la organizaci贸n.
* **Miembro**: Membres铆a b谩sica en una organizaci贸n sin permisos espec铆ficos.
* **Ejecutar**: Puede ejecutar plantillas de trabajo dentro de la organizaci贸n.
* **Leer**: Puede ver los recursos de la organizaci贸n.
4. **Roles del proyecto**:
* **Admin**: Puede gestionar y modificar el proyecto.
* **Usar**: Puede utilizar el proyecto en una plantilla de trabajo.
* **Actualizar**: Puede actualizar el proyecto utilizando el SCM (control de c贸digo fuente).
5. **Roles del inventario**:
* **Admin**: Puede gestionar y modificar el inventario.
* **Ad Hoc**: Puede ejecutar comandos ad hoc en el inventario.
* **Actualizar**: Puede actualizar la fuente del inventario.
* **Usar**: Puede utilizar el inventario en una plantilla de trabajo.
* **Leer**: Acceso de solo lectura.
6. **Roles de la plantilla de trabajo**:
* **Admin**: Puede gestionar y modificar la plantilla de trabajo.
* **Ejecutar**: Puede ejecutar el trabajo.
* **Leer**: Acceso de solo lectura.
7. **Roles de las credenciales**:
* **Admin**: Puede gestionar y modificar las credenciales.
* **Usar**: Puede utilizar las credenciales en plantillas de trabajo u otros recursos relevantes.
* **Leer**: Acceso de solo lectura.
8. **Roles del equipo**:
* **Miembro**: Parte del equipo pero sin permisos espec铆ficos.
* **Admin**: Puede gestionar los miembros del equipo y los recursos asociados.
9. **Roles del flujo de trabajo**:
* **Admin**: Puede gestionar y modificar el flujo de trabajo.
* **Ejecutar**: Puede ejecutar el flujo de trabajo.
* **Leer**: Acceso de solo lectura.

</details>

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
