# Bezpieczestwo Ansible Tower / AWX / Kontroler automatyzacji

<details>

<summary><strong>Zacznij od zera i sta si ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

**Ansible Tower** lub jego wersja open source [**AWX**](https://github.com/ansible/awx) jest r贸wnie偶 znany jako **interfejs u偶ytkownika Ansible, panel i interfejs REST**. Dziki **kontroli dostpu opartej na rolach**, harmonogramowaniu zada i graficznemu zarzdzaniu inwentarzem, mo偶na zarzdza infrastruktur Ansible za pomoc nowoczesnego interfejsu u偶ytkownika. Interfejs REST i interfejs wiersza polece Tower umo偶liwiaj atwe zintegrowanie go z obecnymi narzdziami i procesami.

**Kontroler automatyzacji to nowsza** wersja Ansible Tower z wikszymi mo偶liwociami.

### R贸偶nice

Zgodnie z [**tym**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), g贸wne r贸偶nice midzy Ansible Tower a AWX to otrzymywane wsparcie, a Ansible Tower ma dodatkowe funkcje, takie jak kontrola dostpu oparta na rolach, obsuga niestandardowych interfejs贸w API i zdefiniowane przez u偶ytkownika przepywy pracy.

### Stos technologiczny

* **Interfejs sieciowy**: Jest to interfejs graficzny, w kt贸rym u偶ytkownicy mog zarzdza inwentarzami, powiadczeniami, szablonami i zadaniami. Zosta zaprojektowany tak, aby by intuicyjny i zapewnia wizualizacje pomagajce zrozumie stan i wyniki zada automatyzacji.
* **Interfejs REST**: Wszystko, co mo偶na zrobi w interfejsie sieciowym, mo偶na r贸wnie偶 zrobi za pomoc interfejsu REST. Oznacza to, 偶e mo偶na zintegrowa AWX/Tower z innymi systemami lub skryptowa dziaania, kt贸re zazwyczaj wykonywaby w interfejsie.
* **Baza danych**: AWX/Tower u偶ywa bazy danych (zwykle PostgreSQL) do przechowywania konfiguracji, wynik贸w zada i innych niezbdnych danych operacyjnych.
* **RabbitMQ**: To system komunikacji u偶ywany przez AWX/Tower do komunikacji midzy r贸偶nymi komponentami, zwaszcza midzy usug sieciow a wykonawcami zada.
* **Redis**: Redis su偶y jako pami podrczna i backend dla kolejki zada.

### Skadniki logiczne

* **Inwentarze**: Inwentarz to **zbi贸r host贸w (lub wz贸w)**, na kt贸rych mog by **uruchamiane zadania** (playbooki Ansible). AWX/Tower pozwala zdefiniowa i grupowa inwentarze oraz obsuguje inwentarze dynamiczne, kt贸re mog **pobiera listy host贸w z innych system贸w** takich jak AWS, Azure, itp.
* **Projekty**: Projekt to w zasadzie **zbi贸r playbook贸w Ansible** pobranych z **systemu kontroli wersji** (np. Git) w celu pobrania najnowszych playbook贸w w razie potrzeby.
* **Szablony**: Szablony zada definiuj **spos贸b uruchomienia okrelonego playbooka**, okrelajc **inwentarz**, **powiadczenia** i inne **parametry** dla zadania.
* **Powiadczenia**: AWX/Tower zapewnia bezpieczny spos贸b **zarzdzania i przechowywania tajemnic, takich jak klucze SSH, hasa i tokeny API**. Te powiadczenia mog by powizane z szablonami zada, aby playbooki miay niezbdny dostp podczas uruchamiania.
* **Silnik zada**: To tutaj dzieje si magia. Silnik zada jest oparty na Ansible i odpowiada za **uruchamianie playbook贸w**. Zadania s wysyane do silnika zada, kt贸ry nastpnie uruchamia playbooki Ansible przeciwko okrelonym wzom inwentarza, korzystajc z okrelonych powiadcze.
* **Harmonogramy i wywoania zwrotne**: S to zaawansowane funkcje w AWX/Tower, kt贸re pozwalaj **harmonogramowa zadania** do uruchomienia o okrelonych godzinach lub wywoywane przez zewntrzne zdarzenia.
* **Powiadomienia**: AWX/Tower mo偶e wysya powiadomienia na podstawie sukcesu lub niepowodzenia zada. Obsuguje r贸偶ne sposoby powiadamiania, takie jak e-maile, wiadomoci Slack, webhooks, itp.
* **Playbooki Ansible**: Playbooki Ansible to narzdzia konfiguracji, wdro偶enia i orkiestracji. Opisuj one po偶dany stan system贸w w zautomatyzowany, powtarzalny spos贸b. Napisane w formacie YAML, playbooki u偶ywaj deklaratywnego jzyka automatyzacji Ansible do opisywania konfiguracji, zada i krok贸w, kt贸re nale偶y wykona.

### Przepyw wykonania zadania

1. **Interakcja u偶ytkownika**: U偶ytkownik mo偶e wsp贸dziaa z AWX/Tower poprzez **interfejs sieciowy** lub **interfejs REST**. Zapewniaj one dostp do wszystkich funkcji oferowanych przez AWX/Tower.
2. **Inicjowanie zadania**:
* U偶ytkownik, za porednictwem interfejsu sieciowego lub interfejsu API, inicjuje zadanie na podstawie **Szablonu zadania**.
* Szablon zadania zawiera odniesienia do **Inwentarza**, **Projektu** (zawierajcego playbook) i **Powiadcze**.
* Po zainicjowaniu zadania, 偶danie jest wysyane do backendu AWX/Tower, aby umieci zadanie w kolejce do wykonania.
3. **Kolejkowanie zada**:
* **RabbitMQ** obsuguje komunikacj midzy komponentem sieciowym a wykonawcami zada. Po zainicjowaniu zadania, wiadomo jest wysyana do silnika zada za pomoc RabbitMQ.
* **Redis** dziaa jako backend dla kolejki zada, zarzdzajc zadaniami w kolejce oczekujcymi na wykonanie.
4. **Wykonanie zadania**:
* **Silnik zada** podnosi zadanie z kolejki. Pobiera niezbdne informacje z **Bazy danych** dotyczce powizanego playbooka, inwentarza i powiadcze zadania.
* Korzystajc z pobranego playbooka Ansible z powizanego **Projektu**, Silnik zada uruchamia playbook przeciwko okrelonym wzom **Inwentarza** przy u偶yciu podanych **Powiadcze**.
* Podczas uruchamiania playbooka, jego wyniki wykonania (logi, fakty, itp.) s przechwytywane i przechowywane w **Bazie danych**.
5. **Wyniki zadania**:
* Po zakoczeniu uruchamiania playbooka, wyniki (sukces, niepowodzenie, logi) s zapisywane w **Bazie danych**.
* U偶ytkownicy mog nastpnie przeglda wyniki za pomoc interfejsu sieciowego lub zapytywa o nie za pomoc interfejsu REST.
* Na podstawie wynik贸w zadania, **Powiadomienia** mog by wysyane, informujc u偶ytkownik贸w lub zewntrzne systemy o statusie zadania. Powiadomienia mog by e-mailami, wiadomociami Slack, webhookami, itp.
6. **Integracja z zewntrznymi systemami**:
* **Inwentarze** mog by dynamicznie pobierane z zewntrznych system贸w, umo偶liwiajc AWX/Tower pobieranie host贸w z takich 藕r贸de jak AWS, Azure, VMware i inne.
* **Projekty** (playbooki) mog by pobierane z system贸w kontroli wersji, zapewniajc u偶ycie aktualnych playbook贸w podczas wykonywania zada.
* **Harmonogramy i wywoania zwrotne** mog by u偶ywane do integracji z innymi systemami lub narzdziami, umo偶liwiajc AWX/Tower reagowanie na zewntrzne wyzwalacze lub uruchamianie zada o okrelonych godzinach.

### Utworzenie laboratorium AWX do test贸w

[Zgodnie z dokumentacj](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md) mo偶na u偶y docker-compose do uruchomienia AWX:

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### Obsugiwane role

Najbardziej uprzywilejowan rol jest **Administrator systemu**. Osoba posiadajca t rol mo偶e **modyfikowa wszystko**.

Z przegldu **biaej skrzynki** wynika, 偶e potrzebna byaby rola **Audytora systemu**, kt贸ra pozwala **wywietla wszystkie dane systemowe**, ale nie mo偶e dokonywa 偶adnych zmian. Inna opcja to uzyskanie roli **Audytora organizacji**, ale lepiej byoby uzyska t pierwsz.

<details>

<summary>Rozwi, aby uzyska szczeg贸owy opis dostpnych r贸l</summary>

1. **Administrator systemu**:
* Jest to rola superu偶ytkownika z uprawnieniami do dostpu i modyfikowania dowolnego zasobu w systemie.
* Mog zarzdza wszystkimi organizacjami, zespoami, projektami, inwentarzami, szablonami zada, itp.
2. **Auditor systemu**:
* U偶ytkownicy z t rol mog przeglda wszystkie dane systemowe, ale nie mog dokonywa 偶adnych zmian.
* Rola ta jest przeznaczona do zgodnoci i nadzoru.
3. **Role organizacji**:
* **Admin**: Pena kontrola nad zasobami organizacji.
* **Auditor**: Dostp tylko do odczytu zasob贸w organizacji.
* **Czonek**: Podstawowe czonkostwo w organizacji bez konkretnych uprawnie.
* **Wykonaj**: Mo偶e uruchamia szablony zada w organizacji.
* **Odczyt**: Mo偶e przeglda zasoby organizacji.
4. **Role projektu**:
* **Admin**: Mo偶e zarzdza i modyfikowa projekt.
* **U偶yj**: Mo偶e u偶y projektu w szablonie zadania.
* **Aktualizuj**: Mo偶e aktualizowa projekt za pomoc SCM (kontroli 藕r贸da).
5. **Role inwentarza**:
* **Admin**: Mo偶e zarzdza i modyfikowa inwentarz.
* **Ad hoc**: Mo偶e uruchamia polecenia ad hoc na inwentarzu.
* **Aktualizuj**: Mo偶e aktualizowa 藕r贸do inwentarza.
* **U偶yj**: Mo偶e u偶y inwentarza w szablonie zadania.
* **Odczyt**: Dostp tylko do odczytu.
6. **Role szablonu zadania**:
* **Admin**: Mo偶e zarzdza i modyfikowa szablon zadania.
* **Wykonaj**: Mo偶e uruchomi zadanie.
* **Odczyt**: Dostp tylko do odczytu.
7. **Role powiadczenia**:
* **Admin**: Mo偶e zarzdza i modyfikowa powiadczenia.
* **U偶yj**: Mo偶e u偶y powiadcze w szablonach zada lub innych odpowiednich zasobach.
* **Odczyt**: Dostp tylko do odczytu.
8. **Role zespou**:
* **Czonek**: Cz zespou, ale bez konkretnych uprawnie.
* **Admin**: Mo偶e zarzdza czonkami zespou i powizanymi zasobami.
9. **Role przepywu pracy**:
* **Admin**: Mo偶e zarzdza i modyfikowa przepyw pracy.
* **Wykonaj**: Mo偶e uruchomi przepyw pracy.
* **Odczyt**: Dostp tylko do odczytu.

</details>
