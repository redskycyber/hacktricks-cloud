# Gitea Security

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ¬øQu√© es Gitea?

**Gitea** es una soluci√≥n de **alojamiento de c√≥digo ligera y gestionada por la comunidad autoalojada** escrita en Go.

![](<../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png>)

### Informaci√≥n B√°sica

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratorio

Para ejecutar una instancia de Gitea localmente, puedes simplemente ejecutar un contenedor de docker:

```bash
docker run -p 3000:3000 gitea/gitea
```

Con√©ctese al puerto 3000 para acceder a la p√°gina web.

Tambi√©n podr√≠a ejecutarlo con kubernetes:

```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```

## Enumeraci√≥n Sin Autenticaci√≥n

* Repositorios p√∫blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usuarios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizaciones registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Tenga en cuenta que por **defecto Gitea permite el registro de nuevos usuarios**. Esto no otorgar√° acceso especialmente interesante a los nuevos usuarios sobre otros repositorios u organizaciones de usuarios, pero un **usuario con sesi√≥n iniciada** podr√≠a ser capaz de **visualizar m√°s repositorios u organizaciones**.

## Explotaci√≥n Interna

Para este escenario vamos a suponer que has obtenido alg√∫n acceso a una cuenta de github.

### Con Credenciales de Usuario/Cookie Web

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci√≥n (o robaste una cookie de sesi√≥n) puedes **iniciar sesi√≥n** y verificar qu√© **permisos tienes** sobre qu√© **repositorios**, en **qu√© equipos** est√°s, **listar otros usuarios**, y **c√≥mo est√°n protegidos los repositorios.**

Tenga en cuenta que se puede utilizar **2FA**, por lo que solo podr√°s acceder a esta informaci√≥n si tambi√©n puedes **superar esa verificaci√≥n**.

{% hint style="info" %}
Tenga en cuenta que si logra **robar la cookie `i_like_gitea`** (actualmente configurada con SameSite: Lax) puede **suplantar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

### Con Clave SSH de Usuario

Gitea permite a los **usuarios** establecer **claves SSH** que se utilizar√°n como **m√©todo de autenticaci√≥n para desplegar c√≥digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la api de gitea para enumerar el entorno. Sin embargo, puedes **enumerar configuraciones locales** para obtener informaci√≥n sobre los repositorios y el usuario al que tienes acceso:

```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```

Si el usuario ha configurado su nombre de usuario como su nombre de usuario de gitea, puedes acceder a las **claves p√∫blicas que ha establecido** en su cuenta en _https://github.com/\<gitea\_username>.keys_, podr√≠as verificar esto para confirmar que la clave privada que encontraste se puede utilizar.

Las **claves SSH** tambi√©n pueden configurarse en los repositorios como **claves de despliegue**. Cualquiera con acceso a esta clave podr√° **lanzar proyectos desde un repositorio**. Usualmente en un servidor con diferentes claves de despliegue, el archivo local **`~/.ssh/config`** te dar√° informaci√≥n sobre qu√© clave est√° relacionada.

#### Claves GPG

Como se explica [**aqu√≠**](https://github.com/carlospolop/hacktricks-cloud/blob/es/pentesting-ci-cd/gitea-security/broken-reference/README.md) a veces es necesario firmar los commits o podr√≠as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:

```shell
gpg --list-secret-keys --keyid-format=long
```

### Con Token de Usuario

Para una introducci√≥n sobre [**Tokens de Usuario revisa la informaci√≥n b√°sica**](basic-gitea-information.md#personal-access-tokens).

Un token de usuario puede ser utilizado **en lugar de una contrase√±a** para **autenticarse** contra el servidor de Gitea [**v√≠a API**](https://try.gitea.io/api/swagger#/). Tendr√° **acceso completo** sobre el usuario.

### Con Aplicaci√≥n Oauth

Para una introducci√≥n sobre [**Aplicaciones Oauth de Gitea revisa la informaci√≥n b√°sica**](./#with-oauth-application).

Un atacante podr√≠a crear una **Aplicaci√≥n Oauth maliciosa** para acceder a datos/acciones privilegiados de los usuarios que las acepten, probablemente como parte de una campa√±a de phishing.

Como se explica en la informaci√≥n b√°sica, la aplicaci√≥n tendr√° **acceso total sobre la cuenta del usuario**.

### Elusi√≥n de Protecci√≥n de Ramas

En Github tenemos **github actions** que por defecto obtienen un **token con acceso de escritura** sobre el repositorio que puede ser utilizado para **eludir las protecciones de ramas**. En este caso **no existe**, por lo que las elusiones son m√°s limitadas. Pero veamos qu√© se puede hacer:

* **Habilitar Push**: Si cualquiera con acceso de escritura puede hacer push a la rama, simplemente haz push.
* **Lista Blanca de Push Restringido**: De la misma manera, si est√°s en esta lista, haz push a la rama.
* **Habilitar Lista Blanca de Merge**: Si hay una lista blanca de merge, necesitas estar dentro de ella.
* **Requerir aprobaciones es mayor que 0**: Entonces... necesitas comprometer a otro usuario.
* **Restringir aprobaciones a usuarios en lista blanca**: Si solo usuarios en lista blanca pueden aprobar... necesitas comprometer a otro usuario que est√© en esa lista.
* **Descartar aprobaciones obsoletas**: Si las aprobaciones no se eliminan con nuevos commits, podr√≠as secuestrar un PR ya aprobado para inyectar tu c√≥digo y fusionar el PR.

Nota que **si eres un admin de org/repo** puedes eludir las protecciones.

### Enumerar Webhooks

**Webhooks** son capaces de **enviar informaci√≥n espec√≠fica de gitea a algunos lugares**. Podr√≠as ser capaz de **explotar esa comunicaci√≥n**.\
Sin embargo, usualmente se establece un **secreto** que **no puedes recuperar** en el **webhook** que **prevendr√°** que usuarios externos que conocen la URL del webhook pero no el secreto **exploten ese webhook**.\
Pero en algunas ocasiones, en lugar de establecer el **secreto** en su lugar, lo **ponen en la URL** como un par√°metro, as√≠ que **revisar las URLs** podr√≠a permitirte **encontrar secretos** y otros lugares que podr√≠as explotar m√°s.

Los Webhooks pueden ser configurados a nivel de **repo y de org**.

## Post Explotaci√≥n

### Dentro del servidor

Si de alguna manera lograste entrar al servidor donde se ejecuta gitea deber√≠as buscar el archivo de configuraci√≥n de gitea. Por defecto est√° ubicado en `/data/gitea/conf/app.ini`

En este archivo puedes encontrar **claves** y **contrase√±as**.

En la ruta de gitea (por defecto: /data/gitea) tambi√©n puedes encontrar informaci√≥n interesante como:

* La base de datos **sqlite**: Si gitea no est√° utilizando una db externa, usar√° una db sqlite.
* Las **sesiones** dentro de la carpeta de sesiones: Ejecutando `cat sessions/*/*/*` puedes ver los nombres de usuario de los usuarios conectados (gitea tambi√©n podr√≠a guardar las sesiones dentro de la DB).
* La **clave privada jwt** dentro de la carpeta jwt.
* M√°s **informaci√≥n sensible** podr√≠a ser encontrada en esta carpeta.

Si est√°s dentro del servidor tambi√©n puedes **usar el binario `gitea`** para acceder/modificar informaci√≥n:

* `gitea dump` har√° un volcado de gitea y generar√° un archivo .zip
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generar√° un token del tipo indicado (persistencia)
* `gitea admin user change-password --username admin --password newpassword` Cambiar la contrase√±a
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crear nuevo usuario admin y obtener un token de acceso

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
