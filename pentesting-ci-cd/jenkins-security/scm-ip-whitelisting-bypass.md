# Contournement de la liste blanche d'IP SCM

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Cette page a √©t√© copi√©e de [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Introduction

De nombreuses organisations combinent des syst√®mes de gestion de contr√¥le de source bas√©s sur **SaaS** (comme GitHub ou GitLab) avec une solution **CI** interne et auto-h√©berg√©e (par exemple, Jenkins, TeamCity), permettant √† ces syst√®mes CI de **recevoir des √©v√©nements webhook des fournisseurs de contr√¥le de source SaaS**, dans le simple but de d√©clencher des jobs de pipeline.

Par cons√©quent, les organisations **mettent en liste blanche** les plages d'**IP** du **SCM** leur permettant d'atteindre le syst√®me CI **interne** avec des **webhooks**. Cependant, notez comment **n'importe qui** peut cr√©er un **compte** sur Github ou Gitlab et le faire **d√©clencher un webhook** qui pourrait envoyer une requ√™te √† ce syst√®me CI **interne**.

De plus, notez que bien que la plage d'IP du service de webhook du fournisseur SCM ait √©t√© ouverte dans le pare-feu de l'organisation pour **permettre aux requ√™tes webhook de d√©clencher des pipelines** ‚Äì cela ne **signifie pas** que les requ√™tes webhook ne peuvent pas √™tre **dirig√©es vers d'autres points de terminaison CI**, en plus de ceux qui √©coutent r√©guli√®rement les √©v√©nements webhook. Nous pouvons essayer d'acc√©der √† ces points de terminaison pour **voir des donn√©es pr√©cieuses comme les utilisateurs**, **les pipelines**, **la sortie console** des jobs de pipeline, ou si nous avons la chance de tomber sur une instance qui accorde des privil√®ges d'administrateur aux utilisateurs non authentifi√©s (oui, cela arrive), nous pouvons acc√©der aux **sections de configurations et d'identifiants**.

### Sc√©nario

Imaginez un service **Jenkins** qui **autorise** uniquement les IP de **GitHub** et **GitLab** √† l'atteindre **de l'ext√©rieur**.

Dans ce sc√©nario, un attaquant d√©clenchera des webhooks arbitraires dans GitHub et GitLab pour se connecter √† Jenkins et extraire des informations.

### Limitations courantes des Webhooks

* **Uniquement des requ√™tes POST** : Les webhooks ne vous permettent g√©n√©ralement que d'envoyer des requ√™tes POST, cependant, certains **points de terminaison** avec des informations **int√©ressantes** doivent √™tre accessibles via des requ√™tes **GET**.
* Si le Post est **r√©pondu par une redirection**, il pourrait la suivre.
* Certains CI (Jenkins) permettent d'avoir un **param√®tre GET indiquant o√π rediriger le client** une fois qu'il a r√©ussi √† se connecter, vous pouvez utiliser cela pour le rediriger vers une page sp√©cifique avec un Get.
* **Impossible de contr√¥ler le corps de la requ√™te POST** : Si vous souhaitez envoyer des donn√©es sp√©cifiques dans le corps du POST, vous ne pouvez pas.
* **Jetons CSRF** : Si le point de terminaison int√©ressant attend des jetons CSRF, vous ne pourrez pas les extraire et les fournir.

## Webhooks GitHub

### Abuser de la connexion Jenkins

La connexion n√©cessite l'envoi d'une **requ√™te POST**. Choisir de cibler le point de terminaison de connexion r√©sout le d√©fi de d√©tenir des jetons CSRF, car cette requ√™te sp√©cifique n'en n√©cessite pas. Mais nous sommes toujours confront√©s √† l'autre d√©fi, car nos capacit√©s √† **modifier le corps de la requ√™te restent limit√©es**.

Une requ√™te de connexion Jenkins se pr√©sente comme suit :
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
Nous devons **envoyer les identifiants que nous avons forc√©s par brute force d'une mani√®re ou d'une autre**.\
Heureusement, le point de terminaison de connexion Jenkins **accepte** une requ√™te POST avec les **champs envoy√©s en tant que param√®tres de requ√™te** :
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
Alors, comment pouvons-nous le faire fonctionner ? Nous pouvons **cr√©er un nouveau webhook dans GitHub**, en d√©finissant **l'URL de demande de connexion Jenkins comme URL de payload**. Nous pouvons ensuite cr√©er une automatisation en utilisant l'API GitHub pour **forcer brutalement le mot de passe du compte utilisateur**, en modifiant le champ du mot de passe, en d√©clenchant le webhook et en inspectant la r√©ponse dans le journal des √©v√©nements webhook du d√©p√¥t.
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
```markdown
Nous d√©clenchons le webhook et observons les r√©sultats. Tous les fournisseurs SCM affichent la requ√™te HTTP et la r√©ponse envoy√©es via le webhook dans leur interface utilisateur.
Si la tentative de connexion √©choue, nous sommes redirig√©s vers la page d'erreur de connexion.

Mais si la **connexion r√©ussit**, nous sommes redirig√©s vers la page principale de Jenkins, et un **cookie de session est d√©fini**.

Ainsi, nous pouvons **forcer brutalement les identifiants Jenkins et obtenir un cookie de session !**
Cependant, nous sommes un peu limit√©s - nous ne pouvons envoyer qu'une **requ√™te sans √©tat √† chaque fois**, et le **cookie ne peut pas √™tre attach√©** √† notre requ√™te, car nous ne pouvons pas contr√¥ler les en-t√™tes.

Une autre option serait d'essayer d'obtenir un **jeton d'acc√®s Jenkins**, qui peut √™tre attach√© dans l'URL et utilis√© pour envoyer des requ√™tes POST √† Jenkins sans avoir besoin d'ajouter un jeton CSRF. Cette option est un peu plus complexe car elle n√©cessite qu'un attaquant trouve √† la fois un CI auto-h√©berg√© qui n'est accessible que depuis les plages d'IP SCM et obtienne √©galement un jeton d'acc√®s valide √† ce CI. Donc pour le moment - nous nous concentrerons sur des sc√©narios plus pratiques.

## GitLab Webhooks

### Abuser de la Connexion Jenkins

Essayons d'envoyer la m√™me requ√™te, mais cette fois via GitLab. En raison des m√™mes limitations, nous envoyons la **m√™me requ√™te POST exacte, en ajoutant les identifiants comme param√®tres de requ√™te**.

Nous d√©clenchons la requ√™te, mais contrairement √† GitHub ‚Äì la r√©ponse est 200. Comme dans le dernier exemple, nous avons utilis√© **le service webhook de GitLab pour forcer brutalement un utilisateur et obtenir un cookie de session**, mais cette fois ‚Äì le contenu de la r√©ponse de Jenkins a √©t√© relay√© √† l'interface utilisateur de GitLab, nous fournissant essentiellement **le contenu complet de la page principale de Jenkins.**
C'est parce que **GitLab a suivi la redirection** en ajoutant le **Cookie** √† la requ√™te :

Cela signifie que nous pouvons :

1. forcer brutalement les utilisateurs et d√©couvrir des identifiants valides,
2. utiliser les identifiants valides contre la page de connexion pour se connecter avec succ√®s,
3. obtenir le contenu de la page principale interne de Jenkins.

### Obtenir des Donn√©es Internes de Jenkins

La **connexion Jenkins accepte un param√®tre de redirection** ‚Äì ‚Äú_from_‚Äù. √Ä l'origine utilis√© pour **rediriger les utilisateurs vers la page qu'ils visaient apr√®s s'√™tre connect√©s**, mais dans notre cas ‚Äì une fonctionnalit√© que nous pouvons abuser pour envoyer une requ√™te GET attach√©e avec un cookie de session √† une page interne Jenkins de notre choix. Voyons comment :

1. D√©finissez un webhook avec l'URL suivante :
```
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
Une requ√™te POST est envoy√©e √† Jenkins, et l'authentification r√©ussit.

* Nous obtenons une r√©ponse de redirection 302, avec un cookie de session, et une redirection vers la page de sortie de la console de travail.
* Le service de webhook GitLab suit automatiquement la redirection avec une requ√™te GET envoy√©e √† la page de sortie de la console de travail, avec le cookie de session qui est ajout√© √† la requ√™te :
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* La sortie de la console de t√¢che est renvoy√©e et pr√©sent√©e dans le journal d'√©v√©nements de webhook GitLab de l'attaquant.

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

Il est important de mentionner ici que Jenkins peut √™tre **configur√© soit pour permettre l'acc√®s aux composants internes sans authentification**, soit de mani√®re √† ce que seuls les utilisateurs authentifi√©s puissent acc√©der aux composants internes. Quel impact cela a-t-il sur nous ?

* S'il n'y a **pas d'authentification** configur√©e, nous pouvons faire en sorte que le **service de webhook GitLab acc√®de √† n'importe quelle page interne du CI**, capture la r√©ponse et nous la pr√©sente.
* Si une authentification est configur√©e, nous pouvons essayer de forcer brutalement un utilisateur, puis utiliser les identifiants pour acc√©der √† n'importe quelle page interne (comme dans le point ci-dessus).

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
