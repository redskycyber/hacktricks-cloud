# Terraform Enterpriseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã€ã¾ãŸã¯HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ã”è¦§ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## åŸºæœ¬æƒ…å ±

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise)ã¯ã€[Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs)ã®HashiCorpãŒè‡ªå·±ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã“ã‚Œã¯ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã«**Terraform Cloudã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã‚’æä¾›ã—ã€ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãªã—ã§ã€ç›£æŸ»ãƒ­ã‚°ã‚„SAMLã‚·ãƒ³ã‚°ãƒ«ã‚µã‚¤ãƒ³ã‚ªãƒ³ãªã©ã®è¿½åŠ ã®ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚

ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Terraform Enterpriseã¯ã€IAMè³‡æ ¼æƒ…å ±ã‚„ãã®ä»–ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®Terraformæ“ä½œã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¾ã›ã‚“ã€ï¼ˆ[å‡ºå…¸](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)ï¼‰

{% hint style="info" %}
ã“ã®è¨˜äº‹ã®ç„¦ç‚¹ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ”»æ’ƒã§ã™ãŒã€Terraformã®å®Ÿè¡Œå†…ã§ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã€ä»–ã®æ”»æ’ƒçµŒè·¯ã‚’æä¾›ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãŸã¨ãˆã°ã€ç’°å¢ƒå¤‰æ•°ã«ã¯æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

## ãƒªãƒ¢ãƒ¼ãƒˆTerraformå®Ÿè¡Œ <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloudã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§**ç‹¬è‡ªã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å†…ã®ä½¿ã„æ¨ã¦ä»®æƒ³ãƒã‚·ãƒ³ã§Terraformã‚’å®Ÿè¡Œ**ã—ã¾ã™ã€‚[Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents)ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€Terraformã‚’**ç‹¬è‡ªã®åˆ†é›¢ã•ã‚ŒãŸã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€ã¾ãŸã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ä¸Šã§å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒªãƒ¢ãƒ¼ãƒˆTerraformå®Ÿè¡Œã¯ã€æ™‚ã«ã¯ã€Œãƒªãƒ¢ãƒ¼ãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€Terraform Enterpriseã«é€£çµ¡ã™ã‚‹ãŸã‚ã®APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ã‚³ãƒ³ãƒ†ãƒŠã§**ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[**Terraform APIãƒˆãƒ¼ã‚¯ãƒ³**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens)ã¯ã€**`.atlasv1.`ã‚µãƒ–ã‚¹ãƒˆãƒªãƒ³ã‚°**ã§è­˜åˆ¥ã§ãã¾ã™ã€‚é€šå¸¸ã€`~/.terraform.d/`ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ãŒã€CI/CDãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’æ”»æ’ƒã™ã‚‹ã¨ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„ç’°å¢ƒå¤‰æ•°ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€**çµ„ç¹”ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
ãã—ã¦ã€ã“ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦Workspaceã‚’è¦‹ã¤ã‘ã¾ã™ï¼š
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
ä»Šã€Terraform Enterpriseãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡ã®ãŸã‚ã®è¨­å®šã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[ã“ã®ä¾‹](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)ã‚’å–å¾—ã—ã€Terraform Enterpriseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ›ã‚¹ãƒˆåã‚’æŒ‡å®šã—ã¦**`hostname`ã‚’è¿½åŠ **ã—ã¦ãã ã•ã„ã€‚

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
{% endcode %}

Terraformã‚’åˆæœŸåŒ–ã—ã¦Terraform Enterpriseãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
**TerraformãŒEnterpriseãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚ŒãŸ**ã®ã§ã€æ¬¡ã«ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³[**Terraformã§ã®RCE**](./#rce-in-terraform)ã«å¾“ã†ã ã‘ã§ã™:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### ãƒ”ãƒœãƒƒãƒˆ

ä»¥å‰ã«è¿°ã¹ãŸã‚ˆã†ã«ã€Terraform Enterprise Infraã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ãƒã‚·ãƒ³/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®ãƒã‚·ãƒ³ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚Œã°ã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ[IAMã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã©](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**ï¼‰ã‹ã‚‰**ã‚¯ãƒ©ã‚¦ãƒ‰ã®è³‡æ ¼æƒ…å ±ã‚’åé›†**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€ä»–ã®æ½œåœ¨çš„ãªç§˜å¯†ã‚„APIã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ **ã¨**ç’°å¢ƒå¤‰æ•°**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚\
ã¾ãŸã€ãƒã‚·ãƒ³ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

## ä¿è­·

{% hint style="info" %}
#### ãƒªãƒ¢ãƒ¼ãƒˆæ“ä½œã®ç„¡åŠ¹åŒ– <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloudã®å¤šãã®æ©Ÿèƒ½ã¯ãƒªãƒ¢ãƒ¼ãƒˆå®Ÿè¡Œã«ä¾å­˜ã—ã¦ãŠã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¯ã€Sentinelãƒãƒªã‚·ãƒ¼ã®å¼·åˆ¶ã€ã‚³ã‚¹ãƒˆã®è¦‹ç©ã‚‚ã‚Šã€é€šçŸ¥ãªã©ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¾ã™ã€‚

[å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode)ã‚’**ãƒ­ãƒ¼ã‚«ãƒ«**ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ä»»æ„ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§ãƒªãƒ¢ãƒ¼ãƒˆæ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯Terraformã®çŠ¶æ…‹ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã®ã¿æ©Ÿèƒ½ã—ã€ã™ã¹ã¦ã®å®Ÿè¡Œã¯è‡ªåˆ†è‡ªèº«ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ã‚«ãƒ¼ã§è¡Œã‚ã‚Œã¾ã™ã€‚
{% endhint %}

{% hint style="info" %}
**Terraformãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¶é™**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Terraform Enterpriseã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®Terraformæ“ä½œã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¾ã›ã‚“ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯IAMã®è³‡æ ¼æƒ…å ±ã‚„ãã®ä»–ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)ã€[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows)ã€ã¾ãŸã¯[Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata)ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡ã† ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®githubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
