# Seguridad de Terraform Enterprise

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n b谩sica

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) es la distribuci贸n autohospedada de Hashicorp de [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs). Ofrece a las empresas una **instancia privada de la aplicaci贸n Terraform Cloud**, sin l铆mites de recursos y con caracter铆sticas arquitect贸nicas adicionales de grado empresarial como el registro de auditor铆a y la autenticaci贸n 煤nica SAML.

"De forma predeterminada, Terraform Enterprise **no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia**, que puede contener credenciales IAM u otros datos sensibles" ([fuente](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Si bien el enfoque de este art铆culo se centra en atacar el servicio de metadatos, vale la pena se帽alar que obtener la ejecuci贸n de c贸digo dentro de una ejecuci贸n de Terraform puede proporcionar otras v铆as de ataque. Por ejemplo, se pueden filtrar variables de entorno que pueden contener credenciales sensibles.
{% endhint %}

## Ejecuci贸n remota de Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud ejecuta Terraform en **m谩quinas virtuales desechables en su propia infraestructura en la nube** de forma predeterminada. Puede aprovechar [Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents) para ejecutar Terraform en **su propia infraestructura aislada, privada o local**. A veces se hace referencia a la ejecuci贸n remota de Terraform como "operaciones remotas".

Por lo tanto, con una clave API para contactar con Terraform Enterprise, es posible **ejecutar c贸digo arbitrario en un contenedor en la nube**.

Los [**tokens de API de Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) se pueden identificar por la subcadena **`.atlasv1.`**. Por lo general, se encuentran en `~/.terraform.d/`, pero al atacar plataformas CI/CD y en la nube, es posible encontrarlos en secretos o variables de entorno.

Puede usar este token para **encontrar la organizaci贸n:**

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```

y con esta informaci贸n encontrar el espacio de trabajo:

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```

Ahora necesita crear una configuraci贸n para comunicarse con el backend de Terraform Enterprise. Simplemente obtenga [este ejemplo](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) y **agregue un `hostname`** con el nombre de host de la instancia de Terraform Enterprise:

{% code title="backend_config.tf" %}
```json
terraform {
  backend "remote" {
    hostname = "{{TFE_HOSTNAME}}"
    organization = "{{ORGANIZATION_NAME}}"

    workspaces {
      name = "{{WORKSPACE_NAME}}"
    }
  }
}
```
{% endcode %}

Inicialice su Terraform para usar el token de Terraform Enterprise

```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Verifique si se inicializ贸 correctamente
terraform state list
```

Ahora que tiene **Terraform configurado para contactar con el backend de Enterprise**, simplemente siga la secci贸n [**RCE en Terraform**](./#rce-in-terraform) desde:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoteo

Como se mencion贸 anteriormente, la infraestructura de Terrafomr Enterprise puede ejecutarse en cualquier m谩quina/nube que use agentes. Por lo tanto, si puede ejecutar c贸digo en esta m谩quina, podr铆a recopilar **credenciales de la nube desde el punto final de metadatos (**[**IAM, datos de usuario...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Adem谩s, revise el **sistema de archivos** y las **variables de entorno** en busca de otros secretos y claves API potenciales.\
Tambi茅n, no olvide **revisar la red** donde se encuentra la m谩quina.

## Protecciones

{% hint style="info" %}
#### Desactivar operaciones remotas <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Muchas de las caracter铆sticas de Terraform Cloud dependen de la ejecuci贸n remota y no est谩n disponibles al usar operaciones locales. Esto incluye caracter铆sticas como la aplicaci贸n de pol铆ticas Sentinel, la estimaci贸n de costos y las notificaciones.

Puede desactivar las operaciones remotas para cualquier espacio de trabajo cambiando su [Modo de ejecuci贸n](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) a **Local**. Esto hace que el espacio de trabajo act煤e solo como un backend remoto para el estado de Terraform, con toda la ejecuci贸n que ocurre en sus propias estaciones de trabajo o trabajadores de integraci贸n continua.
{% endhint %}

{% hint style="info" %}
**Restringir el acceso a los metadatos del trabajador de compilaci贸n de Terraform**

De forma predeterminada, Terraform Enterprise no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia, que puede contener credenciales IAM u otros datos sensibles. Consulte la documentaci贸n de [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows) o [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) para obtener m谩s informaci贸n sobre este servicio.
{% endhint %}

## Referencias

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://