# Seguridad en Terraform Enterprise

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) es la distribuci贸n autoalojada de [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs) de hashicorp. Ofrece a las empresas una **instancia privada de la aplicaci贸n Terraform Cloud**, sin l铆mites de recursos y con caracter铆sticas arquitect贸nicas adicionales de nivel empresarial como registro de auditor铆a e inicio de sesi贸n 煤nico SAML.

"Por defecto, Terraform Enterprise **no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia**, que puede contener credenciales IAM u otros datos sensibles" ([fuente](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Aunque el enfoque de este art铆culo est谩 en atacar el servicio de metadatos, vale la pena mencionar que obtener ejecuci贸n de c贸digo dentro de una ejecuci贸n de Terraform puede proporcionar otras v铆as de ataque. Por ejemplo, se podr铆an filtrar variables de entorno que pueden contener credenciales sensibles.
{% endhint %}

## Ejecuci贸n Remota de Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud ejecuta Terraform en **m谩quinas virtuales desechables en su propia infraestructura en la nube** por defecto. Puedes aprovechar los [**Agentes de Terraform Cloud**](https://developer.hashicorp.com/terraform/cloud-docs/agents) para ejecutar Terraform en **tu propia infraestructura aislada, privada o local**. A veces se hace referencia a la ejecuci贸n remota de Terraform como "operaciones remotas".

Por lo tanto, con una clave API para contactar a Terraform Enterprise es posible **ejecutar c贸digo arbitrario en un contenedor en la nube**.

Los [**Tokens de API de Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) se pueden identificar por la subcadena **`.atlasv1.`**. Suelen estar ubicados en `~/.terraform.d/` pero atacando plataformas CI/CD y nubes podr铆as encontrarlos en secretos o variables de entorno.

Puedes usar este token para **encontrar la Organizaci贸n:**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
y con esta informaci贸n encuentra el Workspace:
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
Ahora necesitas crear una configuraci贸n para comunicarte con el backend de Terraform Enterprise. Simplemente obt茅n [este ejemplo](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) y **agrega un `hostname`** con el nombre de host de la instancia de Terraform Enterprise:

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
```markdown
Inicializa tu terraform para usar el token de Terraform Enterprise
```
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
Ahora que tienes **Terraform configurado para contactar con el backend Enterprise** puedes seguir la secci贸n [**RCE en Terraform**](./#rce-in-terraform) desde:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoteo

Como se mencion贸 anteriormente, la infraestructura de Terrafomr Enterprise puede ejecutarse en cualquier m谩quina/proveedor de nube utilizando agentes. Por lo tanto, si puedes ejecutar c贸digo en esta m谩quina, podr铆as obtener **credenciales de la nube desde el punto final de metadatos (**[**IAM, datos de usuario...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Adem谩s, revisa el **sistema de archivos** y las **variables de entorno** en busca de otros secretos potenciales y claves de API.\
Tambi茅n, no olvides **verificar la red** donde se encuentra la m谩quina.

## Protecciones

{% hint style="info" %}
#### Desactivaci贸n de Operaciones Remotas <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Muchas de las caracter铆sticas de Terraform Cloud dependen de la ejecuci贸n remota y no est谩n disponibles al usar operaciones locales. Esto incluye caracter铆sticas como la aplicaci贸n de pol铆ticas Sentinel, estimaci贸n de costos y notificaciones.

Puedes desactivar las operaciones remotas para cualquier Workspace cambiando su [Modo de Ejecuci贸n](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) a **Local**. Esto hace que el Workspace act煤e solo como un backend remoto para el estado de Terraform, con toda la ejecuci贸n ocurriendo en tus propias estaciones de trabajo o trabajadores de integraci贸n continua.
{% endhint %}

{% hint style="info" %}
**Restringir el Acceso a los Metadatos del Worker de Construcci贸n de Terraform**

Por defecto, Terraform Enterprise no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia, que puede contener credenciales IAM u otros datos sensibles. Consulta la documentaci贸n de [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows), o [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) para m谩s informaci贸n sobre este servicio.
{% endhint %}

## Referencias

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
