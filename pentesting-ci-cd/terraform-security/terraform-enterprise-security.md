# Terraform Enterprise ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã‚„[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## åŸºæœ¬æƒ…å ±

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise)ã¯ã€[Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs)ã®hashicorpè‡ªå·±ãƒ›ã‚¹ãƒˆå‹ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãªã—ã§ã€ç›£æŸ»ãƒ­ã‚°ã‚„SAMLã‚·ãƒ³ã‚°ãƒ«ã‚µã‚¤ãƒ³ã‚ªãƒ³ã®ã‚ˆã†ãªè¿½åŠ ã®ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ©Ÿèƒ½ã‚’å‚™ãˆãŸã€Terraform Cloudã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã‚’ä¼æ¥­ã«æä¾›ã—ã¾ã™ã€‚

"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Terraform Enterpriseã¯Terraformã®æ“ä½œãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’**é˜²ãã¾ã›ã‚“**ã€‚ã“ã‚Œã«ã¯IAMã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚„ãã®ä»–ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" ([å‡ºå…¸](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
ã“ã®è¨˜äº‹ã®ç„¦ç‚¹ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ã“ã¨ã§ã™ãŒã€Terraformå®Ÿè¡Œå†…ã§ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’å¾—ã‚‹ã“ã¨ã¯ã€æ”»æ’ƒã®ä»–ã®æ‰‹æ®µã‚’æä¾›ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€æ©Ÿå¯†ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ç’°å¢ƒå¤‰æ•°ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

## ãƒªãƒ¢ãƒ¼ãƒˆTerraformå®Ÿè¡Œ <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloudã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§**ç‹¬è‡ªã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å†…ã®ä½¿ã„æ¨ã¦ã®ä»®æƒ³ãƒã‚·ãƒ³ä¸Šã§Terraformã‚’å®Ÿè¡Œã—ã¾ã™**ã€‚[Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents)ã‚’åˆ©ç”¨ã—ã¦ã€**ç‹¬è‡ªã®åˆ†é›¢ã•ã‚ŒãŸã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€ã¾ãŸã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ä¸Šã§Terraformã‚’å®Ÿè¡Œã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒªãƒ¢ãƒ¼ãƒˆTerraformå®Ÿè¡Œã¯ã€æ™‚ã€…ã€Œãƒªãƒ¢ãƒ¼ãƒˆæ“ä½œã€ã¨å‘¼ã°ã‚Œã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€Terraform Enterpriseã«é€£çµ¡ã™ã‚‹ãŸã‚ã®APIã‚­ãƒ¼ãŒã‚ã‚Œã°ã€**ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ã‚³ãƒ³ãƒ†ãƒŠã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

[**Terraform APIãƒˆãƒ¼ã‚¯ãƒ³**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens)ã¯ã€**`.atlasv1.`ã®éƒ¨åˆ†æ–‡å­—åˆ—**ã«ã‚ˆã£ã¦è­˜åˆ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é€šå¸¸ã¯`~/.terraform.d/`ã«ä½ç½®ã—ã¦ã„ã¾ã™ãŒã€CI/CDãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’æ”»æ’ƒã™ã‚‹éš›ã«ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„ç’°å¢ƒå¤‰æ•°ã®ä¸­ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€**çµ„ç¹”ã‚’è¦‹ã¤ã‘ã‚‹**ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦Workspaceã‚’è¦‹ã¤ã‘ã¾ã™ï¼š
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
```markdown
Terraform Enterpriseãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[ã“ã®ä¾‹](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)ã‚’å–å¾—ã—ã€Terraform Enterpriseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ›ã‚¹ãƒˆåã‚’**`hostname`ã«è¿½åŠ **ã—ã¦ãã ã•ã„ï¼š

{% code title="backend_config.tf" %}
```
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
```
Terraform Enterprise ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã« Terraform ã‚’åˆæœŸåŒ–ã—ã¾ã™
```
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
**TerraformãŒEnterpriseãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚ŒãŸ**ã®ã§ã€ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³[**Terraformã§ã®RCE**](./#rce-in-terraform)ã«å¾“ã£ã¦ãã ã•ã„ï¼š

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### ãƒ”ãƒœãƒƒãƒ†ã‚£ãƒ³ã‚°

ä»¥å‰ã«è¿°ã¹ãŸã‚ˆã†ã«ã€Terrafomr Enterprise Infraã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ãƒã‚·ãƒ³/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®ãƒã‚·ãƒ³ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å ´åˆã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰èªè¨¼æƒ…å ±ã‚’åé›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ**[**IAMã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã©...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**ã€‚\
ã•ã‚‰ã«ã€ä»–ã®æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„APIã‚­ãƒ¼ã«ã¤ã„ã¦ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ **ã¨**ç’°å¢ƒå¤‰æ•°**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚\
ã¾ãŸã€ãƒã‚·ãƒ³ãŒä½ç½®ã™ã‚‹**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹**ã“ã¨ã‚‚å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

## ä¿è­·

{% hint style="info" %}
#### ãƒªãƒ¢ãƒ¼ãƒˆæ“ä½œã®ç„¡åŠ¹åŒ– <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloudã®å¤šãã®æ©Ÿèƒ½ã¯ãƒªãƒ¢ãƒ¼ãƒˆå®Ÿè¡Œã«ä¾å­˜ã—ã¦ãŠã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¯ã€Sentinelãƒãƒªã‚·ãƒ¼ã®å¼·åˆ¶ã€ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šã€é€šçŸ¥ãªã©ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¾ã™ã€‚

ä»»æ„ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒªãƒ¢ãƒ¼ãƒˆæ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹ã«ã¯ã€ãã®[å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode)ã‚’**ãƒ­ãƒ¼ã‚«ãƒ«**ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¯Terraformã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã®ã¿æ©Ÿèƒ½ã—ã€ã™ã¹ã¦ã®å®Ÿè¡Œã¯è‡ªåˆ†ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ã‚«ãƒ¼ã§è¡Œã‚ã‚Œã¾ã™ã€‚
{% endhint %}

{% hint style="info" %}
**Terraformãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¶é™**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Terraform Enterpriseã¯Terraformæ“ä½œãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’é˜²ãã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¯IAMèªè¨¼æƒ…å ±ã‚„ãã®ä»–ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€[AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)ã€[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows)ã€ã¾ãŸã¯[Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata)ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ã”è¦§ãã ã•ã„ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
