# GCP - è®¡ç®—æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## GCP VPC & ç½‘ç»œ

äº†è§£è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### æšä¸¾

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

æ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)æ‰¾åˆ°å…·æœ‰å¼€æ”¾é˜²ç«å¢™è§„åˆ™çš„è®¡ç®—å®ä¾‹

## è®¡ç®—å®ä¾‹

è¿™æ˜¯æ‚¨å¯ä»¥åœ¨GCPå†…éƒ¨è¿è¡Œè™šæ‹Ÿæœºçš„æ–¹å¼ã€‚æŸ¥çœ‹æ­¤é¡µé¢ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### æšä¸¾
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### ç‰¹æƒå‡çº§

åœ¨ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨è®¡ç®—æƒé™ä»¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„æšä¸¾

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### åæœŸåˆ©ç”¨

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## ä¸²è¡Œæ§åˆ¶å°æ—¥å¿—

Compute Engine ä¸²è¡Œæ§åˆ¶å°æ—¥å¿—æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸æ‚¨**æŸ¥çœ‹å’Œè¯Šæ–­è™šæ‹Ÿæœºå®ä¾‹çš„å¼•å¯¼å’Œæ“ä½œç³»ç»Ÿæ—¥å¿—**ã€‚

ä¸²è¡Œæ§åˆ¶å°æ—¥å¿—æä¾›äº†å®ä¾‹å¼•å¯¼è¿‡ç¨‹çš„**ä½çº§è§†å›¾**ï¼ŒåŒ…æ‹¬å†…æ ¸æ¶ˆæ¯ã€init è„šæœ¬å’Œå¼•å¯¼æœŸé—´å‘ç”Ÿçš„å…¶ä»–ç³»ç»Ÿäº‹ä»¶ã€‚è¿™å¯¹äºè°ƒè¯•å¼•å¯¼é—®é¢˜ã€è¯†åˆ«é…ç½®é”™è¯¯æˆ–è½¯ä»¶é”™è¯¯ï¼Œæˆ–è§£å†³ç½‘ç»œè¿æ¥é—®é¢˜éå¸¸æœ‰ç”¨ã€‚

è¿™äº›æ—¥å¿—**å¯èƒ½ä¼šæš´éœ²ç³»ç»Ÿæ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯**ï¼Œä½ç‰¹æƒç”¨æˆ·é€šå¸¸æ— æ³•çœ‹åˆ°ï¼Œä½†å…·æœ‰é€‚å½“ IAM æƒé™çš„ç”¨æˆ·å¯èƒ½èƒ½å¤Ÿé˜…è¯»å®ƒä»¬ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹[gcloud å‘½ä»¤](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)æ¥æŸ¥è¯¢ä¸²è¡Œç«¯å£æ—¥å¿—ï¼ˆæ‰€éœ€æƒé™ä¸º `compute.instances.getSerialPortOutput`ï¼‰:
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## æ“ä½œç³»ç»Ÿé…ç½®ç®¡ç†å™¨

æ‚¨å¯ä»¥ä½¿ç”¨æ“ä½œç³»ç»Ÿé…ç½®ç®¡ç†æœåŠ¡æ¥éƒ¨ç½²ã€æŸ¥è¯¢å’Œç»´æŠ¤è™šæ‹Ÿæœºå®ä¾‹ï¼ˆVMï¼‰çš„ä¸€è‡´é…ç½®ï¼ˆæœŸæœ›çŠ¶æ€å’Œè½¯ä»¶ï¼‰ã€‚åœ¨Compute Engineä¸Šï¼Œæ‚¨å¿…é¡»ä½¿ç”¨[guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy)æ¥ç»´æŠ¤è™šæ‹Ÿæœºä¸Šçš„ä¸€è‡´è½¯ä»¶é…ç½®ã€‚

æ“ä½œç³»ç»Ÿé…ç½®ç®¡ç†åŠŸèƒ½å…è®¸æ‚¨å®šä¹‰é…ç½®ç­–ç•¥ï¼ŒæŒ‡å®šåº”å®‰è£…å“ªäº›è½¯ä»¶åŒ…ï¼Œåº”å¯ç”¨å“ªäº›æœåŠ¡ï¼Œä»¥åŠåº”åœ¨æ‚¨çš„VMä¸Šå­˜åœ¨å“ªäº›æ–‡ä»¶æˆ–é…ç½®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å£°æ˜æ€§æ–¹æ³•æ¥ç®¡ç†VMçš„è½¯ä»¶é…ç½®ï¼Œè¿™ä½¿æ‚¨èƒ½å¤Ÿæ›´è½»æ¾åœ°è‡ªåŠ¨åŒ–å’Œæ‰©å±•é…ç½®ç®¡ç†è¿‡ç¨‹ã€‚

è¿™ä¹Ÿå…è®¸é€šè¿‡IAMæƒé™ç™»å½•å®ä¾‹ï¼Œå› æ­¤éå¸¸**æœ‰ç”¨äºæƒé™æå‡å’Œæ¢çº½**ã€‚

{% hint style="warning" %}
ä¸ºäº†åœ¨æ•´ä¸ªé¡¹ç›®æˆ–å®ä¾‹ä¸­**å¯ç”¨æ“ä½œç³»ç»Ÿé…ç½®**ï¼Œæ‚¨åªéœ€è¦åœ¨æ‰€éœ€çº§åˆ«å°†**`enable-oslogin`**å…ƒæ•°æ®é”®è®¾ç½®ä¸º**`true`**ã€‚\
æ­¤å¤–ï¼Œæ‚¨å¯ä»¥å°†å…ƒæ•°æ®**`enable-oslogin-2fa`**è®¾ç½®ä¸º**`true`**ä»¥å¯ç”¨åŒå› ç´ è®¤è¯ã€‚

åœ¨åˆ›å»ºå®ä¾‹æ—¶å¯ç”¨å®ƒæ—¶ï¼Œå…ƒæ•°æ®é”®å°†è‡ªåŠ¨è®¾ç½®ã€‚
{% endhint %}

å…³äº**OS-configä¸­çš„åŒå› ç´ è®¤è¯**ï¼Œ**ä»…é€‚ç”¨äºç”¨æˆ·**ï¼Œå¦‚æœæ˜¯SAï¼ˆå¦‚è®¡ç®—SAï¼‰ï¼Œåˆ™ä¸éœ€è¦ä»»ä½•é¢å¤–æ“ä½œã€‚

### æšä¸¾
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## é•œåƒ

### è‡ªå®šä¹‰é•œåƒ

è‡ªå®šä¹‰è®¡ç®—æœºé•œåƒå¯èƒ½åŒ…å«æ•æ„Ÿç»†èŠ‚æˆ–å…¶ä»–æ˜“å—æ”»å‡»çš„é…ç½®ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯ã€‚

åˆ›å»ºé•œåƒæ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©3ç§åŠ å¯†ç±»å‹ï¼šä½¿ç”¨Googleæ‰˜ç®¡å¯†é’¥ï¼ˆé»˜è®¤ï¼‰ã€æ¥è‡ªKMSçš„å¯†é’¥ï¼Œæˆ–å®¢æˆ·æä¾›çš„åŸå§‹å¯†é’¥ã€‚

#### æšä¸¾

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥è¯¢é¡¹ç›®ä¸­éæ ‡å‡†é•œåƒçš„åˆ—è¡¨ï¼š

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

ç„¶åï¼Œæ‚¨å¯ä»¥ä»¥å¤šç§æ ¼å¼[**å¯¼å‡º**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)æ¥è‡ªä»»ä½•é•œåƒçš„**è™šæ‹Ÿç£ç›˜**ã€‚ä»¥ä¸‹å‘½ä»¤å°†ä»¥qcow2æ ¼å¼å¯¼å‡ºå›¾åƒ`test-image`ï¼Œä½¿æ‚¨èƒ½å¤Ÿä¸‹è½½è¯¥æ–‡ä»¶å¹¶åœ¨æœ¬åœ°æ„å»ºè™šæ‹Ÿæœºä»¥è¿›è¡Œè¿›ä¸€æ­¥è°ƒæŸ¥ï¼š
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### ææƒ

æ£€æŸ¥è®¡ç®—å®ä¾‹ç‰¹æƒæå‡éƒ¨åˆ†ã€‚

### è‡ªå®šä¹‰å®ä¾‹æ¨¡æ¿

ä¸€ä¸ª[**å®ä¾‹æ¨¡æ¿**](https://cloud.google.com/compute/docs/instance-templates/) **å®šä¹‰å®ä¾‹å±æ€§**ä»¥å¸®åŠ©éƒ¨ç½²ä¸€è‡´çš„é…ç½®ã€‚è¿™äº›å¯èƒ½åŒ…å«ä¸è¿è¡Œå®ä¾‹çš„è‡ªå®šä¹‰å…ƒæ•°æ®ç›¸åŒç±»å‹çš„æ•æ„Ÿæ•°æ®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œè°ƒæŸ¥ï¼š
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
å¯èƒ½ä¼šå¾ˆæœ‰è¶£çŸ¥é“æ–°æ˜ åƒæ­£åœ¨ä½¿ç”¨å“ªä¸ªç£ç›˜ï¼Œä½†è¿™äº›æ¨¡æ¿é€šå¸¸ä¸ä¼šåŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚

## å¿«ç…§

**å¿«ç…§æ˜¯ç£ç›˜çš„å¤‡ä»½**ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸å…‹éš†ç£ç›˜ï¼ˆå¦ä¸€ä¸ªå¯ç”¨åŠŸèƒ½ï¼‰ä¸åŒã€‚\
**å¿«ç…§**å°†ä½¿ç”¨ä¸å…¶æ¥æºç£ç›˜**ç›¸åŒçš„åŠ å¯†**ã€‚

### æšä¸¾
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### ææƒ

æ£€æŸ¥è®¡ç®—å®ä¾‹ææƒéƒ¨åˆ†ã€‚

## å‚è€ƒ

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
