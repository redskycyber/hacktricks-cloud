# GCP - Enumeraci贸n de instancias de c贸mputo

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GCP VPC y Networking

Aprende sobre c贸mo funciona esto en:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeraci贸n

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
                name,
                network,
                direction,
                priority,
                sourceRanges.list():label=SRC_RANGES,
                destinationRanges.list():label=DEST_RANGES,
                allowed[].map().firewall_rule().list():label=ALLOW,
                denied[].map().firewall_rule().list():label=DENY,
                sourceTags.list():label=SRC_TAGS,
                sourceServiceAccounts.list():label=SRC_SVC_ACCT,
                targetTags.list():label=TARGET_TAGS,
                targetServiceAccounts.list():label=TARGET_SVC_ACCT,
                disabled
            )"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Puedes encontrar f谩cilmente instancias de c贸mputo con reglas de firewall abiertas con [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancias de c贸mputo

Estas son la forma en que puedes **ejecutar m谩quinas virtuales dentro de GCP.**

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Enumeraci贸n

```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```

Para obtener m谩s informaci贸n sobre c贸mo **SSH** o **modificar los metadatos** de una instancia para **escalar privilegios**, consulte esta p谩gina:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalada de privilegios

En la siguiente p谩gina, puedes verificar c贸mo **abusar de los permisos de c贸mputo para escalar privilegios**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Registros de la consola serial

Los registros de la consola serial de Compute Engine son una funci贸n que le permite **ver y diagnosticar los registros de arranque y del sistema operativo** de las instancias de m谩quinas virtuales.

Los registros de la consola serial proporcionan una **vista de bajo nivel del proceso de arranque de la instancia**, incluidos los mensajes del kernel, los scripts de inicio y otros eventos del sistema que ocurren durante el arranque. Esto puede ser 煤til para solucionar problemas de arranque, identificar configuraciones incorrectas o errores de software, o solucionar problemas de conectividad de red.

Estos registros **pueden exponer informaci贸n confidencial** de los registros del sistema que un usuario con pocos privilegios normalmente no ver铆a, pero con los permisos IAM apropiados, es posible que pueda leerlos.

Puede utilizar el siguiente [comando de gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar los registros del puerto serie (el permiso requerido es `compute.instances.getSerialPortOutput`):

```bash
gcloud compute instances get-serial-port-output <instance-name>
```

## Administrador de configuraci贸n del sistema operativo

Puede utilizar el servicio de administraci贸n de configuraci贸n del sistema operativo para **implementar, consultar y mantener configuraciones consistentes** (estado deseado y software) para su instancia de VM (VM). En Compute Engine, debe utilizar [pol铆ticas de invitados](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para mantener configuraciones de software consistentes en una VM.

La funci贸n de administraci贸n de configuraci贸n del sistema operativo le permite definir pol铆ticas de configuraci贸n que especifiquen qu茅 paquetes de software deben instalarse, qu茅 servicios deben habilitarse y qu茅 archivos o configuraciones deben estar presentes en sus VM. Puede utilizar un enfoque declarativo para administrar la configuraci贸n de software de sus VM, lo que le permite automatizar y escalar su proceso de administraci贸n de configuraci贸n con mayor facilidad.

Esto tambi茅n permite iniciar sesi贸n en instancias a trav茅s de permisos IAM, por lo que es muy **煤til para la escalada de privilegios y el pivoteo**.

{% hint style="warning" %}
Para **habilitar os-config en todo un proyecto o en una instancia**, solo necesita establecer la clave de **metadatos** **`enable-oslogin`** en **`true`** en el nivel deseado.\
Adem谩s, puede establecer los metadatos **`enable-oslogin-2fa`** en **`true`** para habilitar el 2fa.

Cuando lo habilitas al crear una instancia, las claves de metadatos se establecer谩n autom谩ticamente.
{% endhint %}

M谩s sobre **2fa en OS-config**, **solo se aplica si el usuario es un usuario**, si es un SA (como el SA de c贸mputo) no requerir谩 nada adicional.

### Enumeraci贸n

```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
``
# Obtener los detalles de una plantilla espec铆fica
gcloud compute instance-templates describe [NOMBRE DE LA PLANTILLA]

```

Podr铆a ser interesante saber qu茅 disco est谩n usando las nuevas im谩genes, pero estas plantillas normalmente no tendr谩n informaci贸n sensible.

## Instant谩neas

Las **instant谩neas son copias de seguridad de discos**. Tenga en cuenta que esto no es lo mismo que clonar un disco (otra funci贸n disponible).\
La **instant谩nea** utilizar谩 el **mismo cifrado que el disco** del que se ha tomado.

### Enumeraci贸n

```
gcloud compute snapshots list
gcloud compute snapshots describe <instant谩nea>
gcloud compute snapshots get-iam-policy <instant谩nea>
```

### Escalada de privilegios

Consulte la secci贸n de escalada de privilegios de las instancias de c贸mputo.

## Referencias

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>