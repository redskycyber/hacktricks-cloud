# GCP - VPCå’Œç½‘ç»œ

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘**[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## **GCPè®¡ç®—æœºç½‘ç»œç®€ä»‹**

**VPC**åŒ…å«ç”¨äºå…è®¸æµå…¥VPCçš„æµé‡çš„**é˜²ç«å¢™**è§„åˆ™ã€‚VPCè¿˜åŒ…å«**å­ç½‘**ï¼Œè™šæ‹Ÿæœºå°†è¿æ¥åˆ°è¿™äº›å­ç½‘ä¸Šã€‚\
ä¸AWSç›¸æ¯”ï¼Œ**é˜²ç«å¢™**æ˜¯ä¸**å®‰å…¨ç»„**æœ€æ¥è¿‘çš„ä¸œè¥¿ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯åœ¨VPCä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªå®ä¾‹ä¸­å®šä¹‰çš„ã€‚

## **GCPä¸­çš„VPCã€å­ç½‘å’Œé˜²ç«å¢™**

è®¡ç®—å®ä¾‹è¿æ¥åˆ°**å­ç½‘**ï¼Œå­ç½‘æ˜¯**VPC**ï¼ˆ[Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚åœ¨GCPä¸­ï¼Œæ²¡æœ‰å®‰å…¨ç»„ï¼Œè€Œæ˜¯å…·æœ‰åœ¨æ­¤ç½‘ç»œçº§åˆ«å®šä¹‰ä½†åº”ç”¨äºæ¯ä¸ªVMå®ä¾‹çš„[**VPCé˜²ç«å¢™**](https://cloud.google.com/vpc/docs/firewalls)ã€‚

### å­ç½‘

ä¸€ä¸ª**VPC**å¯ä»¥æœ‰**å¤šä¸ªå­ç½‘**ã€‚æ¯ä¸ª**å­ç½‘ä½äºä¸€ä¸ªåŒºåŸŸ**ã€‚

### é˜²ç«å¢™

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç½‘ç»œéƒ½æœ‰ä¸¤ä¸ª[**éšå«çš„é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)ï¼š**å…è®¸å‡ºç«™**å’Œ**æ‹’ç»å…¥ç«™**ã€‚

å½“åˆ›å»ºä¸€ä¸ªGCPé¡¹ç›®æ—¶ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªåä¸º**`default`**çš„VPCï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é˜²ç«å¢™è§„åˆ™ï¼š

* **default-allow-internalï¼š**å…è®¸æ¥è‡ª`default`ç½‘ç»œä¸Šå…¶ä»–å®ä¾‹çš„æ‰€æœ‰æµé‡
* **default-allow-sshï¼š**å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„22ç«¯å£
* **default-allow-rdpï¼š**å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„3389ç«¯å£
* **default-allow-icmpï¼š**å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ping

{% hint style="warning" %}
æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œ**é˜²ç«å¢™è§„åˆ™**å¯¹äº**å†…éƒ¨IPåœ°å€**å¾€å¾€æ›´åŠ **å®½æ¾**ã€‚é»˜è®¤çš„VPCå…è®¸è®¡ç®—å®ä¾‹ä¹‹é—´çš„æ‰€æœ‰æµé‡ã€‚
{% endhint %}

å¯ä»¥ä¸ºé»˜è®¤VPCæˆ–æ–°VPCåˆ›å»ºæ›´å¤šçš„**é˜²ç«å¢™è§„åˆ™**ã€‚[**é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls)å¯ä»¥é€šè¿‡ä»¥ä¸‹**æ–¹æ³•**åº”ç”¨äºå®ä¾‹ï¼š

* [**ç½‘ç»œæ ‡ç­¾**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**æœåŠ¡å¸å·**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPCä¸­çš„æ‰€æœ‰å®ä¾‹**

ä¸å¹¸çš„æ˜¯ï¼Œæ²¡æœ‰ä¸€ä¸ªç®€å•çš„`gcloud`å‘½ä»¤å¯ä»¥åˆ—å‡ºæ‰€æœ‰åœ¨äº’è”ç½‘ä¸Šå¼€æ”¾ç«¯å£çš„è®¡ç®—å®ä¾‹ã€‚æ‚¨å¿…é¡»å°†é˜²ç«å¢™è§„åˆ™ã€ç½‘ç»œæ ‡ç­¾ã€æœåŠ¡å¸å·å’Œå®ä¾‹è”ç³»èµ·æ¥ã€‚

ä½¿ç”¨[æ­¤Pythonè„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)è‡ªåŠ¨åŒ–äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ƒå°†å¯¼å‡ºä»¥ä¸‹å†…å®¹ï¼š

* CSVæ–‡ä»¶æ˜¾ç¤ºå®ä¾‹ã€å…¬å…±IPã€å…è®¸çš„TCPã€å…è®¸çš„UDP
* é’ˆå¯¹ä»å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰å…è®¸å…¥å£çš„æ‰€æœ‰å®ä¾‹è¿›è¡Œçš„nmapæ‰«æ
* é’ˆå¯¹ä»å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰å…è®¸æ‰€æœ‰TCPç«¯å£çš„è¿™äº›å®ä¾‹çš„å®Œæ•´TCPèŒƒå›´è¿›è¡Œçš„masscanæ‰«æ

### åˆ†å±‚é˜²ç«å¢™ç­–ç•¥ <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_åˆ†å±‚é˜²ç«å¢™ç­–ç•¥_å…è®¸æ‚¨åœ¨æ•´ä¸ªç»„ç»‡ä¸­åˆ›å»ºå’Œ**å¼ºåˆ¶æ‰§è¡Œä¸€è‡´çš„é˜²ç«å¢™ç­–ç•¥**ã€‚æ‚¨å¯ä»¥å°†**åˆ†å±‚é˜²ç«å¢™ç­–ç•¥åˆ†é…ç»™ç»„ç»‡**ä½œä¸ºæ•´ä½“æˆ–ä¸ªåˆ«**æ–‡ä»¶å¤¹**ã€‚è¿™äº›ç­–ç•¥åŒ…å«å¯ä»¥æ˜ç¡®æ‹’ç»æˆ–å…è®¸è¿æ¥çš„è§„åˆ™ã€‚

æ‚¨å¯ä»¥å°†é˜²ç«å¢™ç­–ç•¥çš„åˆ›å»ºå’Œåº”ç”¨ä½œä¸ºå•ç‹¬çš„æ­¥éª¤ã€‚æ‚¨å¯ä»¥åœ¨**èµ„æºå±‚æ¬¡ç»“æ„**ï¼ˆ[**resource hierarchy**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)ï¼‰çš„**ç»„ç»‡æˆ–æ–‡ä»¶å¤¹èŠ‚ç‚¹**ä¸Šåˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™å¯ä»¥**é˜»æ­¢è¿æ¥ã€å…è®¸è¿æ¥æˆ–å°†é˜²ç«å¢™è§„åˆ™è¯„ä¼°æ¨è¿Ÿ**åˆ°è¾ƒä½çº§åˆ«çš„æ–‡ä»¶å¤¹æˆ–åœ¨VPCç½‘ç»œä¸­å®šä¹‰çš„VPCé˜²ç«å¢™è§„åˆ™ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰åˆ†å±‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™éƒ½é€‚ç”¨äºä¸ç­–ç•¥å…³è”çš„ç»„ç»‡æˆ–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰é¡¹ç›®ä¸­çš„æ‰€æœ‰VMã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‡å®š[ç›®æ ‡ç½‘ç»œæˆ–ç›®æ ‡æœåŠ¡å¸å·](https://cloud.google.com/vpc/docs/firewall-policies#targets)æ¥**é™åˆ¶å“ªäº›VMè·å¾—ç‰¹å®šè§„åˆ™**ã€‚

æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å¦‚ä½•[**åˆ›å»ºåˆ†å±‚é˜²ç«å¢™ç­–ç•¥**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ã€‚

### é˜²ç«å¢™è§„åˆ™è¯„ä¼°

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## åŒºåŸŸé˜²ç«å¢™ç­–ç•¥

è¿™äº›æ˜¯**åˆ†é…ç»™åŒºåŸŸçš„é˜²ç«å¢™è§„åˆ™**ã€‚

## VPCç½‘ç»œå¯¹ç­‰è¿æ¥

å…è®¸è¿æ¥ä¸¤ä¸ªè™šæ‹Ÿä¸“ç”¨äº‘ï¼ˆVPCï¼‰ç½‘ç»œï¼Œä»¥ä¾¿**æ¯ä¸ªç½‘ç»œä¸­çš„èµ„æºå¯ä»¥å½¼æ­¤é€šä¿¡**ã€‚\
å¯¹ç­‰VPCç½‘ç»œå¯ä»¥ä½äºåŒä¸€ä¸ªé¡¹ç›®ã€åŒä¸€ç»„ç»‡çš„ä¸åŒé¡¹ç›®ï¼Œæˆ–è€…**ä¸åŒç»„ç»‡çš„ä¸åŒé¡¹ç›®**ä¸­ã€‚

éœ€è¦ä»¥ä¸‹æƒé™ï¼š

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**æ›´å¤šä¿¡æ¯è¯·å‚é˜…æ–‡æ¡£**](https://cloud.google.com/vpc/docs/vpc-peering)ã€‚
## å‚è€ƒèµ„æ–™

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥ **åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
