# GCP - VPC & R√©seautage

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **R√©seautage des instances de calcul GCP en bref**

Les **VPCs** contiennent des r√®gles de **Firewall** pour autoriser le trafic entrant vers le VPC. Les VPCs contiennent √©galement des **sous-r√©seaux** o√π les **machines virtuelles** vont √™tre **connect√©es**.\
En comparaison avec AWS, **Firewall** serait la chose la **plus proche** des **Security Groups**, mais dans ce cas, ces derniers sont **d√©finis dans le VPC** et non dans chaque instance.

## **VPC, Sous-r√©seaux & Firewalls dans GCP**

Les instances de calcul sont connect√©es √† des **sous-r√©seaux** qui font partie des **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Dans GCP, il n'y a pas de groupes de s√©curit√©, il y a des [**firewalls VPC**](https://cloud.google.com/vpc/docs/firewalls) avec des r√®gles d√©finies √† ce niveau de r√©seau mais appliqu√©es √† chaque instance de VM.

### Sous-r√©seaux

Un **VPC** peut avoir **plusieurs sous-r√©seaux**. Chaque **sous-r√©seau est dans 1 r√©gion**.

### Firewalls

Par d√©faut, chaque r√©seau a deux [**r√®gles de firewall implicites**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules) : **autoriser le trafic sortant** et **refuser le trafic entrant**.

Lorsqu'un projet GCP est cr√©√©, un VPC appel√© **`default`** est √©galement cr√©√©, avec les r√®gles de firewall suivantes :

* **default-allow-internal :** autoriser tout le trafic provenant d'autres instances sur le r√©seau `default`
* **default-allow-ssh :** autoriser le port 22 de partout
* **default-allow-rdp :** autoriser le port 3389 de partout
* **default-allow-icmp :** autoriser le ping de partout

{% hint style="warning" %}
Comme vous pouvez le voir, les **r√®gles de firewall** ont tendance √† √™tre **plus permissives** pour les **adresses IP internes**. Le VPC par d√©faut autorise tout le trafic entre les instances de calcul.
{% endhint %}

Plus de **r√®gles de Firewall** peuvent √™tre cr√©√©es pour le VPC par d√©faut ou pour de nouveaux VPCs. Les [**r√®gles de Firewall**](https://cloud.google.com/vpc/docs/firewalls) peuvent √™tre appliqu√©es aux instances via les **m√©thodes** suivantes :

* [**√âtiquettes de r√©seau**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Comptes de service**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Toutes les instances au sein d'un VPC**

Malheureusement, il n'existe pas de commande `gcloud` simple pour lister toutes les instances de calcul avec des ports ouverts sur Internet. Vous devez relier les points entre les r√®gles de firewall, les √©tiquettes de r√©seau, les comptes de service et les instances.

Ce processus a √©t√© automatis√© en utilisant [ce script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) qui exportera les √©l√©ments suivants :

* Fichier CSV montrant l'instance, l'IP publique, le TCP autoris√©, l'UDP autoris√©
* Scan nmap pour cibler toutes les instances sur les ports autoris√©s en entr√©e depuis Internet public (0.0.0.0/0)
* Masscan pour cibler la gamme compl√®te des ports TCP de ces instances qui autorisent TOUS les ports TCP depuis Internet public (0.0.0.0/0)

### Politiques de Firewall Hi√©rarchiques <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Les _politiques de firewall hi√©rarchiques_ vous permettent de cr√©er et **d'appliquer une politique de firewall coh√©rente dans toute votre organisation**. Vous pouvez attribuer **des politiques de firewall hi√©rarchiques √† l'organisation** dans son ensemble ou √† des **dossiers** individuels. Ces politiques contiennent des r√®gles qui peuvent explicitement refuser ou autoriser les connexions.

Vous cr√©ez et appliquez des politiques de firewall en deux √©tapes s√©par√©es. Vous pouvez cr√©er et appliquer des politiques de firewall aux **n≈ìuds organisationnels ou de dossiers de la** [**hi√©rarchie des ressources**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Une r√®gle de politique de firewall peut **bloquer les connexions, autoriser les connexions, ou diff√©rer l'√©valuation des r√®gles de firewall** aux dossiers de niveau inf√©rieur ou aux r√®gles de firewall des VPC d√©finies dans les r√©seaux VPC.

Par d√©faut, toutes les r√®gles de politique de firewall hi√©rarchique s'appliquent √† toutes les VM dans tous les projets sous l'organisation ou le dossier o√π la politique est associ√©e. Cependant, vous pouvez **restreindre les VM qui re√ßoivent une r√®gle donn√©e** en sp√©cifiant [des r√©seaux cibles ou des comptes de service cibles](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Vous pouvez lire ici comment [**cr√©er une Politique de Firewall Hi√©rarchique**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### √âvaluation des R√®gles de Firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Politiques de Firewall R√©gionales

Ce sont des **r√®gles de Firewall attribu√©es √† une r√©gion**.

## Interconnexion de R√©seaux VPC

Permet de connecter deux r√©seaux Virtual Private Cloud (VPC) afin que les **ressources de chaque r√©seau puissent communiquer** entre elles.\
Les r√©seaux VPC interconnect√©s peuvent √™tre dans le m√™me projet, diff√©rents projets de la m√™me organisation, ou **diff√©rents projets de diff√©rentes organisations**.

Voici les permissions n√©cessaires :

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Plus dans la documentation**](https://cloud.google.com/vpc/docs/vpc-peering).
## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
