# GCP - VPC & ç½‘ç»œ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **GCPè®¡ç®—ç½‘ç»œç®€ä»‹**

**VPCs** åŒ…å«**é˜²ç«å¢™**è§„åˆ™ï¼Œå…è®¸æµé‡è¿›å…¥VPCã€‚VPCsè¿˜åŒ…å«**å­ç½‘**ï¼Œ**è™šæ‹Ÿæœº**å°†ä¼š**è¿æ¥**åˆ°è¿™äº›å­ç½‘ã€‚\
ä¸AWSç›¸æ¯”ï¼Œ**é˜²ç«å¢™**ä¸**å®‰å…¨ç»„**æœ€ä¸º**ç›¸ä¼¼**ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé˜²ç«å¢™è§„åˆ™æ˜¯åœ¨**VPCä¸­å®šä¹‰**çš„ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªå®ä¾‹ä¸­å®šä¹‰ã€‚

## **GCPä¸­çš„VPCã€å­ç½‘å’Œé˜²ç«å¢™**

è®¡ç®—å®ä¾‹è¿æ¥åˆ°**å­ç½‘**ï¼Œè¿™äº›å­ç½‘æ˜¯**VPCs**ï¼ˆ[è™šæ‹Ÿç§æœ‰äº‘](https://cloud.google.com/vpc/docs/vpc)ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚åœ¨GCPä¸­æ²¡æœ‰å®‰å…¨ç»„ï¼Œæœ‰çš„æ˜¯[**VPCé˜²ç«å¢™**](https://cloud.google.com/vpc/docs/firewalls)ï¼Œè§„åˆ™åœ¨ç½‘ç»œçº§åˆ«å®šä¹‰ï¼Œä½†åº”ç”¨äºæ¯ä¸ªVMå®ä¾‹ã€‚

### å­ç½‘

ä¸€ä¸ª**VPC**å¯ä»¥æœ‰**å‡ ä¸ªå­ç½‘**ã€‚æ¯ä¸ª**å­ç½‘ä½äº1ä¸ªåŒºåŸŸ**ã€‚

### é˜²ç«å¢™

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç½‘ç»œéƒ½æœ‰ä¸¤ä¸ª[**éšå«çš„é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules)ï¼š**å…è®¸å‡ºç«™**å’Œ**æ‹’ç»å…¥ç«™**ã€‚

å½“åˆ›å»ºGCPé¡¹ç›®æ—¶ï¼Œä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªåä¸º**`default`**çš„VPCï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é˜²ç«å¢™è§„åˆ™ï¼š

* **default-allow-internal:** å…è®¸æ¥è‡ª`default`ç½‘ç»œä¸Šå…¶ä»–å®ä¾‹çš„æ‰€æœ‰æµé‡
* **default-allow-ssh:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„22ç«¯å£
* **default-allow-rdp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„3389ç«¯å£
* **default-allow-icmp:** å…è®¸æ¥è‡ªä»»ä½•åœ°æ–¹çš„ping

{% hint style="warning" %}
å¦‚æ‚¨æ‰€è§ï¼Œ**é˜²ç«å¢™è§„åˆ™**å¯¹**å†…éƒ¨IPåœ°å€**å¾€å¾€**æ›´å®½æ¾**ã€‚é»˜è®¤VPCå…è®¸è®¡ç®—å®ä¾‹ä¹‹é—´çš„æ‰€æœ‰æµé‡ã€‚
{% endhint %}

å¯ä»¥ä¸ºé»˜è®¤VPCæˆ–æ–°VPCåˆ›å»ºæ›´å¤š**é˜²ç«å¢™è§„åˆ™**ã€‚[**é˜²ç«å¢™è§„åˆ™**](https://cloud.google.com/vpc/docs/firewalls)å¯ä»¥é€šè¿‡ä»¥ä¸‹**æ–¹æ³•**åº”ç”¨äºå®ä¾‹ï¼š

* [**ç½‘ç»œæ ‡ç­¾**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**æœåŠ¡è´¦æˆ·**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPCå†…çš„æ‰€æœ‰å®ä¾‹**

é—æ†¾çš„æ˜¯ï¼Œæ²¡æœ‰ä¸€ä¸ªç®€å•çš„`gcloud`å‘½ä»¤å¯ä»¥è¾“å‡ºæ‰€æœ‰å¼€æ”¾ç«¯å£åœ¨äº’è”ç½‘ä¸Šçš„è®¡ç®—å®ä¾‹ã€‚æ‚¨å¿…é¡»è¿æ¥é˜²ç«å¢™è§„åˆ™ã€ç½‘ç»œæ ‡ç­¾ã€æœåŠ¡è´¦æˆ·å’Œå®ä¾‹ä¹‹é—´çš„ç‚¹ã€‚

è¿™ä¸ªè¿‡ç¨‹ä½¿ç”¨[è¿™ä¸ªpythonè„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum)è‡ªåŠ¨åŒ–ï¼Œå®ƒå°†å¯¼å‡ºä»¥ä¸‹å†…å®¹ï¼š

* æ˜¾ç¤ºå®ä¾‹ã€å…¬å…±IPã€å…è®¸çš„TCPã€å…è®¸çš„UDPçš„CSVæ–‡ä»¶
* nmapæ‰«æé’ˆå¯¹æ‰€æœ‰å®ä¾‹çš„ç«¯å£ï¼Œè¿™äº›ç«¯å£ä»å…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰å…è®¸å…¥ç«™
* masscané’ˆå¯¹é‚£äº›å…è®¸æ¥è‡ªå…¬å…±äº’è”ç½‘ï¼ˆ0.0.0.0/0ï¼‰çš„æ‰€æœ‰TCPç«¯å£çš„å®ä¾‹çš„å®Œæ•´TCPèŒƒå›´è¿›è¡Œæ‰«æ

### åˆ†å±‚é˜²ç«å¢™ç­–ç•¥ <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_åˆ†å±‚é˜²ç«å¢™ç­–ç•¥_ è®©æ‚¨å¯ä»¥åœ¨æ•´ä¸ªç»„ç»‡ä¸­åˆ›å»ºå’Œ**æ‰§è¡Œä¸€è‡´çš„é˜²ç«å¢™ç­–ç•¥**ã€‚æ‚¨å¯ä»¥å°†**åˆ†å±‚é˜²ç«å¢™ç­–ç•¥åˆ†é…ç»™æ•´ä¸ªç»„ç»‡**æˆ–å•ä¸ª**æ–‡ä»¶å¤¹**ã€‚è¿™äº›ç­–ç•¥åŒ…å«å¯ä»¥æ˜ç¡®æ‹’ç»æˆ–å…è®¸è¿æ¥çš„è§„åˆ™ã€‚

æ‚¨å¯ä»¥åˆ†åˆ«åˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚æ‚¨å¯ä»¥åœ¨[**èµ„æºå±‚æ¬¡ç»“æ„**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)çš„**ç»„ç»‡æˆ–æ–‡ä»¶å¤¹èŠ‚ç‚¹**åˆ›å»ºå’Œåº”ç”¨é˜²ç«å¢™ç­–ç•¥ã€‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™å¯ä»¥**é˜»æ­¢è¿æ¥ã€å…è®¸è¿æ¥ï¼Œæˆ–å°†é˜²ç«å¢™è§„åˆ™è¯„ä¼°æ¨è¿Ÿ**åˆ°ä¸‹çº§æ–‡ä»¶å¤¹æˆ–åœ¨VPCç½‘ç»œä¸­å®šä¹‰çš„VPCé˜²ç«å¢™è§„åˆ™ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰åˆ†å±‚é˜²ç«å¢™ç­–ç•¥è§„åˆ™é€‚ç”¨äºç»„ç»‡æˆ–æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰é¡¹ç›®ä¸­çš„æ‰€æœ‰VMã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‡å®š[ç›®æ ‡ç½‘ç»œæˆ–ç›®æ ‡æœåŠ¡è´¦æˆ·](https://cloud.google.com/vpc/docs/firewall-policies#targets)æ¥**é™åˆ¶å“ªäº›VMè·å¾—ç»™å®šè§„åˆ™**ã€‚

æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å¦‚ä½•[**åˆ›å»ºåˆ†å±‚é˜²ç«å¢™ç­–ç•¥**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)ã€‚

### é˜²ç«å¢™è§„åˆ™è¯„ä¼°

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## åŒºåŸŸæ€§é˜²ç«å¢™ç­–ç•¥

è¿™äº›æ˜¯**åˆ†é…ç»™ä¸€ä¸ªåŒºåŸŸçš„é˜²ç«å¢™è§„åˆ™**ã€‚

## VPCç½‘ç»œå¯¹ç­‰è¿æ¥

å…è®¸è¿æ¥ä¸¤ä¸ªè™šæ‹Ÿç§æœ‰äº‘ï¼ˆVPCï¼‰ç½‘ç»œï¼Œä»¥ä¾¿**æ¯ä¸ªç½‘ç»œä¸­çš„èµ„æºå¯ä»¥ç›¸äº’é€šä¿¡**ã€‚\
å¯¹ç­‰è¿æ¥çš„VPCç½‘ç»œå¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ï¼ŒåŒä¸€ä¸ªç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­ï¼Œæˆ–**ä¸åŒç»„ç»‡çš„ä¸åŒé¡¹ç›®ä¸­**ã€‚

è¿™äº›æ˜¯æ‰€éœ€çš„æƒé™ï¼š

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**æ›´å¤šä¿¡æ¯è¯·æŸ¥é˜…æ–‡æ¡£**](https://cloud.google.com/vpc/docs/vpc-peering)ã€‚
## å‚è€ƒèµ„æ–™

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
