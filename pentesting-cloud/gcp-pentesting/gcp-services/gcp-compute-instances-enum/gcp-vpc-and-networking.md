# GCP - VPC e Networking

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## **Rede de Computa√ß√£o GCP em Resumo**

**VPCs** cont√™m regras de **Firewall** para permitir tr√°fego de entrada na VPC. As VPCs tamb√©m cont√™m **sub-redes** onde as **m√°quinas virtuais** ser√£o **conectadas**.\
Comparando com a AWS, o **Firewall** seria a coisa mais pr√≥xima dos **Security Groups**, mas neste caso eles s√£o **definidos na VPC** e n√£o em cada inst√¢ncia.

## **VPC, Sub-redes e Firewalls no GCP**

As inst√¢ncias de computa√ß√£o est√£o conectadas a **sub-redes** que fazem parte de **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). No GCP, n√£o h√° grupos de seguran√ßa, h√° [**firewalls VPC**](https://cloud.google.com/vpc/docs/firewalls) com regras definidas neste n√≠vel de rede, mas aplicadas a cada inst√¢ncia VM.

### Sub-redes

Uma **VPC** pode ter **v√°rias sub-redes**. Cada **sub-rede est√° em 1 regi√£o**.

### Firewalls

Por padr√£o, toda rede tem duas [**regras de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir sa√≠da** e **negar entrada**.

Quando um projeto GCP √© criado, uma VPC chamada **`default`** tamb√©m √© criada, com as seguintes regras de firewall:

* **default-allow-internal:** permitir todo o tr√°fego de outras inst√¢ncias na rede `default`
* **default-allow-ssh:** permitir 22 de qualquer lugar
* **default-allow-rdp:** permitir 3389 de qualquer lugar
* **default-allow-icmp:** permitir ping de qualquer lugar

{% hint style="warning" %}
Como voc√™ pode ver, as **regras de firewall** tendem a ser **mais permissivas** para **endere√ßos IP internos**. A VPC padr√£o permite todo o tr√°fego entre as inst√¢ncias de computa√ß√£o.
{% endhint %}

Mais **regras de firewall** podem ser criadas para a VPC padr√£o ou para novas VPCs. [**Regras de firewall**](https://cloud.google.com/vpc/docs/firewalls) podem ser aplicadas √†s inst√¢ncias por meio dos seguintes **m√©todos**:

* [**Tags de rede**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Contas de servi√ßo**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas as inst√¢ncias dentro de uma VPC**

Infelizmente, n√£o h√° um comando `gcloud` simples para listar todas as inst√¢ncias de computa√ß√£o com portas abertas na internet. Voc√™ tem que conectar os pontos entre as regras de firewall, tags de rede, contas de servi√ßo e inst√¢ncias.

Esse processo foi automatizado usando [este script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar√° o seguinte:

* Arquivo CSV mostrando inst√¢ncia, IP p√∫blico, TCP permitido, UDP permitido
* Varredura nmap para atingir todas as inst√¢ncias em portas de entrada permitidas da internet p√∫blica (0.0.0.0/0)
* Masscan para atingir a faixa TCP completa daquelas inst√¢ncias que permitem TODAS as portas TCP da internet p√∫blica (0.0.0.0/0)

### Pol√≠ticas de Firewall Hier√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

As _pol√≠ticas de firewall hier√°rquicas_ permitem criar e **aplicar uma pol√≠tica de firewall consistente em toda a organiza√ß√£o**. Voc√™ pode atribuir **pol√≠ticas de firewall hier√°rquicas √† organiza√ß√£o** como um todo ou a **pastas** individuais. Essas pol√≠ticas cont√™m regras que podem explicitamente negar ou permitir conex√µes.

Voc√™ cria e aplica pol√≠ticas de firewall como etapas separadas. Voc√™ pode criar e aplicar pol√≠ticas de firewall nos **n√≥s de organiza√ß√£o ou pasta** da [**hierarquia de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Uma regra de pol√≠tica de firewall pode **bloquear conex√µes, permitir conex√µes ou adiar a avalia√ß√£o da regra de firewall** para pastas de n√≠vel inferior ou regras de firewall VPC definidas em redes VPC.

Por padr√£o, todas as regras de pol√≠tica de firewall hier√°rquicas se aplicam a todas as VMs em todos os projetos sob a organiza√ß√£o ou pasta onde a pol√≠tica est√° associada. No entanto, voc√™ pode **restringir quais VMs recebem uma determinada regra** especificando [redes de destino ou contas de servi√ßo de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Voc√™ pode ler aqui como [**criar uma Pol√≠tica de Firewall Hier√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Avalia√ß√£o de Regras de Firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Pol√≠ticas de Firewall Regionais

Essas s√£o **regras de firewall atribu√≠das a uma regi√£o**.

## VPC Network Peering

Permite conectar duas redes Virtual Private Cloud (VPC) para que **recursos em cada rede possam se comunicar** entre si.\
As redes VPC conectadas podem estar no mesmo projeto, em projetos diferentes da mesma organiza√ß√£o ou em **projetos diferentes de organiza√ß√µes diferentes**.

Essas s√£o as permiss√µes necess√°rias:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mais na documenta√ß√£o**](https://cloud.google.com/vpc/docs/vpc-peering).

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**Hack