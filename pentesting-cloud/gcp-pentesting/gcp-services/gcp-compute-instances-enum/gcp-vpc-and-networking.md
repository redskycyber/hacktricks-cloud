# GCP - VPC & Networking

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Red de Computaci칩n de GCP en pocas palabras**

Las **VPC** contienen reglas de **Firewall** para permitir el tr치fico entrante a la VPC. Las VPC tambi칠n contienen **subredes** donde se van a **conectar las m치quinas virtuales**.\
Comparando con AWS, el **Firewall** ser칤a lo m치s **similar** a los **Grupos de Seguridad y NACLs de AWS**, pero en este caso estos est치n **definidos en la VPC** y no en cada instancia.

## **VPC, Subredes y Firewalls en GCP**

Las Instancias de Computaci칩n est치n conectadas a **subredes** que forman parte de las **VPC** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). En GCP no existen grupos de seguridad, hay [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) con reglas definidas a nivel de red pero aplicadas a cada instancia de VM.

### Subredes

Una **VPC** puede tener **varias subredes**. Cada **subred est치 en 1 regi칩n**.

### Firewalls

Por defecto, cada red tiene dos [**reglas de firewall impl칤citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir salida** y **denegar entrada**.

Cuando se crea un proyecto de GCP, se crea una VPC llamada **`default`**, con las siguientes reglas de firewall:

* **default-allow-internal:** permite todo el tr치fico desde otras instancias en la red `default`
* **default-allow-ssh:** permite el puerto 22 desde cualquier lugar
* **default-allow-rdp:** permite el puerto 3389 desde cualquier lugar
* **default-allow-icmp:** permite ping desde cualquier lugar

{% hint style="warning" %}
Como se puede ver, las **reglas de firewall** tienden a ser **m치s permisivas** para las **direcciones IP internas**. La VPC predeterminada permite todo el tr치fico entre las Instancias de Computaci칩n.
{% endhint %}

Se pueden crear m치s **reglas de firewall** para la VPC predeterminada o para nuevas VPC. Las [**reglas de firewall**](https://cloud.google.com/vpc/docs/firewalls) se pueden aplicar a las instancias a trav칠s de los siguientes **m칠todos**:

* [**Etiquetas de red**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Cuentas de servicio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas las instancias dentro de una VPC**

Desafortunadamente, no hay un comando `gcloud` simple para mostrar todas las Instancias de Computaci칩n con puertos abiertos en Internet. Debes conectar los puntos entre las reglas de firewall, las etiquetas de red, las cuentas de servicio y las instancias.

Este proceso se automatiz칩 utilizando [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar치 lo siguiente:

* Archivo CSV que muestra la instancia, la IP p칰blica, los puertos TCP permitidos, los puertos UDP permitidos
* Escaneo nmap para apuntar a todas las instancias en puertos de ingreso permitidos desde Internet p칰blico (0.0.0.0/0)
* masscan para apuntar al rango TCP completo de esas instancias que permiten TODOS los puertos TCP desde Internet p칰blico (0.0.0.0/0)

### Pol칤ticas de Firewall Jer치rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Las _pol칤ticas de firewall jer치rquicas_ te permiten crear y **aplicar una pol칤tica de firewall consistente en toda tu organizaci칩n**. Puedes asignar **pol칤ticas de firewall jer치rquicas a la organizaci칩n** en su totalidad o a **carpetas individuales**. Estas pol칤ticas contienen reglas que pueden denegar o permitir expl칤citamente conexiones.

Creas y aplicas pol칤ticas de firewall como pasos separados. Puedes crear y aplicar pol칤ticas de firewall en los **nodos de organizaci칩n o carpeta de la** [**jerarqu칤a de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regla de pol칤tica de firewall puede **bloquear conexiones, permitir conexiones o posponer la evaluaci칩n de la regla de firewall** a reglas de firewall de VPC de nivel inferior o reglas de firewall definidas en redes de VPC.

Por defecto, todas las reglas de pol칤ticas de firewall jer치rquicas se aplican a todas las VM en todos los proyectos bajo la organizaci칩n o carpeta donde se asocia la pol칤tica. Sin embargo, puedes **restringir qu칠 VMs obtienen una regla espec칤fica** especificando [redes de destino o cuentas de servicio de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puedes leer aqu칤 c칩mo [**crear una Pol칤tica de Firewall Jer치rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluaci칩n de Reglas de Firewall

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Pol칤ticas de firewall asignadas a la Organizaci칩n
2. Carpeta: Pol칤ticas de firewall asignadas a la Carpeta
3. VPC: Reglas de firewall asignadas a la VPC
4. Global: Otro tipo de reglas de firewall que se pueden asignar a las VPC
5. Regional: Reglas de firewall asociadas con la red de VPC de la NIC de la VM y la regi칩n de la VM.

## Interconexi칩n de Redes de VPC

Permite conectar dos redes de Virtual Private Cloud (VPC) para que los **recursos en cada red puedan comunicarse** entre s칤.\
Las redes de VPC interconectadas pueden estar en el mismo proyecto, en diferentes proyectos de la misma organizaci칩n o en **diferentes proyectos de diferentes organizaciones**.

Estos son los permisos necesarios:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[M치s en la documentaci칩n](https://cloud.google.com/vpc/docs/vpc-peering).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
