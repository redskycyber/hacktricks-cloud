# GCP - Enumeraci贸n de Cloud Run

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cloud Run <a href="#reviewing-cloud-run-configurations" id="reviewing-cloud-run-configurations"></a>

Google [Cloud Run](https://cloud.google.com/run) es otra oferta sin servidor donde tambi茅n se pueden buscar variables de entorno. Cloud Run crea un peque帽o servidor web, que se ejecuta en el puerto 8080, que espera una solicitud HTTP GET. Cuando se recibe la solicitud, se ejecuta un trabajo y el registro del trabajo se muestra a trav茅s de una respuesta HTTP.

Por **defecto**, el **acceso** al servidor web es **p煤blico**, pero tambi茅n se puede **limitar al tr谩fico interno** (VPC...)\
Adem谩s, la **autenticaci贸n** para contactar con el servidor web puede ser **permitiendo todo** o **requiriendo autenticaci贸n a trav茅s de IAM**.

Por defecto, el **cifrado** utiliza una **clave administrada por Google**, pero tambi茅n se puede **elegir una clave de cifrado gestionada por el cliente (CMEK)** de **KMS**.

Por defecto, la cuenta de servicio utilizada es la **predeterminada de Compute Engine** y tiene el **谩mbito `cloud-platform`.**

Es posible definir **variables de entorno en texto claro** para la ejecuci贸n, e incluso **montar secretos en la nube** o **a帽adir secretos en la nube a las variables de entorno.**

Tambi茅n es posible **a帽adir conexiones con Cloud SQL**.

Las **URLs** de los servicios desplegados son similares a `https://<svc-name>-<random>.a.run.app`

### Enumeraci贸n

```bash
# Listar servicios
gcloud run services list
gcloud run services list --platform=managed
gcloud run services list --platform=gke

# Obtener informaci贸n de un servicio
gcloud run services describe --region <region> <svc-name> 

# Obtener informaci贸n de todos los servicios juntos
gcloud run services list --format=yaml
gcloud run services list --platform=managed --format=json
gcloud run services list --platform=gke --format=json

# Obtener la pol铆tica
gcloud run services get-iam-policy --region <region> <svc-name>

# Obtener revisiones
gcloud run revisions list --region <region>
gcloud run revisions describe --region <region> <revision>

# Obtener dominios
gcloud run domain-mappings list
gcloud run domain-mappings describe <name>

# Intentar desencadenar un trabajo sin autenticaci贸n
curl <url>

# Intentar desencadenar un trabajo con la autorizaci贸n actual de gcloud
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" <url>
```

### Escalada de privilegios

En la siguiente p谩gina, puedes comprobar c贸mo **abusar de los permisos de Cloud Run para escalar privilegios**:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md" %}
[gcp-run-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md)
{% endcontent-ref %}

### Enumerar Open Cloud Run

Con el siguiente c贸digo [tomado de aqu铆](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_cloudrun.sh) puedes encontrar servicios de Cloud Run que permiten invocaciones no autenticadas.

```bash
#!/bin/bash

############################
# Ejecute esta herramienta para encontrar servicios de Cloud Run que permitan invocaciones no autenticadas en cualquier lugar de su organizaci贸n de GCP.
# 隆Disfruta!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
    echo "[*] raspando el proyecto $proj"

    enabled=$(gcloud services list --project "$proj" | grep "Cloud Run API")

    if [ -z "$enabled" ]; then
	continue
    fi


    for run in $(gcloud run services list --platform managed --quiet --project $proj --format="get(name)"); do
        ACL="$(gcloud run services get-iam-policy $run --platform managed --project $proj)"

        all_users="$(echo $ACL | grep allUsers)"
        all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

        if [ -z "$all_users" ]
        then
              :
        else
              echo "[!] Abierto a todos los usuarios: $proj: $run"
        fi

        if [ -z "$all_auth" ]
        then
              :
        else
              echo "[!] Abierto a todos los usuarios autenticados: $proj: $run"
        fi
    done
done
```

## Trabajos de Cloud Run

Los trabajos de Cloud Run son una mejor opci贸n para **contenedores que se ejecutan hasta su finalizaci贸n y no sirven solicitudes**. Los trabajos no tienen la capacidad de servir solicitudes o escuchar en un puerto. Esto significa que, a diferencia de los servicios de Cloud Run, los trabajos no deben incluir un servidor web. En su lugar, los contenedores de trabajos deben salir cuando hayan terminado.

### Enumeraci贸n

```bash
gcloud beta run jobs list
gcloud beta run jobs describe --region <region> <job-name>
gcloud beta run jobs get-iam-policy --region <region> <job-name>
```

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>