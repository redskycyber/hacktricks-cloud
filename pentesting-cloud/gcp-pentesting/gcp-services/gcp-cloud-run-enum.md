# GCP - Enumeraci贸n de Cloud Run

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cloud Run <a href="#reviewing-cloud-run-configurations" id="reviewing-cloud-run-configurations"></a>

Google [Cloud Run](https://cloud.google.com/run) es otra oferta sin servidor donde tambi茅n puedes buscar variables de entorno. Cloud Run crea un peque帽o servidor web, que se ejecuta en el puerto 8080, que espera una solicitud HTTP GET. Cuando se recibe la solicitud, se ejecuta un trabajo y el registro del trabajo se muestra a trav茅s de una respuesta HTTP.

Por **defecto**, el **acceso** al servidor web es **p煤blico**, pero tambi茅n puede ser **limitado a tr谩fico interno** (VPC...).
Adem谩s, la **autenticaci贸n** para contactar con el servidor web puede ser **permitiendo a todos** o **requiriendo autenticaci贸n a trav茅s de IAM**.

Por defecto, la **encriptaci贸n** utiliza una **clave gestionada por Google**, pero tambi茅n se puede **elegir** una **CMEK** (Clave de Encriptaci贸n Gestionada por el Cliente) de **KMS**.

Por **defecto**, la **cuenta de servicio** utilizada es la **predeterminada de Compute Engine** y tiene el **alcance `cloud-platform`.**

Es posible definir **variables de entorno en texto claro** para la ejecuci贸n, e incluso **montar secretos de la nube** o **a帽adir secretos de la nube a las variables de entorno.**

Tambi茅n es posible **a帽adir conexiones con Cloud SQL**.

Las **URLs** de los servicios desplegados son similares a `https://<svc-name>-<random>.a.run.app`

### Enumeraci贸n
```bash
# List services
gcloud run services list
gcloud run services list --platform=managed
gcloud run services list --platform=gke

# Get info of a service
gcloud run services describe --region <region> <svc-name>

# Get info of all the services together
gcloud run services list --format=yaml
gcloud run services list --platform=managed --format=json
gcloud run services list --platform=gke --format=json

# Get policy
gcloud run services get-iam-policy --region <region> <svc-name>

# Get revisions
gcloud run revisions list --region <region>
gcloud run revisions describe --region <region> <revision>

# Get domains
gcloud run domain-mappings list
gcloud run domain-mappings describe <name>

# Attempt to trigger a job unauthenticated
curl <url>

# Attempt to trigger a job with your current gcloud authorization
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" <url>
```
### Escalada de Privilegios

En la siguiente p谩gina, puedes verificar c贸mo **abusar de los permisos de Cloud Run para escalar privilegios**:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md" %}
[gcp-run-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md)
{% endcontent-ref %}

### Enumerar Cloud Run Abierto

Con el siguiente c贸digo [tomado de aqu铆](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_cloudrun.sh) puedes encontrar servicios de Cloud Run que permiten invocaciones sin autenticaci贸n.
```bash
#!/bin/bash

############################
# Run this tool to find Cloud Run services that permit unauthenticated
# invocations anywhere in your GCP organization.
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"

enabled=$(gcloud services list --project "$proj" | grep "Cloud Run API")

if [ -z "$enabled" ]; then
continue
fi


for run in $(gcloud run services list --platform managed --quiet --project $proj --format="get(name)"); do
ACL="$(gcloud run services get-iam-policy $run --platform managed --project $proj)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $proj: $run"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $proj: $run"
fi
done
done
```
## Trabajos de Cloud Run

Los trabajos de Cloud Run son m谩s adecuados para **contenedores que se ejecutan hasta completarse y no atienden solicitudes**. Los trabajos no tienen la capacidad de atender solicitudes ni escuchar en un puerto. Esto significa que, a diferencia de los servicios de Cloud Run, los trabajos no deben incluir un servidor web. En cambio, los contenedores de trabajos deben salir cuando hayan terminado.

### Enumeraci贸n
```bash
gcloud beta run jobs list
gcloud beta run jobs describe --region <region> <job-name>
gcloud beta run jobs get-iam-policy --region <region> <job-name>
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
