# GCP - å­˜å‚¨æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## å­˜å‚¨

Google Cloud Platformï¼ˆGCPï¼‰å­˜å‚¨æ˜¯ä¸€ç§**åŸºäºäº‘çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ï¼Œä¸ºéç»“æ„åŒ–æ•°æ®æä¾›é«˜åº¦è€ç”¨å’Œå¯ç”¨çš„å¯¹è±¡å­˜å‚¨ã€‚å®ƒæä¾›åŸºäºæ€§èƒ½ã€å¯ç”¨æ€§å’Œæˆæœ¬çš„**å„ç§å­˜å‚¨ç±»åˆ«**ï¼ŒåŒ…æ‹¬æ ‡å‡†ã€Nearlineã€Coldlineå’ŒArchiveã€‚GCPå­˜å‚¨è¿˜æä¾›é«˜çº§åŠŸèƒ½ï¼Œå¦‚**ç”Ÿå‘½å‘¨æœŸç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶å’Œè®¿é—®æ§åˆ¶**ï¼Œä»¥æœ‰æ•ˆç®¡ç†å’Œä¿æŠ¤æ•°æ®ã€‚

å­˜å‚¨æ¡¶å¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªåŒºåŸŸã€2ä¸ªåŒºåŸŸæˆ–**å¤šä¸ªåŒºåŸŸï¼ˆé»˜è®¤ï¼‰**ä¸­ã€‚

### å­˜å‚¨ç±»å‹

* **æ ‡å‡†å­˜å‚¨**ï¼šè¿™æ˜¯**æä¾›é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿè®¿é—®é¢‘ç¹è®¿é—®æ•°æ®**çš„é»˜è®¤å­˜å‚¨é€‰é¡¹ã€‚é€‚ç”¨äºå„ç§ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æä¾›ç½‘ç«™å†…å®¹ã€æµåª’ä½“å’Œæ‰˜ç®¡æ•°æ®åˆ†æç®¡é“ã€‚
* **Nearlineå­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«æä¾›æ¯”æ ‡å‡†å­˜å‚¨**æ›´ä½çš„å­˜å‚¨æˆæœ¬**å’Œ**ç¨é«˜çš„è®¿é—®æˆæœ¬**ã€‚å®ƒé’ˆå¯¹ä¸ç»å¸¸è®¿é—®çš„æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€çŸ­å­˜å‚¨æœŸä¸º30å¤©ã€‚éå¸¸é€‚åˆå¤‡ä»½å’Œå½’æ¡£ç›®çš„ã€‚
* **Coldlineå­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«é’ˆå¯¹**ä¸ç»å¸¸è®¿é—®çš„æ•°æ®è¿›è¡Œäº†é•¿æœŸå­˜å‚¨**ï¼Œæœ€çŸ­å­˜å‚¨æœŸä¸º90å¤©ã€‚å®ƒæä¾›æ¯”Nearlineå­˜å‚¨æ›´ä½çš„å­˜å‚¨æˆæœ¬ï¼Œä½†**è®¿é—®æˆæœ¬æ›´é«˜**ã€‚
* **Archiveå­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«ä¸“ä¸º**éå¸¸ä¸ç»å¸¸è®¿é—®çš„å†·æ•°æ®**è®¾è®¡ï¼Œæœ€çŸ­å­˜å‚¨æœŸä¸º365å¤©ã€‚å®ƒæä¾›æ‰€æœ‰GCPå­˜å‚¨é€‰é¡¹ä¸­**æœ€ä½çš„å­˜å‚¨æˆæœ¬**ï¼Œä½†**è®¿é—®æˆæœ¬æœ€é«˜**ã€‚é€‚ç”¨äºéœ€è¦å‡ºäºåˆè§„æˆ–ç›‘ç®¡åŸå› é•¿æœŸä¿ç•™æ•°æ®ã€‚
* **è‡ªåŠ¨åˆ†ç±»**ï¼šå¦‚æœæ‚¨**ä¸çŸ¥é“å°†è®¿é—®å¤šå°‘**æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ†ç±»ï¼ŒGCPå°†**è‡ªåŠ¨æ›´æ”¹å­˜å‚¨ç±»å‹**ä»¥æœ€å°åŒ–æˆæœ¬ã€‚

### è®¿é—®æ§åˆ¶

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œå»ºè®®é€šè¿‡**IAM**æ§åˆ¶è®¿é—®ï¼Œä½†ä¹Ÿå¯ä»¥**å¯ç”¨ACLçš„ä½¿ç”¨**ã€‚\
å¦‚æœé€‰æ‹©ä»…ä½¿ç”¨IAMï¼ˆé»˜è®¤ï¼‰å¹¶ä¸”**ç»è¿‡90å¤©**ï¼Œåˆ™**å°†æ— æ³•ä¸ºå­˜å‚¨æ¡¶å¯ç”¨ACL**ã€‚

### ç‰ˆæœ¬æ§åˆ¶

å¯ä»¥å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™å°†**ä¿å­˜å­˜å‚¨æ¡¶ä¸­æ–‡ä»¶çš„æ—§ç‰ˆæœ¬**ã€‚å¯ä»¥é…ç½®**è¦ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡**ï¼Œç”šè‡³**å¸Œæœ›éå½“å‰ç‰ˆæœ¬ï¼ˆæ—§ç‰ˆæœ¬ï¼‰å­˜åœ¨å¤šé•¿æ—¶é—´**ã€‚å»ºè®®**æ ‡å‡†ç±»å‹ä¸º7å¤©**ã€‚

**éå½“å‰ç‰ˆæœ¬çš„å…ƒæ•°æ®ä¼šè¢«ä¿ç•™**ã€‚æ­¤å¤–ï¼Œ**éå½“å‰ç‰ˆæœ¬çš„ACLä¹Ÿä¼šè¢«ä¿ç•™**ï¼Œå› æ­¤æ—§ç‰ˆæœ¬å¯èƒ½å…·æœ‰ä¸å½“å‰ç‰ˆæœ¬ä¸åŒçš„ACLã€‚

åœ¨[**æ–‡æ¡£**](https://cloud.google.com/storage/docs/object-versioning)ä¸­äº†è§£æ›´å¤šä¿¡æ¯ã€‚

### ä¿ç•™ç­–ç•¥

æŒ‡å®šå¸Œæœ›**ç¦æ­¢åˆ é™¤å­˜å‚¨æ¡¶å†…å¯¹è±¡çš„æ—¶é—´**ï¼ˆè‡³å°‘å¯¹åˆè§„æ€§éå¸¸æœ‰ç”¨ï¼‰ã€‚\
**ç‰ˆæœ¬æ§åˆ¶æˆ–ä¿ç•™ç­–ç•¥åªèƒ½åŒæ—¶å¯ç”¨ä¸€ä¸ª**ã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä½¿ç”¨**Googleç®¡ç†çš„å¯†é’¥**åŠ å¯†ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨**æ¥è‡ªKMSçš„å¯†é’¥**ã€‚

### å…¬å…±è®¿é—®

å¯ä»¥å‘**å¤–éƒ¨ç”¨æˆ·**ï¼ˆç™»å½•åˆ°GCPæˆ–æœªç™»å½•ï¼‰**æä¾›å¯¹å­˜å‚¨æ¡¶å†…å®¹çš„è®¿é—®æƒé™**ã€‚\
é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºå­˜å‚¨æ¡¶æ—¶ï¼Œ**ç¦ç”¨äº†å…¬å¼€æš´éœ²å­˜å‚¨æ¡¶çš„é€‰é¡¹**ï¼Œä½†å…·æœ‰è¶³å¤Ÿæƒé™æ—¶å¯ä»¥æ›´æ”¹ã€‚

è®¿é—®å­˜å‚¨æ¡¶çš„URLæ ¼å¼ä¸º**`https://storage.googleapis.com/<bucket-name>`æˆ–`https://<bucket_name>.storage.googleapis.com`**ï¼ˆä¸¤è€…éƒ½æœ‰æ•ˆï¼‰ã€‚

### HMACå¯†é’¥

HMACå¯†é’¥æ˜¯ä¸€ç§_å‡­è¯_ç±»å‹ï¼Œå¯ä»¥**ä¸Cloud Storageä¸­çš„æœåŠ¡å¸æˆ·æˆ–ç”¨æˆ·å¸æˆ·å…³è”**ã€‚æ‚¨ä½¿ç”¨HMACå¯†é’¥åˆ›å»º_ç­¾å_ï¼Œç„¶åå°†å…¶åŒ…å«åœ¨å¯¹Cloud Storageçš„è¯·æ±‚ä¸­ã€‚ç­¾åè¡¨æ˜**ç»™å®šè¯·æ±‚ç”±ç”¨æˆ·æˆ–æœåŠ¡å¸æˆ·æˆæƒ**ã€‚

HMACå¯†é’¥æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œå³_è®¿é—®ID_å’Œ_å¯†é’¥_ã€‚

*   **è®¿é—®ID**ï¼šä¸ç‰¹å®šæœåŠ¡æˆ–ç”¨æˆ·å¸æˆ·å…³è”çš„å­—æ¯æ•°å­—å­—ç¬¦ä¸²ã€‚å½“ä¸æœåŠ¡å¸æˆ·å…³è”æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º61ä¸ªå­—ç¬¦ï¼Œå½“ä¸ç”¨æˆ·å¸æˆ·å…³è”æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º24ä¸ªå­—ç¬¦ã€‚ä»¥ä¸‹æ˜¯è®¿é—®IDçš„ç¤ºä¾‹ï¼š

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **å¯†é’¥**ï¼šä¸ç‰¹å®šè®¿é—®IDå…³è”çš„40ä¸ªå­—ç¬¦çš„Base-64ç¼–ç å­—ç¬¦ä¸²ã€‚å¯†é’¥æ˜¯æ‚¨å’ŒCloud StorageçŸ¥é“çš„é¢„å…±äº«å¯†é’¥ã€‚æ‚¨ä½¿ç”¨å¯†é’¥åˆ›å»ºç­¾åä½œä¸ºèº«ä»½éªŒè¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ä»¥ä¸‹æ˜¯å¯†é’¥çš„ç¤ºä¾‹ï¼š

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

**è®¿é—®IDå’Œå¯†é’¥å”¯ä¸€æ ‡è¯†HMACå¯†é’¥**ï¼Œä½†å¯†é’¥æ˜¯æ›´æ•æ„Ÿçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒç”¨äº**åˆ›å»ºç­¾å**ã€‚

### æšä¸¾
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list
```
å¦‚æœåœ¨åˆ—å‡ºå­˜å‚¨æ¡¶æ—¶é‡åˆ°æƒé™è¢«æ‹’ç»çš„é”™è¯¯ï¼Œä½ ä»ç„¶å¯èƒ½å¯ä»¥è®¿é—®å†…å®¹ã€‚ç°åœ¨ä½ å·²ç»äº†è§£äº†å­˜å‚¨æ¡¶å‘½åè§„èŒƒï¼Œå¯ä»¥ç”Ÿæˆå¯èƒ½çš„åç§°åˆ—è¡¨ï¼Œç„¶åå°è¯•è®¿é—®å®ƒä»¬ï¼š
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
å…·æœ‰`storage.objects.list`å’Œ`storage.objects.get`æƒé™ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿæšä¸¾å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼Œä»¥ä¾¿ä¸‹è½½å®ƒä»¬ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹Pythonè„šæœ¬å®ç°ï¼š
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### ææƒ

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨å­˜å‚¨æƒé™ä»¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### æœªè®¤è¯æšä¸¾

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### åæ¸—é€

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)** ä¸Š**å…³æ³¨**æˆ‘**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
