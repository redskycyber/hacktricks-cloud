# GCP - å­˜å‚¨æšä¸¾

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## å­˜å‚¨

Google Cloud Platform (GCP) å­˜å‚¨æ˜¯ä¸€ç§åŸºäºäº‘çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œä¸ºéç»“æ„åŒ–æ•°æ®æä¾›é«˜åº¦è€ç”¨å’Œå¯ç”¨çš„å¯¹è±¡å­˜å‚¨ã€‚å®ƒæä¾›åŸºäºæ€§èƒ½ã€å¯ç”¨æ€§å’Œæˆæœ¬çš„å„ç§å­˜å‚¨ç±»åˆ«ï¼ŒåŒ…æ‹¬æ ‡å‡†ã€Nearlineã€Coldline å’Œ Archiveã€‚GCP å­˜å‚¨è¿˜æä¾›é«˜çº§åŠŸèƒ½ï¼Œå¦‚ç”Ÿå‘½å‘¨æœŸç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶å’Œè®¿é—®æ§åˆ¶ï¼Œä»¥æœ‰æ•ˆåœ°ç®¡ç†å’Œä¿æŠ¤æ•°æ®ã€‚

å­˜å‚¨æ¡¶å¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªåŒºåŸŸã€ä¸¤ä¸ªåŒºåŸŸæˆ–**å¤šä¸ªåŒºåŸŸï¼ˆé»˜è®¤ï¼‰**ã€‚

### å­˜å‚¨ç±»å‹

* **æ ‡å‡†å­˜å‚¨**ï¼šè¿™æ˜¯é»˜è®¤çš„å­˜å‚¨é€‰é¡¹ï¼Œ**æä¾›å¯¹é¢‘ç¹è®¿é—®æ•°æ®çš„é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿè®¿é—®**ã€‚é€‚ç”¨äºå„ç§ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æä¾›ç½‘ç«™å†…å®¹ã€æµåª’ä½“å’Œæ‰˜ç®¡æ•°æ®åˆ†ææµæ°´çº¿ã€‚
* **Nearline å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«çš„å­˜å‚¨æˆæœ¬è¾ƒä½ï¼Œè®¿é—®æˆæœ¬ç•¥é«˜äºæ ‡å‡†å­˜å‚¨ã€‚å®ƒé’ˆå¯¹ä¸ç»å¸¸è®¿é—®çš„æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€ä½å­˜å‚¨æŒç»­æ—¶é—´ä¸º 30 å¤©ã€‚éå¸¸é€‚åˆå¤‡ä»½å’Œå½’æ¡£ç›®çš„ã€‚
* **Coldline å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«é’ˆå¯¹**ä¸ç»å¸¸è®¿é—®çš„é•¿æœŸå­˜å‚¨æ•°æ®**è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€ä½å­˜å‚¨æŒç»­æ—¶é—´ä¸º 90 å¤©ã€‚å®ƒæä¾›æ¯” Nearline å­˜å‚¨æ›´ä½çš„å­˜å‚¨æˆæœ¬ï¼Œä½†è®¿é—®æˆæœ¬è¾ƒé«˜ã€‚
* **Archive å­˜å‚¨**ï¼šæ­¤å­˜å‚¨ç±»åˆ«ä¸“ä¸º**éå¸¸ä¸ç»å¸¸è®¿é—®çš„å†·æ•°æ®**è®¾è®¡ï¼Œæœ€ä½å­˜å‚¨æŒç»­æ—¶é—´ä¸º 365 å¤©ã€‚å®ƒæ˜¯æ‰€æœ‰ GCP å­˜å‚¨é€‰é¡¹ä¸­å­˜å‚¨æˆæœ¬æœ€ä½çš„ï¼Œä½†è®¿é—®æˆæœ¬æœ€é«˜ã€‚é€‚ç”¨äºéœ€è¦é•¿æœŸä¿ç•™éœ€è¦ç¬¦åˆåˆè§„æ€§æˆ–ç›‘ç®¡è¦æ±‚çš„æ•°æ®ã€‚
* **è‡ªåŠ¨åˆ†ç±»**ï¼šå¦‚æœæ‚¨**ä¸çŸ¥é“å°†è®¿é—®å¤šå°‘æ•°æ®**ï¼Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ†ç±»ï¼ŒGCP å°†**è‡ªåŠ¨æ›´æ”¹å­˜å‚¨ç±»å‹ä»¥æœ€å°åŒ–æˆæœ¬**ã€‚

### è®¿é—®æ§åˆ¶

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œå»ºè®®é€šè¿‡**IAM**æ§åˆ¶è®¿é—®ï¼Œä½†ä¹Ÿå¯ä»¥**å¯ç”¨ ACL çš„ä½¿ç”¨**ã€‚\
å¦‚æœé€‰æ‹©ä»…ä½¿ç”¨ IAMï¼ˆé»˜è®¤ï¼‰å¹¶ä¸”**90 å¤©è¿‡å»**ï¼Œåˆ™**æ— æ³•ä¸ºå­˜å‚¨æ¡¶å¯ç”¨ ACL**ã€‚

### å­˜å‚¨å¯¹è±¡ä¿æŠ¤

### ç‰ˆæœ¬æ§åˆ¶

å¯ä»¥å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™å°†**åœ¨å­˜å‚¨æ¡¶å†…ä¿å­˜æ–‡ä»¶çš„æ—§ç‰ˆæœ¬**ã€‚å¯ä»¥é…ç½®**è¦ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡**ï¼Œç”šè‡³å¯ä»¥é…ç½®**éå½“å‰ç‰ˆæœ¬ï¼ˆæ—§ç‰ˆæœ¬ï¼‰çš„å­˜æ´»æ—¶é—´**ã€‚å»ºè®®ä¸º**æ ‡å‡†ç±»å‹è®¾ç½® 7 å¤©**ã€‚

**éå½“å‰ç‰ˆæœ¬çš„å…ƒæ•°æ®å°†è¢«ä¿ç•™**ã€‚æ­¤å¤–ï¼Œ**éå½“å‰ç‰ˆæœ¬çš„ ACL ä¹Ÿå°†è¢«ä¿ç•™**ï¼Œå› æ­¤å½“å‰ç‰ˆæœ¬å¯èƒ½ä¸å½“å‰ç‰ˆæœ¬å…·æœ‰ä¸åŒçš„ ACLã€‚&#x20;

åœ¨[**æ–‡æ¡£**](https://cloud.google.com/storage/docs/object-versioning)ä¸­äº†è§£æ›´å¤šä¿¡æ¯ã€‚

### ä¿ç•™ç­–ç•¥

æŒ‡å®šæ‚¨å¸Œæœ›**ç¦æ­¢åˆ é™¤å­˜å‚¨æ¡¶å†…å¯¹è±¡çš„æ—¶é—´**ï¼ˆè‡³å°‘å¯¹åˆè§„æ€§éå¸¸æœ‰ç”¨ï¼‰ã€‚\
**åªèƒ½åŒæ—¶å¯ç”¨ç‰ˆæœ¬æ§åˆ¶æˆ–ä¿ç•™ç­–ç•¥ä¸­çš„ä¸€ä¸ª**ã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä½¿ç”¨**Google æ‰˜ç®¡å¯†é’¥è¿›è¡ŒåŠ å¯†**ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨**KMS ä¸­çš„å¯†é’¥**ã€‚

### æšä¸¾
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
å¦‚æœæ‚¨åœ¨åˆ—å‡ºå­˜å‚¨æ¡¶æ—¶é‡åˆ°æƒé™è¢«æ‹’ç»çš„é”™è¯¯ï¼Œå¯èƒ½ä»ç„¶å¯ä»¥è®¿é—®å…¶å†…å®¹ã€‚å› æ­¤ï¼Œç°åœ¨æ‚¨å·²ç»äº†è§£äº†å­˜å‚¨æ¡¶çš„å‘½åçº¦å®šï¼Œå¯ä»¥ç”Ÿæˆå¯èƒ½çš„åç§°åˆ—è¡¨å¹¶å°è¯•è®¿é—®å®ƒä»¬ï¼š
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### å…¬å¼€è®¿é—®

å¯ä»¥å°†å¤–éƒ¨ç”¨æˆ·ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•GCPï¼‰æˆäºˆè®¿é—®å­˜å‚¨æ¡¶å†…å®¹çš„æƒé™ã€‚ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå­˜å‚¨æ¡¶å°†ç¦ç”¨å…¬å¼€è®¿é—®é€‰é¡¹ï¼š
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
å¦‚æœæ‚¨å°è¯•ä¸ºå·²ç¦ç”¨ACLçš„å­˜å‚¨æ¡¶æä¾›ACLï¼Œåˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š`ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

è¦é€šè¿‡æµè§ˆå™¨è®¿é—®å…¬å¼€çš„å­˜å‚¨æ¡¶ï¼Œè¯·è®¿é—®ä»¥ä¸‹URLï¼š`https://<bucket_name>.storage.googleapis.com/` æˆ– `https://<bucket_name>.storage.googleapis.com/<object_name>`

### ç‰¹æƒå‡çº§

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥çœ‹å¦‚ä½•æ»¥ç”¨å­˜å‚¨æƒé™ä»¥æå‡ç‰¹æƒï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### åœ¨å½“å‰è´¦æˆ·ä¸­æœç´¢å…¬å¼€çš„å­˜å‚¨æ¡¶

ä½¿ç”¨ä»¥ä¸‹è„šæœ¬[ä»è¿™é‡Œè·å–](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh)ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æ‰€æœ‰å…¬å¼€çš„å­˜å‚¨æ¡¶ï¼š
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¿›è¡Œå¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
