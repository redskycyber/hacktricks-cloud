# GCP - Enumera√ß√£o de Armazenamento

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Armazenamento

O Armazenamento da Google Cloud Platform (GCP) √© uma **solu√ß√£o de armazenamento baseada em nuvem** que fornece armazenamento de objetos altamente dur√°vel e dispon√≠vel para dados n√£o estruturados. Ele oferece **v√°rias classes de armazenamento** com base em desempenho, disponibilidade e custo, incluindo Padr√£o, Nearline, Coldline e Archive. O Armazenamento da GCP tamb√©m fornece recursos avan√ßados, como **pol√≠ticas de ciclo de vida, versionamento e controle de acesso** para gerenciar e proteger dados de forma eficaz.

O bucket pode ser armazenado em uma regi√£o, em 2 regi√µes ou **multi-regi√£o (padr√£o)**.

### Tipos de Armazenamento

* **Armazenamento Padr√£o**: Esta √© a op√ß√£o de armazenamento padr√£o que **oferece acesso de alto desempenho e baixa lat√™ncia a dados acessados com frequ√™ncia**. √â adequado para uma ampla gama de casos de uso, incluindo servir conte√∫do de site, transmitir m√≠dia e hospedar pipelines de an√°lise de dados.
* **Armazenamento Nearline**: Esta classe de armazenamento oferece **custos de armazenamento mais baixos** e **custos de acesso ligeiramente mais altos** do que o Armazenamento Padr√£o. √â otimizado para dados acessados com pouca frequ√™ncia, com uma dura√ß√£o m√≠nima de armazenamento de 30 dias. √â ideal para fins de backup e arquivamento.
* **Armazenamento Coldline**: Esta classe de armazenamento √© otimizada para **armazenamento de longo prazo de dados acessados com pouca frequ√™ncia**, com uma dura√ß√£o m√≠nima de armazenamento de 90 dias. Oferece **custos de armazenamento mais baixos** do que o Armazenamento Nearline, mas com **custos de acesso mais altos**.
* **Armazenamento Archive**: Esta classe de armazenamento √© projetada para dados frios que s√£o acessados **muito raramente**, com uma dura√ß√£o m√≠nima de armazenamento de 365 dias. Oferece os **custos de armazenamento mais baixos de todas as op√ß√µes de armazenamento da GCP**, mas com os **custos de acesso mais altos**. √â adequado para a reten√ß√£o de longo prazo de dados que precisam ser armazenados por motivos de conformidade ou regulamentares.
* **Autoclass**: Se voc√™ **n√£o sabe com que frequ√™ncia vai acessar** os dados, pode selecionar Autoclass e a GCP **mudar√° automaticamente o tipo de armazenamento para minimizar os custos**.

### Controle de Acesso

Por **padr√£o**, √© **recomendado** controlar o acesso por meio do **IAM**, mas tamb√©m √© poss√≠vel **ativar o uso de ACLs**.\
Se voc√™ optar por usar apenas o IAM (padr√£o) e **90 dias se passarem**, voc√™ **n√£o poder√° habilitar ACLs** para o bucket.

### Versionamento

√â poss√≠vel habilitar o versionamento, isso **salvar√° vers√µes antigas do arquivo dentro do bucket**. √â poss√≠vel configurar o **n√∫mero de vers√µes que deseja manter** e at√© **por quanto tempo** deseja que as vers√µes **n√£o atuais** (vers√µes antigas) permane√ßam. O recomendado √© **7 dias para o tipo Padr√£o**.

O **metadados de uma vers√£o n√£o atual s√£o mantidos**. Al√©m disso, **as ACLs das vers√µes n√£o atuais tamb√©m s√£o mantidas**, ent√£o vers√µes antigas podem ter ACLs diferentes da vers√£o atual.

Saiba mais na [**documenta√ß√£o**](https://cloud.google.com/storage/docs/object-versioning).

### Pol√≠tica de Reten√ß√£o

Indique por **quanto tempo** deseja **impedir a exclus√£o de Objetos dentro do bucket** (muito √∫til para conformidade, no m√≠nimo).\
Apenas um dos **versionamento ou pol√≠tica de reten√ß√£o pode ser habilitado por vez**.

### Criptografia

Por padr√£o, os objetos s√£o **criptografados usando chaves gerenciadas pela Google**, mas voc√™ tamb√©m pode usar uma **chave do KMS**.

### Acesso P√∫blico

√â poss√≠vel dar **acesso aos conte√∫dos dos buckets para usu√°rios externos** (logados na GCP ou n√£o). \
Por padr√£o, quando um bucket √© criado, a op√ß√£o de **expor publicamente** o bucket estar√° **desativada**, mas com permiss√µes suficientes, isso pode ser alterado.

O **formato de uma URL** para acessar um bucket √© **`https://storage.googleapis.com/<nome-do-bucket>` ou `https://<nome_do_bucket>.storage.googleapis.com`** (ambos s√£o v√°lidos).

### Chaves HMAC

Uma chave HMAC √© um tipo de _credencial_ e pode ser **associada a uma conta de servi√ßo ou a uma conta de usu√°rio no Cloud Storage**. Voc√™ usa uma chave HMAC para criar _assinaturas_ que s√£o ent√£o inclu√≠das em solicita√ß√µes ao Cloud Storage. As assinaturas mostram que uma **determinada solicita√ß√£o √© autorizada pelo usu√°rio ou conta de servi√ßo**.

As chaves HMAC t√™m duas partes principais, um _ID de acesso_ e um _segredo_.

*   **ID de Acesso**: Uma sequ√™ncia alfanum√©rica vinculada a um servi√ßo espec√≠fico ou conta de usu√°rio. Quando vinculado a uma conta de servi√ßo, a sequ√™ncia tem 61 caracteres de comprimento e, quando vinculado a uma conta de usu√°rio, a sequ√™ncia tem 24 caracteres de comprimento. O seguinte mostra um exemplo de um ID de acesso:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Segredo**: Uma sequ√™ncia codificada em Base-64 de 40 caracteres que est√° vinculada a um ID de acesso espec√≠fico. Um segredo √© uma chave pr√©-compartilhada que apenas voc√™ e o Cloud Storage conhecem. Voc√™ usa seu segredo para criar assinaturas como parte do processo de autentica√ß√£o. O seguinte mostra um exemplo de um segredo:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Tanto o **ID de acesso quanto o segredo identificam exclusivamente uma chave HMAC**, mas o segredo √© uma informa√ß√£o muito mais sens√≠vel, pois √© usado para **criar assinaturas**.

### Enumera√ß√£o
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list
```
Se voc√™ receber um erro de permiss√£o negada ao listar os buckets, ainda pode ter acesso ao conte√∫do. Agora que voc√™ conhece a conven√ß√£o de nomes dos buckets, pode gerar uma lista de poss√≠veis nomes e tentar acess√°-los:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Com as permiss√µes `storage.objects.list` e `storage.objects.get`, voc√™ deve ser capaz de enumerar todas as pastas e arquivos do bucket para baix√°-los. Voc√™ pode conseguir isso com este script Python:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Escala√ß√£o de Privil√©gios

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes de armazenamento para escalar privil√©gios**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumera√ß√£o N√£o Autenticada

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
