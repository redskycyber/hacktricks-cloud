# GCP - å­˜å‚¨æšä¸¾

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## å­˜å‚¨

Google Cloud Platform (GCP) å­˜å‚¨æ˜¯ä¸€ç§**åŸºäºäº‘çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ï¼Œä¸ºéç»“æ„åŒ–æ•°æ®æä¾›é«˜åº¦è€ç”¨å’Œå¯ç”¨çš„å¯¹è±¡å­˜å‚¨ã€‚å®ƒæä¾›åŸºäºæ€§èƒ½ã€å¯ç”¨æ€§å’Œæˆæœ¬çš„**å¤šç§å­˜å‚¨ç±»åˆ«**ï¼ŒåŒ…æ‹¬æ ‡å‡†ã€è¿‘çº¿ã€å†·çº¿å’Œå½’æ¡£ã€‚GCPå­˜å‚¨è¿˜æä¾›é«˜çº§åŠŸèƒ½ï¼Œå¦‚**ç”Ÿå‘½å‘¨æœŸç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶å’Œè®¿é—®æ§åˆ¶**ï¼Œä»¥æœ‰æ•ˆç®¡ç†å’Œä¿æŠ¤æ•°æ®ã€‚

å­˜å‚¨æ¡¶å¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªåŒºåŸŸã€ä¸¤ä¸ªåŒºåŸŸæˆ–**å¤šåŒºåŸŸï¼ˆé»˜è®¤ï¼‰**ã€‚

### å­˜å‚¨ç±»å‹

* **æ ‡å‡†å­˜å‚¨**ï¼šè¿™æ˜¯é»˜è®¤çš„å­˜å‚¨é€‰é¡¹ï¼Œ**æä¾›å¯¹é¢‘ç¹è®¿é—®æ•°æ®çš„é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿè®¿é—®**ã€‚é€‚ç”¨äºå¹¿æ³›çš„ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æä¾›ç½‘ç«™å†…å®¹ã€æµåª’ä½“å’Œæ‰˜ç®¡æ•°æ®åˆ†æç®¡é“ã€‚
* **è¿‘çº¿å­˜å‚¨**ï¼šè¿™ä¸ªå­˜å‚¨ç±»åˆ«æä¾›**è¾ƒä½çš„å­˜å‚¨æˆæœ¬**å’Œ**ç•¥é«˜çš„è®¿é—®æˆæœ¬**ã€‚å®ƒé’ˆå¯¹ä¸å¸¸è®¿é—®çš„æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€çŸ­å­˜å‚¨æœŸé™ä¸º30å¤©ã€‚å®ƒéå¸¸é€‚åˆå¤‡ä»½å’Œå­˜æ¡£ç›®çš„ã€‚
* **å†·çº¿å­˜å‚¨**ï¼šè¿™ä¸ªå­˜å‚¨ç±»åˆ«é’ˆå¯¹**é•¿æœŸå­˜å‚¨ä¸å¸¸è®¿é—®çš„æ•°æ®**è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæœ€çŸ­å­˜å‚¨æœŸé™ä¸º90å¤©ã€‚å®ƒæä¾›æ¯”è¿‘çº¿å­˜å‚¨**æ›´ä½çš„å­˜å‚¨æˆæœ¬**ï¼Œä½†**è®¿é—®æˆæœ¬æ›´é«˜**ã€‚
* **å½’æ¡£å­˜å‚¨**ï¼šè¿™ä¸ªå­˜å‚¨ç±»åˆ«è®¾è®¡ç”¨äº**éå¸¸ä¸å¸¸è®¿é—®çš„å†·æ•°æ®**ï¼Œæœ€çŸ­å­˜å‚¨æœŸé™ä¸º365å¤©ã€‚å®ƒæä¾›äº†æ‰€æœ‰GCPå­˜å‚¨é€‰é¡¹ä¸­**æœ€ä½çš„å­˜å‚¨æˆæœ¬**ï¼Œä½†**è®¿é—®æˆæœ¬æœ€é«˜**ã€‚å®ƒé€‚ç”¨äºéœ€è¦å› åˆè§„æˆ–ç›‘ç®¡åŸå› è€Œé•¿æœŸä¿ç•™çš„æ•°æ®ã€‚
* **è‡ªåŠ¨åˆ†ç±»**ï¼šå¦‚æœæ‚¨**ä¸çŸ¥é“å°†è¦è®¿é—®æ•°æ®çš„é¢‘ç‡**ï¼Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ†ç±»ï¼ŒGCPå°†**è‡ªåŠ¨ä¸ºæ‚¨æ›´æ”¹å­˜å‚¨ç±»å‹ä»¥æœ€å°åŒ–æˆæœ¬**ã€‚

### è®¿é—®æ§åˆ¶

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œå»ºè®®é€šè¿‡**IAM**æ§åˆ¶è®¿é—®ï¼Œä½†ä¹Ÿå¯ä»¥**å¯ç”¨ACLsçš„ä½¿ç”¨**ã€‚\
å¦‚æœæ‚¨é€‰æ‹©ä»…ä½¿ç”¨IAMï¼ˆé»˜è®¤ï¼‰ï¼Œå¹¶ä¸”**è¿‡å»äº†90å¤©**ï¼Œæ‚¨**å°†æ— æ³•ä¸ºå­˜å‚¨æ¡¶å¯ç”¨ACLs**ã€‚

### ç‰ˆæœ¬æ§åˆ¶

å¯ä»¥å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™å°†**åœ¨å­˜å‚¨æ¡¶å†…ä¿å­˜æ–‡ä»¶çš„æ—§ç‰ˆæœ¬**ã€‚å¯ä»¥é…ç½®**æ‚¨æƒ³è¦ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡**ï¼Œç”šè‡³**éå½“å‰ç‰ˆæœ¬ï¼ˆæ—§ç‰ˆæœ¬ï¼‰çš„å­˜æ´»æ—¶é—´**ã€‚å»ºè®®**æ ‡å‡†ç±»å‹ä¸º7å¤©**ã€‚

**éå½“å‰ç‰ˆæœ¬çš„å…ƒæ•°æ®è¢«ä¿ç•™**ã€‚æ­¤å¤–ï¼Œ**éå½“å‰ç‰ˆæœ¬çš„ACLsä¹Ÿè¢«ä¿ç•™**ï¼Œå› æ­¤æ—§ç‰ˆæœ¬å¯èƒ½å…·æœ‰ä¸å½“å‰ç‰ˆæœ¬ä¸åŒçš„ACLsã€‚

åœ¨[**æ–‡æ¡£**](https://cloud.google.com/storage/docs/object-versioning)ä¸­äº†è§£æ›´å¤šã€‚

### ä¿ç•™ç­–ç•¥

æŒ‡æ˜æ‚¨å¸Œæœ›**ç¦æ­¢åœ¨å­˜å‚¨æ¡¶å†…åˆ é™¤å¯¹è±¡çš„æ—¶é—´é•¿åº¦**ï¼ˆè‡³å°‘å¯¹äºåˆè§„æ€§éå¸¸æœ‰ç”¨ï¼‰ã€‚\
**ç‰ˆæœ¬æ§åˆ¶æˆ–ä¿ç•™ç­–ç•¥åªèƒ½åŒæ—¶å¯ç”¨ä¸€ä¸ª**ã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä½¿ç”¨Googleç®¡ç†çš„å¯†é’¥è¿›è¡Œ**åŠ å¯†**ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨**æ¥è‡ªKMSçš„å¯†é’¥**ã€‚

### HMACå¯†é’¥

HMACå¯†é’¥æ˜¯ä¸€ç§_å‡­è¯_ç±»å‹ï¼Œå¯ä»¥**ä¸äº‘å­˜å‚¨ä¸­çš„æœåŠ¡è´¦æˆ·æˆ–ç”¨æˆ·è´¦æˆ·å…³è”**ã€‚æ‚¨ä½¿ç”¨HMACå¯†é’¥åˆ›å»º_ç­¾å_ï¼Œç„¶åå°†å…¶åŒ…å«åœ¨å¯¹äº‘å­˜å‚¨çš„è¯·æ±‚ä¸­ã€‚ç­¾åè¡¨æ˜**ç»™å®šè¯·æ±‚ç”±ç”¨æˆ·æˆ–æœåŠ¡è´¦æˆ·æˆæƒ**ã€‚

HMACå¯†é’¥æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œä¸€ä¸ª_è®¿é—®ID_å’Œä¸€ä¸ª_ç§˜å¯†_ã€‚

*   **è®¿é—®ID**ï¼šä¸ç‰¹å®šæœåŠ¡æˆ–ç”¨æˆ·è´¦æˆ·å…³è”çš„å­—æ¯æ•°å­—å­—ç¬¦ä¸²ã€‚å½“é“¾æ¥åˆ°æœåŠ¡è´¦æˆ·æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º61ä¸ªå­—ç¬¦ï¼Œå½“é“¾æ¥åˆ°ç”¨æˆ·è´¦æˆ·æ—¶ï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º24ä¸ªå­—ç¬¦ã€‚ä»¥ä¸‹æ˜¯è®¿é—®IDçš„ä¸€ä¸ªç¤ºä¾‹ï¼š

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **ç§˜å¯†**ï¼šä¸€ä¸ª40å­—ç¬¦çš„Base-64ç¼–ç å­—ç¬¦ä¸²ï¼Œä¸ç‰¹å®šçš„è®¿é—®IDå…³è”ã€‚ç§˜å¯†æ˜¯ä¸€ä¸ªé¢„å…±äº«å¯†é’¥ï¼Œåªæœ‰æ‚¨å’Œäº‘å­˜å‚¨çŸ¥é“ã€‚æ‚¨ä½¿ç”¨æ‚¨çš„ç§˜å¯†ä½œä¸ºè®¤è¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†æ¥åˆ›å»ºç­¾åã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç§˜å¯†çš„ç¤ºä¾‹ï¼š

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

**è®¿é—®IDå’Œç§˜å¯†å”¯ä¸€åœ°è¯†åˆ«ä¸€ä¸ªHMACå¯†é’¥**ï¼Œä½†ç§˜å¯†æ˜¯æ›´æ•æ„Ÿçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒç”¨äº**åˆ›å»ºç­¾å**ã€‚

### æšä¸¾
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list
```
```markdown
å¦‚æœåœ¨åˆ—å‡ºå­˜å‚¨æ¡¶æ—¶é‡åˆ°æƒé™æ‹’ç»é”™è¯¯ï¼Œæ‚¨å¯èƒ½ä»ç„¶å¯ä»¥è®¿é—®å†…å®¹ã€‚å› æ­¤ï¼Œç°åœ¨æ‚¨çŸ¥é“äº†å­˜å‚¨æ¡¶çš„å‘½åè§„åˆ™ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆä¸€ç³»åˆ—å¯èƒ½çš„åç§°å¹¶å°è¯•è®¿é—®å®ƒä»¬ï¼š
```
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### å…¬å…±è®¿é—®

å¯ä»¥å…è®¸å¤–éƒ¨ç”¨æˆ·ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•GCPï¼‰è®¿é—®å­˜å‚¨æ¡¶å†…å®¹ã€‚ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå­˜å‚¨æ¡¶å°†ç¦ç”¨å…¬å¼€æš´éœ²å­˜å‚¨æ¡¶çš„é€‰é¡¹ï¼š
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
å¦‚æœæ‚¨å°è¯•ç»™**ç¦ç”¨äº†ACLsçš„å­˜å‚¨æ¡¶åˆ†é…ACLs**ï¼Œæ‚¨ä¼šé‡åˆ°è¿™ä¸ªé”™è¯¯ï¼š`ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

è¦é€šè¿‡æµè§ˆå™¨è®¿é—®å¼€æ”¾çš„å­˜å‚¨æ¡¶ï¼Œè¯·è®¿é—®URL `https://<bucket_name>.storage.googleapis.com/` æˆ– `https://<bucket_name>.storage.googleapis.com/<object_name>`

### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å¦‚ä½•**æ»¥ç”¨å­˜å‚¨æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### åœ¨å½“å‰è´¦æˆ·ä¸­æœç´¢å¼€æ”¾çš„å­˜å‚¨æ¡¶

ä½¿ç”¨ä»¥ä¸‹[ä»è¿™é‡Œæ”¶é›†çš„](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh)è„šæœ¬ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æ‰€æœ‰å¼€æ”¾çš„å­˜å‚¨æ¡¶ï¼š
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
