# GCP - Enumeracja magazynu

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Magazynowanie

Google Cloud Platform (GCP) Storage to **rozwizanie magazynowania w chmurze**, kt贸re zapewnia wysoce trwae i dostpne magazynowanie obiekt贸w dla danych niestrukturyzowanych. Oferuje **r贸偶ne klasy magazynowania** oparte na wydajnoci, dostpnoci i kosztach, w tym Standard, Nearline, Coldline i Archive. GCP Storage zapewnia r贸wnie偶 zaawansowane funkcje takie jak **polityki cyklu 偶ycia, wersjonowanie i kontrola dostpu**, aby efektywnie zarzdza i zabezpiecza dane.

Wiadro mo偶na przechowywa w regionie, w 2 regionach lub **w wielu regionach (domylnie)**.

### Typy magazynowania

* **Standardowe magazynowanie**: Jest to domylna opcja magazynowania, kt贸ra **zapewnia wysok wydajno i niski dostp o niskim op贸藕nieniu do czsto odwiedzanych danych**. Nadaje si do szerokiego zakresu zastosowa, w tym dostarczania treci na stronie internetowej, przesyania medi贸w strumieniowych i hostowania potok贸w analizy danych.
* **Magazynowanie Nearline**: Ta klasa magazynowania oferuje **ni偶sze koszty magazynowania** i **nieco wy偶sze koszty dostpu** ni偶 Standardowe Magazynowanie. Jest zoptymalizowana dla danych rzadko odwiedzanych, z minimalnym czasem przechowywania danych wynoszcym 30 dni. Nadaje si do cel贸w archiwizacji i tworzenia kopii zapasowych.
* **Magazynowanie Coldline**: Ta klasa magazynowania jest zoptymalizowana dla **dugoterminowego przechowywania danych rzadko odwiedzanych**, z minimalnym czasem przechowywania danych wynoszcym 90 dni. Oferuje **ni偶sze koszty magazynowania** ni偶 Magazynowanie Nearline, ale z **wy偶szymi kosztami dostpu**.
* **Magazynowanie Archive**: Ta klasa magazynowania jest przeznaczona dla danych archiwalnych, do kt贸rych dostp jest **bardzo rzadki**, z minimalnym czasem przechowywania danych wynoszcym 365 dni. Oferuje **najni偶sze koszty magazynowania spor贸d wszystkich opcji magazynowania w GCP**, ale z **najwy偶szymi kosztami dostpu**. Nadaje si do dugoterminowego przechowywania danych, kt贸re musz by przechowywane ze wzgld贸w zgodnoci lub regulacyjnych.
* **Autoklasa**: Jeli **nie wiesz, jak czsto bdziesz uzyskiwa dostp** do danych, mo偶esz wybra Autoklas, a GCP **automatycznie zmieni typ magazynowania, aby zminimalizowa koszty**.

### Kontrola dostpu

Domylnie zaleca si kontrolowanie dostpu za pomoc **IAM**, ale mo偶na r贸wnie偶 **wczy korzystanie z list ACL**.\
Jeli wybierzesz korzystanie tylko z IAM (domylnie) i **minie 90 dni**, nie bdziesz m贸g wczy list ACL dla wiadra.

### Wersjonowanie

Mo偶liwe jest wczenie wersjonowania, co spowoduje **zachowanie starych wersji plik贸w wewntrz wiadra**. Mo偶na skonfigurowa **liczb wersji, kt贸re chcesz zachowa** oraz nawet **jak dugo** maj **偶y nieaktualne** wersje (stare wersje). Zalecane jest **7 dni dla typu Standard**.

**Metadane nieaktualnej wersji s przechowywane**. Ponadto **listy ACL nieaktualnych wersji s r贸wnie偶 przechowywane**, wic starsze wersje mog mie inne listy ACL ni偶 bie偶ca wersja.

Dowiedz si wicej w [**dokumentacji**](https://cloud.google.com/storage/docs/object-versioning).

### Polityka retencji

Okrel, jak **dugo** chcesz **zakaza usuwania obiekt贸w wewntrz wiadra** (bardzo przydatne ze wzgld贸w zgodnoci przynajmniej).\
Tylko jedno z **wersjonowania lub polityki retencji mo偶e by wczone jednoczenie**.

### Szyfrowanie

Domylnie obiekty s **szyfrowane za pomoc zarzdzanych przez Google kluczy**, ale mo偶na r贸wnie偶 u偶y **klucza z KMS**.

### Dostp publiczny

Mo偶liwe jest udzielenie **zewntrznym u偶ytkownikom** (zalogowanym do GCP lub nie) **dostpu do zawartoci wiadra**. \
Domylnie, gdy wiadro jest tworzone, opcja **publicznego udostpniania wiadra jest wyczona**, ale przy wystarczajcych uprawnieniach mo偶na j zmieni.

**Format URL** do dostpu do wiadra to **`https://storage.googleapis.com/<nazwa-wiadra>` lub `https://<nazwa_wiadra>.storage.googleapis.com`** (oba s poprawne).

### Klucze HMAC

Klucz HMAC to rodzaj _powiadczenia_ i mo偶e by **powizany z kontem usugi lub kontem u偶ytkownika w Cloud Storage**. U偶ywasz klucza HMAC do tworzenia _podpis贸w_, kt贸re s nastpnie doczane do 偶da do Cloud Storage. Podpisy pokazuj, 偶e **dane 偶danie jest autoryzowane przez u偶ytkownika lub konto usugi**.

Klucze HMAC maj dwie podstawowe czci, _identyfikator dostpu_ i _sekret_.

*   **Identyfikator dostpu**: Alfanumeryczny cig powizany z okrelon usug lub kontem u偶ytkownika. Gdy jest powizany z kontem usugi, cig ma dugo 61 znak贸w, a gdy jest powizany z kontem u偶ytkownika, cig ma dugo 24 znak贸w. Poni偶ej przedstawiono przykad identyfikatora dostpu:

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **Sekret**: 40-znakowy zakodowany w Base-64 cig, kt贸ry jest powizany z okrelonym identyfikatorem dostpu. Sekret to klucz uzgodniony z g贸ry, kt贸ry znaj tylko ty i Cloud Storage. U偶ywasz swojego sekretu do tworzenia podpis贸w w ramach procesu uwierzytelniania. Poni偶ej przedstawiono przykad sekretu:

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

Zar贸wno **identyfikator dostpu, jak i sekret jednoznacznie identyfikuj klucz HMAC**, ale sekret jest znacznie bardziej poufn informacj, poniewa偶 jest u偶ywany do **tworzenia podpis贸w**.

### Wyliczanie
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list
```
Jeli otrzymasz bd o braku uprawnie do wywietlenia kubek贸w, mo偶esz nadal mie dostp do ich zawartoci. Teraz, kiedy znasz konwencj nazewnictwa kubek贸w, mo偶esz wygenerowa list mo偶liwych nazw i spr贸bowa uzyska do nich dostp:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
Z uprawnieniami `storage.objects.list` i `storage.objects.get` powiniene m贸c wyliczy wszystkie foldery i pliki z kubeka, aby je pobra. Mo偶esz to osign za pomoc tego skryptu w jzyku Python:
```python
import requests
import xml.etree.ElementTree as ET

def list_bucket_objects(bucket_name, prefix='', marker=None):
url = f"https://storage.googleapis.com/{bucket_name}?prefix={prefix}"
if marker:
url += f"&marker={marker}"
response = requests.get(url)
xml_data = response.content
root = ET.fromstring(xml_data)
ns = {'ns': 'http://doc.s3.amazonaws.com/2006-03-01'}
for contents in root.findall('.//ns:Contents', namespaces=ns):
key = contents.find('ns:Key', namespaces=ns).text
print(key)
next_marker = root.find('ns:NextMarker', namespaces=ns)
if next_marker is not None:
next_marker_value = next_marker.text
list_bucket_objects(bucket_name, prefix, next_marker_value)

list_bucket_objects('<storage-name>')
```
### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia do przechowywania danych do eskalacji uprawnie**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/" %}
[gcp-storage-unauthenticated-enum](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/)
{% endcontent-ref %}

### Po wykorzystaniu

{% content-ref url="../gcp-post-exploitation/gcp-storage-post-exploitation.md" %}
[gcp-storage-post-exploitation.md](../gcp-post-exploitation/gcp-storage-post-exploitation.md)
{% endcontent-ref %}

### Utrzymanie dostpu

{% content-ref url="../gcp-persistence/gcp-storage-persistence.md" %}
[gcp-storage-persistence.md](../gcp-persistence/gcp-storage-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
