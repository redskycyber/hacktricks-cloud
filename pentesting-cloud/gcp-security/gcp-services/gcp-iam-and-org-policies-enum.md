# GCP - IAMã€Ppals å’Œç»„ç»‡ç­–ç•¥æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æœåŠ¡è´¦æˆ·

å…³äºæœåŠ¡è´¦æˆ·æ˜¯ä»€ä¹ˆçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

æœåŠ¡è´¦æˆ·æ€»æ˜¯å±äºä¸€ä¸ªé¡¹ç›®ï¼š
```bash
gcloud iam service-accounts list --project <project>
```
## ç”¨æˆ·ä¸ç»„

æœ‰å…³ GCP ä¸­ç”¨æˆ·ä¸ç»„å¦‚ä½•å·¥ä½œçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

æ‹¥æœ‰ **`serviceusage.services.enable`** å’Œ **`serviceusage.services.use`** æƒé™å¯ä»¥åœ¨é¡¹ç›®ä¸­**å¯ç”¨æœåŠ¡**å¹¶ä½¿ç”¨å®ƒä»¬ã€‚

å¦‚æœä½ èƒ½å¤Ÿ**å¯ç”¨ `admin` æœåŠ¡**ï¼Œå¹¶ä¸”ä½ çš„ç”¨æˆ·åœ¨ workspace ä¸­æ‹¥æœ‰**è¶³å¤Ÿçš„æƒé™**ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç **æšä¸¾æ‰€æœ‰ç»„å’Œç”¨æˆ·**ã€‚\
å³ä½¿å®ƒæ˜¾ç¤ºä¸º **`identity groups`**ï¼Œå®ƒä¹Ÿä¼šè¿”å›**æ²¡æœ‰ä»»ä½•ç»„çš„ç”¨æˆ·**ï¼š
```bash
# Enable admin
gcloud services enable admin.googleapis.com
# List all users & groups
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>
## Group Members
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```
å³ä½¿å¯ç”¨äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œå¦‚æœæ‚¨çš„å—æŸWorkspaceç”¨æˆ·æƒé™ä¸è¶³ï¼Œæ‚¨åœ¨æšä¸¾æ—¶å¯èƒ½ä¼šé‡åˆ°é”™è¯¯ï¼š

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

å¦‚æœæ‚¨èƒ½å¤Ÿå¯ç”¨æœåŠ¡ **`cloudidentity.googleapli.com`**ï¼ˆå¦‚æœå·²ç¦ç”¨ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥**æšä¸¾ç¾¤ç»„**ï¼ˆå°±åƒåœ¨PurplePandaçš„[è¿™é‡Œ](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)æ‰€åšçš„é‚£æ ·ï¼‰ï¼š
```
gcloud services enable cloudidentity.googleapis.com
```
## IAM

æŸ¥çœ‹[**è¿™é‡Œè·å–æœ‰å…³IAMçš„åŸºæœ¬ä¿¡æ¯**](../gcp-basic-information.md#iam-roles)ã€‚

### é»˜è®¤æƒé™

æ ¹æ®[**æ–‡æ¡£**](https://cloud.google.com/resource-manager/docs/default-access-control)ï¼šå½“åˆ›å»ºç»„ç»‡èµ„æºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šè¢«æˆäºˆ**è®¡è´¹è´¦æˆ·åˆ›å»ºè€…**å’Œ**é¡¹ç›®åˆ›å»ºè€…**è§’è‰²ã€‚è¿™äº›é»˜è®¤è§’è‰²å…è®¸æ‚¨çš„ç”¨æˆ·ç«‹å³å¼€å§‹ä½¿ç”¨Google Cloudï¼Œä½†å¹¶ä¸é€‚ç”¨äºç»„ç»‡èµ„æºçš„å¸¸è§„æ“ä½œã€‚

è¿™äº›**è§’è‰²**æˆäºˆä»¥ä¸‹**æƒé™**ï¼š

* `billing.accounts.create` å’Œ `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` å’Œ `resourcemanager.projects.create`

{% hint style="danger" %}
åœ¨GCPç»„ç»‡ä¸­æœ€é«˜æƒé™æ˜¯**ç»„ç»‡ç®¡ç†å‘˜**è§’è‰²ã€‚
{% endhint %}

### æšä¸¾
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### é€šè¿‡ cloudasset æšä¸¾

ä½¿ç”¨æ­¤æœåŠ¡ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥æ£€æŸ¥ç”¨æˆ·åœ¨ä¸åŒèµ„æºï¼ˆå¦‚ç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ç­‰ï¼‰ä¸­çš„æ‰€æœ‰æƒé™ã€‚

* æƒé™ **`cloudasset.assets.searchAllIamPolicies`** å¯ä»¥è¯·æ±‚èµ„æºå†…çš„**æ‰€æœ‰ iam ç­–ç•¥**ã€‚
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeIamPolicy`** å¯ä»¥è¯·æ±‚èµ„æºå†…ä¸»ä½“çš„**æ‰€æœ‰iamç­–ç•¥**ã€‚
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* æƒé™ **`cloudasset.assets.searchAllResources`** å…è®¸åˆ—å‡ºç»„ç»‡ã€æ–‡ä»¶å¤¹æˆ–é¡¹ç›®çš„æ‰€æœ‰èµ„æºã€‚åŒ…æ‹¬ä¸IAMç›¸å…³çš„èµ„æºï¼ˆå¦‚è§’è‰²ï¼‰ã€‚
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeMove`** ä¹Ÿå¯ä»¥ç”¨æ¥æ£€ç´¢å½±å“èµ„æºï¼ˆå¦‚é¡¹ç›®ï¼‰çš„ç­–ç•¥
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* æˆ‘è®¤ä¸ºæƒé™ **`cloudasset.assets.queryIamPolicy`** ä¹Ÿå¯èƒ½å…è®¸æŸ¥æ‰¾ä¸»ä½“çš„æƒé™
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
å¦‚æœæ‚¨**æ— æ³•ä½¿ç”¨å‰è¿°æ–¹æ³•è®¿é—® IAM ä¿¡æ¯**ï¼Œå¹¶ä¸”æ‚¨åœ¨çº¢é˜Ÿä¸­ã€‚æ‚¨å¯ä»¥**ä½¿ç”¨å·¥å…·** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **æ¥æš´åŠ›ç ´è§£æ‚¨å½“å‰çš„æƒé™ã€‚**
{% endhint %}

### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ IAM æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### æœåŠ¡è´¦æˆ·æ¨¡æ‹Ÿ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

æ¨¡æ‹ŸæœåŠ¡è´¦æˆ·å¯ä»¥éå¸¸æœ‰ç”¨ï¼Œä»¥**è·å¾—æ–°çš„å’Œæ›´å¥½çš„æƒé™**ã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼[æ¨¡æ‹Ÿå¦ä¸€ä¸ªæœåŠ¡è´¦æˆ·](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)ï¼š

* ä½¿ç”¨ RSA ç§é’¥è¿›è¡Œ**è®¤è¯**ï¼ˆä¸Šæ–‡å·²è¦†ç›–ï¼‰
* ä½¿ç”¨ Cloud IAM ç­–ç•¥è¿›è¡Œ**æˆæƒ**ï¼ˆæ­¤å¤„è¦†ç›–ï¼‰
* **åœ¨ GCP æœåŠ¡ä¸Šéƒ¨ç½²ä½œä¸š**ï¼ˆæ›´é€‚ç”¨äºç”¨æˆ·è´¦æˆ·çš„å¦¥åï¼‰

### æˆäºˆè®¿é—®ç®¡ç†æ§åˆ¶å°çš„æƒé™ <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

è®¿é—® [GCP ç®¡ç†æ§åˆ¶å°](https://console.cloud.google.com) æ˜¯**æä¾›ç»™ç”¨æˆ·è´¦æˆ·ï¼Œè€Œä¸æ˜¯æœåŠ¡è´¦æˆ·**ã€‚è¦ç™»å½•åˆ°ç½‘ç»œç•Œé¢ï¼Œæ‚¨å¯ä»¥**æˆäºˆæ‚¨æ§åˆ¶çš„ Google è´¦æˆ·è®¿é—®æƒé™**ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªé€šç”¨çš„ "**@gmail.com**" è´¦æˆ·ï¼Œå®ƒ**ä¸å¿…æ˜¯ç›®æ ‡ç»„ç»‡çš„æˆå‘˜**ã€‚

ç„¶è€Œï¼Œè¦**æˆäºˆ**ä¸€ä¸ªé€šç”¨ "@gmail.com" è´¦æˆ·**Owner**çš„åŸå§‹è§’è‰²ï¼Œæ‚¨éœ€è¦**ä½¿ç”¨ç½‘ç»œæ§åˆ¶å°**ã€‚å¦‚æœæ‚¨å°è¯•æˆäºˆé«˜äºç¼–è¾‘è€…çš„æƒé™ï¼Œ`gcloud` ä¼šå‡ºé”™ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**æˆäºˆç”¨æˆ·å¯¹æ‚¨ç°æœ‰é¡¹ç›®çš„ç¼–è¾‘è€…åŸå§‹è§’è‰²**ï¼š
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
å¦‚æœæ‚¨åœ¨è¿™é‡ŒæˆåŠŸäº†ï¼Œå°è¯•**è®¿é—®ç½‘ç»œç•Œé¢**å¹¶ä»é‚£é‡Œæ¢ç´¢ã€‚

è¿™æ˜¯æ‚¨ä½¿ç”¨gcloudå·¥å…·å¯ä»¥åˆ†é…çš„**æœ€é«˜çº§åˆ«**ã€‚

## ç»„ç»‡ç­–ç•¥

è¦äº†è§£ç»„ç»‡ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMç­–ç•¥æŒ‡ç¤ºäº†ä¸»ä½“é€šè¿‡è§’è‰²å¯¹èµ„æºçš„æƒé™ï¼Œè¿™äº›è§’è‰²è¢«åˆ†é…äº†ç»†ç²’åº¦æƒé™ã€‚ç»„ç»‡ç­–ç•¥**é™åˆ¶äº†è¿™äº›æœåŠ¡çš„ä½¿ç”¨æ–¹å¼æˆ–å“ªäº›åŠŸèƒ½è¢«ç¦ç”¨**ã€‚è¿™æœ‰åŠ©äºæ”¹å–„GCPç¯å¢ƒä¸­æ¯ä¸ªèµ„æºçš„æœ€å°æƒé™ã€‚
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ç»„ç»‡ç­–ç•¥æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
