# GCP - IAM, Ppals & Org Policies Enum

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æœåŠ¡è´¦å·

å…³äºä»€ä¹ˆæ˜¯æœåŠ¡è´¦å·çš„ä»‹ç»ï¼Œè¯·å‚è€ƒï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

æœåŠ¡è´¦å·å§‹ç»ˆå±äºä¸€ä¸ªé¡¹ç›®ï¼š
```bash
gcloud iam service-accounts list --project <project>
```
## ç”¨æˆ·å’Œç»„

æœ‰å…³GCPä¸­ç”¨æˆ·å’Œç»„å¦‚ä½•å·¥ä½œçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

ä½¿ç”¨æƒé™ **`serviceusage.services.enable`** å’Œ **`serviceusage.services.use`**ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­**å¯ç”¨æœåŠ¡**å¹¶ä½¿ç”¨å®ƒä»¬ã€‚

å¦‚æœæ‚¨å¯ä»¥**å¯ç”¨`admin`æœåŠ¡**å¹¶ä¸”æ‚¨çš„ç”¨æˆ·åœ¨å·¥ä½œåŒºä¸­å…·æœ‰**è¶³å¤Ÿçš„æƒé™**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**æšä¸¾æ‰€æœ‰ç»„å’Œç”¨æˆ·**ã€‚\
å³ä½¿å®ƒè¯´æ˜¯**`identity groups`**ï¼Œå®ƒä¹Ÿä¼šè¿”å›**æ²¡æœ‰ä»»ä½•ç»„çš„ç”¨æˆ·**ï¼š
```bash
# Enable admin
gcloud services enable admin.googleapis.com
# List all users & groups
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>
## Group Members
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```
å³ä½¿å¯ç”¨äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œç”±äºæ‚¨å—æŸçš„å·¥ä½œåŒºç”¨æˆ·æƒé™ä¸è¶³ï¼Œå¯èƒ½ä¼šåœ¨æšä¸¾æ—¶é‡åˆ°é”™è¯¯ï¼š

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

å¦‚æœå¯ä»¥å¯ç”¨è¢«ç¦ç”¨çš„æœåŠ¡ **`cloudidentity.googleapli.com`**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥**æšä¸¾ç»„**ï¼ˆå°±åƒåœ¨[PurplePanda](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)ä¸­æ‰€åšçš„é‚£æ ·ï¼‰ï¼š
```
gcloud services enable cloudidentity.googleapis.com
```
## IAM

æŸ¥çœ‹[**è¿™é‡Œçš„IAMåŸºæœ¬ä¿¡æ¯**](../gcp-basic-information.md#iam-roles)ã€‚

### é»˜è®¤æƒé™

æ ¹æ®[**æ–‡æ¡£**](https://cloud.google.com/resource-manager/docs/default-access-control)ï¼šå½“åˆ›å»ºç»„ç»‡èµ„æºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·éƒ½è¢«æˆäºˆ**Billing Account Creator**å’Œ**Project Creator**è§’è‰²ã€‚è¿™äº›é»˜è®¤è§’è‰²å…è®¸æ‚¨çš„ç”¨æˆ·ç«‹å³å¼€å§‹ä½¿ç”¨Google Cloudï¼Œä½†ä¸é€‚ç”¨äºç»„ç»‡èµ„æºçš„å¸¸è§„æ“ä½œã€‚

è¿™äº›**è§’è‰²**æˆäºˆä»¥ä¸‹**æƒé™**ï¼š

* `billing.accounts.create`å’Œ`resourcemanager.organizations.get`
* `resourcemanager.organizations.get`å’Œ`resourcemanager.projects.create`

{% hint style="danger" %}
GCPç»„ç»‡ä¸­çš„æœ€é«˜æƒé™æ˜¯**ç»„ç»‡ç®¡ç†å‘˜**è§’è‰²ã€‚
{% endhint %}

### æšä¸¾
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### é€šè¿‡cloudassetè¿›è¡Œæšä¸¾

æœ‰å¤šç§æ–¹æ³•å¯ä»¥ä½¿ç”¨æ­¤æœåŠ¡æ£€æŸ¥ç”¨æˆ·åœ¨ä¸åŒèµ„æºï¼ˆå¦‚ç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ç­‰ï¼‰ä¸­çš„æ‰€æœ‰æƒé™ã€‚

* æƒé™**`cloudasset.assets.searchAllIamPolicies`**å¯ä»¥è¯·æ±‚åœ¨èµ„æºå†…éƒ¨çš„**æ‰€æœ‰iamç­–ç•¥**ã€‚
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeIamPolicy`** å¯ä»¥è¯·æ±‚èµ„æºå†…ç‰¹å®šä¸»ä½“çš„**æ‰€æœ‰ IAM ç­–ç•¥**ã€‚
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* æƒé™ **`cloudasset.assets.searchAllResources`** å…è®¸åˆ—å‡ºç»„ç»‡ã€æ–‡ä»¶å¤¹æˆ–é¡¹ç›®çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ä¸IAMç›¸å…³çš„èµ„æºï¼ˆå¦‚è§’è‰²ï¼‰ã€‚
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeMove`** å¯ç”¨äºæ£€ç´¢å½±å“é¡¹ç›®ç­‰èµ„æºçš„ç­–ç•¥ã€‚
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* æˆ‘è®¤ä¸ºæƒé™ **`cloudasset.assets.queryIamPolicy`** ä¹Ÿå¯ä»¥è®©ç”¨æˆ·æŸ¥æ‰¾ä¸»ä½“çš„æƒé™
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
å¦‚æœæ‚¨æ— æ³•ä½¿ç”¨å…ˆå‰çš„æ–¹æ³•è®¿é—®IAMä¿¡æ¯ï¼Œå¹¶ä¸”æ‚¨æ˜¯çº¢é˜Ÿæˆå‘˜ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/carlospolop/my\_gcp\_perms](https://github.com/carlospolop/my\_gcp\_perms)æ¥æš´åŠ›ç ´è§£æ‚¨å½“å‰çš„æƒé™ã€‚
{% endhint %}

### ææƒ

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥çœ‹å¦‚ä½•æ»¥ç”¨IAMæƒé™ä»¥æå‡ç‰¹æƒï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### æœåŠ¡è´¦å·å†’å…… <a href="#service-account-impersonation" id="service-account-impersonation"></a>

å†’å……æœåŠ¡è´¦å·å¯ä»¥éå¸¸æœ‰ç”¨ï¼Œä»¥è·å¾—æ–°çš„å’Œæ›´å¥½çš„ç‰¹æƒã€‚

æœ‰ä¸‰ç§æ–¹å¼å¯ä»¥[å†’å……å¦ä¸€ä¸ªæœåŠ¡è´¦å·](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)ï¼š

* ä½¿ç”¨RSAç§é’¥è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆä¸Šé¢å·²æ¶µç›–ï¼‰
* ä½¿ç”¨Cloud IAMç­–ç•¥è¿›è¡Œæˆæƒï¼ˆåœ¨æ­¤å¤„æ¶µç›–ï¼‰
* åœ¨GCPæœåŠ¡ä¸Šéƒ¨ç½²ä½œä¸šï¼ˆæ›´é€‚ç”¨äºç”¨æˆ·è´¦å·çš„å¦¥åï¼‰

### æˆäºˆå¯¹ç®¡ç†æ§åˆ¶å°çš„è®¿é—®æƒé™ <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

å¯¹äºGCPç®¡ç†æ§åˆ¶å°çš„è®¿é—®æƒé™æ˜¯æä¾›ç»™ç”¨æˆ·è´¦å·è€Œä¸æ˜¯æœåŠ¡è´¦å·çš„ã€‚è¦ç™»å½•åˆ°Webç•Œé¢ï¼Œæ‚¨å¯ä»¥æˆäºˆæ‚¨æ§åˆ¶çš„Googleè´¦å·è®¿é—®æƒé™ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªé€šç”¨çš„â€œ@gmail.comâ€è´¦å·ï¼Œå®ƒä¸å¿…æ˜¯ç›®æ ‡ç»„ç»‡çš„æˆå‘˜ã€‚

è¦å°†é€šç”¨çš„â€œ@gmail.comâ€è´¦å·æˆäºˆåŸå§‹è§’è‰²â€œOwnerâ€ï¼Œæ‚¨éœ€è¦ä½¿ç”¨Webæ§åˆ¶å°ã€‚å¦‚æœæ‚¨å°è¯•æˆäºˆå®ƒé«˜äºEditorçš„æƒé™ï¼Œ`gcloud`å°†æŠ¥é”™ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†ç”¨æˆ·æˆäºˆç°æœ‰é¡¹ç›®çš„åŸå§‹è§’è‰²â€œEditorâ€ï¼š
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
å¦‚æœä½ åœ¨è¿™é‡ŒæˆåŠŸäº†ï¼Œå°è¯•**è®¿é—®Webç•Œé¢**å¹¶ä»é‚£é‡Œè¿›è¡Œæ¢ç´¢ã€‚

è¿™æ˜¯ä½¿ç”¨gcloudå·¥å…·å¯ä»¥åˆ†é…çš„**æœ€é«˜çº§åˆ«**ã€‚

## ç»„ç»‡ç­–ç•¥

å…³äºç»„ç»‡ç­–ç•¥çš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMç­–ç•¥æŒ‡ç¤ºäº†ä¸»ä½“å¯¹èµ„æºæ‹¥æœ‰çš„æƒé™ï¼Œé€šè¿‡è§’è‰²åˆ†é…äº†ç»†ç²’åº¦çš„æƒé™ã€‚ç»„ç»‡ç­–ç•¥**é™åˆ¶äº†è¿™äº›æœåŠ¡çš„ä½¿ç”¨æ–¹å¼æˆ–ç¦ç”¨äº†å“ªäº›åŠŸèƒ½**ã€‚è¿™æœ‰åŠ©äºæé«˜GCPç¯å¢ƒä¸­æ¯ä¸ªèµ„æºçš„æœ€å°ç‰¹æƒã€‚
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### ææƒ

åœ¨ä¸‹é¢çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ç»„ç»‡ç­–ç•¥æƒé™ä»¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
