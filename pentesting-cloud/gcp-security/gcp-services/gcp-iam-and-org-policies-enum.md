# GCP - IAM, Principals & Org Policies Enum

<details>

<summary><strong>Impara l'hacking su AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Account di Servizio

Per una introduzione su cosa sia un account di servizio controlla:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumerazione

Un account di servizio appartiene sempre a un progetto:

```bash
gcloud iam service-accounts list --project <project>
```

## Utenti e Gruppi

Per una introduzione su come funzionano Utenti e Gruppi in GCP, controlla:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### Enumerazione

Con i permessi **`serviceusage.services.enable`** e **`serviceusage.services.use`** √® possibile **abilitare servizi** in un progetto e utilizzarli.

{% hint style="danger" %}
Nota che di default, agli utenti di Workspace viene assegnato il ruolo **Project Creator**, che concede loro l'accesso per **creare nuovi progetti**. Quando un utente crea un progetto, gli viene assegnato il ruolo **`owner`** su di esso. Quindi, potrebbe **abilitare questi servizi sul progetto per poter enumerare Workspace**.

Tuttavia, √® importante notare che √® necessario avere **sufficienti autorizzazioni in Workspace** per poter chiamare queste API.
{% endhint %}

Se puoi **abilitare il servizio `admin`** e se il tuo utente ha **sufficienti privilegi in workspace**, potresti **enumerare tutti i gruppi e utenti** con le seguenti righe.\
Anche se si parla di **`gruppi di identit√†`**, restituisce anche **utenti senza alcun gruppo**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Nei precedenti esempi il parametro `--labels` √® richiesto, quindi viene utilizzato un valore generico (non √® richiesto se si utilizza l'API direttamente come fa [**PurplePanda qui**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Anche con il servizio admin abilitato, √® possibile che si verifichi un errore nell'enumerarli perch√© l'utente del tuo workspace compromesso non ha abbastanza autorizzazioni:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Controlla [**questo per informazioni di base su IAM**](../gcp-basic-information/#iam-roles).

### Autorizzazioni predefinite

Dai [**documenti**](https://cloud.google.com/resource-manager/docs/default-access-control): Quando viene creato un risorsa dell'organizzazione, tutti gli utenti nel tuo dominio ottengono automaticamente i ruoli **Billing Account Creator** e **Project Creator** per impostazione predefinita. Questi ruoli predefiniti consentono agli utenti di iniziare a utilizzare Google Cloud immediatamente, ma non sono destinati all'uso regolare delle risorse dell'organizzazione.

Questi **ruoli** concedono le **autorizzazioni**:

* `billing.accounts.create` e `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` e `resourcemanager.projects.create`

Inoltre, quando un utente crea un progetto, viene **automaticamente assegnato come proprietario di quel progetto** secondo i [documenti](https://cloud.google.com/resource-manager/docs/access-control-proj). Pertanto, per impostazione predefinita, un utente sar√† in grado di creare un progetto ed eseguire qualsiasi servizio su di esso (minatori? Enumerazione di Workspace? ...)

{% hint style="danger" %}
Il privilegio pi√π elevato in un'Organizzazione GCP √® il ruolo di **Amministratore dell'Organizzazione**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Nella maggior parte dei servizi sar√† possibile modificare le autorizzazioni su una risorsa utilizzando il metodo **`add-iam-policy-binding`** o **`set-iam-policy`**. La differenza principale √® che **`add-iam-policy-binding` aggiunge un nuovo binding di ruolo** alla policy IAM esistente mentre **`set-iam-policy`** **eliminer√† le autorizzazioni precedentemente** concesse e **imposter√† solo quelle** indicate nel comando.

### Enumerazione

```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```

### Enumerazione IAM di cloudasset

Ci sono diversi modi per verificare tutti i permessi di un utente su risorse diverse (come organizzazioni, cartelle, progetti...) utilizzando questo servizio.

* Il permesso **`cloudasset.assets.searchAllIamPolicies`** pu√≤ richiedere **tutte le policy iam** all'interno di una risorsa.

```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```

* Il permesso **`cloudasset.assets.analyzeIamPolicy`** pu√≤ richiedere **tutte le policy iam** di un principale all'interno di una risorsa.

```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```

* Il permesso **`cloudasset.assets.searchAllResources`** consente di elencare tutte le risorse di un'organizzazione, cartella o progetto. Risorse correlate a IAM (come ruoli) incluse.

```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```

* Il permesso **`cloudasset.assets.analyzeMove`** potrebbe essere utile anche per recuperare le policy che influenzano una risorsa come un progetto

```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```

* Suppongo che il permesso **`cloudasset.assets.queryIamPolicy`** potrebbe anche dare accesso per trovare i permessi dei principali.

```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```

### Enumerazione dei permessi di testIamPermissions

{% hint style="danger" %}
Se **non √® possibile accedere alle informazioni IAM** utilizzando i metodi precedenti e ti trovi in un Red Team. Potresti **utilizzare lo strumento** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **per forzare i tuoi permessi attuali.**

Tuttavia, nota che il servizio **`cloudresourcemanager.googleapis.com`** deve essere abilitato.
{% endhint %}

### Privesc

Nella pagina seguente puoi verificare come **abusare dei permessi IAM per elevare i privilegi**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Enumerazione non autenticata <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Esploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistenza

Se hai privilegi elevati potresti:

* Creare nuovi SA (o utenti se sei in Workspace)
* Dare pi√π permessi ai principali controllati da te
* Concedere pi√π privilegi a SA vulnerabili (SSRF in vm, Cloud Function vulnerabile...)
* ...

## Politiche dell'Organizzazione

Per una introduzione su cosa sono le Politiche dell'Organizzazione, controlla:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Le politiche IAM indicano i permessi che i principali hanno sui servizi tramite ruoli, ai quali sono assegnati permessi granulari. Le politiche dell'organizzazione **limitano come quei servizi possono essere utilizzati o quali funzionalit√† sono disabilitate**. Questo aiuta a migliorare il principio del privilegio minimo di ciascuna risorsa nell'ambiente GCP.

```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```

### Escalazione dei privilegi

Nella seguente pagina puoi verificare come **abusare dei permessi delle policy dell'organizzazione per escalare i privilegi**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}
