# GCP - Enumeracja IAM, Podmiot贸w i Polityk Org

<details>

<summary><strong>Zacznij od zera i zosta ekspertem od hakowania AWS dziki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Konta Usug

Aby dowiedzie si wicej na temat konta usugi, sprawd藕:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeracja

Konto usugi zawsze nale偶y do projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## U偶ytkownicy i Grupy

Aby uzyska wprowadzenie do tego, jak dziaaj U偶ytkownicy i Grupy w GCP, sprawd藕:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Wyliczanie

Dziki uprawnieniom **`serviceusage.services.enable`** i **`serviceusage.services.use`** mo偶na **wcza usugi** w projekcie i z nich korzysta.

{% hint style="danger" %}
Zauwa偶, 偶e domylnie u偶ytkownicy Workspace otrzymuj rol **Tw贸rca projektu**, co daje im dostp do **tworzenia nowych projekt贸w**. Gdy u偶ytkownik tworzy projekt, otrzymuje rol **`owner`** nad nim. Dlatego mo偶e **wczy te usugi w projekcie, aby m贸c wyliczy Workspace**.

Jednak zauwa偶, 偶e konieczne jest r贸wnie偶 posiadanie **wystarczajcych uprawnie w Workspace**, aby m贸c wywoa te interfejsy API.
{% endhint %}

Jeli mo偶esz **wczy usug `admin`** i jeli Tw贸j u偶ytkownik ma **wystarczajce uprawnienia w Workspace**, mo偶esz **wyliczy wszystkie grupy i u偶ytkownik贸w** za pomoc poni偶szych polece.\
Nawet jeli m贸wi **`grupy to偶samoci`**, zwraca r贸wnie偶 **u偶ytkownik贸w bez przypisanych grup**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
W poprzednich przykadach parametr `--labels` jest wymagany, dlatego u偶ywana jest og贸lna warto (nie jest wymagany, jeli u偶ywasz API bezporednio, tak jak [**PurplePanda robi tutaj**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Nawet po wczeniu usugi admin, mo偶liwe jest, 偶e wystpi bd podczas ich wyliczania, poniewa偶 skompromitowany u偶ytkownik przestrzeni roboczej nie ma wystarczajcych uprawnie:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Sprawd藕 [**to podstawowe informacje na temat IAM**](../gcp-basic-information.md#iam-roles).

### Domylne uprawnienia

Z [**dokumentacji**](https://cloud.google.com/resource-manager/docs/default-access-control): Gdy tworzony jest zas贸b organizacji, wszyscy u偶ytkownicy w Twojej domenie otrzymuj domylnie role **Tw贸rca konta rozliczeniowego** i **Tw贸rca projektu**. Te domylne role pozwalaj Twoim u偶ytkownikom natychmiast zacz korzysta z Google Cloud, ale nie s przeznaczone do regularnego u偶ytku zasob贸w organizacji.

Te **role** nadaj **uprawnienia**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

Ponadto, gdy u偶ytkownik tworzy projekt, automatycznie **otrzymuje uprawnienia waciciela tego projektu** zgodnie z [dokumentacj](https://cloud.google.com/resource-manager/docs/access-control-proj). Dlatego domylnie u偶ytkownik bdzie m贸g tworzy projekt i uruchamia na nim dowoln usug (koparki? Wyliczanie przestrzeni roboczej? ...)

{% hint style="danger" %}
Najwy偶sz uprawnieniem w organizacji GCP jest rola **Administratora organizacji**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

W wikszoci usug bdziesz m贸g zmienia uprawnienia dla zasobu za pomoc metody **`add-iam-policy-binding`** lub **`set-iam-policy`**. G贸wna r贸偶nica polega na tym, 偶e **`add-iam-policy-binding` dodaje nowe powizanie roli** do istniejcej polityki IAM, podczas gdy **`set-iam-policy`** **usunie wczeniej** udzielone uprawnienia i **ustawi tylko te**, kt贸re s wskazane w poleceniu.

### Wyliczanie
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### Enumeracja IAM cloudasset

Istniej r贸偶ne sposoby sprawdzenia wszystkich uprawnie u偶ytkownika w r贸偶nych zasobach (takich jak organizacje, foldery, projekty...) za pomoc tej usugi.

* Uprawnienie **`cloudasset.assets.searchAllIamPolicies`** umo偶liwia 偶danie **wszystkich polityk IAM** wewntrz zasobu.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Uprawnienie **`cloudasset.assets.analyzeIamPolicy`** mo偶e 偶da **wszystkich polityk IAM** podmiotu w zasobie.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Uprawnienie **`cloudasset.assets.searchAllResources`** pozwala na wywietlanie wszystkich zasob贸w organizacji, folderu lub projektu. Zasoby zwizane z IAM (takie jak role) s uwzgldnione.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Uprawnienie **`cloudasset.assets.analyzeMove`** mo偶e by przydatne do pobrania polityk dotyczcych zasobu, takiego jak projekt
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Przypuszczam, 偶e uprawnienie **`cloudasset.assets.queryIamPolicy`** r贸wnie偶 mo偶e umo偶liwia znalezienie uprawnie podmiot贸w
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### Testowanie uprawnie IamPermissions

{% hint style="danger" %}
Jeli **nie mo偶esz uzyska dostpu do informacji IAM** za pomoc poprzednich metod i jeste w Red Team, mo偶esz **u偶y narzdzia** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **do brutalnego testowania Twoich obecnych uprawnie.**

Nale偶y jednak pamita, 偶e usuga **`cloudresourcemanager.googleapis.com`** musi by wczona.
{% endhint %}

### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnie IAM w celu eskalacji uprawnie**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniona enumeracja <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Trwao

Jeli masz wysokie uprawnienia, mo偶esz:

* Tworzy nowe SA (lub u偶ytkownik贸w, jeli jeste w Workspace)
* Przypisywa podmiotom kontrolowanym przez siebie wicej uprawnie
* Przyznawa wicej uprawnie podatnym SA (SSRF w vm, podatna funkcja Cloud...)
* ...

## Polityki organizacyjne

Aby uzyska wprowadzenie do tego, czym s polityki organizacyjne, sprawd藕:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

Polityki IAM wskazuj, jakie uprawnienia maj podmioty do zasob贸w za pomoc r贸l, kt贸re przypisuj szczeg贸owe uprawnienia. Polityki organizacyjne **ograniczaj spos贸b korzystania z tych usug lub wyczaj okrelone funkcje**. Pomaga to poprawi zasad najmniejszych uprawnie dla ka偶dego zasobu w rodowisku GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia polityk organizacyjnych do eskalacji uprawnie**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}
