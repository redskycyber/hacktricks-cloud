# GCP - Enumeraci贸n de IAM, Ppals y Pol铆ticas de Org

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cuentas de servicio

Para una introducci贸n sobre qu茅 es una cuenta de servicio, consulte:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeraci贸n

Una cuenta de servicio siempre pertenece a un proyecto:

```bash
gcloud iam service-accounts list --project <project>
```

## Usuarios y grupos

Para una introducci贸n sobre c贸mo funcionan los usuarios y grupos en GCP, consulte:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeraci贸n

Con los permisos **`serviceusage.services.enable`** y **`serviceusage.services.use`** es posible **habilitar servicios** en un proyecto y usarlos.

Si puede **habilitar el servicio `admin`** y si su usuario tiene **suficientes privilegios en el espacio de trabajo**, podr铆a **enumerar todos los grupos y usuarios** con las siguientes l铆neas.\
Incluso si dice **`identity groups`**, tambi茅n devuelve **usuarios sin ning煤n grupo**:

```bash
# Habilitar admin
gcloud services enable admin.googleapis.com
# Listar todos los usuarios y grupos
gcloud organizations list #El DIRECTORY_CUSTOMER_ID es el ID del espacio de trabajo
gcloud beta identity groups preview --customer <workspace-id>
## Miembros del grupo
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```

Incluso con el servicio de administrador habilitado, es posible que obtenga un error al enumerarlos porque el usuario de su espacio de trabajo comprometido no tiene suficientes permisos:

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Si puede habilitar el servicio **`cloudidentity.googleapli.com`** si est谩 deshabilitado, podr铆a usarlo para **enumerar grupos** (como se hace en PurplePanda en [aqu铆](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)):

```
gcloud services enable cloudidentity.googleapis.com
```

## IAM

Consulte [**esto para obtener informaci贸n b谩sica sobre IAM**](../gcp-basic-information.md#iam-roles).

### Permisos predeterminados

De los [**documentos**](https://cloud.google.com/resource-manager/docs/default-access-control): Cuando se crea un recurso de organizaci贸n, todos los usuarios de su dominio reciben los roles de **Creador de cuenta de facturaci贸n** y **Creador de proyecto** de forma predeterminada. Estos roles predeterminados permiten que sus usuarios comiencen a usar Google Cloud de inmediato, pero no est谩n destinados a su uso en la operaci贸n regular de su recurso de organizaci贸n.

Estos **roles** otorgan los **permisos**:

* `billing.accounts.create` y `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` y `resourcemanager.projects.create`

{% hint style="danger" %}
El privilegio m谩s alto en una organizaci贸n de GCP es el rol de **Administrador de organizaci贸n**.
{% endhint %}

### Enumeraci贸n

```bash
# Roles
## Listar roles
gcloud iam roles list --project $PROJECT_ID # Listar solo roles personalizados
gcloud iam roles list --filter='etag:AA=='

## Obtener permisos y descripci贸n del rol
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Pol铆ticas
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Permisos probables en el recurso
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Roles otorgables a un recurso
gcloud iam list-grantable-roles <project URL>
```

#### Enumeraci贸n a trav茅s de cloudasset

Existen diferentes formas de verificar todos los permisos de un usuario en diferentes recursos (como organizaciones, carpetas, proyectos...) utilizando este servicio.

* El permiso **`cloudasset.assets.searchAllIamPolicies`** puede solicitar **todas las pol铆ticas de IAM** dentro de un recurso.

```bash
gcloud asset search-all-iam-policies #Por defecto utiliza la carpeta configurada actualmente
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```

* El permiso **`cloudasset.assets.analyzeIamPolicy`** puede solicitar **todas las pol铆ticas de IAM** de un principal dentro de un recurso.

```bash
# Necesita permiso "cloudasset.assets.analyzeIamPolicy" sobre el recurso
gcloud asset analyze-iam-policy --organization=<org-id> \
            --identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
            --identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
            --identity='user:carlos.polop@hacktricks.xyz'
```

* El permiso **`cloudasset.assets.searchAllResources`** permite listar todos los recursos de una organizaci贸n, carpeta o proyecto. Recursos relacionados con IAM (como roles) incluidos.

```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```

* El permiso **`cloudasset.assets.analyzeMove`** pero puede ser 煤til para recuperar tambi茅n pol铆ticas que afectan a un recurso como un proyecto

```bash
gcloud asset analyze-move --project=<proj-name> \
          --destination-organization=609216679593
```

* Supongo que el permiso **`cloudasset.assets.queryIamPolicy`** tambi茅n podr铆a dar
### Privesc

En la siguiente p谩gina puedes ver c贸mo **abusar de los permisos de las pol铆ticas de organizaci贸n para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>