# GCP - IAM, Principals & Org Policies Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬** [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) **ë˜ëŠ”** [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)**ì— ê°€ì…í•˜ê±°ë‚˜**Twitter\*\* ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ íŒ”ë¡œìš°í•˜ì„¸ìš”\*\*.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## ì„œë¹„ìŠ¤ ê³„ì •

ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### ì—´ê±°

ì„œë¹„ìŠ¤ ê³„ì •ì€ í•­ìƒ í”„ë¡œì íŠ¸ì— ì†í•©ë‹ˆë‹¤:

```bash
gcloud iam service-accounts list --project <project>
```

## ì‚¬ìš©ì ë° ê·¸ë£¹

GCPì—ì„œ ì‚¬ìš©ì ë° ê·¸ë£¹ì´ ì‘ë™í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### ì—´ê±°

ê¶Œí•œ **`serviceusage.services.enable`** ë° \*\*`serviceusage.services.use`\*\*ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡œì íŠ¸ì—ì„œ **ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”**í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ê¸°ë³¸ì ìœ¼ë¡œ Workspace ì‚¬ìš©ìì—ê²ŒëŠ” **í”„ë¡œì íŠ¸ ìƒì„±ì** ì—­í• ì´ ë¶€ì—¬ë˜ì–´ **ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆëŠ” ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ í•´ë‹¹ í”„ë¡œì íŠ¸ì— ëŒ€í•œ **`owner`** ì—­í• ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **Workspaceì„ ì—´ê±°í•  ìˆ˜ ìˆë„ë¡ í”„ë¡œì íŠ¸ì—ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ **Workspaceì— ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆì–´ì•¼**í•©ë‹ˆë‹¤.
{% endhint %}

**`admin` ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”**í•  ìˆ˜ ìˆê³  ì‚¬ìš©ìê°€ **Workspaceì—ì„œ ì¶©ë¶„í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´**, ë‹¤ìŒ ë¼ì¸ì„ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ê·¸ë£¹ ë° ì‚¬ìš©ìë¥¼ ì—´ê±°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
\*\*`identity groups`\*\*ë¼ê³  ë‚˜ì™€ ìˆì§€ë§Œ **ê·¸ë£¹ ì—†ëŠ” ì‚¬ìš©ì**ë„ ë°˜í™˜ë©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
ì´ì „ ì˜ˆì œì—ì„œëŠ” ë§¤ê°œë³€ìˆ˜ `--labels`ê°€ í•„ìš”í•˜ë¯€ë¡œ ì¼ë°˜ì ì¸ ê°’ì´ ì‚¬ìš©ë©ë‹ˆë‹¤ (APIë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. [**ì—¬ê¸°ì—ì„œ PurplePandaê°€ ìˆ˜í–‰í•˜ëŠ” ê²ƒì²˜ëŸ¼**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

ê´€ë¦¬ ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆë”ë¼ë„, kompromised workspace ì‚¬ìš©ìê°€ ì¶©ë¶„í•œ ê¶Œí•œì„ ê°–ê³  ìˆì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—´ê±°í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

IAMì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ëŠ” [**ì—¬ê¸°ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤**](../gcp-basic-information/#iam-roles).

### ê¸°ë³¸ ê¶Œí•œ

[**ë¬¸ì„œ**](https://cloud.google.com/resource-manager/docs/default-access-control)ì— ë”°ë¥´ë©´, ì¡°ì§ ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ë„ë©”ì¸ì˜ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ **Billing Account Creator** ë° **Project Creator** ì—­í• ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê¸°ë³¸ ì—­í• ì„ í†µí•´ ì‚¬ìš©ìëŠ” Google Cloudë¥¼ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ ì¡°ì§ ë¦¬ì†ŒìŠ¤ì˜ ì •ê¸°ì ì¸ ìš´ì˜ì—ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ **ì—­í• **ì€ ë‹¤ìŒ **ê¶Œí•œ**ì„ ë¶€ì—¬í•©ë‹ˆë‹¤:

* `billing.accounts.create` ë° `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` ë° `resourcemanager.projects.create`

ë˜í•œ ì‚¬ìš©ìê°€ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ [ë¬¸ì„œ](https://cloud.google.com/resource-manager/docs/access-control-proj)ì— ë”°ë¼ í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ì†Œìœ ìê°€ ìë™ìœ¼ë¡œ ë¶€ì—¬ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  í•´ë‹¹ í”„ë¡œì íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë§ˆì´ë„ˆ? Workspace ì—´ê±°? ...)

{% hint style="danger" %}
GCP ì¡°ì§ì—ì„œ ê°€ì¥ ë†’ì€ ê¶Œí•œì€ **Organization Administrator** ì—­í• ì…ë‹ˆë‹¤.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

ëŒ€ë¶€ë¶„ì˜ ì„œë¹„ìŠ¤ì—ì„œëŠ” **`add-iam-policy-binding`** ë˜ëŠ” **`set-iam-policy`** ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ìš” ì°¨ì´ì ì€ **`add-iam-policy-binding`ì´ ê¸°ì¡´ IAM ì •ì±…ì— ìƒˆë¡œìš´ ì—­í•  ë°”ì¸ë”©ì„ ì¶”ê°€**í•˜ëŠ” ë°˜ë©´ \*\*`set-iam-policy`\*\*ì€ ì´ì „ì— ë¶€ì—¬ëœ ê¶Œí•œì„ **ì‚­ì œí•˜ê³ ** ëª…ë ¹ì–´ì—ì„œ ì§€ì •ëœ ê²ƒë§Œ **ì„¤ì •**í•©ë‹ˆë‹¤.

### ì—´ê±°

```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```

### cloudasset IAM ì—´ê±°

ì´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ëª¨ë“  ê¶Œí•œì„ ë‹¤ì–‘í•œ ë¦¬ì†ŒìŠ¤(ì¡°ì§, í´ë”, í”„ë¡œì íŠ¸ ë“±)ì—ì„œ í™•ì¸í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

* ê¶Œí•œ \*\*`cloudasset.assets.searchAllIamPolicies`\*\*ë¥¼ ì‚¬ìš©í•˜ë©´ ë¦¬ì†ŒìŠ¤ ë‚´ì˜ **ëª¨ë“  IAM ì •ì±…**ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```

* **`cloudasset.assets.analyzeIamPolicy`** ê¶Œí•œì€ ë¦¬ì†ŒìŠ¤ ë‚´ë¶€ ì£¼ì²´ì˜ **ëª¨ë“  IAM ì •ì±…**ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```

* **`cloudasset.assets.searchAllResources`** ê¶Œí•œì€ ì¡°ì§, í´ë” ë˜ëŠ” í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë‚˜ì—´í•˜ëŠ” ê²ƒì„ í—ˆìš©í•©ë‹ˆë‹¤. ì—­í• ê³¼ ê°™ì€ IAM ê´€ë ¨ ë¦¬ì†ŒìŠ¤ê°€ í¬í•¨ë©ë‹ˆë‹¤.

```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```

* **`cloudasset.assets.analyzeMove`** ê¶Œí•œì€ í”„ë¡œì íŠ¸ì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ì— ì˜í–¥ì„ ì£¼ëŠ” ì •ì±…ì„ ê²€ìƒ‰í•˜ëŠ” ë° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```

* ë‚˜ëŠ” ê¶Œí•œ \*\*`cloudasset.assets.queryIamPolicy`\*\*ë„ ì£¼ì²´ì˜ ê¶Œí•œì„ ì°¾ëŠ” ë° ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì„ ê²ƒì´ë¼ê³  ìƒê°í•©ë‹ˆë‹¤.

```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```

### testIamPermissions ì—´ê±°

{% hint style="danger" %}
ì´ì „ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ IAM ì •ë³´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ëŠ” ê²½ìš° Red Teamì— ì†í•´ ìˆë‹¤ë©´ í˜„ì¬ ê¶Œí•œì„ ë¸Œë£¨íŠ¸ í¬ìŠ¤í•  ìˆ˜ ìˆëŠ” [https://github.com/carlospolop/bf\_my\_gcp\_perms](https://github.com/carlospolop/bf\_my\_gcp\_perms) ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ `cloudresourcemanager.googleapis.com` ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### Privesc

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **IAM ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹**í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### ì¸ì¦ë˜ì§€ ì•Šì€ ì—´ê±° <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

ê³  ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìƒˆë¡œìš´ SAs ìƒì„± (ë˜ëŠ” Workspaceì˜ ê²½ìš° ì‚¬ìš©ì ìƒì„±)
* ìì²´ì ìœ¼ë¡œ ì œì–´í•˜ëŠ” ì£¼ì²´ì—ê²Œ ë” ë§ì€ ê¶Œí•œ ë¶€ì—¬
* ì·¨ì•½í•œ SAsì— ë” ë§ì€ ê¶Œí•œ ë¶€ì—¬ (vmì—ì„œ SSRF, ì·¨ì•½í•œ Cloud Function ë“±)
* ...

## Org Policies

Org Policiesì— ëŒ€í•œ ì†Œê°œëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAM ì •ì±…ì€ ì—­í• ì„ í†µí•´ ì£¼ì²´ê°€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ê°€ì§€ëŠ” ê¶Œí•œì„ ë‚˜íƒ€ë‚´ë©°, ì´ëŠ” ì„¸ë¶„í™”ëœ ê¶Œí•œì´ í• ë‹¹ë©ë‹ˆë‹¤. ì¡°ì§ ì •ì±…ì€ **ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì œí•œí•˜ê±°ë‚˜ ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•˜ëŠ” ê²ƒ**ì„ ì œí•œí•©ë‹ˆë‹¤. ì´ëŠ” GCP í™˜ê²½ì˜ ê° ë¦¬ì†ŒìŠ¤ì˜ ìµœì†Œ ê¶Œí•œì„ í–¥ìƒì‹œí‚¤ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```

### ê¶Œí•œ ìƒìŠ¹

ë‹¤ìŒ í˜ì´ì§€ì—ì„œ **ì¡°ì§ ì •ì±… ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹í•˜ëŠ” ë°©ë²•**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}
