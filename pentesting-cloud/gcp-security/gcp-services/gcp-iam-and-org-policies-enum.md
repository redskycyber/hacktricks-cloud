# GCP - IAMã€ä¸»ä½“å’Œç»„ç»‡ç­–ç•¥æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æœåŠ¡è´¦æˆ·

å…³äºæœåŠ¡è´¦æˆ·æ˜¯ä»€ä¹ˆçš„ä»‹ç»ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

æœåŠ¡è´¦æˆ·æ€»æ˜¯å±äºä¸€ä¸ªé¡¹ç›®ï¼š
```bash
gcloud iam service-accounts list --project <project>
```
## ç”¨æˆ·ä¸ç»„

æœ‰å…³ GCP ä¸­ç”¨æˆ·ä¸ç»„å·¥ä½œæ–¹å¼çš„ç®€ä»‹ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### æšä¸¾

æ‹¥æœ‰ **`serviceusage.services.enable`** å’Œ **`serviceusage.services.use`** æƒé™å¯ä»¥åœ¨é¡¹ç›®ä¸­**å¯ç”¨æœåŠ¡**å¹¶ä½¿ç”¨å®ƒä»¬ã€‚

å¦‚æœä½ èƒ½**å¯ç”¨ `admin` æœåŠ¡**ï¼Œå¹¶ä¸”ä½ çš„ç”¨æˆ·åœ¨ workspace ä¸­æ‹¥æœ‰**è¶³å¤Ÿçš„æƒé™**ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç **æšä¸¾æ‰€æœ‰ç»„å’Œç”¨æˆ·**ã€‚\
å³ä½¿å®ƒæ˜¾ç¤ºä¸º **`identity groups`**ï¼Œå®ƒä¹Ÿä¼šè¿”å›**æ²¡æœ‰ä»»ä½•ç»„çš„ç”¨æˆ·**ï¼š

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œå‚æ•° `--labels` æ˜¯å¿…éœ€çš„ï¼Œæ‰€ä»¥ä½¿ç”¨äº†ä¸€ä¸ªé€šç”¨å€¼ï¼ˆå¦‚æœä½ ç›´æ¥åƒ [**PurplePanda åœ¨è¿™é‡Œåšçš„**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py) é‚£æ ·ä½¿ç”¨ APIï¼Œå°±ä¸éœ€è¦è¿™ä¸ªå‚æ•°ï¼‰ã€‚
{% endhint %}

å³ä½¿å¯ç”¨äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œå¦‚æœä½ çš„å—æŸ Workspace ç”¨æˆ·æƒé™ä¸è¶³ï¼Œä½ åœ¨æšä¸¾æ—¶å¯èƒ½ä¼šé‡åˆ°é”™è¯¯ï¼š

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

æŸ¥çœ‹ [**è¿™é‡Œçš„åŸºç¡€ä¿¡æ¯å…³äº IAM**](../gcp-basic-information.md#iam-roles)ã€‚

### é»˜è®¤æƒé™

æ ¹æ® [**æ–‡æ¡£**](https://cloud.google.com/resource-manager/docs/default-access-control)ï¼šå½“åˆ›å»ºä¸€ä¸ªç»„ç»‡èµ„æºæ—¶ï¼Œé»˜è®¤ä¼šå‘ä½ çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·æˆäºˆ **Billing Account Creator** å’Œ **Project Creator** è§’è‰²ã€‚è¿™äº›é»˜è®¤è§’è‰²å…è®¸ä½ çš„ç”¨æˆ·ç«‹å³å¼€å§‹ä½¿ç”¨ Google Cloudï¼Œä½†ä¸é€‚ç”¨äºä½ çš„ç»„ç»‡èµ„æºçš„å¸¸è§„æ“ä½œã€‚

è¿™äº› **è§’è‰²** æˆäºˆ **æƒé™**ï¼š

* `billing.accounts.create` å’Œ `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` å’Œ `resourcemanager.projects.create`

{% hint style="danger" %}
åœ¨ GCP ç»„ç»‡ä¸­æœ€é«˜æƒé™æ˜¯ **Organization Administrator** è§’è‰²ã€‚
{% endhint %}

### æšä¸¾
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### é€šè¿‡ cloudasset æšä¸¾

ä½¿ç”¨è¿™é¡¹æœåŠ¡ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥æ£€æŸ¥ç”¨æˆ·åœ¨ä¸åŒèµ„æºï¼ˆå¦‚ç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ç­‰ï¼‰ä¸­çš„æ‰€æœ‰æƒé™ã€‚

* æƒé™ **`cloudasset.assets.searchAllIamPolicies`** å¯ä»¥è¯·æ±‚èµ„æºå†…çš„**æ‰€æœ‰ iam ç­–ç•¥**ã€‚
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeIamPolicy`** å¯ä»¥è¯·æ±‚èµ„æºå†…ä¸»ä½“çš„**æ‰€æœ‰iamç­–ç•¥**ã€‚
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* æƒé™ **`cloudasset.assets.searchAllResources`** å…è®¸åˆ—å‡ºç»„ç»‡ã€æ–‡ä»¶å¤¹æˆ–é¡¹ç›®çš„æ‰€æœ‰èµ„æºã€‚åŒ…æ‹¬ä¸IAMç›¸å…³çš„èµ„æºï¼ˆå¦‚è§’è‰²ï¼‰ã€‚
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeMove`** ä¹Ÿå¯èƒ½ç”¨äºæ£€ç´¢å½±å“èµ„æºï¼ˆå¦‚é¡¹ç›®ï¼‰çš„ç­–ç•¥
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* æˆ‘è®¤ä¸ºæƒé™ **`cloudasset.assets.queryIamPolicy`** ä¹Ÿå¯èƒ½å…è®¸æŸ¥æ‰¾ä¸»ä½“çš„æƒé™
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
å¦‚æœæ‚¨**æ— æ³•ä½¿ç”¨å‰è¿°æ–¹æ³•è®¿é—®IAMä¿¡æ¯**ï¼Œå¹¶ä¸”æ‚¨åœ¨çº¢é˜Ÿä¸­ã€‚æ‚¨å¯ä»¥**ä½¿ç”¨å·¥å…·** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **æ¥æš´åŠ›ç ´è§£æ‚¨å½“å‰çš„æƒé™ã€‚**
{% endhint %}

### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨IAMæƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### æœåŠ¡è´¦æˆ·æ¨¡æ‹Ÿ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

æ¨¡æ‹ŸæœåŠ¡è´¦æˆ·å¯ä»¥éå¸¸æœ‰ç”¨ï¼Œä»¥**è·å¾—æ–°çš„å’Œæ›´å¥½çš„æƒé™**ã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼[æ¨¡æ‹Ÿå¦ä¸€ä¸ªæœåŠ¡è´¦æˆ·](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)ï¼š

* ä½¿ç”¨**RSAç§é’¥**è®¤è¯ï¼ˆä¸Šæ–‡å·²è¦†ç›–ï¼‰
* ä½¿ç”¨**Cloud IAMç­–ç•¥**æˆæƒï¼ˆæ­¤å¤„è¦†ç›–ï¼‰
* **åœ¨GCPæœåŠ¡ä¸Šéƒ¨ç½²ä½œä¸š**ï¼ˆæ›´é€‚ç”¨äºç”¨æˆ·è´¦æˆ·çš„å¦¥åï¼‰

### æˆäºˆè®¿é—®ç®¡ç†æ§åˆ¶å°çš„æƒé™ <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

è®¿é—®[GCPç®¡ç†æ§åˆ¶å°](https://console.cloud.google.com)æ˜¯**æä¾›ç»™ç”¨æˆ·è´¦æˆ·ï¼Œè€Œä¸æ˜¯æœåŠ¡è´¦æˆ·**ã€‚è¦ç™»å½•åˆ°Webç•Œé¢ï¼Œæ‚¨å¯ä»¥**æˆäºˆæ‚¨æ§åˆ¶çš„Googleè´¦æˆ·è®¿é—®æƒé™**ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªé€šç”¨çš„"**@gmail.com**"è´¦æˆ·ï¼Œå®ƒ**ä¸å¿…æ˜¯ç›®æ ‡ç»„ç»‡çš„æˆå‘˜**ã€‚

ç„¶è€Œï¼Œè¦**æˆäºˆ**ä¸€ä¸ªé€šç”¨çš„"@gmail.com"è´¦æˆ·**Owner**çš„åŸå§‹è§’è‰²ï¼Œæ‚¨éœ€è¦**ä½¿ç”¨Webæ§åˆ¶å°**ã€‚å¦‚æœæ‚¨å°è¯•æˆäºˆé«˜äºç¼–è¾‘è€…çš„æƒé™ï¼Œ`gcloud`ä¼šæŠ¥é”™ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**æˆäºˆç”¨æˆ·å¯¹æ‚¨ç°æœ‰é¡¹ç›®çš„EditoråŸå§‹è§’è‰²**ï¼š
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
å¦‚æœæ‚¨åœ¨è¿™é‡ŒæˆåŠŸäº†ï¼Œå°è¯•**è®¿é—®ç½‘ç»œç•Œé¢**å¹¶ä»é‚£é‡Œæ¢ç´¢ã€‚

è¿™æ˜¯æ‚¨ä½¿ç”¨gcloudå·¥å…·å¯ä»¥åˆ†é…çš„**æœ€é«˜çº§åˆ«**ã€‚

## ç»„ç»‡ç­–ç•¥

è¦äº†è§£ç»„ç»‡ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMç­–ç•¥æŒ‡ç¤ºäº†ä¸»ä½“é€šè¿‡è§’è‰²å¯¹èµ„æºçš„æƒé™ï¼Œè¿™äº›è§’è‰²è¢«åˆ†é…äº†ç»†ç²’åº¦æƒé™ã€‚ç»„ç»‡ç­–ç•¥**é™åˆ¶äº†è¿™äº›æœåŠ¡çš„ä½¿ç”¨æ–¹å¼æˆ–å“ªäº›åŠŸèƒ½è¢«ç¦ç”¨**ã€‚è¿™æœ‰åŠ©äºæ”¹å–„GCPç¯å¢ƒä¸­æ¯ä¸ªèµ„æºçš„æœ€å°æƒé™ã€‚
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ç»„ç»‡ç­–ç•¥æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
