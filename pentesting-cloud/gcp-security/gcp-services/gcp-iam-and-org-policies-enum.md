# GCP - IAMã€ä¸»ä½“å’Œç»„ç»‡ç­–ç•¥æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æœåŠ¡è´¦å·

æœ‰å…³æœåŠ¡è´¦å·çš„ç®€ä»‹ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### æšä¸¾

æœåŠ¡è´¦å·å§‹ç»ˆå±äºä¸€ä¸ªé¡¹ç›®ï¼š
```bash
gcloud iam service-accounts list --project <project>
```
## ç”¨æˆ·å’Œç”¨æˆ·ç»„

æœ‰å…³GCPä¸­ç”¨æˆ·å’Œç”¨æˆ·ç»„å¦‚ä½•å·¥ä½œçš„ç®€ä»‹ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### æšä¸¾

é€šè¿‡æƒé™**`serviceusage.services.enable`**å’Œ**`serviceusage.services.use`**ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­**å¯ç”¨æœåŠ¡**å¹¶ä½¿ç”¨å®ƒä»¬ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒWorkspaceç”¨æˆ·è¢«æˆäºˆ**é¡¹ç›®åˆ›å»ºè€…**è§’è‰²ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿ**åˆ›å»ºæ–°é¡¹ç›®**ã€‚å½“ç”¨æˆ·åˆ›å»ºé¡¹ç›®æ—¶ï¼Œä»–è¢«æˆäºˆè¯¥é¡¹ç›®çš„**`owner`**è§’è‰²ã€‚å› æ­¤ï¼Œä»–å¯ä»¥**åœ¨é¡¹ç›®ä¸Šå¯ç”¨è¿™äº›æœåŠ¡ä»¥èƒ½å¤Ÿæšä¸¾Workspace**ã€‚

ä½†è¯·æ³¨æ„ï¼Œè¿˜éœ€è¦åœ¨Workspaceä¸­å…·æœ‰**è¶³å¤Ÿçš„æƒé™**æ‰èƒ½è°ƒç”¨è¿™äº›APIã€‚
{% endhint %}

å¦‚æœæ‚¨å¯ä»¥**å¯ç”¨`admin`æœåŠ¡**ï¼Œå¹¶ä¸”æ‚¨çš„ç”¨æˆ·åœ¨Workspaceä¸­å…·æœ‰**è¶³å¤Ÿçš„ç‰¹æƒ**ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç **æšä¸¾æ‰€æœ‰ç”¨æˆ·ç»„å’Œç”¨æˆ·**ã€‚\
å³ä½¿å®ƒè¯´**`identity groups`**ï¼Œå®ƒä¹Ÿä¼šè¿”å›**æ²¡æœ‰ä»»ä½•ç»„çš„ç”¨æˆ·**ï¼š
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œå‚æ•°`--labels`æ˜¯å¿…éœ€çš„ï¼Œå› æ­¤ä½¿ç”¨äº†é€šç”¨å€¼ï¼ˆå¦‚æœæ‚¨ç›´æ¥ä½¿ç”¨APIï¼Œå¦‚[**PurplePanda åœ¨è¿™é‡Œæ‰€åšçš„**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)ï¼Œåˆ™ä¸éœ€è¦ï¼‰ã€‚
{% endhint %}

å³ä½¿å¯ç”¨äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œç”±äºæ‚¨å—æŸçš„ Workspace ç”¨æˆ·æƒé™ä¸è¶³ï¼Œå¯èƒ½ä¼šåœ¨æšä¸¾å®ƒä»¬æ—¶å‡ºç°é”™è¯¯ï¼š

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

æŸ¥çœ‹[**è¿™é‡Œæœ‰å…³ IAM çš„åŸºæœ¬ä¿¡æ¯**](../gcp-basic-information/#iam-roles)ã€‚

### é»˜è®¤æƒé™

æ ¹æ®[æ–‡æ¡£](https://cloud.google.com/resource-manager/docs/default-access-control)ï¼šåˆ›å»ºç»„ç»‡èµ„æºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·éƒ½è¢«æˆäºˆ**è®¡è´¹å¸æˆ·åˆ›å»ºè€…**å’Œ**é¡¹ç›®åˆ›å»ºè€…**è§’è‰²ã€‚è¿™äº›é»˜è®¤è§’è‰²å…è®¸æ‚¨çš„ç”¨æˆ·ç«‹å³å¼€å§‹ä½¿ç”¨ Google Cloudï¼Œä½†ä¸é€‚ç”¨äºæ‚¨ç»„ç»‡èµ„æºçš„å¸¸è§„æ“ä½œã€‚

è¿™äº›**è§’è‰²**æˆäºˆä»¥ä¸‹**æƒé™**ï¼š

* `billing.accounts.create` å’Œ `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` å’Œ `resourcemanager.projects.create`

æ­¤å¤–ï¼Œå½“ç”¨æˆ·åˆ›å»ºé¡¹ç›®æ—¶ï¼Œæ ¹æ®[æ–‡æ¡£](https://cloud.google.com/resource-manager/docs/access-control-proj)ï¼Œä»–å°†**è‡ªåŠ¨è¢«æˆäºˆè¯¥é¡¹ç›®çš„æ‰€æœ‰è€…**ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†èƒ½å¤Ÿåˆ›å»ºé¡¹ç›®å¹¶åœ¨å…¶ä¸Šè¿è¡Œä»»ä½•æœåŠ¡ï¼ˆçŸ¿å·¥ï¼ŸWorkspace æšä¸¾ï¼Ÿ...ï¼‰

{% hint style="danger" %}
GCP ç»„ç»‡ä¸­çš„æœ€é«˜ç‰¹æƒæ˜¯**ç»„ç»‡ç®¡ç†å‘˜**è§’è‰²ã€‚
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

åœ¨å¤§å¤šæ•°æœåŠ¡ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–¹æ³•**`add-iam-policy-binding`**æˆ–**`set-iam-policy`**æ›´æ”¹èµ„æºä¸Šçš„æƒé™ã€‚ä¸»è¦åŒºåˆ«åœ¨äº**`add-iam-policy-binding`ä¼šå‘ç°æœ‰ IAM ç­–ç•¥æ·»åŠ æ–°çš„è§’è‰²ç»‘å®š**ï¼Œè€Œ**`set-iam-policy`**å°†**åˆ é™¤å…ˆå‰**æˆäºˆçš„æƒé™ï¼Œå¹¶**ä»…è®¾ç½®**å‘½ä»¤ä¸­æŒ‡å®šçš„æƒé™ã€‚

### æšä¸¾
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAMæšä¸¾

æœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥ä½¿ç”¨æ­¤æœåŠ¡æ£€æŸ¥ç”¨æˆ·åœ¨ä¸åŒèµ„æºï¼ˆå¦‚ç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ç­‰ï¼‰ä¸­çš„æ‰€æœ‰æƒé™ã€‚

* æƒé™ **`cloudasset.assets.searchAllIamPolicies`** å¯ä»¥è¯·æ±‚èµ„æºå†…çš„ **æ‰€æœ‰iamç­–ç•¥**ã€‚
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* æƒé™ **`cloudasset.assets.analyzeIamPolicy`** å¯ä»¥è¯·æ±‚èµ„æºå†…ç‰¹å®šä¸»ä½“çš„**æ‰€æœ‰ IAM ç­–ç•¥**ã€‚
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* æƒé™ **`cloudasset.assets.searchAllResources`** å…è®¸åˆ—å‡ºç»„ç»‡ã€æ–‡ä»¶å¤¹æˆ–é¡¹ç›®çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ IAM ç›¸å…³èµ„æºï¼ˆå¦‚è§’è‰²ï¼‰ã€‚
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* æƒé™ **`cloudasset.assets.analyzeMove`** å¯èƒ½ä¹Ÿå¯¹æ£€ç´¢å½±å“é¡¹ç›®ç­‰èµ„æºçš„ç­–ç•¥æœ‰ç”¨
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* æˆ‘è®¤ä¸ºæƒé™ **`cloudasset.assets.queryIamPolicy`** ä¹Ÿå¯ä»¥è®¿é—®æŸ¥æ‰¾ä¸»ä½“æƒé™
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### æµ‹è¯•IamPermissionsæšä¸¾

{% hint style="danger" %}
å¦‚æœæ‚¨æ— æ³•ä½¿ç”¨å…ˆå‰çš„æ–¹æ³•è®¿é—®IAMä¿¡æ¯ï¼Œå¹¶ä¸”æ‚¨æ˜¯çº¢é˜Ÿæˆå‘˜ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[https://github.com/carlospolop/bf_my_gcp_perms](https://github.com/carlospolop/bf_my_gcp_perms)æ¥æš´åŠ›ç ´è§£æ‚¨å½“å‰çš„æƒé™ã€‚

ä½†è¯·æ³¨æ„ï¼Œéœ€è¦å¯ç”¨æœåŠ¡`cloudresourcemanager.googleapis.com`ã€‚
{% endhint %}

### ææƒ

æ‚¨å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•æ»¥ç”¨IAMæƒé™ä»¥æå‡ç‰¹æƒï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„æšä¸¾ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### åæœŸåˆ©ç”¨ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

å¦‚æœæ‚¨æ‹¥æœ‰é«˜æƒé™ï¼Œæ‚¨å¯ä»¥ï¼š

- åˆ›å»ºæ–°çš„SAï¼ˆæˆ–ç”¨æˆ·ï¼Œå¦‚æœåœ¨Workspaceä¸­ï¼‰
- ä¸ºè‡ªå·±æ§åˆ¶çš„ä¸»ä½“æä¾›æ›´å¤šæƒé™
- ä¸ºæ˜“å—æ”»å‡»çš„SAæä¾›æ›´å¤šç‰¹æƒï¼ˆvmä¸­çš„SSRFï¼Œvuln Cloud Functionç­‰ï¼‰
- ...

## ç»„ç»‡ç­–ç•¥

æœ‰å…³ç»„ç»‡ç­–ç•¥æ˜¯ä»€ä¹ˆçš„ç®€ä»‹ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

IAMç­–ç•¥æŒ‡ç¤ºäº†ä¸»ä½“é€šè¿‡è§’è‰²å¯¹èµ„æºæ‹¥æœ‰çš„æƒé™ï¼Œè¿™äº›è§’è‰²åˆ†é…äº†ç»†ç²’åº¦çš„æƒé™ã€‚ç»„ç»‡ç­–ç•¥é™åˆ¶äº†è¿™äº›æœåŠ¡çš„ä½¿ç”¨æ–¹å¼æˆ–ç¦ç”¨äº†å“ªäº›åŠŸèƒ½ã€‚è¿™æœ‰åŠ©äºæé«˜GCPç¯å¢ƒä¸­æ¯ä¸ªèµ„æºçš„æœ€å°ç‰¹æƒã€‚
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### ææƒ

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å¦‚ä½•**æ»¥ç”¨ç»„ç»‡ç­–ç•¥æƒé™æ¥æå‡ç‰¹æƒ**ï¼š

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}
