# GCP - IAM, Principali i Org politike Enumeracija

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Servisni Nalozi

Za uvod o tome 코ta je servisni nalog proverite:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeracija

Servisni nalog uvek pripada projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## Korisnici i grupe

Za uvod o tome kako korisnici i grupe funkcioni코u u GCP-u, pogledajte:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeracija

Sa dozvolama **`serviceusage.services.enable`** i **`serviceusage.services.use`** mogu캖e je **omogu캖iti usluge** u projektu i koristiti ih.

{% hint style="danger" %}
Imajte na umu da su korisnicima Workspace-a po defaultu dodeljene uloge **Kreator projekta**, 코to im omogu캖ava pristup **kreiranju novih projekata**. Kada korisnik kreira projekat, dodeljena mu je uloga **`owner`** nad njim. Dakle, on mo쬰 **omogu캖iti ove usluge nad projektom kako bi mogao da enumeri코e Workspace**.

Me캠utim, primetite da je tako캠e potrebno imati **dovoljno dozvola u Workspace-u** kako biste mogli da pozovete ove API-je.
{% endhint %}

Ako mo쬰te **omogu캖iti uslugu `admin`** i ako va코 korisnik ima **dovoljno privilegija u Workspace-u**, mo쬰te **enumerisati sve grupe i korisnike** sa slede캖im linijama.\
캛ak i ako ka쬰 **`identity groups`**, vra캖a i **korisnike bez ikakvih grupa**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
U prethodnim primerima parametar `--labels` je obavezan, pa se koristi generi캜ka vrednost (nije obavezan ako koristite API direktno kao 코to [**PurplePanda radi ovde**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

캛ak i sa omogu캖enom admin uslugom, mogu캖e je da dobijete gre코ku pri enumeraciji jer korisnik va코eg kompromitovanog radnog prostora nema dovoljno dozvola:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Proverite [**ovde osnovne informacije o IAM-u**](../gcp-basic-information.md#iam-roles).

### Podrazumevane dozvole

Prema [**dokumentaciji**](https://cloud.google.com/resource-manager/docs/default-access-control): Kada se kreira resurs organizacije, svi korisnici u va코em domenu automatski dobijaju uloge **Kreator ra캜una za naplatu** i **Kreator projekta**. Ove podrazumevane uloge omogu캖avaju korisnicima da odmah po캜nu koristiti Google Cloud, ali nisu namenjene za redovno kori코캖enje resursa organizacije.

Ove **uloge** dodeljuju **dozvole**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

Osim toga, kada korisnik kreira projekat, automatski mu se dodeljuje **vlasni코tvo nad tim projektom** prema [dokumentaciji](https://cloud.google.com/resource-manager/docs/access-control-proj). Prema tome, podrazumevano, korisnik 캖e mo캖i da kreira projekat i pokrene bilo koju uslugu na njemu (rudari? Enumeracija radnog prostora? ...)

{% hint style="danger" %}
Najvi코a privilegija u GCP organizaciji je uloga **Administrator organizacije**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

U ve캖ini usluga mo쬰te promeniti dozvole nad resursom koriste캖i metodu **`add-iam-policy-binding`** ili **`set-iam-policy`**. Glavna razlika je da **`add-iam-policy-binding` dodaje novu vezu uloge** postoje캖oj IAM politici dok 캖e **`set-iam-policy`** **obrisati prethodno** dodeljene dozvole i **postaviti samo one** koje su navedene u komandi.

### Enumeracija
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### Nabrojavanje putem cloudasset-a

Postoje razli캜iti na캜ini da se provere sve dozvole korisnika u razli캜itim resursima (kao 코to su organizacije, fascikle, projekti...) koriste캖i ovu uslugu.

* Dozvola **`cloudasset.assets.searchAllIamPolicies`** mo쬰 zahtevati **sve iam politike** unutar resursa.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Dozvola **`cloudasset.assets.analyzeIamPolicy`** mo쬰 zahtevati **sve IAM politike** principala unutar resursa.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Dozvola **`cloudasset.assets.searchAllResources`** omogu캖ava listanje svih resursa organizacije, fascikle ili projekta. Uklju캜eni su i resursi vezani za IAM (kao 코to su uloge).
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Dozvola **`cloudasset.assets.analyzeMove`** mo쬰 biti korisna i za dobijanje politika koje uti캜u na resurs kao 코to je projekat.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Pretpostavljam da dozvola **`cloudasset.assets.queryIamPolicy`** tako캠e mo쬰 omogu캖iti pristup pronala쬰nju dozvola principala.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Ako **ne mo쬰te pristupiti IAM informacijama** koriste캖i prethodne metode i nalazite se u Red Team-u, mo쬰te **koristiti alat** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **za brute-force va코ih trenutnih dozvola**.
{% endhint %}

### Privesc

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti IAM dozvole za eskalaciju privilegija**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Neautentifikovano Enumerisanje <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Eksploatacija <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Upornost

Ako imate visoke privilegije, mo쬰te:

* Kreirati nove servisne naloge (ili korisnike ako ste u Workspace-u)
* Dodeliti principale koje kontroli코ete vi코e dozvola
* Dodeliti vi코e privilegija ranjivim servisnim nalozima (SSRF u vm, ranjiva Cloud funkcija...)
* ...

## Org Politike

Za uvod o tome 코ta su Org Politike, pogledajte:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAM politike ukazuju na dozvole koje principali imaju nad resursima putem uloga, koje dodeljuju granularne dozvole. Org politike **ograni캜avaju na캜in na koji se te usluge mogu koristiti ili koje funkcionalnosti su onemogu캖ene**. Ovo poma쬰 u pobolj코anju najmanje privilegije svakog resursa u GCP okru쬰nju.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti dozvole org politika da biste pove캖ali privilegije**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
