# GCP - Bigquery Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

ë‹¤ë¥¸ HackTricks ì§€ì› ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud**ì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”
* github ì €ì¥ì†Œ.

</details>

## ê¸°ë³¸ ì •ë³´

Google Cloud BigQueryëŠ” **ì™„ì „ ê´€ë¦¬í˜•, ì„œë²„ë¦¬ìŠ¤ ì—”í„°í”„ë¼ì´ì¦ˆ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤**ë¡œ, **í˜íƒ€ë°”ì´íŠ¸ ë‹¨ìœ„ì˜ ë°ì´í„° ë¶„ì„** ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬ ëŒ€ê·œëª¨ ë°ì´í„°ì…‹ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. Platform as a Service (PaaS)ë¡œ, ìˆ˜ë™ ê°ì‹œ ì—†ì´ ë°ì´í„° ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•˜ëŠ” ì¸í”„ë¼ ë° ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ANSI SQL**ì„ ì‚¬ìš©í•œ ì¿¼ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì£¼ìš” ê°ì²´ëŠ” **ë°ì´í„°ë¥¼ í¬í•¨í•˜ëŠ” í…Œì´ë¸”ì„ í¬í•¨í•˜ëŠ” ë°ì´í„°ì…‹**ì…ë‹ˆë‹¤.

### ì•”í˜¸í™”

ê¸°ë³¸ì ìœ¼ë¡œ **Google ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤**ê°€ ì‚¬ìš©ë˜ì§€ë§Œ **ê³ ê° ê´€ë¦¬í˜• ì•”í˜¸í™” í‚¤ (CMEK)**ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ì´í„°ì…‹ ë° ë°ì´í„°ì…‹ ë‚´ í…Œì´ë¸” ë‹¹ ì•”í˜¸í™” í‚¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë§Œë£Œ

ë°ì´í„°ì…‹ì— **ë§Œë£Œ ì‹œê°„ì„ ì§€ì •**í•˜ì—¬ í•´ë‹¹ ë°ì´í„°ì…‹ì— ìƒì„±ëœ ìƒˆ í…Œì´ë¸”ì´ ìƒì„± í›„ ì§€ì •ëœ ì¼ ìˆ˜ í›„ **ìë™ìœ¼ë¡œ ì‚­ì œ**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì™¸ë¶€ ì†ŒìŠ¤

BigQueryëŠ” ë‹¤ë¥¸ Google ì„œë¹„ìŠ¤ì™€ ê¹Šê²Œ í†µí•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë²„í‚·, pub/sub, Google ë“œë¼ì´ë¸Œ, RDS ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°ì´í„°ì…‹ ACL

ë°ì´í„°ì…‹ì´ ìƒì„±ë˜ë©´ **ACLì´ ì²¨ë¶€**ë˜ì–´ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ë°ì´í„°ì…‹ì„ ë§Œë“  ì‚¬ìš©ìì—ê²Œ **ì†Œìœ ì** ê¶Œí•œì´ ë¶€ì—¬ë˜ë©° ê·¸ë£¹ **projectOwners** (í”„ë¡œì íŠ¸ ì†Œìœ ì), **projectWriters** ê·¸ë£¹ì— **ì‘ì„±ì** ê¶Œí•œì´ ë¶€ì—¬ë˜ê³  **projectReaders** ê·¸ë£¹ì— **ë¦¬ë”** ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤.
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### í…Œì´ë¸” í–‰ ì•¡ì„¸ìŠ¤ ì œì–´

**í–‰ ì•¡ì„¸ìŠ¤ ì •ì±…**ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ë‚´ì—ì„œ ì£¼ì²´ê°€ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” í–‰ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement)ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ë‚´ì—ì„œ ì •ì˜ë©ë‹ˆë‹¤.\
ì•¡ì„¸ìŠ¤ ì •ì±…ì€ í•„í„°ë¥¼ ì •ì˜í•˜ë©° í•´ë‹¹ í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” **í–‰ë§Œ** ì§€ì •ëœ ì£¼ì²´ê°€ **ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### ì—´ ì•¡ì„¸ìŠ¤ ì œì–´

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

ì—´ ìˆ˜ì¤€ì—ì„œ ë°ì´í„° ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´:

1. **ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ ì •ì˜**. ë°ì´í„°ë¥¼ ìœ„í•œ ë¶„ë¥˜ ì²´ê³„ ë° ì •ì±… íƒœê·¸ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. ì„ íƒ ì‚¬í•­: **ë°ì´í„° ì¹´íƒˆë¡œê·¸ ì„¸ë¶„í™”ëœ ë¦¬ë” ì—­í• ì„ í•˜ë‚˜ ì´ìƒì˜ ì£¼ì²´ì—ê²Œ ë¶€ì—¬**í•˜ì‹­ì‹œì˜¤. ë§Œë“  ì •ì±… íƒœê·¸ ì¤‘ í•˜ë‚˜ ì´ìƒì— ëŒ€í•´.
3. **BigQuery ì—´ì— ì •ì±… íƒœê·¸ í• ë‹¹**. BigQueryì—ì„œ ìŠ¤í‚¤ë§ˆ ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ëŠ” ê° ì—´ì— ì •ì±… íƒœê·¸ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
4. **ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ ê°•ì œ**. ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•˜ë©´ ë¶„ë¥˜ ì²´ê³„ì˜ ëª¨ë“  ì •ì±… íƒœê·¸ì— ëŒ€í•´ ì •ì˜ëœ ì•¡ì„¸ìŠ¤ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤.
5. **ì •ì±… íƒœê·¸ì—ì„œ ì•¡ì„¸ìŠ¤ ê´€ë¦¬**. [Identity and Access Management](https://cloud.google.com/iam) (IAM) ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ ê° ì •ì±… íƒœê·¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•©ë‹ˆë‹¤. ì •ì±…ì€ ì •ì±… íƒœê·¸ì— ì†í•˜ëŠ” ê° ì—´ì— ëŒ€í•´ ì ìš©ë©ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ì¿¼ë¦¬ ì‹œê°„ì— ì—´ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ, BigQueryëŠ” **ì—´ ì •ì±… íƒœê·¸ ë° í•´ë‹¹ ì •ì±…ì„ í™•ì¸í•˜ì—¬ ì‚¬ìš©ìê°€ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤**.

{% hint style="success" %}
ìš”ì•½í•˜ë©´, íŠ¹ì • ì‚¬ìš©ìë“¤ì—ê²Œ íŠ¹ì • ì—´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ë ¤ë©´ **ìŠ¤í‚¤ë§ˆì˜ ì—´ì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ê³  ì‚¬ìš©ìì˜ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œ**í•˜ì—¬ íƒœê·¸ì˜ ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ë¶„ë¥˜ ì²´ê³„ì—ì„œ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ê°•ì œí•˜ë ¤ë©´ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ì—´ì˜ íƒœê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### ì—´ê±°

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQL Injection

[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)

### Privilege Escalation & Post Exploitation

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## References

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>ì œë¡œë¶€í„° ì˜ì›…ì´ ë  ë•Œê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud**ì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”
* github ì €ì¥ì†Œ.

</details>
