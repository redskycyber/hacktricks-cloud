# GCP - Bigquery æšä¸¾

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**
* &#x20;githubä»“åº“ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Google Cloud BigQuery æ˜¯ä¸€ä¸ª **å®Œå…¨æ‰˜ç®¡çš„ï¼Œæ— æœåŠ¡å™¨çš„ä¼ä¸šæ•°æ®ä»“åº“**ï¼Œèƒ½å¤Ÿå¯¹ **PBçº§åˆ«** çš„æ•°æ®è¿›è¡Œå¯æ‰©å±•çš„ **åˆ†æ**ã€‚å®ƒæ˜¯ä¸€ä¸ªæ”¯æŒ **ä½¿ç”¨ANSI SQLæŸ¥è¯¢** çš„å¹³å°å³æœåŠ¡ï¼ˆPaaSï¼‰ã€‚å®ƒè¿˜å†…ç½®äº†æœºå™¨å­¦ä¹ åŠŸèƒ½ï¼Œå¹¶ä¸å…¶ä»–Google CloudæœåŠ¡é«˜åº¦é›†æˆã€‚

### åŠ å¯†

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ **Googleç®¡ç†çš„åŠ å¯†å¯†é’¥**ï¼Œå°½ç®¡å¯ä»¥é…ç½® **å®¢æˆ·ç®¡ç†çš„åŠ å¯†å¯†é’¥ï¼ˆCMEKï¼‰**ã€‚å¯ä»¥æŒ‡å®šæ¯ä¸ªæ•°æ®é›†å’Œæ•°æ®é›†å†…æ¯ä¸ªè¡¨çš„åŠ å¯†å¯†é’¥ã€‚

### è¿‡æœŸ

å¯ä»¥åœ¨ **æ•°æ®é›†ä¸­æŒ‡å®šè¿‡æœŸæ—¶é—´**ï¼Œå› æ­¤åœ¨æ­¤æ•°æ®é›†ä¸­åˆ›å»ºçš„ä»»ä½•æ–°è¡¨éƒ½ä¼šåœ¨åˆ›å»ºåæŒ‡å®šçš„å¤©æ•° **è‡ªåŠ¨åˆ é™¤**ã€‚

### å¤–éƒ¨æ¥æº

Bigqueryä¸å…¶ä»–GoogleæœåŠ¡æ·±åº¦é›†æˆã€‚å¯ä»¥ä»å­˜å‚¨æ¡¶ã€pub/subã€google driveã€RDSæ•°æ®åº“ç­‰åŠ è½½æ•°æ®...

### æ•°æ®é›†ACLs

åˆ›å»ºæ•°æ®é›†æ—¶ä¼š **é™„åŠ ACLs** ä»¥æˆäºˆå…¶è®¿é—®æƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®é›†çš„ **åˆ›å»ºè€…** è¢«èµ‹äºˆ **Owner** æƒé™ï¼Œç„¶åé¡¹ç›®çš„ **projectOwners** ç»„ï¼ˆé¡¹ç›®æ‰€æœ‰è€…ï¼‰è¢«èµ‹äºˆ **Owner**ï¼Œ**projectWriters** ç»„è¢«èµ‹äºˆ **Writer**ï¼Œ**projectReaders** ç»„è¢«èµ‹äºˆ **Reader**ï¼š
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### è¡¨è¡Œæ§åˆ¶è®¿é—®

å¯ä»¥é€šè¿‡è¡Œè®¿é—®ç­–ç•¥**æ§åˆ¶ä¸»ä½“å°†èƒ½å¤Ÿè®¿é—®è¡¨å†…çš„å“ªäº›è¡Œ**ã€‚è¿™äº›ç­–ç•¥æ˜¯åœ¨è¡¨å†…ä½¿ç”¨[**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_row_access_policy_statement)å®šä¹‰çš„ã€‚\
è®¿é—®ç­–ç•¥å®šä¹‰äº†ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œ**åªæœ‰ä¸è¯¥è¿‡æ»¤å™¨åŒ¹é…çš„è¡Œ**å°†å¯¹æŒ‡å®šçš„ä¸»ä½“**å¯è®¿é—®**ã€‚
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### åˆ—è®¿é—®æ§åˆ¶

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

è¦åœ¨åˆ—çº§åˆ«é™åˆ¶æ•°æ®è®¿é—®ï¼š

1. **å®šä¹‰åˆ†ç±»æ³•å’Œç­–ç•¥æ ‡ç­¾**ã€‚ä¸ºæ‚¨çš„æ•°æ®åˆ›å»ºå’Œç®¡ç†ä¸€ä¸ªåˆ†ç±»æ³•å’Œç­–ç•¥æ ‡ç­¾ã€‚[https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. å¯é€‰ï¼šåœ¨æ‚¨åˆ›å»ºçš„ä¸€ä¸ªæˆ–å¤šä¸ªç­–ç•¥æ ‡ç­¾ä¸Šï¼Œä¸ºä¸€ä¸ªæˆ–å¤šä¸ªä¸»ä½“æˆäºˆ **Data Catalog Fine-Grained Reader è§’è‰²**ã€‚
3. **å°†ç­–ç•¥æ ‡ç­¾åˆ†é…ç»™æ‚¨çš„ BigQuery åˆ—**ã€‚åœ¨ BigQuery ä¸­ï¼Œä½¿ç”¨æ¨¡å¼æ³¨é‡Šä¸ºæ‚¨æƒ³è¦é™åˆ¶è®¿é—®çš„æ¯ä¸ªåˆ—åˆ†é…ä¸€ä¸ªç­–ç•¥æ ‡ç­¾ã€‚
4. **å¯¹åˆ†ç±»æ³•æ‰§è¡Œè®¿é—®æ§åˆ¶**ã€‚æ‰§è¡Œè®¿é—®æ§åˆ¶ä¼šå¯¼è‡´åˆ†ç±»æ³•ä¸­æ‰€æœ‰ç­–ç•¥æ ‡ç­¾å®šä¹‰çš„è®¿é—®é™åˆ¶è¢«åº”ç”¨ã€‚
5. **ç®¡ç†ç­–ç•¥æ ‡ç­¾ä¸Šçš„è®¿é—®**ã€‚ä½¿ç”¨ [Identity and Access Management](https://cloud.google.com/iam) (IAM) ç­–ç•¥æ¥é™åˆ¶å¯¹æ¯ä¸ªç­–ç•¥æ ‡ç­¾çš„è®¿é—®ã€‚è¯¥ç­–ç•¥å¯¹å±äºç­–ç•¥æ ‡ç­¾çš„æ¯ä¸ªåˆ—éƒ½æœ‰æ•ˆã€‚

å½“ç”¨æˆ·å°è¯•åœ¨æŸ¥è¯¢æ—¶è®¿é—®åˆ—æ•°æ®æ—¶ï¼ŒBigQuery **ä¼šæ£€æŸ¥åˆ—çš„ç­–ç•¥æ ‡ç­¾åŠå…¶ç­–ç•¥ï¼Œä»¥ç¡®å®šç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æ•°æ®**ã€‚

{% hint style="success" %}
æ€»ç»“æ¥è¯´ï¼Œè¦é™åˆ¶æŸäº›ç”¨æˆ·å¯¹æŸäº›åˆ—çš„è®¿é—®ï¼Œæ‚¨å¯ä»¥ **åœ¨æ¨¡å¼ä¸­ä¸ºåˆ—æ·»åŠ æ ‡ç­¾å¹¶é™åˆ¶ç”¨æˆ·å¯¹æ ‡ç­¾çš„è®¿é—®**ï¼Œé€šè¿‡å¯¹æ ‡ç­¾çš„åˆ†ç±»æ³•æ‰§è¡Œè®¿é—®æ§åˆ¶ã€‚
{% endhint %}

è¦å¯¹åˆ†ç±»æ³•æ‰§è¡Œè®¿é—®æ§åˆ¶ï¼Œéœ€è¦å¯ç”¨æœåŠ¡ï¼š
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
```bash
bq show --format=prettyjson [PROJECT_ID]:[DATASET].[TABLE] | jq '.schema.fields[] | select(.description != null) | {name, description}'
```
{% endcode %}

è¿™å¯ä»¥æŸ¥çœ‹å¸¦æœ‰æ ‡ç­¾çš„åˆ—ï¼š

{% code overflow="wrap" %}
```bash
bq show --format=prettyjson [PROJECT_ID]:[DATASET].[TABLE] | jq '.schema.fields[] | select(.description != null) | {name, description}'
```
{% endcode %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### æšä¸¾

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQL æ³¨å…¥

[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)

### æƒé™æå‡ & åæœŸåˆ©ç”¨

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* &#x20;github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
