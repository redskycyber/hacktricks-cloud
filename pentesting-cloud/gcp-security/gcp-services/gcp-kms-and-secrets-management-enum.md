# GCP - Administrador de Enumeraci贸n de KMS

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) es un repositorio para **almacenar claves criptogr谩ficas**, como las utilizadas para **cifrar y descifrar archivos sensibles**. Las claves individuales se almacenan en anillos de claves, y se pueden aplicar permisos granulares en cualquiera de los dos niveles.

Los anillos de claves de KMS se crean por **defecto como globales**, lo que significa que las claves dentro de ese anillo de claves son accesibles desde cualquier regi贸n. Sin embargo, es posible crear anillos de claves espec铆ficos en **regiones espec铆ficas**.

### Nivel de Protecci贸n de la Clave

* **Claves de software**: Las claves de software son **creadas y gestionadas por KMS enteramente en software**. Estas claves **no est谩n protegidas por ning煤n m贸dulo de seguridad de hardware (HSM)** y pueden ser utilizadas para **prop贸sitos de prueba y desarrollo**. No se recomienda su uso en producci贸n porque ofrecen baja seguridad y son susceptibles a ataques.
* **Claves alojadas en la nube**: Las claves alojadas en la nube son **creadas y gestionadas por KMS** en la nube utilizando una infraestructura altamente disponible y confiable. Estas claves est谩n **protegidas por HSMs**, pero los HSMs **no est谩n dedicados a un cliente espec铆fico**. Las claves alojadas en la nube son adecuadas para la mayor铆a de los casos de uso en producci贸n.
* **Claves externas**: Las claves externas son **creadas y gestionadas fuera de KMS**, y se importan a KMS para su uso en operaciones criptogr谩ficas. Las claves externas **pueden almacenarse en un m贸dulo de seguridad de hardware (HSM) o en una biblioteca de software, dependiendo de la preferencia del cliente**.

### Prop贸sitos de la Clave

* **Cifrado/descifrado sim茅trico**: Se utiliza para **cifrar y descifrar datos usando una sola clave para ambas operaciones**. Las claves sim茅tricas son r谩pidas y eficientes para cifrar y descifrar grandes vol煤menes de datos.
* **Soportado**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **Firma Asim茅trica**: Utilizada para la comunicaci贸n segura entre dos partes sin compartir la clave. Las claves asim茅tricas vienen en un par, consistiendo en una **clave p煤blica y una clave privada**. La clave p煤blica se comparte con otros, mientras que la clave privada se mantiene en secreto.
* **Soportado:** [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Descifrado Asim茅trico**: Utilizado para verificar la autenticidad de un mensaje o datos. Se crea una firma digital utilizando una clave privada y se puede verificar utilizando la clave p煤blica correspondiente.
* **Soportado:** [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Firma MAC**: Utilizada para asegurar la **integridad y autenticidad de los datos creando un c贸digo de autenticaci贸n de mensaje (MAC) usando una clave secreta**. HMAC es com煤nmente utilizado para la autenticaci贸n de mensajes en protocolos de red y aplicaciones de software.
* **Soportado:** [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Periodo de Rotaci贸n & Periodo Programado para Destrucci贸n

Por **defecto**, cada **90 d铆as** pero puede ser **f谩cilmente** y **completamente personalizado**.

El periodo "Programado para destrucci贸n" es el **tiempo desde que el usuario solicita la eliminaci贸n de la clave** hasta que la clave es **eliminada**. No se puede cambiar despu茅s de que la clave es creada (por defecto 1 d铆a).

### Enumeraci贸n

Teniendo **permisos para listar las claves** as铆 es como puedes acceder a ellas:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### Escalaci贸n de Privilegios

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
