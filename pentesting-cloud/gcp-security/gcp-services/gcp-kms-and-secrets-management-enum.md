# GCP - KMS ç®¡ç†å‘˜æšä¸¾

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) æ˜¯ä¸€ä¸ªç”¨äº**å­˜å‚¨åŠ å¯†å¯†é’¥**çš„å­˜å‚¨åº“ï¼Œä¾‹å¦‚ç”¨äº**åŠ å¯†å’Œè§£å¯†æ•æ„Ÿæ–‡ä»¶**çš„å¯†é’¥ã€‚å•ä¸ªå¯†é’¥å­˜å‚¨åœ¨å¯†é’¥ç¯ä¸­ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•çº§åˆ«åº”ç”¨ç»†ç²’åº¦æƒé™ã€‚

KMS å¯†é’¥ç¯é»˜è®¤ä¸ºå…¨å±€åˆ›å»ºï¼Œè¿™æ„å‘³ç€è¯¥å¯†é’¥ç¯ä¸­çš„å¯†é’¥å¯ä»¥ä»ä»»ä½•åŒºåŸŸè®¿é—®ã€‚ä½†æ˜¯ï¼Œå¯ä»¥åœ¨ç‰¹å®šåŒºåŸŸåˆ›å»ºç‰¹å®šçš„å¯†é’¥ç¯ã€‚

### å¯†é’¥ä¿æŠ¤çº§åˆ«

* **è½¯ä»¶å¯†é’¥**ï¼šè½¯ä»¶å¯†é’¥å®Œå…¨ç”± KMS åœ¨è½¯ä»¶ä¸­åˆ›å»ºå’Œç®¡ç†ã€‚è¿™äº›å¯†é’¥**ä¸å—ä»»ä½•ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) ä¿æŠ¤**ï¼Œå¯ä»¥ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„ã€‚ç”±äºæä¾›çš„å®‰å…¨æ€§è¾ƒä½ä¸”å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è½¯ä»¶å¯†é’¥ã€‚
* **äº‘æ‰˜ç®¡å¯†é’¥**ï¼šäº‘æ‰˜ç®¡å¯†é’¥ç”± KMS åœ¨äº‘ä¸­ä½¿ç”¨é«˜å¯ç”¨æ€§å’Œå¯é æ€§çš„åŸºç¡€è®¾æ–½åˆ›å»ºå’Œç®¡ç†ã€‚è¿™äº›å¯†é’¥å—åˆ° HSM çš„ä¿æŠ¤ï¼Œä½† HSM å¹¶ä¸ä¸“é—¨ä¸ºç‰¹å®šå®¢æˆ·è€Œè®¾ã€‚äº‘æ‰˜ç®¡å¯†é’¥é€‚ç”¨äºå¤§å¤šæ•°ç”Ÿäº§ç”¨ä¾‹ã€‚
* **å¤–éƒ¨å¯†é’¥**ï¼šå¤–éƒ¨å¯†é’¥åœ¨ KMS ä¹‹å¤–åˆ›å»ºå’Œç®¡ç†ï¼Œå¹¶å¯¼å…¥åˆ° KMS ç”¨äºåŠ å¯†æ“ä½œã€‚å¤–éƒ¨å¯†é’¥å¯ä»¥å­˜å‚¨åœ¨ç¡¬ä»¶å®‰å…¨æ¨¡å— (HSM) æˆ–è½¯ä»¶åº“ä¸­ï¼Œå…·ä½“å–å†³äºå®¢æˆ·çš„åå¥½ã€‚

### å¯†é’¥ç”¨é€”

* **å¯¹ç§°åŠ å¯†/è§£å¯†**ï¼šç”¨äºä½¿ç”¨å•ä¸ªå¯†é’¥è¿›è¡Œæ•°æ®åŠ å¯†å’Œè§£å¯†çš„æ“ä½œã€‚å¯¹ç§°å¯†é’¥é€‚ç”¨äºåŠ å¯†å’Œè§£å¯†å¤§é‡æ•°æ®çš„å¿«é€Ÿé«˜æ•ˆæ“ä½œã€‚
* **æ”¯æŒçš„æ“ä½œ**ï¼š[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt)ï¼Œ[cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **éå¯¹ç§°ç­¾å**ï¼šç”¨äºä¸¤ä¸ªå‚ä¸æ–¹ä¹‹é—´çš„å®‰å…¨é€šä¿¡ï¼Œè€Œæ— éœ€å…±äº«å¯†é’¥ã€‚éå¯¹ç§°å¯†é’¥ç”±ä¸€å¯¹å…¬é’¥å’Œç§é’¥ç»„æˆã€‚å…¬é’¥ä¸ä»–äººå…±äº«ï¼Œè€Œç§é’¥ä¿å¯†ã€‚
* **æ”¯æŒçš„æ“ä½œ**ï¼š[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign)ï¼Œ[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **éå¯¹ç§°è§£å¯†**ï¼šç”¨äºéªŒè¯æ¶ˆæ¯æˆ–æ•°æ®çš„çœŸå®æ€§ã€‚ä½¿ç”¨ç§é’¥åˆ›å»ºæ•°å­—ç­¾åï¼Œå¯ä»¥ä½¿ç”¨ç›¸åº”çš„å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚
* **æ”¯æŒçš„æ“ä½œ**ï¼š[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt)ï¼Œ[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC ç­¾å**ï¼šä½¿ç”¨ç§˜å¯†å¯†é’¥åˆ›å»ºæ¶ˆæ¯è®¤è¯ç  (MAC) æ¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚HMAC åœ¨ç½‘ç»œåè®®å’Œè½¯ä»¶åº”ç”¨ç¨‹åºä¸­å¸¸ç”¨äºæ¶ˆæ¯è®¤è¯ã€‚
* **æ”¯æŒçš„æ“ä½œ**ï¼š[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign)ï¼Œ[cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### æ—‹è½¬å‘¨æœŸå’Œé”€æ¯è®¡åˆ’å‘¨æœŸ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¯†é’¥çš„æ—‹è½¬å‘¨æœŸä¸º**90å¤©**ï¼Œä½†å¯ä»¥**è½»æ¾**å’Œ**å®Œå…¨è‡ªå®šä¹‰**ã€‚

"é”€æ¯è®¡åˆ’"å‘¨æœŸæ˜¯ç”¨æˆ·è¦æ±‚åˆ é™¤å¯†é’¥çš„æ—¶é—´ï¼Œç›´åˆ°å¯†é’¥è¢«åˆ é™¤ä¸ºæ­¢ã€‚åœ¨å¯†é’¥åˆ›å»ºåæ— æ³•æ›´æ”¹ï¼ˆé»˜è®¤ä¸º1å¤©ï¼‰ã€‚

### æšä¸¾

å¦‚æœ**å…·æœ‰åˆ—å‡ºå¯†é’¥çš„æƒé™**ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼è®¿é—®å®ƒä»¬ï¼š
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### ææƒ

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
