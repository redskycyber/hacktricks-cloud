# GCP - KMS Enum

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS

[**UsÅ‚uga zarzÄ…dzania kluczami**](https://cloud.google.com/kms/docs/) w chmurze (Cloud Key Management Service - KMS) sÅ‚uÅ¼y jako bezpieczne miejsce przechowywania **kluczy kryptograficznych**, ktÃ³re sÄ… niezbÄ™dne do operacji takich jak **szyfrowanie i deszyfrowanie danych**. Klucze te sÄ… zorganizowane w obrÄ™bie pierÅ›cieni kluczy, co umoÅ¼liwia strukturalne zarzÄ…dzanie nimi. Ponadto, kontrola dostÄ™pu moÅ¼e byÄ‡ precyzyjnie skonfigurowana, zarÃ³wno na poziomie indywidualnego klucza, jak i dla caÅ‚ego pierÅ›cienia kluczy, zapewniajÄ…c, Å¼e uprawnienia sÄ… dokÅ‚adnie dopasowane do wymagaÅ„ bezpieczeÅ„stwa.

PierÅ›cienie kluczy KMS sÄ… **domyÅ›lnie tworzone jako globalne**, co oznacza, Å¼e klucze wewnÄ…trz tego pierÅ›cienia kluczy sÄ… dostÄ™pne z dowolnego regionu. Jednak moÅ¼liwe jest tworzenie konkretnych pierÅ›cieni kluczy w **konkretnych regionach**.

### Poziom ochrony klucza

* **Klucze programowe**: Klucze programowe sÄ… **tworzone i zarzÄ…dzane w caÅ‚oÅ›ci przez KMS w oprogramowaniu**. Klucze te **nie sÄ… chronione przez Å¼adny moduÅ‚ zabezpieczeÅ„ sprzÄ™towych (HSM)** i mogÄ… byÄ‡ uÅ¼ywane do celÃ³w **testowych i rozwojowych**. Klucze programowe **nie sÄ… zalecane do uÅ¼ycia w produkcji**, poniewaÅ¼ zapewniajÄ… niskie bezpieczeÅ„stwo i sÄ… podatne na ataki.
* **Klucze hostowane w chmurze**: Klucze hostowane w chmurze sÄ… **tworzone i zarzÄ…dzane przez KMS** w chmurze za pomocÄ… infrastruktury o wysokiej dostÄ™pnoÅ›ci i niezawodnoÅ›ci. Klucze te sÄ… **chronione przez moduÅ‚y zabezpieczeÅ„ sprzÄ™towych (HSM)**, ale moduÅ‚y HSM **nie sÄ… dedykowane dla konkretnego klienta**. Klucze hostowane w chmurze sÄ… odpowiednie dla wiÄ™kszoÅ›ci przypadkÃ³w uÅ¼ycia w produkcji.
* **Klucze zewnÄ™trzne**: Klucze zewnÄ™trzne sÄ… **tworzone i zarzÄ…dzane poza KMS**, a nastÄ™pnie importowane do KMS w celu uÅ¼ycia w operacjach kryptograficznych. Klucze zewnÄ™trzne **mogÄ… byÄ‡ przechowywane w module zabezpieczeÅ„ sprzÄ™towych (HSM) lub bibliotece oprogramowania, w zaleÅ¼noÅ›ci od preferencji klienta**.

### Cele klucza

* **Szyfrowanie/deszyfrowanie symetryczne**: UÅ¼ywane do **szyfrowania i deszyfrowania danych za pomocÄ… jednego klucza dla obu operacji**. Klucze symetryczne sÄ… szybkie i wydajne w szyfrowaniu i deszyfrowaniu duÅ¼ych iloÅ›ci danych.
* **ObsÅ‚ugiwane**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **Podpisywanie asymetryczne**: UÅ¼ywane do bezpiecznej komunikacji miÄ™dzy dwiema stronami bez udostÄ™pniania klucza. Klucze asymetryczne skÅ‚adajÄ… siÄ™ z pary, skÅ‚adajÄ…cej siÄ™ z **klucza publicznego i klucza prywatnego**. Klucz publiczny jest udostÄ™pniany innym, podczas gdy klucz prywatny jest utrzymywany w tajemnicy.
* **ObsÅ‚ugiwane**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Deszyfrowanie asymetryczne**: UÅ¼ywane do weryfikacji autentycznoÅ›ci wiadomoÅ›ci lub danych. Podpis cyfrowy jest tworzony za pomocÄ… klucza prywatnego i moÅ¼e byÄ‡ zweryfikowany za pomocÄ… odpowiadajÄ…cego mu klucza publicznego.
* **ObsÅ‚ugiwane**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **Podpisywanie MAC**: UÅ¼ywane do zapewnienia **integralnoÅ›ci i autentycznoÅ›ci danych poprzez tworzenie kodu uwierzytelniajÄ…cego wiadomoÅ›Ä‡ (MAC) za pomocÄ… tajnego klucza**. HMAC jest powszechnie stosowany do uwierzytelniania wiadomoÅ›ci w protokoÅ‚ach sieciowych i aplikacjach oprogramowania.
* **ObsÅ‚ugiwane**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Okres rotacji i okres programowanego zniszczenia

DomyÅ›lnie wynosi **90 dni**, ale moÅ¼na go **Å‚atwo** i **caÅ‚kowicie dostosowaÄ‡**.

Okres "Programowany do zniszczenia" to **czas od momentu, gdy uÅ¼ytkownik poprosi o usuniÄ™cie klucza** do momentu, gdy klucz zostanie **usuniÄ™ty**. Nie moÅ¼na go zmieniÄ‡ po utworzeniu klucza (domyÅ›lnie 1 dzieÅ„).

### Wersja podstawowa

KaÅ¼dy klucz KMS moÅ¼e mieÄ‡ kilka wersji, z ktÃ³rych jedna musi byÄ‡ **domyÅ›lna**, ta zostanie uÅ¼yta, gdy **nie zostanie okreÅ›lona Å¼adna wersja podczas interakcji z kluczem KMS**.

### Wyliczanie

JeÅ›li masz **uprawnienia do listowania kluczy**, to jest sposÃ³b, w jaki moÅ¼esz do nich uzyskaÄ‡ dostÄ™p:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### Eskalacja uprawnieÅ„

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## Referencje

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
