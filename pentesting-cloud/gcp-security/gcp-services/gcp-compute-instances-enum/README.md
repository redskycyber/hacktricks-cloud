# GCP - Enumeracja Compute

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GCP VPC i Networking

Dowiedz siÄ™, jak to dziaÅ‚a w:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeracja

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Åatwo znajdziesz instancje obliczeniowe z otwartymi reguÅ‚ami zapory sieciowej za pomocÄ… [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancje obliczeniowe

To jest sposÃ³b, w jaki moÅ¼esz **uruchamiaÄ‡ wirtualne maszyny w GCP**. SprawdÅº tÄ™ stronÄ™, aby uzyskaÄ‡ wiÄ™cej informacji:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Wyliczanie
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Aby uzyskaÄ‡ wiÄ™cej informacji na temat **SSH** lub **modyfikacji metadanych** instancji w celu **zwiÄ™kszenia uprawnieÅ„**, sprawdÅº tÄ™ stronÄ™:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Eskalacja uprawnieÅ„

Na nastÄ™pnej stronie moÅ¼esz sprawdziÄ‡, jak **wykorzystaÄ‡ uprawnienia obliczeniowe do eskalacji uprawnieÅ„**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumeracja bez uwierzytelnienia

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### TrwaÅ‚oÅ›Ä‡

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Dzienniki konsoli szeregowej

Dzienniki konsoli szeregowej Compute Engine to funkcja, ktÃ³ra umoÅ¼liwia **wyÅ›wietlanie i diagnozowanie dziennikÃ³w uruchamiania i systemu operacyjnego** wirtualnych maszyn.

Dzienniki konsoli szeregowej zapewniajÄ… **niskopoziomowy widok procesu uruchamiania instancji**, w tym komunikaty jÄ…dra, skrypty init i inne zdarzenia systemowe, ktÃ³re wystÄ™pujÄ… podczas uruchamiania. MoÅ¼e to byÄ‡ przydatne do debugowania problemÃ³w z uruchamianiem, identyfikowania bÅ‚Ä™dÃ³w konfiguracji lub oprogramowania oraz rozwiÄ…zywania problemÃ³w z Å‚Ä…cznoÅ›ciÄ… sieciowÄ….

Te dzienniki **mogÄ… ujawniaÄ‡ poufne informacje** z dziennikÃ³w systemowych, ktÃ³rych niskoprzywilejowy uÅ¼ytkownik zwykle nie widzi, ale przy odpowiednich uprawnieniach IAM moÅ¼esz je odczytaÄ‡.

MoÅ¼esz uÅ¼yÄ‡ nastÄ™pujÄ…cej [komendy gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output), aby zapytaÄ‡ o dzienniki portu szeregowego (wymagane uprawnienie to `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## MenedÅ¼er konfiguracji systemu operacyjnego

MoÅ¼esz uÅ¼yÄ‡ usÅ‚ugi zarzÄ…dzania konfiguracjÄ… systemu operacyjnego do **wdroÅ¼enia, zapytania i utrzymania spÃ³jnych konfiguracji** (stanu docelowego i oprogramowania) dla twojej instancji maszyny wirtualnej (VM). W Compute Engine musisz uÅ¼yÄ‡ [polityk goÅ›cia](https://cloud.google.com/compute/docs/os-config-management#guest-policy), aby utrzymaÄ‡ spÃ³jne konfiguracje oprogramowania na VM.

Funkcja zarzÄ…dzania konfiguracjÄ… systemu operacyjnego umoÅ¼liwia definiowanie polityk konfiguracyjnych, ktÃ³re okreÅ›lajÄ…, jakie pakiety oprogramowania powinny byÄ‡ zainstalowane, jakie usÅ‚ugi powinny byÄ‡ wÅ‚Ä…czone, a jakie pliki lub konfiguracje powinny byÄ‡ obecne na twoich VM. MoÅ¼esz uÅ¼yÄ‡ deklaratywnego podejÅ›cia do zarzÄ…dzania konfiguracjÄ… oprogramowania twoich VM, co umoÅ¼liwia Å‚atwiejsze automatyzowanie i skalowanie procesu zarzÄ…dzania konfiguracjÄ….

To rÃ³wnieÅ¼ umoÅ¼liwia logowanie siÄ™ do instancji za pomocÄ… uprawnieÅ„ IAM, wiÄ™c jest bardzo **przydatne do podwyÅ¼szania uprawnieÅ„ i przechodzenia**.

{% hint style="warning" %}
Aby **wÅ‚Ä…czyÄ‡ os-config w caÅ‚ym projekcie lub na instancji**, wystarczy ustawiÄ‡ klucz **`enable-oslogin`** w metadanych na poziomie docelowym na **`true`**.\
Ponadto, moÅ¼na ustawiÄ‡ metadane **`enable-oslogin-2fa`** na **`true`**, aby wÅ‚Ä…czyÄ‡ 2FA.

Gdy wÅ‚Ä…czysz to podczas tworzenia instancji, klucze metadanych zostanÄ… automatycznie ustawione.
{% endhint %}

WiÄ™cej na temat **2FA w OS-config**, **dotyczy to tylko uÅ¼ytkownikÃ³w**, jeÅ›li jest to SA (tak jak SA obliczeniowy), nie bÄ™dzie wymagaÄ‡ niczego dodatkowego.

### Wyliczanie
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Obrazy

### Niestandardowe obrazy

Niestandardowe obrazy obliczeniowe mogÄ… zawieraÄ‡ poufne szczegÃ³Å‚y lub inne podatne konfiguracje, ktÃ³re moÅ¼na wykorzystaÄ‡.

Podczas tworzenia obrazu moÅ¼na wybraÄ‡ **3 rodzaje szyfrowania**: UÅ¼ywanie **zarzÄ…dzanego klucza Google** (domyÅ›lnie), klucza z **KMS** lub **surowego klucza** podanego przez klienta.

#### Wyliczanie

MoÅ¼esz zapytaÄ‡ o listÄ™ niestandardowych obrazÃ³w w projekcie za pomocÄ… poniÅ¼szej komendy:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

NastÄ™pnie moÅ¼esz [**eksportowaÄ‡**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **wirtualne dyski** z dowolnego obrazu w wielu formatach. PoniÅ¼sze polecenie eksportuje obraz `test-image` w formacie qcow2, umoÅ¼liwiajÄ…c pobranie pliku i zbudowanie maszyny wirtualnej lokalnie w celu dalszego badania:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacja uprawnieÅ„

SprawdÅº sekcjÄ™ eskalacji uprawnieÅ„ Compute Instances.

### Niestandardowe szablony instancji

[**Szablon instancji**](https://cloud.google.com/compute/docs/instance-templates/) **definiuje wÅ‚aÅ›ciwoÅ›ci instancji**, ktÃ³re pomagajÄ… w wdraÅ¼aniu spÃ³jnych konfiguracji. MogÄ… one zawieraÄ‡ te same rodzaje danych wraÅ¼liwych, co niestandardowe metadane dziaÅ‚ajÄ…cej instancji. MoÅ¼esz uÅ¼yÄ‡ nastÄ™pujÄ…cych poleceÅ„ do przeprowadzenia dochodzenia:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
MoÅ¼e byÄ‡ interesujÄ…ce dowiedzieÄ‡ siÄ™, jakie dyski sÄ… uÅ¼ywane do nowych obrazÃ³w, ale te szablony zazwyczaj nie zawierajÄ… poufnych informacji.

## Snapshoty

**Snapshoty to kopie zapasowe dyskÃ³w**. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e nie jest to to samo co klonowanie dysku (innÄ… dostÄ™pnÄ… funkcjÄ…).\
**Snapshot** bÄ™dzie uÅ¼ywaÅ‚ **tej samej metody szyfrowania co dysk**, z ktÃ³rego zostaÅ‚ utworzony.

### Wyliczanie
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Eskalacja uprawnieÅ„

SprawdÅº sekcjÄ™ eskalacji uprawnieÅ„ dla instancji Compute.

## OdwoÅ‚ania

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
