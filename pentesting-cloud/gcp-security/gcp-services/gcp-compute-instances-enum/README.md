# GCP - Enumerazione delle istanze di calcolo

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## GCP VPC e Networking

Scopri come funziona questo in:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumerazione

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

√à possibile trovare facilmente le istanze di calcolo con regole del firewall aperte con [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Istanze di calcolo

In questo modo √® possibile **eseguire macchine virtuali all'interno di GCP**. Controlla questa pagina per ulteriori informazioni:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumerazione
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Per ulteriori informazioni su come **SSH** o **modificare i metadati** di un'istanza per **aumentare i privilegi**, consulta questa pagina:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Aumento dei privilegi

Nella seguente pagina, puoi verificare come **abusare delle autorizzazioni di calcolo per aumentare i privilegi**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumerazione non autenticata

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Esploitation

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistenza

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Log della console seriale

I log della console seriale di Compute Engine sono una funzionalit√† che consente di **visualizzare e diagnosticare i log di avvio e del sistema operativo** delle istanze della macchina virtuale.

I log della console seriale forniscono una **visualizzazione a basso livello del processo di avvio dell'istanza**, inclusi i messaggi del kernel, gli script di inizializzazione e altri eventi di sistema che si verificano durante l'avvio. Questo pu√≤ essere utile per il debug dei problemi di avvio, l'individuazione di errori di configurazione o software o la risoluzione dei problemi di connettivit√† di rete.

Questi log **possono esporre informazioni sensibili** dai log di sistema che un utente con privilegi limitati potrebbe non vedere di solito, ma con le autorizzazioni IAM appropriate potresti essere in grado di leggerli.

Puoi utilizzare il seguente [comando gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) per interrogare i log della porta seriale (l'autorizzazione richiesta √® `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Gestore di configurazione del sistema operativo

Puoi utilizzare il servizio di gestione della configurazione del sistema operativo per **distribuire, interrogare e mantenere configurazioni coerenti** (stato desiderato e software) per la tua istanza di macchina virtuale (VM). Su Compute Engine, devi utilizzare le [politiche degli ospiti](https://cloud.google.com/compute/docs/os-config-management#guest-policy) per mantenere configurazioni software coerenti su una VM.

La funzionalit√† di gestione della configurazione del sistema operativo ti consente di definire politiche di configurazione che specificano quali pacchetti software devono essere installati, quali servizi devono essere abilitati e quali file o configurazioni devono essere presenti sulle tue VM. Puoi utilizzare un approccio dichiarativo per gestire la configurazione software delle tue VM, il che ti consente di automatizzare e scalare pi√π facilmente il processo di gestione della configurazione.

Ci√≤ consente anche di accedere alle istanze tramite autorizzazioni IAM, quindi √® molto **utile per l'elevazione dei privilegi e il pivotaggio**.

{% hint style="warning" %}
Per **abilitare os-config in un intero progetto o in un'istanza**, √® sufficiente impostare la chiave **metadata** **`enable-oslogin`** su **`true`** al livello desiderato.\
Inoltre, puoi impostare la metadata **`enable-oslogin-2fa`** su **`true`** per abilitare il 2FA.

Quando lo abiliti durante la creazione di un'istanza, le chiavi di metadata verranno impostate automaticamente.
{% endhint %}

Per saperne di pi√π sul **2FA in OS-config**, **si applica solo se l'utente √® un utente**, se √® un SA (come il SA di calcolo) non richieder√† nulla di extra.

### Enumerazione
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Immagini

### Immagini personalizzate

Le immagini personalizzate di calcolo possono contenere dettagli sensibili o altre configurazioni vulnerabili che √® possibile sfruttare.

Quando viene creata un'immagine, √® possibile scegliere 3 tipi di crittografia: utilizzando una chiave gestita da Google (predefinita), una chiave da KMS o una chiave grezza fornita dal client.

#### Enumerazione

√à possibile interrogare l'elenco delle immagini non standard in un progetto con il seguente comando:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Successivamente, √® possibile [**esportare**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **i dischi virtuali** da qualsiasi immagine in diversi formati. Il seguente comando esporter√† l'immagine `test-image` nel formato qcow2, consentendoti di scaricare il file e creare una VM localmente per ulteriori indagini:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalazione dei privilegi

Controlla la sezione di escalation dei privilegi delle istanze di calcolo.

### Modelli di istanze personalizzate

Un [**modello di istanza**](https://cloud.google.com/compute/docs/instance-templates/) **definisce le propriet√† dell'istanza** per aiutare a distribuire configurazioni coerenti. Questi possono contenere gli stessi tipi di dati sensibili presenti nei metadati personalizzati di un'istanza in esecuzione. Puoi utilizzare i seguenti comandi per indagare:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Potrebbe essere interessante sapere quale disco vengono utilizzate le nuove immagini, ma di solito questi modelli non contengono informazioni sensibili.

## Snapshot

Gli **snapshot sono backup dei dischi**. Nota che questo non √® lo stesso di clonare un disco (un'altra funzionalit√† disponibile).\
Lo **snapshot** utilizzer√† la **stessa crittografia del disco** da cui √® stato preso.

### Enumerazione
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalazione dei privilegi

Controlla la sezione di escalation dei privilegi delle istanze di calcolo.

## Riferimenti

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
