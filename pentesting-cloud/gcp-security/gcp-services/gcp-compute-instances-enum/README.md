# GCP - Enumera√ß√£o de Computa√ß√£o

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## GCP VPC & Networking

Saiba como isso funciona em:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Voc√™ pode facilmente encontrar inst√¢ncias de computa√ß√£o com regras de firewall abertas em [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Inst√¢ncias de Computa√ß√£o

Esta √© a maneira de **executar m√°quinas virtuais dentro do GCP.** Confira esta p√°gina para mais informa√ß√µes:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumera√ß√£o
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Para obter mais informa√ß√µes sobre como **SSH** ou **modificar os metadados** de uma inst√¢ncia para **escalar privil√©gios**, consulte esta p√°gina:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escala√ß√£o de Privil√©gios

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes de computa√ß√£o para escalar privil√©gios**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumera√ß√£o N√£o Autenticada

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Registros do Console Serial

Os Registros do Console Serial do Compute Engine s√£o um recurso que permite **visualizar e diagnosticar os logs de inicializa√ß√£o e do sistema operacional** das suas inst√¢ncias de m√°quinas virtuais.

Os Registros do Console Serial fornecem uma **vis√£o de baixo n√≠vel do processo de inicializa√ß√£o da inst√¢ncia**, incluindo mensagens do kernel, scripts de inicializa√ß√£o e outros eventos do sistema que ocorrem durante a inicializa√ß√£o. Isso pode ser √∫til para depurar problemas de inicializa√ß√£o, identificar configura√ß√µes incorretas ou erros de software, ou solucionar problemas de conectividade de rede.

Esses logs **podem expor informa√ß√µes sens√≠veis** dos logs do sistema que um usu√°rio com baixos privil√©gios normalmente n√£o veria, mas com as permiss√µes IAM apropriadas, voc√™ pode ser capaz de l√™-los.

Voc√™ pode usar o seguinte [comando gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar os logs da porta serial (a permiss√£o necess√°ria √© `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Gerenciador de Configura√ß√£o do Sistema Operacional

Voc√™ pode usar o servi√ßo de gerenciamento de configura√ß√£o do sistema operacional para **implantar, consultar e manter configura√ß√µes consistentes** (estado desejado e software) para sua inst√¢ncia de VM (VM). No Compute Engine, voc√™ deve usar [pol√≠ticas de convidados](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para manter configura√ß√µes de software consistentes em uma VM.

O recurso de gerenciamento de configura√ß√£o do sistema operacional permite que voc√™ defina pol√≠ticas de configura√ß√£o que especificam quais pacotes de software devem ser instalados, quais servi√ßos devem ser habilitados e quais arquivos ou configura√ß√µes devem estar presentes em suas VMs. Voc√™ pode usar uma abordagem declarativa para gerenciar a configura√ß√£o de software de suas VMs, o que permite automatizar e dimensionar seu processo de gerenciamento de configura√ß√£o com mais facilidade.

Isso tamb√©m permite fazer login em inst√¢ncias por meio de permiss√µes do IAM, sendo muito **√∫til para escalonamento de privil√©gios e pivoteamento**.

{% hint style="warning" %}
Para **ativar o os-config em um projeto inteiro ou em uma inst√¢ncia**, basta definir a chave **`enable-oslogin`** nos **metadados** como **`true`** no n√≠vel desejado.\
Al√©m disso, voc√™ pode definir os metadados **`enable-oslogin-2fa`** como **`true`** para ativar a autentica√ß√£o em duas etapas.

Quando voc√™ o ativa ao criar uma inst√¢ncia, as chaves de metadados ser√£o definidas automaticamente.
{% endhint %}

Mais sobre **2fa no OS-config**, **aplica-se apenas se o usu√°rio for um usu√°rio**, se for um SA (como o SA de computa√ß√£o), n√£o ser√° necess√°rio nada extra.

### Enumera√ß√£o
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Imagens

### Imagens Personalizadas

**As imagens de computa√ß√£o personalizadas podem conter detalhes sens√≠veis** ou outras configura√ß√µes vulner√°veis que voc√™ pode explorar.

Ao criar uma imagem, voc√™ pode escolher **3 tipos de criptografia**: Usando a **chave gerenciada pelo Google** (padr√£o), uma **chave do KMS**, ou uma **chave bruta** fornecida pelo cliente.

#### Enumera√ß√£o

Voc√™ pode consultar a lista de imagens n√£o padr√£o em um projeto com o seguinte comando:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Voc√™ pode ent√£o [**exportar**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **os discos virtuais** de qualquer imagem em v√°rios formatos. O comando a seguir exportaria a imagem `test-image` no formato qcow2, permitindo que voc√™ baixe o arquivo e construa uma VM localmente para investiga√ß√µes adicionais:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escala√ß√£o de Privil√©gios

Verifique a se√ß√£o de escala√ß√£o de privil√©gios das Inst√¢ncias de Computa√ß√£o.

### Modelos de Inst√¢ncia Personalizados

Um [**modelo de inst√¢ncia**](https://cloud.google.com/compute/docs/instance-templates/) **define propriedades da inst√¢ncia** para ajudar a implantar configura√ß√µes consistentes. Eles podem conter os mesmos tipos de dados sens√≠veis que os metadados personalizados de uma inst√¢ncia em execu√ß√£o. Voc√™ pode usar os seguintes comandos para investigar:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Pode ser interessante saber em qual disco as novas imagens est√£o sendo usadas, mas esses modelos geralmente n√£o ter√£o informa√ß√µes sens√≠veis.

## Snapshots

Os **snapshots s√£o backups de discos**. Note que isso n√£o √© o mesmo que clonar um disco (outra funcionalidade dispon√≠vel).\
O **snapshot** usar√° a **mesma criptografia do disco** do qual foi tirado.

### Enumera√ß√£o
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escala√ß√£o de Privil√©gios

Verifique a se√ß√£o de escala√ß√£o de privil√©gios das Inst√¢ncias de Computa√ß√£o.

## Refer√™ncias

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
