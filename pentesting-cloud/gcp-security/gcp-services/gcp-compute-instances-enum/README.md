# GCP - Wyszukiwanie instancji obliczeniowych

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>

## GCP VPC i Sieciowanie

Dowiedz si, jak to dziaa w:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Wyszukiwanie

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

atwo znajdziesz instancje obliczeniowe z otwartymi reguami zapory sieciowej za pomoc [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancje obliczeniowe

To jest spos贸b, w jaki **uruchamiasz maszyny wirtualne w GCP.** Sprawd藕 t stron, aby uzyska wicej informacji:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeracja
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnie obliczeniowych w celu eskalacji uprawnie**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Nieuwierzytelniona Enumeracja

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Po Wykorzystaniu

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Trwao

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Dzienniki konsoli szeregowej

Dzienniki konsoli szeregowej Compute Engine to funkcja, kt贸ra pozwala **wywietla i diagnozowa dzienniki uruchamiania i systemu operacyjnego** twoich instancji maszyn wirtualnych.

Dzienniki konsoli szeregowej zapewniaj **niskopoziomowy widok procesu uruchamiania instancji**, w tym komunikaty jdra, skrypty init oraz inne zdarzenia systemowe, kt贸re wystpuj podczas uruchamiania. Mo偶e to by przydatne do debugowania problem贸w z uruchamianiem, identyfikowania bd贸w konfiguracji lub oprogramowania, a tak偶e rozwizywania problem贸w z cznoci sieciow.

Te dzienniki **mog ujawni poufne informacje** z dziennik贸w systemowych, kt贸rych zwykle nie widzi nisko uprzywilejowany u偶ytkownik, ale przy odpowiednich uprawnieniach IAM mo偶esz je odczyta.

Mo偶esz u偶y nastpujcej [komendy gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) do zapytania o dzienniki portu szeregowego (wymagane uprawnienie to `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Mened偶er konfiguracji systemu operacyjnego

Mo偶esz u偶y usugi zarzdzania konfiguracj systemu operacyjnego do **wdra偶ania, zapytywania i utrzymywania sp贸jnych konfiguracji** (stanu docelowego i oprogramowania) dla twojej instancji maszyny wirtualnej (VM). W Compute Engine musisz u偶y [polityk gocinnych](https://cloud.google.com/compute/docs/os-config-management#guest-policy) do utrzymywania sp贸jnych konfiguracji oprogramowania na VM.

Funkcja zarzdzania konfiguracj systemu operacyjnego pozwala zdefiniowa polityki konfiguracji, kt贸re okrelaj, kt贸re pakiety oprogramowania powinny by zainstalowane, kt贸re usugi powinny by wczone, oraz kt贸re pliki lub konfiguracje powinny by obecne na twoich VM. Mo偶esz u偶y deklaratywnego podejcia do zarzdzania konfiguracj oprogramowania twoich VM, co pozwala na atwiejsze automatyzowanie i skalowanie procesu zarzdzania konfiguracj.

To r贸wnie偶 pozwala na logowanie si do instancji za pomoc uprawnie IAM, co jest bardzo **przydatne do eskalacji uprawnie i przekierowywania**.

{% hint style="warning" %}
Aby **wczy os-config w caym projekcie lub na instancji**, wystarczy ustawi klucz **`enable-oslogin`** metadanych na poziomie docelowym na **`true`**.\
Co wicej, mo偶na ustawi metadane **`enable-oslogin-2fa`** na **`true`** aby wczy uwierzytelnianie dwuetapowe.

Gdy wczysz to podczas tworzenia instancji, klucze metadanych zostan automatycznie ustawione.
{% endhint %}

Wicej informacji na temat **2fa w OS-config**, **dotyczy to tylko u偶ytkownika**, jeli jest to SA (jak SA obliczeniowy), nie bdzie wymaga niczego dodatkowego.

### Wyliczanie
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Obrazy

### Niestandardowe obrazy

**Niestandardowe obrazy obliczeniowe mog zawiera poufne szczeg贸y** lub inne podatne konfiguracje, kt贸re mo偶na wykorzysta.

Podczas tworzenia obrazu mo偶esz wybra **3 rodzaje szyfrowania**: U偶ycie **klucza zarzdzanego przez Google** (domylnie), **klucza z KMS** lub **klucza surowego** podanego przez klienta.

#### Wyliczenie

Mo偶esz zapyta list obraz贸w niestandardowych w projekcie za pomoc nastpujcej komendy:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
Mo偶esz nastpnie [**eksportowa**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **dyski wirtualne** z dowolnego obrazu w wielu formatach. Poni偶sze polecenie eksportuje obraz `test-image` w formacie qcow2, umo偶liwiajc pobranie pliku i zbudowanie maszyny wirtualnej lokalnie w celu dalszego zbadania:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Eskalacja uprawnie

Sprawd藕 sekcj eskalacji uprawnie instancji obliczeniowych.

### Szablony niestandardowych instancji

[**Szablon instancji**](https://cloud.google.com/compute/docs/instance-templates/) **definiuje waciwoci instancji** w celu uatwienia wdra偶ania sp贸jnych konfiguracji. Mog one zawiera te same rodzaje danych wra偶liwych co niestandardowe metadane dziaajcej instancji. Mo偶esz u偶y poni偶szych polece do zbadania:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Mo偶e by interesujce dowiedzie si, kt贸ry dysk jest u偶ywany do nowych obraz贸w, ale te szablony zazwyczaj nie bd zawiera poufnych informacji.

## Snapshoty

**Snapshoty to kopie zapasowe dysk贸w**. Nale偶y zauwa偶y, 偶e nie jest to to偶same z klonowaniem dysku (inn dostpn funkcj).\
**Snapshot** bdzie u偶ywa **tej samej szyfrowania co dysk**, z kt贸rego zosta utworzony.

### Wyliczanie
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Eskalacja uprawnie

Sprawd藕 sekcj eskalacji uprawnie instancji obliczeniowych.

## Referencje

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
