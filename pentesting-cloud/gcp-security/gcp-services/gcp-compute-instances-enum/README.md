# GCP - Enumeraci贸n de Instancias de C贸mputo

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GCP VPC y Networking

Aprende c贸mo funciona esto en:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeraci贸n

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Puedes encontrar f谩cilmente instancias de c贸mputo con reglas de firewall abiertas en [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancias de C贸mputo

Esta es la forma en que puedes **ejecutar m谩quinas virtuales dentro de GCP.** Consulta esta p谩gina para obtener m谩s informaci贸n:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeraci贸n
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Para obtener m谩s informaci贸n sobre c贸mo **SSH** o **modificar los metadatos** de una instancia para **escalar privilegios**, consulta esta p谩gina:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalada de Privilegios

En la siguiente p谩gina, puedes ver c贸mo **abusar de los permisos de c贸mputo para escalar privilegios**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Enumeraci贸n sin Autenticaci贸n

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci贸n

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Registros de la Consola Serie

Los Registros de la Consola Serie de Compute Engine son una caracter铆stica que te permite **ver y diagnosticar los registros de arranque y del sistema operativo** de tus instancias de m谩quinas virtuales.

Los Registros de la Consola Serie proporcionan una **vista de bajo nivel del proceso de arranque de la instancia**, incluidos mensajes del kernel, scripts de inicio y otros eventos del sistema que ocurren durante el arranque. Esto puede ser 煤til para depurar problemas de arranque, identificar configuraciones incorrectas o errores de software, o solucionar problemas de conectividad de red.

Estos registros **pueden exponer informaci贸n sensible** de los registros del sistema que un usuario con privilegios bajos normalmente no ver铆a, pero con los permisos IAM apropiados podr铆as ser capaz de leerlos.

Puedes utilizar el siguiente [comando gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar los registros del puerto serie (el permiso requerido es `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Administrador de configuraci贸n del sistema operativo

Puedes utilizar el servicio de administraci贸n de configuraci贸n del sistema operativo para **implementar, consultar y mantener configuraciones consistentes** (estado deseado y software) para tu instancia de VM. En Compute Engine, debes utilizar [pol铆ticas de invitado](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para mantener configuraciones de software consistentes en una VM.

La funci贸n de administraci贸n de configuraci贸n del sistema operativo te permite definir pol铆ticas de configuraci贸n que especifican qu茅 paquetes de software deben instalarse, qu茅 servicios deben habilitarse y qu茅 archivos o configuraciones deben estar presentes en tus VM. Puedes utilizar un enfoque declarativo para gestionar la configuraci贸n de software de tus VM, lo que te permite automatizar y escalar tu proceso de administraci贸n de configuraciones de forma m谩s sencilla.

Esto tambi茅n permite iniciar sesi贸n en las instancias a trav茅s de permisos de IAM, por lo que es muy **煤til para la escalada de privilegios y el pivoteo**.

{% hint style="warning" %}
Para **habilitar os-config en todo un proyecto o en una instancia**, solo necesitas establecer la clave **`enable-oslogin`** en **`true`** en el nivel deseado.\
Adem谩s, puedes establecer la clave de metadatos **`enable-oslogin-2fa`** en **`true`** para habilitar la autenticaci贸n de dos factores (2FA).

Cuando lo habilitas al crear una instancia, las claves de metadatos se establecer谩n autom谩ticamente.
{% endhint %}

M谩s sobre **2fa en OS-config**, **solo se aplica si el usuario es un usuario**, si es un SA (como el SA de computaci贸n) no requerir谩 nada adicional.

### Enumeraci贸n
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Im谩genes

### Im谩genes personalizadas

Las **im谩genes personalizadas de computaci贸n pueden contener detalles sensibles** u otras configuraciones vulnerables que puedes explotar.

Cuando se crea una imagen, puedes elegir **3 tipos de cifrado**: Usando una **clave administrada por Google** (predeterminado), una **clave de KMS**, o una **clave sin procesar** proporcionada por el cliente.

#### Enumeraci贸n

Puedes consultar la lista de im谩genes no est谩ndar en un proyecto con el siguiente comando:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Luego puedes [**exportar**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **los discos virtuales** de cualquier imagen en varios formatos. El siguiente comando exportar铆a la imagen `test-image` en formato qcow2, lo que te permitir铆a descargar el archivo y construir una VM localmente para una investigaci贸n m谩s detallada:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalaci贸n de privilegios

Verifique la secci贸n de escalaci贸n de privilegios de las Instancias de C贸mputo.

### Plantillas de Instancia Personalizadas

Una [**plantilla de instancia**](https://cloud.google.com/compute/docs/instance-templates/) **define propiedades de la instancia** para ayudar a implementar configuraciones consistentes. Estas pueden contener los mismos tipos de datos sensibles que los metadatos personalizados de una instancia en ejecuci贸n. Puede utilizar los siguientes comandos para investigar:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Puede ser interesante saber qu茅 disco est谩 utilizando nuevas im谩genes, pero estas plantillas generalmente no tendr谩n informaci贸n sensible.

## Instant谩neas

Las **instant谩neas son copias de seguridad de discos**. Tenga en cuenta que esto no es lo mismo que clonar un disco (otra funci贸n disponible).\
La **instant谩nea** utilizar谩 el **mismo cifrado que el disco** del que se tom贸. 

### Enumeraci贸n
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalada de Privilegios

Consulte la secci贸n de escalada de privilegios de las Instancias de C贸mputo.

## Referencias

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
