# GCP - Compute Enum

<details>

<summary><strong>Erfahren Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## GCP VPC & Networking

Erfahren Sie, wie dies funktioniert in:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Sie k√∂nnen Compute-Instanzen mit offenen Firewall-Regeln leicht finden mit [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Compute-Instanzen

So k√∂nnen Sie **virtuelle Maschinen in GCP ausf√ºhren.** √úberpr√ºfen Sie diese Seite f√ºr weitere Informationen:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### Berechtigungserweiterung

Auf der folgenden Seite k√∂nnen Sie nachlesen, wie Sie **Compute-Berechtigungen missbrauchen, um Berechtigungen zu eskalieren**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Nicht authentifizierte Enumeration

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistenz

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Serielle Konsolenprotokolle

Compute Engine Serial Console Logs sind eine Funktion, die es Ihnen erm√∂glicht, die Start- und Betriebssystemprotokolle Ihrer virtuellen Maschineninstanzen **anzuzeigen und zu diagnostizieren**.

Die Seriellen Konsolenprotokolle bieten eine **niedrigstufige Ansicht des Startvorgangs der Instanz**, einschlie√ülich Kernelmeldungen, Init-Skripte und anderer Systemereignisse, die w√§hrend des Bootvorgangs auftreten. Dies kann n√ºtzlich sein, um Startprobleme zu debuggen, Fehlkonfigurationen oder Softwarefehler zu identifizieren oder Netzwerkverbindungsprobleme zu beheben.

Diese Protokolle **k√∂nnen sensible Informationen preisgeben**, die ein Benutzer mit niedrigen Berechtigungen normalerweise nicht sehen w√ºrde, aber mit den entsprechenden IAM-Berechtigungen k√∂nnen Sie sie m√∂glicherweise lesen.

Sie k√∂nnen den folgenden [gcloud-Befehl](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) verwenden, um die Seriellen-Port-Protokolle abzufragen (die erforderliche Berechtigung ist `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## OS-Konfigurations-Manager

Sie k√∂nnen den OS-Konfigurations-Manager verwenden, um **konsistente Konfigurationen bereitzustellen, abzufragen und aufrechtzuerhalten** (gew√ºnschter Zustand und Software) f√ºr Ihre VM-Instanz (VM). Auf Compute Engine m√ºssen Sie [Gastrichtlinien](https://cloud.google.com/compute/docs/os-config-management#guest-policy) verwenden, um konsistente Softwarekonfigurationen auf einer VM aufrechtzuerhalten.

Das Feature OS-Konfigurations-Management erm√∂glicht es Ihnen, Konfigurationsrichtlinien zu definieren, die angeben, welche Softwarepakete installiert werden sollen, welche Dienste aktiviert werden sollen und welche Dateien oder Konfigurationen auf Ihren VMs vorhanden sein sollen. Sie k√∂nnen einen deklarativen Ansatz zur Verwaltung der Softwarekonfiguration Ihrer VMs verwenden, der es Ihnen erm√∂glicht, Ihren Konfigurationsverwaltungsprozess einfacher zu automatisieren und zu skalieren.

Dies erm√∂glicht auch das Einloggen in Instanzen √ºber IAM-Berechtigungen, daher ist es sehr **n√ºtzlich f√ºr Privilege Escalation und Pivoting**.

{% hint style="warning" %}
Um **os-config in einem gesamten Projekt oder in einer Instanz zu aktivieren**, m√ºssen Sie einfach den **Metadaten**-Schl√ºssel **`enable-oslogin`** auf **`true`** auf der gew√ºnschten Ebene setzen.\
Dar√ºber hinaus k√∂nnen Sie die Metadaten **`enable-oslogin-2fa`** auf **`true`** setzen, um die 2FA zu aktivieren.

Wenn Sie es aktivieren, wenn Sie eine Instanz erstellen, werden die Metadaten automatisch gesetzt.
{% endhint %}

Mehr √ºber **2FA in OS-Konfiguration**, **es gilt nur, wenn der Benutzer ein Benutzer ist**, wenn es sich um einen SA handelt (wie den Compute SA), wird nichts zus√§tzliches ben√∂tigt.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Bilder

### Benutzerdefinierte Bilder

Benutzerdefinierte Compute-Bilder k√∂nnen sensible Details oder andere anf√§llige Konfigurationen enthalten, die Sie ausnutzen k√∂nnen.

Wenn ein Bild erstellt wird, k√∂nnen Sie **3 Arten der Verschl√ºsselung** w√§hlen: Verwendung des **von Google verwalteten Schl√ºssels** (Standard), eines **Schl√ºssels von KMS** oder eines **rohen Schl√ºssels**, der vom Client bereitgestellt wird.

#### Aufz√§hlung

Sie k√∂nnen die Liste der nicht standardm√§√üigen Bilder in einem Projekt mit dem folgenden Befehl abfragen:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Sie k√∂nnen dann [**die virtuellen Festplatten**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) aus einem beliebigen Image in mehreren Formaten exportieren. Der folgende Befehl w√ºrde das Image `test-image` im qcow2-Format exportieren, sodass Sie die Datei herunterladen und lokal eine VM f√ºr weitere Untersuchungen erstellen k√∂nnen:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Privilege Escalation

√úberpr√ºfen Sie den Abschnitt zur Privilegieneskalation von Compute-Instanzen.

### Benutzerdefinierte Instanzvorlagen

Eine [**Instanzvorlage**](https://cloud.google.com/compute/docs/instance-templates/) **definiert Instanzeigenschaften**, um bei der Bereitstellung konsistente Konfigurationen zu unterst√ºtzen. Diese k√∂nnen dieselben Arten von sensiblen Daten enthalten wie die benutzerdefinierten Metadaten einer laufenden Instanz. Sie k√∂nnen die folgenden Befehle verwenden, um zu untersuchen:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Es k√∂nnte interessant sein zu wissen, welche Festplatte neue Images verwenden, aber diese Vorlagen enthalten normalerweise keine sensiblen Informationen.

## Snapshots

Die **Snapshots sind Sicherungskopien von Festplatten**. Beachten Sie, dass dies nicht dasselbe ist wie das Klonen einer Festplatte (eine weitere verf√ºgbare Funktion).\
Der **Snapshot** verwendet die **gleiche Verschl√ºsselung wie die Festplatte**, von der er erstellt wurde.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

√úberpr√ºfen Sie den Abschnitt zur Privilegieneskalation von Compute-Instanzen.

## Referenzen

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
