# GCP - Enum√©ration des instances de calcul

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## GCP VPC & R√©seau

Apprenez comment cela fonctionne dans :

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Vous pouvez facilement trouver des instances de calcul avec des r√®gles de pare-feu ouvertes avec [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instances de calcul

C'est ainsi que vous pouvez **ex√©cuter des machines virtuelles dans GCP.** Consultez cette page pour plus d'informations :

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### √ânum√©ration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Pour plus d'informations sur la fa√ßon de **SSH** ou **modifier les m√©tadonn√©es** d'une instance pour **escalader les privil√®ges**, consultez cette page :

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations de calcul pour escalader les privil√®ges** :

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### √ânum√©ration non authentifi√©e

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Journaux de la console s√©rie

Les journaux de la console s√©rie de Compute Engine sont une fonctionnalit√© qui vous permet de **visualiser et diagnostiquer les journaux de d√©marrage et du syst√®me d'exploitation** de vos instances de machine virtuelle.

Les journaux de la console s√©rie fournissent une **vue de bas niveau du processus de d√©marrage de l'instance**, y compris les messages du noyau, les scripts d'initialisation et d'autres √©v√©nements syst√®me qui se produisent lors du d√©marrage. Cela peut √™tre utile pour d√©boguer les probl√®mes de d√©marrage, identifier les mauvaises configurations ou les erreurs logicielles, ou r√©soudre les probl√®mes de connectivit√© r√©seau.

Ces journaux **peuvent exposer des informations sensibles** des journaux syst√®me que les utilisateurs peu privil√©gi√©s ne voient g√©n√©ralement pas, mais avec les autorisations IAM appropri√©es, vous pouvez les lire.

Vous pouvez utiliser la commande [gcloud suivante](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) pour interroger les journaux du port s√©rie (l'autorisation requise est `compute.instances.getSerialPortOutput`) :
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Gestionnaire de configuration du syst√®me d'exploitation

Vous pouvez utiliser le service de gestion de la configuration du syst√®me d'exploitation pour **d√©ployer, interroger et maintenir des configurations coh√©rentes** (√©tat souhait√© et logiciels) pour votre instance de machine virtuelle (VM). Sur Compute Engine, vous devez utiliser [les politiques invit√©es](https://cloud.google.com/compute/docs/os-config-management#guest-policy) pour maintenir des configurations logicielles coh√©rentes sur une VM.

La fonction de gestion de la configuration du syst√®me d'exploitation vous permet de d√©finir des politiques de configuration qui sp√©cifient quels packages logiciels doivent √™tre install√©s, quels services doivent √™tre activ√©s et quels fichiers ou configurations doivent √™tre pr√©sents sur vos VM. Vous pouvez utiliser une approche d√©clarative pour g√©rer la configuration logicielle de vos VM, ce qui vous permet d'automatiser et de mettre √† l'√©chelle plus facilement votre processus de gestion de la configuration.

Cela permet √©galement de se connecter aux instances via les autorisations IAM, ce qui est tr√®s **utile pour l'√©l√©vation de privil√®ges et le pivotement**.

{% hint style="warning" %}
Pour **activer os-config dans un projet entier ou dans une instance**, vous devez simplement d√©finir la cl√© **`enable-oslogin`** des **m√©tadonn√©es** sur **`true`** au niveau souhait√©.\
De plus, vous pouvez d√©finir les m√©tadonn√©es **`enable-oslogin-2fa`** sur **`true`** pour activer l'authentification √† deux facteurs.

Lorsque vous l'activez lors de la cr√©ation d'une instance, les cl√©s de m√©tadonn√©es seront automatiquement d√©finies.
{% endhint %}

En savoir plus sur **2fa dans OS-config**, **cela s'applique uniquement si l'utilisateur est un utilisateur**, s'il s'agit d'un SA (comme le SA de calcul), il ne n√©cessitera rien de plus.

### √ânum√©ration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Images personnalis√©es

Les images de calcul personnalis√©es peuvent contenir des d√©tails sensibles ou d'autres configurations vuln√©rables que vous pouvez exploiter.

Lorsqu'une image est cr√©√©e, vous pouvez choisir 3 types de chiffrement : en utilisant une cl√© g√©r√©e par Google (par d√©faut), une cl√© provenant de KMS, ou une cl√© brute fournie par le client.

#### √ânum√©ration

Vous pouvez interroger la liste des images non standard dans un projet avec la commande suivante :

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Vous pouvez ensuite [**exporter**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **les disques virtuels** de n'importe quelle image dans plusieurs formats. La commande suivante exporterait l'image `test-image` au format qcow2, vous permettant de t√©l√©charger le fichier et de construire une machine virtuelle localement pour une enqu√™te ult√©rieure:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### √âl√©vation de privil√®ges

V√©rifiez la section sur l'√©l√©vation de privil√®ges des instances Compute.

### Mod√®les d'instances personnalis√©s

Un [**mod√®le d'instance**](https://cloud.google.com/compute/docs/instance-templates/) **d√©finit les propri√©t√©s de l'instance** pour aider au d√©ploiement de configurations coh√©rentes. Ils peuvent contenir les m√™mes types de donn√©es sensibles que les m√©tadonn√©es personnalis√©es d'une instance en cours d'ex√©cution. Vous pouvez utiliser les commandes suivantes pour enqu√™ter :
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Il pourrait √™tre int√©ressant de savoir quel disque est utilis√© par les nouvelles images, mais ces mod√®les n'auront g√©n√©ralement pas d'informations sensibles.

## Instantan√©s

Les **instantan√©s sont des sauvegardes des disques**. Notez que ce n'est pas la m√™me chose que de cloner un disque (une autre fonctionnalit√© disponible).\
L'**instantan√©** utilisera le **m√™me chiffrement que le disque** dont il est issu.

### √ânum√©ration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### √âl√©vation de privil√®ges

Consultez la section sur l'√©l√©vation de privil√®ges des instances de calcul.

## R√©f√©rences

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
