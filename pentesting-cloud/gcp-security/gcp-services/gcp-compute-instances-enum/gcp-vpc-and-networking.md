# GCP - VPC & Networking

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## **Networking di Calcolo GCP in breve**

Le **VPC** contengono regole del **Firewall** per consentire il traffico in ingresso alla VPC. Le VPC contengono anche **sottoreti** dove le **macchine virtuali** verranno **collegate**.\
Paragonando con AWS, il **Firewall** sarebbe la cosa pi√π **simile** a **Gruppi di Sicurezza AWS e NACLs**, ma in questo caso sono **definiti nella VPC** e non in ogni istanza.

## **VPC, Sottoreti e Firewall in GCP**

Le istanze di calcolo sono collegate a **sottoreti** che fanno parte delle **VPC** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). In GCP non ci sono gruppi di sicurezza, ci sono [**firewall VPC**](https://cloud.google.com/vpc/docs/firewalls) con regole definite a questo livello di rete ma applicate a ciascuna istanza VM.

### Sottoreti

Una **VPC** pu√≤ avere **diverse sottoreti**. Ogni **sottorete √® in 1 regione**.

### Firewall

Per impostazione predefinita, ogni rete ha due [**regole del firewall implicite**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **consenti in uscita** e **negare in ingresso**.

Quando viene creato un progetto GCP, viene creata anche una VPC chiamata **`default`**, con le seguenti regole del firewall:

* **default-allow-internal:** consente tutto il traffico da altre istanze sulla rete `default`
* **default-allow-ssh:** consente 22 da ovunque
* **default-allow-rdp:** consente 3389 da ovunque
* **default-allow-icmp:** consente ping da ovunque

{% hint style="warning" %}
Come puoi vedere, le **regole del firewall** tendono ad essere **pi√π permissive** per gli **indirizzi IP interni**. La VPC predefinita permette tutto il traffico tra le istanze di calcolo.
{% endhint %}

Possono essere create ulteriori **regole del firewall** per la VPC predefinita o per nuove VPC. Le [**regole del firewall**](https://cloud.google.com/vpc/docs/firewalls) possono essere applicate alle istanze tramite i seguenti **metodi**:

* [**Tag di rete**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Account di servizio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Tutte le istanze all'interno di una VPC**

Purtroppo non esiste un semplice comando `gcloud` per visualizzare tutte le istanze di calcolo con porte aperte su Internet. √à necessario collegare i puntini tra le regole del firewall, i tag di rete, gli account di servizio e le istanze.

Questo processo √® stato automatizzato utilizzando [questo script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) che esporter√† quanto segue:

* File CSV che mostra istanza, IP pubblico, TCP consentito, UDP consentito
* Scansione nmap per mirare a tutte le istanze su porte ingress consentite dall'Internet pubblico (0.0.0.0/0)
* masscan per mirare all'intero intervallo TCP di quelle istanze che consentono TUTTE le porte TCP dall'Internet pubblico (0.0.0.0/0)

### Politiche del Firewall Gerarchico <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Le _politiche del firewall gerarchico_ ti consentono di creare e **applicare una politica del firewall coerente in tutta l'organizzazione**. Puoi assegnare **politiche del firewall gerarchico all'organizzazione** nel suo complesso o a singole **cartelle**. Queste politiche contengono regole che possono esplicitamente negare o consentire connessioni.

Crei e applichi le politiche del firewall come passaggi separati. Puoi creare e applicare le politiche del firewall ai **nodi dell'organizzazione o della cartella** della [**gerarchia delle risorse**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regola della politica del firewall pu√≤ **bloccare connessioni, consentire connessioni o rinviare la valutazione della regola del firewall** a cartelle di livello inferiore o regole del firewall VPC definite nelle reti VPC.

Per impostazione predefinita, tutte le regole delle politiche del firewall gerarchico si applicano a tutte le VM in tutti i progetti sotto l'organizzazione o la cartella in cui √® associata la politica. Tuttavia, puoi **limitare a quali VM viene applicata una determinata regola** specificando [reti di destinazione o account di servizio di destinazione](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puoi leggere qui come [**creare una Politica del Firewall Gerarchico**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Valutazione delle Regole del Firewall

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Politiche del firewall assegnate all'Organizzazione
2. Cartella: Politiche del firewall assegnate alla Cartella
3. VPC: Regole del firewall assegnate alla VPC
4. Globale: Un altro tipo di regole del firewall che possono essere assegnate alle VPC
5. Regionale: Regole del firewall associate alla rete VPC della scheda di rete della VM e alla regione della VM.

## Interconnessione delle Reti VPC

Consente di collegare due reti Virtual Private Cloud (VPC) in modo che le **risorse in ciascuna rete possano comunicare** tra loro.\
Le reti VPC interconnesse possono essere nello stesso progetto, in progetti diversi della stessa organizzazione o in **progetti diversi di organizzazioni diverse**.

Questi sono i permessi necessari:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Maggiori informazioni nella documentazione**](https://cloud.google.com/vpc/docs/vpc-peering).

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
