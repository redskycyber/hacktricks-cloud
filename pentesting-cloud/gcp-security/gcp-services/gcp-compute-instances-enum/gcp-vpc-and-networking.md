# GCP - VPC & Networking

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **GCP RaÄunarska MreÅ¾a u Kratkim Crtama**

**VPC-ovi** sadrÅ¾e **Firewall** pravila koja omoguÄ‡avaju dolazni saobraÄ‡aj u VPC. VPC-ovi takoÄ‘e sadrÅ¾e **podmreÅ¾e** gde Ä‡e biti **povezane virtuelne maÅ¡ine**.\
U poreÄ‘enju sa AWS-om, **Firewall** bi bio **najbliÅ¾a** stvar **AWS** **Security Groups i NACLs**, ali u ovom sluÄaju su **definisani u VPC-u** a ne u svakom primerku.

## **VPC, PodmreÅ¾e i Firewall-ovi u GCP-u**

RaÄunarski primeri su povezani **podmreÅ¾ama** koje su deo **VPC-ova** ([Virtualne privatne mreÅ¾e](https://cloud.google.com/vpc/docs/vpc)). U GCP-u ne postoje sigurnosne grupe, veÄ‡ postoje [**VPC firewall-ovi**](https://cloud.google.com/vpc/docs/firewalls) sa pravilima definisanim na ovom nivou mreÅ¾e ali primenjenim na svaku VM instancu.

### PodmreÅ¾e

**VPC** moÅ¾e imati **viÅ¡e podmreÅ¾a**. Svaka **podmreÅ¾a je u 1 regionu**.

### Firewall-ovi

Podrazumevano, svaka mreÅ¾a ima dva [**podrazumevana firewall pravila**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **dozvoli odlazni** i **zabrani dolazni**.

Kada se kreira GCP projekat, VPC pod nazivom **`default`** se takoÄ‘e kreira, sa sledeÄ‡im firewall pravilima:

* **default-allow-internal:** dozvoljava sav saobraÄ‡aj sa drugih instanci na `default` mreÅ¾i
* **default-allow-ssh:** dozvoljava 22 sa bilo kog mesta
* **default-allow-rdp:** dozvoljava 3389 sa bilo kog mesta
* **default-allow-icmp:** dozvoljava ping sa bilo kog mesta

{% hint style="warning" %}
Kao Å¡to moÅ¾ete videti, **firewall pravila** obiÄno su **viÅ¡e dozvoljena** za **internu IP adresu**. Podrazumevani VPC dozvoljava sav saobraÄ‡aj izmeÄ‘u RaÄunarskih Instanci.
{% endhint %}

ViÅ¡e **Firewall pravila** moÅ¾e biti kreirano za podrazumevani VPC ili za nove VPC-ove. [**Firewall pravila**](https://cloud.google.com/vpc/docs/firewalls) mogu biti primenjena na instance putem sledeÄ‡ih **metoda**:

* [**MreÅ¾ni tagovi**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Servisni nalozi**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Sve instance unutar VPC-a**

NaÅ¾alost, ne postoji jednostavna `gcloud` komanda koja Ä‡e izlistati sve RaÄunske Instance sa otvorenim portovima na internetu. Morate povezati taÄke izmeÄ‘u firewall pravila, mreÅ¾nih tagova, servisnih naloga i instanci.

Ovaj proces je automatizovan koriÅ¡Ä‡enjem [ovog python skripta](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) koji Ä‡e izvesti sledeÄ‡e:

* CSV fajl koji prikazuje instancu, javnu IP adresu, dozvoljeni TCP, dozvoljeni UDP
* nmap skeniranje svih instanci na portovima za dolazni saobraÄ‡aj sa javnog interneta (0.0.0.0/0)
* masscan za ciljanje punog TCP opsega tih instanci koje dozvoljavaju SVE TCP portove sa javnog interneta (0.0.0.0/0)

### Hijerarhijske Firewall Politike <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hijerarhijske firewall politike_ vam omoguÄ‡avaju da kreirate i **sprovedete doslednu firewall politiku Å¡irom vaÅ¡e organizacije**. MoÅ¾ete dodeliti **hijerarhijske firewall politike organizaciji** u celini ili pojedinaÄnim **folderima**. Ove politike sadrÅ¾e pravila koja mogu eksplicitno zabraniti ili dozvoliti konekcije.

Kreirate i primenjujete firewall politike kao odvojene korake. MoÅ¾ete kreirati i primeniti firewall politike na **Ävorovima organizacije ili foldera** [**hijerarhije resursa**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Pravilo firewall politike moÅ¾e **blokirati konekcije, dozvoliti konekcije ili odloÅ¾iti evaluaciju pravila firewall-a** na niÅ¾im nivoima foldera ili VPC firewall pravila definisana u VPC mreÅ¾ama.

Podrazumevano, sva pravila hijerarhijske firewall politike se primenjuju na sve VM-ove u svim projektima pod organizacijom ili folderom gde je politika povezana. MeÄ‘utim, moÅ¾ete **ograniÄiti kojim VM-ovima se dodeljuje dato pravilo** specificiranjem [ciljnih mreÅ¾a ili ciljnih servisnih naloga](https://cloud.google.com/vpc/docs/firewall-policies#targets).

MoÅ¾ete proÄitati ovde kako [**kreirati Hijerarhijsku Firewall Politiku**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluacija Pravila Firewall-a

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Firewall politike dodeljene Organizaciji
2. Folder: Firewall politike dodeljene Folderu
3. VPC: Firewall pravila dodeljena VPC-u
4. Globalno: Druga vrsta firewall pravila koja mogu biti dodeljena VPC-ovima
5. Regionalno: Firewall pravila povezana sa VPC mreÅ¾om NIC-a VM-a i regionom VM-a.

## Povezivanje VPC MreÅ¾a

OmoguÄ‡ava povezivanje dve Virtualne privatne mreÅ¾e (VPC) tako da **resursi u svakoj mreÅ¾i mogu komunicirati** jedni sa drugima.\
Povezane VPC mreÅ¾e mogu biti u istom projektu, razliÄitim projektima iste organizacije, ili **razliÄitim projektima razliÄitih organizacija**.

Potrebne dozvole su:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**ViÅ¡e u dokumentaciji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
