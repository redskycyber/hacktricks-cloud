# GCP - VPC & 网络

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **GCP计算网络简介**

**VPC** 包含 **防火墙** 规则，允许流入 VPC 的流量。VPC 还包含 **子网**，其中 **虚拟机** 将被 **连接**。\
与AWS相比，**防火墙** 将是最接近 **AWS安全组和NACLs** 的东西，但在这种情况下，这些是在 **VPC** 中定义的，而不是在每个实例中定义的。

## **GCP中的VPC、子网和防火墙**

计算实例连接到 **子网**，这些子网是 **VPC**（[虚拟专用云](https://cloud.google.com/vpc/docs/vpc)）的一部分。在GCP中没有安全组，而是具有在此网络级别定义但应用于每个VM实例的 [**VPC防火墙**](https://cloud.google.com/vpc/docs/firewalls)。

### 子网

一个 **VPC** 可以有 **多个子网**。每个 **子网位于一个区域**。

### 防火墙

默认情况下，每个网络都有两个 [**隐含的防火墙规则**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)：**允许出站** 和 **拒绝入站**。

创建GCP项目时，还会创建一个名为 **`default`** 的VPC，具有以下防火墙规则：

- **default-allow-internal：** 允许来自 `default` 网络上其他实例的所有流量
- **default-allow-ssh：** 允许来自任何地方的22端口
- **default-allow-rdp：** 允许来自任何地方的3389端口
- **default-allow-icmp：** 允许来自任何地方的ping

{% hint style="warning" %}
正如您所看到的，**防火墙规则** 对于 **内部IP地址** 倾向于 **更具包容性**。默认VPC允许计算实例之间的所有流量。
{% endhint %}

可以为默认VPC或新VPC创建更多 **防火墙规则**。[**防火墙规则**](https://cloud.google.com/vpc/docs/firewalls) 可以通过以下 **方法** 应用于实例：

- [**网络标签**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**服务帐户**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **VPC内的所有实例**

不幸的是，并没有一个简单的 `gcloud` 命令可以列出所有在互联网上开放端口的计算实例。您必须在防火墙规则、网络标签、服务帐户和实例之间建立联系。

可以使用[此Python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)自动化此过程，该脚本将导出以下内容：

- 显示实例、公共IP、允许的TCP、允许的UDP的CSV文件
- 针对从公共互联网（0.0.0.0/0）允许的端口进行的nmap扫描
- 针对允许从公共互联网（0.0.0.0/0）访问所有TCP端口的这些实例的完整TCP范围的masscan扫描

### 分层防火墙策略 <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_分层防火墙策略_ 允许您创建并 **强制执行组织范围内的一致防火墙策略**。您可以将 **分层防火墙策略分配给** 整个组织或单个 **文件夹**。这些策略包含可以明确拒绝或允许连接的规则。

您可以将创建和应用防火墙策略作为单独的步骤。您可以在 [**资源层次结构**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) 的 **组织或文件夹节点** 处创建和应用防火墙策略。防火墙策略规则可以 **阻止连接、允许连接或将防火墙规则评估推迟** 到较低级别文件夹或在VPC网络中定义的VPC防火墙规则。

默认情况下，所有分层防火墙策略规则适用于与策略关联的组织或文件夹下的所有项目中的所有VM。但是，您可以通过指定 [目标网络或目标服务帐户](https://cloud.google.com/vpc/docs/firewall-policies#targets) 来 **限制哪些VM获得特定规则**。

您可以在此处阅读如何 [**创建分层防火墙策略**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)。

### 防火墙规则评估

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. 组织：分配给组织的防火墙策略
2. 文件夹：分配给文件夹的防火墙策略
3. VPC：分配给VPC的防火墙规则
4. 全局：分配给VPC的另一种类型的防火墙规则
5. 区域：与VM的NIC的VPC网络和VM所在区域相关联的防火墙规则。

## VPC网络对等连接

允许连接两个虚拟专用云（VPC）网络，以便 **每个网络中的资源可以相互通信**。\
对等VPC网络可以位于同一项目中、同一组织的不同项目中，或 **不同组织的不同项目中**。

这些是所需的权限：

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**更多信息请参阅文档**](https://cloud.google.com/vpc/docs/vpc-peering)。

## 参考资料

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
