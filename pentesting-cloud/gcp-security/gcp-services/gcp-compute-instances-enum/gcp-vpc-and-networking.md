# GCP - VPC & Networking

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Red de Computaci√≥n de GCP en pocas palabras**

Las **VPCs** contienen reglas de **Firewall** para permitir el tr√°fico entrante a la VPC. Las VPCs tambi√©n contienen **subredes** donde se van a **conectar las m√°quinas virtuales**.\
Comparando con AWS, el **Firewall** ser√≠a lo m√°s **similar** a los **Grupos de Seguridad y NACLs de AWS**, pero en este caso estos est√°n **definidos en la VPC** y no en cada instancia.

## **VPC, Subredes y Firewalls en GCP**

Las Instancias de Computaci√≥n est√°n conectadas a **subredes** que son parte de las **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). En GCP no existen grupos de seguridad, hay [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) con reglas definidas en este nivel de red pero aplicadas a cada Instancia de VM.

### Subredes

Una **VPC** puede tener **varias subredes**. Cada **subred est√° en 1 regi√≥n**.

### Firewalls

Por defecto, cada red tiene dos [**reglas de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir salida** y **denegar entrada**.

Cuando se crea un proyecto de GCP, se crea tambi√©n una VPC llamada **`default`**, con las siguientes reglas de firewall:

* **default-allow-internal:** permite todo el tr√°fico desde otras instancias en la red `default`
* **default-allow-ssh:** permite el puerto 22 desde cualquier lugar
* **default-allow-rdp:** permite el puerto 3389 desde cualquier lugar
* **default-allow-icmp:** permite ping desde cualquier lugar

{% hint style="warning" %}
Como puedes ver, las **reglas de firewall** tienden a ser **m√°s permisivas** para las **direcciones IP internas**. La VPC predeterminada permite todo el tr√°fico entre las Instancias de Computaci√≥n.
{% endhint %}

Se pueden crear m√°s **reglas de firewall** para la VPC predeterminada o para nuevas VPCs. Las [**reglas de firewall**](https://cloud.google.com/vpc/docs/firewalls) se pueden aplicar a las instancias a trav√©s de los siguientes **m√©todos**:

* [**Etiquetas de red**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Cuentas de servicio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas las instancias dentro de una VPC**

Desafortunadamente, no hay un comando `gcloud` simple para mostrar todas las Instancias de Computaci√≥n con puertos abiertos en internet. Debes conectar los puntos entre las reglas de firewall, las etiquetas de red, las cuentas de servicio e instancias.

Este proceso se automatiz√≥ utilizando [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar√° lo siguiente:

* Archivo CSV que muestra la instancia, IP p√∫blica, TCP permitido, UDP permitido
* Escaneo nmap para apuntar a todas las instancias en puertos de ingreso permitidos desde internet p√∫blico (0.0.0.0/0)
* masscan para apuntar al rango completo de TCP de esas instancias que permiten TODOS los puertos TCP desde internet p√∫blico (0.0.0.0/0)

### Pol√≠ticas de Firewall Jer√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Las _pol√≠ticas de firewall jer√°rquicas_ te permiten crear y **aplicar una pol√≠tica de firewall consistente en toda tu organizaci√≥n**. Puedes asignar **pol√≠ticas de firewall jer√°rquicas a la organizaci√≥n** en su totalidad o a **carpetas individuales**. Estas pol√≠ticas contienen reglas que pueden denegar o permitir expl√≠citamente conexiones.

Creas y aplicas pol√≠ticas de firewall como pasos separados. Puedes crear y aplicar pol√≠ticas de firewall en los **nodos de organizaci√≥n o carpeta de la** [**jerarqu√≠a de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regla de pol√≠tica de firewall puede **bloquear conexiones, permitir conexiones o posponer la evaluaci√≥n de la regla de firewall** a reglas de firewall de VPC de carpetas de niveles inferiores o definidas en redes de VPC.

Por defecto, todas las reglas de pol√≠ticas de firewall jer√°rquicas se aplican a todas las VM en todos los proyectos bajo la organizaci√≥n o carpeta donde se asocia la pol√≠tica. Sin embargo, puedes **restringir qu√© VMs obtienen una regla espec√≠fica** especificando [redes de destino o cuentas de servicio de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puedes leer aqu√≠ c√≥mo [**crear una Pol√≠tica de Firewall Jer√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluaci√≥n de Reglas de Firewall

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. Org: Pol√≠ticas de firewall asignadas a la Organizaci√≥n
2. Carpeta: Pol√≠ticas de firewall asignadas a la Carpeta
3. VPC: Reglas de firewall asignadas a la VPC
4. Global: Otro tipo de reglas de firewall que se pueden asignar a VPCs
5. Regional: Reglas de firewall asociadas con la red de VPC de la NIC de la VM y la regi√≥n de la VM.

## Interconexi√≥n de Redes de VPC

Permite conectar dos redes de Virtual Private Cloud (VPC) para que los **recursos en cada red puedan comunicarse** entre s√≠.\
Las redes de VPC interconectadas pueden estar en el mismo proyecto, en diferentes proyectos de la misma organizaci√≥n o en **diferentes proyectos de diferentes organizaciones**.

Estos son los permisos necesarios:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[M√°s en la documentaci√≥n](https://cloud.google.com/vpc/docs/vpc-peering).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
