# GCP - æ—¥å¿—æšä¸¾

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

æ­¤æœåŠ¡å…è®¸ç”¨æˆ·å­˜å‚¨ã€æœç´¢ã€åˆ†æã€ç›‘æ§å’Œè­¦æŠ¥æ¥è‡ªGCPçš„**æ—¥å¿—æ•°æ®å’Œäº‹ä»¶**ã€‚

Cloud Loggingä¸å…¶ä»–GCPæœåŠ¡å®Œå…¨é›†æˆï¼Œä¸ºæ¥è‡ªæ‰€æœ‰GCPèµ„æºçš„æ—¥å¿—æä¾›äº†ä¸€ä¸ªé›†ä¸­å­˜å‚¨åº“ã€‚å®ƒ**è‡ªåŠ¨æ”¶é›†æ¥è‡ªå„ç§GCPæœåŠ¡çš„æ—¥å¿—**ï¼Œå¦‚App Engineã€Compute Engineå’ŒCloud Functionsã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨Cloud Loggingä»£ç†æˆ–APIï¼Œä¸ºåœ¨æœ¬åœ°æˆ–å…¶ä»–äº‘ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºä½¿ç”¨Cloud Loggingã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

* **æ—¥å¿—æ•°æ®é›†ä¸­åŒ–ï¼š** ä»å„ç§æ¥æºèšåˆæ—¥å¿—æ•°æ®ï¼Œæä¾›å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºå’ŒåŸºç¡€è®¾æ–½çš„å…¨é¢è§†å›¾ã€‚
* **å®æ—¶æ—¥å¿—ç®¡ç†ï¼š** å®æ—¶æµå¼ä¼ è¾“æ—¥å¿—ï¼Œä»¥ä¾¿ç«‹å³åˆ†æå’Œå“åº”ã€‚
* **å¼ºå¤§çš„æ•°æ®åˆ†æï¼š** ä½¿ç”¨é«˜çº§è¿‡æ»¤å’Œæœç´¢åŠŸèƒ½å¿«é€Ÿç­›é€‰å¤§é‡æ—¥å¿—æ•°æ®ã€‚
* **ä¸BigQueryé›†æˆï¼š** å°†æ—¥å¿—å¯¼å‡ºåˆ°BigQueryè¿›è¡Œè¯¦ç»†åˆ†æå’ŒæŸ¥è¯¢ã€‚
* **åŸºäºæ—¥å¿—çš„æŒ‡æ ‡ï¼š** ä»æ‚¨çš„æ—¥å¿—æ•°æ®åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§å’Œè­¦æŠ¥ã€‚

### æ—¥å¿—æµ

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œsinkså’ŒåŸºäºæ—¥å¿—çš„æŒ‡æ ‡å°†å†³å®šæ—¥å¿—åº”è¯¥å­˜å‚¨åœ¨å“ªé‡Œã€‚

### GCPæ—¥å¿—æ”¯æŒçš„é…ç½®

Cloud Loggingçš„é…ç½®é«˜åº¦å¯å®šåˆ¶ï¼Œä»¥æ»¡è¶³ä¸åŒçš„è¿è¥éœ€æ±‚ï¼š

1. **æ—¥å¿—å­˜å‚¨æ¡¶ï¼ˆç½‘é¡µä¸­çš„æ—¥å¿—å­˜å‚¨ï¼‰ï¼š** åœ¨Cloud Loggingä¸­å®šä¹‰å­˜å‚¨æ¡¶æ¥ç®¡ç†**æ—¥å¿—ä¿ç•™**ï¼Œæ§åˆ¶æ—¥å¿—æ¡ç›®ä¿ç•™çš„æ—¶é—´é•¿çŸ­ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šåˆ›å»ºå­˜å‚¨æ¡¶`_Default`å’Œ`_Required`ï¼ˆä¸€ä¸ªè®°å½•å¦ä¸€ä¸ªæ²¡æœ‰è®°å½•çš„å†…å®¹ï¼‰ã€‚
*   **\_Required** æ˜¯ï¼š

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* æ•°æ®çš„**ä¿ç•™æœŸé™**æŒ‰å­˜å‚¨æ¡¶é…ç½®ï¼Œè‡³å°‘**1å¤©**ã€‚ç„¶è€Œï¼Œ**\_Requiredçš„ä¿ç•™æœŸé™æ˜¯400å¤©**ï¼Œä¸”æ— æ³•ä¿®æ”¹ã€‚
* æ³¨æ„ï¼Œæ—¥å¿—å­˜å‚¨æ¡¶åœ¨Cloud Storageä¸­**ä¸å¯è§**ã€‚
2. **æ—¥å¿—æ¥æ”¶å™¨ï¼ˆç½‘é¡µä¸­çš„æ—¥å¿—è·¯ç”±å™¨ï¼‰ï¼š** åˆ›å»ºæ¥æ”¶å™¨ä»¥æ ¹æ®**è¿‡æ»¤å™¨**å°†æ—¥å¿—æ¡ç›®**å¯¼å‡º**åˆ°å„ç§ç›®çš„åœ°ï¼Œå¦‚Pub/Subã€BigQueryæˆ–Cloud Storageã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä¸ºå­˜å‚¨æ¡¶`_Default`å’Œ`_Required`åˆ›å»ºæ¥æ”¶å™¨ï¼š
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **æ’é™¤è¿‡æ»¤å™¨ï¼š** å¯ä»¥è®¾ç½®**æ’é™¤**ï¼Œä»¥é˜²æ­¢ç‰¹å®šæ—¥å¿—æ¡ç›®è¢«æ‘„å–ï¼ŒèŠ‚çœæˆæœ¬å¹¶å‡å°‘ä¸å¿…è¦çš„å¹²æ‰°ã€‚
3. **åŸºäºæ—¥å¿—çš„æŒ‡æ ‡ï¼š** æ ¹æ®æ—¥å¿—å†…å®¹é…ç½®**è‡ªå®šä¹‰æŒ‡æ ‡**ï¼Œå…è®¸åŸºäºæ—¥å¿—æ•°æ®è¿›è¡Œè­¦æŠ¥å’Œç›‘æ§ã€‚
4. **æ—¥å¿—è§†å›¾ï¼š** æ—¥å¿—è§†å›¾æä¾›äº†é«˜çº§å’Œ**ç»†ç²’åº¦çš„æ§åˆ¶**ï¼Œæ§åˆ¶è°å¯ä»¥è®¿é—®æ‚¨çš„æ—¥å¿—å­˜å‚¨æ¡¶ä¸­çš„æ—¥å¿—ã€‚&#x20;
* Cloud Loggingä¸ºæ¯ä¸ªå­˜å‚¨æ¡¶**è‡ªåŠ¨åˆ›å»º`_AllLogs`è§†å›¾**ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—ã€‚Cloud Loggingè¿˜ä¸º`_Default`å­˜å‚¨æ¡¶åˆ›å»ºäº†ä¸€ä¸ªåä¸º`_Default`çš„è§†å›¾ã€‚`_Default`å­˜å‚¨æ¡¶çš„`_Default`è§†å›¾æ˜¾ç¤ºé™¤æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—ä¹‹å¤–çš„æ‰€æœ‰æ—¥å¿—ã€‚`_AllLogs`å’Œ`_Default`è§†å›¾ä¸å¯ç¼–è¾‘ã€‚



å¯ä»¥å…è®¸ä¸€ä¸ªä¸»ä½“**ä»…ä½¿ç”¨ç‰¹å®šçš„æ—¥å¿—è§†å›¾**ï¼Œé€šè¿‡IAMç­–ç•¥ï¼Œå¦‚ï¼š
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### æšä¸¾

`gcloud` å‘½ä»¤è¡Œå·¥å…·æ˜¯ GCP ç”Ÿæ€ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå…è®¸æ‚¨ç®¡ç†èµ„æºå’ŒæœåŠ¡ã€‚ä»¥ä¸‹æ˜¯æ‚¨å¦‚ä½•ä½¿ç”¨ `gcloud` æ¥ç®¡ç†æ—¥å¿—é…ç½®å’Œè®¿é—®æ—¥å¿—ã€‚

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

æ£€æŸ¥ **`cloudresourcemanager`** æ—¥å¿—çš„ç¤ºä¾‹ï¼ˆç”¨äºæš´åŠ›ç ´è§£æƒé™ï¼‰ï¼š[https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

**`testIamPermissions`** æ²¡æœ‰æ—¥å¿—ï¼š

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### æ¸—é€åæ“ä½œ

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…åŒ–

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
