# GCP - Protokollierungsenum

<details>

<summary><strong>Erlernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

Dieser Dienst erm√∂glicht es Benutzern, **Protokolldaten und Ereignisse** aus GCP zu speichern, zu durchsuchen, zu analysieren, zu √ºberwachen und Alarme zu setzen.

Cloud Logging ist vollst√§ndig in andere GCP-Dienste integriert und bietet ein zentrales Repository f√ºr Protokolle von allen Ihren GCP-Ressourcen. Es **sammelt automatisch Protokolle von verschiedenen GCP-Diensten** wie App Engine, Compute Engine und Cloud Functions. Sie k√∂nnen Cloud Logging auch f√ºr Anwendungen verwenden, die lokal oder in anderen Clouds ausgef√ºhrt werden, indem Sie den Cloud Logging-Agent oder die API verwenden.

Hauptfunktionen:

* **Zentralisierung von Protokolldaten:** Aggregieren Sie Protokolldaten aus verschiedenen Quellen und bieten Sie einen ganzheitlichen √úberblick √ºber Ihre Anwendungen und Infrastruktur.
* **Echtzeit-Protokollverwaltung:** Streamen Sie Protokolle in Echtzeit f√ºr sofortige Analyse und Reaktion.
* **Leistungsstarke Datenanalyse:** Verwenden Sie erweiterte Filter- und Suchfunktionen, um schnell durch gro√üe Mengen von Protokolldaten zu navigieren.
* **Integration mit BigQuery:** Exportieren Sie Protokolle nach BigQuery f√ºr detaillierte Analyse und Abfrage.
* **Protokollbasierte Metriken:** Erstellen Sie benutzerdefinierte Metriken aus Ihren Protokolldaten f√ºr √úberwachung und Alarmierung.

### Protokollfluss

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Grunds√§tzlich legen die Sinks und protokollbasierten Metriken fest, wo ein Protokoll gespeichert werden soll.

### Von GCP Logging unterst√ºtzte Konfigurationen

Cloud Logging ist hoch konfigurierbar, um unterschiedlichen betrieblichen Anforderungen gerecht zu werden:

1. **Protokoll-Buckets (Protokollspeicher im Web):** Definieren Sie Buckets in Cloud Logging, um die **Protokollaufbewahrung** zu verwalten und die Dauer festzulegen, f√ºr die Ihre Protokolle aufbewahrt werden.
* Standardm√§√üig werden die Buckets `_Default` und `_Required` erstellt (einer protokolliert, was der andere nicht protokolliert).
*   **\_Required** ist:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* Die **Aufbewahrungsfrist** der Daten wird pro Bucket konfiguriert und muss **mindestens 1 Tag betragen**. Die **Aufbewahrungsfrist von \_Required betr√§gt jedoch 400 Tage** und kann nicht ge√§ndert werden.
* Beachten Sie, dass Protokoll-Buckets **in Cloud Storage nicht sichtbar sind**.
2. **Protokoll-Sinks (Protokollrouter im Web):** Erstellen Sie Sinks, um Protokolleintr√§ge basierend auf einem **Filter** an verschiedene Ziele wie Pub/Sub, BigQuery oder Cloud Storage zu **exportieren**.
* Standardm√§√üig werden Sinks f√ºr die Buckets `_Default` und `_Required` erstellt:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Ausschlussfilter:** Es ist m√∂glich, **Ausschl√ºsse einzurichten, um zu verhindern, dass bestimmte Protokolleintr√§ge** erfasst werden, um Kosten zu sparen und unn√∂tigen L√§rm zu reduzieren.
3. **Protokollbasierte Metriken:** Konfigurieren Sie **benutzerdefinierte Metriken** basierend auf dem Inhalt von Protokollen, um Alarme und √úberwachung basierend auf Protokolldaten zu erm√∂glichen.
4. **Protokollansichten:** Protokollansichten bieten eine erweiterte und **granulare Kontrolle dar√ºber, wer auf die Protokolle in Ihren Protokoll-Buckets zugreifen kann**.
* Cloud Logging erstellt **automatisch die Ansicht `_AllLogs` f√ºr jeden Bucket**, die alle Protokolle anzeigt. Cloud Logging erstellt auch eine Ansicht f√ºr den Bucket `_Default` namens `_Default`. Die Ansichten `_AllLogs` und `_Default` sind nicht bearbeitbar.



Es ist m√∂glich, einem Prinzipal zu erlauben, **nur eine bestimmte Protokollansicht** mit einer IAM-Richtlinie zu verwenden:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### Standardprotokolle

Standardm√§√üig werden **Admin Write**-Operationen (auch als Admin-Aktivit√§tspr√ºfprotokolle bezeichnet) protokolliert (Metadaten oder Konfigurationsinformationen schreiben) und **k√∂nnen nicht deaktiviert werden**.

Anschlie√üend kann der Benutzer **Data Access Audit-Logs** aktivieren, die **Admin Read, Data Write und Data Write** umfassen.

Weitere Informationen zu jedem Protokolltyp finden Sie in der Dokumentation: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Es sei jedoch darauf hingewiesen, dass dies bedeutet, dass standardm√§√üig Aktionen wie **`GetIamPolicy`** und andere Leseaktionen **nicht protokolliert werden**. Ein Angreifer, der standardm√§√üig versucht, die Umgebung aufzulisten, wird also nicht erfasst, wenn der Systemadministrator nicht konfiguriert hat, um mehr Protokolle zu generieren.

Um mehr Protokolle in der Konsole zu aktivieren, muss der Systemadministrator zu [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) gehen und sie aktivieren. Es gibt 2 verschiedene Optionen:

* **Standardkonfiguration**: Es ist m√∂glich, eine Standardkonfiguration zu erstellen und alle Admin Read und/oder Data Read und/oder Data Write-Protokolle zu protokollieren und sogar ausgenommene Prinzipale hinzuzuf√ºgen:

<figure><img src="../../../.gitbook/assets/image (149).png" alt=""><figcaption></figcaption></figure>

* **Dienste ausw√§hlen**: Oder einfach die **Dienste ausw√§hlen**, f√ºr die Sie Protokolle generieren m√∂chten, sowie den Protokolltyp und den ausgenommenen Prinzipal f√ºr diesen spezifischen Dienst.

Bitte beachten Sie auch, dass standardm√§√üig nur diese Protokolle generiert werden, da das Generieren weiterer Protokolle die Kosten erh√∂hen wird.

### Aufz√§hlung

Das `gcloud`-Befehlszeilentool ist ein integraler Bestandteil des GCP-√ñkosystems und erm√∂glicht es Ihnen, Ihre Ressourcen und Dienste zu verwalten. Hier erfahren Sie, wie Sie `gcloud` verwenden k√∂nnen, um Ihre Protokollkonfigurationen und Zugriffsprotokolle zu verwalten.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Beispiel zum √úberpr√ºfen der Protokolle von **`cloudresourcemanager`** (der zur BF-Berechtigungen verwendet wird): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Es gibt keine Protokolle von **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### Post-Exploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistenz

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
