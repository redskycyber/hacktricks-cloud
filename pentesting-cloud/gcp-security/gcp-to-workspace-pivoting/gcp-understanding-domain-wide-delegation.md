# GCP - Razumevanje Delegacije na Nivou Domena

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Ovaj post je uvod u [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) gde mo쬰te prona캖i vi코e detalja.

## **Razumevanje Delegacije na Nivou Domena**

Delegacija na nivou domena u Google Workspace-u omogu캖ava objektu identiteta, bilo da je to **spoljni aplikacija** sa Google Workspace Marketplace-a ili interni **GCP Service Account**, da **pristupi podacima 코irom Workspace-a u ime korisnika**. Ova funkcija, koja je klju캜na za aplikacije koje interaguju sa Google API-jima ili uslugama koje zahtevaju impersonaciju korisnika, pobolj코ava efikasnost i minimizira ljudske gre코ke automatizacijom zadataka. Kori코캖enjem OAuth 2.0, razvojni programeri aplikacija i administratori mogu dati ovim servisnim nalozima pristup korisni캜kim podacima bez pojedina캜ne saglasnosti korisnika.\
\
Google Workspace omogu캖ava kreiranje dva glavna tipa globalnih delegiranih objekata identiteta:

* **GWS Aplikacije:** Aplikacije sa Workspace Marketplace-a mogu biti postavljene kao delegirani identitet. Pre nego 코to postanu dostupne na tr쬴코tu, svaka aplikacija Workspace-a prolazi kroz pregled od strane Google-a kako bi se minimizirala mogu캖nost zloupotrebe. Iako ovo ne elimini코e potpuno rizik od zloupotrebe, zna캜ajno pove캖ava te쬴nu za takve incidente da se dese.
* **GCP Service Account:** Saznajte vi코e o [**GCP Service Accounts ovde**](../gcp-basic-information/#service-accounts).

### **Delegacija na Nivou Domena: Iznutra**

Ovako GCP Service Account mo쬰 pristupiti Google API-jima u ime drugih identiteta u Google Workspace-u:

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Identitet kreira JWT:** Identitet koristi privatni klju캜 servisnog naloga (deo JSON klju캜nog para fajla) da potpi코e JWT. Ovaj JWT sadr쬴 tvrdnje o servisnom nalogu, ciljanom korisniku za impersonaciju i OAuth opsege pristupa REST API-ju koji se zahteva.
2. **Identitet koristi JWT za zahtevanje pristupnog tokena:** Aplikacija/korisnik koristi JWT za zahtevanje pristupnog tokena od Google-ovog OAuth 2.0 servisa. Zahtev tako캠e uklju캜uje ciljanog korisnika za impersonaciju (email korisnika Workspace-a) i opsege za koje se zahteva pristup.
3. **Google-ov OAuth 2.0 servis vra캖a pristupni token:** Pristupni token predstavlja ovla코캖enje servisnog naloga da deluje u ime korisnika za odre캠ene opsege. Ovaj token je obi캜no kratkotrajan i mora se osve쬬vati periodi캜no (prema potrebi aplikacije). Va쬹o je razumeti da OAuth opsezi navedeni u JWT tokenu imaju va쬹ost i uticaj na rezultantni pristupni token. Na primer, pristupni tokeni koji poseduju vi코e opsega 캖e biti va쬰캖i za brojne REST API aplikacije.
4. **Identitet koristi pristupni token za pozivanje Google API-ja**: Sada sa relevantnim pristupnim tokenom, servis mo쬰 pristupiti potrebnom REST API-ju. Aplikacija koristi ovaj pristupni token u "Authorization" zaglavlju svojih HTTP zahteva namenjenih Google API-jima. Ovi API-ji koriste token za proveru impersoniranog identiteta i potvrdu da ima neophodnu autorizaciju.
5. **Google API-ji vra캖aju tra쬰ne podatke**: Ako je pristupni token validan i servisni nalog ima odgovaraju캖u autorizaciju, Google API-ji vra캖aju tra쬰ne podatke. Na primer, u slede캖oj slici, iskoristili smo _users.messages.list_ metod da bismo naveli sve Gmail ID poruka povezanih sa ciljanim korisnikom Workspace-a.
