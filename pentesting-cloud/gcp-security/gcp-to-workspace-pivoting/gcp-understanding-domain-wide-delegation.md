# GCP - Understanding Domain-Wide Delegation

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Este post es la introducci贸n de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) al que se puede acceder para m谩s detalles.

## **Entendiendo la Delegaci贸n a Nivel de Dominio**

La delegaci贸n a nivel de dominio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci贸n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP**, **acceda a datos a trav茅s de Workspace en nombre de los usuarios**. Esta caracter铆stica, crucial para aplicaciones que interact煤an con las APIs de Google o servicios que necesitan suplantaci贸n de usuario, mejora la eficiencia y minimiza el error humano automatizando tareas. Utilizando OAuth 2.0, los desarrolladores de aplicaciones y administradores pueden dar a estas cuentas de servicio acceso a datos de usuario sin el consentimiento individual de cada uno.\
\
Google Workspace permite la creaci贸n de dos tipos principales de identidades delegadas globales:

* **Aplicaciones GWS:** Las aplicaciones del Marketplace de Workspace pueden configurarse como una identidad delegada. Antes de estar disponibles en el marketplace, cada aplicaci贸n de Workspace pasa por una revisi贸n de Google para minimizar el posible mal uso. Aunque esto no elimina completamente el riesgo de abuso, aumenta significativamente la dificultad para que ocurran tales incidentes.
* **Cuenta de Servicio de GCP:** Aprende m谩s sobre [**Cuentas de Servicio de GCP aqu铆**](../gcp-basic-information/#service-accounts).

### **Delegaci贸n a Nivel de Dominio: Detr谩s de las Escenas**

As铆 es como una Cuenta de Servicio de GCP puede acceder a las APIs de Google en nombre de otras identidades en Google Workspace:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **La Identidad crea un JWT:** La Identidad utiliza la clave privada de la cuenta de servicio (parte del archivo de par de claves JSON) para firmar un JWT. Este JWT contiene afirmaciones sobre la cuenta de servicio, el usuario objetivo a suplantar y los alcances de OAuth para acceder a la API REST que se est谩 solicitando.
2. **La Identidad utiliza el JWT para solicitar un token de acceso:** La aplicaci贸n/usuario utiliza el JWT para solicitar un token de acceso del servicio OAuth 2.0 de Google. La solicitud tambi茅n incluye el usuario objetivo a suplantar (el correo electr贸nico de Workspace del usuario) y los alcances para los cuales se solicita acceso.
3. **El servicio OAuth 2.0 de Google devuelve un token de acceso:** El token de acceso representa la autoridad de la cuenta de servicio para actuar en nombre del usuario para los alcances especificados. Este token generalmente tiene una vida corta y debe actualizarse peri贸dicamente (seg煤n la necesidad de la aplicaci贸n). Es esencial entender que los alcances de OAuth especificados en el token JWT tienen validez e impacto en el token de acceso resultante. Por ejemplo, los tokens de acceso que poseen m煤ltiples alcances tendr谩n validez para numerosas aplicaciones de API REST.
4. **La Identidad utiliza el token de acceso para llamar a las APIs de Google**: Ahora con un token de acceso relevante, el servicio puede acceder a la API REST requerida. La aplicaci贸n utiliza este token de acceso en el encabezado "Authorization" de sus solicitudes HTTP destinadas a las APIs de Google. Estas APIs utilizan el token para verificar la identidad suplantada y confirmar que tiene la autorizaci贸n necesaria.
5. **Las APIs de Google devuelven los datos solicitados**: Si el token de acceso es v谩lido y la cuenta de servicio tiene la autorizaci贸n adecuada, las APIs de Google devuelven los datos solicitados. Por ejemplo, en la siguiente imagen, hemos utilizado el m茅todo _users.messages.list_ para listar todos los IDs de mensajes de Gmail asociados con un usuario objetivo de Workspace.

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
