# GCP <--> Workspace Pivoting

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**'Ä± takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## **GCP'den GWS'ye**

### **Alan GeniÅŸ Yetkilendirme temelleri**

Google Workspace'in Alan GeniÅŸ Yetkilendirme Ã¶zelliÄŸi, bir **harici uygulama** (Google Workspace Marketplace'den) veya iÃ§ **GCP Hizmet HesabÄ±**nÄ±n, **kullanÄ±cÄ±lar adÄ±na Workspace Ã¼zerindeki verilere eriÅŸmesine izin verir**.

{% hint style="info" %}
Bu temelde, bir organizasyonun GCP projelerindeki **hizmet hesaplarÄ±**, aynÄ± organizasyonun (veya farklÄ± bir organizasyonun) Workspace kullanÄ±cÄ±larÄ±nÄ± **taklit edebilir**.
{% endhint %}

Bu nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ± hakkÄ±nda daha fazla bilgi iÃ§in ÅŸuraya bakÄ±n:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Mevcut yetkilendirmeyi tehlikeye atma

EÄŸer bir saldÄ±rgan **GCP Ã¼zerinde bazÄ± eriÅŸimleri ele geÃ§irdiyse** ve ÅŸirketin **geÃ§erli bir Workspace kullanÄ±cÄ± e-postasÄ±nÄ±** (tercihen **sÃ¼per yÃ¶netici**) bildiÄŸi durumda, **eriÅŸimi olan tÃ¼m projeleri sÄ±ralayabilir**, projelerin **tÃ¼m hizmet hesaplarÄ±nÄ± sÄ±ralayabilir**, hangi **hizmet hesaplarÄ±na eriÅŸimi olduÄŸunu** kontrol edebilir ve her bir hizmet hesabÄ± ile bu adÄ±mlarÄ± **tekrarlayabilir**.\
EriÅŸime sahip olduÄŸu **tÃ¼m hizmet hesaplarÄ± listesi** ve **Workspace e-postalarÄ±** listesi ile saldÄ±rgan, her bir hizmet hesabÄ± ile kullanÄ±cÄ±yÄ± **taklit etmeyi deneyebilir**.

{% hint style="danger" %}
Alan geniÅŸ yetkilendirme yapÄ±landÄ±rÄ±lÄ±rken bir Workspace kullanÄ±cÄ±sÄ±na ihtiyaÃ§ duyulmaz, bu nedenle sadece **geÃ§erli bir tanesini bilmek yeterlidir ve taklit iÃ§in gereklidir**.\
Ancak, taklit edilen kullanÄ±cÄ±nÄ±n **yetkileri kullanÄ±lacaktÄ±r**, bu nedenle SÃ¼per YÃ¶netici ise her ÅŸeye eriÅŸebilirsiniz. EÄŸer hiÃ§bir eriÅŸimi yoksa bu iÅŸe yaramaz olacaktÄ±r.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, aÅŸaÄŸÄ±daki adÄ±mlarÄ± takip ederek saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirebilen bir araÃ§tÄ±r:

1. Kaynak YÃ¶neticisi API'sÄ±nÄ± kullanarak **GCP Projelerini sÄ±ralayÄ±n**.
2. Her proje kaynaÄŸÄ±nda dÃ¶ngÃ¼ oluÅŸturun ve baÅŸlangÄ±Ã§taki IAM kullanÄ±cÄ±sÄ±nÄ±n eriÅŸimi olan **GCP Hizmet hesabÄ± kaynaklarÄ±nÄ± sÄ±ralayÄ±n**.
3. **Her hizmet hesabÄ± rolÃ¼** Ã¼zerinde dÃ¶ngÃ¼ oluÅŸturun ve _GetIAMPolicy_ kullanarak hedef hizmet hesabÄ± kaynaÄŸÄ±nda _**serviceAccountKeys.create**_ iznine sahip yerleÅŸik, temel ve Ã¶zel rolleri bulun. EditÃ¶r rolÃ¼nÃ¼n bu izne sahip olduÄŸu doÄŸal olarak bilinmelidir.
4. IAM politikasÄ±nda ilgili izne sahip **her hizmet hesabÄ± kaynaÄŸÄ± iÃ§in yeni bir `KEY_ALG_RSA_2048`** Ã¶zel anahtarÄ± oluÅŸturun.
5. **Her yeni hizmet hesabÄ± Ã¼zerinde dÃ¶ngÃ¼ oluÅŸturun ve onun iÃ§in bir `JWT`** **nesnesi** oluÅŸturun. Bu, SA Ã¶zel anahtar kimlik bilgileri ve bir OAuth kapsamÄ±ndan oluÅŸan bir JWT nesnesi oluÅŸturma sÃ¼recidir. Yeni bir _JWT_ nesnesi oluÅŸturma sÃ¼reci, tÃ¼m var olan OAuth kapsamÄ± kombinasyonlarÄ± Ã¼zerinde dÃ¶ngÃ¼ oluÅŸturacak ve Workspace kimliklerini kÃ¶tÃ¼ye kullanmak iÃ§in ilgili olan tÃ¼m yetkilendirme olasÄ±lÄ±klarÄ±nÄ± bulmak iÃ§in **oauth\_scopes.txt** listesinden geÃ§ecektir. **oauth\_scopes.txt** listesi, Workspace kimliklerini kÃ¶tÃ¼ye kullanmak iÃ§in ilgili bulduÄŸumuz tÃ¼m OAuth kapsamlarÄ± ile gÃ¼ncellenmiÅŸtir.
6. `_make_authorization_grant_assertion` yÃ¶ntemi, DWD altÄ±nda JWT'ler oluÅŸturmak iÃ§in bir _hedef workspace kullanÄ±cÄ±sÄ±nÄ±_ belirtme gerekliliÄŸini ortaya koymaktadÄ±r. Bu belirli bir kullanÄ±cÄ± gibi gÃ¶rÃ¼nse de, Ã¶nemli olan **DWD'nin bir alan iÃ§indeki her kimliÄŸi etkilemesidir**. SonuÃ§ olarak, herhangi bir alan kullanÄ±cÄ±sÄ± iÃ§in bir JWT oluÅŸturmak, o alanÄ±n tÃ¼m kimliklerini etkiler, kombinasyon sÄ±ralama kontrolÃ¼mÃ¼zle tutarlÄ±dÄ±r. BasitÃ§e sÃ¶ylemek gerekirse, ilerlemek iÃ§in geÃ§erli bir Workspace kullanÄ±cÄ±sÄ± yeterlidir.\
Bu kullanÄ±cÄ±, DeleFriend'in _config.yaml_ dosyasÄ±nda tanÄ±mlanabilir. EÄŸer hedef workspace kullanÄ±cÄ±sÄ± zaten bilinmiyorsa, araÃ§, GCP projelerinde rolleri olan alan kullanÄ±cÄ±larÄ±nÄ± tarayarak geÃ§erli workspace kullanÄ±cÄ±larÄ±nÄ± otomatik olarak tanÄ±mlamayÄ± kolaylaÅŸtÄ±rÄ±r. (Tekrar belirtmek gerekirse) JWT'ler alan Ã¶zgÃ¼l olup her kullanÄ±cÄ± iÃ§in oluÅŸturulmaz; bu nedenle otomatik sÃ¼reÃ§, her alan iÃ§in tek bir benzersiz kimliÄŸi hedef alÄ±r.
7. **Her JWT iÃ§in yeni bir taÅŸÄ±yÄ±cÄ± eriÅŸim belirteci oluÅŸturun** ve belirteci tokeninfo API'sine karÅŸÄ± doÄŸrulayÄ±n.

#### [Gitlab'Ä±n Python betiÄŸi](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, [bu Python betiÄŸini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluÅŸturdu. Bu betik, kullanÄ±cÄ± dizinini listeler ve bir json ile belirtilen SA kimlik bilgileri ve taklit edilecek kullanÄ±cÄ± ile yeni bir yÃ¶netici hesabÄ± oluÅŸturabilir. Ä°ÅŸte nasÄ±l kullanÄ±lÄ±r:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir yetkilendirme oluÅŸturun (KalÄ±cÄ±lÄ±k)

**Domain GeniÅŸ Yetkilendirmeleri kontrol edilebilir** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Bir saldÄ±rgan, bir GCP projesinde **hizmet hesaplarÄ± oluÅŸturma yeteneÄŸine** ve **GWS'de sÃ¼per yÃ¶netici ayrÄ±calÄ±ÄŸÄ±na** sahip olarak, SAs'nin bazÄ± GWS kullanÄ±cÄ±larÄ±nÄ± taklit etmelerine izin veren yeni bir yetkilendirme oluÅŸturabilir:

1. **Yeni bir Hizmet HesabÄ± ve Ä°lgili Anahtar Ã‡ifti OluÅŸturma:** GCP'de, yeni hizmet hesabÄ± kaynaklarÄ± ya konsol aracÄ±lÄ±ÄŸÄ±yla etkileÅŸimli olarak ya da doÄŸrudan API Ã§aÄŸrÄ±larÄ± ve CLI araÃ§larÄ± kullanÄ±larak programatik olarak Ã¼retilebilir. Bu, **rol `iam.serviceAccountAdmin`** veya **`iam.serviceAccounts.create`** **izinini** iÃ§eren herhangi bir Ã¶zel rol gerektirir. Hizmet hesabÄ± oluÅŸturulduktan sonra, ilgili bir **anahtar Ã§ifti oluÅŸturacaÄŸÄ±z** (**`iam.serviceAccountKeys.create`** izni).
2. **Yeni yetkilendirme oluÅŸturma**: **YalnÄ±zca SÃ¼per YÃ¶netici rolÃ¼nÃ¼n Google Workspace'te genel Domain GeniÅŸ yetkilendirme kurma yeteneÄŸine sahip olduÄŸunu** ve Domain GeniÅŸ yetkilendirmenin **programatik olarak yapÄ±landÄ±rÄ±lamayacaÄŸÄ±nÄ±**, yalnÄ±zca Google Workspace **konsolu** aracÄ±lÄ±ÄŸÄ±yla **manuel olarak** oluÅŸturulabileceÄŸini anlamak Ã¶nemlidir.
* KuralÄ±n oluÅŸturulmasÄ±, **API kontrolleri â†’ Google Workspace YÃ¶netici konsolunda Domain GeniÅŸ yetkilendirmeyi YÃ¶net** sayfasÄ±nda bulunabilir.
3. **OAuth kapsam ayrÄ±calÄ±klarÄ±nÄ± eklemek**: Yeni bir yetkilendirme yapÄ±landÄ±rÄ±lÄ±rken, Google yalnÄ±zca 2 parametre gerektirir, GCP Hizmet HesabÄ±nÄ±n **OAuth KimliÄŸi** ve yetkilendirmenin hangi API Ã§aÄŸrÄ±larÄ±nÄ± gerektirdiÄŸini tanÄ±mlayan **OAuth kapsamlarÄ±**.
* **OAuth kapsamlarÄ±nÄ±n tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir Ã¶neri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Hedef kimlik adÄ±na hareket etme:** Bu noktada, GWS'de iÅŸlevsel bir yetkilendirilmiÅŸ nesnemiz var. Åimdi, **GCP Hizmet HesabÄ± Ã¶zel anahtarÄ± kullanarak API Ã§aÄŸrÄ±larÄ± yapabiliriz** (OAuth kapsam parametresinde tanÄ±mlanan kapsamda) ve **Google Workspace'de var olan herhangi bir kimlik adÄ±na hareket edebiliriz**. Hizmet hesabÄ±nÄ±n REST API uygulamalarÄ± iÃ§in ihtiyaÃ§larÄ±na gÃ¶re eriÅŸim belirteÃ§leri oluÅŸturacaÄŸÄ±nÄ± ve izinlerine gÃ¶re hareket edeceÄŸini Ã¶ÄŸrendik.
* Bu yetkilendirmeyi kullanmak iÃ§in bazÄ± **araÃ§lar** iÃ§in **Ã¶nceki bÃ¶lÃ¼me** bakÄ±n.

#### Kurumsal Ã‡apta Yetkilendirme

OAuth SA KimliÄŸi kÃ¼reseldir ve **kurumsal Ã§apta yetkilendirme** iÃ§in kullanÄ±labilir. Ã‡apraz-global yetkilendirme engellemek iÃ§in herhangi bir kÄ±sÄ±tlama uygulanmamÄ±ÅŸtÄ±r. BasitÃ§e ifade etmek gerekirse, **farklÄ± GCP organizasyonlarÄ±ndan hizmet hesaplarÄ±, diÄŸer Workspace organizasyonlarÄ±nda alan geniÅŸ yetkilendirme yapÄ±landÄ±rabilir**. Bu, yalnÄ±zca Workspace'e SÃ¼per YÃ¶netici eriÅŸimine ihtiyaÃ§ duyulacaÄŸÄ± anlamÄ±na gelir ve saldÄ±rgan, Hizmet HesaplarÄ± ve Ã¶zel anahtarlarÄ±nÄ± kendi kontrol ettiÄŸi GCP hesabÄ±nda oluÅŸturabilir.

### Workspace'Ä± numaralandÄ±rmak iÃ§in bir Proje oluÅŸturma

**VarsayÄ±lan olarak** Workspace **kullanÄ±cÄ±larÄ±**, **yeni projeler oluÅŸturma iznine** sahiptir ve yeni bir proje oluÅŸturulduÄŸunda **oluÅŸturucu Ã¼zerinde Sahip rolÃ¼** alÄ±r.

Bu nedenle, bir kullanÄ±cÄ± bir proje **oluÅŸturabilir**, yeni projesinde Workspace'Ä± numaralandÄ±rmak iÃ§in **API'leri etkinleÅŸtirebilir** ve onu **numaralandÄ±rmaya** Ã§alÄ±ÅŸabilir.

{% hint style="danger" %}
Bir kullanÄ±cÄ±nÄ±n Workspace'Ä± numaralandÄ±rabilmesi iÃ§in yeterli Workspace iznine de ihtiyacÄ± vardÄ±r (her kullanÄ±cÄ± dizini numaralandÄ±ramayabilir).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**Daha fazla numaralandÄ±rma iÃ§in kontrol edin**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloud KÃ¶tÃ¼ye KullanÄ±mÄ±

`gcloud` akÄ±ÅŸÄ± hakkÄ±nda daha fazla bilgiyi aÅŸaÄŸÄ±daki baÄŸlantÄ±da bulabilirsiniz:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Orada aÃ§Ä±klandÄ±ÄŸÄ± gibi, gcloud, kullanÄ±cÄ±nÄ±n sÃ¼rÃ¼cÃ¼sÃ¼ne eriÅŸim saÄŸlayacak olan `https://www.googleapis.com/auth/drive` kapsamÄ±nÄ± isteyebilir.\
Bir saldÄ±rgan olarak, bir kullanÄ±cÄ±nÄ±n bilgisayarÄ±nÄ± **fiziksel olarak** ele geÃ§irdiyseniz ve **kullanÄ±cÄ± hala oturum aÃ§Ä±k** ise, kullanÄ±cÄ± hesabÄ±yla sÃ¼rÃ¼cÃ¼ye eriÅŸime izin veren bir belge oluÅŸturarak oturum aÃ§abilirsiniz:
```bash
gcloud auth login --enable-gdrive-access
```
EÄŸer bir saldÄ±rgan bir kullanÄ±cÄ±nÄ±n bilgisayarÄ±nÄ± ele geÃ§irirse, `google-cloud-sdk/lib/googlecloudsdk/core/config.py` dosyasÄ±nÄ± deÄŸiÅŸtirip **`CLOUDSDK_SCOPES`** iÃ§ine **`'https://www.googleapis.com/auth/drive'`** kapsamÄ±nÄ± ekleyebilir:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Bu nedenle, kullanÄ±cÄ± bir sonraki oturum aÃ§tÄ±ÄŸÄ±nda, saldÄ±rganÄ±n sÃ¼rÃ¼cÃ¼ye eriÅŸim saÄŸlayabileceÄŸi bir **jeton oluÅŸturacak**. AÃ§Ä±kÃ§asÄ±, tarayÄ±cÄ± oluÅŸturulan jetonun sÃ¼rÃ¼cÃ¼ye eriÅŸim saÄŸlayacaÄŸÄ±nÄ± belirtecektir, ancak kullanÄ±cÄ± **`gcloud auth login`** komutunu kendisi Ã§aÄŸÄ±racaÄŸÄ±ndan dolayÄ± **muhtemelen ÅŸÃ¼phelenmeyecektir.**

SÃ¼rÃ¼cÃ¼ dosyalarÄ±nÄ± listelemek iÃ§in: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## GWS'den GCP'ye

### AyrÄ±calÄ±klÄ± GCP kullanÄ±cÄ±larÄ±na eriÅŸim

Bir saldÄ±rganÄ±n GWS Ã¼zerinde tam eriÅŸimi varsa, genellikle **GWS'deki kullanÄ±cÄ±lar GCP Ã¼zerinde yÃ¼ksek ayrÄ±calÄ±klara sahip olduklarÄ±ndan dolayÄ±** GWS'den GCP'ye geÃ§mek daha "basit" olacaktÄ±r.&#x20;

### Google GruplarÄ± AyrÄ±calÄ±k YÃ¼kseltme

VarsayÄ±lan olarak kullanÄ±cÄ±lar **KuruluÅŸun Workspace gruplarÄ±na serbestÃ§e katÄ±labilir** ve bu gruplar **GCP izinleri** atamÄ±ÅŸ olabilir (gruplarÄ±nÄ±zÄ± [https://groups.google.com/](https://groups.google.com/) adresinden kontrol edin).

**Google gruplarÄ± ayrÄ±calÄ±k yÃ¼kseltme**yi kÃ¶tÃ¼ye kullanarak GCP'ye ayrÄ±calÄ±klÄ± eriÅŸime sahip bir gruba yÃ¼kseltme yapabilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmaya kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya beni **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
