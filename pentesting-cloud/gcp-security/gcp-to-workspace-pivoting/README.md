# GCP <--> Workspace Pivoting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> adlÄ± <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## **GCP'den GWS'ye**

### **Domain GeniÅŸ Yetkilendirme Temelleri**

Google Workspace'in Domain GeniÅŸ Yetkilendirme Ã¶zelliÄŸi, bir **harici uygulama** (Google Workspace Marketplace'den) veya bir **GCP Hizmet HesabÄ±** olmak Ã¼zere bir kimlik nesnesinin, kullanÄ±cÄ±lar adÄ±na Workspace Ã¼zerindeki verilere **eriÅŸmesine olanak tanÄ±r**.

{% hint style="info" %}
Bu temel olarak, bir organizasyonun GCP projelerindeki **hizmet hesaplarÄ±nÄ±n**, aynÄ± organizasyonun (veya farklÄ± bir organizasyonun) Workspace kullanÄ±cÄ±larÄ±nÄ± **taklit edebilme** yeteneÄŸine sahip olabileceÄŸi anlamÄ±na gelir.
{% endhint %}

Bu konuyla ilgili daha fazla bilgi iÃ§in ÅŸu adrese bakÄ±n:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Varolan yetkilendirmeyi ele geÃ§irme

Bir saldÄ±rgan, **GCP Ã¼zerinde bazÄ± eriÅŸimleri ele geÃ§irdiyse** ve ÅŸirketin bir **GeÃ§erli Workspace kullanÄ±cÄ± e-posta adresini** (tercihen **sÃ¼per yÃ¶netici**) bildiÄŸinde, eriÅŸime sahip olduÄŸu **tÃ¼m projeleri sÄ±ralayabilir**, projelerin **tÃ¼m hizmet hesaplarÄ±nÄ± sÄ±ralayabilir**, hangi **hizmet hesaplarÄ±na eriÅŸimi olduÄŸunu** kontrol edebilir ve her bir hizmet hesabÄ±yla bu adÄ±mlarÄ± **tekrarlayabilir**.\
**EriÅŸime sahip olduÄŸu tÃ¼m hizmet hesaplarÄ±nÄ±n listesi** ve **Workspace e-postalarÄ±nÄ±n listesi** ile saldÄ±rgan, her bir hizmet hesabÄ±yla kullanÄ±cÄ±yÄ± **taklit etmeyi deneyebilir**.

{% hint style="danger" %}
Domain geniÅŸ yetkilendirme yapÄ±landÄ±rÄ±lÄ±rken bir Workspace kullanÄ±cÄ±sÄ±na ihtiyaÃ§ duyulmadÄ±ÄŸÄ±nÄ± unutmayÄ±n, bu nedenle **geÃ§erli bir tane bilmeniz, taklit iÃ§in yeterli ve gereklidir**.\
Ancak, taklit edilen kullanÄ±cÄ±nÄ±n **yetkileri kullanÄ±lacaktÄ±r**, bu nedenle SÃ¼per YÃ¶netici ise her ÅŸeye eriÅŸebilirsiniz. EriÅŸimi yoksa bu iÅŸe yaramaz.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, saldÄ±rÄ±yÄ± aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyerek gerÃ§ekleÅŸtirebilen bir araÃ§tÄ±r:

1. Kaynak YÃ¶neticisi API'sÄ±nÄ± kullanarak **GCP Projelerini sÄ±ralayÄ±n**.
2. Her proje kaynaÄŸÄ± Ã¼zerinde dÃ¶ngÃ¼ oluÅŸturun ve baÅŸlangÄ±Ã§ IAM kullanÄ±cÄ±sÄ±nÄ±n eriÅŸimi olan **GCP Hizmet hesabÄ± kaynaklarÄ±nÄ± sÄ±ralayÄ±n**.
3. **Her hizmet hesabÄ± rolÃ¼ Ã¼zerinde dÃ¶ngÃ¼ oluÅŸturun** ve hedef hizmet hesabÄ± kaynaÄŸÄ±nda _**serviceAccountKeys.create**_ iznine sahip olan yerleÅŸik, temel ve Ã¶zel rolleri bulun. EditÃ¶r rolÃ¼nÃ¼n bu izne sahip olduÄŸu unutulmamalÄ±dÄ±r.
4. IAM politikasÄ±nda ilgili izne sahip bulunan **her hizmet hesabÄ± kaynaÄŸÄ±na yeni bir `KEY_ALG_RSA_2048` Ã¶zel anahtarÄ± oluÅŸturun**.
5. **Her yeni hizmet hesabÄ± iÃ§in bir `JWT` nesnesi oluÅŸturun**. Bu, SA Ã¶zel anahtar kimlik bilgileri ve bir OAuth kapsamÄ±ndan oluÅŸur. Yeni bir _JWT_ nesnesi oluÅŸturma iÅŸlemi, mevcut OAuth kapsamlarÄ±nÄ±n tÃ¼m kombinasyonlarÄ±nÄ± bulmak iÃ§in **oauth\_scopes.txt** listesindeki tÃ¼m OAuth kapsamlarÄ±nÄ±n Ã¼zerinde dÃ¶ner. **oauth\_scopes.txt** listesi, Workspace kimliklerini kÃ¶tÃ¼ye kullanmak iÃ§in ilgili olduÄŸunu tespit ettiÄŸimiz tÃ¼m OAuth kapsamlarÄ±yla gÃ¼ncellenir.
6. `_make_authorization_grant_assertion` yÃ¶ntemi, DWD altÄ±nda JWT'lerin oluÅŸturulmasÄ± iÃ§in bir **hedef workspace kullanÄ±cÄ±sÄ±nÄ±n** (subject) belirtilmesi gerekliliÄŸini ortaya koyar. Bu, belirli bir kullanÄ±cÄ± gerektiriyor gibi gÃ¶rÃ¼nebilir, ancak DWD'nin bir alan iÃ§indeki her kimliÄŸi etkilediÄŸini anlamak Ã¶nemlidir. SonuÃ§ olarak, herhangi bir alan kullanÄ±cÄ±sÄ± iÃ§in bir JWT oluÅŸturmak, bu alandaki tÃ¼m kimlikleri etkiler ve kombinasyon numaralamasÄ± kontrolÃ¼mÃ¼zle tutarlÄ±dÄ±r. BasitÃ§e sÃ¶ylemek gerekirse, ilerlemek iÃ§in geÃ§erli bir Workspace kullanÄ±cÄ±sÄ± yeterlidir.\
Bu kullanÄ±cÄ±, DeleFriend'Ã¼n _config.yaml_ dosyasÄ±nda tanÄ±mlanabilir. Hedef bir workspace kullanÄ±cÄ±sÄ± zaten bilinmiyorsa, araÃ§, GCP projelerinde rolleri olan alan kullanÄ±cÄ±larÄ±nÄ± taramak suretiyle geÃ§erli workspace kullanÄ±cÄ±larÄ±nÄ±n otomatik olarak tanÄ±mlanmasÄ±nÄ± kolaylaÅŸtÄ±rÄ±r. (Tekrar belirtmek gerekirse) JWT'ler alan Ã¶zgÃ¼dÃ¼r ve her kullanÄ±cÄ± iÃ§in oluÅŸturulmaz; bu nedenle, otomatik sÃ¼reÃ§, her alan iÃ§in tek bir benzersiz kimliÄŸi hedefler.
7. Her JWT iÃ§in yeni bir taÅŸÄ±yÄ±cÄ± eriÅŸim belirteci **sÄ±ralayÄ±n ve oluÅŸturun** ve belirteci tokeninfo API'sine karÅŸÄ± doÄŸrulayÄ±n.

#### [Gitlab'Ä±n Python betiÄŸi](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, kullanÄ±cÄ± dizinini listelemek ve bir json ile belirtilen SA kimlik bilgileri ve taklit edilecek kullanÄ±cÄ±yÄ± gÃ¶stererek yeni bir yÃ¶netici hesabÄ± oluÅŸturmak iÃ§in [bu Python betiÄŸini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluÅŸturdu. Ä°ÅŸte nasÄ±l kullanacaÄŸÄ±nÄ±z:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir yetkilendirme oluÅŸturma (KalÄ±cÄ±lÄ±k)

[**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** adresindeki** **Domain Wide Delegations** kontrol edilebilir.

Bir saldÄ±rgan, bir GCP projesinde **hizmet hesaplarÄ± oluÅŸturma yeteneÄŸine** ve **GWS'ye sÃ¼per yÃ¶netici ayrÄ±calÄ±ÄŸÄ±na** sahipse, SAs'Ä±n bazÄ± GWS kullanÄ±cÄ±larÄ±nÄ± taklit etmelerine izin veren yeni bir yetkilendirme oluÅŸturabilir:

1. **Yeni bir Hizmet HesabÄ± ve Ä°lgili Anahtar Ã‡ifti OluÅŸturma:** GCP'de, yeni hizmet hesabÄ± kaynaklarÄ±, ya konsol aracÄ±lÄ±ÄŸÄ±yla etkileÅŸimli olarak veya doÄŸrudan API Ã§aÄŸrÄ±larÄ± ve CLI araÃ§larÄ± kullanÄ±larak programlÄ± olarak Ã¼retilebilir. Bunun iÃ§in **`iam.serviceAccountAdmin`** rolÃ¼ veya **`iam.serviceAccounts.create`** **izinini** iÃ§eren herhangi bir Ã¶zel rol gereklidir. Hizmet hesabÄ± oluÅŸturulduktan sonra, ilgili bir anahtar Ã§ifti oluÅŸturmak iÃ§in **`iam.serviceAccountKeys.create`** izni kullanÄ±lÄ±r.
2. **Yeni bir yetkilendirme oluÅŸturma**: Google Workspace'de, **yalnÄ±zca SÃ¼per YÃ¶netici rolÃ¼nÃ¼n** **global Domain-Wide yetkilendirmeyi** kurma yeteneÄŸine sahip olduÄŸu ve Domain-Wide yetkilendirmenin **programlÄ± olarak kurulamayacaÄŸÄ±,** yalnÄ±zca Google Workspace **konsolu** Ã¼zerinden **manuel olarak** oluÅŸturulup ayarlanabileceÄŸi Ã¶nemlidir.
* Kural oluÅŸturma, **API kontrolleri â†’ Google Workspace YÃ¶netici konsolunda Domain-Wide yetkilendirmeyi YÃ¶net** sayfasÄ±nda bulunabilir.
3. **OAuth kapsamlarÄ± ayrÄ±calÄ±ÄŸÄ±nÄ± eklemek**: Yeni bir yetkilendirme yapÄ±landÄ±rÄ±lÄ±rken, Google yalnÄ±zca 2 parametre gerektirir: Ä°stemci KimliÄŸi, yani GCP Hizmet HesabÄ± kaynaÄŸÄ±nÄ±n **OAuth KimliÄŸi** ve yetkilendirmenin hangi API Ã§aÄŸlarÄ±nÄ± gerektirdiÄŸini tanÄ±mlayan **OAuth kapsamlarÄ±**.
* **OAuth kapsamlarÄ±nÄ±n tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir Ã¶neri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Hedef kimliÄŸi adÄ±na hareket etme:** Bu noktada, GWS'de iÅŸlevsel bir yetkilendirilmiÅŸ nesnemiz var. Åimdi, GCP Hizmet HesabÄ± Ã¶zel anahtarÄ±nÄ± kullanarak (OAuth kapsam parametresinde tanÄ±mlanan kapsamda) API Ã§aÄŸrÄ±larÄ± yapabilir ve Google Workspace'de var olan herhangi bir kimlik adÄ±na hareket edebiliriz. Hizmet hesabÄ±, ihtiyaÃ§larÄ±na gÃ¶re eriÅŸim belirteÃ§leri oluÅŸturacak ve REST API uygulamalarÄ±na sahip olduÄŸu izinlere gÃ¶re hareket edecektir.
* Bu yetkilendirmeyi kullanmak iÃ§in bazÄ± **araÃ§lar** iÃ§in **Ã¶nceki bÃ¶lÃ¼me** bakÄ±n.

#### KuruluÅŸlararasÄ± yetkilendirme

OAuth SA KimliÄŸi kÃ¼reseldir ve **kuruluÅŸlararasÄ± yetkilendirme** iÃ§in kullanÄ±labilir. KÃ¼resel Ã§apta yetkilendirme yapmak iÃ§in herhangi bir kÄ±sÄ±tlama uygulanmamÄ±ÅŸtÄ±r. Basit bir ifadeyle, **farklÄ± GCP kuruluÅŸlarÄ±ndan hizmet hesaplarÄ±, diÄŸer Workspace kuruluÅŸlarÄ±nda domain-wide yetkilendirme yapÄ±landÄ±rmasÄ± iÃ§in kullanÄ±labilir**. Bu, yalnÄ±zca SÃ¼per YÃ¶netici eriÅŸimine ihtiyaÃ§ duyulan Workspace'e eriÅŸim saÄŸlar ve saldÄ±rgan, kendi kontrolÃ¼nde olan GCP hesabÄ±nda Hizmet HesaplarÄ± ve Ã¶zel anahtarlar oluÅŸturabilir.

### Workspace'yi numaralandÄ±rmak iÃ§in bir Proje oluÅŸturma

VarsayÄ±lan olarak, Workspace **kullanÄ±cÄ±larÄ±**, **yeni projeler oluÅŸturma iznine** sahiptir ve yeni bir proje oluÅŸturulduÄŸunda **oluÅŸturucu Ã¼zerinde Sahip rolÃ¼** alÄ±r.

Bu nedenle, bir kullanÄ±cÄ± bir proje oluÅŸturabilir, yeni projesinde Workspace'yi numaralandÄ±rmak iÃ§in **API'leri etkinleÅŸtirebilir** ve onu **numaralandÄ±rmaya** Ã§alÄ±ÅŸabilir.

{% hint style="danger" %}
Bir kullanÄ±cÄ±nÄ±n Workspace'yi numaralandÄ±rabilmesi iÃ§in yeterli Workspace iznine de ihtiyacÄ± vardÄ±r (her kullanÄ±cÄ± dizini numaralandÄ±ramaz).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Daha fazla numaralandÄ±rmayÄ± kontrol et:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## GWS'den GCP'ye

### AyrÄ±calÄ±klÄ± GCP kullanÄ±cÄ±larÄ±na eriÅŸim

Bir saldÄ±rganÄ±n GWS Ã¼zerinde tam eriÅŸimi varsa, GCP Ã¼zerinde ayrÄ±calÄ±klÄ± eriÅŸime sahip gruplara veya hatta kullanÄ±cÄ±lara eriÅŸebilir, bu nedenle GWS'den GCP'ye geÃ§mek genellikle daha "basit" olabilir Ã§Ã¼nkÃ¼ **GWS'deki kullanÄ±cÄ±lar GCP Ã¼zerinde yÃ¼ksek ayrÄ±calÄ±klara sahiptir**.

### Google GruplarÄ± AyrÄ±calÄ±k YÃ¼kseltme

VarsayÄ±lan olarak, kullanÄ±cÄ±lar **Organizasyonun Workspace gruplarÄ±na serbestÃ§e katÄ±labilir** ve bu gruplara **GCP izinleri** atanmÄ±ÅŸ olabilir (gruplarÄ±nÄ±zÄ± [https://groups.google.com/](https://groups.google.com/) adresinde kontrol edin).

**Google gruplarÄ± ayrÄ±calÄ±k yÃ¼kseltmesini** kÃ¶tÃ¼ye kullanarak, GCP'ye bazÄ± ayrÄ±calÄ±klÄ± eriÅŸimi olan bir gruba yÃ¼kseltme yapabilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**'u takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
