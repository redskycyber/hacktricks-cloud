# GCP <--> Workspace Pivoting

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## **Von GCP zu GWS**

### **Grundlagen der Domain-weiten Delegation**

Die Domain-weite Delegation von Google Workspace erm√∂glicht einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Servicekonto**, auf **Daten im gesamten Workspace im Namen von Benutzern zuzugreifen**.

{% hint style="info" %}
Dies bedeutet im Wesentlichen, dass **Servicekonten** innerhalb von GCP-Projekten einer Organisation in der Lage sein k√∂nnten, Workspace-Benutzer der gleichen Organisation (oder sogar einer anderen) zu **imitieren**.
{% endhint %}

F√ºr weitere Informationen dar√ºber, wie dies genau funktioniert, siehe:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromittierung bestehender Delegation

Wenn ein Angreifer **einen gewissen Zugriff auf GCP kompromittiert** hat und die E-Mail-Adresse eines g√ºltigen Workspace-Benutzers kennt (vorzugsweise **Super-Admin**) des Unternehmens, k√∂nnte er **alle Projekte auflisten**, auf die er Zugriff hat, **alle SAs** der Projekte auflisten, √ºberpr√ºfen, auf welche **Servicekonten er Zugriff hat**, und **alle diese Schritte mit jedem SA wiederholen** kann, den er imitieren kann.\
Mit einer **Liste aller Servicekonten**, auf die er **Zugriff** hat, und der Liste der **Workspace-E-Mails** k√∂nnte der Angreifer versuchen, **jeden Benutzer mit jedem Servicekonto zu imitieren**.

{% hint style="danger" %}
Beachten Sie, dass bei der Konfiguration der domainweiten Delegation kein Workspace-Benutzer erforderlich ist, daher reicht es aus, **einen g√ºltigen Benutzer zu kennen und f√ºr die Imitation erforderlich zu sein**.\
Die **Berechtigungen des imitierten Benutzers werden jedoch verwendet**, sodass Sie bei einem Super-Admin auf alles zugreifen k√∂nnen. Wenn er keine Berechtigungen hat, ist dies nutzlos.
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Dieses einfache Skript wird **ein OAuth-Token als der delegierte Benutzer generieren**, den Sie dann verwenden k√∂nnen, um auf andere Google-APIs mit oder ohne `gcloud` zuzugreifen:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dies ist ein Tool, das den Angriff gem√§√ü der folgenden Schritte durchf√ºhren kann:

1. **Aufz√§hlen von GCP-Projekten** mithilfe der Resource Manager API.
2. Iterieren √ºber jeden Projektressource und **Aufz√§hlen von GCP-Servicekontenressourcen**, auf die der anf√§ngliche IAM-Benutzer Zugriff hat, unter Verwendung von _GetIAMPolicy_.
3. Iterieren √ºber **jede Servicekontenrolle** und Finden von integrierten, grundlegenden und benutzerdefinierten Rollen mit der Berechtigung _**serviceAccountKeys.create**_ auf der Ziel-Servicekontenressource. Es sollte beachtet werden, dass die Editor-Rolle diese Berechtigung von Natur aus besitzt.
4. Erstellen eines **neuen privaten Schl√ºssels vom Typ `KEY_ALG_RSA_2048`** f√ºr jede Servicekontenressource, die mit der relevanten Berechtigung in der IAM-Richtlinie gefunden wurde.
5. Iterieren √ºber **jedes neue Servicekonto und Erstellen eines `JWT`-Objekts** daf√ºr, das aus den SA-privaten Schl√ºsselinformationen und einem OAuth-Bereich besteht. Der Prozess des Erstellens eines neuen _JWT_-Objekts wird **alle vorhandenen Kombinationen von OAuth-Bereichen** aus der Liste **oauth\_scopes.txt** durchlaufen, um alle Delegierungsm√∂glichkeiten zu finden. Die Liste **oauth\_scopes.txt** wird mit allen relevanten f√ºr den Missbrauch von Workspace-Identit√§ten gefundenen OAuth-Bereichen aktualisiert.
6. Die Methode `_make_authorization_grant_assertion` zeigt die Notwendigkeit auf, einen **Ziel-Workspace-Benutzer** zu deklarieren, der als _subject_ f√ºr die Generierung von JWTs unter DWD dient. Obwohl dies einen spezifischen Benutzer zu erfordern scheint, ist es wichtig zu erkennen, dass **DWD jede Identit√§t innerhalb einer Dom√§ne beeinflusst**. Folglich beeinflusst das Erstellen eines JWT f√ºr **einen beliebigen Dom√§nenbenutzer** alle Identit√§ten in dieser Dom√§ne, im Einklang mit unserer Kombinationsaufz√§hlungspr√ºfung. Einfach ausgedr√ºckt ist ein g√ºltiger Workspace-Benutzer ausreichend, um fortzufahren.\
Dieser Benutzer kann in der _config.yaml_-Datei von DeleFriend definiert werden. Wenn ein Ziel-Workspace-Benutzer noch nicht bekannt ist, erleichtert das Tool die automatische Identifizierung g√ºltiger Workspace-Benutzer durch Scannen von Dom√§nenbenutzern mit Rollen in GCP-Projekten. Es ist wichtig zu beachten (erneut), dass JWTs dom√§nenspezifisch sind und nicht f√ºr jeden Benutzer generiert werden; daher zielt der automatische Prozess auf eine einzelne eindeutige Identit√§t pro Dom√§ne ab.
7. **Aufz√§hlen und Erstellen eines neuen Bearer-Zugriffstokens** f√ºr jedes JWT und Validieren des Tokens gegen die tokeninfo-API.

#### [Gitlab's Python-Skript](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab hat [dieses Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) erstellt, das zwei Dinge tun kann - das Benutzerverzeichnis auflisten und ein neues Administratorkonto erstellen, w√§hrend ein JSON mit SA-Anmeldeinformationen und dem zu imitierenden Benutzer angegeben wird. So w√ºrden Sie es verwenden:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Erstellen einer neuen Delegation (Persistenz)

Es ist m√∂glich, **Domain-weite Delegationen unter** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** zu √ºberpr√ºfen**.

Ein Angreifer mit der F√§higkeit, **Service-Konten in einem GCP-Projekt zu erstellen** und **Super-Admin-Berechtigungen f√ºr GWS zu haben, k√∂nnte eine neue Delegation erstellen, die es Service-Konten erm√∂glicht, einige GWS-Benutzer zu impersonieren**:

1. **Generierung eines neuen Service-Kontos und entsprechendes Schl√ºsselpaar:** Auf GCP k√∂nnen neue Ressourcen f√ºr Service-Konten entweder interaktiv √ºber die Konsole oder programmgesteuert √ºber direkte API-Aufrufe und CLI-Tools erstellt werden. Hierf√ºr sind die **Rolle `iam.serviceAccountAdmin`** oder eine benutzerdefinierte Rolle mit der **Berechtigung `iam.serviceAccounts.create`** erforderlich. Sobald das Service-Konto erstellt ist, werden wir fortfahren, ein **zugeh√∂riges Schl√ºsselpaar zu generieren** (**Berechtigung `iam.serviceAccountKeys.create`**).
2. **Erstellung einer neuen Delegation**: Es ist wichtig zu verstehen, dass **nur die Rolle des Super-Admins die F√§higkeit besitzt, eine globale Domain-weite Delegation in Google Workspace einzurichten** und Domain-weite Delegation **nicht programmgesteuert eingerichtet werden kann**. Sie kann nur **manuell** √ºber die Google Workspace **Konsole** erstellt und angepasst werden.
* Die Erstellung der Regel findet sich unter der Seite **API-Steuerungen ‚Üí Verwalten der Domain-weiten Delegation in der Google Workspace Admin-Konsole**.
3. **Zuweisen von OAuth-Berechtigungen**: Bei der Konfiguration einer neuen Delegation erfordert Google nur 2 Parameter, die Client-ID, die die **OAuth-ID der GCP-Service-Konto**-Ressource ist, und **OAuth-Berechtigungen**, die definieren, welche API-Aufrufe die Delegation erfordert.
* Die **vollst√§ndige Liste der OAuth-Berechtigungen** finden Sie [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes), aber hier ist eine Empfehlung: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Im Namen der Zielidentit√§t handeln:** Zu diesem Zeitpunkt haben wir ein funktionierendes delegiertes Objekt in GWS. Jetzt k√∂nnen wir **unter Verwendung des privaten Schl√ºssels des GCP-Service-Kontos API-Aufrufe** (im Umfang, der im OAuth-Bereichsparameter definiert ist) durchf√ºhren, um es auszul√∂sen und **im Namen einer beliebigen Identit√§t, die in Google Workspace existiert, zu handeln**. Wie wir gelernt haben, wird das Service-Konto Zugriffstoken gem√§√ü seinen Anforderungen generieren und gem√§√ü den Berechtigungen, die es f√ºr REST-API-Anwendungen hat.
* √úberpr√ºfen Sie den **vorherigen Abschnitt** f√ºr einige **Tools**, um diese Delegation zu verwenden.

#### Cross-Organisationale Delegation

Die OAuth SA-ID ist global und kann f√ºr **cross-organisationale Delegation** verwendet werden. Es wurde keine Einschr√§nkung implementiert, um eine globale Delegation zu verhindern. Einfach ausgedr√ºckt k√∂nnen **Service-Konten aus verschiedenen GCP-Organisationen verwendet werden, um domain-weite Delegationen in anderen Workspace-Organisationen zu konfigurieren**. Dies w√ºrde dazu f√ºhren, dass **nur Super-Admin-Zugriff auf Workspace erforderlich ist**, und kein Zugriff auf dasselbe GCP-Konto, da der Angreifer Service-Konten und private Schl√ºssel in seinem pers√∂nlich kontrollierten GCP-Konto erstellen kann.

### Erstellen eines Projekts zur Auflistung von Workspace

Standardm√§√üig haben **Workspace-Benutzer** die Berechtigung, **neue Projekte zu erstellen**, und wenn ein neues Projekt erstellt wird, erh√§lt der **Ersteller die Eigent√ºmerrolle** dar√ºber.

Daher kann ein Benutzer ein Projekt erstellen, die **APIs aktivieren**, um Workspace in seinem neuen Projekt aufzulisten und versuchen, es **aufzulisten**.

{% hint style="danger" %}
Damit ein Benutzer Workspace auflisten kann, ben√∂tigt er auch ausreichende Workspace-Berechtigungen (nicht jeder Benutzer wird in der Lage sein, das Verzeichnis aufzulisten).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

√úberpr√ºfen Sie **weitere Enumerationen in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Missbrauch von Gcloud

Weitere Informationen zum `gcloud`-Ablauf zur Anmeldung finden Sie unter:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Wie dort erkl√§rt, kann gcloud den Bereich `https://www.googleapis.com/auth/drive` anfordern, der einem Benutzer den Zugriff auf das Laufwerk des Benutzers erm√∂glichen w√ºrde.\
Als Angreifer k√∂nnten Sie, wenn Sie den Computer eines Benutzers **physisch** kompromittiert haben und der **Benutzer noch mit seinem Konto angemeldet ist**, sich anmelden und ein Token generieren, das Zugriff auf das Laufwerk gew√§hrt, indem Sie:
```bash
gcloud auth login --enable-gdrive-access
```
Wenn ein Angreifer den Computer eines Benutzers kompromittiert, k√∂nnte er auch die Datei `google-cloud-sdk/lib/googlecloudsdk/core/config.py` √§ndern und im **`CLOUDSDK_SCOPES`** den Bereich **`'https://www.googleapis.com/auth/drive'`** hinzuf√ºgen:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Daher wird beim n√§chsten Mal, wenn sich der Benutzer anmeldet, ein **Token mit Zugriff auf Drive erstellt**, den der Angreifer missbrauchen k√∂nnte, um auf das Laufwerk zuzugreifen. Offensichtlich wird der Browser anzeigen, dass das generierte Token Zugriff auf Drive haben wird, aber da der Benutzer sich selbst mit **`gcloud auth login`** authentifiziert, wird er wahrscheinlich **nichts Verd√§chtiges vermuten.**

Um Laufwerksdateien aufzulisten: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Von GWS zu GCP

### Zugriff auf privilegierte GCP-Benutzer

Wenn ein Angreifer vollst√§ndigen Zugriff auf GWS hat, kann er auf Gruppen mit privilegiertem Zugriff auf GCP oder sogar Benutzer zugreifen. Daher ist der √úbergang von GWS zu GCP in der Regel "einfacher", einfach weil **Benutzer in GWS √ºber hohe Berechtigungen f√ºr GCP verf√ºgen**.

### Google Groups Privilege Escalation

Standardm√§√üig k√∂nnen Benutzer **frei Workspace-Gruppen der Organisation beitreten**, und diese Gruppen **k√∂nnen GCP-Berechtigungen** zugewiesen haben (√ºberpr√ºfen Sie Ihre Gruppen unter [https://groups.google.com/](https://groups.google.com/)).

Durch Ausnutzen der **google groups privesc** k√∂nnten Sie in der Lage sein, zu einer Gruppe mit einer Art privilegiertem Zugriff auf GCP zu eskalieren.

### Referenzen

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
