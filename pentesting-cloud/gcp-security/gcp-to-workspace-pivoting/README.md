# GCP <--> Workspace Pivoting

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Od GCP-a do GWS-a**

### **Osnove delegacije na nivou domena**

Delegacija na nivou domena u Google Workspace-u omoguÄ‡ava objektu identiteta, bilo da je to **eksterna aplikacija** sa Google Workspace Marketplace-a ili interni **GCP Service Account**, da **pristupi podacima u okviru Workspace-a u ime korisnika**.

{% hint style="info" %}
Ovo u osnovi znaÄi da **servisni nalozi** unutar GCP projekata organizacije mogu biti u moguÄ‡nosti da **predstavljaju korisnike Workspace-a** iste organizacije (ili Äak iz druge organizacije).
{% endhint %}

Za viÅ¡e informacija o tome kako taÄno ovo funkcioniÅ¡e, pogledajte:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromitovanje postojeÄ‡e delegacije

Ako napadaÄ **kompromituje pristup GCP-u** i **pozna validnu email adresu korisnika Workspace-a** (po moguÄ‡stvu **super admina**) kompanije, on bi mogao **izlistati sve projekte** do kojih ima pristup, **izlistati sve servisne naloge** projekata, proveriti do kojih **servisnih naloga ima pristup**, i **ponoviti** sve ove korake sa svakim servisnim nalogom koji moÅ¾e predstavljati.\
Sa **listom svih servisnih naloga** do kojih ima **pristup** i listom **email adresa Workspace-a**, napadaÄ bi mogao pokuÅ¡ati da **predstavlja korisnika sa svakim servisnim nalogom**.

{% hint style="danger" %}
Imajte na umu da prilikom konfigurisanja delegacije na nivou domena nije potreban korisnik Workspace-a, stoga je dovoljno poznavati **jednog validnog korisnika za predstavljanje**.\
MeÄ‘utim, **privilegije predstavljenog korisnika Ä‡e biti koriÅ¡Ä‡ene**, pa ako je to Super Admin, biÄ‡ete u moguÄ‡nosti da pristupite svemu. Ako nema nikakav pristup, ovo Ä‡e biti beskorisno.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Ovo je alat koji moÅ¾e izvrÅ¡iti napad sledeÄ‡im koracima:

1. **Izlistajte GCP projekte** koristeÄ‡i Resource Manager API.
2. Iterirajte kroz svaki resurs projekta i **izlistajte GCP resurse servisnih naloga** do kojih poÄetni IAM korisnik ima pristup koristeÄ‡i _GetIAMPolicy_.
3. Iterirajte kroz **svaku ulogu servisnog naloga** i pronaÄ‘ite ugraÄ‘ene, osnovne i prilagoÄ‘ene uloge sa dozvolom _**serviceAccountKeys.create**_ na ciljnom resursu servisnog naloga. Treba napomenuti da uloga Editor inherentno poseduje ovu dozvolu.
4. Kreirajte **novi `KEY_ALG_RSA_2048`** privatni kljuÄ za svaki resurs servisnog naloga koji je pronaÄ‘en sa relevantnom dozvolom u IAM politici.
5. Iterirajte kroz **svaki novi servisni nalog i kreirajte `JWT`** **objekat** za njega koji se sastoji od kredencijala privatnog kljuÄa SA i OAuth opsega. Proces kreiranja novog _JWT_ objekta Ä‡e **iterirati kroz sve postojeÄ‡e kombinacije OAuth opsega** iz liste **oauth\_scopes.txt**, kako bi pronaÅ¡ao sve moguÄ‡nosti delegacije. Lista **oauth\_scopes.txt** se aÅ¾urira sa svim OAuth opsezima koje smo pronaÅ¡li relevantnim za zloupotrebu identiteta Workspace-a.
6. Metoda `_make_authorization_grant_assertion` otkriva potrebu za deklarisanjem **ciljnog korisnika Workspace-a**, nazvanog _subject_, za generisanje JWT-ova u okviru DWD. Iako se moÅ¾e Äiniti da je za ovo potreban odreÄ‘eni korisnik, vaÅ¾no je shvatiti da **DWD utiÄe na svaki identitet unutar domena**. Kao rezultat toga, kreiranje JWT-a za **bilo kog korisnika domena** utiÄe na sve identitete u tom domenu, u skladu sa naÅ¡om proverom kombinacija. Jednostavno reÄeno, jedan validan korisnik Workspace-a je dovoljan za nastavak.\
Ovaj korisnik moÅ¾e biti definisan u DeleFriend-ovom _config.yaml_ fajlu. Ako ciljni korisnik Workspace-a veÄ‡ nije poznat, alat omoguÄ‡ava automatsko identifikovanje validnih korisnika Workspace-a skeniranjem korisnika domena sa ulogama na GCP projektima. VaÅ¾no je napomenuti (ponovo) da su JWT-ovi specifiÄni za domen i nisu generisani za svakog korisnika; stoga, automatski proces cilja na jedan jedinstveni identitet po domenu.
7. **Izlistajte i kreirajte novi bearer pristupni token** za svaki JWT i validirajte token protiv tokeninfo API-ja.

#### [Python skripta Gitlab-a](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab je kreirao [ovu Python skriptu](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) koja moÅ¾e uraditi dve stvari - izlistati direktorijum korisnika i kreirati novi administratorski nalog uz navoÄ‘enje json-a sa SA kredencijalima i korisnika za predstavljanje. Evo kako biste je koristili:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Kreiranje nove delegacije (Upornost)

MoguÄ‡e je **proveriti Delegacije na nivou domena** na [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

NapadaÄ koji ima moguÄ‡nost **kreiranja servisnih naloga u GCP projektu** i **super admin privilegiju za GWS moÅ¾e kreirati novu delegaciju koja omoguÄ‡ava servisnim nalozima da se predstavljaju kao neki GWS korisnici:**

1. **Generisanje novog servisnog naloga i odgovarajuÄ‡eg para kljuÄeva:** Na GCP-u, nove resurse servisnih naloga moÅ¾emo generisati interaktivno putem konzole ili programski koriÅ¡Ä‡enjem API poziva i CLI alata. Za ovo je potrebna **uloga `iam.serviceAccountAdmin`** ili bilo koja prilagoÄ‘ena uloga opremljena sa **`iam.serviceAccounts.create`** **dozvolom**. Nakon Å¡to je servisni nalog kreiran, nastavljamo sa generisanjem **odgovarajuÄ‡eg para kljuÄeva** (**`iam.serviceAccountKeys.create`** dozvola).
2. **Kreiranje nove delegacije**: VaÅ¾no je razumeti da **samo uloga Super Admin ima moguÄ‡nost postavljanja globalne Delegacije na nivou domena u Google Workspace-u** i Delegacija na nivou domena **ne moÅ¾e biti postavljena programski,** MoÅ¾e se samo kreirati i prilagoditi **ruÄno** putem Google Workspace **konzole**.
* Kreiranje pravila moÅ¾e se pronaÄ‡i na stranici **API kontrole â†’ Upravljanje Delegacijom na nivou domena u Google Workspace Admin konzoli**.
3. **Povezivanje privilegija OAuth opsega**: Prilikom konfigurisanja nove delegacije, Google zahteva samo 2 parametra, Client ID, koji je **OAuth ID GCP servisnog naloga** resursa, i **OAuth opsege** koji definiÅ¡u koje API pozive delegacija zahteva.
* **Puni spisak OAuth opsega** moÅ¾ete pronaÄ‡i [**ovde**](https://developers.google.com/identity/protocols/oauth2/scopes), ali evo preporuke: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Delovanje u ime ciljnog identiteta:** U ovom trenutku, imamo funkcionalni delegirani objekat u GWS-u. Sada, **koristeÄ‡i privatni kljuÄ GCP servisnog naloga, moÅ¾emo izvrÅ¡iti API pozive** (u opsegu definisanom u parametru OAuth opsega) da ga pokrenemo i **delujemo u ime bilo kog identiteta koji postoji u Google Workspace-u**. Kao Å¡to smo nauÄili, servisni nalog Ä‡e generisati pristupne tokene prema svojim potrebama i u skladu sa dozvolama koje ima za REST API aplikacije.
* Pogledajte **prethodni odeljak** za neke **alate** za koriÅ¡Ä‡enje ove delegacije.

#### Delegacija preko organizacija

OAuth SA ID je globalan i moÅ¾e se koristiti za **delegaciju preko organizacija**. Nije implementirano nikakvo ograniÄenje koje spreÄava prekograniÄnu delegaciju. Jednostavno reÄeno, **servisni nalozi iz razliÄitih GCP organizacija mogu se koristiti za konfigurisanje delegacije na nivou domena u drugim organizacijama Workspace-a**. To bi rezultiralo **potrebom samo za Super Admin pristup Workspace-u**, a ne pristup istom GCP nalogu, jer napadaÄ moÅ¾e kreirati servisne naloge i privatne kljuÄeve na svom liÄno kontrolisanom GCP nalogu.

### Kreiranje projekta za enumeraciju Workspace-a

**Podrazumevano**, korisnici Workspace-a imaju dozvolu za **kreiranje novih projekata**, i kada se kreira novi projekat, **kreator dobija ulogu Vlasnika** nad njim.

Stoga, korisnik moÅ¾e **kreirati projekat**, **omoguÄ‡iti** API-je za enumeraciju Workspace-a u svom novom projektu i pokuÅ¡ati ga **enumerisati**.

{% hint style="danger" %}
Da bi korisnik mogao da enumeriÅ¡e Workspace, takoÄ‘e mu je potrebno dovoljno dozvola u Workspace-u (neÄ‡e svaki korisnik moÄ‡i da enumeriÅ¡e direktorijum).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Proverite **viÅ¡e enumeracije u**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Od GWS do GCP

### Pristup privilegovanim GCP korisnicima

Ako napadaÄ ima potpuni pristup nad GWS-om, moÄ‡i Ä‡e pristupiti grupama sa privilegovanim pristupom nad GCP-om ili Äak korisnicima, stoga prelazak sa GWS-a na GCP je obiÄno "jednostavniji" jer **korisnici u GWS-u imaju visoke privilegije nad GCP-om**.&#x20;

### Eskalacija privilegija Google grupa

Prema zadanim postavkama, korisnici mogu **slobodno pristupiti grupama Workspace-a organizacije** i te grupe **mogu imati dodijeljene dozvole za GCP** (proverite svoje grupe na [https://groups.google.com/](https://groups.google.com/)).

Zloupotrebom **google groups privesc** moÅ¾da Ä‡ete moÄ‡i eskalirati do grupe sa nekom vrstom privilegiranog pristupa GCP-u.

### Reference

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite videti **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzeti HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
