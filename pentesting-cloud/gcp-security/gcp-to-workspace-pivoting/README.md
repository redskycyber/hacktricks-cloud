# GCP <--> Workspace Pivoting

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **ä»GCPåˆ°GWS**

### **åŸŸèŒƒå›´å§”æ‰˜åŸºç¡€çŸ¥è¯†**

Google Workspaceçš„åŸŸèŒƒå›´å§”æ‰˜å…è®¸ä¸€ä¸ªèº«ä»½å¯¹è±¡ï¼Œå¯ä»¥æ˜¯æ¥è‡ªGoogle Workspace Marketplaceçš„**å¤–éƒ¨åº”ç”¨**æˆ–å†…éƒ¨çš„**GCPæœåŠ¡è´¦å·**ï¼Œä»£è¡¨ç”¨æˆ·**è·¨Workspaceè®¿é—®æ•°æ®**ã€‚

{% hint style="info" %}
è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ç»„ç»‡ä¸­GCPé¡¹ç›®å†…çš„**æœåŠ¡è´¦å·**å¯èƒ½èƒ½å¤Ÿ**å†’å……**åŒä¸€ç»„ç»‡çš„Workspaceç”¨æˆ·ï¼ˆç”šè‡³æ¥è‡ªä¸åŒç»„ç»‡ï¼‰ã€‚
{% endhint %}

æœ‰å…³æ­¤å·¥ä½œåŸç†çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### æŸå®³ç°æœ‰å§”æ‰˜

å¦‚æœæ”»å‡»è€…**å…¥ä¾µäº†GCPçš„æŸäº›è®¿é—®æƒé™**å¹¶ä¸”**çŸ¥é“å…¬å¸ä¸­ä¸€ä¸ªæœ‰æ•ˆçš„Workspaceç”¨æˆ·ç”µå­é‚®ä»¶**ï¼ˆæœ€å¥½æ˜¯**è¶…çº§ç®¡ç†å‘˜**ï¼‰ï¼Œä»–å¯ä»¥**æšä¸¾æ‰€æœ‰ä»–å¯ä»¥è®¿é—®çš„é¡¹ç›®**ï¼Œ**æšä¸¾é¡¹ç›®çš„æ‰€æœ‰æœåŠ¡è´¦å·**ï¼Œæ£€æŸ¥ä»–å¯ä»¥è®¿é—®å“ªäº›**æœåŠ¡è´¦å·**ï¼Œå¹¶**é‡å¤**æ‰€æœ‰è¿™äº›æ­¥éª¤ä»¥å†’å……æ¯ä¸ªå¯ä»¥å†’å……çš„SAã€‚\
æœ‰äº†ä»–å¯ä»¥**è®¿é—®**çš„**æ‰€æœ‰æœåŠ¡è´¦å·åˆ—è¡¨**å’Œ**Workspace** **ç”µå­é‚®ä»¶**åˆ—è¡¨ï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•ä½¿ç”¨æ¯ä¸ªæœåŠ¡è´¦å·**å†’å……ç”¨æˆ·**ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œåœ¨é…ç½®åŸŸèŒƒå›´å§”æ‰˜æ—¶ä¸éœ€è¦Workspaceç”¨æˆ·ï¼Œå› æ­¤åªéœ€çŸ¥é“**ä¸€ä¸ªæœ‰æ•ˆç”¨æˆ·å°±è¶³å¤Ÿä¸”å¿…éœ€ç”¨äºå†’å……**ã€‚\
ä½†æ˜¯ï¼Œå°†ä½¿ç”¨**è¢«å†’å……ç”¨æˆ·çš„æƒé™**ï¼Œå› æ­¤å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œåˆ™å¯ä»¥è®¿é—®æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è®¿é—®æƒé™ï¼Œåˆ™è¿™å°†æ˜¯æ— ç”¨çš„ã€‚
{% endhint %}

#### [GCPç”Ÿæˆå§”æ‰˜ä»¤ç‰Œ](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

è¿™ä¸ªç®€å•çš„è„šæœ¬å°†**ç”Ÿæˆä¸€ä¸ªOAuthä»¤ç‰Œï¼Œä½œä¸ºè¢«å§”æ‰˜ç”¨æˆ·**ï¼Œç„¶åæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®å…¶ä»–Google APIï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨`gcloud`ï¼š
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

è¿™æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ”»å‡»æ­¥éª¤ï¼š

1. ä½¿ç”¨èµ„æºç®¡ç†å™¨ API è¿›è¡Œ**æšä¸¾ GCP é¡¹ç›®**ã€‚
2. é’ˆå¯¹æ¯ä¸ªé¡¹ç›®èµ„æºè¿›è¡Œè¿­ä»£ï¼Œå¹¶ä½¿ç”¨ _GetIAMPolicy_ **æšä¸¾åˆå§‹ IAM ç”¨æˆ·** å¯è®¿é—®çš„ GCP æœåŠ¡è´¦æˆ·èµ„æºã€‚
3. é’ˆå¯¹**æ¯ä¸ªæœåŠ¡è´¦æˆ·è§’è‰²**è¿›è¡Œè¿­ä»£ï¼Œå¹¶æŸ¥æ‰¾å…·æœ‰ç›®æ ‡æœåŠ¡è´¦æˆ·èµ„æºä¸Š _**serviceAccountKeys.create**_ æƒé™çš„å†…ç½®ã€åŸºæœ¬å’Œè‡ªå®šä¹‰è§’è‰²ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç¼–è¾‘å™¨è§’è‰²æœ¬è´¨ä¸Šå…·æœ‰æ­¤æƒé™ã€‚
4. ä¸ºåœ¨ IAM ç­–ç•¥ä¸­æ‰¾åˆ°ç›¸å…³æƒé™çš„æ¯ä¸ªæœåŠ¡è´¦æˆ·èµ„æºåˆ›å»ºä¸€ä¸ª**æ–°çš„ `KEY_ALG_RSA_2048`** ç§é’¥ã€‚
5. é’ˆå¯¹**æ¯ä¸ªæ–°æœåŠ¡è´¦æˆ·åˆ›å»ºä¸€ä¸ª `JWT`** **å¯¹è±¡**ï¼Œè¯¥å¯¹è±¡ç”± SA ç§é’¥å‡­æ®å’Œ OAuth èŒƒå›´ç»„æˆã€‚åˆ›å»ºæ–° _JWT_ å¯¹è±¡çš„è¿‡ç¨‹å°†**è¿­ä»£æ‰€æœ‰ç°æœ‰çš„ OAuth èŒƒå›´ç»„åˆ**ï¼Œä»¥ä¾¿æ‰¾åˆ°æ‰€æœ‰çš„å§”æ‰˜å¯èƒ½æ€§ã€‚åˆ—è¡¨ **oauth\_scopes.txt** å·²æ›´æ–°ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬å‘ç°ç”¨äºæ»¥ç”¨ Workspace èº«ä»½çš„æ‰€æœ‰ OAuth èŒƒå›´ã€‚
6. `_make_authorization_grant_assertion` æ–¹æ³•æ­ç¤ºäº†åœ¨ DWD ä¸‹ç”Ÿæˆ JWT éœ€è¦å£°æ˜ä¸€ä¸ª**ç›®æ ‡ Workspace ç”¨æˆ·**ï¼Œç§°ä¸º _subject_ã€‚è™½ç„¶è¿™ä¼¼ä¹éœ€è¦ä¸€ä¸ªç‰¹å®šç”¨æˆ·ï¼Œä½†é‡è¦çš„æ˜¯è¦æ„è¯†åˆ°**DWD å½±å“åŸŸå†…çš„æ¯ä¸ªèº«ä»½**ã€‚å› æ­¤ï¼Œä¸º**ä»»ä½•åŸŸç”¨æˆ·**åˆ›å»º JWT ä¼šå½±å“è¯¥åŸŸä¸­çš„æ‰€æœ‰èº«ä»½ï¼Œä¸æˆ‘ä»¬çš„ç»„åˆæšä¸¾æ£€æŸ¥ä¸€è‡´ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„ Workspace ç”¨æˆ·è¶³ä»¥ç»§ç»­è¿›è¡Œã€‚\
å¯ä»¥åœ¨ DeleFriend çš„ _config.yaml_ æ–‡ä»¶ä¸­å®šä¹‰æ­¤ç”¨æˆ·ã€‚å¦‚æœç›®æ ‡ Workspace ç”¨æˆ·å°šæœªçŸ¥æ™“ï¼Œè¯¥å·¥å…·é€šè¿‡æ‰«æåœ¨ GCP é¡¹ç›®ä¸Šå…·æœ‰è§’è‰²çš„åŸŸç”¨æˆ·æ¥è‡ªåŠ¨è¯†åˆ«æœ‰æ•ˆçš„ Workspace ç”¨æˆ·ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJWT æ˜¯ç‰¹å®šäºåŸŸçš„ï¼Œä¸ä¼šä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆï¼›å› æ­¤ï¼Œè‡ªåŠ¨æµç¨‹é’ˆå¯¹æ¯ä¸ªåŸŸçš„å•ä¸ªå”¯ä¸€èº«ä»½ã€‚
7. **æšä¸¾å¹¶ä¸ºæ¯ä¸ª JWT åˆ›å»ºä¸€ä¸ªæ–°çš„æ‰¿è½½è®¿é—®ä»¤ç‰Œ**ï¼Œå¹¶é’ˆå¯¹ tokeninfo API éªŒè¯ä»¤ç‰Œã€‚

#### [Gitlab çš„ Python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab åˆ›å»ºäº†[æ­¤ Python è„šæœ¬](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)ï¼Œå¯ä»¥æ‰§è¡Œä¸¤é¡¹æ“ä½œ - åˆ—å‡ºç”¨æˆ·ç›®å½•å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†è´¦æˆ·ï¼ŒåŒæ—¶æŒ‡ç¤ºä¸€ä¸ªåŒ…å« SA å‡­æ®å’Œè¦æ¨¡æ‹Ÿçš„ç”¨æˆ·çš„ jsonã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒï¼š
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### åˆ›å»ºæ–°å§”æ‰˜ï¼ˆæŒä¹…æ€§ï¼‰

å¯ä»¥åœ¨[https://admin.google.com/u/1/ac/owl/domainwidedelegation](https://admin.google.com/u/1/ac/owl/domainwidedelegation)ä¸­**æ£€æŸ¥åŸŸèŒƒå›´å§”æ‰˜**ã€‚

æ‹¥æœ‰åœ¨GCPé¡¹ç›®ä¸­**åˆ›å»ºæœåŠ¡è´¦å·**å’Œ**GWSè¶…çº§ç®¡ç†å‘˜ç‰¹æƒ**çš„æ”»å‡»è€…å¯ä»¥åˆ›å»ºæ–°çš„å§”æ‰˜ï¼Œå…è®¸æœåŠ¡è´¦å·å†’å……ä¸€äº›GWSç”¨æˆ·ï¼š

1. **ç”Ÿæˆæ–°çš„æœåŠ¡è´¦å·å’Œç›¸åº”çš„å¯†é’¥å¯¹ï¼š** åœ¨GCPä¸Šï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å°äº¤äº’å¼åœ°åˆ›å»ºæ–°çš„æœåŠ¡è´¦å·èµ„æºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç›´æ¥APIè°ƒç”¨å’ŒCLIå·¥å…·è¿›è¡Œç¼–ç¨‹åŒ–ç”Ÿæˆã€‚è¿™éœ€è¦**è§’è‰²`iam.serviceAccountAdmin`**æˆ–é…å¤‡**`iam.serviceAccounts.create`** **æƒé™**çš„ä»»ä½•è‡ªå®šä¹‰è§’è‰²ã€‚ä¸€æ—¦åˆ›å»ºäº†æœåŠ¡è´¦å·ï¼Œæˆ‘ä»¬å°†ç»§ç»­ç”Ÿæˆ**ç›¸å…³çš„å¯†é’¥å¯¹**ï¼ˆ**`iam.serviceAccountKeys.create`**æƒé™ï¼‰ã€‚
2. **åˆ›å»ºæ–°çš„å§”æ‰˜ï¼š** é‡è¦çš„æ˜¯è¦äº†è§£**åªæœ‰è¶…çº§ç®¡ç†å‘˜è§’è‰²å…·æœ‰åœ¨Google Workspaceä¸­è®¾ç½®å…¨å±€åŸŸå§”æ‰˜çš„èƒ½åŠ›**ï¼ŒåŸŸå§”æ‰˜**ä¸èƒ½é€šè¿‡ç¼–ç¨‹æ–¹å¼è®¾ç½®**ï¼Œåªèƒ½é€šè¿‡Google Workspace **æ§åˆ¶å°**è¿›è¡Œ**æ‰‹åŠ¨**åˆ›å»ºå’Œè°ƒæ•´ã€‚
   * è§„åˆ™çš„åˆ›å»ºå¯ä»¥åœ¨é¡µé¢**APIæ§åˆ¶ â†’ åœ¨Google Workspaceç®¡ç†æ§åˆ¶å°ä¸­ç®¡ç†åŸŸå§”æ‰˜**ä¸‹æ‰¾åˆ°ã€‚
3. **é™„åŠ OAuthèŒƒå›´æƒé™ï¼š** åœ¨é…ç½®æ–°çš„å§”æ‰˜æ—¶ï¼ŒGoogleåªéœ€è¦2ä¸ªå‚æ•°ï¼Œå³å®¢æˆ·ç«¯IDï¼Œå³**GCPæœåŠ¡è´¦å·**èµ„æºçš„**OAuth ID**ï¼Œä»¥åŠå®šä¹‰å§”æ‰˜éœ€è¦çš„**OAuthèŒƒå›´**ã€‚
   * å¯ä»¥åœ¨[**æ­¤å¤„**](https://developers.google.com/identity/protocols/oauth2/scopes)æ‰¾åˆ°**å®Œæ•´çš„OAuthèŒƒå›´åˆ—è¡¨**ï¼Œä½†è¿™é‡Œæ˜¯ä¸€ä¸ªå»ºè®®ï¼š`https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **ä»£è¡¨ç›®æ ‡èº«ä»½è¡Œäº‹ï¼š** ç°åœ¨ï¼Œåœ¨GWSä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ªæ­£å¸¸è¿è¡Œçš„å§”æ‰˜å¯¹è±¡ã€‚ç°åœ¨ï¼Œ**ä½¿ç”¨GCPæœåŠ¡è´¦å·ç§é’¥ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒAPIè°ƒç”¨**ï¼ˆåœ¨OAuthèŒƒå›´å‚æ•°ä¸­å®šä¹‰çš„èŒƒå›´å†…ï¼‰æ¥è§¦å‘å®ƒï¼Œå¹¶**ä»£è¡¨Google Workspaceä¸­å­˜åœ¨çš„ä»»ä½•èº«ä»½**è¡Œäº‹ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€äº†è§£çš„ï¼ŒæœåŠ¡è´¦å·å°†æ ¹æ®å…¶éœ€è¦ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼Œå¹¶æ ¹æ®å…¶å¯¹REST APIåº”ç”¨ç¨‹åºçš„æƒé™è¿›è¡Œæ“ä½œã€‚
   * æŸ¥çœ‹**å‰ä¸€èŠ‚**ä»¥äº†è§£ä¸€äº›**å·¥å…·**æ¥ä½¿ç”¨æ­¤å§”æ‰˜ã€‚

#### è·¨ç»„ç»‡å§”æ‰˜

OAuth SA IDæ˜¯å…¨å±€çš„ï¼Œå¯ç”¨äº**è·¨ç»„ç»‡å§”æ‰˜**ã€‚å°šæœªå®æ–½ä»»ä½•é™åˆ¶ä»¥é˜»æ­¢è·¨å…¨å±€å§”æ‰˜ã€‚ç®€å•æ¥è¯´ï¼Œ**æ¥è‡ªä¸åŒGCPç»„ç»‡çš„æœåŠ¡è´¦å·å¯ä»¥ç”¨äºåœ¨å…¶ä»–Workspaceç»„ç»‡ä¸Šé…ç½®åŸŸå§”æ‰˜**ã€‚è¿™å°†å¯¼è‡´**åªéœ€è¦å¯¹Workspaceå…·æœ‰è¶…çº§ç®¡ç†å‘˜è®¿é—®æƒé™**ï¼Œè€Œä¸éœ€è¦è®¿é—®ç›¸åŒçš„GCPè´¦æˆ·ï¼Œå› ä¸ºå¯¹æ‰‹å¯ä»¥åœ¨å…¶ä¸ªäººæ§åˆ¶çš„GCPè´¦æˆ·ä¸Šåˆ›å»ºæœåŠ¡è´¦å·å’Œç§é’¥ã€‚

### åˆ›å»ºç”¨äºæšä¸¾Workspaceçš„é¡¹ç›®

**é»˜è®¤æƒ…å†µä¸‹**ï¼ŒWorkspace **ç”¨æˆ·**å…·æœ‰**åˆ›å»ºæ–°é¡¹ç›®**çš„æƒé™ï¼Œå½“åˆ›å»ºæ–°é¡¹ç›®æ—¶ï¼Œ**åˆ›å»ºè€…å°†æˆä¸ºå…¶æ‰€æœ‰è€…**ã€‚

å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥**åˆ›å»ºä¸€ä¸ªé¡¹ç›®**ï¼Œ**å¯ç”¨**APIä»¥åœ¨å…¶æ–°é¡¹ç›®ä¸­æšä¸¾Workspaceï¼Œå¹¶å°è¯•**æšä¸¾**å®ƒã€‚

{% hint style="danger" %}
ä¸ºäº†ä½¿ç”¨æˆ·èƒ½å¤Ÿæšä¸¾Workspaceï¼Œä»–è¿˜éœ€è¦è¶³å¤Ÿçš„Workspaceæƒé™ï¼ˆå¹¶éæ¯ä¸ªç”¨æˆ·éƒ½èƒ½æšä¸¾ç›®å½•ï¼‰ã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

æ£€æŸ¥**æ›´å¤šæšä¸¾**ï¼š

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### æ»¥ç”¨ Gcloud

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹æ‰¾åˆ°æœ‰å…³`gcloud`ç™»å½•æµç¨‹çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

å¦‚ä¸Šæ‰€è¿°ï¼Œgcloudå¯ä»¥è¯·æ±‚èŒƒå›´`https://www.googleapis.com/auth/drive`ï¼Œè¿™å°†å…è®¸ç”¨æˆ·è®¿é—®ç”¨æˆ·çš„é©±åŠ¨å™¨ã€‚\
ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæ‚¨å·²ç»**ç‰©ç†**å…¥ä¾µäº†ç”¨æˆ·çš„è®¡ç®—æœºä¸”**ç”¨æˆ·ä»ç„¶ç™»å½•**åˆ°ä»–çš„å¸æˆ·ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆä¸€ä¸ªå…·æœ‰è®¿é—®æƒé™çš„ä»¤ç‰Œæ¥ç™»å½•å¹¶è®¿é—®é©±åŠ¨å™¨ï¼š
```bash
gcloud auth login --enable-gdrive-access
```
å¦‚æœæ”»å‡»è€…å…¥ä¾µäº†ç”¨æˆ·çš„è®¡ç®—æœºï¼Œä»–è¿˜å¯ä»¥ä¿®æ”¹æ–‡ä»¶ `google-cloud-sdk/lib/googlecloudsdk/core/config.py`ï¼Œåœ¨ **`CLOUDSDK_SCOPES`** ä¸­æ·»åŠ ä½œç”¨åŸŸ **`'https://www.googleapis.com/auth/drive'`**ï¼š

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
å› æ­¤ï¼Œä¸‹æ¬¡ç”¨æˆ·ç™»å½•æ—¶ï¼Œä»–å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰è®¿é—®é©±åŠ¨å™¨æƒé™çš„ä»¤ç‰Œï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥è®¿é—®é©±åŠ¨å™¨ã€‚æ˜¾ç„¶ï¼Œæµè§ˆå™¨å°†æŒ‡ç¤ºç”Ÿæˆçš„ä»¤ç‰Œå°†å…·æœ‰è®¿é—®é©±åŠ¨å™¨çš„æƒé™ï¼Œä½†ç”±äºç”¨æˆ·å°†è°ƒç”¨ **`gcloud auth login`**ï¼Œä»–å¯èƒ½ **ä¸ä¼šæ€€ç–‘ä»»ä½•äº‹æƒ…ã€‚**

åˆ—å‡ºé©±åŠ¨å™¨æ–‡ä»¶ï¼š**`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## ä» GWS åˆ° GCP

### è®¿é—®ç‰¹æƒ GCP ç”¨æˆ·

å¦‚æœæ”»å‡»è€…å®Œå…¨æ§åˆ¶äº† GWSï¼Œä»–å°†èƒ½å¤Ÿè®¿é—®å…·æœ‰å¯¹ GCP æˆ–ç”šè‡³ç”¨æˆ·çš„ç‰¹æƒè®¿é—®æƒé™çš„ç»„ï¼Œå› æ­¤ä» GWS åˆ° GCP çš„ç§»åŠ¨é€šå¸¸æ›´åŠ  "ç®€å•"ï¼Œå› ä¸º **GWS ä¸­çš„ç”¨æˆ·å¯¹ GCP æœ‰é«˜ç‰¹æƒ**ã€‚

### Google Groups ç‰¹æƒå‡çº§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ **è‡ªç”±åŠ å…¥ç»„ç»‡çš„ Workspace ç»„**ï¼Œè¿™äº›ç»„ **å¯èƒ½å…·æœ‰åˆ†é…çš„ GCP æƒé™**ï¼ˆæ£€æŸ¥æ‚¨çš„ç»„åœ¨ [https://groups.google.com/](https://groups.google.com/)ï¼‰ã€‚

é€šè¿‡æ»¥ç”¨ **google groups privesc**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿå‡çº§åˆ°å…·æœ‰æŸç§ç‰¹æƒè®¿é—®æƒé™çš„ç»„ã€‚

### å‚è€ƒèµ„æ–™

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„ **å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ **HackTricks** å’Œ **HackTricks Cloud** github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
