# GCP <--> Pivoting Workspace

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **Z GCP do GWS**

### **Podstawy Delegacji na Poziomie Domeny**

Delegacja na poziomie domeny Google Workspace pozwala obiektowi toÅ¼samoÅ›ci, czy to **zewnÄ™trznej aplikacji** z Google Workspace Marketplace, czy wewnÄ™trznemu **Kontu UsÅ‚ugi GCP**, na **dostÄ™p do danych w caÅ‚ym Workspace w imieniu uÅ¼ytkownikÃ³w**.

{% hint style="info" %}
Oznacza to w zasadzie, Å¼e **konta usÅ‚ug** w projektach GCP organizacji mogÄ… **podawaÄ‡ siÄ™ za uÅ¼ytkownikÃ³w Workspace** tej samej organizacji (lub nawet z innej).
{% endhint %}

Aby uzyskaÄ‡ wiÄ™cej informacji na temat tego, jak dokÅ‚adnie to dziaÅ‚a, sprawdÅº:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Skompromitowanie istniejÄ…cej delegacji

JeÅ›li atakujÄ…cy **skompromituje dostÄ™p do GCP** i **zna prawidÅ‚owy adres e-mail uÅ¼ytkownika Workspace** (najlepiej **super administratora**) firmy, moÅ¼e **wyliczyÄ‡ wszystkie projekty**, do ktÃ³rych ma dostÄ™p, **wyliczyÄ‡ wszystkie Konta UsÅ‚ug** w projektach, sprawdziÄ‡, do ktÃ³rych **kont usÅ‚ug ma dostÄ™p**, i **powtarzaÄ‡** te kroki z kaÅ¼dym kontem usÅ‚ugi, ktÃ³re moÅ¼e podawaÄ‡ siÄ™ za uÅ¼ytkownika.\
DziÄ™ki **listy wszystkich kont usÅ‚ug**, do ktÃ³rych ma **dostÄ™p**, i listy **adresÃ³w e-mail Workspace**, atakujÄ…cy mÃ³gÅ‚by prÃ³bowaÄ‡ **podawaÄ‡ siÄ™ za uÅ¼ytkownika z kaÅ¼dym kontem usÅ‚ugi**.

{% hint style="danger" %}
ZauwaÅ¼, Å¼e podczas konfigurowania delegacji na poziomie domeny nie jest wymagany uÅ¼ytkownik Workspace, dlatego wystarczy znaÄ‡ **jednego prawidÅ‚owego, co jest konieczne do podawania siÄ™ za niego**.\
Jednak **uprawnienia podawanego uÅ¼ytkownika bÄ™dÄ… wykorzystane**, wiÄ™c jeÅ›li jest to Super Administrator, bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do wszystkiego. JeÅ›li nie ma Å¼adnego dostÄ™pu, bÄ™dzie to bezuÅ¼yteczne.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

To narzÄ™dzie moÅ¼e przeprowadziÄ‡ atak, wykonujÄ…c nastÄ™pujÄ…ce kroki:

1. **Wylicz projekty GCP** za pomocÄ… interfejsu API Resource Manager.
2. Iteruj na kaÅ¼dym zasobie projektu i **wylicz zasoby Kont UsÅ‚ugi GCP**, do ktÃ³rych poczÄ…tkowy uÅ¼ytkownik IAM ma dostÄ™p, korzystajÄ…c z _GetIAMPolicy_.
3. Iteruj na **kaÅ¼dej roli konta usÅ‚ugi**, i znajdÅº wbudowane, podstawowe i niestandardowe role z uprawnieniem _**serviceAccountKeys.create**_ na docelowym zasobie konta usÅ‚ugi. NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e rola Edytora posiada to uprawnienie w sposÃ³b wbudowany.
4. UtwÃ³rz nowy **prywatny klucz `KEY_ALG_RSA_2048`** dla kaÅ¼dego zasobu konta usÅ‚ugi, ktÃ³ry zostaÅ‚ znaleziony z odpowiednim uprawnieniem w polityce IAM.
5. Iteruj na **kaÅ¼dym nowym koncie usÅ‚ugi i utwÃ³rz `JWT`** **obiekt** dla niego, ktÃ³ry skÅ‚ada siÄ™ z poÅ›wiadczeÅ„ prywatnego klucza konta usÅ‚ugi i zakresu OAuth. Proces tworzenia nowego obiektu _JWT_ bÄ™dzie **iterowaÅ‚ po wszystkich istniejÄ…cych kombinacjach zakresÃ³w OAuth** z listy **oauth\_scopes.txt**, aby znaleÅºÄ‡ wszystkie moÅ¼liwoÅ›ci delegacji. Lista **oauth\_scopes.txt** jest aktualizowana o wszystkie zakresy OAuth, ktÃ³re uznaliÅ›my za istotne do naduÅ¼ywania toÅ¼samoÅ›ci Workspace.
6. Metoda `_make_authorization_grant_assertion` ujawnia koniecznoÅ›Ä‡ zadeklarowania **docelowego uÅ¼ytkownika Workspace**, okreÅ›lanego jako _subject_, do generowania JWT w ramach DWD. ChociaÅ¼ moÅ¼e siÄ™ wydawaÄ‡, Å¼e wymaga to okreÅ›lonego uÅ¼ytkownika, waÅ¼ne jest zrozumienie, Å¼e **DWD wpÅ‚ywa na kaÅ¼dÄ… toÅ¼samoÅ›Ä‡ w domenie**. W rezultacie tworzenie JWT dla **dowolnego uÅ¼ytkownika domeny** wpÅ‚ywa na wszystkie toÅ¼samoÅ›ci w tej domenie, zgodnie z naszÄ… kontrolÄ… enumeracji kombinacji. Po prostu mÃ³wiÄ…c, jedno prawidÅ‚owe konto uÅ¼ytkownika Workspace jest wystarczajÄ…ce do kontynuacji.\
Ten uÅ¼ytkownik moÅ¼e byÄ‡ zdefiniowany w pliku _config.yaml_ DeleFriend. JeÅ›li docelowy uÅ¼ytkownik Workspace nie jest jeszcze znany, narzÄ™dzie uÅ‚atwia automatyczne identyfikowanie prawidÅ‚owych uÅ¼ytkownikÃ³w Workspace poprzez skanowanie uÅ¼ytkownikÃ³w domeny z rolami w projektach GCP. Warto zauwaÅ¼yÄ‡ (ponownie), Å¼e JWT sÄ… specyficzne dla domeny i nie sÄ… generowane dla kaÅ¼dego uÅ¼ytkownika; dlatego proces automatyczny kieruje siÄ™ w stronÄ™ jednej unikalnej toÅ¼samoÅ›ci na domenÄ™.
7. **Wylicz i utwÃ³rz nowy token dostÄ™pu typu bearer** dla kaÅ¼dego JWT i zweryfikuj token za pomocÄ… interfejsu API tokeninfo.

#### [Skrypt Pythona Gitlaba](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab stworzyÅ‚ [ten skrypt Pythona](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py), ktÃ³ry moÅ¼e wykonaÄ‡ dwie rzeczy - wyÅ›wietliÄ‡ katalog uÅ¼ytkownikÃ³w i utworzyÄ‡ nowe konto administracyjne, wskazujÄ…c plik json z poÅ›wiadczeniami SA i uÅ¼ytkownikiem do podania siÄ™ za niego. Oto jak go uÅ¼yÄ‡:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### UtwÃ³rz nowÄ… delegacjÄ™ (TrwaÅ‚oÅ›Ä‡)

MoÅ¼liwe jest **sprawdzenie Delegacji na Poziomie Domeny w** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

AtakujÄ…cy majÄ…cy zdolnoÅ›Ä‡ **tworzenia kont usÅ‚ugowych w projekcie GCP** oraz **uprawnienia super administratora w GWS mÃ³gÅ‚by utworzyÄ‡ nowÄ… delegacjÄ™ umoÅ¼liwiajÄ…cÄ… kontom usÅ‚ugowym udawanie niektÃ³rych uÅ¼ytkownikÃ³w GWS:**

1. **Generowanie nowego konta usÅ‚ugowego i odpowiadajÄ…cej pary kluczy:** Na platformie GCP, nowe zasoby kont usÅ‚ugowych mogÄ… byÄ‡ tworzone interaktywnie za pomocÄ… konsoli lub programistycznie przy uÅ¼yciu bezpoÅ›rednich wywoÅ‚aÅ„ interfejsu API i narzÄ™dzi CLI. Wymaga to roli **`iam.serviceAccountAdmin`** lub dowolnej niestandardowej roli wyposaÅ¼onej w uprawnienie **`iam.serviceAccounts.create`**. Po utworzeniu konta usÅ‚ugowego przejdziemy do wygenerowania **powiÄ…zanej pary kluczy** (uprawnienie **`iam.serviceAccountKeys.create`**).
2. **Utworzenie nowej delegacji**: WaÅ¼ne jest zrozumienie, Å¼e **tylko rola Super Administratora posiada zdolnoÅ›Ä‡ do ustawienia globalnej delegacji na Poziomie Domeny w Google Workspace** i delegacjÄ™ na Poziomie Domeny **nie moÅ¼na skonfigurowaÄ‡ programistycznie,** MoÅ¼na jÄ… jedynie utworzyÄ‡ i dostosowaÄ‡ **rÄ™cznie** za pomocÄ… konsoli Google Workspace.
* Utworzenie reguÅ‚y moÅ¼na znaleÅºÄ‡ na stronie **Kontrole API â†’ ZarzÄ…dzaj DelegacjÄ… na Poziomie Domeny w konsoli administratora Google Workspace**.
3. **Przywileje doÅ‚Ä…czania zakresÃ³w OAuth**: Podczas konfigurowania nowej delegacji, Google wymaga tylko 2 parametrÃ³w, identyfikatora klienta (Client ID), ktÃ³ry jest **ID OAuth zasobu Konta UsÅ‚ugowego GCP**, oraz **zakresÃ³w OAuth**, ktÃ³re okreÅ›lajÄ…, jakie wywoÅ‚ania API sÄ… wymagane przez delegacjÄ™.
* **PeÅ‚nÄ… listÄ™ zakresÃ³w OAuth** moÅ¼na znaleÅºÄ‡ [**tutaj**](https://developers.google.com/identity/protocols/oauth2/scopes), ale oto rekomendacja: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **DziaÅ‚anie w imieniu docelowej toÅ¼samoÅ›ci:** W tym momencie mamy dziaÅ‚ajÄ…cÄ… obiekt delegowany w GWS. Teraz, **korzystajÄ…c z prywatnego klucza konta usÅ‚ugowego GCP, moÅ¼emy wykonywaÄ‡ wywoÅ‚ania API** (w zakresie okreÅ›lonym w parametrze zakresu OAuth) w celu jego uruchomienia i **dziaÅ‚ania w imieniu dowolnej toÅ¼samoÅ›ci istniejÄ…cej w Google Workspace**. Jak siÄ™ dowiedzieliÅ›my, konto usÅ‚ugowe bÄ™dzie generowaÄ‡ tokeny dostÄ™pu zgodnie z wÅ‚asnymi potrzebami i zgodnie z uprawnieniami, jakie ma do aplikacji REST API.
* SprawdÅº **poprzedniÄ… sekcjÄ™** w celu uzyskania **narzÄ™dzi** do korzystania z tej delegacji.

#### Delegacja MiÄ™dzyorganizacyjna

ID OAuth konta usÅ‚ugowego jest globalne i moÅ¼e byÄ‡ uÅ¼ywane do **delegacji miÄ™dzyorganizacyjnej**. Nie zostaÅ‚o wprowadzone Å¼adne ograniczenie uniemoÅ¼liwiajÄ…ce delegacjÄ™ miÄ™dzyglobalnÄ…. W prostych sÅ‚owach, **konta usÅ‚ugowe z rÃ³Å¼nych organizacji GCP mogÄ… byÄ‡ uÅ¼ywane do konfigurowania delegacji na poziomie domeny w innych organizacjach Workspace**. Spowoduje to, Å¼e **wystarczy dostÄ™p Super Administratora do Workspace**, a nie dostÄ™p do tego samego konta GCP, poniewaÅ¼ przeciwnik moÅ¼e tworzyÄ‡ konta usÅ‚ugowe i klucze prywatne w swoim kontrolowanym osobiÅ›cie koncie GCP.

### Tworzenie projektu w celu wyliczenia Workspace

DomyÅ›lnie **uÅ¼ytkownicy** Workspace majÄ… uprawnienia do **tworzenia nowych projektÃ³w**, a gdy tworzony jest nowy projekt, **twÃ³rca otrzymuje rolÄ™ WÅ‚aÅ›ciciela** nad nim.

Dlatego uÅ¼ytkownik moÅ¼e **utworzyÄ‡ projekt**, **wÅ‚Ä…czyÄ‡** interfejsy **API** do wyliczenia Workspace w swoim nowym projekcie i sprÃ³bowaÄ‡ go **wyliczyÄ‡**.

{% hint style="danger" %}
Aby uÅ¼ytkownik mÃ³gÅ‚ wyliczyÄ‡ Workspace, potrzebuje rÃ³wnieÅ¼ wystarczajÄ…cych uprawnieÅ„ Workspace (nie kaÅ¼dy uÅ¼ytkownik bÄ™dzie w stanie wyliczyÄ‡ katalog).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

SprawdÅº **wiÄ™cej wyliczeÅ„ w**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### NaduÅ¼ycie Gcloud

MoÅ¼esz znaleÅºÄ‡ dalsze informacje na temat przepÅ‚ywu `gcloud` do logowania siÄ™ w:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Jak wyjaÅ›niono tam, gcloud moÅ¼e Å¼Ä…daÄ‡ zakresu `https://www.googleapis.com/auth/drive`, co pozwoliÅ‚oby uÅ¼ytkownikowi uzyskaÄ‡ dostÄ™p do dysku uÅ¼ytkownika.\
Jako atakujÄ…cy, jeÅ›li skompromitowaÅ‚eÅ› **fizycznie** komputer uÅ¼ytkownika i **uÅ¼ytkownik nadal jest zalogowany** na swoje konto, moÅ¼esz zalogowaÄ‡ siÄ™, generujÄ…c token z dostÄ™pem do dysku za pomocÄ…:
```bash
gcloud auth login --enable-gdrive-access
```
JeÅ›li atakujÄ…cy przejmie komputer uÅ¼ytkownika, moÅ¼e rÃ³wnieÅ¼ zmodyfikowaÄ‡ plik `google-cloud-sdk/lib/googlecloudsdk/core/config.py` i dodaÄ‡ do **`CLOUDSDK_SCOPES`** zakres **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
W zwiÄ…zku z tym, nastÄ™pnym razem, gdy uÅ¼ytkownik siÄ™ zaloguje, utworzy **token z dostÄ™pem do dysku**, ktÃ³ry atakujÄ…cy mÃ³gÅ‚by wykorzystaÄ‡ do uzyskania dostÄ™pu do dysku. OczywiÅ›cie, przeglÄ…darka wskaÅ¼e, Å¼e wygenerowany token bÄ™dzie miaÅ‚ dostÄ™p do dysku, ale poniewaÅ¼ uÅ¼ytkownik wywoÅ‚a polecenie **`gcloud auth login`**, prawdopodobnie **nie podejrzewa niczego.**

Aby wyÅ›wietliÄ‡ pliki dysku: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Z GWS do GCP

### DostÄ™p do uprzywilejowanych uÅ¼ytkownikÃ³w GCP

JeÅ›li atakujÄ…cy ma peÅ‚ny dostÄ™p do GWS, bÄ™dzie mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do grup z uprzywilejowanym dostÄ™pem do GCP lub nawet uÅ¼ytkownikÃ³w, dlatego przechodzenie z GWS do GCP jest zazwyczaj bardziej "proste", poniewaÅ¼ **uÅ¼ytkownicy w GWS majÄ… wysokie uprawnienia w GCP**.&#x20;

### Eskalacja uprawnieÅ„ w grupach Google

DomyÅ›lnie uÅ¼ytkownicy mogÄ… **swobodnie doÅ‚Ä…czaÄ‡ do grup Workspace w Organizacji**, a te grupy **mogÄ… mieÄ‡ przypisane uprawnienia GCP** (sprawdÅº swoje grupy na [https://groups.google.com/](https://groups.google.com/)).

WykorzystujÄ…c **google groups privesc**, moÅ¼esz byÄ‡ w stanie eskalowaÄ‡ do grupy z pewnym rodzajem uprzywilejowanego dostÄ™pu do GCP.

### OdnoÅ›niki

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
