# GCP - KMS í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì´íŠ¸

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## KMS

KMSì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

### `cloudkms.cryptoKeyVersions.destroy`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” KMS ë²„ì „ì„ íŒŒê´´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë¨¼ì € í‚¤ë¥¼ ë¹„í™œì„±í™”í•œ ë‹¤ìŒ íŒŒê´´í•´ì•¼ í•©ë‹ˆë‹¤:
```python
# pip install google-cloud-kms

from google.cloud import kms

def disable_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Disables a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to disable the key version.
client.update_crypto_key_version(request={'crypto_key_version': {'name': key_version_name, 'state': kms.CryptoKeyVersion.State.DISABLED}})

def destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version):
"""
Destroys a key version in Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Call the API to destroy the key version.
client.destroy_crypto_key_version(request={'name': key_version_name})

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'  # Version number to disable and destroy

# Disable the key version
disable_key_version(project_id, location_id, key_ring_id, key_id, key_version)

# Destroy the key version
destroy_key_version(project_id, location_id, key_ring_id, key_id, key_version)
```
### KMS ëœì„¬ì›¨ì–´

AWSì—ì„œëŠ” KMS ë¦¬ì†ŒìŠ¤ ì •ì±…ì„ ìˆ˜ì •í•˜ì—¬ ê³µê²©ì ê³„ì •ë§Œ í•´ë‹¹ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•¨ìœ¼ë¡œì¨ KMS í‚¤ë¥¼ ì™„ì „íˆ **ë„ìš©**í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. GCPì—ì„œëŠ” ì´ëŸ¬í•œ ë¦¬ì†ŒìŠ¤ ì •ì±…ì´ ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ, ì „ì—­ KMS ëœì„¬ì›¨ì–´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

* ê³µê²©ìê°€ ê°€ì ¸ì˜¨ **í‚¤ ì¬ë£Œë¡œ í‚¤ì˜ ìƒˆë¡œìš´ ë²„ì „ì„ ìƒì„±**í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
gcloud kms import-jobs create [IMPORT_JOB] --location [LOCATION] --keyring [KEY_RING] --import-method [IMPORT_METHOD] --protection-level [PROTECTION_LEVEL] --target-key [KEY]
```
{% code %}

* **ê¸°ë³¸ ë²„ì „**ìœ¼ë¡œ ì„¤ì •í•˜ì‹­ì‹œì˜¤ (ì•ìœ¼ë¡œ ì•”í˜¸í™”ë˜ëŠ” ë°ì´í„°ì— ëŒ€í•´).
* ì´ì „ ë²„ì „ìœ¼ë¡œ ì•”í˜¸í™”ëœ **ì´ì „ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ë‹¤ì‹œ ì•”í˜¸í™”**í•˜ì‹­ì‹œì˜¤.
* **KMS í‚¤ë¥¼ ì‚­ì œ**í•˜ì‹­ì‹œì˜¤.
* ì´ì œ ì›ë˜ í‚¤ ìë£Œë¥¼ ê°€ì§„ ê³µê²©ìë§Œ ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### `cloudkms.cryptoKeyVersions.useToEncrypt` | `cloudkms.cryptoKeyVersions.useToEncryptViaDelegation`
```python
from google.cloud import kms
import base64

def encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext):
"""
Encrypts data using a symmetric key from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key name.
key_name = client.crypto_key_path(project_id, location_id, key_ring_id, key_id)

# Convert the plaintext to bytes.
plaintext_bytes = plaintext.encode('utf-8')

# Call the API.
encrypt_response = client.encrypt(request={'name': key_name, 'plaintext': plaintext_bytes})
ciphertext = encrypt_response.ciphertext

# Optional: Encode the ciphertext to base64 for easier handling.
return base64.b64encode(ciphertext)

# Example usage
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
plaintext = 'your-data-to-encrypt'

ciphertext = encrypt_symmetric(project_id, location_id, key_ring_id, key_id, plaintext)
print('Ciphertext:', ciphertext)
```
### `cloudkms.cryptoKeyVersions.useToSign`

`cloudkms.cryptoKeyVersions.useToSign`ì€ Google Cloud Platform (GCP)ì˜ Key Management Service (KMS)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê¶Œí•œì…ë‹ˆë‹¤. ì´ ê¶Œí•œì€ ì•”í˜¸í™” í‚¤ ë²„ì „ì„ ì‚¬ìš©í•˜ì—¬ ì„œëª…ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. 

ì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ì•”í˜¸í™” í‚¤ ë²„ì „ì„ ì‚¬ìš©í•˜ì—¬ ì„œëª…ì„ ìƒì„±í•˜ê³ , ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì„œëª…ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì•”í˜¸í™”ëœ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ê³ , ë°ì´í„°ê°€ ì†ìƒë˜ì§€ ì•Šì•˜ìŒì„ ë³´ì¥í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

`cloudkms.cryptoKeyVersions.useToSign` ê¶Œí•œì€ ì•”í˜¸í™” í‚¤ ë²„ì „ì„ ì‚¬ìš©í•˜ì—¬ ì„œëª…ì„ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ ì¤‘ìš”í•œ ê¶Œí•œì´ë¯€ë¡œ, ì´ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê²ƒì€ ì‹ ì¤‘í•˜ê²Œ ê³ ë ¤ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ê¶Œí•œì„ ë¶€ì—¬í•  ë•ŒëŠ” ì‚¬ìš©ìì˜ ì‹ ë¢°ì„±ê³¼ ë³´ì•ˆ ìš”êµ¬ ì‚¬í•­ì„ ê³ ë ¤í•˜ì—¬ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
```python
import hashlib
from google.cloud import kms

def sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message):
"""
Sign a message using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Call the API to sign the digest.
sign_response = client.asymmetric_sign(name=key_version_name, digest=digest)
return sign_response.signature

# Example usage for signing
project_id = 'your-project-id'
location_id = 'your-location'
key_ring_id = 'your-key-ring'
key_id = 'your-key-id'
key_version = '1'
message = 'your-message'

signature = sign_asymmetric(project_id, location_id, key_ring_id, key_id, key_version, message)
print('Signature:', signature)
```
### `cloudkms.cryptoKeyVersions.useToVerify`

`cloudkms.cryptoKeyVersions.useToVerify`ëŠ” Google Cloud Platform (GCP)ì˜ Key Management Service (KMS)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê¶Œí•œì…ë‹ˆë‹¤. ì´ ê¶Œí•œì€ ì•”í˜¸í™” í‚¤ ë²„ì „ì„ ì‚¬ìš©í•˜ì—¬ ì„œëª…ì„ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ì•”í˜¸í™”ëœ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
from google.cloud import kms
import hashlib

def verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature):
"""
Verify a signature using an asymmetric key version from Cloud KMS.
"""
# Create the client.
client = kms.KeyManagementServiceClient()

# Build the key version name.
key_version_name = client.crypto_key_version_path(project_id, location_id, key_ring_id, key_id, key_version)

# Convert the message to bytes and calculate the digest.
message_bytes = message.encode('utf-8')
digest = {'sha256': hashlib.sha256(message_bytes).digest()}

# Build the verify request and call the API.
verify_response = client.asymmetric_verify(name=key_version_name, digest=digest, signature=signature)
return verify_response.success

# Example usage for verification
verified = verify_asymmetric_signature(project_id, location_id, key_ring_id, key_id, key_version, message, signature)
print('Verified:', verified)
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
