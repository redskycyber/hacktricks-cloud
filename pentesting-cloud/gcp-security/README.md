# Pentesting de GCP

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Informaci贸n b谩sica

**Antes de comenzar el pentesting** de un entorno de **GCP**, hay algunas **cosas b谩sicas que debes saber** sobre c贸mo funciona para ayudarte a entender lo que necesitas hacer, c贸mo encontrar configuraciones incorrectas y c贸mo explotarlas.

Conceptos como la jerarqu铆a de **organizaci贸n**, **permisos** y otros conceptos b谩sicos se explican en:

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## Laboratorios para aprender

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## Metodolog铆a de pentesting de GCP/Red Team

Para auditar un entorno de GCP, es muy importante saber: qu茅 **servicios se est谩n utilizando**, qu茅 se est谩 **exponiendo**, qui茅n tiene **acceso** a qu茅 y c贸mo est谩n conectados los servicios internos de GCP con los servicios **externos**.

Desde el punto de vista de un Red Team, el **primer paso para comprometer un entorno de GCP** es lograr obtener algunas **credenciales**. Aqu铆 tienes algunas ideas sobre c贸mo hacerlo:

* **Fugas** en GitHub (u otros) - OSINT
* **Ingenier铆a** social (Consulta la p谩gina [**Seguridad de Workspace**](../workspace-security.md))
* Reutilizaci贸n de **contrase帽as** (fugas de contrase帽as)
* Vulnerabilidades en aplicaciones alojadas en GCP
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) con acceso al punto de conexi贸n de metadatos
* **Lectura de archivos locales**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* **Brechas** de terceros
* Empleado **interno**

O comprometiendo un servicio sin autenticaci贸n expuesto:

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

O si est谩s haciendo una **revisi贸n**, simplemente puedes **solicitar credenciales** con estos roles:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Despu茅s de haber logrado obtener credenciales, necesitas saber **a qui茅n pertenecen esas credenciales** y **a qu茅 tienen acceso**, por lo que debes realizar una enumeraci贸n b谩sica:
{% endhint %}

## Enumeraci贸n b谩sica

### **SSRF**

Para obtener m谩s informaci贸n sobre c贸mo **enumerar metadatos de GCP**, consulta la siguiente p谩gina de hacktricks:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

En GCP, puedes probar varias opciones para intentar adivinar qui茅n eres:
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
### Enumeraci贸n de la Organizaci贸n

#### Descripci贸n

La enumeraci贸n de la organizaci贸n es el proceso de recopilar informaci贸n sobre la estructura y los recursos de una organizaci贸n en la plataforma de la nube. Esto incluye identificar los proyectos, carpetas, cuentas de servicio y otros elementos que forman parte de la organizaci贸n en Google Cloud Platform (GCP).

#### T茅cnicas de Enumeraci贸n

A continuaci贸n se presentan algunas t茅cnicas comunes utilizadas para enumerar una organizaci贸n en GCP:

1. **Enumeraci贸n de proyectos**: Identificar los proyectos existentes en la organizaci贸n utilizando comandos como `gcloud projects list` o consultando la API de GCP.

2. **Enumeraci贸n de carpetas**: Identificar las carpetas en la organizaci贸n utilizando comandos como `gcloud resource-manager folders list` o consultando la API de GCP.

3. **Enumeraci贸n de cuentas de servicio**: Identificar las cuentas de servicio en la organizaci贸n utilizando comandos como `gcloud iam service-accounts list` o consultando la API de GCP.

4. **Enumeraci贸n de pol铆ticas de IAM**: Obtener informaci贸n sobre las pol铆ticas de control de acceso en la organizaci贸n utilizando comandos como `gcloud organizations get-iam-policy` o consultando la API de GCP.

#### Recomendaciones de Seguridad

Para proteger la organizaci贸n en GCP, se recomienda seguir estas mejores pr谩cticas:

1. Limitar los privilegios de las cuentas de servicio y asignar solo los permisos necesarios.

2. Regularmente revisar y auditar las pol铆ticas de IAM para asegurarse de que solo los usuarios y servicios autorizados tengan acceso a los recursos.

3. Implementar medidas de seguridad adicionales, como la autenticaci贸n de dos factores y el monitoreo de registros, para detectar y prevenir actividades sospechosas.

4. Mantenerse actualizado sobre las 煤ltimas actualizaciones de seguridad y parches proporcionados por GCP.

#### Conclusiones

La enumeraci贸n de la organizaci贸n es un paso importante en el proceso de pentesting en la nube. Proporciona informaci贸n valiosa sobre la estructura y los recursos de una organizaci贸n en GCP, lo que ayuda a identificar posibles puntos d茅biles y mejorar la seguridad en la plataforma. Al seguir las mejores pr谩cticas de seguridad, se puede mitigar el riesgo de posibles ataques y filtraciones de datos.
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Enumeraci贸n de Principales e IAM

Si tienes suficientes permisos, **verificar los privilegios de cada entidad dentro de la cuenta de GCP** te ayudar谩 a entender lo que t煤 y otras identidades pueden hacer y c贸mo **elevar privilegios**.

Si no tienes suficientes permisos para enumerar IAM, puedes **robarlos por fuerza bruta** para descubrirlos.\
Consulta **c贸mo hacer la enumeraci贸n y fuerza bruta** en:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
Ahora que **tienes informaci贸n sobre tus credenciales** (y si eres un equipo rojo, esperemos que **no hayas sido detectado**), es hora de descubrir qu茅 servicios se est谩n utilizando en el entorno.\
En la siguiente secci贸n puedes consultar algunas formas de **enumerar algunos servicios comunes**.
{% endhint %}

## Enumeraci贸n de Servicios, Post-Explotaci贸n y Persistencia

GCP tiene una cantidad asombrosa de servicios, en la siguiente p谩gina encontrar谩s **informaci贸n b谩sica, hojas de trucos de enumeraci贸n**, c贸mo **evitar la detecci贸n**, obtener **persistencia** y otros trucos de **post-explotaci贸n** sobre algunos de ellos:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

{% content-ref url="gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](gcp-non-svc-persistance.md)
{% endcontent-ref %}

Ten en cuenta que **no** necesitas realizar todo el trabajo **manualmente**, m谩s adelante en esta publicaci贸n puedes encontrar una **secci贸n sobre** [**herramientas autom谩ticas**](./#automatic-tools).

Adem谩s, en esta etapa es posible que hayas descubierto **m谩s servicios expuestos a usuarios no autenticados**, es posible que puedas explotarlos:

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

## Escalada de Privilegios

La forma m谩s com煤n una vez que has obtenido algunas credenciales de la nube o has comprometido alg煤n servicio que se ejecuta dentro de una nube es **abusar de los privilegios mal configurados** que la cuenta comprometida pueda tener. Por lo tanto, lo primero que debes hacer es enumerar tus privilegios.

Adem谩s, durante esta enumeraci贸n, recuerda que los **permisos se pueden establecer en el nivel m谩s alto de "Organizaci贸n"** tambi茅n.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

## Servicios Expuestos P煤blicamente

Mientras enumeras los servicios de GCP, es posible que hayas encontrado algunos de ellos **exponiendo elementos a Internet** (puertos de VM/contenedores, bases de datos o servicios de cola, instant谩neas o buckets...).\
Como pentester/equipo rojo, siempre debes verificar si puedes encontrar **informaci贸n sensible/vulnerabilidades** en ellos, ya que podr铆an proporcionarte **acceso adicional a la cuenta de GCP**.

En este libro encontrar谩s **informaci贸n** sobre c贸mo encontrar **servicios expuestos de GCP y c贸mo verificarlos**. Sobre c贸mo encontrar **vulnerabilidades en servicios de red expuestos**, te recomendar铆a **buscar** el **servicio** espec铆fico en:

{% embed url="https://book.hacktricks.xyz/" %}

## Herramientas Autom谩ticas

* En la **consola de GCloud**, en [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) puedes ver los recursos y IAM que se utilizan en el proyecto.
* Aqu铆 puedes ver los activos admitidos por esta API: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* Consulta las **herramientas** que se pueden [**utilizar en varias nubes aqu铆**](../pentesting-cloud-methodology.md).
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Este es un esc谩ner de recursos de GCP que puede ayudar a determinar qu茅 **nivel de acceso tienen ciertas credenciales** en GCP.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): Script de Bash para enumerar un entorno de GCP utilizando la interfaz de l铆nea de comandos de gcloud y guardar los resultados en un archivo.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): Scripts para enumerar privilegios IAM elevados y para escalar privilegios en GCP abusando de ellos (no pude hacer funcionar el script de enumeraci贸n).

## Configuraci贸n y depuraci贸n de gcloud
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### Captura de red de gcloud, gsutil...

Recuerda que puedes utilizar el **par谩metro** **`--log-http`** con la herramienta **`gcloud`** cli para **imprimir** las **solicitudes** que realiza la herramienta. Si no deseas que los registros oculten el valor del token, utiliza `gcloud config set log_http_redact_token false`

Adem谩s, para interceptar la comunicaci贸n:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
