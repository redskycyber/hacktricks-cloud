# GCP - å­˜å‚¨æƒé™æå‡

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## å­˜å‚¨

### `storage.objects.get`

æ­¤æƒé™å…è®¸æ‚¨**ä¸‹è½½å­˜å‚¨åœ¨ Gcp å­˜å‚¨ä¸­çš„æ–‡ä»¶**ã€‚è¿™å¯èƒ½å…è®¸æ‚¨æå‡æƒé™ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹**æ•æ„Ÿä¿¡æ¯è¢«ä¿å­˜åœ¨é‚£é‡Œ**ã€‚æ­¤å¤–ï¼Œä¸€äº› Gcp æœåŠ¡å°†å…¶ä¿¡æ¯å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼š

* **GCP Composer**ï¼šå½“æ‚¨åˆ›å»º Composer ç¯å¢ƒæ—¶ï¼Œ**æ‰€æœ‰ DAG çš„ä»£ç **å°†ä¿å­˜åœ¨**å­˜å‚¨æ¡¶**ä¸­ã€‚è¿™äº›ä»»åŠ¡å¯èƒ½åœ¨å…¶ä»£ç ä¸­åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ã€‚
* **GCR (å®¹å™¨æ³¨å†Œè¡¨)**ï¼šå®¹å™¨çš„**é•œåƒ**å­˜å‚¨åœ¨**å­˜å‚¨æ¡¶**ä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨å¯ä»¥è¯»å–å­˜å‚¨æ¡¶ï¼Œæ‚¨å°†èƒ½å¤Ÿä¸‹è½½é•œåƒå¹¶**æœç´¢æ³„éœ²å’Œ/æˆ–æºä»£ç **ã€‚

### `storage.objects.create`, `storage.objects.delete`

è¦åœ¨å­˜å‚¨æ¡¶ä¸­**åˆ›å»ºæ–°å¯¹è±¡**ï¼Œæ‚¨éœ€è¦ `storage.objects.create`ï¼Œå¹¶ä¸”æ ¹æ®[æ–‡æ¡£](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions)ï¼Œæ‚¨è¿˜éœ€è¦ `storage.objects.delete` æ¥**ä¿®æ”¹**ç°æœ‰å¯¹è±¡ã€‚

åœ¨äº‘ä¸­å¯ä»¥å†™å…¥å­˜å‚¨æ¡¶çš„æƒ…å†µä¸‹ï¼Œ**å¸¸è§çš„åˆ©ç”¨**æ˜¯å¦‚æœ**å­˜å‚¨æ¡¶æ­£åœ¨ä¿å­˜ Web æœåŠ¡å™¨æ–‡ä»¶**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**å­˜å‚¨æ–°ä»£ç **ï¼Œè¯¥ä»£ç å°†è¢« Web åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚

æ­¤å¤–ï¼Œå‡ ä¸ª GCP æœåŠ¡ä¹Ÿ**åœ¨å­˜å‚¨æ¡¶ä¸­å­˜å‚¨ä»£ç **ï¼Œç¨åå°†**æ‰§è¡Œ**ï¼š

* **GCP Composer**ï¼š**DAG ä»£ç **å­˜å‚¨åœ¨ GCP å­˜å‚¨ä¸­ã€‚è¿™**ä»£ç **ç¨ååœ¨ Composer ä½¿ç”¨çš„**K8s ç¯å¢ƒ**ä¸­**æ‰§è¡Œ**ï¼Œå¹¶ä¸”è¿˜å¯ä»¥**è®¿é—® GCP SA**ã€‚å› æ­¤ï¼Œä¿®æ”¹è¿™äº›ä»£ç ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè¿›å…¥ composer k8s ç¯å¢ƒå¹¶çªƒå–æ‰€ä½¿ç”¨çš„ GCP SA çš„ä»¤ç‰Œã€‚
* **GCR (å®¹å™¨æ³¨å†Œè¡¨)**ï¼š**å®¹å™¨é•œåƒå­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­**ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å¯¹å®ƒä»¬æœ‰å†™æƒé™ï¼Œæ‚¨å¯ä»¥**ä¿®æ”¹é•œåƒ**å¹¶åœ¨ä½¿ç”¨è¯¥å®¹å™¨æ—¶æ‰§è¡Œæ‚¨è‡ªå·±çš„ä»£ç ã€‚
* GCR ä½¿ç”¨çš„å­˜å‚¨æ¡¶çš„ URL ç±»ä¼¼äº `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`ï¼ˆé¡¶çº§å­åŸŸåœ¨[è¿™é‡Œ](https://cloud.google.com/container-registry/docs/pushing-and-pulling)æŒ‡å®šï¼‰ã€‚

### `storage.objects.setIamPolicy`

æ‚¨å¯ä»¥ç»™è‡ªå·±æƒé™æ¥**æ»¥ç”¨æœ¬èŠ‚ä¸­çš„ä»»ä½•å‰è¿°åœºæ™¯**ã€‚

### **`storage.buckets.setIamPolicy`**

æœ‰å…³å¦‚ä½•ä½¿ç”¨æ­¤æƒé™ä¿®æ”¹æƒé™çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage æœ‰ä¸€ä¸ªâ€œäº’æ“ä½œæ€§â€åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸€ç§è®© Cloud Storage ä¸å…¶ä»–äº‘æä¾›å•†ï¼ˆå¦‚ AWS S3ï¼‰çš„å­˜å‚¨äº§å“äº’åŠ¨çš„æ–¹å¼ã€‚ä½œä¸ºè¯¥åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ä¸ºæœåŠ¡è´¦æˆ·å’Œæ™®é€šç”¨æˆ·åˆ›å»º HMAC å¯†é’¥ã€‚æˆ‘ä»¬å¯ä»¥**é€šè¿‡ä¸ºæƒé™æ›´é«˜çš„æœåŠ¡è´¦æˆ·åˆ›å»º HMAC å¯†é’¥æ¥æå‡ Cloud Storage æƒé™**ã€‚

å±äºæ‚¨ç”¨æˆ·çš„ HMAC å¯†é’¥æ— æ³•é€šè¿‡ API è®¿é—®ï¼Œå¿…é¡»é€šè¿‡ Web æ§åˆ¶å°è®¿é—®ï¼Œä½†å¥½çš„æ˜¯ï¼Œè®¿é—®å¯†é’¥å’Œå¯†é’¥åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ç”¨ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å–ä¸€ä¸ªç°æœ‰çš„å¯¹å¹¶å°†å®ƒä»¬å­˜å‚¨èµ·æ¥ï¼Œä»¥å¤‡å°†æ¥è®¿é—®è´¦æˆ·ã€‚å±äºæœåŠ¡è´¦æˆ·çš„ HMAC å¯†é’¥**å¯ä»¥**é€šè¿‡ API è®¿é—®ï¼Œä½†åˆ›å»ºåï¼Œæ‚¨å°†æ— æ³•å†æ¬¡çœ‹åˆ°è®¿é—®å¯†é’¥å’Œå¯†é’¥ã€‚

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

æ­¤æ–¹æ³•çš„åˆ©ç”¨è„šæœ¬å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)æ‰¾åˆ°ã€‚

## storage.objects å†™æƒé™

å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹æˆ–æ·»åŠ å­˜å‚¨æ¡¶ä¸­çš„å¯¹è±¡ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæå‡æƒé™åˆ°å…¶ä»–ä½¿ç”¨å­˜å‚¨æ¡¶å­˜å‚¨ä»–ä»¬æ‰§è¡Œçš„ä»£ç çš„èµ„æºã€‚

### Composer

**Composer** æ˜¯åœ¨ GCP ä¸­ç®¡ç†çš„ **Apache Airflow**ã€‚å®ƒæœ‰å‡ ä¸ªæœ‰è¶£çš„ç‰¹ç‚¹ï¼š

* å®ƒåœ¨ **GKE é›†ç¾¤**ä¸­è¿è¡Œï¼Œå› æ­¤é›†ç¾¤ä½¿ç”¨çš„ **SA å¯ä»¥è¢« Composer å†…éƒ¨è¿è¡Œçš„ä»£ç è®¿é—®**
* å®ƒå°†**ä»£ç å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­**ï¼Œå› æ­¤ï¼Œ**ä»»ä½•å¯¹è¯¥å­˜å‚¨æ¡¶æœ‰å†™æƒé™çš„äºº**éƒ½å°†èƒ½å¤Ÿæ›´æ”¹/æ·»åŠ  DGA ä»£ç ï¼ˆApache Airflow å°†æ‰§è¡Œçš„ä»£ç ï¼‰\
ç„¶åï¼Œå¦‚æœæ‚¨å¯¹ Composer ä½¿ç”¨çš„å­˜å‚¨æ¡¶æœ‰**å†™æƒé™**æ¥å­˜å‚¨ä»£ç ï¼Œæ‚¨å¯ä»¥**æå‡æƒé™åˆ° GKE é›†ç¾¤ä¸­è¿è¡Œçš„ SA**ã€‚

### Cloud Functions

* Cloud Functions çš„ä»£ç å­˜å‚¨åœ¨ Storage ä¸­ï¼Œå› æ­¤**è¦†ç›–å®ƒï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç **ã€‚

### App Engine

* App Engine çš„æºä»£ç å­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œ**è¦†ç›–ä»£ç å¯èƒ½å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç **

### GCR

* **Google å®¹å™¨æ³¨å†Œè¡¨**å°†é•œåƒå­˜å‚¨åœ¨å­˜å‚¨æ¡¶ä¸­ï¼Œå¦‚æœæ‚¨å¯ä»¥**å†™å…¥è¿™äº›å­˜å‚¨æ¡¶**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**æ¨ªå‘ç§»åŠ¨åˆ°è¿è¡Œè¿™äº›å­˜å‚¨æ¡¶çš„åœ°æ–¹ã€‚**

## **å‚è€ƒèµ„æ–™**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
