# GCP - Escalaci贸n de Privilegios en Almacenamiento

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Almacenamiento

Informaci贸n B谩sica:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Este permiso te permite **descargar archivos almacenados dentro de Cloud Storage**. Esto podr铆a permitirte escalar privilegios porque en algunas ocasiones **se guarda informaci贸n sensible all铆**. Adem谩s, algunos servicios de GCP almacenan su informaci贸n en buckets:

* **GCP Composer**: Cuando creas un Entorno de Composer, el **c贸digo de todos los DAGs** se guardar谩 dentro de un **bucket**. Estas tareas pueden contener informaci贸n interesante en su c贸digo.
* **GCR (Container Registry)**: La **imagen** de los contenedores se almacena dentro de **buckets**, lo que significa que si puedes leer los buckets podr谩s descargar las im谩genes y **buscar fugas y/o c贸digo fuente**.

### `storage.objects.setIamPolicy`

Puedes darte permiso para **abusar de cualquiera de los escenarios anteriores de esta secci贸n**.

### **`storage.buckets.setIamPolicy`**

Para un ejemplo de c贸mo modificar permisos con este permiso, consulta esta p谩gina:

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Hay una caracter铆stica de Cloud Storage, "interoperabilidad", que proporciona una forma para que Cloud Storage interact煤e con ofertas de almacenamiento de otros proveedores de la nube, como AWS S3. Como parte de eso, se pueden crear claves HMAC tanto para Cuentas de Servicio como para usuarios regulares. Podemos **escalar los permisos de Cloud Storage creando una clave HMAC para una Cuenta de Servicio con mayores privilegios**.

Las claves HMAC pertenecientes a tu usuario no se pueden acceder a trav茅s de la API y deben ser accedidas a trav茅s de la consola web, pero lo bueno es que tanto la clave de acceso como la clave secreta est谩n disponibles en cualquier momento. Esto significa que podr铆amos tomar un par existente y almacenarlos para acceso de respaldo a la cuenta. Las claves HMAC pertenecientes a Cuentas de Servicio **pueden** ser accedidas a trav茅s de la API, pero despu茅s de la creaci贸n, no podr谩s ver la clave de acceso y el secreto nuevamente.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Otro script de explotaci贸n para este m茅todo se puede encontrar [aqu铆](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permisos de escritura en Storage

Para **crear un nuevo objeto** dentro de un bucket necesitas `storage.objects.create` y, seg煤n [la documentaci贸n](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), tambi茅n necesitas `storage.objects.delete` para **modificar** un objeto existente.

Una **explotaci贸n com煤n** de buckets donde puedes escribir en la nube es en caso de que el **bucket est茅 guardando archivos de un servidor web**, podr铆as ser capaz de **almacenar nuevo c贸digo** que ser谩 utilizado por la aplicaci贸n web.

### Composer

**Composer** es **Apache Airflow** gestionado dentro de GCP. Tiene varias caracter铆sticas interesantes:

* Se ejecuta dentro de un **cluster de GKE**, por lo que el **SA que utiliza el cluster es accesible** por el c贸digo que se ejecuta dentro de Composer
* Almacena el **c贸digo en un bucket**, por lo tanto, **cualquiera con acceso de escritura sobre ese bucket** va a poder cambiar/agregar un c贸digo DGA (el c贸digo que Apache Airflow ejecutar谩)\
Entonces, si tienes **acceso de escritura sobre el bucket que Composer est谩 usando** para almacenar el c贸digo, puedes **escalar privilegios al SA que se ejecuta en el cluster de GKE**.

### Cloud Functions

* El c贸digo de Cloud Functions se almacena en Storage, por lo que **sobrescribirlo, es posible ejecutar c贸digo arbitrario**.

### App Engine

* El c贸digo fuente de App Engine se almacena en buckets, **sobrescribir el c贸digo podr铆a hacer posible ejecutar c贸digo arbitrario.**

### GCR

* **Google Container Registry** almacena las im谩genes dentro de buckets, si puedes **escribir en esos buckets** podr铆as ser capaz de **moverte lateralmente a donde esos buckets se est谩n ejecutando.**
* El bucket utilizado por GCR tendr谩 una URL similar a `gs://<eu/usa/asia/nada>.artifacts.<proyecto>.appspot.com` (Los subdominios de nivel superior est谩n especificados [aqu铆](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Referencias**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
