# GCP - Escalaci칩n de Privilegios en Almacenamiento

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Almacenamiento

Informaci칩n B치sica:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Este permiso te permite **descargar archivos almacenados dentro de Cloud Storage**. Esto podr칤a permitirte escalar privilegios porque en algunas ocasiones **se guarda informaci칩n sensible all칤**. Adem치s, algunos servicios de GCP almacenan su informaci칩n en buckets:

* **GCP Composer**: Cuando creas un Entorno de Composer, el **c칩digo de todos los DAGs** se guardar치 dentro de un **bucket**. Estas tareas pueden contener informaci칩n interesante en su c칩digo.
* **GCR (Container Registry)**: La **imagen** de los contenedores se almacena dentro de **buckets**, lo que significa que si puedes leer los buckets podr치s descargar las im치genes y **buscar fugas y/o c칩digo fuente**.

### `storage.objects.setIamPolicy`

Puedes darte permiso para **abusar de cualquiera de los escenarios anteriores de esta secci칩n**.

### **`storage.buckets.setIamPolicy`**

Para un ejemplo de c칩mo modificar permisos con este permiso, consulta esta p치gina:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Hay una caracter칤stica de Cloud Storage, "interoperabilidad", que proporciona una forma para que Cloud Storage interact칰e con ofertas de almacenamiento de otros proveedores de la nube, como AWS S3. Como parte de eso, se pueden crear claves HMAC tanto para Cuentas de Servicio como para usuarios regulares. Podemos **escalar los permisos de Cloud Storage creando una clave HMAC para una Cuenta de Servicio con mayores privilegios**.

Las claves HMAC pertenecientes a tu usuario no se pueden acceder a trav칠s de la API y deben ser accedidas a trav칠s de la consola web, pero lo bueno es que tanto la clave de acceso como la clave secreta est치n disponibles en cualquier momento. Esto significa que podr칤amos tomar un par existente y almacenarlos para acceso de respaldo a la cuenta. Las claves HMAC pertenecientes a Cuentas de Servicio **pueden** ser accedidas a trav칠s de la API, pero despu칠s de la creaci칩n, no podr치s ver la clave de acceso y el secreto nuevamente.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Otro script de explotaci칩n para este m칠todo se puede encontrar [aqu칤](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permisos de escritura en Storage

Para **crear un nuevo objeto** dentro de un bucket necesitas `storage.objects.create` y, seg칰n [la documentaci칩n](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), tambi칠n necesitas `storage.objects.delete` para **modificar** un objeto existente.

Una **explotaci칩n muy com칰n** de buckets donde puedes escribir en la nube es en caso de que el **bucket est칠 guardando archivos de un servidor web**, podr칤as ser capaz de **almacenar nuevo c칩digo** que ser치 utilizado por la aplicaci칩n web.

### Composer

**Composer** es **Apache Airflow** gestionado dentro de GCP. Tiene varias caracter칤sticas interesantes:

* Se ejecuta dentro de un **cluster de GKE**, por lo que el **SA que utiliza el cluster es accesible** por el c칩digo que se ejecuta dentro de Composer
* Almacena el **c칩digo en un bucket**, por lo tanto, **cualquiera con acceso de escritura sobre ese bucket** va a poder cambiar/agregar un c칩digo DGA (el c칩digo que Apache Airflow ejecutar치)\
Entonces, si tienes **acceso de escritura sobre el bucket que Composer est치 usando** para almacenar el c칩digo, puedes **escalar privilegios al SA que se ejecuta en el cluster de GKE**.

### Cloud Functions

* El c칩digo de Cloud Functions se almacena en Storage, por lo que **sobrescribirlo, es posible ejecutar c칩digo arbitrario**.

### App Engine

* El c칩digo fuente de App Engine se almacena en buckets, **sobrescribir el c칩digo podr칤a hacer posible ejecutar c칩digo arbitrario. ESTO NO ES POSIBLE**
* **Parece que las capas del contenedor se almacenan en el bucket, 쯦al vez cambiando esas?**

### GCR

* **Google Container Registry** almacena las im치genes dentro de buckets, si puedes **escribir esos buckets** podr칤as ser capaz de **moverte lateralmente a donde esos buckets se est치n ejecutando.**
* El bucket utilizado por GCR tendr치 una URL similar a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Los subdominios de nivel superior est치n especificados [aqu칤](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Referencias**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
