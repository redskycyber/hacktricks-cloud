# GCP - Privilege Escalation di Storage

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Storage

Informazioni di base:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Questa autorizzazione ti consente di **scaricare file memorizzati all'interno di Cloud Storage**. Ci√≤ potrebbe consentirti di ottenere privilegi pi√π elevati perch√© in alcune occasioni **informazioni sensibili vengono salvate l√¨**. Inoltre, alcuni servizi GCP memorizzano le loro informazioni in bucket:

* **GCP Composer**: Quando crei un ambiente Composer, il **codice di tutti i DAG** verr√† salvato all'interno di un **bucket**. Questi task potrebbero contenere informazioni interessanti all'interno del loro codice.
* **GCR (Container Registry)**: L'**immagine** dei container viene memorizzata all'interno di **bucket**, il che significa che se puoi leggere i bucket sarai in grado di scaricare le immagini e **cercare perdite e/o codice sorgente**.

### `storage.objects.setIamPolicy`

Puoi concederti l'autorizzazione per **abusare di uno qualsiasi degli scenari precedenti di questa sezione**.

### **`storage.buckets.setIamPolicy`**

Per un esempio su come modificare le autorizzazioni con questa autorizzazione, controlla questa pagina:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

La funzionalit√† di "interoperabilit√†" di Cloud Storage, progettata per **interazioni tra cloud** come con AWS S3, comporta la **creazione di chiavi HMAC per Service Account e utenti**. Un attaccante pu√≤ sfruttare ci√≤ generando una chiave HMAC per un Service Account con privilegi elevati, **escalando cos√¨ i privilegi all'interno di Cloud Storage**. Mentre le chiavi HMAC associate all'utente sono recuperabili solo tramite la console web, sia l'accesso che le chiavi segrete rimangono **perpetuamente accessibili**, consentendo un potenziale accesso di backup. Al contrario, le chiavi HMAC associate al Service Account sono accessibili tramite API, ma le loro chiavi di accesso e segrete non sono recuperabili dopo la creazione, aggiungendo un livello di complessit√† per l'accesso continuo.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Un altro script di exploit per questo metodo pu√≤ essere trovato [qui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permessi di scrittura su Storage

Per poter **creare un nuovo oggetto** all'interno di un bucket, √® necessario avere il permesso `storage.objects.create` e, secondo [la documentazione](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), √® necessario anche il permesso `storage.objects.delete` per **modificare** un oggetto esistente.

Un'exploit molto **comune** dei bucket in cui √® possibile scrivere nel cloud avviene nel caso in cui il **bucket stia salvando file del server web**, potresti essere in grado di **memorizzare nuovo codice** che verr√† utilizzato dall'applicazione web.

### Composer

**Composer** √® **Apache Airflow** gestito all'interno di GCP. Ha diverse funzionalit√† interessanti:

* Viene eseguito all'interno di un **cluster GKE**, quindi il **SA utilizzato dal cluster √® accessibile** dal codice in esecuzione all'interno di Composer.
* Memorizza il **codice in un bucket**, quindi **chiunque abbia accesso in scrittura a quel bucket** sar√† in grado di modificare/aggiungere un codice DGA (il codice che Apache Airflow eseguir√†).\
Quindi, se hai **accesso in scrittura al bucket utilizzato da Composer** per memorizzare il codice, puoi **elevare i privilegi all'account di servizio in esecuzione nel cluster GKE**.

### Cloud Functions

* Il codice di Cloud Functions viene memorizzato in Storage, quindi sovrascrivendolo, √® possibile eseguire codice arbitrario.

### App Engine

* Il codice sorgente di App Engine viene memorizzato in bucket, **sovrascrivendo il codice potrebbe essere possibile eseguire codice arbitrario. QUESTO NON √à POSSIBILE**
* **Sembra che i layer dei container siano memorizzati nel bucket, forse cambiando quelli?**

### GCR

* **Google Container Registry** memorizza le immagini all'interno di bucket, se puoi **scrivere su quei bucket** potresti essere in grado di **muoverti lateralmente verso dove vengono eseguiti quei bucket**.
* Il bucket utilizzato da GCR avr√† un URL simile a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (I sottodomini di primo livello sono specificati [qui](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Riferimenti**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
