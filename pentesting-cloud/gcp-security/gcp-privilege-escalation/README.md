# GCP - Eskalacija privilegija

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Uvod u eskalaciju privilegija u GCP-u <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kao i svaki drugi oblak, ima neke **principale**: korisnike, grupe i servisne naloge, i neke **resurse** poput raÄunarskog sistema, cloud funkcija...\
Zatim, putem uloga, **dodeljuju se dozvole tim principima nad resursima**. To je naÄin da se specificira dozvole koje princip ima nad resursom u GCP-u.\
Postoje odreÄ‘ene dozvole koje Ä‡e omoguÄ‡iti korisniku da **dobije joÅ¡ viÅ¡e dozvola** nad resursom ili resursima treÄ‡ih strana, a to se naziva **eskalacija privilegija** (takoÄ‘e, iskoriÅ¡Ä‡avanje ranjivosti da bi se dobile viÅ¡e dozvole).

Stoga, Å¾eleo bih da razdvojim tehnike eskalacije privilegija u GCP-u u **2 grupe**:

* **Privesc na principala**: To Ä‡e vam omoguÄ‡iti da **se predstavljate kao drugi princip**, i stoga delujete kao da imate sve njegove dozvole. npr.: Zloupotreba _getAccessToken_ da bi se predstavljao kao servisni nalog.
* **Privesc na resursu**: To Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e dozvola nad odreÄ‘enim resursom**. npr.: moÅ¾ete zloupotrebiti dozvolu _setIamPolicy_ nad cloud funkcijama da biste omoguÄ‡ili pokretanje funkcije.
* Imajte na umu da Ä‡e neke **dozvole za resurse takoÄ‘e omoguÄ‡iti da pridruÅ¾ite proizvoljni servisni nalog** resursu. To znaÄi da Ä‡ete moÄ‡i da pokrenete resurs sa SA, uÄ‘ete u resurs i **ukradete SA token**. Stoga Ä‡e vam to omoguÄ‡iti eskalaciju na principala putem eskalacije resursa. Ovo se dogodilo u nekoliko resursa ranije, ali sada je manje uobiÄajeno (ali se i dalje moÅ¾e dogoditi).

OÄigledno, najinteresantnije tehnike eskalacije privilegija su one iz **druge grupe**, jer Ä‡e vam omoguÄ‡iti da **dobijete viÅ¡e privilegija izvan resursa nad kojima veÄ‡ imate neke privilegije**. MeÄ‘utim, imajte na umu da **eskalacija u resursima** moÅ¾e vam dati i pristup **osetljivim informacijama** ili Äak **drugim principima** (moÅ¾da putem Äitanja tajne koja sadrÅ¾i token SA).

{% hint style="warning" %}
VaÅ¾no je napomenuti da su u **GCP servisni nalozi i principali i dozvole**, pa Ä‡e eskalacija privilegija u SA vam omoguÄ‡iti i da se predstavljate kao taj SA.
{% endhint %}

{% hint style="info" %}
Dozvole izmeÄ‘u zagrada ukazuju na dozvole potrebne za iskoriÅ¡Ä‡avanje ranjivosti pomoÄ‡u `gcloud`-a. One moÅ¾da neÄ‡e biti potrebne ako se iskoriÅ¡tava putem API-ja.
{% endhint %}

## Dozvole za metodologiju eskalacije privilegija

Ovako **testiram specifiÄne dozvole** za izvoÄ‘enje odreÄ‘enih radnji unutar GCP-a.

1. Preuzmite github repozitorijum [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodajte novi skriptu u tests/

## ZaobilaÅ¾enje pristupnih opsega <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeni SA koji su procurili iz GCP metadata servisa imaju **pristupne opsege**. To su **ograniÄenja** na **dozvole** koje token ima. Na primer, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform`**, imaÄ‡e **puni pristup** svim GCP uslugama. MeÄ‘utim, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform.read-only`**, imaÄ‡e samo **samo za Äitanje pristup** svim GCP uslugama, Äak i ako SA ima viÅ¡e dozvola u IAM-u.

Ne postoji direktni naÄin za zaobilaÅ¾enje ovih dozvola, ali uvek moÅ¾ete pokuÅ¡ati da **traÅ¾ite nove akreditive** na kompromitovanom hostu, **pronaÄ‘ete kljuÄ servisa** da biste generisali OAuth token bez ograniÄenja ili **preÄ‘ete na drugi VM sa manje restrikcija**.

Kada se koriste [pristupni opsezi](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), OAuth token koji se generiÅ¡e za raÄunarski instancu (VM) Ä‡e **imati ograniÄenje opsega** [**ukljuÄeno**](https://oauth.net/2/scope/). MeÄ‘utim, moÅ¾da Ä‡ete moÄ‡i da **zaobiÄ‘ete** ovo ograniÄenje i iskoristite dozvole koje kompromitovani nalog ima.

**Najbolji naÄin za zaobilaÅ¾enje** ovog ograniÄenja je ili da **pronaÄ‘ete nove akreditive** na kompromitovanom hostu, da **pronaÄ‘ete kljuÄ servisa za generisanje OAuth tokena** bez ograniÄenja ili da **kompromitujete drugi VM sa manje restrikcija**.

Proverite SA sa generisanim kljuÄevima koristeÄ‡i:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tehnike eskalacije privilegija

NaÄin da eskalirate svoje privilegije u GCP-u je da imate dovoljno dozvola da biste mogli, na neki naÄin, pristupiti privilegijama drugih servisnih naloga/korisnika/grupa. Povezivanje eskalacija dok ne dobijete administratorski pristup organizaciji.

{% hint style="warning" %}
GCP ima **stotine** (ako ne i hiljade) **dozvola** koje entitet moÅ¾e dobiti. U ovoj knjizi moÅ¾ete pronaÄ‡i **sve dozvole koje znam** koje moÅ¾ete zloupotrebiti za **eskalciju privilegija**, ali ako **znate neki drugi put** koji ovde nije naveden, **molimo vas da ga podelite**.
{% endhint %}

MoÅ¾ete pronaÄ‡i sve **putanje eskalacije privilegija podeljene po uslugama**:

* [**Apikeys eskalacija privilegija**](gcp-apikeys-privesc.md)
* [**Cloudbuild eskalacija privilegija**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions eskalacija privilegija**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler eskalacija privilegija**](gcp-cloudscheduler-privesc.md)
* [**Compute eskalacija privilegija**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer eskalacija privilegija**](gcp-composer-privesc.md)
* [**Container eskalacija privilegija**](gcp-container-privesc.md)
* [**Deploymentmanager eskalacija privilegija**](gcp-deploymentmaneger-privesc.md)
* [**IAM eskalacija privilegija**](gcp-iam-privesc.md)
* [**KMS eskalacija privilegija**](gcp-kms-privesc.md)
* [**Orgpolicy eskalacija privilegija**](gcp-orgpolicy-privesc.md)
* [**Pubsub eskalacija privilegija**](gcp-pubsub-privesc.md)
* [**Resourcemanager eskalacija privilegija**](gcp-resourcemanager-privesc.md)
* [**Run eskalacija privilegija**](gcp-run-privesc.md)
* [**Secretmanager eskalacija privilegija**](gcp-secretmanager-privesc.md)
* [**Serviceusage eskalacija privilegija**](gcp-serviceusage-privesc.md)
* [**Source Repos eskalacija privilegija**](gcp-sourcerepos-privesc.md)
* [**Storage eskalacija privilegija**](gcp-storage-privesc.md)
* [**Misc eskalacija privilegija**](gcp-misc-perms-privesc.md)

### Zloupotreba GCP-a za lokalnu eskalaciju privilegija

Ako se nalazite unutar maÅ¡ine u GCP-u, moÅ¾da Ä‡ete moÄ‡i zloupotrebiti dozvole za lokalnu eskalaciju privilegija:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini da podrÅ¾ite HackTricks:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
