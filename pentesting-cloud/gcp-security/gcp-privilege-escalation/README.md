# GCP - Eskalacja uprawnie

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wprowadzenie do eskalacji uprawnie w GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, podobnie jak ka偶da inna chmura, ma pewne **podmioty**: u偶ytkownik贸w, grupy i konta usug, oraz pewne **zasoby**, takie jak maszyny obliczeniowe, funkcje chmury...\
Nastpnie, za pomoc r贸l, **przyznawane s uprawnienia tym podmiotom wobec zasob贸w**. To jest spos贸b okrelania uprawnie, jakie podmiot ma wobec zasobu w GCP.\
Istniej pewne uprawnienia, kt贸re pozwol u偶ytkownikowi **uzyska jeszcze wicej uprawnie** wobec zasobu lub zasob贸w os贸b trzecich, i to jest to, co nazywamy **eskalacj uprawnie** (a tak偶e wykorzystaniem podatnoci w celu uzyskania wikszych uprawnie).

Dlatego chciabym podzieli techniki eskalacji uprawnie w GCP na **2 grupy**:

* **Eskalacja uprawnie do podmiotu**: Pozwoli ci to **udawa innego podmiotu** i dziaa w jego imieniu ze wszystkimi jego uprawnieniami. np.: Wykorzystanie _getAccessToken_ do udawania konta usugi.
* **Eskalacja uprawnie w zasobie**: Pozwoli ci to **uzyska wicej uprawnie wobec konkretnego zasobu**. np.: Mo偶esz wykorzysta uprawnienie _setIamPolicy_ w funkcjach chmury, aby umo偶liwi wywoanie funkcji.
* Nale偶y zauwa偶y, 偶e niekt贸re **uprawnienia zasob贸w pozwol ci r贸wnie偶 doczy dowolne konto usugi** do zasobu. Oznacza to, 偶e bdziesz m贸g uruchomi zas贸b z kontem usugi, wej do zasobu i **ukra token konta usugi**. Dlatego bdziesz m贸g eskalowa uprawnienia do podmiotu za porednictwem eskalacji zasobu. Wczeniej zdarzao si to w przypadku wielu zasob贸w, ale teraz jest to mniej czste (ale wci偶 mo偶liwe).

Oczywicie, najbardziej interesujce techniki eskalacji uprawnie to te z **drugiej grupy**, poniewa偶 pozwol ci **uzyska wicej uprawnie poza zasobami, w kt贸rych ju偶 masz pewne uprawnienia**. Jednak nale偶y zauwa偶y, 偶e **eskalacja w zasobach** mo偶e r贸wnie偶 da ci dostp do **wra偶liwych informacji** lub nawet do **innych podmiot贸w** (mo偶e to by mo偶liwe poprzez odczytanie tajemnicy zawierajcej token konta usugi).

{% hint style="warning" %}
Warto r贸wnie偶 zauwa偶y, 偶e w **kontach usug GCP zar贸wno podmioty, jak i uprawnienia** s to偶same, wic eskalacja uprawnie w koncie usugi pozwoli ci r贸wnie偶 na udawanie go.
{% endhint %}

{% hint style="info" %}
Uprawnienia w nawiasach wskazuj uprawnienia potrzebne do wykorzystania podatnoci za pomoc `gcloud`. Mog one nie by potrzebne, jeli wykorzystasz j za pomoc interfejsu API.
{% endhint %}

## Uprawnienia dla metodologii eskalacji uprawnie

Tak **testuj konkretne uprawnienia** do wykonania okrelonych dziaa w GCP.

1. Pobierz repozytorium github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodaj nowy skrypt do folderu tests/

## Omijanie zakres贸w dostpu <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeny kont usug (SA) wyciekajce z usugi metadanych GCP maj **zakresy dostpu**. S to **ograniczenia** dotyczce **uprawnie**, jakie posiada token. Na przykad, jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform`**, bdzie mia **peny dostp** do wszystkich usug GCP. Jednak jeli token ma zakres **`https://www.googleapis.com/auth/cloud-platform.read-only`**, bdzie mia tylko **dostp tylko do odczytu** do wszystkich usug GCP, nawet jeli konto usugi ma wicej uprawnie w IAM.

Nie ma bezporedniego sposobu na obejcie tych uprawnie, ale zawsze mo偶esz spr贸bowa wyszuka **nowe powiadczenia** na skompromitowanym hocie, **znale藕 klucz usugi do wygenerowania tokenu OAuth bez ogranicze** lub **przej do innego mniej ograniczonego VM**.

Kiedy s u偶ywane [zakresy dostpu](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), token OAuth generowany dla instancji obliczeniowej (VM) **bdzie zawiera ograniczenie zakresu** [**scope**](https://oauth.net/2/scope/). Jednak mo偶esz by w stanie **obej** to ograniczenie i wykorzysta uprawnienia, jakie ma skompromitowane konto.

**Najlepszym sposobem na obejcie** tego ograniczenia jest znalezienie **nowych powiadcze** na skompromitowanym hocie, znalezienie **klucza usugi do wygenerowania tokenu OAuth** bez ogranicze lub skompromitowanie innego VM z mniej ograniczonym kontem usugi.

Sprawd藕 SA z wygenerowanymi kluczami przy u偶yciu:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniki eskalacji uprawnie

Sposobem na eskalacj uprawnie w GCP jest posiadanie wystarczajcych uprawnie, aby w jaki spos贸b uzyska dostp do uprawnie innych kont/usug/grup. Eskalacja jest acuchowa, a偶 do uzyskania dostpu administratora do organizacji.

{% hint style="warning" %}
GCP ma **setki** (jeli nie tysice) **uprawnie**, kt贸re mo偶na przyzna podmiotowi. W tej ksi偶ce znajdziesz **wszystkie uprawnienia, kt贸re znam**, kt贸re mo偶na wykorzysta do **eskalacji uprawnie**, ale jeli **znasz jak cie偶k**, kt贸ra tutaj nie jest wymieniona, **podziel si ni**.
{% endhint %}

**Podstrony tej sekcji s uporzdkowane wedug usug. Na ka偶dej usudze mo偶na znale藕 r贸偶ne sposoby eskalacji uprawnie.**

### Wykorzystywanie GCP do eskalacji uprawnie lokalnie

Jeli jeste wewntrz maszyny w GCP, mo偶esz pr贸bowa wykorzysta uprawnienia do eskalacji uprawnie nawet lokalnie:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Odwoania

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
