# GCP - Escalada de Privilegios

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n a la Escalada de Privilegios en GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, al igual que cualquier otra nube, tiene algunos **principales**: usuarios, grupos y cuentas de servicio, y algunos **recursos** como motor de c√≥mputo, funciones en la nube...\
Luego, a trav√©s de roles, **se otorgan permisos a esos principales sobre los recursos**. Esta es la forma de especificar los permisos que un principal tiene sobre un recurso en GCP.\
Existen ciertos permisos que permitir√°n a un usuario **obtener a√∫n m√°s permisos** sobre el recurso o recursos de terceros, y eso es lo que se llama **escalada de privilegios** (tambi√©n, la explotaci√≥n de vulnerabilidades para obtener m√°s permisos).

Por lo tanto, me gustar√≠a separar las t√©cnicas de escalada de privilegios de GCP en **2 grupos**:

* **Escalada de privilegios a un principal**: Esto te permitir√° **hacerte pasar por otro principal**, y por lo tanto actuar como √©l con todos sus permisos. Ej.: Abusar de _getAccessToken_ para hacerse pasar por una cuenta de servicio.
* **Escalada de privilegios en el recurso**: Esto te permitir√° **obtener m√°s permisos sobre el recurso espec√≠fico**. Ej.: puedes abusar del permiso _setIamPolicy_ sobre cloudfunctions para permitirte activar la funci√≥n.
* Ten en cuenta que algunos **permisos de recursos tambi√©n te permitir√°n adjuntar una cuenta de servicio arbitraria** al recurso. Esto significa que podr√°s lanzar un recurso con una SA, ingresar al recurso y **robar el token de la SA**. Por lo tanto, esto permitir√° escalar a un principal a trav√©s de una escalada de recursos. Esto ha ocurrido en varios recursos anteriormente, pero ahora es menos frecuente (pero a√∫n puede suceder).

Obviamente, las t√©cnicas de escalada de privilegios m√°s interesantes son las del **segundo grupo** porque te permitir√°n **obtener m√°s privilegios fuera de los recursos** sobre los que ya tienes algunos privilegios. Sin embargo, ten en cuenta que **escalar en recursos** tambi√©n puede darte acceso a **informaci√≥n sensible** o incluso a **otros principales** (quiz√°s a trav√©s de la lectura de un secreto que contiene un token de una SA).

{% hint style="warning" %}
Tambi√©n es importante tener en cuenta que en **las cuentas de servicio de GCP son tanto principales como permisos**, por lo que escalar privilegios en una SA te permitir√° tambi√©n hacerse pasar por ella.
{% endhint %}

{% hint style="info" %}
Los permisos entre par√©ntesis indican los permisos necesarios para explotar la vulnerabilidad con `gcloud`. Esos podr√≠an no ser necesarios si se explota a trav√©s de la API.
{% endhint %}

## Permisos para la Metodolog√≠a de Escalada de Privilegios

As√≠ es como **pruebo permisos espec√≠ficos** para realizar acciones espec√≠ficas dentro de GCP.

1. Descarga el repositorio de GitHub [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Agrega en tests/ el nuevo script

## Saltando los alcances de acceso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Los tokens de SA filtrados desde el servicio de metadatos de GCP tienen **alcances de acceso**. Estos son **restricciones** sobre los **permisos** que tiene el token. Por ejemplo, si el token tiene el alcance **`https://www.googleapis.com/auth/cloud-platform`**, tendr√° **acceso completo** a todos los servicios de GCP. Sin embargo, si el token tiene el alcance **`https://www.googleapis.com/auth/cloud-platform.read-only`**, solo tendr√° **acceso de solo lectura** a todos los servicios de GCP, incluso si la SA tiene m√°s permisos en IAM.

No hay una forma directa de saltar estas permisos, pero siempre puedes intentar buscar **nuevas credenciales** en el host comprometido, **encontrar la clave de servicio** para generar un token de OAuth sin restricciones o **saltar a una VM diferente menos restringida**.

Cuando se utilizan [alcances de acceso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), el token de OAuth que se genera para la instancia inform√°tica (VM) **tendr√° una** [**limitaci√≥n de alcance**](https://oauth.net/2/scope/) **incluida**. Sin embargo, es posible que puedas **saltar** esta limitaci√≥n y explotar los permisos que tiene la cuenta comprometida.

La **mejor manera de saltar** esta restricci√≥n es encontrar **nuevas credenciales** en el host comprometido, encontrar la **clave de servicio para generar un token de OAuth** sin restricciones o comprometer una **VM diferente con una SA menos restringida**.

Verifica SA con claves generadas con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## T√©cnicas de Escalada de Privilegios

La forma de escalar tus privilegios en AWS es tener suficientes permisos para poder, de alguna manera, acceder a los privilegios de otras cuentas/usuarios/grupos de servicios. Encadenando escaladas hasta obtener acceso de administrador sobre la organizaci√≥n.

{% hint style="warning" %}
GCP tiene **cientos** (si no miles) de **permisos** que una entidad puede recibir. En este libro puedes encontrar **todos los permisos que conozco** que puedes abusar para **escalar privilegios**, pero si conoces alg√∫n camino no mencionado aqu√≠, **por favor comp√°rtelo**.
{% endhint %}

**Las subp√°ginas de esta secci√≥n est√°n ordenadas por servicios. Puedes encontrar en cada servicio diferentes formas de escalar privilegios en los servicios.**

### Abusando de GCP para escalar privilegios localmente

Si est√°s dentro de una m√°quina en GCP, es posible que puedas abusar de los permisos para escalar privilegios incluso localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
