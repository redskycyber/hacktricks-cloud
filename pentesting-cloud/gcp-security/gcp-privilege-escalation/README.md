# GCP - AyrÄ±calÄ±k YÃ¼kseltme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## GCP AyrÄ±calÄ±k YÃ¼kseltmeye GiriÅŸ <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, diÄŸer herhangi bir bulut gibi, bazÄ± **ilkeleri** iÃ§erir: kullanÄ±cÄ±lar, gruplar ve hizmet hesaplarÄ± ve bazÄ± **kaynaklar** gibi hesaplama motoru, bulut iÅŸlevleri...\
Sonra, roller aracÄ±lÄ±ÄŸÄ±yla, bu **ilkelerin kaynaklar Ã¼zerindeki izinleri verilir**. Bu, GCP'deki bir kaynak Ã¼zerinde bir ilkeye sahip olan izinleri belirtmenin yoludur.\
BazÄ± izinler, bir kullanÄ±cÄ±nÄ±n kaynak veya Ã¼Ã§Ã¼ncÃ¼ taraf kaynaklar Ã¼zerinde **daha fazla izin almasÄ±na** izin verecektir ve bu, **ayrÄ±calÄ±k yÃ¼kseltme** olarak adlandÄ±rÄ±lÄ±r (ayrÄ±ca, daha fazla izin almak iÃ§in zafiyetleri sÃ¶mÃ¼rme).

Bu nedenle, GCP ayrÄ±calÄ±k yÃ¼kseltme tekniklerini **2 gruba** ayÄ±rmak istiyorum:

* **Bir ilkeye ayrÄ±calÄ±k yÃ¼kseltme**: Bu, baÅŸka bir ilkeyi **taklit etmenize** izin verecektir ve bu nedenle tÃ¼m izinleriyle onun gibi davranmanÄ±za olanak saÄŸlar. Ã–rneÄŸin: Bir hizmet hesabÄ±nÄ± taklit etmek iÃ§in _getAccessToken_ kÃ¶tÃ¼ye kullanÄ±mÄ±.
* **Kaynak Ã¼zerinde ayrÄ±calÄ±k yÃ¼kseltme**: Bu, **belirli bir kaynak Ã¼zerinde daha fazla izin almanÄ±za** izin verecektir. Ã–rneÄŸin: bir iÅŸlevi tetiklemenize izin vermek iÃ§in cloudfunctions Ã¼zerinde _setIamPolicy_ iznini kÃ¶tÃ¼ye kullanabilirsiniz.
* BazÄ± **kaynak izinleri ayrÄ±ca bir hizmet hesabÄ±nÄ±** kaynaÄŸa **baÄŸlamanÄ±za** izin verecektir. Bu, bir SA ile bir kaynaÄŸÄ± baÅŸlatabileceÄŸiniz, kaynaÄŸa girebileceÄŸiniz ve **SA belirtecinin Ã§alÄ±nmasÄ±na** izin vereceÄŸiniz anlamÄ±na gelir. Bu nedenle, bir kaynak yÃ¼kseltmesi aracÄ±lÄ±ÄŸÄ±yla bir ilkeye ayrÄ±calÄ±k yÃ¼kseltme yapmanÄ±za izin verecektir. Bu daha Ã¶nce birkaÃ§ kaynakta yaÅŸandÄ±, ancak ÅŸimdi daha az sÄ±klÄ±kta oluyor (ancak hala olabilir).

AÃ§Ä±kÃ§asÄ±, en ilginÃ§ ayrÄ±calÄ±k yÃ¼kseltme teknikleri, **ikinci gruptaki** tekniklerdir Ã§Ã¼nkÃ¼ **zaten bazÄ± ayrÄ±calÄ±klara sahip olduÄŸunuz kaynaklarÄ±n dÄ±ÅŸÄ±nda daha fazla ayrÄ±calÄ±k elde etmenizi** saÄŸlar. Bununla birlikte, **kaynaklarda yÃ¼kseltme** yapmak, aynÄ± zamanda **hassas bilgilere** veya hatta **diÄŸer ilkelere** (belki bir SA belirteci iÃ§eren bir gizliyi okuyarak) eriÅŸim saÄŸlayabilir.

{% hint style="warning" %}
AyrÄ±ca, **GCP Hizmet HesaplarÄ± hem ilke hem de izinlerdir**, bu nedenle bir SA'da ayrÄ±calÄ±klarÄ± yÃ¼kseltmek, onu taklit etmenize de izin verecektir.
{% endhint %}

{% hint style="info" %}
Parantez iÃ§indeki izinler, `gcloud` ile zafiyetin sÃ¶mÃ¼rÃ¼lmesi iÃ§in gereken izinleri gÃ¶sterir. Bunlar, API aracÄ±lÄ±ÄŸÄ±yla sÃ¶mÃ¼rÃ¼lÃ¼yorsa gerekli olmayabilir.
{% endhint %}

## AyrÄ±calÄ±k YÃ¼kseltme Metodolojisi iÃ§in Ä°zinler

Belirli eylemleri gerÃ§ekleÅŸtirmek iÃ§in belirli izinleri **test etmek** iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin.

1. Github deposunu [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) adresinden indirin.
2. tests/ klasÃ¶rÃ¼ne yeni betiÄŸi ekleyin

## EriÅŸim kapsamlarÄ±nÄ± atlatma <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCP meta veri servisinden sÄ±zdÄ±rÄ±lan SA belirteÃ§leri **eriÅŸim kapsamlarÄ±na** sahiptir. Bunlar, belirli belirtecin sahip olduÄŸu **izinler Ã¼zerindeki kÄ±sÄ±tlamalardÄ±r**. Ã–rneÄŸin, belirtecin **`https://www.googleapis.com/auth/cloud-platform`** kapsamÄ± varsa, tÃ¼m GCP hizmetlerine **tam eriÅŸimi** olacaktÄ±r. Bununla birlikte, belirtecin **`https://www.googleapis.com/auth/cloud-platform.read-only`** kapsamÄ± varsa, yalnÄ±zca IAM'de SA'nÄ±n daha fazla izne sahip olsa bile tÃ¼m GCP hizmetlerine **salt okunur eriÅŸimi** olacaktÄ±r.

Bu izinleri atlamak iÃ§in doÄŸrudan bir yol yoktur, ancak her zaman kompromize edilmiÅŸ ana makinede **yeni kimlik bilgileri arayabilir**, kÄ±sÄ±tlama olmadan bir OAuth belirteci oluÅŸturmak iÃ§in **hizmet anahtarÄ±nÄ± bulabilir** veya **daha az kÄ±sÄ±tlÄ± bir SA'ya sahip farklÄ± bir sanal makineye geÃ§ebilirsiniz**.

[**EriÅŸim kapsamlarÄ±**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) kullanÄ±ldÄ±ÄŸÄ±nda, hesaplama Ã¶rneÄŸi (VM) iÃ§in oluÅŸturulan OAuth belirteci, **kapsam sÄ±nÄ±rlamasÄ±nÄ± iÃ§eren** bir [**kapsam**](https://oauth.net/2/scope/) **kÄ±sÄ±tlamasÄ±na sahip olacaktÄ±r**. Bununla birlikte, kompromize edilen hesabÄ±n sahip olduÄŸu izinleri sÃ¶mÃ¼rmek ve bu kÄ±sÄ±tlamayÄ± atlamak mÃ¼mkÃ¼n olabilir.

Bu kÄ±sÄ±tlamayÄ± **atlamak iÃ§in en iyi yol**, ya kompromize edilmiÅŸ ana makinede **yeni kimlik bilgileri bulmak**, kÄ±sÄ±tlama olmadan bir OAuth belirteci oluÅŸturmak iÃ§in **hizmet anahtarÄ±nÄ± bulmak** veya **daha az kÄ±sÄ±tlÄ± bir SA'ya sahip farklÄ± bir sanal makineyi ele geÃ§irmektir**.

AnahtarlarÄ± oluÅŸturulan SA'yÄ± kontrol edin:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Yetki YÃ¼kseltme Teknikleri

AWS'de yetkilerinizi yÃ¼kseltmenin yolu, diÄŸer hizmet hesaplarÄ±/kullanÄ±cÄ±lar/gruplarÄ±nÄ±n yetkilerine bir ÅŸekilde eriÅŸebilecek kadar yeterli izne sahip olmaktÄ±r. Yetkilendirme zincirlemesi yaparak, organizasyon Ã¼zerinde yÃ¶netici eriÅŸimi elde edene kadar yetkileri yÃ¼kseltmek.

{% hint style="warning" %}
GCP'de bir varlÄ±k **binlerce** (belki de binlerce) **izin** alabilir. Bu kitapta, **yetkileri yÃ¼kseltmek** iÃ§in **kullanabileceÄŸiniz tÃ¼m izinleri** bulabilirsiniz, ancak burada bahsedilmeyen **baÅŸka bir yol biliyorsanÄ±z**, **lÃ¼tfen paylaÅŸÄ±n**.
{% endhint %}

**Bu bÃ¶lÃ¼mÃ¼n alt sayfalarÄ± hizmetlere gÃ¶re sÄ±ralanmÄ±ÅŸtÄ±r. Her hizmette yetkileri yÃ¼kseltmenin farklÄ± yollarÄ±nÄ± bulabilirsiniz.**

### Yetkileri yerel olarak yÃ¼kseltmek iÃ§in GCP'yi kÃ¶tÃ¼ye kullanma

GCP'deki bir makinedeyseniz, yerel olarak bile yetkileri yÃ¼kseltmek iÃ§in izinleri kÃ¶tÃ¼ye kullanabilirsiniz:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **tanÄ±tmak isterseniz** veya HackTricks'i **PDF olarak indirmek isterseniz**, [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
