# GCP - ç½‘ç»œ Docker é€ƒé€¸

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åˆå§‹çŠ¶æ€

åœ¨æŒ‡å®šè¿™é¡¹æŠ€æœ¯çš„ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæ”»å‡»è€…éƒ½æˆåŠŸè·å¾—äº† GCP ç®¡ç†çš„ **Docker** å®¹å™¨å†…çš„ **root** è®¿é—®æƒé™ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®å®¿ä¸»ç½‘ç»œï¼ˆå¹¶å…·æœ‰ **`CAP_NET_ADMIN`** å’Œ **`CAP_NET_RAW`** æƒé™ï¼‰ã€‚

## æ”»å‡»

å½“æ‚¨åœ¨å¸¸è§„çš„ Google Compute Engine å®ä¾‹ä¸Šæ£€æŸ¥ç½‘ç»œæµé‡æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°å¾ˆå¤š**æ˜æ–‡ HTTP è¯·æ±‚**è¢«å®šå‘åˆ° **`169.254.169.254`** ä¸Šçš„ **metadata** å®ä¾‹ã€‚ä¸€ä¸ªå‘å‡ºæ­¤ç±»è¯·æ±‚çš„æœåŠ¡æ˜¯å¼€æºçš„ [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)ã€‚è¯·æ±‚ç¤ºä¾‹ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

è¯¥ä»£ç†**ç›‘æ§ metadata çš„å˜åŒ–**ã€‚åœ¨ **metadata** ä¸­æœ‰ä¸€ä¸ªåŒ…å«æˆæƒçš„ **SSH å…¬é’¥**çš„**å­—æ®µ**ã€‚\
å› æ­¤ï¼Œå½“ metadata ä¸­å‡ºç°æ–°çš„å…¬å…± SSH å¯†é’¥æ—¶ï¼Œä»£ç†å°†åœ¨ç”¨æˆ·çš„ `.authorized_key` æ–‡ä»¶ä¸­**æˆæƒ**å®ƒï¼Œå¹¶åœ¨å¿…è¦æ—¶**åˆ›å»º**ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° **sudoers** ä¸­ã€‚

Google Guest Agent ç›‘æ§å˜åŒ–çš„æ–¹å¼æ˜¯é€šè¿‡è°ƒç”¨**é€’å½’æ£€ç´¢æ‰€æœ‰ metadata å€¼**ï¼ˆ`GET /computeMetadata/v1/?recursive=true`ï¼‰ï¼ŒæŒ‡ç¤º metadata æœåŠ¡å™¨**ä»…åœ¨æœ‰ä»»ä½•å˜åŒ–**æ—¶å‘é€å“åº”ï¼Œä¸ä¸Šæ¬¡æ£€ç´¢çš„ metadata å€¼ç›¸æ¯”ï¼Œç”±å…¶ Etag æ ‡è¯†ï¼ˆ`wait_for_change=true&last_etag=`ï¼‰ã€‚

æ­¤è¯·æ±‚è¿˜åŒ…æ‹¬ä¸€ä¸ª**è¶…æ—¶**ï¼ˆ`timeout_sec=`ï¼‰ï¼Œå› æ­¤å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´å†…**æ²¡æœ‰å‘ç”Ÿå˜åŒ–**ï¼Œmetadata æœåŠ¡å™¨ä¼šå“åº”**æœªæ›´æ”¹çš„å€¼**ã€‚

è¿™ä½¿å¾— **IMDS** åœ¨æ²¡æœ‰é…ç½®æ›´æ”¹çš„ 60 ç§’å**å“åº”**ï¼Œä¸ºå‘æ¥å®¾ä»£ç†æ³¨å…¥å‡é…ç½®å“åº”æä¾›äº†**çª—å£**ã€‚

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…è®¾æ³•æ‰§è¡Œ **MitM** æ”»å‡»ï¼Œä»–å¯ä»¥**ä¼ªé€ **æ¥è‡ª **IMDS** æœåŠ¡å™¨çš„**å“åº”**ï¼Œ**æ’å…¥æ–°çš„å…¬é’¥**ï¼Œä»¥å…è®¸æ–°ç”¨æˆ·é€šè¿‡ **SSH** è®¿é—®å®¿ä¸»ã€‚

### é€ƒé€¸

ARP æ¬ºéª—åœ¨ Google Compute Engine ç½‘ç»œä¸Šä¸èµ·ä½œç”¨ï¼Œä½†æ˜¯ [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) ç”Ÿæˆäº†è¿™ä¸ª**ä¿®æ”¹ç‰ˆçš„** [**rshijack**](https://github.com/ezequielpereira/rshijack) ****ï¼Œå¯ä»¥ç”¨æ¥åœ¨é€šä¿¡ä¸­æ³¨å…¥æ•°æ®åŒ…ä»¥æ³¨å…¥ SSH ç”¨æˆ·ã€‚

è¿™ä¸ªä¿®æ”¹ç‰ˆçš„ rshijack å…è®¸**é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ ACK å’Œ SEQ å·ç **ï¼ŒèŠ‚çœæ—¶é—´å¹¶å…è®¸æˆ‘ä»¬åœ¨çœŸæ­£çš„ Metadata å“åº”åˆ°æ¥ä¹‹å‰**ä¼ªé€ å“åº”**ã€‚\
\
æ­¤å¤–ï¼Œ**è¿™ä¸ª** [**å°å‹ Shell è„šæœ¬**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** å¯ä»¥è¿”å›ä¸€ä¸ª**ç‰¹åˆ«åˆ¶ä½œçš„æœ‰æ•ˆè½½è·**ï¼Œè§¦å‘ Google Guest Agent **åˆ›å»ºç”¨æˆ· `wouter`**ï¼Œå¹¶åœ¨å…¶ `.authorized_keys` æ–‡ä»¶ä¸­æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„å…¬é’¥ã€‚\
\
è¿™ä¸ªè„šæœ¬æ¥æ”¶ ETag ä½œä¸ºå‚æ•°ï¼Œå› ä¸ºä¿æŒç›¸åŒçš„ ETagï¼ŒMetadata æœåŠ¡å™¨ä¸ä¼šç«‹å³å‘Šè¯‰ Google Guest Agent ä¸‹ä¸€ä¸ªå“åº”ä¸­çš„ metadata å€¼æœ‰æ‰€ä¸åŒï¼Œè€Œæ˜¯ç­‰å¾… timeout\_sec ä¸­æŒ‡å®šçš„ç§’æ•°ã€‚\
\
è¦å®ç°æ¬ºéª—ï¼Œæ‚¨åº”è¯¥**è§‚å¯Ÿå¯¹ Metadata** æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œä½¿ç”¨ **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** ç­‰å¾…çœ‹åˆ°åƒè¿™æ ·çš„è¡Œï¼š

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

å½“æ‚¨çœ‹åˆ°è¯¥å€¼æ—¶ï¼Œä½¿ç”¨æ­£ç¡®çš„ETAGå‘**`rshijack`**å‘é€**å‡å…ƒæ•°æ®**ï¼š

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

è¿™åº”è¯¥ä¼šè®©ä»£ç†**æˆæƒé‚£ä¸ªå…¬é’¥**ï¼Œå…è®¸æ‚¨é€šè¿‡**SSH**ä½¿ç”¨**ç§é’¥**è¿›è¡Œ**è¿æ¥**ã€‚

## å‚è€ƒèµ„æ–™

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricks**ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
