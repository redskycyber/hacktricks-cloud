# GCP - Bekstvo iz Docker mre쬰

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Po캜etno stanje

U oba opisa gde je navedena ova tehnika, napada캜i su uspeli da dobiju **root** pristup unutar **Docker** kontejnera koji je upravljao GCP-om sa pristupom host mre쬴 (i mogu캖nostima **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## Obja코njenje napada

Na Google Compute Engine instanci, redovna inspekcija mre쬹og saobra캖aja otkriva brojne **obi캜ne HTTP zahteve** ka **metadata instanci** na adresi `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), open-source servis, 캜esto 코alje takve zahteve.

Ovaj agent je dizajniran da **prati promene u metapodacima**. Posebno, metapodaci uklju캜uju **polje za SSH javne klju캜eve**. Kada se novi javni SSH klju캜 doda u metapodatke, agent automatski ga **autorizuje** u fajlu `.authorized_key`. Tako캠e, mo쬰 **kreirati novog korisnika** i dodati ga u **sudoers** ako je potrebno.

Agent prati promene slanjem zahteva za **dobijanje svih vrednosti metapodataka rekurzivno** (`GET /computeMetadata/v1/?recursive=true`). Ovaj zahtev je dizajniran da podstakne metadata server da po코alje odgovor samo ako postoji promena u metapodacima od poslednjeg dobijanja, identifikovana preko Etag-a (`wait_for_change=true&last_etag=`). Dodatno, uklju캜en je i parametar **timeout** (`timeout_sec=`). Ako ne do캠e do promene u odre캠enom vremenskom roku, server odgovara sa **nepromenjenim vrednostima**.

Ovaj proces omogu캖ava **IMDS-u** (Instance Metadata Service) da odgovori nakon **60 sekundi** ako nije do코lo do promene konfiguracije, stvaraju캖i potencijalni **prozor za ubacivanje la쬹og odgovora konfiguracije** u guest agentu.

Napada캜 bi mogao iskoristiti ovo izvr코avanjem **Man-in-the-Middle (MitM) napada**, la쬴raju캖i odgovor od IMDS servera i **ubacivanjem novog javnog klju캜a**. Ovo bi omogu캖ilo neovla코캖en pristup hostu putem SSH-a.

### Tehnika bekstva

Iako ARP spoofing nije efikasan na Google Compute Engine mre쬬ma, [**modifikovana verzija rshijack**](https://github.com/ezequielpereira/rshijack) razvijena od strane [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) mo쬰 se koristiti za ubacivanje paketa u komunikaciju i ubacivanje SSH korisnika.

Ova verzija rshijack-a omogu캖ava uno코enje ACK i SEQ brojeva kao argumente komandne linije, olak코avaju캖i la쬴ranje odgovora pre pravog odgovora servera metapodataka. Dodatno, koristi se [**mali Shell skript**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) za vra캖anje **specijalno kreiranog payload-a**. Ovaj payload pokre캖e Google Guest Agent da **kreira korisnika `wouter`** sa odre캠enim javnim klju캜em u fajlu `.authorized_keys`.

Skripta koristi isti ETag kako bi spre캜ila Metadata server da odmah obavesti Google Guest Agent o razli캜itim vrednostima metapodataka, 캜ime se odla쬰 odgovor.

Da bi se izvr코ilo la쬴ranje, potrebno je izvr코iti slede캖e korake:

1. **Pratite zahteve ka Metadata serveru** koriste캖i **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Potra쬴te liniju sli캜nu:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Po코aljite la쬹e metapodatke sa ispravnim ETAG-om rshijack-u:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ova korak autorizuje javni klju캜, omogu캖avaju캖i SSH konekciju sa odgovaraju캖im privatnim klju캜em.


## Reference

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
