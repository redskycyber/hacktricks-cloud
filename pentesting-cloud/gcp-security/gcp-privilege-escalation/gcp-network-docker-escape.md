# GCP - ç½‘ç»œDockeré€ƒé€¸

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åˆå§‹çŠ¶æ€

åœ¨æŒ‡å®šäº†æ­¤æŠ€æœ¯çš„ä¸¤ä¸ªwriteupä¸­ï¼Œæ”»å‡»è€…æˆåŠŸåœ¨ç”±GCPç®¡ç†çš„Dockerå®¹å™¨å†…è·å¾—äº†**root**è®¿é—®æƒé™ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®ä¸»æœºç½‘ç»œï¼ˆä»¥åŠå…·æœ‰**`CAP_NET_ADMIN`**å’Œ**`CAP_NET_RAW`**çš„æƒé™ï¼‰ã€‚

## æ”»å‡»

å½“æ‚¨æ£€æŸ¥å¸¸è§„Google Compute Engineå®ä¾‹ä¸Šçš„ç½‘ç»œæµé‡æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°å¤§é‡çš„**æ˜æ–‡HTTPè¯·æ±‚**è¢«å®šå‘åˆ°**`169.254.169.254`**ä¸Šçš„**metadata**å®ä¾‹ã€‚ä¸€ä¸ªè¿›è¡Œæ­¤ç±»è¯·æ±‚çš„æœåŠ¡æ˜¯å¼€æºçš„[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)ã€‚è¯·æ±‚ç¤ºä¾‹ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

è¯¥ä»£ç†ç¨‹åº**ç›‘è§†å…ƒæ•°æ®çš„æ›´æ”¹**ã€‚åœ¨**metadata**ä¸­ï¼Œæœ‰ä¸€ä¸ªå¸¦æœ‰æˆæƒçš„**SSHå…¬é’¥**å­—æ®µã€‚\
å› æ­¤ï¼Œå½“å…ƒæ•°æ®ä¸­å‡ºç°æ–°çš„å…¬å…±SSHå¯†é’¥æ—¶ï¼Œä»£ç†ç¨‹åºå°†åœ¨ç”¨æˆ·çš„`.authorized_key`æ–‡ä»¶ä¸­**æˆæƒ**å®ƒï¼Œå¹¶åœ¨éœ€è¦æ—¶**åˆ›å»º**ä¸€ä¸ªæ–°ç”¨æˆ·å¹¶å°†å…¶æ·»åŠ åˆ°**sudoers**ã€‚

Google Guest Agentç›‘è§†æ›´æ”¹çš„æ–¹å¼æ˜¯é€šè¿‡è°ƒç”¨**é€’å½’æ£€ç´¢æ‰€æœ‰å…ƒæ•°æ®å€¼**ï¼ˆ`GET /computeMetadata/v1/?recursive=true`ï¼‰ï¼Œå‘ŠçŸ¥å…ƒæ•°æ®æœåŠ¡å™¨**ä»…åœ¨ä¸ä¸Šæ¬¡æ£€ç´¢çš„å…ƒæ•°æ®å€¼æœ‰ä»»ä½•æ›´æ”¹æ—¶**å‘é€å“åº”ï¼Œé€šè¿‡å…¶Etagè¿›è¡Œæ ‡è¯†ï¼ˆ`wait_for_change=true&last_etag=`ï¼‰ã€‚

æ­¤è¯·æ±‚è¿˜åŒ…æ‹¬ä¸€ä¸ª**è¶…æ—¶**ï¼ˆ`timeout_sec=`ï¼‰ï¼Œå› æ­¤å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´å†…**æ²¡æœ‰æ›´æ”¹**å‘ç”Ÿï¼Œå…ƒæ•°æ®æœåŠ¡å™¨å°†ä»¥**æœªæ›´æ”¹çš„å€¼**å“åº”ã€‚

è¿™ä½¿å¾—**IMDS**åœ¨è¯¥é—´éš”å†…æ²¡æœ‰é…ç½®æ›´æ”¹æ—¶**60ç§’å**å“åº”ï¼Œä»IMDSå‘å®¢æˆ·ä»£ç†æ³¨å…¥ä¸€ä¸ªä¼ªé€ çš„é…ç½®å“åº”çš„**çª—å£**ã€‚

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…æˆåŠŸæ‰§è¡Œ**MitM**æ”»å‡»ï¼Œä»–å¯ä»¥**ä¼ªé€ **æ¥è‡ª**IMDS**æœåŠ¡å™¨çš„**å“åº”**ï¼Œæ’å…¥ä¸€ä¸ªæ–°çš„å…¬é’¥ï¼Œä»¥å…è®¸æ–°ç”¨æˆ·é€šè¿‡**SSH**è®¿é—®ä¸»æœºã€‚

### é€ƒé€¸

ARPæ¬ºéª—åœ¨Google Compute Engineç½‘ç»œä¸Šä¸èµ·ä½œç”¨ï¼Œä½†æ˜¯ï¼Œ[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)ç”Ÿæˆäº†è¿™ä¸ª**ä¿®æ”¹ç‰ˆæœ¬çš„**[**rshijack**](https://github.com/ezequielpereira/rshijack) ****ï¼Œå¯ä»¥ç”¨äºåœ¨é€šä¿¡ä¸­æ³¨å…¥æ•°æ®åŒ…ä»¥æ³¨å…¥SSHç”¨æˆ·ã€‚

è¿™ä¸ªä¿®æ”¹ç‰ˆæœ¬çš„rshijackå…è®¸å°†ACKå’ŒSEQå·ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ï¼ŒèŠ‚çœæ—¶é—´å¹¶å…è®¸æˆ‘ä»¬åœ¨çœŸæ­£çš„Metadataå“åº”åˆ°æ¥ä¹‹å‰**ä¼ªé€ ä¸€ä¸ªå“åº”**ã€‚\
\
æ­¤å¤–ï¼Œ**è¿™ä¸ª**[**å°å‹Shellè„šæœ¬**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) ****å°†è¿”å›ä¸€ä¸ª**ç‰¹åˆ¶çš„æœ‰æ•ˆè´Ÿè½½**ï¼Œè¯¥æœ‰æ•ˆè´Ÿè½½å°†è§¦å‘Google Guest Agentåœ¨å…¶`.authorized_keys`æ–‡ä»¶ä¸­**åˆ›å»ºç”¨æˆ·`wouter`**ï¼Œå¹¶åŒ…å«æˆ‘ä»¬è‡ªå·±çš„å…¬é’¥ã€‚\
\
è¯¥è„šæœ¬æ¥æ”¶ETagä½œä¸ºå‚æ•°ï¼Œå› ä¸ºé€šè¿‡ä¿æŒç›¸åŒçš„ETagï¼Œå…ƒæ•°æ®æœåŠ¡å™¨ä¸ä¼šç«‹å³å‘Šè¯‰Google Guest Agentä¸‹ä¸€ä¸ªå“åº”ä¸­çš„å…ƒæ•°æ®å€¼ä¸ä¸Šæ¬¡ä¸åŒï¼Œè€Œæ˜¯ç­‰å¾…timeout\_secæŒ‡å®šçš„ç§’æ•°ã€‚\
\
è¦å®ç°ä¼ªé€ ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨**tcpdumpç›‘è§†å¯¹MetadataæœåŠ¡å™¨çš„è¯·æ±‚**ï¼š`tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`ï¼Œç­‰å¾…å‡ºç°ç±»ä¼¼ä»¥ä¸‹è¡Œçš„å†…å®¹ï¼š

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

å½“ä½ çœ‹åˆ°è¯¥å€¼æ—¶ï¼Œä½¿ç”¨æ­£ç¡®çš„ETAGå‘`rshijack`å‘é€**ä¼ªé€ çš„å…ƒæ•°æ®æ•°æ®**ï¼š

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

è¿™å°†ä½¿ä»£ç†**æˆæƒè¯¥å…¬é’¥**ï¼Œä»è€Œå…è®¸æ‚¨ä½¿ç”¨**ç§é’¥**é€šè¿‡**SSH**è¿›è¡Œ**è¿æ¥**ã€‚

## å‚è€ƒèµ„æ–™

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
