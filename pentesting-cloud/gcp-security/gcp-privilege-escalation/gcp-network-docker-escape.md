# GCP - AÄŸ Docker KaÃ§Ä±ÅŸÄ±

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimizden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## BaÅŸlangÄ±Ã§ Durumu

Bu teknik belirtildiÄŸi iki yazÄ±da da saldÄ±rganlar, GCP tarafÄ±ndan yÃ¶netilen bir **Docker** konteynerinde **kÃ¶k** eriÅŸimi elde etmeyi baÅŸardÄ±lar ve ana aÄŸa eriÅŸime sahiptiler (**`CAP_NET_ADMIN`** ve **`CAP_NET_RAW`** yetenekleri ile).

## SaldÄ±rÄ± AÃ§Ä±klamasÄ±

Google Compute Engine Ã¶rneÄŸinde, aÄŸ trafiÄŸinin dÃ¼zenli olarak incelenmesi, `169.254.169.254` adresindeki **metadata Ã¶rneÄŸine** birÃ§ok **dÃ¼z HTTP isteÄŸi** olduÄŸunu ortaya Ã§Ä±kardÄ±. SÄ±k sÄ±k bu tÃ¼r isteklerde bulunan aÃ§Ä±k kaynaklÄ± bir hizmet olan [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), bu istekleri yapar.

Bu ajan, **metadata'da yapÄ±lan deÄŸiÅŸiklikleri izlemek** iÃ§in tasarlanmÄ±ÅŸtÄ±r. Ã–zellikle, metadata, bir **SSH genel anahtarlarÄ± alanÄ±** iÃ§erir. Yeni bir genel SSH anahtarÄ± metadata'ya eklenirse, ajan otomatik olarak bunu `.authorized_key` dosyasÄ±nda **yetkilendirir**. Gerekirse ayrÄ±ca **yeni bir kullanÄ±cÄ± oluÅŸturur** ve onlarÄ± **sudoers** a ekler.

Ajan, tÃ¼m metadata deÄŸerlerini **rekÃ¼rsif olarak almak iÃ§in bir istek gÃ¶ndererek** (`GET /computeMetadata/v1/?recursive=true`) deÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± kontrol eder. Bu istek, metadata sunucusunun, son alÄ±mdan bu yana metadata'da herhangi bir deÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± belirleyen bir Etag ile yanÄ±t gÃ¶ndermesini saÄŸlamak iÃ§in tasarlanmÄ±ÅŸtÄ±r (`wait_for_change=true&last_etag=`). Ek olarak, bir **zaman aÅŸÄ±mÄ±** parametresi (`timeout_sec=`) eklenir. Belirtilen zaman aÅŸÄ±mÄ± sÃ¼resi iÃ§inde herhangi bir deÄŸiÅŸiklik olmazsa, sunucu **deÄŸiÅŸmeyen deÄŸerlerle** yanÄ±t verir.

Bu sÃ¼reÃ§, **IMDS** (Ã–rnek Metadata Hizmeti)'nin, yapÄ±landÄ±rma deÄŸiÅŸikliÄŸi olmadÄ±ÄŸÄ±nda **60 saniye** sonra yanÄ±t vermesine olanak tanÄ±r ve bu da sahte bir yapÄ±landÄ±rma yanÄ±tÄ±nÄ±n **enjekte edilmesi iÃ§in bir pencere** oluÅŸturur.

Bir saldÄ±rgan, IMDS sunucusundan gelen yanÄ±tÄ± **Man-in-the-Middle (MitM) saldÄ±rÄ±sÄ±** yaparak ve IMDS sunucusundan gelen yanÄ±tÄ± taklit ederek ve yeni bir genel anahtar **ekleyerek** bunu sÃ¶mÃ¼rebilir. Bu, ana bilgisayara yetkisiz SSH eriÅŸimi saÄŸlayabilir.

### KaÃ§Ä±ÅŸ TekniÄŸi

ARP spoofing, Google Compute Engine aÄŸlarÄ±nda etkisizdir, ancak [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) tarafÄ±ndan geliÅŸtirilen [**rshijack'Ä±n modifiye edilmiÅŸ bir sÃ¼rÃ¼mÃ¼**](https://github.com/ezequielpereira/rshijack), paket enjeksiyonu iÃ§in kullanÄ±labilir.

Bu rshijack sÃ¼rÃ¼mÃ¼, ACK ve SEQ numaralarÄ±nÄ± komut satÄ±rÄ± argÃ¼manlarÄ± olarak girmeyi saÄŸlar, bÃ¶ylece gerÃ§ek Metadata sunucusu yanÄ±tÄ±ndan Ã¶nce bir yanÄ±tÄ±n taklit edilmesi kolaylaÅŸÄ±r. AyrÄ±ca, Ã¶zel olarak oluÅŸturulmuÅŸ bir yÃ¼kÃ¼ dÃ¶ndÃ¼ren [**kÃ¼Ã§Ã¼k bir Shell betiÄŸi**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) kullanÄ±lÄ±r. Bu yÃ¼k, Google Guest Agent'Ä±n `.authorized_keys` dosyasÄ±nda belirtilen bir genel anahtarla **`wouter` adÄ±nda bir kullanÄ±cÄ± oluÅŸturmasÄ±nÄ±** tetikler.

Betik, Metadata sunucusunun hemen farklÄ± metadata deÄŸerlerini Google Guest Agent'a bildirmesini engellemek iÃ§in aynÄ± ETag'i kullanÄ±r ve bÃ¶ylece yanÄ±tÄ± geciktirir.

Sahte yanÄ±tÄ±n yÃ¼rÃ¼tÃ¼lmesi iÃ§in aÅŸaÄŸÄ±daki adÄ±mlar gereklidir:

1. **Metadata sunucusuna yapÄ±lan istekleri** **tcpdump** kullanarak izleyin:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
`To escape the Docker container and gain access to the underlying host, you can exploit misconfigurations in the GCP network settings.`

Turkish Translation:

`Docker konteynerinden kaÃ§arak altta yatan ana bilgisayara eriÅŸim saÄŸlamak iÃ§in, GCP aÄŸ ayarlarÄ±nda yapÄ±landÄ±rma hatalarÄ±nÄ± sÃ¶mÃ¼rebilirsiniz.`
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Rshijack'e doÄŸru ETAG ile sahte meta verileri gÃ¶nderin:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Bu adÄ±m, ilgili Ã¶zel anahtarla SSH baÄŸlantÄ±sÄ±nÄ± etkinleÅŸtirmek iÃ§in genel anahtarÄ± yetkilendirir.


## Referanslar

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana dÃ¶nÃ¼ÅŸÃ¼n</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
