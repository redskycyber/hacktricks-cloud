# GCP - Ucieczka z kontenera Docker w sieci

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Stan poczÄ…tkowy

W obu opisach, gdzie ta technika jest okreÅ›lona, atakujÄ…cy zdoÅ‚ali uzyskaÄ‡ dostÄ™p **root** wewnÄ…trz kontenera **Docker** zarzÄ…dzanego przez GCP z dostÄ™pem do sieci hosta (oraz uprawnieniami **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## WyjaÅ›nienie ataku

Na instancji Google Compute Engine regularne sprawdzanie ruchu sieciowego ujawnia liczne **zwykÅ‚e Å¼Ä…dania HTTP** do **instancji metadanych** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), otwarte ÅºrÃ³dÅ‚o usÅ‚ugi, czÄ™sto wykonuje takie Å¼Ä…dania.

Ten agent jest zaprojektowany do **monitorowania zmian w metadanych**. Warto zauwaÅ¼yÄ‡, Å¼e metadane obejmujÄ… **pole dla kluczy publicznych SSH**. Gdy do metadanych dodawany jest nowy klucz publiczny SSH, agent automatycznie **autoryzuje** go w pliku `.authorized_key`. MoÅ¼e rÃ³wnieÅ¼ **utworzyÄ‡ nowego uÅ¼ytkownika** i dodaÄ‡ go do **sudoers**, jeÅ›li jest to konieczne.

Agent monitoruje zmiany, wysyÅ‚ajÄ…c Å¼Ä…danie **pobrania wszystkich wartoÅ›ci metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To Å¼Ä…danie ma na celu spowodowanie, Å¼e serwer metadanych wyÅ›le odpowiedÅº tylko wtedy, gdy wystÄ…piÅ‚a zmiana w metadanych od ostatniego pobrania, zidentyfikowana za pomocÄ… Etag (`wait_for_change=true&last_etag=`). Dodatkowo, doÅ‚Ä…czany jest parametr **timeout** (`timeout_sec=`). JeÅ›li w okreÅ›lonym czasie nie wystÄ…pi Å¼adna zmiana, serwer odpowiada **niezmienionymi wartoÅ›ciami**.

Ten proces pozwala na odpowiedÅº **IMDS** (Instance Metadata Service) po **60 sekundach**, jeÅ›li nie wystÄ…piÅ‚a Å¼adna zmiana konfiguracji, tworzÄ…c potencjalne **okno do wstrzykniÄ™cia faÅ‚szywej odpowiedzi konfiguracyjnej** do agenta goÅ›cia.

AtakujÄ…cy mÃ³gÅ‚by wykorzystaÄ‡ to, wykonujÄ…c atak **Man-in-the-Middle (MitM)**, podszywajÄ…c siÄ™ pod odpowiedÅº serwera IMDS i **wstawiajÄ…c nowy klucz publiczny**. MoÅ¼e to umoÅ¼liwiÄ‡ nieautoryzowany dostÄ™p SSH do hosta.

### Technika ucieczki

Podczas gdy ARP spoofing jest nieskuteczny w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) moÅ¼e byÄ‡ uÅ¼yta do wstrzykiwania pakietÃ³w w komunikacjÄ™ w celu wstrzykniÄ™cia uÅ¼ytkownika SSH.

Ta wersja rshijack umoÅ¼liwia wprowadzenie numerÃ³w ACK i SEQ jako argumentÃ³w wiersza poleceÅ„, uÅ‚atwiajÄ…c podszywanie siÄ™ pod odpowiedÅº przed rzeczywistÄ… odpowiedziÄ… serwera metadanych. Dodatkowo, uÅ¼ywany jest [**maÅ‚y skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh), ktÃ³ry zwraca **specjalnie spreparowany payload**. Ten payload powoduje, Å¼e Google Guest Agent **tworzy uÅ¼ytkownika `wouter`** z okreÅ›lonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt uÅ¼ywa tego samego ETag, aby uniemoÅ¼liwiÄ‡ serwerowi metadanych natychmiastowe powiadomienie Google Guest Agent o innych wartoÅ›ciach metadanych, opÃ³ÅºniajÄ…c tym samym odpowiedÅº.

Aby przeprowadziÄ‡ podszywanie, konieczne sÄ… nastÄ™pujÄ…ce kroki:

1. **Monitoruj Å¼Ä…dania do serwera metadanych** za pomocÄ… **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
ZnajdÅº liniÄ™ podobnÄ… do:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. WyÅ›lij faÅ‚szywe dane metadanych z poprawnym ETAG do rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ten krok autoryzuje klucz publiczny, umoÅ¼liwiajÄ…c poÅ‚Ä…czenie SSH z odpowiadajÄ…cym mu kluczem prywatnym.


## Referencje

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
