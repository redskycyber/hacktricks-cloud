# GCP - Eskalacja uprawnie kontenera

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## kontener

### `container.clusters.get`

To uprawnienie pozwala na **zebranie powiadcze dla klastra Kubernetes** za pomoc czego takiego jak:
```bash
gcloud container clusters get-credentials <cluster_name> --zone <zone>
```
Bez dodatkowych uprawnie, powiadczenia s do podstawowe, poniewa偶 mo偶na tylko **wywietli pewne zasoby**, ale s one przydatne do znalezienia bd贸w konfiguracji w rodowisku.

{% hint style="info" %}
Zauwa偶, 偶e **klastry Kubernetes mog by skonfigurowane jako prywatne**, co uniemo偶liwia dostp do serwera Kube-API z Internetu.
{% endhint %}

Jeli nie masz tych uprawnie, nadal mo偶esz uzyska dostp do klastra, ale musisz **utworzy wasny plik konfiguracyjny kubectl** z informacjami o klastrach. Nowo wygenerowany plik wyglda tak:
```yaml
apiVersion: v1
clusters:
- cluster:
certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVMRENDQXBTZ0F3SUJBZ0lRRzNaQmJTSVlzeVRPR1FYODRyNDF3REFOQmdrcWhraUc5dzBCQVFzRkFEQXYKTVMwd0t3WURWUVFERXlRMk9UQXhZVEZoWlMweE56ZGxMVFF5TkdZdE9HVmhOaTAzWVdFM01qVmhNR05tTkdFdwpJQmNOTWpJeE1qQTBNakl4T1RJMFdoZ1BNakExTWpFeE1qWXlNekU1TWpSYU1DOHhMVEFyQmdOVkJBTVRKRFk1Ck1ERmhNV0ZsTFRFM04yVXROREkwWmkwNFpXRTJMVGRoWVRjeU5XRXdZMlkwWVRDQ0FhSXdEUVlKS29aSWh2Y04KQVFFQkJRQURnZ0dQQURDQ0FZb0NnZ0dCQU00TWhGemJ3Y3VEQXhiNGt5WndrNEdGNXRHaTZmb0pydExUWkI4Rgo5TDM4a2V2SUVWTHpqVmtoSklpNllnSHg4SytBUHl4RHJQaEhXMk5PczFNMmpyUXJLSHV6M0dXUEtRUmtUWElRClBoMy9MMDVtbURwRGxQK3hKdzI2SFFqdkE2Zy84MFNLakZjRXdKRVhZbkNMMy8yaFBFMzdxN3hZbktwTWdKVWYKVnoxOVhwNEhvbURvOEhUN2JXUTJKWTVESVZPTWNpbDhkdDZQd3FUYmlLNjJoQzNRTHozNzNIbFZxaiszNy90RgpmMmVwUUdFOG90a0VVOFlHQ3FsRTdzaVllWEFqbUQ4bFZENVc5dk1RNXJ0TW8vRHBTVGNxRVZUSzJQWk1rc0hyCmMwbGVPTS9LeXhnaS93TlBRdW5oQ2hnRUJIZTVzRmNxdmRLQ1pmUFovZVI1Qk0vc0w1WFNmTE9sWWJLa2xFL1YKNFBLNHRMVmpiYVg1VU9zMUZIVXMrL3IyL1BKQ2hJTkRaVTV2VjU0L1c5NWk4RnJZaUpEYUVGN0pveXJvUGNuMwpmTmNjQ2x1eGpOY1NsZ01ISGZKRzZqb0FXLzB0b2U3ek05RHlQOFh3NW44Zm5lQm5aVTFnYXNKREZIYVlZbXpGCitoQzFETmVaWXNibWNxOGVPVG9LOFBKRjZ3SURBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWdRd0R3WUQKVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVU5UkhvQXlxY3RWSDVIcmhQZ1BjYzF6Sm9kWFV3RFFZSgpLb1pJaHZjTkFRRUxCUUFEZ2dHQkFLbnp3VEx0QlJBVE1KRVB4TlBNbmU2UUNqZDJZTDgxcC9oeVc1eWpYb2w5CllkMTRRNFVlVUJJVXI0QmJadzl0LzRBQ3ZlYUttVENaRCswZ2wyNXVzNzB3VlFvZCtleVhEK2I1RFBwUUR3Z1gKbkJLcFFCY1NEMkpvZ29tT3M3U1lPdWVQUHNrODVvdWEwREpXLytQRkY1WU5ublc3Z1VLT2hNZEtKcnhuYUVGZAprVVl1TVdPT0d4U29qVndmNUsyOVNCbGJ5YXhDNS9tOWkxSUtXV2piWnZPN0s4TTlYLytkcDVSMVJobDZOSVNqCi91SmQ3TDF2R0crSjNlSjZneGs4U2g2L28yRnhxZWFNdDladWw4MFk4STBZaGxXVmlnSFMwZmVBUU1NSzUrNzkKNmozOWtTZHFBYlhPaUVOMzduOWp2dVlNN1ZvQzlNUk1oYUNyQVNhR2ZqWEhtQThCdlIyQW5iQThTVGpQKzlSMQp6VWRpK3dsZ0V4bnFvVFpBcUVHRktuUTlQcjZDaDYvR0xWWStqYXhuR3lyUHFPYlpNZTVXUDFOUGs4NkxHSlhCCjc1elFvanEyRUpxanBNSjgxT0gzSkxOeXRTdmt4UDFwYklxTzV4QUV0OWxRMjh4N28vbnRuaWh1WmR6M0lCRU8KODdjMDdPRGxYNUJQd0hIdzZtKzZjUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
server: https://34.123.141.28
name: gke_security-devbox_us-central1_autopilot-cluster-1
contexts:
- context:
cluster: gke_security-devbox_us-central1_autopilot-cluster-1
user: gke_security-devbox_us-central1_autopilot-cluster-1
name: gke_security-devbox_us-central1_autopilot-cluster-1
current-context: gke_security-devbox_us-central1_autopilot-cluster-1
kind: Config
preferences: {}
users:
- name: gke_security-devbox_us-central1_autopilot-cluster-1
user:
auth-provider:
config:
access-token: <access token>
cmd-args: config config-helper --format=json
cmd-path: gcloud
expiry: "2022-12-06T01:13:11Z"
expiry-key: '{.credential.token_expiry}'
token-key: '{.credential.access_token}'
name: gcp
```
### `container.roles.escalate` | `container.clusterRoles.escalate`

Domylnie **Kubernetes** uniemo偶liwia podmiotom tworzenie lub aktualizowanie r贸l i clusterR贸l z wikszymi uprawnieniami ni偶 te, kt贸re posiada podmiot. Jednak podmiot GCP posiadajcy te uprawnienia bdzie m贸g tworzy/aktualizowa role/clusterRole z wikszymi uprawnieniami ni偶 te, kt贸re posiada, co umo偶liwia obejcie ochrony Kubernetes przed tym zachowaniem.

Wymagane s r贸wnie偶 uprawnienia **`container.roles.create`** i/lub **`container.roles.update`** LUB **`container.clusterRoles.create`** i/lub **`container.clusterRoles.update`** do wykonania tych dziaa eskalacji uprawnie.

### `container.roles.bind` | `container.clusterRoles.bind`

Domylnie **Kubernetes** uniemo偶liwia podmiotom tworzenie lub aktualizowanie RoleBindings i ClusterRoleBindings w celu nadania wikszych uprawnie ni偶 te, kt贸re posiada podmiot. Jednak podmiot GCP posiadajcy te uprawnienia bdzie m贸g tworzy/aktualizowa RoleBindings/ClusterRoleBindings z wikszymi uprawnieniami ni偶 te, kt贸re posiada, co umo偶liwia obejcie ochrony Kubernetes przed tym zachowaniem.

Wymagane s r贸wnie偶 uprawnienia **`container.roleBindings.create`** i/lub **`container.roleBindings.update`** LUB **`container.clusterRoleBindings.create`** i/lub **`container.clusterRoleBindings.update`** do wykonania tych dziaa eskalacji uprawnie.

### `container.cronJobs.create` | `container.cronJobs.update` | `container.daemonSets.create` | `container.daemonSets.update` | `container.deployments.create` | `container.deployments.update` | `container.jobs.create` | `container.jobs.update` | `container.pods.create` | `container.pods.update` | `container.replicaSets.create` | `container.replicaSets.update` | `container.replicationControllers.create` | `container.replicationControllers.update` | `container.scheduledJobs.create` | `container.scheduledJobs.update` | `container.statefulSets.create` | `container.statefulSets.update`

Wszystkie te uprawnienia umo偶liwiaj tworzenie lub aktualizowanie zasobu, w kt贸rym mo偶na zdefiniowa pod. Definiujc pod, mo偶na okreli SA, kt贸ry zostanie do niego doczony, oraz obraz, kt贸ry zostanie uruchomiony. Dziki temu mo偶na uruchomi obraz, kt贸ry wykradnie token SA do twojego serwera, umo偶liwiajc eskalacj do dowolnego konta usugi.
Aby uzyska wicej informacji, sprawd藕:

Poniewa偶 jestemy w rodowisku GCP, bdziesz r贸wnie偶 m贸g uzyska SA nodepoola z usugi metadanych i eskalowa uprawnienia w GCP (domylnie u偶ywane jest SA obliczeniowe).

### `container.secrets.get` | `container.secrets.list`

Z tymi uprawnieniami mo偶na odczyta tokeny wszystkich SA w Kubernetes, co umo偶liwia eskalacj do nich.

### `container.pods.exec`

Dziki temu uprawnieniu bdziesz m贸g wykona polecenie wewntrz pod贸w, co daje dostp do wszystkich SA Kubernetes dziaajcych w podach, umo偶liwiajc eskalacj uprawnie w K8s. Bdziesz r贸wnie偶 m贸g ukra GCP Service Account z NodePool, eskalujc uprawnienia w GCP.

### `container.pods.portForward`

Z tymi uprawnieniami mo偶na uzyska dostp do lokalnych usug uruchomionych w podach, co mo偶e umo偶liwi eskalacj uprawnie w Kubernetes (i w GCP, jeli uda ci si somehow porozmawia z usug metadanych).

### `container.serviceAccounts.createToken`

Ze wzgldu na nazw uprawnienia wydaje si, 偶e umo偶liwia generowanie token贸w kont usug K8s, dziki czemu bdziesz m贸g eskalowa uprawnienia do dowolnego SA wewntrz Kubernetes. Jednak nie znalazem 偶adnego punktu kocowego API do jego u偶ycia, wic daj mi zna, jeli go znajdziesz.

### `container.mutatingWebhookConfigurations.create` | `container.mutatingWebhookConfigurations.update`

Te uprawnienia mog umo偶liwi eskalacj uprawnie w Kubernetes, ale bardziej prawdopodobne jest, 偶e mo偶na je wykorzysta do trwaego pozostania w klastrze.
Aby uzyska wicej informacji, [kliknij tutaj](../../kubernetes-security/abusing-roles-clusterroles-in-kubernetes/#malicious-admission-controller).
