# GCP - Escalada de privilegios IAM

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## IAM

Encuentra m치s informaci칩n sobre IAM en:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Un atacante con los permisos mencionados podr치 actualizar un rol asignado a ti y otorgarte permisos adicionales a otros recursos como:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Puedes encontrar un script para automatizar la **creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤** y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Para m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Un atacante con los permisos mencionados podr치 **solicitar un token de acceso que pertenece a una Cuenta de Servicio**, por lo que es posible solicitar un token de acceso de una Cuenta de Servicio con m치s privilegios que los nuestros.

Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Para m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Un atacante con los permisos mencionados podr치 **crear una clave gestionada por el usuario para una Cuenta de Servicio**, lo que nos permitir치 acceder a GCP como esa Cuenta de Servicio.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Para obtener m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Nota que **`iam.serviceAccountKeys.update` no funcionar치 para modificar la clave** de un SA porque se necesita tambi칠n el permiso `iam.serviceAccountKeys.create`.

### `iam.serviceAccounts.implicitDelegation`

Si tienes el permiso **`iam.serviceAccounts.implicitDelegation`** en una Cuenta de Servicio que tiene el permiso **`iam.serviceAccounts.getAccessToken`** en una tercera Cuenta de Servicio, entonces puedes usar la delegaci칩n impl칤cita para **crear un token para esa tercera Cuenta de Servicio**. Aqu칤 tienes un diagrama para ayudar a explicar.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Para obtener m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Nota que seg칰n la [**documentaci칩n**](https://cloud.google.com/iam/docs/understanding-service-accounts), la delegaci칩n solo funciona para generar un token utilizando el m칠todo [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken).

### `iam.serviceAccounts.signBlob`

Un atacante con los permisos mencionados podr치 **firmar cargas arbitrarias en GCP**. Por lo tanto, ser치 posible **crear un JWT no firmado del SA y luego enviarlo como un blob para que el JWT sea firmado** por el SA que estamos apuntando. Para obtener m치s informaci칩n [**lee esto**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) y [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Para obtener m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Un atacante con los permisos mencionados podr치 **firmar tokens JSON web (JWTs) bien formados**. La diferencia con el m칠todo anterior es que **en lugar de hacer que Google firme un blob que contiene un JWT, usamos el m칠todo signJWT que ya espera un JWT**. Esto facilita su uso, pero solo puedes firmar JWT en lugar de cualquier bytes.

Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) y un script en python para abusar de este privilegio [**aqu칤**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Para obtener m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Un atacante con los permisos mencionados podr치 **agregar pol칤ticas de IAM a las cuentas de servicio**. Puedes abusar de esto para **concederte** los permisos que necesitas para suplantar la cuenta de servicio. En el siguiente ejemplo nos estamos otorgando el rol `roles/iam.serviceAccountTokenCreator` sobre la SA de inter칠s:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
Puedes encontrar un script para automatizar la [**creaci칩n, explotaci칩n y limpieza de un entorno vulnerable aqu칤**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

El **permiso iam.serviceAccounts.actAs** es similar al **permiso iam:PassRole de AWS**. Es esencial para ejecutar tareas, como iniciar una instancia de Compute Engine, ya que otorga la capacidad de "actuar como" una Cuenta de Servicio, asegurando una gesti칩n segura de permisos. Sin esto, los usuarios podr칤an obtener acceso indebido. Adem치s, explotar el **iam.serviceAccounts.actAs** implica varios m칠todos, cada uno requiriendo un conjunto de permisos, a diferencia de otros m칠todos que solo necesitan uno.

#### Suplantaci칩n de cuenta de servicio <a href="#suplantaci칩n-de-cuenta-de-servicio" id="suplantaci칩n-de-cuenta-de-servicio"></a>

Suplantar una cuenta de servicio puede ser muy 칰til para **obtener nuevos y mejores privilegios**. Hay tres formas en las que puedes [suplantar otra cuenta de servicio](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Autenticaci칩n **usando claves privadas RSA** (mencionado anteriormente)
* Autorizaci칩n **usando pol칤ticas de Cloud IAM** (mencionado aqu칤)
* **Implementar trabajos en servicios de GCP** (m치s aplicable al compromiso de una cuenta de usuario)

### `iam.serviceAccounts.getOpenIdToken`

Un atacante con los permisos mencionados podr치 generar un JWT OpenID. Estos se utilizan para afirmar la identidad y no necesariamente llevan impl칤cita ninguna autorizaci칩n contra un recurso.

Seg칰n este [**interesante post**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), es necesario indicar la audiencia (servicio donde deseas usar el token para autenticarte) y recibir치s un JWT firmado por Google indicando la cuenta de servicio y la audiencia del JWT.

Puedes generar un OpenIDToken (si tienes acceso) con:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Entonces puedes usarlo para acceder al servicio con:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Algunos servicios que admiten la autenticaci칩n a trav칠s de este tipo de tokens son:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (si se utiliza Google OIDC)

Puedes encontrar un ejemplo de c칩mo crear un token OpenID en nombre de una cuenta de servicio [**aqu칤**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
