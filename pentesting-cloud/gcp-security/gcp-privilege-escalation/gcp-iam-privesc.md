# GCP - IAM Privesc

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## IAM

Encuentra m谩s informaci贸n sobre IAM en:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Si tienes los permisos mencionados podr谩s actualizar un rol asignado a ti y otorgarte permisos adicionales a otros recursos como:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Puede encontrar un script para automatizar la **creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆** y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Este permiso permite **solicitar un token de acceso que pertenece a una Cuenta de Servicio**, por lo que es posible solicitar un token de acceso de una Cuenta de Servicio con m谩s privilegios que los nuestros.

Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Este permiso nos permite hacer algo similar al m茅todo anterior, pero en lugar de un token de acceso, estamos **creando una clave gestionada por el usuario para una Cuenta de Servicio**, lo que nos permitir谩 acceder a GCP como esa Cuenta de Servicio.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Tenga en cuenta que **`iam.serviceAccountKeys.update` no funcionar谩 para modificar la clave** de una SA porque para hacer eso tambi茅n se necesita el permiso `iam.serviceAccountKeys.create`.

### `iam.serviceAccounts.implicitDelegation`

Si tiene el permiso **`iam.serviceAccounts.implicitDelegation`** en una Cuenta de Servicio que tiene el permiso **`iam.serviceAccounts.getAccessToken`** en una tercera Cuenta de Servicio, entonces puede usar implicitDelegation para **crear un token para esa tercera Cuenta de Servicio**. Aqu铆 hay un diagrama para ayudar a explicar.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Tenga en cuenta que, seg煤n la [**documentaci贸n**](https://cloud.google.com/iam/docs/understanding-service-accounts), la delegaci贸n solo funciona para generar un token utilizando el m茅todo [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken).

### `iam.serviceAccounts.signBlob`

El permiso **`iam.serviceAccounts.signBlob`** "permite la firma de cargas 煤tiles arbitrarias" en GCP. Esto significa que podemos **crear un JWT sin firmar de la SA y luego enviarlo como un blob para obtener el JWT firmado** por la SA que estamos atacando. Para m谩s informaci贸n [**lea esto**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) y [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

De manera similar a c贸mo el m茅todo anterior funcionaba firmando cargas 煤tiles arbitrarias, este m茅todo funciona firmando tokens web JSON (JWTs) bien formados. La diferencia con el m茅todo anterior es que **en lugar de hacer que google firme un blob que contiene un JWT, usamos el m茅todo signJWT que ya espera un JWT**. Esto lo hace m谩s f谩cil de usar, pero solo puede firmar JWT en lugar de cualquier byte.

Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) y un script de python para abusar de este privilegio [**aqu铆**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Para m谩s informaci贸n, consulte la [**investigaci贸n original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Este permiso permite **agregar pol铆ticas IAM a cuentas de servicio**. Puede abusar de 茅l para **otorgarse** los permisos que necesita para suplantar la cuenta de servicio. En el siguiente ejemplo, nos estamos otorgando el rol `roles/iam.serviceAccountTokenCreator` sobre la SA interesante:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
Puede encontrar un script para automatizar la [**creaci贸n, explotaci贸n y limpieza de un entorno vulnerable aqu铆**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

Esto significa que como parte de la creaci贸n de ciertos recursos, debe "actuar como" la Cuenta de Servicio para que la llamada se complete con 茅xito. Por ejemplo, al iniciar una nueva instancia de Compute Engine con una Cuenta de Servicio adjunta, necesita **`iam.serviceAccounts.actAs`** en esa Cuenta de Servicio. Esto se debe a que sin ese permiso, los usuarios podr铆an escalar permisos con menos permisos para comenzar.

**Hay varios m茅todos individuales que usan `iam.serviceAccounts.actAs`, por lo que, dependiendo de sus propios permisos, es posible que solo pueda explotar uno (o m谩s) de estos m茅todos a continuaci贸n**. Estos m茅todos son ligeramente diferentes en que **requieren m煤ltiples permisos para explotar, en lugar de un solo permiso** como todos los m茅todos anteriores.

#### Suplantaci贸n de cuenta de servicio <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Suplantar una cuenta de servicio puede ser muy 煤til para **obtener nuevos y mejores privilegios**. Hay tres formas en las que puede [suplantar otra cuenta de servicio](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account):

* Autenticaci贸n **usando claves privadas RSA** (cubierto arriba)
* Autorizaci贸n **usando pol铆ticas de Cloud IAM** (cubierto aqu铆)
* **Desplegando trabajos en servicios de GCP** (m谩s aplicable al compromiso de una cuenta de usuario)

### `iam.serviceAccounts.getOpenIdToken`

Este permiso se puede utilizar para generar un JWT de OpenID. Estos se utilizan para afirmar la identidad y no necesariamente conllevan ninguna autorizaci贸n impl铆cita contra un recurso.

De acuerdo con este [**post interesante**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), es necesario indicar la audiencia (servicio donde desea usar el token para autenticarse) y recibir谩 un JWT firmado por Google que indica la cuenta de servicio y la audiencia del JWT.

Puede generar un OpenIDToken (si tiene acceso) con:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Entonces puedes usarlo para acceder al servicio con:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Algunos servicios que admiten autenticaci贸n a trav茅s de este tipo de tokens son:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (si se utiliza Google OIDC)

Puedes encontrar un ejemplo de c贸mo crear un token OpenID en nombre de una cuenta de servicio [**aqu铆**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
