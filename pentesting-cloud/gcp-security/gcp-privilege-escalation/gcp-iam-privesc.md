# GCP - IAMæƒé™æå‡

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## IAM

### `iam.roles.update` (`iam.roles.get`)

å¦‚æœæ‚¨æ‹¥æœ‰ä¸Šè¿°æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿæ›´æ–°åˆ†é…ç»™æ‚¨çš„è§’è‰²ï¼Œå¹¶ä¸ºå…¶ä»–èµ„æºæä¾›é¢å¤–çš„æƒé™ï¼Œä¾‹å¦‚ï¼š
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†ä¸€ä¸ªæ¼æ´ç¯å¢ƒ**ï¼Œå¹¶ä¸”å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py)æ‰¾åˆ°ä¸€ä¸ªæ»¥ç”¨è¿™ä¸ªæƒé™çš„Pythonè„šæœ¬ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

æ­¤æƒé™å…è®¸**è¯·æ±‚å±äºæœåŠ¡å¸å·çš„è®¿é—®ä»¤ç‰Œ**ï¼Œå› æ­¤å¯ä»¥è¯·æ±‚ä¸€ä¸ªæ¯”æˆ‘ä»¬æƒé™æ›´é«˜çš„æœåŠ¡å¸å·çš„è®¿é—®ä»¤ç‰Œã€‚

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†ä¸€ä¸ªæ¼æ´ç¯å¢ƒ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh)ï¼Œå¹¶ä¸”å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py)æ‰¾åˆ°ä¸€ä¸ªæ»¥ç”¨è¿™ä¸ªæƒé™çš„Pythonè„šæœ¬ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccountKeys.create`

æ­¤æƒé™å…è®¸æˆ‘ä»¬æ‰§è¡Œç±»ä¼¼äºå‰ä¸€ç§æ–¹æ³•çš„æ“ä½œï¼Œä½†ä¸æ˜¯åˆ›å»ºè®¿é—®ä»¤ç‰Œï¼Œè€Œæ˜¯**ä¸ºæœåŠ¡å¸å·åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç®¡ç†çš„å¯†é’¥**ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬ä»¥è¯¥æœåŠ¡å¸å·çš„èº«ä»½è®¿é—®GCPã€‚
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh)ï¼Œä»¥åŠä¸€ä¸ªæ»¥ç”¨æ­¤æƒé™çš„Pythonè„šæœ¬[æ­¤å¤„](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py)ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

è¯·æ³¨æ„ï¼Œ**`iam.serviceAccountKeys.update`æ— æ³•ä¿®æ”¹SAçš„å¯†é’¥**ï¼Œå› ä¸ºè¿˜éœ€è¦`iam.serviceAccountKeys.create`æƒé™ã€‚

### `iam.serviceAccounts.implicitDelegation`

å¦‚æœæ‚¨åœ¨å…·æœ‰ç¬¬ä¸‰æ–¹æœåŠ¡å¸æˆ·ä¸Šå…·æœ‰**`iam.serviceAccounts.getAccessToken`**æƒé™çš„æœåŠ¡å¸æˆ·ä¸Šå…·æœ‰**`iam.serviceAccounts.implicitDelegation`**æƒé™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨implicitDelegationä¸ºè¯¥ç¬¬ä¸‰æ–¹æœåŠ¡å¸æˆ·**åˆ›å»ºä»¤ç‰Œ**ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå›¾è¡¨ä»¥å¸®åŠ©è§£é‡Šã€‚

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh)ï¼Œä»¥åŠä¸€ä¸ªæ»¥ç”¨æ­¤æƒé™çš„Pythonè„šæœ¬[æ­¤å¤„](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py)ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

è¯·æ³¨æ„ï¼Œæ ¹æ®[æ–‡æ¡£](https://cloud.google.com/iam/docs/understanding-service-accounts)ï¼Œå§”æ´¾ä»…é€‚ç”¨äºä½¿ç”¨[generateAccessToken()](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken)æ–¹æ³•ç”Ÿæˆä»¤ç‰Œã€‚

### `iam.serviceAccounts.signBlob`

**`iam.serviceAccounts.signBlob`**æƒé™åœ¨GCPä¸­â€œå…è®¸ç­¾ç½²ä»»æ„æœ‰æ•ˆè´Ÿè½½â€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥**åˆ›å»ºä¸€ä¸ªæœªç­¾åçš„SA JWTï¼Œç„¶åå°†å…¶ä½œä¸ºBlobå‘é€ä»¥è·å¾—ç›®æ ‡SAç­¾åçš„JWT**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»[æ­¤å¤„](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed)ã€‚

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh)ï¼Œä»¥åŠä¸€ä¸ªæ»¥ç”¨æ­¤æƒé™çš„Pythonè„šæœ¬[æ­¤å¤„](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py)å’Œ[æ­¤å¤„](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py)ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.signJwt`

ä¸å‰ä¸€ç§æ–¹æ³•ç±»ä¼¼ï¼Œæ­¤æ–¹æ³•é€šè¿‡ç­¾ç½²æ ¼å¼è‰¯å¥½çš„JSON Webä»¤ç‰Œï¼ˆJWTï¼‰æ¥å·¥ä½œã€‚ä¸å‰ä¸€ç§æ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œ**æˆ‘ä»¬ä¸æ˜¯è®©Googleç­¾ç½²åŒ…å«JWTçš„Blobï¼Œè€Œæ˜¯ä½¿ç”¨å·²ç»æœŸæœ›JWTçš„signJWTæ–¹æ³•**ã€‚è¿™ä½¿å¾—ä½¿ç”¨æ›´åŠ ç®€å•ï¼Œä½†æ‚¨åªèƒ½ç­¾ç½²JWTè€Œä¸æ˜¯ä»»ä½•å­—èŠ‚ã€‚

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh)ï¼Œä»¥åŠä¸€ä¸ªæ»¥ç”¨æ­¤æƒé™çš„Pythonè„šæœ¬[æ­¤å¤„](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py)ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

æ­¤æƒé™å…è®¸**å‘æœåŠ¡å¸æˆ·æ·»åŠ IAMç­–ç•¥**ã€‚æ‚¨å¯ä»¥æ»¥ç”¨å®ƒæ¥**æˆäºˆè‡ªå·±**æ¨¡æ‹ŸæœåŠ¡å¸æˆ·æ‰€éœ€çš„æƒé™ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæœ‰è¶£çš„SAæˆäºˆ`roles/iam.serviceAccountTokenCreator`è§’è‰²ï¼š
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–[åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†ä¸€ä¸ªæ¼æ´ç¯å¢ƒ](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)ã€‚

### `iam.serviceAccounts.actAs`

è¿™æ„å‘³ç€åœ¨åˆ›å»ºæŸäº›èµ„æºæ—¶ï¼Œæ‚¨å¿…é¡»â€œæ‰®æ¼”â€æœåŠ¡å¸æˆ·æ‰èƒ½æˆåŠŸå®Œæˆè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå½“ä½¿ç”¨é™„åŠ çš„æœåŠ¡å¸æˆ·å¯åŠ¨æ–°çš„è®¡ç®—å¼•æ“å®ä¾‹æ—¶ï¼Œæ‚¨éœ€è¦åœ¨è¯¥æœåŠ¡å¸æˆ·ä¸Šå…·æœ‰**`iam.serviceAccounts.actAs`**æƒé™ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæ²¡æœ‰è¯¥æƒé™ï¼Œç”¨æˆ·å¯èƒ½ä¼šé€šè¿‡è¾ƒå°‘çš„æƒé™å‡çº§æƒé™ã€‚

æ ¹æ®æ‚¨è‡ªå·±çš„æƒé™ï¼Œå¯èƒ½åªèƒ½åˆ©ç”¨ä¸‹é¢è¿™äº›æ–¹æ³•ä¸­çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•ç•¥æœ‰ä¸åŒï¼Œéœ€è¦å¤šä¸ªæƒé™æ¥åˆ©ç”¨ï¼Œè€Œä¸æ˜¯åƒä¹‹å‰çš„æ–¹æ³•é‚£æ ·åªéœ€è¦ä¸€ä¸ªæƒé™ã€‚

### `iam.serviceAccounts.getOpenIdToken`

æ­¤æƒé™å¯ç”¨äºç”Ÿæˆä¸€ä¸ªOpenID JWTã€‚è¿™äº›ç”¨äºå£°æ˜èº«ä»½ï¼Œä¸ä¸€å®šå¯¹èµ„æºè¿›è¡Œä»»ä½•éšå¼æˆæƒã€‚

æ ¹æ®è¿™ç¯‡[**æœ‰è¶£çš„æ–‡ç« **](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b)ï¼Œéœ€è¦æŒ‡å®šå—ä¼—ï¼ˆæ‚¨æƒ³è¦ä½¿ç”¨ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯çš„æœåŠ¡ï¼‰ï¼Œç„¶åæ‚¨å°†æ”¶åˆ°ç”±Googleç­¾åçš„JWTï¼Œå…¶ä¸­åŒ…å«æœåŠ¡å¸æˆ·å’ŒJWTçš„å—ä¼—ã€‚

å¦‚æœæ‚¨æœ‰æƒé™ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªOpenIDTokenï¼š
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
ç„¶åä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®è¯¥æœåŠ¡ï¼š
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
æ”¯æŒé€šè¿‡è¿™ç§ç±»å‹ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯çš„ä¸€äº›æœåŠ¡åŒ…æ‹¬ï¼š

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id)ï¼ˆå¦‚æœä½¿ç”¨Google OIDCï¼‰

æ‚¨å¯ä»¥åœ¨[**æ­¤å¤„**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py)æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä»£è¡¨æœåŠ¡è´¦å·åˆ›å»ºå’Œä½¿ç”¨OpenIDä»¤ç‰Œã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
