# GCP - IAM Privesc

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## IAM

åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æ›´å¤šå…³äºIAMçš„ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

å¦‚æœæ‚¨æ‹¥æœ‰ä¸Šè¿°æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿæ›´æ–°åˆ†é…ç»™æ‚¨çš„è§’è‰²ï¼Œå¹¶ä¸ºæ‚¨æä¾›å¯¹å…¶ä»–èµ„æºçš„é¢å¤–æƒé™ï¼Œä¾‹å¦‚ï¼š
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py)æ‰¾åˆ°ä¸€ä¸ªPythonè„šæœ¬æ¥æ»¥ç”¨è¿™ä¸ªæƒé™ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

æ­¤æƒé™å…è®¸**è¯·æ±‚å±äºæœåŠ¡è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œ**ï¼Œå› æ­¤å¯ä»¥è¯·æ±‚ä¸€ä¸ªæ¯”æˆ‘ä»¬æƒé™æ›´é«˜çš„æœåŠ¡è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œã€‚

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh)æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†ä¸€ä¸ªæ¼æ´ç¯å¢ƒ**ï¼Œå¹¶ä¸”å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py)æ‰¾åˆ°ä¸€ä¸ªPythonè„šæœ¬æ¥æ»¥ç”¨è¿™ä¸ªæƒé™ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccountKeys.create`

æ­¤æƒé™å…è®¸æˆ‘ä»¬æ‰§è¡Œä¸å‰ä¸€æ–¹æ³•ç±»ä¼¼çš„æ“ä½œï¼Œä½†æˆ‘ä»¬ä¸æ˜¯è·å–è®¿é—®ä»¤ç‰Œï¼Œè€Œæ˜¯**ä¸ºæœåŠ¡è´¦æˆ·åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç®¡ç†çš„å¯†é’¥**ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬ä»¥è¯¥æœåŠ¡è´¦æˆ·çš„èº«ä»½è®¿é—®GCPã€‚
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh)æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ**ï¼Œä»¥åŠä¸€ä¸ªç”¨äºæ»¥ç”¨æ­¤æƒé™çš„pythonè„šæœ¬[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py)ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

è¯·æ³¨æ„ï¼Œ**`iam.serviceAccountKeys.update` æ— æ³•ç”¨äºä¿®æ”¹SAçš„å¯†é’¥**ï¼Œå› ä¸ºè¦åšåˆ°è¿™ä¸€ç‚¹è¿˜éœ€è¦`iam.serviceAccountKeys.create`æƒé™ã€‚

### `iam.serviceAccounts.implicitDelegation`

å¦‚æœæ‚¨æ‹¥æœ‰å¯¹æŸä¸ªæœåŠ¡è´¦æˆ·çš„**`iam.serviceAccounts.implicitDelegation`**æƒé™ï¼Œè€Œè¯¥æœåŠ¡è´¦æˆ·åˆå¯¹ç¬¬ä¸‰ä¸ªæœåŠ¡è´¦æˆ·æ‹¥æœ‰**`iam.serviceAccounts.getAccessToken`**æƒé™ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨implicitDelegationæ¥**ä¸ºé‚£ä¸ªç¬¬ä¸‰ä¸ªæœåŠ¡è´¦æˆ·åˆ›å»ºä»¤ç‰Œ**ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå›¾è¡¨å¸®åŠ©è§£é‡Šã€‚

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh)æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ**ï¼Œä»¥åŠä¸€ä¸ªç”¨äºæ»¥ç”¨æ­¤æƒé™çš„pythonè„šæœ¬[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py)ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

è¯·æ³¨æ„ï¼Œæ ¹æ®[**æ–‡æ¡£**](https://cloud.google.com/iam/docs/understanding-service-accounts)ï¼Œå§”æ‰˜åªé€‚ç”¨äºä½¿ç”¨[**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken)æ–¹æ³•ç”Ÿæˆä»¤ç‰Œã€‚

### `iam.serviceAccounts.signBlob`

**`iam.serviceAccounts.signBlob`**æƒé™åœ¨GCPä¸­â€œå…è®¸ç­¾ç½²ä»»æ„æœ‰æ•ˆè½½è·â€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥**åˆ›å»ºSAçš„æœªç­¾åJWTï¼Œç„¶åå°†å…¶ä½œä¸ºblobå‘é€ä»¥è·å–SAç­¾åçš„JWT**ã€‚æ›´å¤šä¿¡æ¯è¯·[**é˜…è¯»è¿™ç¯‡æ–‡ç« **](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed)ã€‚

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh)æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ**ï¼Œä»¥åŠç”¨äºæ»¥ç”¨æ­¤æƒé™çš„pythonè„šæœ¬[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py)å’Œ[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py)ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.signJwt`

ä¸ä¹‹å‰é€šè¿‡ç­¾ç½²ä»»æ„æœ‰æ•ˆè½½è·çš„æ–¹æ³•ç±»ä¼¼ï¼Œè¿™ç§æ–¹æ³•é€šè¿‡ç­¾ç½²æ ¼å¼è‰¯å¥½çš„JSONç½‘ç»œä»¤ç‰Œï¼ˆJWTsï¼‰æ¥å·¥ä½œã€‚ä¸å‰ä¸€ç§æ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œ**æˆ‘ä»¬ä¸æ˜¯è®©è°·æ­Œç­¾ç½²åŒ…å«JWTçš„blobï¼Œè€Œæ˜¯ä½¿ç”¨å·²ç»é¢„æœŸJWTçš„signJWTæ–¹æ³•**ã€‚è¿™ä½¿å¾—å®ƒæ›´å®¹æ˜“ä½¿ç”¨ï¼Œä½†æ‚¨åªèƒ½ç­¾ç½²JWTè€Œä¸æ˜¯ä»»ä½•å­—èŠ‚ã€‚

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh)æ‰¾åˆ°ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–**åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ**ï¼Œä»¥åŠä¸€ä¸ªç”¨äºæ»¥ç”¨æ­¤æƒé™çš„pythonè„šæœ¬[**è¿™é‡Œ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py)ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)ã€‚

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

æ­¤æƒé™å…è®¸**å‘æœåŠ¡è´¦æˆ·æ·»åŠ IAMç­–ç•¥**ã€‚æ‚¨å¯ä»¥æ»¥ç”¨å®ƒæ¥**æˆäºˆè‡ªå·±**æ‰€éœ€çš„æƒé™æ¥æ¨¡æ‹ŸæœåŠ¡è´¦æˆ·ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºè‡ªå·±æˆäºˆå¯¹æœ‰è¶£SAçš„`roles/iam.serviceAccountTokenCreator`è§’è‰²ï¼š
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªè„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨åŒ–åˆ›å»ºã€åˆ©ç”¨å’Œæ¸…ç†æ¼æ´ç¯å¢ƒ**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**ã€‚**

### `iam.serviceAccounts.actAs`

è¿™æ„å‘³ç€ä½œä¸ºåˆ›å»ºæŸäº›èµ„æºçš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨å¿…é¡»â€œactAsâ€æœåŠ¡å¸æˆ·æ‰èƒ½æˆåŠŸå®Œæˆè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå¯åŠ¨ä¸€ä¸ªé™„åŠ äº†æœåŠ¡å¸æˆ·çš„æ–°Compute Engineå®ä¾‹æ—¶ï¼Œæ‚¨éœ€è¦å¯¹è¯¥æœåŠ¡å¸æˆ·æœ‰**`iam.serviceAccounts.actAs`**æƒé™ã€‚è¿™æ˜¯å› ä¸ºæ²¡æœ‰è¯¥æƒé™ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨æ›´å°‘çš„æƒé™æ¥æå‡æƒé™ã€‚

**æœ‰å¤šä¸ªå•ç‹¬çš„æ–¹æ³•ä½¿ç”¨`iam.serviceAccounts.actAs`ï¼Œå› æ­¤æ ¹æ®æ‚¨è‡ªå·±çš„æƒé™ï¼Œæ‚¨å¯èƒ½åªèƒ½åˆ©ç”¨ä»¥ä¸‹ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰æ–¹æ³•**ã€‚è¿™äº›æ–¹æ³•ç•¥æœ‰ä¸åŒï¼Œå®ƒä»¬**éœ€è¦å¤šä¸ªæƒé™æ¥åˆ©ç”¨ï¼Œè€Œä¸æ˜¯åƒæ‰€æœ‰ä¹‹å‰çš„æ–¹æ³•é‚£æ ·åªéœ€è¦å•ä¸€æƒé™**ã€‚

#### æœåŠ¡å¸æˆ·æ¨¡æ‹Ÿ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

æ¨¡æ‹ŸæœåŠ¡å¸æˆ·å¯ä»¥éå¸¸æœ‰ç”¨ï¼Œä»¥**è·å¾—æ–°çš„å’Œæ›´å¥½çš„æƒé™**ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼[æ¨¡æ‹Ÿå¦ä¸€ä¸ªæœåŠ¡å¸æˆ·](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account)ï¼š

* ä½¿ç”¨RSAç§é’¥è¿›è¡Œè®¤è¯ï¼ˆä¸Šæ–‡å·²è¦†ç›–ï¼‰
* ä½¿ç”¨Cloud IAMç­–ç•¥è¿›è¡Œæˆæƒï¼ˆæ­¤å¤„è¦†ç›–ï¼‰
* **åœ¨GCPæœåŠ¡ä¸Šéƒ¨ç½²ä½œä¸š**ï¼ˆæ›´é€‚ç”¨äºç”¨æˆ·å¸æˆ·çš„å¦¥åï¼‰

### `iam.serviceAccounts.getOpenIdToken`

æ­¤æƒé™å¯ç”¨äºç”ŸæˆOpenID JWTã€‚è¿™äº›ç”¨äºå£°æ˜èº«ä»½ï¼Œå¹¶ä¸ä¸€å®šå¯¹èµ„æºå…·æœ‰ä»»ä½•éšå«çš„æˆæƒã€‚

æ ¹æ®è¿™ç¯‡[**æœ‰è¶£çš„æ–‡ç« **](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b)ï¼Œéœ€è¦æŒ‡æ˜å—ä¼—ï¼ˆæ‚¨æƒ³è¦ä½¿ç”¨ä»¤ç‰Œè¿›è¡Œè®¤è¯çš„æœåŠ¡ï¼‰ï¼Œæ‚¨å°†æ”¶åˆ°ç”±googleç­¾åçš„JWTï¼ŒæŒ‡ç¤ºæœåŠ¡å¸æˆ·å’ŒJWTçš„å—ä¼—ã€‚

å¦‚æœæ‚¨æœ‰æƒé™ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªOpenIDTokenï¼š
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
```plaintext
ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®æœåŠ¡ï¼š
```
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
ä»¥ä¸‹æœåŠ¡æ”¯æŒé€šè¿‡æ­¤ç±»ä»¤ç‰Œè¿›è¡Œè®¤è¯ï¼š

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id)ï¼ˆå¦‚æœä½¿ç”¨Google OIDCï¼‰

æ‚¨å¯ä»¥åœ¨[**è¿™é‡Œ**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py)æ‰¾åˆ°ä¸€ä¸ªä»£è¡¨æœåŠ¡è´¦æˆ·åˆ›å»ºOpenIDä»¤ç‰Œçš„ç¤ºä¾‹ã€‚

## å‚è€ƒèµ„æ–™

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
