# GCP - BigQuery ê¶Œí•œ ìƒìŠ¹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* íšŒì‚¬ë¥¼ **HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìƒí’ˆ**](https://peass.creator-spring.com)ì„ êµ¬ë§¤í•˜ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ìì‹ ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## BigQuery

BigQueryì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../gcp-services/gcp-bigquery-enum.md" %}
[gcp-bigquery-enum.md](../gcp-services/gcp-bigquery-enum.md)
{% endcontent-ref %}

### í…Œì´ë¸” ì½ê¸°

BigQuery í…Œì´ë¸”ì— ì €ì¥ëœ ì •ë³´ë¥¼ ì½ìœ¼ë©´ **ë¯¼ê°í•œ ì •ë³´**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì •ë³´ì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê¶Œí•œì€ **`bigquery.tables.get`**, **`bigquery.jobs.create`** ë° **`bigquery.tables.getData`**ì…ë‹ˆë‹¤:
```bash
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
```
### ë°ì´í„° ë‚´ë³´ë‚´ê¸°

ì´ê²ƒì€ ë°ì´í„°ì— ì ‘ê·¼í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ **í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ ë²„í‚·ìœ¼ë¡œ ë‚´ë³´ë‚´ê³ ** ì •ë³´ê°€ ë‹´ê¸´ **íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ**í•©ë‹ˆë‹¤.\
ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: **`bigquery.tables.export`**, **`bigquery.jobs.create`** ë° **`storage.objects.create`**.
```bash
bq extract <dataset>.<table> "gs://<bucket>/table*.csv"
```
### ë°ì´í„° ì‚½ì…

ë‹¤ë¥¸ ì¥ì†Œì˜ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ Bigquery í…Œì´ë¸”ì— **íŠ¹ì • ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ë¥¼ ì‚½ì…**í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **`bigquery.tables.get`**, **`bigquery.tables.updateData`** ë° **`bigquery.jobs.create`** ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ ì‰½ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Via query
bq query --nouse_legacy_sql 'INSERT INTO `<proj>.<dataset>.<table-name>` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'

# Via insert param
bq insert dataset.table /tmp/mydata.json
```
{% endcode %}

### `bigquery.datasets.setIamPolicy`

ê³µê²©ìëŠ” ì´ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ BigQuery ë°ì´í„°ì…‹ì— ëŒ€í•´ **ìì‹ ì—ê²Œ ì¶”ê°€ì ì¸ ê¶Œí•œì„ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# For this you also need bigquery.tables.getIamPolicy
bq add-iam-policy-binding \
--member='user:<email>' \
--role='roles/bigquery.admin' \
<proj>:<dataset>

# use the set-iam-policy if you don't have bigquery.tables.getIamPolicy
```
### `bigquery.datasets.update`, (`bigquery.datasets.get`)

ì´ ê¶Œí•œë§Œìœ¼ë¡œë„ BigQuery ë°ì´í„°ì…‹ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” ACLì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# Download current permissions, reqires bigquery.datasets.get
bq show --format=prettyjson <proj>:<dataset> > acl.json
## Give permissions to the desired user
bq update --source acl.json <proj>:<dataset>
```
### `bigquery.tables.setIamPolicy`

ì´ ê¶Œí•œì„ ì•…ìš©í•˜ëŠ” ê³µê²©ìëŠ” BigQuery í…Œì´ë¸”ì— ëŒ€í•´ **ìì‹ ì—ê²Œ ì¶”ê°€ ê¶Œí•œì„ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# For this you also need bigquery.tables.setIamPolicy
bq add-iam-policy-binding \
--member='user:<email>' \
--role='roles/bigquery.admin' \
<proj>:<dataset>.<table>

# use the set-iam-policy if you don't have bigquery.tables.setIamPolicy
```
### `bigquery.rowAccessPolicies.update`, `bigquery.rowAccessPolicies.setIamPolicy`, `bigquery.tables.getData`, `bigquery.jobs.create`

ë¬¸ì„œì— ë”°ë¥´ë©´, ìœ„ì— ì–¸ê¸‰ëœ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ **í–‰ ì •ì±…ì„ ì—…ë°ì´íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜, **`bq`** CLIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì¶”ê°€ë¡œ í•„ìš”í•œ ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤: **`bigquery.rowAccessPolicies.create`**, **`bigquery.tables.get`**.

{% code overflow="wrap" %}
```bash
bq query --nouse_legacy_sql 'CREATE OR REPLACE ROW ACCESS POLICY <filter_id> ON `<proj>.<dataset-name>.<table-name>` GRANT TO ("user:user@email.xyz") FILTER USING (term = "Cfba");' # A example filter was used
```
{% endcode %}

í–‰ ì •ì±… ì—´ê±°ì˜ ì¶œë ¥ì—ì„œ í•„í„° IDë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆì‹œ:
```bash
bq ls --row_access_policies <proj>:<dataset>.<table>

Id        Filter Predicate            Grantees              Creation Time    Last Modified Time
------------- ------------------ ----------------------------- ----------------- --------------------
apac_filter   term = "Cfba"      user:asd@hacktricks.xyz   21 Jan 23:32:09   21 Jan 23:32:09
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
