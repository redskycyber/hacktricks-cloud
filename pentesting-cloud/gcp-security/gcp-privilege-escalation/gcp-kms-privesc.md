# GCP - KMS æƒé™æå‡

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## KMS

å…³äº KMS çš„ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

è¯·æ³¨æ„ï¼Œåœ¨ KMS ä¸­ï¼Œ**æƒé™**ä¸ä»…ä»ç»„ç»‡ã€æ–‡ä»¶å¤¹å’Œé¡¹ç›®**ç»§æ‰¿**ï¼Œè¿˜æ¥è‡ª**å¯†é’¥ç¯**ã€‚

### `cloudkms.cryptoKeyVersions.useToDecrypt`

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æƒé™**ä½¿ç”¨å¯†é’¥è§£å¯†ä¿¡æ¯**ï¼Œå‰ææ˜¯æ‚¨æ‹¥æœ‰è¯¥æƒé™ã€‚
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥**ç»™è‡ªå·±æƒé™**ä½¿ç”¨å¯†é’¥è§£å¯†ä¿¡æ¯ã€‚
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

ä»¥ä¸‹æ˜¯è¿™ç§å§”æ‰˜å·¥ä½œæ–¹å¼çš„æ¦‚å¿µæ€§åˆ†è§£ï¼š

1. **æœåŠ¡è´¦æˆ·A** ç›´æ¥è®¿é—®ä½¿ç”¨KMSä¸­çš„ç‰¹å®šå¯†é’¥è¿›è¡Œè§£å¯†ã€‚
2. **æœåŠ¡è´¦æˆ·B** è¢«æˆäºˆ `useToDecryptViaDelegation` æƒé™ã€‚è¿™å…è®¸å®ƒä»£è¡¨æœåŠ¡è´¦æˆ·Aè¯·æ±‚KMSè§£å¯†æ•°æ®ã€‚

è¿™ä¸ª**æƒé™çš„ä½¿ç”¨æ˜¯éšå«åœ¨KMSæœåŠ¡æ£€æŸ¥æƒé™çš„æ–¹å¼ä¸­**ï¼Œå½“å‘å‡ºè§£å¯†è¯·æ±‚æ—¶ã€‚

å½“ä½ ä½¿ç”¨Google Cloud KMS APIï¼ˆåœ¨Pythonæˆ–å…¶ä»–è¯­è¨€ä¸­ï¼‰å‘å‡ºæ ‡å‡†è§£å¯†è¯·æ±‚æ—¶ï¼ŒæœåŠ¡**æ£€æŸ¥è¯·æ±‚æœåŠ¡è´¦æˆ·æ˜¯å¦å…·æœ‰å¿…è¦çš„æƒé™**ã€‚å¦‚æœè¯·æ±‚æ˜¯ç”±å…·æœ‰**`useToDecryptViaDelegation`** æƒé™çš„æœåŠ¡è´¦æˆ·å‘å‡ºçš„ï¼ŒKMSéªŒè¯è¿™ä¸ª**è´¦æˆ·æ˜¯å¦è¢«å…è®¸ä»£è¡¨æ‹¥æœ‰å¯†é’¥çš„å®ä½“è¯·æ±‚è§£å¯†**ã€‚

#### ä¸ºå§”æ‰˜è®¾ç½®

1. **å®šä¹‰è‡ªå®šä¹‰è§’è‰²**ï¼šåˆ›å»ºä¸€ä¸ªYAMLæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ`custom_role.yaml`ï¼‰ï¼Œå®šä¹‰è‡ªå®šä¹‰è§’è‰²ã€‚è¯¥æ–‡ä»¶åº”åŒ…æ‹¬ `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` æƒé™ã€‚ä»¥ä¸‹æ˜¯è¯¥æ–‡ä»¶å¯èƒ½çš„æ ·å­ï¼š
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **ä½¿ç”¨ gcloud CLI åˆ›å»ºè‡ªå®šä¹‰è§’è‰²**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æ‚¨çš„ Google Cloud é¡¹ç›®ä¸­åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼š

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
```plaintext
å°† `[YOUR_PROJECT_ID]` æ›¿æ¢ä¸ºæ‚¨çš„ Google Cloud é¡¹ç›® IDã€‚

3. **å‘æœåŠ¡è´¦æˆ·æˆäºˆè‡ªå®šä¹‰è§’è‰²**ï¼šå°†æ‚¨çš„è‡ªå®šä¹‰è§’è‰²åˆ†é…ç»™å°†ä½¿ç”¨æ­¤æƒé™çš„æœåŠ¡è´¦æˆ·ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
å°† `[YOUR_PROJECT_ID]` å’Œ `[SERVICE_ACCOUNT_EMAIL]` åˆ†åˆ«æ›¿æ¢ä¸ºæ‚¨çš„é¡¹ç›® ID å’ŒæœåŠ¡è´¦æˆ·çš„ç”µå­é‚®ä»¶ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
