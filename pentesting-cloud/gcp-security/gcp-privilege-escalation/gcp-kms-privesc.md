# GCP - KMS ê¶Œí•œ ìƒìŠ¹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì„ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìƒí’ˆ**](https://peass.creator-spring.com)ì„ êµ¬ë§¤í•˜ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## KMS

KMSì— ëŒ€í•œ ì •ë³´:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

KMSì—ì„œ **ê¶Œí•œ**ì€ Orgs, Folders, Projectsë¿ë§Œ ì•„ë‹ˆë¼ **Keyrings**ì—ì„œë„ **ìƒì†**ë©ë‹ˆë‹¤.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ **í•´ë‹¹ í‚¤ë¡œ ì •ë³´ë¥¼ ë³µí˜¸í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ë³µí˜¸í™”í•˜ëŠ” ë° í•„ìš”í•œ ê¶Œí•œì„ **ìì‹ ì—ê²Œ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

ë‹¤ìŒì€ ì´ ìœ„ì„ì´ ì‘ë™í•˜ëŠ” ë°©ì‹ì— ëŒ€í•œ ê°œë…ì ì¸ ì„¤ëª…ì…ë‹ˆë‹¤:

1. **ì„œë¹„ìŠ¤ ê³„ì • A**ëŠ” KMSì—ì„œ íŠ¹ì • í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•˜ëŠ” ë° ì§ì ‘ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤.
2. **ì„œë¹„ìŠ¤ ê³„ì • B**ëŠ” `useToDecryptViaDelegation` ê¶Œí•œì„ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê³„ì • Aë¥¼ ëŒ€ì‹ í•˜ì—¬ KMSì— ë°ì´í„° ë³µí˜¸í™”ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ **ê¶Œí•œì€ KMS ì„œë¹„ìŠ¤ê°€ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë°©ì‹ì—ì„œ ì•”ë¬µì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤**.

Google Cloud KMS API(íŒŒì´ì¬ì´ë‚˜ ë‹¤ë¥¸ ì–¸ì–´ì—ì„œ)ë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì¤€ ë³µí˜¸í™” ìš”ì²­ì„ í•  ë•Œ, ì„œë¹„ìŠ¤ëŠ” **ìš”ì²­í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì´ í•„ìš”í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤. ë§Œì•½ ìš”ì²­ì´ **`useToDecryptViaDelegation`** ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì— ì˜í•´ ì´ë£¨ì–´ì§„ë‹¤ë©´, KMSëŠ” ì´ **ê³„ì •ì´ í‚¤ë¥¼ ì†Œìœ í•œ ì—”í‹°í‹°ë¥¼ ëŒ€ì‹ í•˜ì—¬ ë³µí˜¸í™”ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤.

#### ìœ„ì„ ì„¤ì •í•˜ê¸°

1. **ì‚¬ìš©ì ì •ì˜ ì—­í•  ì •ì˜**: `custom_role.yaml`ì´ë¼ëŠ” YAML íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ì •ì˜í•©ë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` ê¶Œí•œì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒì€ ì´ íŒŒì¼ì´ ì–´ë–»ê²Œ ë³´ì¼ ìˆ˜ ìˆëŠ”ì§€ ì˜ˆì‹œì…ë‹ˆë‹¤:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì—­í•  ìƒì„±í•˜ê¸°**: Google Cloud í”„ë¡œì íŠ¸ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ìƒì„±í•˜ì„¸ìš”:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[YOUR_PROJECT_ID]`ë¥¼ Google Cloud í”„ë¡œì íŠ¸ IDë¡œ ëŒ€ì²´í•˜ì‹­ì‹œì˜¤.

3. **ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í•  ë¶€ì—¬**: ì´ ê¶Œí•œì„ ì‚¬ìš©í•  ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ í• ë‹¹í•˜ì‹­ì‹œì˜¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]`ì™€ `[SERVICE_ACCOUNT_EMAIL]`ë¥¼ ê°ê° í”„ë¡œì íŠ¸ IDì™€ ì„œë¹„ìŠ¤ ê³„ì •ì˜ ì´ë©”ì¼ë¡œ ëŒ€ì²´í•˜ì‹­ì‹œì˜¤.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”. ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
