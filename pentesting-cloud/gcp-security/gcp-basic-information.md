# GCP - 基本信息

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **资源层次结构**

Google Cloud使用类似于传统文件系统的[资源层次结构](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)，在概念上类似。这提供了一个具有特定附加点的逻辑父/子工作流程，用于策略和权限。

在高层次上，它看起来像这样：
```
Organization
--> Folders
--> Projects
--> Resources
```
虚拟机（称为计算实例）是一种资源。资源位于项目中，可能与其他计算实例、存储桶等一起。

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **项目迁移**

可以**将一个项目从没有任何组织迁移到具有`roles/resourcemanager.projectCreator`和`roles/resourcemanager.projectMover`权限的组织**。如果项目位于其他组织中，则需要联系GCP支持人员**将其移出该组织**。有关更多信息，请查看[**此链接**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)。

## **组织策略**

允许集中控制组织的云资源：

* 集中控制以**配置限制**组织资源的使用方式。
* 为开发团队**定义和建立**合规边界内的**防护措施**。
* 帮助项目所有者及其团队快速移动，无需担心违反合规性。

这些策略可以被创建以**影响整个组织、文件夹或项目**。目标资源层次结构节点的后代**继承组织策略**。

为了**定义**一个组织策略，**您选择一个**[**约束**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)，这是针对Google Cloud服务或一组Google Cloud服务的特定类型限制。您**配置该约束以符合您的要求**。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### 常见用例 <a href="#common_use_cases" id="common_use_cases"></a>

* 基于域限制资源共享。
* 限制身份和访问管理服务帐号的使用。
* 限制新创建资源的物理位置。
* 禁用服务帐号创建。

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

还有许多约束可让您对组织的资源进行精细控制。有关**更多信息，请参阅**[**所有组织策略服务约束列表**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**。**

### **默认组织策略**

<details>

<summary>这些是Google在设置您的GCP组织时默认添加的策略：</summary>

**访问管理策略**

* **受限域联系人：** 防止将用户添加到指定域之外的基本联系人。这限制了基本联系人只允许受管理的用户身份在您选择的域中接收平台通知。
* **受限域共享：** 防止将用户添加到IAM策略之外的指定域。这限制了IAM策略只允许受管理的用户身份在您选择的域中访问此组织内的资源。
* **公共访问预防：** 防止Cloud Storage存储桶暴露给公众。这确保开发人员无法配置Cloud Storage存储桶以具有未经身份验证的互联网访问。
* **统一存储桶级别访问：** 防止Cloud Storage存储桶中的对象级访问控制列表（ACL）。通过在Cloud Storage存储桶中的所有对象上一致应用IAM策略，简化了您的访问管理。
* **需要OS登录：** 在新项目中创建的VM将启用OS登录。这使您可以使用IAM管理SSH访问您的实例，而无需创建和管理单独的SSH密钥。

**服务帐号的其他安全策略**

* **禁用自动IAM授予：** 防止默认的App Engine和Compute Engine服务帐号在创建时自动被授予项目的编辑IAM角色。这确保服务帐号在创建时不会收到过于宽松的IAM角色。
* **禁用服务帐号密钥创建：** 防止创建公共服务帐号密钥。这有助于减少暴露持久凭据的风险。
* **禁用服务帐号密钥上传：** 防止上传公共服务帐号密钥。这有助于减少密钥材料的泄露或重复使用风险。

**安全VPC网络配置策略**

* **定义VM实例的允许外部IP：** 防止创建具有公共IP的计算实例，这可能会使其暴露给互联网流量。

<!---->

* **禁用VM嵌套虚拟化：** 防止在Compute Engine VM上创建嵌套VM。这降低了具有未经监控的嵌套VM的安全风险。

<!---->

* **禁用VM串行端口：** 防止通过Compute Engine API向Compute Engine VM的串行端口输入。

<!---->

* **限制Cloud SQL实例上的授权网络：** 防止公共或非内部网络范围访问您的Cloud SQL数据库。

<!---->

* **基于IP地址类型限制协议转发：** 防止外部IP地址的VM协议转发。

<!---->

* **限制Cloud SQL实例的公共IP访问：** 防止创建具有公共IP的Cloud SQL实例，这可能会使其暴露给互联网流量。

<!---->

* **限制共享VPC项目留置移除：** 防止意外删除共享VPC主机项目。

<!---->

* **将新项目的内部DNS设置为仅区域DNS：** 防止使用具有降低服务可用性的传统DNS设置。

<!---->

* **跳过默认网络创建：** 防止自动创建默认VPC网络和相关资源。这避免了过于宽松的默认防火墙规则。

<!---->

* **禁用VPC外部IPv6使用：** 防止创建外部IPv6子网，这可能会暴露给未经授权的互联网访问。

</details>

## **IAM角色**

这些类似于AWS中的IAM策略，**每个角色包含一组权限**。

然而，与AWS不同的是，**没有角色的集中存储库**。资源**向Y主体提供X访问角色**，查找谁有权访问资源的唯一方法是使用**`get-iam-policy`方法**查看该资源。\
这可能会成为问题，因为这意味着找出**主体具有哪些权限的唯一方法是询问每个资源它正在授予权限的对象**，而用户可能无权从所有资源获取权限。

IAM中有**三种类型**的角色：

* **基本/原始角色**，包括在引入IAM之前存在的**所有者**、**编辑**和**查看者**角色。
* **预定义角色**，为特定服务提供细粒度访问权限，并由Google Cloud管理。有许多预定义角色，您可以**查看它们及其权限**[**这里**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)。
* **自定义角色**，根据用户指定的权限列表提供细粒度访问权限。

GCP中有成千上万的权限。要检查角色是否具有权限，您可以在[**此处搜索权限**](https://cloud.google.com/iam/docs/permissions-reference)，并查看哪些角色具有该权限。

您还可以在[**此处搜索预定义角色**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)**，**由每个产品提供。请注意，**某些角色**不能附加给用户，**只能附加给SAs，因为它们包含的某些权限**。**\
此外，请注意，**权限**只有在**附加到相关服务时才会生效**。

或者检查**自定义角色是否可以使用**[**此处的特定权限**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**。**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## 用户 <a href="#default-credentials" id="default-credentials"></a>

在 **GCP 控制台** 中 **没有用户或组** 管理，这是在 **Google Workspace** 中完成的。尽管您可以在 Google Workspace 中同步不同的身份提供者。

您可以在 [**https://admin.google.com**](https://admin.google.com/) 访问 Workspaces 的 **用户和组**。

**MFA** 可以 **强制** 应用于 Workspaces 用户，但是，**攻击者** 可能使用令牌访问 GCP **通过 cli，该方式不受 MFA 保护**（仅当用户登录以生成令牌时才受 MFA 保护：`gcloud auth login`）。

## 组

创建组织时建议创建几个组。如果您管理其中任何一个，可能会危及整个组织或重要部分：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>组</strong></td><td><strong>功能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(需要清单的组或个人帐户)</em></td><td>管理属于组织的任何资源。谨慎分配此角色；组织管理员可以访问您的所有 Google Cloud 资源。或者，由于此功能权限很高，考虑使用个人帐户而不是创建组。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(需要清单)</em></td><td>创建网络、子网、防火墙规则以及网络设备，如 Cloud Router、Cloud VPN 和云负载均衡器。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(需要清单)</em></td><td>设置计费账户并监视其使用情况。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(需要清单)</em></td><td>设计、编码和测试应用程序。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>为整个组织建立和管理安全策略，包括访问管理和<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">组织约束策略</a>。有关规划您的 Google Cloud 安全基础设施的更多信息，请参阅<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud 安全基础指南</a>。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>创建或管理支持持续集成和交付、监控和系统供应的端到端流水线。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(不再默认)</em></td><td>监视项目的支出。典型成员属于财务团队。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(不再默认)</em></td><td>查看 Google Cloud 组织中的资源信息。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(不再默认)</em></td><td>审查云安全。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(不再默认)</em></td><td>审查网络配置。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(不再默认)</em></td><td>查看审计日志。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(不再默认)</em></td><td>管理安全命令中心。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(不再默认)</em></td><td>管理 Secret Manager 中的秘密。</td></tr></tbody></table>

## **默认密码策略**

* 强制使用强密码
* 8 到 100 个字符
* 不重复使用
* 不过期
* 如果人们通过第三方提供程序访问 Workspace，则不适用这些要求。

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **服务账号**

这些是 **资源** 可以 **附加** 并访问以便与 GCP 轻松交互的主体。例如，可以访问附加到 VM 中的服务账号的 **auth 令牌**。\
在同时使用 **IAM 和访问范围** 时可能会遇到一些 **冲突**。例如，您的服务账号可能具有 `compute.instanceAdmin` 的 IAM 角色，但您入侵的实例已被限制为 `https://www.googleapis.com/auth/compute.readonly` 的范围。这将阻止您使用自动分配给实例的 OAuth 令牌进行任何更改。

这类似于 **AWS 的 IAM 角色**。但与 AWS 不同的是，**任何** 服务账号都可以 **附加到任何服务**（不需要通过策略允许）。

您将发现的一些服务账号实际上是 **GCP 在您开始使用服务时自动生成的**，例如：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
然而，也可以创建并附加到资源**自定义服务帐号**，其将如下所示：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **访问范围**

访问范围**附加到生成的 OAuth 令牌**以访问 GCP API 端点。它们**限制了 OAuth 令牌的权限**。\
这意味着如果一个令牌属于资源的所有者，但在令牌范围中没有访问该资源的权限，那么该令牌**无法用于滥用这些权限**。

Google实际上[建议](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions)不使用**访问范围，完全依赖 IAM**。Web 管理门户实际上强制执行了这一点，但可以通过编程方式向实例应用自定义服务帐户的访问范围。

您可以通过**查询**查看**分配的范围**：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

之前的**范围**是使用**`gcloud`**访问数据时**默认**生成的。这是因为当您使用**`gcloud`**时，首先会创建一个OAuth令牌，然后使用它来联系端点。

其中最重要的范围可能是**`cloud-platform`**，基本上意味着可以**访问GCP中的任何服务**。

您可以在[**这里找到**](https://developers.google.com/identity/protocols/googlescopes)**所有可能的范围列表**。

如果您有**`gcloud`**浏览器凭据，可以通过执行类似以下操作来**获取具有其他范围的令牌**：
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Terraform IAM Policies, Bindings and Memberships**

根据terraform在[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)中的定义，使用terraform与GCP时，有不同的方式可以授予主体对资源的访问权限：

- **成员关系**：您可以将**主体设置为角色的成员**，**没有对角色或主体的限制**。您可以将用户设置为角色的成员，然后将组设置为相同角色的成员，并将这些主体（用户和组）设置为其他角色的成员。
- **绑定**：多个**主体可以绑定到一个角色**。这些**主体仍然可以绑定或成为其他角色的成员**。但是，如果一个未绑定到该角色的主体被设置为**绑定角色的成员**，下次**应用绑定时，成员关系将消失**。
- **策略**：策略是**有权威的**，它指示角色和主体，然后，**这些主体不能拥有更多角色，这些角色也不能拥有更多主体**，除非修改该策略（甚至不在其他策略、绑定或成员关系中）。因此，当在策略中指定角色或主体时，所有特权都受到该策略的**限制**。显然，如果主体被授予修改策略或特权升级权限（如创建一个新主体并将其绑定到新角色）的选项，则可以绕过此限制。

## References

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)
