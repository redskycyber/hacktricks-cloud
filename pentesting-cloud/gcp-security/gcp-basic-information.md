# GCP - Informaci√≥n B√°sica

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Jerarqu√≠a de recursos**

Google Cloud utiliza una [Jerarqu√≠a de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo l√≥gico padre/hijo con puntos de conexi√≥n espec√≠ficos para pol√≠ticas y permisos.

A alto nivel, se ve as√≠:

```
Organizaci√≥n
--> Carpetas
  --> Proyectos
    --> Recursos
```

Una m√°quina virtual (llamada Instancia de C√≥mputo) es un recurso. Un recurso reside en un proyecto, probablemente junto con otras Instancias de C√≥mputo, buckets de almacenamiento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **Migraci√≥n de proyectos**

Es posible **migrar un proyecto sin ninguna organizaci√≥n** a una organizaci√≥n con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto est√° dentro de otra organizaci√≥n, es necesario contactar al soporte de GCP para **sacarlos de la organizaci√≥n primero**. Para obtener m√°s informaci√≥n, consulte [**esto**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Pol√≠ticas de organizaci√≥n**

Permiten centralizar el control sobre los recursos en la nube de su organizaci√≥n:

* Centralizar el control para **configurar restricciones** sobre c√≥mo se pueden utilizar los recursos de su organizaci√≥n.
* Definir y establecer **l√≠mites** para que los equipos de desarrollo se mantengan dentro de los l√≠mites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a moverse r√°pidamente sin preocuparse por incumplir el cumplimiento.

Estas pol√≠ticas se pueden crear para **afectar a toda la organizaci√≥n, carpeta(s) o proyecto(s)**. Los descendientes del nodo de jerarqu√≠a de recursos objetivo **heredan la pol√≠tica de la organizaci√≥n**.

Para **definir** una pol√≠tica de organizaci√≥n, **se elige una** [**restricci√≥n**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricci√≥n contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. **Configura esa restricci√≥n con las restricciones deseadas**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar el intercambio de recursos en funci√≥n del dominio.
* Limitar el uso de cuentas de servicio de Identity and Access Management.
* Restringir la ubicaci√≥n f√≠sica de los recursos reci√©n creados.
* Deshabilitar la creaci√≥n de cuentas de servicio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Hay muchas m√°s restricciones que le dan un control detallado de los recursos de su organizaci√≥n. Para **m√°s informaci√≥n, consulte la** [**lista de todas las restricciones del servicio de pol√≠ticas de organizaci√≥n**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

## **Roles de IAM**

Estos son como las pol√≠ticas de IAM en AWS ya que **cada rol contiene un conjunto de permisos**.

Sin embargo, a diferencia de AWS, no hay un **repositorio centralizado** de roles. En lugar de eso, **los recursos dan roles de acceso X a los principales Y**, y la √∫nica forma de saber qui√©n tiene acceso a un recurso es usar el **m√©todo `get-iam-policy` sobre ese recurso**.\
Esto podr√≠a ser un problema porque esto significa que la √∫nica forma de saber **qu√© permisos tiene un principal es preguntar a cada recurso a qui√©n est√° dando permisos**, y un usuario podr√≠a no tener permisos para obtener permisos de todos los recursos.

Hay **tres tipos** de roles en IAM:

* **Roles b√°sicos/primitivos**, que incluyen los roles de **Propietario**, **Editor** y **Espectador** que exist√≠an antes de la introducci√≥n de IAM.
* **Roles predefinidos**, que proporcionan acceso granular para un servicio espec√≠fico y son administrados por Google Cloud. Hay muchos roles predefinidos, puedes **ver todos ellos con los privilegios que tienen** [**aqu√≠**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
### **Alcances de acceso**

Los alcances de acceso est√°n **adjuntos a los tokens OAuth generados** para acceder a los puntos finales de la API de GCP. Estos **restringen los permisos** del token OAuth.\
Esto significa que si un token pertenece a un propietario de un recurso pero no tiene el alcance en el token para acceder a ese recurso, el token **no se puede utilizar para (ab)usar esos privilegios**.

Google, de hecho, [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se utilicen los alcances de acceso y que se dependa totalmente de IAM**. El portal de gesti√≥n web realmente hace cumplir esto, pero los alcances de acceso a√∫n se pueden aplicar a las instancias utilizando cuentas de servicio personalizadas program√°ticamente.

Puede ver qu√© **alcances** est√°n **asignados** **consultando:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
  "issued_to": "223044615559.apps.googleusercontent.com",
  "audience": "223044615559.apps.googleusercontent.com",
  "user_id": "139746512919298469201",
  "scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
  "expires_in": 2253,
  "email": "username@testing.com",
  "verified_email": true,
  "access_type": "offline"
}
```
{% endcode %}

Los **alcances** anteriores son los generados por **defecto** utilizando **`gcloud`** para acceder a los datos. Esto se debe a que cuando se utiliza **`gcloud`** primero se crea un token OAuth y luego se utiliza para contactar con los puntos finales.

El alcance m√°s importante de esos potencialmente es **`cloud-platform`**, lo que b√°sicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puede **encontrar una lista de** [**todos los posibles alcances aqu√≠**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tiene credenciales de navegador **`gcloud`**, es posible **obtener un token con otros alcances,** haciendo algo como:

{% code overflow="wrap" %}
```bash
# Tal vez pueda obtener un token de usuario con otros alcances cambiando la matriz de alcances de ~/.config/gcloud/credentials.db

# Establecer nuevos alcances para las credenciales de SDK
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Imprimir nuevo token
gcloud auth application-default print-access-token

# Para usar este token con alguna API, es posible que necesite usar curl para indicar el encabezado del proyecto con --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Pol√≠ticas de IAM de Terraform, asignaciones y membres√≠as**

Como se define en terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) utilizando terraform con GCP hay diferentes formas de otorgar acceso a un principal sobre un recurso:

* **Membres√≠as**: Establece **principales como miembros de roles** **sin restricciones** sobre el rol o los principales. Puede poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y tambi√©n establecer esos principales (usuario y grupo) como miembros de otros roles.
* **Asignaciones**: Varios **principales pueden estar asignados a un rol**. Esos **principales a√∫n pueden estar asignados o ser miembros de otros roles**. Sin embargo, si se establece un principal que no est√° asignado al rol como **miembro de un rol asignado**, la pr√≥xima vez que se **aplique la asignaci√≥n, la membres√≠a desaparecer√°**.
* **Pol√≠ticas**: Una pol√≠tica es **autoritaria**, indica roles y principales y luego, **esos principales no pueden tener m√°s roles y esos roles no pueden tener m√°s principales** a menos que se modifique esa pol√≠tica (ni siquiera en otras pol√≠ticas, asignaciones o membres√≠as). Por lo tanto, cuando se especifica un rol o principal en una pol√≠tica, todos sus privilegios est√°n **limitados por esa pol√≠tica**. Obviamente, esto se puede evitar en caso de que se le d√© al principal la opci√≥n de modificar la pol√≠tica o los permisos de escalada de privilegios (como crear un nuevo principal y asignarle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>