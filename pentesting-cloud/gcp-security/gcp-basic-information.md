# GCP - 기본 정보

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## **리소스 계층 구조**

Google Cloud는 전통적인 파일 시스템과 개념적으로 유사한 [리소스 계층 구조](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)를 사용합니다. 이는 정책과 권한에 대한 특정 첨부 지점을 가진 논리적인 부모/자식 워크플로우를 제공합니다.

높은 수준에서는 다음과 같습니다:
```
Organization
--> Folders
--> Projects
--> Resources
```
가상 머신(Compute Instance라고도 함)은 리소스입니다. 리소스는 프로젝트에 속해 있으며, 다른 Compute Instance, 스토리지 버킷 등과 함께 있을 수 있습니다.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **프로젝트 이전**

**조직 없이** 프로젝트를 조직으로 이전할 수 있습니다. 이를 위해서는 `roles/resourcemanager.projectCreator` 및 `roles/resourcemanager.projectMover` 권한이 필요합니다. 프로젝트가 다른 조직 내에 있는 경우, 먼저 GCP 지원팀에 문의하여 조직에서 이동시켜야 합니다. 자세한 내용은 [**여기**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)를 참조하세요.

## **조직 정책**

조직의 클라우드 리소스에 대한 중앙 집중식 제어를 가능하게 합니다:

* 조직의 리소스 사용 방법에 대한 **제한을 구성**하는 중앙 집중식 제어
* 개발 팀이 규정 준수 범위 내에서 작업할 수 있도록 **가드레일**을 정의하고 설정
* 규정 준수 위반 걱정 없이 프로젝트 소유자 및 팀이 신속하게 이동할 수 있도록 지원

이러한 정책은 **전체 조직, 폴더 또는 프로젝트에 영향을 줄 수 있습니다**. 대상 리소스 계층 노드의 하위 항목은 조직 정책을 **상속**합니다.

조직 정책을 **정의**하려면 Google Cloud 서비스 또는 Google Cloud 서비스 그룹에 대한 특정 유형의 제한인 [**제약 조건**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)을 선택합니다. 그런 다음 해당 제약 조건을 원하는 제한으로 **구성**합니다.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### 일반적인 사용 사례 <a href="#common_use_cases" id="common_use_cases"></a>

* 도메인을 기반으로 리소스 공유 제한
* Identity and Access Management 서비스 계정 사용 제한
* 새로 생성된 리소스의 물리적 위치 제한
* 서비스 계정 생성 비활성화

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

조직의 리소스에 대한 세밀한 제어를 제공하는 많은 다른 제약 조건이 있습니다. **자세한 내용은** [**조직 정책 서비스 제약 조건 목록**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**을 참조하세요.**

### **기본 조직 정책**

<details>

<summary>GCP 조직을 설정할 때 Google이 기본적으로 추가하는 정책입니다:</summary>

**액세스 관리 정책**

* **도메인 제한된 연락처:** 지정된 도메인 외부의 사용자를 Essential Contacts에 추가하는 것을 방지합니다. 이를 통해 Essential Contacts는 선택한 도메인의 관리되는 사용자 ID만 플랫폼 알림을 받을 수 있도록 제한됩니다.
* **도메인 제한된 공유:** 지정된 도메인 외부의 사용자를 IAM 정책에 추가하는 것을 방지합니다. 이를 통해 IAM 정책은 선택한 도메인의 관리되는 사용자 ID만 이 조직 내의 리소스에 액세스할 수 있도록 제한됩니다.
* **공개 액세스 방지:** Cloud Storage 버킷이 공개에 노출되지 않도록 합니다. 이를 통해 개발자가 Cloud Storage 버킷을 인증되지 않은 인터넷 액세스를 허용하도록 구성할 수 없습니다.
* **일관된 버킷 수준 액세스:** Cloud Storage 버킷의 객체 수준 액세스 제어 목록(ACL)을 방지합니다. 이를 통해 Cloud Storage 버킷의 모든 객체에 일관된 IAM 정책을 적용하여 액세스 관리를 간소화할 수 있습니다.
* **OS 로그인 필요:** 새 프로젝트에서 생성된 가상 머신에는 OS 로그인이 활성화됩니다. 이를 통해 IAM을 사용하여 인스턴스에 대한 SSH 액세스를 관리할 수 있으며 개별 SSH 키를 생성하고 관리할 필요가 없습니다.

**서비스 계정에 대한 추가 보안 정책**

* **자동 IAM 권한 부여 비활성화**: App Engine 및 Compute Engine 기본 서비스 계정이 프로젝트 생성 시 Editor IAM 역할을 자동으로 부여받지 못하도록 방지합니다. 이를 통해 서비스 계정이 생성 시 과도하게 권한이 부여되지 않도록 합니다.
* **서비스 계정 키 생성 비활성화**: 공개 서비스 계정 키의 생성을 방지합니다. 이를 통해 지속적인 자격 증명 노출 위험을 줄일 수 있습니다.
* **서비스 계정 키 업로드 비활성화**: 공개 서비스 계정 키의 업로드를 방지합니다. 이를 통해 키 자료의 유출 또는 재사용 위험을 줄일 수 있습니다.

**보안 VPC 네트워크 구성 정책**

* **VM 인스턴스에 허용된 외부 IP 정의**: 공용 IP가 있는 Compute 인스턴스의 생성을 방지하여 인터넷 트래픽에 노출되지 않도록 합니다.

<!---->

* **VM 중첩 가상화 비활성화**: Compute Engine VM에서 중첩 VM 생성을 방지합니다. 이를 통해 감시되지 않은 중첩 VM의 보안 위험을 줄입니다.

<!---->

* **VM 시리얼 포트 비활성화:** Compute Engine VM에 대한 시리얼 포트 액세스를 방지합니다. 이를 통해 Compute Engine API를 사용하여 서버의 시리얼 포트에 입력되는 것을 방지합니다.

<!---->

* **Cloud SQL 인스턴스의 인가된 네트워크 제한:** 공용 또는 비내부 네트워크 범위가 Cloud SQL 데이터베이스에 액세스하지 못하도록 합니다.

<!---->

* **IP 주소 유형에 따른 프로토콜 포워딩 제한:** 외부 IP 주소에 대한 VM 프로토콜 포워딩을 방지합니다.

<!---->

* **Cloud SQL 인스턴스의 공용 IP 액세스 제한:** 인터넷 트래픽에 노출될 수 있는 공용 IP가 있는 Cloud SQL 인스턴스의 생성을 방지합니다.

<!---->

* **공유 VPC 프로젝트 lien 제한:** 공유 VPC 호스트 프로젝트의 실수로 삭제되는 것을 방지합니다.

<!---->

* **새 프로젝트의 내부 DNS 설정을 Zonal DNS Only로 설정:** 서비스 가용성이 감소된 레거시 DNS 설정 사용을 방지합니다.

<!---->

* **기본 네트워크 생성 건너뛰기:** 기본 VPC 네트워크 및 관련 리소스의 자동 생성을 방지합니다. 이를 통해 과도하게 허용되는 기본 방화벽 규칙을 피할 수 있습니다.

<!---->

* **VPC 외부 IPv6 사용 비활성화:** 외부 IPv6 서브넷의 생성을 방지합니다. 이를 통해 무단 인터넷 액세스에 노출될 수 있는 위험을 줄입니다.

</details>

## **IAM 역할**

각 역할에는 권한 집합
## 사용자 <a href="#default-credentials" id="default-credentials"></a>

**GCP 콘솔**에는 사용자 또는 그룹 관리가 없습니다. 이는 **Google Workspace**에서 수행됩니다. 그러나 Google Workspace에서 다른 신원 제공자를 동기화할 수 있습니다.

Workspaces의 사용자 및 그룹에는 [**https://admin.google.com**](https://admin.google.com/)에서 액세스할 수 있습니다.

**MFA**(다중 인증)는 Workspaces 사용자에게 **강제로 적용**될 수 있지만, **공격자**는 토큰을 사용하여 MFA로 보호되지 않는 GCP에 액세스할 수 있습니다(cli를 통해 액세스할 때만 사용자가 로그인하여 생성할 때 MFA로 보호됨: `gcloud auth login`).

## 그룹

조직이 생성되면 여러 그룹을 **강력히 권장**합니다. 이러한 그룹 중 하나를 관리하면 조직의 모든 또는 중요한 부분을 침해할 수 있습니다:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>그룹</strong></td><td><strong>기능</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(체크리스트에 필요한 그룹 또는 개별 계정)</em></td><td>조직에 속하는 모든 리소스를 관리합니다. 이 역할은 절약적으로 할당하십시오. org 관리자는 Google Cloud 리소스에 대한 액세스 권한이 있습니다. 또는 이 기능은 권한이 매우 높으므로 그룹을 생성하는 대신 개별 계정을 사용하는 것을 고려하십시오.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(체크리스트에 필요함)</em></td><td>네트워크, 서브넷, 방화벽 규칙 및 Cloud Router, Cloud VPN, 클라우드 로드 밸런서와 같은 네트워크 장치를 생성합니다.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(체크리스트에 필요함)</em></td><td>청구 계정 설정 및 사용량 모니터링을 설정합니다.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(체크리스트에 필요함)</em></td><td>응용 프로그램을 설계, 코딩 및 테스트합니다.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>전체 조직에 대한 보안 정책을 수립 및 관리하며, 액세스 관리 및 <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">조직 제약 정책</a>을 포함합니다. Google Cloud 보안 기반 가이드에서 Google Cloud 보안 인프라를 계획하는 데 대한 자세한 내용을 확인하십시오.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>지속적인 통합 및 배포, 모니터링 및 시스템 프로비저닝을 지원하는 end-to-end 파이프라인을 생성 또는 관리합니다.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>프로젝트의 지출을 모니터링합니다. 일반적으로 재무팀의 일부 구성원입니다.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>Google Cloud 조직 전체의 리소스 정보를 검토합니다.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>클라우드 보안을 검토합니다.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>네트워크 구성을 검토합니다.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>감사 로그를 확인합니다.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>보안 명령 센터를 관리합니다.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(더 이상 기본값으로 제공되지 않음)</em></td><td>Secret Manager에서 비밀을 관리합니다.</td></tr></tbody></table>

## **기본 암호 정책**

* 강력한 암호 강제
* 8자에서 100자 사이
* 재사용 금지
* 만료 없음
* 사람들이 제3자 공급자를 통해 Workspace에 액세스하는 경우 이러한 요구 사항은 적용되지 않습니다.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **서비스 계정**

이는 **리소스**가 **연결**되고 GCP와 쉽게 상호 작용할 수 있는 주체입니다. 예를 들어, 메타데이터에 연결된 **VM에 연결된 서비스 계정**의 **인증 토큰**에 액세스할 수 있습니다.\
IAM 및 액세스 범위를 함께 사용할 때 일부 **충돌**이 발생할 수 있습니다. 예를 들어, 서비스 계정에는 `compute.instanceAdmin` IAM 역할이 있을 수 있지만 침투한 인스턴스에는 `https://www.googleapis.com/auth/compute.readonly`의 범위 제한이 적용되어 있을 수 있습니다. 이로 인해 자동으로 할당된 OAuth 토큰을 사용하여 변경 사항을 수행할 수 없습니다.

이는 AWS의 IAM 역할과 유사합니다. 그러나 AWS와 달리 **어떤** 서비스 계정이 **어떤 서비스에도 연결**될 수 있습니다(정책을 통해 허용할 필요가 없음).

찾을 수 있는 서비스 계정 중 일부는 실제로 GCP를 사용하기 시작할 때 **자동으로 생성**되는 것입니다. 예를 들어:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
그러나 **사용자 정의 서비스 계정**을 생성하고 연결하는 것도 가능합니다. 이는 다음과 같이 표시됩니다:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **액세스 범위**

액세스 범위는 GCP API 엔드포인트에 액세스하기 위해 생성된 OAuth 토큰에 **부여된다**. 이들은 OAuth 토큰의 권한을 **제한**한다.\
이것은 토큰이 리소스의 소유자에게 속하지만 해당 리소스에 액세스할 수 있는 토큰 범위가 없는 경우, 토큰은 그 권한을 **(남용하여) 사용할 수 없다**는 것을 의미한다.

Google은 실제로 [권장](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions)으로 **액세스 범위를 사용하지 않고 완전히 IAM에 의존**할 것을 권장한다. 웹 관리 포털은 실제로 이를 강제하지만, 액세스 범위는 여전히 사용자 정의 서비스 계정을 사용하여 인스턴스에 적용할 수 있다.

다음을 **쿼리하여** 어떤 **범위**가 **할당**되었는지 볼 수 있다:

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

이전의 **scopes**는 **`gcloud`**를 사용하여 데이터에 액세스하기 위해 **기본적으로 생성**되는 것입니다. 이는 **`gcloud`**를 사용할 때 OAuth 토큰을 먼저 생성한 다음 해당 토큰을 사용하여 엔드포인트에 연락하는 방식입니다.

가장 중요한 scope 중 하나는 **`cloud-platform`**입니다. 이 scope은 기본적으로 **GCP의 모든 서비스에 액세스할 수 있다는 것을 의미**합니다.

[**여기에서 가능한 모든 scopes의 목록을 찾을 수 있습니다**](https://developers.google.com/identity/protocols/googlescopes)**.**

**`gcloud`** 브라우저 자격 증명이 있는 경우, 다른 scopes로 토큰을 **얻을 수 있습니다**. 다음과 같이 수행할 수 있습니다:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM 정책, 바인딩 및 멤버십**

Terraform에서는 [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)에서 정의된대로 GCP와 함께 Terraform을 사용하여 리소스에 대한 주체에게 액세스 권한을 부여하는 다양한 방법이 있습니다:

* **멤버십**: 역할 또는 주체에 대한 **제한 없이 주체를 멤버로 설정**합니다. 사용자를 역할의 멤버로 설정한 다음 동일한 역할의 멤버로 그룹을 설정하고 해당 주체(사용자 및 그룹)를 다른 역할의 멤버로 설정할 수 있습니다.
* **바인딩**: 여러 **주체를 역할에 바인딩**할 수 있습니다. 이러한 **주체는 여전히 다른 역할에 바인딩되거나 멤버가 될 수 있습니다**. 그러나 역할에 바인딩되지 않은 주체가 바인딩된 역할의 멤버로 설정되면 **바인딩이 적용될 때 멤버십이 사라집니다**.
* **정책**: 정책은 **권한이 있는** 역할과 주체를 나타냅니다. 그런 다음, **해당 주체는 더 많은 역할을 가질 수 없으며 해당 역할은 더 많은 주체를 가질 수 없습니다**. 정책이 수정되지 않는 한 (다른 정책, 바인딩 또는 멤버십에서도) 역할이나 주체가 정책에 지정된 경우 해당 권한은 **해당 정책에 의해 제한됩니다**. 물론, 주체가 정책을 수정하거나 권한 상승 권한(새 주체를 생성하고 새 역할을 바인딩하는 등)을 부여받을 수 있는 경우 이를 우회할 수 있습니다.

## 참고 자료

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
