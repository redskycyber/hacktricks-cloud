# GCP - Informaci칩n B치sica

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Jerarqu칤a de recursos**

Google Cloud utiliza una [Jerarqu칤a de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo l칩gico de padre/hijo con puntos de conexi칩n espec칤ficos para pol칤ticas y permisos.

A un alto nivel, se ve as칤:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una m치quina virtual (llamada una Instancia de C칩mputo) es un recurso. Un recurso reside en un proyecto, probablemente junto con otras Instancias de C칩mputo, buckets de almacenamiento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migraci칩n de Proyectos**

Es posible **migrar un proyecto sin ninguna organizaci칩n** a una organizaci칩n con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto est치 dentro de otra organizaci칩n, es necesario contactar al soporte de GCP para **moverlos fuera de la organizaci칩n primero**. Para m치s informaci칩n, consulta [**este enlace**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Pol칤ticas de Organizaci칩n**

Permiten centralizar el control sobre los recursos en la nube de tu organizaci칩n:

* Centralizar el control para **configurar restricciones** sobre c칩mo pueden ser utilizados los recursos de tu organizaci칩n.
* Definir y establecer **l칤mites** para que los equipos de desarrollo se mantengan dentro de los l칤mites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a moverse r치pidamente sin preocuparse por incumplir el cumplimiento.

Estas pol칤ticas pueden ser creadas para **afectar a toda la organizaci칩n, carpeta(s) o proyecto(s)**. Los descendientes del nodo de jerarqu칤a de recursos objetivo **heredan la pol칤tica de la organizaci칩n**.

Para **definir** una pol칤tica de organizaci칩n, **eliges una** [**restricci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricci칩n contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. **Configuras esa restricci칩n con las restricciones deseadas**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar el intercambio de recursos basado en dominio.
* Limitar el uso de cuentas de servicio de Identidad y Acceso.
* Restringir la ubicaci칩n f칤sica de los recursos reci칠n creados.
* Deshabilitar la creaci칩n de cuentas de servicio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Existen muchas m치s restricciones que te brindan un control detallado de los recursos de tu organizaci칩n. Para **m치s informaci칩n, consulta la** [**lista de todas las restricciones del Servicio de Pol칤ticas de Organizaci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Pol칤ticas de Organizaci칩n Predeterminadas**

<details>

<summary>Estas son las pol칤ticas que Google agregar치 por defecto al configurar tu organizaci칩n de GCP:</summary>

**Pol칤ticas de Gesti칩n de Acceso**

* **Contactos restringidos por dominio:** Evita agregar usuarios a Contactos Esenciales fuera de los dominios especificados. Esto limita los Contactos Esenciales para permitir solo identidades de usuario administradas en tus dominios seleccionados para recibir notificaciones de la plataforma.
* **Compartir restringido por dominio:** Evita agregar usuarios a pol칤ticas de IAM fuera de los dominios especificados. Esto limita las pol칤ticas de IAM para permitir solo identidades de usuario administradas en tus dominios seleccionados para acceder a recursos dentro de esta organizaci칩n.
* **Prevenci칩n de acceso p칰blico:** Evita que los buckets de Cloud Storage sean expuestos al p칰blico. Esto asegura que un desarrollador no pueda configurar los buckets de Cloud Storage para tener acceso a internet no autenticado.
* **Acceso uniforme a nivel de bucket:** Evita las listas de control de acceso (ACL) a nivel de objeto en los buckets de Cloud Storage. Esto simplifica la gesti칩n de acceso al aplicar pol칤ticas de IAM de manera consistente en todos los objetos en los buckets de Cloud Storage.
* **Requerir inicio de sesi칩n en el SO:** Las VMs creadas en nuevos proyectos tendr치n el inicio de sesi칩n en el SO habilitado. Esto te permite gestionar el acceso SSH a tus instancias utilizando IAM sin necesidad de crear y gestionar claves SSH individuales.

**Pol칤ticas de seguridad adicionales para cuentas de servicio**

* **Deshabilitar concesiones autom치ticas de IAM**: Evita que las cuentas de servicio predeterminadas de App Engine y Compute Engine reciban autom치ticamente el rol Editor IAM en un proyecto al crearse. Esto asegura que las cuentas de servicio no reciban roles IAM excesivamente permisivos al crearse.
* **Deshabilitar la creaci칩n de claves de cuenta de servicio**: Evita la creaci칩n de claves de cuenta de servicio p칰blicas. Esto ayuda a reducir el riesgo de exponer credenciales persistentes.
* **Deshabilitar la carga de claves de cuenta de servicio**: Evita la carga de claves de cuenta de servicio p칰blicas. Esto ayuda a reducir el riesgo de material de clave filtrado o reutilizado.

**Pol칤ticas de configuraci칩n de red VPC segura**

* **Definir IPs externas permitidas para instancias de VM**: Evita la creaci칩n de instancias de C칩mputo con una IP p칰blica, lo que las expone al tr치fico de internet.

<!---->

* **Deshabilitar la virtualizaci칩n anidada de VM**: Evita la creaci칩n de VM anidadas en VMs de Compute Engine. Esto disminuye el riesgo de seguridad de tener VMs anidadas no monitoreadas.

<!---->

* **Deshabilitar el puerto serie de VM**: Evita el acceso al puerto serie en las VMs de Compute Engine. Esto evita la entrada a un puerto serie del servidor utilizando la API de Compute Engine.

<!---->

* **Restringir redes autorizadas en instancias de Cloud SQL**: Evita que los rangos de red p칰blicos o no internos accedan a tus bases de datos de Cloud SQL.

<!---->

* **Restringir el reenv칤o de protocolo basado en el tipo de direcci칩n IP**: Evita el reenv칤o de protocolo de VM para direcciones IP externas.

<!---->

* **Restringir el acceso por IP p칰blico en instancias de Cloud SQL**: Evita la creaci칩n de instancias de Cloud SQL con una IP p칰blica, lo que las expone al tr치fico de internet.

<!---->

* **Restringir la eliminaci칩n de lienzo de proyecto VPC compartido**: Evita la eliminaci칩n accidental de proyectos host de VPC compartidos.

<!---->

* **Establece la configuraci칩n de DNS interno para nuevos proyectos a DNS Zonal 칔nicamente**: Evita el uso de una configuraci칩n de DNS heredada que reduce la disponibilidad del servicio.

<!---->

* **Omitir la creaci칩n de red predeterminada**: Evita la creaci칩n autom치tica de la red VPC predeterminada y los recursos relacionados. Esto evita reglas de firewall predeterminadas excesivamente permisivas.

<!---->

* **Deshabilitar el uso de IPv6 externo en VPC**: Evita la creaci칩n de subredes IPv6 externas, que pueden exponerse a accesos no autorizados desde internet.

</details>

## **Roles de IAM**

Estos son como las pol칤ticas de IAM en AWS ya que **cada rol contiene un conjunto de permisos**.

Sin embargo, a diferencia de AWS, no hay un repositorio centralizado de roles. En lugar de eso, **los recursos otorgan roles de acceso X a principios Y**, y la 칰nica forma de averiguar qui칠n tiene acceso a un recurso es utilizar el **m칠todo `get-iam-policy` sobre ese recurso**.\
Esto podr칤a ser un problema porque esto significa que la 칰nica forma de averiguar **qu칠 permisos tiene un principio es preguntar a cada recurso a qui칠n est치 otorgando permisos**, y un usuario podr칤a no tener permisos para obtener permisos de todos los recursos.

Hay **tres tipos** de roles en IAM:

* **Roles B치sicos/Primitivos**, que incluyen los roles **Propietario**, **Editor** y **Visualizador** que exist칤an antes de la introducci칩n de IAM.
* **Roles Predefinidos**, que proporcionan acceso detallado para un servicio espec칤fico y son gestionados por Google Cloud. Hay muchos roles predefinidos, puedes **ver todos ellos con los privilegios que tienen** [**aqu칤**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Roles Personalizados**, que proporcionan acceso detallado de acuerdo a una lista de permisos especificada por el usuario.

Hay miles de permisos en GCP. Para verificar si un rol tiene un permiso puedes [**buscar el permiso aqu칤**](https://cloud.google.com/iam/docs/permissions-reference) y ver qu칠 roles lo tienen.

Tambi칠n puedes [**buscar aqu칤 roles predefinidos**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **ofrecidos por cada producto.** Ten en cuenta que algunos **roles** no pueden ser asignados a usuarios y **solo a cuentas de servicio debido a algunos permisos** que contienen.\
Adem치s, ten en cuenta que los **permisos** solo **tendr치n efecto** si est치n **asignados al servicio relevante**.

O verifica si un **rol personalizado puede usar un** [**permiso espec칤fico aqu칤**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Usuarios <a href="#default-credentials" id="default-credentials"></a>

En la **consola de GCP** no hay **gesti칩n de Usuarios o Grupos**, eso se hace en **Google Workspace**. Aunque podr칤as sincronizar un proveedor de identidad diferente en Google Workspace.

Puedes acceder a los **usuarios y grupos de Workspaces en** [**https://admin.google.com**](https://admin.google.com/).

Se puede **forzar la MFA** a los usuarios de Workspaces, sin embargo, un **atacante** podr칤a usar un token para acceder a GCP **a trav칠s de la CLI que no estar치 protegida por MFA** (estar치 protegida por MFA solo cuando el usuario inicie sesi칩n para generarlo: `gcloud auth login`).

## Grupos

Cuando se crea una organizaci칩n, se sugiere fuertemente crear varios grupos. Si administras alguno de ellos, podr칤as comprometer toda o una parte importante de la organizaci칩n:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Funci칩n</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupo o cuentas individuales requeridas para la lista de verificaci칩n)</em></td><td>Administrar cualquier recurso que pertenezca a la organizaci칩n. Asigna este rol con moderaci칩n; los administradores de la organizaci칩n tienen acceso a todos tus recursos de Google Cloud. Alternativamente, debido a que esta funci칩n es altamente privilegiada, considera usar cuentas individuales en lugar de crear un grupo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Crear redes, subredes, reglas de firewall y dispositivos de red como Cloud Router, Cloud VPN y balanceadores de carga en la nube.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Configurar cuentas de facturaci칩n y monitorear su uso.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Dise침ar, codificar y probar aplicaciones.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Establecer y gestionar pol칤ticas de seguridad para toda la organizaci칩n, incluido el manejo de acceso y <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">pol칤ticas de restricci칩n de organizaci칩n</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">gu칤a de fundamentos de seguridad de Google Cloud</a> para obtener m치s informaci칩n sobre la planificaci칩n de la infraestructura de seguridad de Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Crear o gestionar flujos de trabajo de extremo a extremo que admitan la integraci칩n y entrega continua, monitoreo y aprovisionamiento de sistemas.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Monitorear el gasto en proyectos. Los miembros t칤picos son parte del equipo financiero.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar informaci칩n de recursos en toda la organizaci칩n de Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar la seguridad en la nube.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar configuraciones de red.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Ver registros de auditor칤a.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Administrar Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Gestionar secretos en Secret Manager.</td></tr></tbody></table>

## **Pol칤tica de Contrase침a Predeterminada**

* Aplicar contrase침as seguras
* Entre 8 y 100 caracteres
* Sin reutilizaci칩n
* Sin expiraci칩n
* Si las personas acceden a Workspace a trav칠s de un proveedor de terceros, estos requisitos no se aplican.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Cuentas de Servicio**

Estos son los principios a los que **los recursos pueden tener adjuntos** y acceder para interactuar f치cilmente con GCP. Por ejemplo, es posible acceder al **token de autenticaci칩n** de una Cuenta de Servicio **adjunta a una VM** en los metadatos.\
Es posible encontrar algunos **conflictos** al usar tanto **IAM como alcances de acceso**. Por ejemplo, tu cuenta de servicio puede tener el rol IAM de `compute.instanceAdmin` pero la instancia a la que has accedido ha sido limitada con la limitaci칩n de alcance de `https://www.googleapis.com/auth/compute.readonly`. Esto te impedir칤a realizar cambios utilizando el token OAuth que se asigna autom치ticamente a tu instancia.

Es similar a los **roles de IAM de AWS**. Pero a diferencia de AWS, **cualquier** cuenta de servicio puede ser **adjuntada a cualquier servicio** (no necesita permitirlo a trav칠s de una pol칤tica).

Varias de las cuentas de servicio que encontrar치s son en realidad **generadas autom치ticamente por GCP** cuando comienzas a usar un servicio, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Sin embargo, tambi칠n es posible crear y adjuntar a los recursos **cuentas de servicio personalizadas**, que se ver치n as칤:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Alcances de acceso**

Los alcances de acceso est치n **adjuntos a los tokens OAuth generados** para acceder a los puntos finales de la API de GCP. Estos **restringen los permisos** del token OAuth.\
Esto significa que si un token pertenece a un Propietario de un recurso pero no tiene en el alcance del token el acceso a ese recurso, el token **no se puede utilizar para (ab)usar esos privilegios**.

Google realmente [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se utilicen alcances de acceso y se conf칤e totalmente en IAM**. El portal de gesti칩n web realmente hace cumplir esto, pero los alcances de acceso a칰n se pueden aplicar a instancias utilizando cuentas de servicio personalizadas de forma program치tica.

Puedes ver qu칠 **alcances** est치n **asignados** mediante **consulta:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Los **alcances** anteriores son los generados por **defecto** al usar **`gcloud`** para acceder a los datos. Esto se debe a que al usar **`gcloud`** primero se crea un token de OAuth y luego se utiliza para contactar los puntos finales.

El alcance m치s importante de esos potencialmente es **`cloud-platform`**, lo que b치sicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puedes **encontrar una lista de** [**todos los alcances posibles aqu칤**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tienes credenciales de navegador de **`gcloud`**, es posible **obtener un token con otros alcances**, haciendo algo como:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Pol칤ticas IAM de Terraform, V칤nculos y Miembros**

Seg칰n lo define terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) al usar terraform con GCP, existen diferentes formas de otorgar acceso a un principal sobre un recurso:

* **Miembros**: Se establecen **principales como miembros de roles** **sin restricciones** sobre el rol o los principales. Puedes poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y tambi칠n establecer esos principales (usuario y grupo) como miembros de otros roles.
* **V칤nculos**: Varios **principales pueden estar vinculados a un rol**. Esos **principales a칰n pueden estar vinculados o ser miembros de otros roles**. Sin embargo, si un principal que no est치 vinculado al rol es establecido como **miembro de un rol vinculado**, la pr칩xima vez que se aplique el **v칤nculo, la membres칤a desaparecer치**.
* **Pol칤ticas**: Una pol칤tica es **autoritaria**, indica roles y principales y luego, **esos principales no pueden tener m치s roles y esos roles no pueden tener m치s principales** a menos que se modifique esa pol칤tica (ni siquiera en otras pol칤ticas, v칤nculos o miembros). Por lo tanto, cuando se especifica un rol o principal en una pol칤tica, todos sus privilegios est치n **limitados por esa pol칤tica**. Obviamente, esto se puede evadir en caso de que al principal se le d칠 la opci칩n de modificar la pol칤tica o permisos de escalada de privilegios (como crear un nuevo principal y vincularle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
