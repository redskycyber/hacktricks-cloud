# GCP - Osnovne informacije

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Hierarhija resursa**

Google Cloud koristi [Hierarhiju resursa](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) koja je konceptualno sli캜na tradicionalnom sistemskom fajl sistemu. Ovo pru쬬 logi캜an roditelj/dete radni tok sa specifi캜nim ta캜kama za pravila i dozvole.

Na visokom nivou, izgleda ovako:
```
Organization
--> Folders
--> Projects
--> Resources
```
Virtualna ma코ina (nazvana Compute Instance) je resurs. Resurs se nalazi u projektu, verovatno zajedno sa drugim Compute Instancama, skladi코nim kantama itd.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migracija projekata**

Mogu캖e je **migrirati projekat bez organizacije** u organizaciju sa dozvolama `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Ako je projekat unutar druge organizacije, potrebno je kontaktirati GCP podr코ku da ih **premesti iz organizacije prvo**. Za vi코e informacija pogledajte [**ovde**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politike organizacije**

Omogu캖avaju centralizovanu kontrolu nad resursima oblaka va코e organizacije:

* Centralizovana kontrola za **konfigurisanje ograni캜enja** o tome kako se mogu koristiti resursi va코e organizacije.
* Definisanje i uspostavljanje **ograni캜enja** za timove za razvoj kako bi ostali unutar granica usagla코enosti.
* Poma쬰 vlasnicima projekata i njihovim timovima da se brzo kre캖u bez brige o kr코enju usagla코enosti.

Ove politike mogu biti kreirane da **uti캜u na celu organizaciju, folder(e) ili projekat(e)**. Potomci ciljanog 캜vora hijerarhije resursa **nasle캠uju politiku organizacije**.

Da biste **definisali** politiku organizacije, **birate** [**ograni캜enje**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), koje je odre캠eni tip ograni캜enja protiv odre캠ene Google Cloud usluge ili grupe Google Cloud usluga. **Konfiguri코ete to ograni캜enje sa 쬰ljenim ograni캜enjima**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Uobi캜ajene upotrebe <a href="#common_use_cases" id="common_use_cases"></a>

* Ograni캜avanje deljenja resursa na osnovu domena.
* Ograni캜avanje upotrebe servisnih naloga za identitet i pristup.
* Ograni캜avanje fizi캜ke lokacije novostvorenih resursa.
* Onemogu캖avanje kreiranja servisnih naloga.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Postoji jo코 mnogo ograni캜enja koja vam pru쬬ju detaljnu kontrolu nad resursima va코e organizacije. Za **vi코e informacija pogledajte** [**listu svih ograni캜enja usluge Politika organizacije**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Podrazumevane politike organizacije**

<details>

<summary>Ovo su politike koje 캖e Google automatski dodati prilikom pode코avanja va코e GCP organizacije:</summary>

**Politike upravljanja pristupom**

* **Kontakti sa ograni캜enim domenom:** Onemogu캖ava dodavanje korisnika Essential Contacts izvan va코ih odabranih domena. Ovo ograni캜ava Essential Contacts da dozvoli samo upravljanim korisni캜kim identitetima u va코im odabranim domenima da primaju obave코tenja platforme.
* **Deljenje sa ograni캜enim domenom:** Onemogu캖ava dodavanje korisnika u IAM politike izvan va코ih odabranih domena. Ovo ograni캜ava IAM politike da dozvoli samo upravljanim korisni캜kim identitetima u va코im odabranim domenima pristup resursima unutar ove organizacije.
* **Prevencija javnog pristupa:** Onemogu캖ava izlaganje kanti za Cloud Storage javnosti. Ovo osigurava da programer ne mo쬰 konfigurisati kante za Cloud Storage da imaju neautentifikovan pristup internetu.
* **Jedinstven pristup nivou kante:** Onemogu캖ava liste za kontrolu pristupa na nivou objekta (ACL) u kantama za Cloud Storage. Ovo pojednostavljuje upravljanje pristupom primenom IAM politika dosledno na sve objekte u kantama za Cloud Storage.
* **Zahtevaj prijavu na OS:** VM-ovi kreirani u novim projektima 캖e imati omogu캖enu prijavu na OS. Ovo vam omogu캖ava da upravljate SSH pristupom va코im instancama koriste캖i IAM, bez potrebe za kreiranjem i upravljanjem pojedina캜nim SSH klju캜evima.

**Dodatne bezbednosne politike za servisne naloge**

* **Onemogu캖i automatske IAM dozvole**: Onemogu캖ava podrazumevane App Engine i Compute Engine servisne naloge da automatski dobiju Editor IAM ulogu na projektu prilikom kreiranja. Ovo osigurava da servisni nalozi ne dobijaju prekomerne IAM uloge prilikom kreiranja.
* **Onemogu캖i kreiranje klju캜eva servisnih naloga**: Onemogu캖ava kreiranje javnih klju캜eva servisnih naloga. Ovo poma쬰 u smanjenju rizika od izlaganja trajnih akreditiva.
* **Onemogu캖i otpremanje klju캜eva servisnih naloga**: Onemogu캖ava otpremanje javnih klju캜eva servisnih naloga. Ovo poma쬰 u smanjenju rizika od curenja ili ponovne upotrebe klju캜nih materijala.

**Politike konfiguracije bezbedne VPC mre쬰**

* **Defini코i dozvoljene spoljne IP adrese za VM instance**: Onemogu캖ava kreiranje Compute instanci sa javnom IP adresom, 코to ih mo쬰 izlo쬴ti internet saobra캖aju.

<!---->

* **Onemogu캖i ugnje쮃녀vanje VM virtuelizacije**: Onemogu캖ava kreiranje ugnje쮃년nih VM-ova na Compute Engine VM-ovima. Ovo smanjuje sigurnosni rizik od prisustva nepra캖enih ugnje쮃년nih VM-ova.

<!---->

* **Onemogu캖i serijski port VM-a:** Onemogu캖ava pristup serijskom portu Compute Engine VM-ovima. Ovo spre캜ava unos na serijski port servera kori코캖enjem Compute Engine API-ja.

<!---->

* **Ograni캜i ovla코캖ene mre쬰 na Cloud SQL instancama:** Onemogu캖ava javne ili neinternetske mre쬹e opsege da pristupe va코im Cloud SQL bazama podataka.

<!---->

* **Ograni캜i prosle캠ivanje protokola na osnovu vrste IP adrese:** Onemogu캖ava prosle캠ivanje protokola VM-ova za spoljne IP adrese.

<!---->

* **Ograni캜i pristup javnim IP adresama na Cloud SQL instancama:** Onemogu캖ava kreiranje Cloud SQL instanci sa javnom IP adresom, 코to ih mo쬰 izlo쬴ti internet saobra캖aju.

<!---->

* **Ograni캜i uklanjanje liena deljenog VPC projekta:** Onemogu캖ava slu캜ajno brisanje host projekata deljenog VPC-a.

<!---->

* **Postavi internu DNS postavku za nove projekte samo na Zonal DNS:** Onemogu캖ava upotrebu zastarele DNS postavke koja ima smanjenu dostupnost usluge.

<!---->

* **Presko캜i automatsko kreiranje podrazumevane mre쬰:** Onemogu캖ava automatsko kreiranje podrazumevane VPC mre쬰 i pripadaju캖ih resursa. Ovo izbegava prekomerno dozvoljena podrazumevana pravila za코tite od po쬬ra.

<!---->

* **Onemogu캖i upotrebu VPC spoljnih IPv6 adresa:** Onemogu캖ava kreiranje spoljnih IPv6 podmre쬬, koje mogu biti izlo쬰ne neovla코캖enom pristupu internetu.

</details>

## **IAM Uloge**

Ove uloge su sli캜ne IAM politikama u AWS-u jer **svaka uloga sadr쬴 skup dozvola**.

Me캠utim, za razliku od AWS-a, ne postoji **centralizovani repozitorijum** uloga. Umesto toga, **resursi dodeljuju uloge pristupu
## Korisnici <a href="#default-credentials" id="default-credentials"></a>

U **GCP konzoli** nema upravljanja **korisnicima ili grupama**, to se radi u **Google Workspace-u**. Me캠utim, mo쬰te sinhronizovati drugog pru쬬oca identiteta u Google Workspace-u.

Korisnici i grupe Workspace-a mogu se pristupiti na [https://admin.google.com](https://admin.google.com).

**MFA** se mo쬰 **obavezati** korisnicima Workspace-a, me캠utim, **napada캜** mo쬰 koristiti token za pristup GCP **putem CLI-a koji ne캖e biti za코ti캖en MFA-om** (bi캖e za코ti캖en MFA-om samo kada korisnik se prijavi da ga generi코e: `gcloud auth login`).

## Grupe

Kada se organizacija kreira, preporu캜uje se kreiranje nekoliko grupa. Ako upravljate bilo kojom od njih, mo쬰te kompromitovati celu ili va쬬n deo organizacije:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcija</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupa ili pojedina캜ni nalozi potrebni za proveru)</em></td><td>Upravljanje svim resursima koji pripadaju organizaciji. Ovu ulogu dodeljujte pa쬷jivo; administratori organizacije imaju pristup svim va코im Google Cloud resursima. Alternativno, zbog visokih privilegija ove funkcije, razmislite o kori코캖enju pojedina캜nih naloga umesto kreiranja grupe.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Kreiranje mre쬬, podmre쬬, pravila za za코titni zid i mre쬹ih ure캠aja kao 코to su Cloud Router, Cloud VPN i cloud load balanceri.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Pode코avanje ra캜una za naplatu i pra캖enje njihove upotrebe.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(potrebno za proveru)</em></td><td>Dizajniranje, kodiranje i testiranje aplikacija.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Ustanovljavanje i upravljanje sigurnosnim politikama za celu organizaciju, uklju캜uju캖i upravljanje pristupom i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">ograni캜enjima organizacije</a>. Pogledajte <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">vodi캜 za osnove sigurnosti Google Cloud-a</a> za vi코e informacija o planiranju infrastrukture sigurnosti Google Cloud-a.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Kreiranje ili upravljanje celokupnim tokovima rada koji podr쬬vaju kontinuiranu integraciju i isporuku, nadgledanje i obezbe캠ivanje sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Pra캖enje tro코kova projekata. Tipi캜ni 캜lanovi su deo finansijskog tima.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Pregled informacija o resursima u celoj organizaciji Google Cloud-a.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Pregledavanje sigurnosti u oblaku.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Pregledavanje konfiguracija mre쬰.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Pregledavanje evidencija audita.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Upravljanje Security Command Center-om.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(vi코e nije podrazumevano)</em></td><td>Upravljanje tajnama u Secret Manager-u.</td></tr></tbody></table>

## **Podrazumevana politika lozinki**

* Zahtevajte jake lozinke
* Izme캠u 8 i 100 karaktera
* Bez ponovne upotrebe
* Bez isteka
* Ako ljudi pristupaju Workspace-u putem provajdera tre캖e strane, ovi zahtevi se ne primenjuju.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Servisni nalozi**

Ovo su principali koji mogu biti **pridru쬰ni** **resursima** i omogu캖avaju im jednostavan pristup i interakciju sa GCP-om. Na primer, mogu캖e je pristupiti **autenti캜nom tokenu** servisnog naloga **pridru쬰nog virtuelnoj ma코ini** u metapodacima.\
Mogu캖e je nai캖i na **sukobe** prilikom kori코캖enja IAM uloga i opsega pristupa. Na primer, va코 servisni nalog mo쬰 imati IAM ulogu `compute.instanceAdmin`, ali instanca koju ste prekr코ili ima ograni캜enje opsega `https://www.googleapis.com/auth/compute.readonly`. To bi vam onemogu캖ilo da vr코ite bilo kakve promene koriste캖i OAuth token koji je automatski dodeljen va코oj instanci.

Sli캜no je IAM ulogama u AWS-u. Ali, za razliku od AWS-a, **bilo koji** servisni nalog mo쬰 biti **pridru쬰n bilo kojoj usluzi** (ne mora biti dozvoljeno putem politike).

Neki od servisnih naloga koje 캖ete prona캖i su zapravo **automatski generisani od strane GCP-a** kada po캜nete koristiti uslugu, kao 코to su:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Me캠utim, tako캠e je mogu캖e kreirati i povezati **prilago캠ene servisne naloge** sa resursima, koji 캖e izgledati ovako:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Pristupni opsezi**

Pristupni opsezi su **dodijeljeni OAuth tokenima** kako bi se pristupilo GCP API endpointima. Oni **ograni캜avaju dozvole** OAuth tokena.\
To zna캜i da ako token pripada vlasniku resursa, ali nema pristupni opseg za pristup tom resursu, token **ne mo쬰 se koristiti za zloupotrebu tih privilegija**.

Google zapravo [preporu캜uje](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) da se **ne koriste pristupni opsezi i da se potpuno oslanjaju na IAM**. Web upravlja캜ka plo캜a zapravo to provodi, ali pristupni opsezi se i dalje mogu primijeniti na instance koriste캖i prilago캠ene servisne ra캜une programski.

Mo쬰te vidjeti koje **opsege** su **dodijeljeni** tako da **upitate:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Prethodni **opsezi** su generisani **podrazumevano** kori코캖enjem **`gcloud`** za pristup podacima. To je zato 코to kada koristite **`gcloud`** prvo kreirate OAuth token, a zatim ga koristite za kontaktiranje krajnjih ta캜aka.

Najva쬹iji opseg od tih potencijalno je **`cloud-platform`**, 코to u osnovi zna캜i da je mogu캖e **pristupiti bilo kojoj usluzi u GCP**.

Mo쬰te **prona캖i listu** [**svih mogu캖ih opsega ovde**](https://developers.google.com/identity/protocols/googlescopes)**.**

Ako imate **gcloud** kredencijale za pretra쬴va캜, mogu캖e je **dobiti token sa drugim opsezima**, tako 코to 캖ete uraditi ne코to kao:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM politike, veze i 캜lanstva**

Kako je definisano od strane terraforma u [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), kori코캖enjem terraforma sa GCP postoje razli캜iti na캜ini da se dodeli pristup principalu nad resursom:

* **캛lanstva**: Postavljate **principale kao 캜lanove uloga** **bez ograni캜enja** nad ulogom ili principale. Mo쬰te postaviti korisnika kao 캜lana uloge, a zatim postaviti grupu kao 캜lana iste uloge i tako캠e postaviti te principe (korisnika i grupu) kao 캜lanove drugih uloga.
* **Veze**: Vi코e **principala mo쬰 biti vezano za ulogu**. Ti **principali i dalje mogu biti vezani ili biti 캜lanovi drugih uloga**. Me캠utim, ako se princip koji nije vezan za ulogu postavi kao **캜lan vezane uloge**, slede캖i put kada se **veza primeni, 캜lanstvo 캖e nestati**.
* **Politike**: Politika je **autoritativna**, ona defini코e uloge i principe, a zatim, **ti principi ne mogu imati vi코e uloga, a te uloge ne mogu imati vi코e principala** osim ako se ta politika ne izmeni (캜ak ni u drugim politikama, vezama ili 캜lanstvima). Dakle, kada se uloga ili princip navedu u politici, sva njihova ovla코캖enja su **ograni캜ena tom politikom**. O캜igledno, ovo se mo쬰 zaobi캖i ako se principu omogu캖i izmena politike ili privilegije eskalacije (kao 코to je kreiranje novog principa i vezivanje mu nove uloge).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
