# GCP - Podstawowe informacje

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Hierarchia zasob贸w**

Google Cloud u偶ywa [hierarchii zasob贸w](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy), kt贸ra jest podobna, koncepcyjnie, do tradycyjnego systemu plik贸w. Zapewnia to logiczny przepyw rodzic/dziecko z okrelonymi punktami doczania polityk i uprawnie.

Na wysokim poziomie wyglda to tak:
```
Organization
--> Folders
--> Projects
--> Resources
```
Maszyna wirtualna (zwana instancj obliczeniow) to zas贸b. Zas贸b znajduje si w projekcie, prawdopodobnie obok innych instancji obliczeniowych, kubek贸w przechowywania itp.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migracja projekt贸w**

Mo偶liwa jest **migracja projektu bez 偶adnej organizacji** do organizacji z uprawnieniami `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Jeli projekt znajduje si w innej organizacji, nale偶y skontaktowa si z pomoc techniczn GCP, aby **przenie go z organizacji**. Wicej informacji mo偶na znale藕 [**tutaj**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Zasady organizacji**

Pozwalaj na scentralizowan kontrol nad zasobami chmurowymi Twojej organizacji:

* Skonfiguruj **ograniczenia** dotyczce sposobu korzystania z zasob贸w Twojej organizacji.
* Zdefiniuj i ustan贸w **ogrodzenia** dla zespo贸w deweloperskich, aby pozostay w granicach zgodnoci.
* Pom贸偶 wacicielom projekt贸w i ich zespoom dziaa szybko, nie martwic si o naruszenie zgodnoci.

Te zasady mog by tworzone, aby **dotyczy caej organizacji, folder贸w lub projekt贸w**. Potomkowie docelowego wza hierarchii zasob贸w **dziedzicz zasady organizacji**.

Aby **zdefiniowa** zasad organizacji, **wybierasz** [**ograniczenie**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), kt贸re jest okrelonym rodzajem ograniczenia dotyczcego usugi Google Cloud lub grupy usug Google Cloud. Nastpnie **konfigurujesz to ograniczenie z wymaganymi ograniczeniami**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Typowe przypadki u偶ycia <a href="#common_use_cases" id="common_use_cases"></a>

* Ograniczenie udostpniania zasob贸w na podstawie domeny.
* Ograniczenie korzystania z kont usug Identity and Access Management.
* Ograniczenie fizycznego poo偶enia nowo tworzonych zasob贸w.
* Wyczenie tworzenia kont usug.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Istnieje wiele innych ogranicze, kt贸re pozwalaj na precyzyjn kontrol zasob贸w Twojej organizacji. Aby uzyska **wicej informacji, zobacz** [**list wszystkich ogranicze usugi Organization Policy**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Domylne zasady organizacji**

<details>

<summary>Oto zasady, kt贸re Google domylnie dodaje podczas konfigurowania Twojej organizacji GCP:</summary>

**Zasady zarzdzania dostpem**

* **Ograniczenia dotyczce kontakt贸w w domenie:** Zapobiega dodawaniu u偶ytkownik贸w do kontakt贸w podstawowych spoza okrelonych domen. Ogranicza to kontakty podstawowe, aby umo偶liwi tylko zarzdzane to偶samoci u偶ytkownik贸w w wybranych domenach otrzymywa powiadomienia platformy.
* **Ograniczenia dotyczce udostpniania w domenie:** Zapobiega dodawaniu u偶ytkownik贸w do polityk IAM spoza okrelonych domen. Ogranicza to polityki IAM, aby umo偶liwi tylko zarzdzane to偶samoci u偶ytkownik贸w w wybranych domenach uzyskiwa dostp do zasob贸w w tej organizacji.
* **Zapobieganie publicznemu dostpowi:** Zapobiega ujawnianiu kubek贸w Cloud Storage publicznie. Zapewnia to, 偶e deweloper nie mo偶e skonfigurowa kubek贸w Cloud Storage tak, aby miay dostp do internetu bez uwierzytelnienia.
* **Jednolity dostp na poziomie kubeka:** Zapobiega kontrolom dostpu na poziomie obiektu (ACL) w kubekach Cloud Storage. Uatwia zarzdzanie dostpem, stosujc polityki IAM konsekwentnie dla wszystkich obiekt贸w w kubekach Cloud Storage.
* **Wymaganie logowania do systemu operacyjnego:** Maszyny wirtualne tworzone w nowych projektach bd miay wczone logowanie do systemu operacyjnego. Pozwala to zarzdza dostpem SSH do instancji za pomoc IAM, bez koniecznoci tworzenia i zarzdzania indywidualnymi kluczami SSH.

**Dodatkowe zasady bezpieczestwa dla kont usug**

* **Wycz automatyczne przyznawanie uprawnie IAM**: Zapobiega automatycznemu przyznawaniu kontom usug App Engine i Compute Engine roli IAM Editor w projekcie podczas tworzenia. Zapewnia to, 偶e konta usug nie otrzymuj nadmiernie uprzywilejowanych r贸l IAM przy tworzeniu.
* **Wycz tworzenie kluczy kont usug**: Zapobiega tworzeniu publicznych kluczy kont usug. Pomaga to zmniejszy ryzyko ujawnienia trwaych powiadcze.
* **Wycz przesyanie kluczy kont usug**: Zapobiega przesyaniu publicznych kluczy kont usug. Pomaga to zmniejszy ryzyko ujawnienia lub ponownego u偶ycia materiau klucza.

**Zasady konfiguracji bezpiecznej sieci VPC**

* **Zdefiniuj dozwolone zewntrzne adresy IP dla instancji VM**: Zapobiega tworzeniu instancji Compute z publicznym adresem IP, co mo偶e je wystawi na ruch internetowy.

<!---->

* **Wycz zagnie偶d偶anie wirtualizacji VM**: Zapobiega tworzeniu zagnie偶d偶onych maszyn wirtualnych na maszynach Compute Engine VM. Zmniejsza to ryzyko bezpieczestwa zwizanego z posiadaniem nie monitorowanych maszyn wirtualnych.

<!---->

* **Wycz port szeregowy VM:** Zapobiega dostpowi do portu szeregowego maszyn wirtualnych Compute Engine. Zapobiega to wprowadzaniu danych wejciowych do portu szeregowego serwera za pomoc interfejsu API Compute Engine.

<!---->

* **Ogranicz dostp do sieci autoryzowanych na instancje Cloud SQL:** Zapobiega dostpowi do baz danych Cloud SQL z publicznych lub niezewntrznych zakres贸w sieciowych.

<!---->

* **Ogranicz przekazywanie protokou na podstawie typu adresu IP:** Zapobiega przekazywaniu protokou VM dla adres贸w IP zewntrznych.

<!---->

* **Ogranicz dostp do publicznego adresu IP na instancje Cloud SQL:** Zapobiega tworzeniu instancji Cloud SQL z publicznym adresem IP, co mo偶e je wystawi na ruch internetowy.

<!---->

* **Ogranicz usuwanie zablokowanych projekt贸w Shared VPC:** Zapobiega przypadkowemu usuniciu hostujcych projekt贸w Shared VPC.

<!---->

* **Ustawienie wewntrznej konfiguracji DNS dla nowych projekt贸w na Zonal DNS Only:** Zapobiega korzystaniu z przestarzaej konfiguracji DNS, kt贸ra ma ograniczon dostpno usug.

<!---->

* **Pomi tworzenie domylnej sieci:** Zapobiega automatycznemu tworzeniu domylnej sieci VPC i powizanych zasob贸w. Zapobiega to nadmiernie uprzywilejowanym domylnym reguom zapory sieciowej.

<!---->

* **Wycz u偶ywanie zewntrznego IPv6 w sieci VPC:** Zapobiega tworzeniu zewntrznych podsieci IPv6, kt贸re mog by wystawione na nieautoryzowany dostp do internetu.

</details>

## **Role IAM**

S one podobne do polityk IAM w AWS, poniewa偶 **ka偶da rola zawiera zestaw uprawnie**.

Jednak w przeciwiestwie do AWS, nie ma **centralnego repozytorium** r贸l. Zamiast tego, **zasoby nadaj role dostpu X dla podmiot贸w Y**, a jedynym sposobem dowiedzenia si, kto ma dostp do zasob
## U偶ytkownicy <a href="#default-credentials" id="default-credentials"></a>

W **konsoli GCP** nie ma zarzdzania **u偶ytkownikami ani grupami**, to jest robione w **Google Workspace**. Mo偶esz jednak zsynchronizowa inny dostawc to偶samoci w Google Workspace.

Mo偶esz uzyska dostp do u偶ytkownik贸w i grup w Workspaces na stronie [**https://admin.google.com**](https://admin.google.com/).

**MFA** mo偶e by **wymuszone** dla u偶ytkownik贸w Workspaces, jednak **atakujcy** mo偶e u偶y tokena do dostpu do GCP **za pomoc wiersza polece, kt贸ry nie jest chroniony przez MFA** (chroniony jest przez MFA tylko wtedy, gdy u偶ytkownik loguje si, aby go wygenerowa: `gcloud auth login`).

## Grupy

Podczas tworzenia organizacji zaleca si utworzenie kilku grup. Jeli zarzdzasz kt贸r z nich, mo偶esz narazi ca organizacj lub jej wa偶n cz:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcja</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(wymagane dla listy kontrolnej)</em></td><td>Administrowanie zasobami nale偶cymi do organizacji. Przypisuj t rol oszczdnie; administratorzy organizacji maj dostp do wszystkich zasob贸w Google Cloud. Alternatywnie, ze wzgldu na wysoki poziom uprawnie, rozwa偶 u偶ycie kont indywidualnych zamiast tworzenia grupy.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(wymagane dla listy kontrolnej)</em></td><td>Tworzenie sieci, podsieci, regu zapory sieciowej oraz urzdze sieciowych, takich jak Cloud Router, Cloud VPN i r贸wnowa偶niki obci偶enia w chmurze.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(wymagane dla listy kontrolnej)</em></td><td>Ustawianie kont rozliczeniowych i monitorowanie ich wykorzystania.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(wymagane dla listy kontrolnej)</em></td><td>Projektowanie, kodowanie i testowanie aplikacji.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Ustanawianie i zarzdzanie politykami bezpieczestwa dla caej organizacji, w tym zarzdzanie dostpem i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politykami ogranicze organizacji</a>. Aby uzyska wicej informacji na temat planowania infrastruktury bezpieczestwa Google Cloud, zobacz <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">przewodnik dotyczcy podstaw bezpieczestwa Google Cloud</a>.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Tworzenie lub zarzdzanie potokami end-to-end, kt贸re obsuguj cig integracj i dostarczanie, monitorowanie oraz dostarczanie systemu.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Monitorowanie wydatk贸w na projektach. Typowi czonkowie to cz zespou finansowego.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Przegldanie informacji o zasobach w caej organizacji Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Przegldanie bezpieczestwa chmury.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Przegldanie konfiguracji sieciowej.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Przegldanie dziennik贸w audytu.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Administrowanie Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(ju偶 nie domylnie)</em></td><td>Zarzdzanie sekretami w Secret Manager.</td></tr></tbody></table>

## **Domylne zasady hasa**

* Wymagane s silne hasa
* Od 8 do 100 znak贸w
* Brak mo偶liwoci ponownego u偶ycia
* Brak wyganicia
* Jeli osoby korzystaj z Workspace za porednictwem dostawcy zewntrznego, te wymagania nie s stosowane.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Konta usug**

S to podmioty, kt贸re **zasoby** mog mie **przypisane** i uzyskiwa dostp do interakcji z GCP. Na przykad, mo偶liwe jest uzyskanie dostpu do **tokena uwierzytelniajcego** konta usugi **przypisanego do maszyny wirtualnej** w metadanych.\
Mo偶e wystpi kilka **konflikt贸w** przy jednoczesnym u偶yciu zar贸wno **r贸l IAM, jak i zakres贸w dostpu**. Na przykad, twoje konto usugi mo偶e mie rol IAM `compute.instanceAdmin`, ale instancja, kt贸r naruszye, zostaa ograniczona zakresem `https://www.googleapis.com/auth/compute.readonly`. Uniemo偶liwioby to dokonywanie jakichkolwiek zmian za pomoc tokena OAuth, kt贸ry automatycznie przypisano do twojej instancji.

To jest podobne do r贸l IAM w AWS. Ale w przeciwiestwie do AWS, **dowolne** konto usugi mo偶e by **przypisane do dowolnej usugi** (nie musi by do tego uprawnione za pomoc polityki).

Wiele kont usug, kt贸re znajdziesz, jest **automatycznie generowanych przez GCP** podczas korzystania z usugi, takich jak:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Jednak偶e istnieje r贸wnie偶 mo偶liwo tworzenia i doczania do zasob贸w **niestandardowych kont usug**, kt贸re bd wyglda tak:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Zakresy dostpu**

Zakresy dostpu s **przypisane do wygenerowanych token贸w OAuth** w celu uzyskania dostpu do punkt贸w kocowych API GCP. **Ograniczaj uprawnienia** tokenu OAuth.\
Oznacza to, 偶e jeli token nale偶y do waciciela zasobu, ale nie ma zakresu dostpu do tego zasobu, token **nie mo偶e by u偶ywany do (nadu偶ywania) tych uprawnie**.

Google faktycznie [zaleca](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions), aby **nie u偶ywa zakres贸w dostpu i cakowicie polega na IAM**. Portal zarzdzania sieci faktycznie to egzekwuje, ale zakresy dostpu nadal mog by stosowane do instancji za pomoc niestandardowych kont usug programistycznie.

Mo偶esz zobaczy, jakie **zakresy** s **przypisane** poprzez **zapytanie:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Poprzednie **zakresy** s generowane **domylnie** przy u偶yciu **`gcloud`** do dostpu do danych. Dzieje si tak, poniewa偶 przy u偶yciu **`gcloud`** najpierw tworzony jest token OAuth, a nastpnie jest on u偶ywany do kontaktowania si z punktami kocowymi.

Najwa偶niejszym zakresem spor贸d tych potencjalnych jest **`cloud-platform`**, co oznacza, 偶e jest mo偶liwy **dostp do dowolnej usugi w GCP**.

Mo偶esz **znale藕 list** [**wszystkich mo偶liwych zakres贸w tutaj**](https://developers.google.com/identity/protocols/googlescopes)**.**

Jeli masz powiadczenia przegldarki **`gcloud`**, mo偶liwe jest **uzyskanie tokenu z innymi zakresami**, wykonujc co takiego:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform Polityki IAM, powizania i czonkostwa**

Zgodnie z definicj terraformu w [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), korzystajc z terraformu w GCP istniej r贸偶ne sposoby przyznawania dostpu do zasobu dla podmiotu:

* **Czonkostwa**: Ustawiasz **podmioty jako czonk贸w r贸l** **bez ogranicze** dotyczcych roli lub podmiot贸w. Mo偶esz umieci u偶ytkownika jako czonka roli, a nastpnie umieci grup jako czonka tej samej roli i r贸wnie偶 ustawi te podmioty (u偶ytkownika i grup) jako czonk贸w innych r贸l.
* **Powizania**: Kilka **podmiot贸w mo偶e by powizanych z rol**. Te **podmioty mog nadal by powizane lub by czonkami innych r贸l**. Jednak jeli podmiot, kt贸ry nie jest powizany z rol, zostanie ustawiony jako **czonek powizanej roli**, to przy nastpnym **zastosowaniu powizania czonkostwo zniknie**.
* **Polityki**: Polityka jest **wi偶ca**, okrela role i podmioty, a nastpnie **te podmioty nie mog mie wicej r贸l, a te role nie mog mie wicej podmiot贸w**, chyba 偶e polityka zostanie zmodyfikowana (nawet w innych politykach, powizaniach lub czonkostwach). Dlatego, gdy rola lub podmiot jest okrelony w polityce, wszystkie jego uprawnienia s **ograniczone przez t polityk**. Oczywicie, mo偶na to obej w przypadku, gdy podmiotowi zostanie udostpniona mo偶liwo modyfikacji polityki lub uprawnie eskalacji przywilej贸w (np. utworzenie nowego podmiotu i powizanie go z now rol).

## Odwoania

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
