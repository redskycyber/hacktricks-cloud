# GCP para Pivoteamento no Workspace

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Este post √© um resumo do que est√° em [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover), que pode ser acessado para mais detalhes.

## **Entendendo a Delega√ß√£o em Todo o Dom√≠nio**

A delega√ß√£o em todo o dom√≠nio do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Marketplace do Google Workspace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em todo o Workspace em nome dos usu√°rios**. Essa funcionalidade, crucial para aplicativos que interagem com APIs do Google ou servi√ßos que precisam de personifica√ß√£o de usu√°rio, aumenta a efici√™ncia e minimiza erros humanos automatizando tarefas. Usando OAuth 2.0, desenvolvedores de aplicativos e administradores podem dar a essas contas de servi√ßo acesso aos dados do usu√°rio sem consentimento individual.\
\
O Google Workspace permite a cria√ß√£o de dois principais tipos de identidades delegadas globais:

* **Aplica√ß√µes GWS:** Aplica√ß√µes do Marketplace do Workspace podem ser configuradas como uma identidade delegada. Antes de serem disponibilizadas no marketplace, cada aplica√ß√£o do Workspace passa por uma revis√£o do Google para minimizar o potencial de uso indevido. Embora isso n√£o elimine completamente o risco de abuso, aumenta significativamente a dificuldade para que tais incidentes ocorram.
* **Conta de Servi√ßo GCP:** Saiba mais sobre [**Contas de Servi√ßo GCP aqui**](gcp-basic-information.md#service-accounts).

### **Delega√ß√£o em Todo o Dom√≠nio: Por Dentro**

Assim √© como uma Conta de Servi√ßo GCP pode acessar APIs do Google em nome de outras identidades no Google Workspace:

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **Identidade cria um JWT:** A Identidade usa a chave privada da conta de servi√ßo (parte do arquivo de par de chaves JSON) para assinar um JWT. Este JWT cont√©m declara√ß√µes sobre a conta de servi√ßo, o usu√°rio alvo a ser personificado e os escopos OAuth de acesso √† API REST que est√° sendo solicitada.
2. **A Identidade usa o JWT para solicitar um token de acesso:** O aplicativo/usu√°rio usa o JWT para solicitar um token de acesso do servi√ßo OAuth 2.0 do Google. A solicita√ß√£o tamb√©m inclui o usu√°rio alvo a ser personificado (o e-mail do Workspace do usu√°rio) e os escopos para os quais o acesso √© solicitado.
3. **O servi√ßo OAuth 2.0 do Google retorna um token de acesso:** O token de acesso representa a autoridade da conta de servi√ßo para agir em nome do usu√°rio para os escopos especificados. Este token geralmente tem vida curta e deve ser renovado periodicamente (conforme a necessidade do aplicativo). √â essencial entender que os escopos OAuth especificados no token JWT t√™m validade e impacto no token de acesso resultante. Por exemplo, tokens de acesso que possuem m√∫ltiplos escopos ter√£o validade para v√°rias aplica√ß√µes da API REST.
4. **A Identidade usa o token de acesso para chamar APIs do Google**: Agora com um token de acesso relevante, o servi√ßo pode acessar a API REST necess√°ria. O aplicativo usa esse token de acesso no cabe√ßalho "Authorization" de suas solicita√ß√µes HTTP destinadas √†s APIs do Google. Essas APIs utilizam o token para verificar a identidade personificada e confirmar se ela tem a autoriza√ß√£o necess√°ria.
5. **As APIs do Google retornam os dados solicitados**: Se o token de acesso for v√°lido e a conta de servi√ßo tiver autoriza√ß√£o apropriada, as APIs do Google retornam os dados solicitados. Por exemplo, na imagem a seguir, utilizamos o m√©todo _users.messages.list_ para listar todos os IDs de mensagens do Gmail associados a um usu√°rio alvo do Workspace.

## Nova delega√ß√£o com acesso interativo ao GWS

No primeiro cen√°rio, um ator normalmente obt√©m acesso inicial a uma identidade IAM, com a capacidade de **criar contas de servi√ßo em um projeto GCP.** Al√©m disso, ele agora possui um **privil√©gio de super administrador no GWS.**

**Passos do ataque:**

1. **Gerando uma Nova Conta de Servi√ßo e Par de Chaves Correspondente:** No GCP, novos recursos de conta de servi√ßo podem ser produzidos interativamente atrav√©s do console ou programaticamente usando chamadas diretas de API e ferramentas de CLI. Isso requer o **papel `iam.serviceAccountAdmin`** ou qualquer papel personalizado equipado com a **permiss√£o `iam.serviceAccounts.create`**. Uma vez que a conta de servi√ßo √© criada, prosseguimos para gerar um **par de chaves relacionado** (**permiss√£o `iam.serviceAccountKeys.create`**).
2.  **Cria√ß√£o de nova delega√ß√£o**: Ap√≥s ter um objeto de identidade relevante e uma chave privada relacionada que permite a autentica√ß√£o com APIs do Google, precisamos **estabelecer uma nova regra de delega√ß√£o para o recurso de conta de servi√ßo dentro do Google Workspace**. Esta regra de delega√ß√£o nos permitir√° realizar a atividade de APIs do Google em aplica√ß√µes da API REST do Workspace. √â importante entender que **apenas o papel de Super Admin possui a capacidade de configurar a delega√ß√£o global em Todo o Dom√≠nio no Google Workspace** e a delega√ß√£o em Todo o Dom√≠nio **n√£o pode ser configurada programaticamente,** s√≥ pode ser criada e ajustada **manualmente** atrav√©s do console do **Google Workspace**.

A cria√ß√£o da regra pode ser encontrada na p√°gina **Controles de API ‚Üí Gerenciar Delega√ß√£o em Todo o Dom√≠nio no console de Administra√ß√£o do Google Workspace**.
3. **Anexando privil√©gio de escopos OAuth**: Ao configurar uma nova delega√ß√£o, o Google exige apenas 2 par√¢metros, o ID do Cliente, que √© o **ID OAuth da Conta de Servi√ßo GCP** e **escopos OAuth** que definem quais chamadas de API a delega√ß√£o requer.\
A **lista completa de escopos OAuth** pode ser encontrada [**aqui**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Agindo em nome da identidade alvo:** Neste ponto, temos um objeto delegado funcionando no GWS. Agora, **usando a chave privada da Conta de Servi√ßo GCP, podemos realizar chamadas de API** (no escopo definido no par√¢metro de escopo OAuth) para ativ√°-lo e **agir em nome de qualquer identidade que exista no Google Workspace**. Como aprendemos, a conta de servi√ßo gerar√° tokens de acesso conforme suas necessidades e de acordo com a permiss√£o que tem para aplica√ß√µes da API REST.

### Delega√ß√£o Interorganizacional

O ID SA OAuth √© global e pode ser usado para **delega√ß√£o interorganizacional**. N√£o foi implementada nenhuma restri√ß√£o para impedir a delega√ß√£o global cruzada. Em termos simples, **contas de servi√ßo de diferentes organiza√ß√µes GCP podem ser usadas para configurar delega√ß√£o em todo o dom√≠nio em outras organiza√ß√µes do Workspace**. Isso resultaria em **precisar apenas de acesso de Super Admin ao Workspace**, e n√£o acesso √† mesma conta GCP, j√° que o advers√°rio pode criar Contas de Servi√ßo e chaves privadas em sua conta GCP controlada pessoalmente.

## Comprometimento de delega√ß√£o existente - DeleFriend

Caso tenhamos acesso a um recurso relevante de Conta de Servi√ßo GCP com **delega√ß√£o em Todo o Dom√≠nio existente** dentro da Pol√≠tica IAM, nada nos impede de criar uma nova chave, enumerar todas as possibilidades de JWT existentes e usar essa delega√ß√£o existente para realizar chamadas de API para o Google Workspace em nome de outras identidades no dom√≠nio.

{% hint style="danger" %}
Ap√≥s comprometer de alguma forma uma organiza√ß√£o/projeto GCP, um atacante poderia verificar quais Contas de Servi√ßo GCP ele pode criar **chaves json**, cri√°-las e verificar se a **SA tem acesso em nome de outras identidades a alguns escopos OAuth do Workspace**.
{% endhint %}

Estes s√£o os passos exatos:

1. **Enumerar Projetos GCP** usando a API do Gerenciador de Recursos.
2. Iterar em cada recurso do projeto e **enumerar recursos de Conta de Servi√ßo GCP** aos quais o usu√°rio IAM inicial tem acesso usando _GetIAMPolicy_.
3. Iterar em **cada papel da conta de servi√ßo**, e encontrar pap√©is integrados, b√°sicos e personalizados com permiss√£o _**serviceAccountKeys.create**_ no recurso da conta de servi√ßo alvo. Deve-se notar que o papel de Editor possui inerentemente esta permiss√£o.
4. Criar uma **nova chave privada \_KEY\_ALG\_RSA\_2048**\_\*\* para cada recurso de conta de servi√ßo\*\* encontrado com permiss√£o relevante na pol√≠tica IAM.
5. Iterar em **cada nova conta de servi√ßo e criar um objeto \_JWT**\_\*\* para ela que √© composto pelas credenciais da chave privada da SA e um escopo OAuth. O processo de cria√ß√£o de um novo objeto _JWT_ ir√° **iterar em todas as combina√ß√µes existentes de escopos OAuth** da lista **oauth\_scopes.txt**, a fim de encontrar todas as possibilidades de delega√ß√£o. A lista **oauth\_scopes.txt** √© atualizada com todos os escopos OAuth que encontramos serem relevantes para abusar de identidades do Workspace.
6. O m√©todo _\_make\_authorization\_grant\_assertion_ destaca a necessidade de declarar um **usu√°rio do workspace alvo**, referido como _subject_, para gerar JWTs sob DWD. Embora isso possa parecer exigir um usu√°rio espec√≠fico, √© importante perceber que **DWD influencia todas as identidades dentro de um dom√≠nio**. Consequentemente, criar um JWT para **qualquer usu√°rio do dom√≠nio** afeta todas as identidades naquele dom√≠nio, consistente com nossa verifica√ß√£o de enumera√ß√£o de combina√ß√µes. Simplificando, um usu√°rio v√°lido do Workspace √© suficiente para avan√ßar.\
Este usu√°rio pode ser definido no arquivo _config.yaml_ do DeleFriend. Se um usu√°rio alvo do workspace j√° n√£o for conhecido, a ferramenta facilita a identifica√ß√£o autom√°tica de usu√°rios v√°lidos do workspace, escaneando usu√°rios de dom√≠nio com pap√©is em projetos GCP. √â chave notar (novamente) que os JWTs s√£o espec√≠ficos do dom√≠nio e n√£o gerados para cada usu√°rio; portanto, o processo autom√°tico visa uma identidade √∫nica por dom√≠nio.
7. **Enumerar e criar um novo token de acesso bearer** para cada JWT e validar o token contra a API tokeninfo.

**Voc√™ pode encontrar a ferramenta para realizar este ataque automaticamente em:** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## Refer√™ncias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
