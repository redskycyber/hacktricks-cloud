# GWS - 谷歌平台钓鱼

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 通用钓鱼方法论

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## 谷歌群组钓鱼

显然，默认情况下，在工作空间成员[**可以创建群组**](https://groups.google.com/all-groups) **并邀请人加入**。然后，您可以修改将发送给用户的电子邮件**添加一些链接**。**邮件将来自谷歌地址**，因此看起来**合法**，人们可能会点击链接。

还可以将**FROM**地址设置为**谷歌群组电子邮件**，以向群组内的用户发送**更多电子邮件**，就像下面的图片中创建了名为**`google--support@googlegroups.com`**的群组，并向该群组的所有成员发送了一封电子邮件（未经任何同意添加的成员）

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## 谷歌聊天钓鱼

您可能可以通过仅知道其电子邮件地址**开始与某人聊天**，或发送**邀请进行对话**。此外，还可以**创建一个空间**，可以使用任何名称（例如“谷歌支持”），并**邀请**成员加入。如果他们接受，他们可能会认为他们正在与谷歌支持交谈：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**然而，在我的测试中，被邀请的成员甚至没有收到邀请。**
{% endhint %}

您可以查看过去的工作方式：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## 谷歌文档钓鱼

过去可以创建一个**看起来合法的文档**，然后在评论中**提及某个电子邮件（如@user@gmail.com）**。谷歌会向该电子邮件地址发送一封电子邮件，通知他们在文档中被提及。\
现在，这种方法不起作用，但如果您**让受害者访问文档**，谷歌将发送一封电子邮件进行通知。这是当您提及某人时出现的消息：

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
受害者可能有防护机制，不允许外部文档共享的电子邮件到达他们的邮箱。
{% endhint %}

## 谷歌日历钓鱼

您可以**创建一个日历事件**，并添加您攻击的公司的尽可能多的电子邮件地址。将此日历事件安排在**当前时间的5或15分钟**后。使事件看起来合法，并**添加评论和标题，指示他们需要阅读某些内容**（带有**钓鱼链接**）。

这是浏览器中将出现的一个警报，会议标题为“解雇人员”，因此您可以设置一个更具钓鱼性质的标题（甚至更改与您的电子邮件关联的名称）。

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

为了使其看起来不那么可疑：

* 设置为**接收者无法看到其他被邀请的人**
* **不要发送关于事件的电子邮件通知**。然后，人们只会看到他们关于5分钟后的会议的警告以及他们需要阅读该链接的信息。
* 显然，使用API，您可以设置为**接受**事件的**人员**，甚至代表他们创建**评论**。 

## 应用脚本重定向钓鱼

可以在[https://script.google.com/](https://script.google.com/)创建一个脚本，并**将其公开为每个人都可以访问的Web应用程序**，该应用程序将使用合法域**`script.google.com`**。\
然后，使用以下类似的代码，攻击者可以使脚本在不停止访问该域的情况下加载任意内容在此页面中：

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

例如访问[https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec)，您将看到：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
请注意，由于内容加载在iframe中，会出现警告。
{% endhint %}

## 应用脚本OAuth钓鱼

可以创建附加到文档的应用脚本，尝试获取受害者OAuth令牌的访问权限，欲了解更多信息，请查看：

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth应用程序钓鱼

任何先前的技术都可能被用来让用户访问**Google OAuth应用程序**，该应用程序将**请求**用户一些**访问权限**。如果用户**信任****来源**，他可能会**信任**该**应用程序**（即使它要求高权限）。

{% hint style="info" %}
请注意，Google会显示一个丑陋的提示，警告应用程序未经信任，在许多情况下，Workspace管理员甚至可以阻止人们接受OAuth应用程序。
{% endhint %}

**Google**允许创建可以代表用户与多个**Google服务**交互的应用程序：Gmail、Drive、GCP...

创建一个应用程序以**代表其他用户操作**时，开发人员需要在GCP内创建一个**OAuth应用程序**，并指定应用程序需要访问用户数据的范围（权限）。\
当**用户**想要**使用**该**应用程序**时，他们将被**提示****接受**该应用程序将访问在权限中指定的数据。

这是一种非常诱人的方式，可以**钓鱼**非技术用户使用**访问敏感信息的应用程序**，因为他们可能不了解后果。但是，在组织帐户中，有方法可以防止这种情况发生。

### 未经验证的应用程序提示

如前所述，Google将始终向用户显示一个**提示**，要求他们接受他们代表应用程序授予的权限。但是，如果应用程序被认为是**危险的**，Google将首先显示一个**提示**，指示它是**危险的**，并**使用户更难**向应用程序授予权限。

此提示出现在以下应用程序中：

* 使用任何可以访问私人数据的范围（Gmail、Drive、GCP、BigQuery...）
* 少于100个用户的应用程序（对于超过100个用户的应用程序，还需要进行审查流程，以阻止显示未经验证的提示）

### 有趣的范围

[**在这里**](https://developers.google.com/identity/protocols/oauth2/scopes)您可以找到所有Google OAuth范围的列表。

* **cloud-platform**：查看并管理您在**Google Cloud Platform**服务中的数据。您可以在GCP中冒充用户。
* **admin.directory.user.readonly**：查看并下载您组织的GSuite目录。获取所有用户的姓名、电话、日历URL。

### 创建OAuth应用程序

**开始创建OAuth客户端ID**

1. 转到[https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)，并单击配置同意屏幕。
2. 然后，将询问**用户类型**是**内部**（仅适用于您组织中的人员）还是**外部**。选择适合您需求的类型
* 如果您已经入侵了组织中的某个用户，并且正在创建此应用程序以钓鱼另一个用户，则内部可能会很有趣。
3. 为应用程序指定一个**名称**、一个**支持电子邮件**（请注意，您可以设置一个googlegroup电子邮件，以尝试更加匿名化自己），一个**标志**、**授权域**和另一个用于**更新**的**电子邮件**。
4. **选择**OAuth**范围**。
* 此页面分为非敏感权限、敏感权限和受限权限。每次添加新权限时，它都会添加到其类别中。根据请求的权限不同，用户将看到不同的提示，指示这些权限有多敏感。
* **`admin.directory.user.readonly`**和**`cloud-platform`**都是敏感权限。
5. **添加测试用户**。只有这些用户能够访问应用程序，只要应用程序处于测试状态，因此请确保**添加您将要钓鱼的电子邮件**。

现在，使用**先前创建的OAuth客户端ID**获取**Web应用程序的凭据**：

1. 返回到[https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)，这次会出现不同的选项。
2. 选择**为Web应用程序创建凭据**
3. 设置所需的**Javascript起源**和**重定向URI**
* 您可以在两者中设置类似**`http://localhost:8000/callback`**的内容进行测试
4. 获取您的应用程序**凭据**

最后，让我们**运行一个将使用OAuth应用程序凭据的Web应用程序**。您可以在[https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example)中找到一个示例。
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
前往**`http://localhost:8000`**，点击“使用Google登录”按钮，您将收到类似以下消息的提示：

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

该应用程序将显示可轻松使用的**访问令牌和刷新令牌**。有关如何使用这些令牌的更多信息，请查看：

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### 使用`gcloud`

可以使用gcloud而不是Web控制台执行某些操作，请查看：

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 参考资料

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
