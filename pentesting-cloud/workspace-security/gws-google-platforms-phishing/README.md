# GWS - Phishing na platformach Google

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Og贸lna metodologia phishingu

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing w Google Groups

Widocznie, domylnie w czonkach workspace [**mog tworzy grupy**](https://groups.google.com/all-groups) **i zaprasza do nich ludzi**. Nastpnie mo偶na zmodyfikowa e-mail, kt贸ry zostanie wysany do u偶ytkownika, **dodajc kilka link贸w**. **E-mail bdzie pochodzi z adresu Google**, wic bdzie wyglda **wiarygodnie**, a ludzie mog klikn w link.

Mo偶liwe jest r贸wnie偶 ustawienie adresu **FROM** jako **adres e-mail grupy Google**, aby wysa **wicej e-maili do u偶ytkownik贸w wewntrz grupy**, jak na poni偶szym obrazku, gdzie utworzono grup **`google--support@googlegroups.com`** i wysano **e-mail do wszystkich czonk贸w** grupy (kt贸rzy zostali dodani bez zgody)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing w Google Chat

Mo偶esz by w stanie **rozpocz rozmow** z osob, znajc tylko jej adres e-mail lub wysa **zaproszenie do rozmowy**. Ponadto, mo偶liwe jest **utworzenie przestrzeni**, kt贸ra mo偶e mie dowoln nazw (np. "Google Support") i **zaproszenie** czonk贸w do niej. Jeli zaakceptuj, mog myle, 偶e rozmawiaj z obsug Google:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Jednak w moim tecie zaproszeni czonkowie nawet nie otrzymali zaproszenia.**
{% endhint %}

Mo偶esz sprawdzi, jak to dziaao w przeszoci na stronie: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing w Google Doc

W przeszoci mo偶na byo utworzy **wydawa si wiarygodny dokument** i w komentarzu **wspomnie o jakim adresie e-mail (np. @user@gmail.com)**. Google **wysya e-mail na ten adres e-mail**, informujc, 偶e zosta wspomniany w dokumencie.\
Obecnie to nie dziaa, ale jeli **udostpnisz ofierze dostp do dokumentu**, Google wyle e-mail z tak informacj. Oto wiadomo, kt贸ra pojawia si, gdy wspomnisz o kim:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ofiary mog mie mechanizm ochrony, kt贸ry nie pozwala na dotarcie do ich e-maili informacji o udostpnieniu im zewntrznego dokumentu.
{% endhint %}

## Phishing w Google Calendar

Mo偶esz **utworzy wydarzenie w kalendarzu** i doda tyle adres贸w e-mail firmowych, ile chcesz zaatakowa. Zaplanuj to wydarzenie w **5 lub 15 minut** od bie偶cego czasu. Ustal, aby wydarzenie wygldao wiarygodnie i **dodaj komentarz i tytu wskazujcy, 偶e musz co przeczyta** (z **linkiem phishingowym**).

To jest alert, kt贸ry pojawi si w przegldarce z tytuem spotkania "Zwolnienie pracownik贸w", wic mo偶esz ustawi bardziej phishingowy tytu (i nawet zmieni nazw powizan z twoim adresem e-mail).

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Aby wygldao to mniej podejrzanie:

* Ustaw tak, aby **odbiorcy nie widzieli innych zaproszonych os贸b**
* **NIE wysyaj e-maili z powiadomieniem o wydarzeniu**. Wtedy ludzie zobacz tylko ostrze偶enie o spotkaniu za 5 minut i 偶e musz przeczyta ten link.
* Wydaje si, 偶e za pomoc interfejsu API mo偶na ustawi na **True**, 偶e **osoby** zaakceptoway **wydarzenie** i nawet tworzy **komentarze w ich imieniu**.

## Przekierowanie phishingowe w App Scripts

Mo偶liwe jest utworzenie skryptu w [https://script.google.com/](https://script.google.com/) i **udostpnienie go jako aplikacji internetowej dostpnej dla wszystkich**, kt贸ra bdzie korzysta z prawdziwej domeny **`script.google.com`**.  \
Nastpnie, za pomoc kodu podobnego do poni偶szego, atakujcy mo偶e sprawi, 偶e skrypt bdzie adowa dowolne treci na tej stronie, nie przestajc uzyskiwa dostpu do domeny:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Na przykad, po wejciu na stron [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) zobaczysz:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Zauwa偶, 偶e pojawi si ostrze偶enie, poniewa偶 zawarto jest adowana wewntrz iframe.
{% endhint %}

## Phishing OAuth App Scripts

Mo偶liwe jest utworzenie skrypt贸w aplikacji doczonych do dokument贸w w celu uzyskania dostpu do tokena OAuth ofiary. Aby uzyska wicej informacji, sprawd藕:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing aplikacji OAuth

Ka偶da z wczeniejszych technik mo偶e by wykorzystana do zmuszenia u偶ytkownika do **uzyskania dostpu do aplikacji OAuth Google**, kt贸ra bdzie **偶da** od u偶ytkownika pewnego **dostpu**. Jeli u偶ytkownik **ufa** **藕r贸du**, mo偶e **zaufa** **aplikacji** (nawet jeli prosi o uprzywilejowane uprawnienia).

{% hint style="info" %}
Nale偶y zauwa偶y, 偶e Google prezentuje brzydkie ostrze偶enie, informujce, 偶e aplikacja jest niezaufana w wielu przypadkach, a administratorzy Workspace mog nawet uniemo偶liwi akceptowanie aplikacji OAuth przez u偶ytkownik贸w.
{% endhint %}

**Google** umo偶liwia tworzenie aplikacji, kt贸re mog **interakcjonowa w imieniu u偶ytkownik贸w** z r贸偶nymi **usugami Google**: Gmail, Drive, GCP...

Tworzc aplikacj, kt贸ra ma **dziaa w imieniu innych u偶ytkownik贸w**, deweloper musi utworzy **aplikacj OAuth w GCP** i okreli zakresy (uprawnienia), kt贸rych aplikacja potrzebuje do uzyskania dostpu do danych u偶ytkownik贸w.\
Gdy **u偶ytkownik** chce **u偶ywa** tej **aplikacji**, zostanie **poproszony** o **zaakceptowanie**, 偶e aplikacja bdzie miaa dostp do ich danych okrelonych w zakresach.

Jest to bardzo atrakcyjny spos贸b na **wyudzenie** od u偶ytkownik贸w niezwizanych z technologi **u偶ywania aplikacji, kt贸re maj dostp do wra偶liwych informacji**, poniewa偶 mog nie zrozumie konsekwencji. Jednak w przypadku kont organizacyjnych istniej sposoby zapobiegania temu.

### Ostrze偶enie o niezweryfikowanej aplikacji

Jak ju偶 wspomniano, Google zawsze przedstawi **ostrze偶enie u偶ytkownikowi**, aby zaakceptowa uprawnienia, kt贸re udziela aplikacji w jego imieniu. Jednak jeli aplikacja jest uwa偶ana za **niebezpieczn**, Google najpierw poka偶e **ostrze偶enie**, 偶e jest **niebezpieczna** i **utrudni** u偶ytkownikowi udzielenie uprawnie aplikacji.

To ostrze偶enie pojawia si w aplikacjach, kt贸re:

* U偶ywaj jakiegokolwiek zakresu, kt贸ry mo偶e uzyska dostp do prywatnych danych (Gmail, Drive, GCP, BigQuery...)
* Aplikacje z mniej ni偶 100 u偶ytkownikami (aplikacje > 100 wymagaj r贸wnie偶 procesu przegldu, aby przesta pokazywa ostrze偶enie o niezweryfikowanej aplikacji)

### Interesujce zakresy

[**Tutaj**](https://developers.google.com/identity/protocols/oauth2/scopes) znajdziesz list wszystkich zakres贸w OAuth Google.

* **cloud-platform**: Wywietlaj i zarzdzaj danymi w r贸偶nych usugach **Google Cloud Platform**. Mo偶esz podawa si za u偶ytkownika w GCP.
* **admin.directory.user.readonly**: Wywietlaj i pobieraj katalog GSuite Twojej organizacji. Uzyskaj nazwy, numery telefon贸w, adresy URL kalendarzy wszystkich u偶ytkownik贸w.

### Utw贸rz aplikacj OAuth

**Rozpocznij tworzenie identyfikatora klienta OAuth**

1. Przejd藕 do [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) i kliknij przycisk skonfiguruj ekran zgody.
2. Nastpnie zostaniesz zapytany, czy **typ u偶ytkownika** to **wewntrzny** (tylko dla os贸b w Twojej organizacji) lub **zewntrzny**. Wybierz ten, kt贸ry najlepiej odpowiada Twoim potrzebom
* Wewntrzny mo偶e by interesujcy, jeli ju偶 skompromitowae u偶ytkownika organizacji i tworzysz t aplikacj, aby wyudzi kolejnego.
3. Nadaj **nazw** aplikacji, **adres e-mail wsparcia** (zauwa偶, 偶e mo偶esz ustawi adres e-mail grupy Google, aby zachowa wiksz anonimowo), **logo**, **autoryzowane domeny** i inny **adres e-mail** do **aktualizacji**.
4. **Wybierz** **zakresy OAuth**.
* Ta strona jest podzielona na uprawnienia niewra偶liwe, uprawnienia wra偶liwe i uprawnienia ograniczone. Za ka偶dym razem, gdy dodajesz nowe uprawnienie, jest ono dodawane do swojej kategorii. W zale偶noci od 偶danych uprawnie, u偶ytkownikowi zostanie wywietlone r贸偶ne ostrze偶enie, wskazujce, jak wra偶liwe s te uprawnienia.
* Zar贸wno **`admin.directory.user.readonly`** jak i **`cloud-platform`** to uprawnienia wra偶liwe.
5. **Dodaj testowych u偶ytkownik贸w**. Dop贸ki status aplikacji jest testowy, tylko ci u偶ytkownicy bd mogli uzyska dostp do aplikacji, wic upewnij si, 偶e **dodajesz e-mail, kt贸rym bdziesz wyudza**.

Teraz uzyskajmy **dane uwierzytelniajce dla aplikacji internetowej**, korzystajc z **wczeniej utworzonego identyfikatora klienta OAuth**:

1. Wr贸 do [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), tym razem pojawi si inna opcja.
2. Wybierz **utw贸rz dane uwierzytelniajce dla aplikacji internetowej**
3. Ustaw wymagane **pochodzenia JavaScript** i **adresy URL przekierowania**
* Mo偶esz ustawi w obu przypadkach co takiego jak **`http://localhost:8000/callback`** do test贸w
4. Uzyskaj **dane uwierzytelniajce** Twojej aplikacji

Na koniec, uruchommy **aplikacj internetow, kt贸ra bdzie korzysta z danych uwierzytelniajcych aplikacji OAuth**. Przykad znajdziesz pod adresem [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Przejd藕 do **`http://localhost:8000`**, kliknij przycisk Zaloguj si za pomoc konta Google, zostaniesz **poproszony** o wiadomo podobn do tej:

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

Aplikacja poka偶e **token dostpu i odwie偶ania**, kt贸re mo偶na atwo wykorzysta. Aby uzyska wicej informacji na temat **sposobu korzystania z tych token贸w, sprawd藕**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Korzystanie z `glcoud`

Mo偶na co zrobi za pomoc gcloud zamiast konsoli internetowej, sprawd藕:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Odwoania

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch i Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
