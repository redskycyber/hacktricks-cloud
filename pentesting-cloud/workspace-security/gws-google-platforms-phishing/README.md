# GWS - Phishing en Plataformas de Google

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Metodolog칤a Gen칠rica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing en Grupos de Google

Aparentemente, de forma predeterminada, en los miembros de workspace [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electr칩nico que se enviar치 al usuario **agregando algunos enlaces**. El **correo electr칩nico vendr치 de una direcci칩n de Google**, por lo que parecer치 **leg칤timo** y es posible que las personas hagan clic en el enlace.

Tambi칠n es posible establecer la direcci칩n **FROM** como el **correo electr칩nico del grupo de Google** para enviar **m치s correos electr칩nicos a los usuarios dentro del grupo**, como en la siguiente imagen donde se cre칩 el grupo **`google--support@googlegroups.com`** y se envi칩 un **correo electr칩nico a todos los miembros** del grupo (que fueron agregados sin consentimiento alguno)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing en Google Chat

Es posible que puedas **iniciar un chat** con una persona solo teniendo su direcci칩n de correo electr칩nico o enviar una **invitaci칩n para hablar**. Adem치s, es posible **crear un Espacio** que puede tener cualquier nombre (por ejemplo, "Soporte de Google") e **invitar** miembros a 칠l. Si aceptan, podr칤an pensar que est치n hablando con el Soporte de Google:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Sin embargo, en mis pruebas los miembros invitados ni siquiera recibieron una invitaci칩n.**
{% endhint %}

Puedes ver c칩mo funcionaba esto en el pasado en: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing en Google Docs

En el pasado era posible crear un **documento aparentemente leg칤timo** y luego en un comentario **mencionar alg칰n correo electr칩nico (como @usuario@gmail.com)**. Google **enviaba un correo electr칩nico a esa direcci칩n de correo** notificando que fueron mencionados en el documento.\
Hoy en d칤a, esto ya no funciona, pero si **das acceso al correo electr칩nico de la v칤ctima al documento** Google enviar치 un correo electr칩nico indic치ndolo. Este es el mensaje que aparece cuando mencionas a alguien:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Las v칤ctimas podr칤an tener un mecanismo de protecci칩n que no permita que los correos electr칩nicos que indican que se comparti칩 un documento externo con ellos lleguen a su correo electr칩nico.
{% endhint %}

## Phishing en Google Calendar

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo electr칩nico de la empresa que est치s atacando como desees. Programa este evento de calendario en **5 o 15 minutos** desde el momento actual. Haz que el evento parezca leg칤timo y **pon un comentario y un t칤tulo indicando que necesitan leer algo** (con el **enlace de phishing**).

Este es el aviso que aparecer치 en el navegador con un t칤tulo de reuni칩n "Despidiendo Personas", por lo que podr칤as establecer un t칤tulo m치s parecido al phishing (e incluso cambiar el nombre asociado con tu correo electr칩nico).

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Para que parezca menos sospechoso:

* Config칰ralo para que **los destinatarios no puedan ver a las otras personas invitadas**
* **NO env칤es correos electr칩nicos notificando sobre el evento**. Entonces, las personas solo ver치n su advertencia sobre una reuni칩n en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, utilizando la API puedes establecer como **Verdadero** que las **personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

## Phishing de Redirecci칩n en Scripts de Aplicaciones

Es posible crear un script en [https://script.google.com/](https://script.google.com/) y **exponerlo como una aplicaci칩n web accesible por todos** que utilizar치 el dominio leg칤timo **`script.google.com`**.  \
Luego, con un c칩digo como el siguiente, un atacante podr칤a hacer que el script cargue contenido arbitrario en esta p치gina sin dejar de acceder al dominio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Por ejemplo, al acceder a [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) ver치s:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Ten en cuenta que aparecer치 una advertencia ya que el contenido se carga dentro de un iframe.
{% endhint %}

## Phishing de OAuth de App Scripts

Es posible crear App Scripts adjuntos a documentos para intentar obtener acceso al token OAuth de las v칤ctimas, para obtener m치s informaci칩n consulta:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing de Aplicaciones OAuth

Cualquiera de las t칠cnicas anteriores podr칤a ser utilizada para hacer que el usuario acceda a una **aplicaci칩n OAuth de Google** que solicitar치 al usuario cierto **acceso**. Si el usuario **conf칤a** en la **fuente**, podr칤a **confiar** en la **aplicaci칩n** (incluso si est치 solicitando permisos de alto nivel).

{% hint style="info" %}
Ten en cuenta que Google presenta una molesta advertencia indicando que la aplicaci칩n no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones OAuth.
{% endhint %}

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicaci칩n para **actuar en nombre de otros usuarios**, el desarrollador necesita crear una **aplicaci칩n OAuth dentro de GCP** e indicar los alcances (permisos) que la aplicaci칩n necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** desea **utilizar** esa **aplicaci칩n**, se le pedir치 que **acepte** que la aplicaci칩n tendr치 acceso a sus datos especificados en los alcances.

Esta es una forma muy atractiva de **phishing** para usuarios no t칠cnicos que utilizan **aplicaciones que acceden a informaci칩n sensible** porque podr칤an no entender las consecuencias. Sin embargo, en cuentas de organizaciones, hay formas de evitar que esto suceda.

### Advertencia de Aplicaci칩n no Verificada

Como se mencion칩, Google siempre presentar치 una **advertencia al usuario para aceptar** los permisos que est치n otorgando a la aplicaci칩n en su nombre. Sin embargo, si la aplicaci칩n se considera **peligrosa**, Google mostrar치 **primero** una **advertencia** indicando que es **peligrosa** y **haciendo m치s dif칤cil** para el usuario otorgar los permisos a la aplicaci칩n.

Esta advertencia aparece en aplicaciones que:

* Utilizan cualquier alcance que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (para aplicaciones > 100 tambi칠n se necesita un proceso de revisi칩n para dejar de mostrar la advertencia de no verificado)

### Alcances Interesantes

[**Aqu칤**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los alcances de OAuth de Google.

* **cloud-platform**: Ver y administrar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **admin.directory.user.readonly**: Ver y descargar el directorio de GSuite de tu organizaci칩n. Obtener nombres, tel칠fonos, URL de calendario de todos los usuarios.

### Crear una Aplicaci칩n OAuth

**Comienza creando un ID de Cliente OAuth**

1. Ve a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) y haz clic en configurar la pantalla de consentimiento.
2. Luego, se te preguntar치 si el **tipo de usuario** es **interno** (solo para personas de tu organizaci칩n) o **externo**. Selecciona el que se ajuste a tus necesidades
* Interno puede ser interesante si ya has comprometido a un usuario de la organizaci칩n y est치s creando esta aplicaci칩n para hacer phishing a otro.
3. Dale un **nombre** a la aplicaci칩n, un **correo de soporte** (nota que puedes configurar un correo de googlegroup para tratar de anonimizarte un poco m치s), un **logotipo**, **dominios autorizados** y otro **correo** para **actualizaciones**.
4. **Selecciona** los **alcances OAuth**.
* Esta p치gina est치 dividida en permisos no sensibles, permisos sensibles y permisos restringidos. Cada vez que agregas un nuevo permiso se agrega en su categor칤a. Dependiendo de los permisos solicitados, aparecer치n diferentes advertencias al usuario indicando qu칠 tan sensibles son estos permisos.
* Tanto **`admin.directory.user.readonly`** como **`cloud-platform`** son permisos sensibles.
5. **Agrega los usuarios de prueba.** Mientras el estado de la aplicaci칩n sea de prueba, solo estos usuarios podr치n acceder a la aplicaci칩n, as칤 que aseg칰rate de **agregar el correo al que vas a hacer phishing**.

Ahora obtengamos **credenciales para una aplicaci칩n web** utilizando el **ID de Cliente OAuth previamente creado**:

1. Regresa a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), esta vez aparecer치 una opci칩n diferente.
2. Selecciona **crear credenciales para una aplicaci칩n web**
3. Configura los **or칤genes de Javascript** y las **URI de redireccionamiento** necesarios
* Puedes configurar en ambos algo como **`http://localhost:8000/callback`** para pruebas
4. Obten tus **credenciales de aplicaci칩n**

Finalmente, vamos a **ejecutar una aplicaci칩n web que utilizar치 las credenciales de la aplicaci칩n OAuth**. Puedes encontrar un ejemplo en [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Ve a **`http://localhost:8000`**, haz clic en el bot칩n de Iniciar sesi칩n con Google, se te **solicitar치** un mensaje como este:

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

La aplicaci칩n mostrar치 el **token de acceso y de actualizaci칩n** que se pueden utilizar f치cilmente. Para obtener m치s informaci칩n sobre **c칩mo utilizar estos tokens, consulta**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `gcloud`

Es posible hacer algo utilizando gcloud en lugar de la consola web, consulta:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
