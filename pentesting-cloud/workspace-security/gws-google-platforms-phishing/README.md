# GWS - Phishing em Plataformas Google

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Metodologia Gen√©rica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing em Grupos do Google

Aparentemente, por padr√£o, nos membros do workspace [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o e-mail que ser√° enviado ao usu√°rio **adicionando alguns links**. O **e-mail vir√° de um endere√ßo do Google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

Tamb√©m √© poss√≠vel definir o endere√ßo **DE** como o **e-mail do grupo do Google** para enviar **mais e-mails aos usu√°rios dentro do grupo**, como na imagem a seguir, onde o grupo **`google--support@googlegroups.com`** foi criado e um **e-mail foi enviado a todos os membros** do grupo (que foram adicionados sem consentimento algum)

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing no Google Chat

Voc√™ pode **iniciar um chat** com uma pessoa apenas tendo o endere√ßo de e-mail dela ou enviar um **convite para conversar**. Al√©m disso, √© poss√≠vel **criar um Espa√ßo** que pode ter qualquer nome (por exemplo, "Suporte Google") e **convidar** membros para ele. Se eles aceitarem, podem pensar que est√£o falando com o Suporte Google:

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**No entanto, nos meus testes, os membros convidados nem mesmo receberam um convite.**
{% endhint %}

Voc√™ pode verificar como isso funcionou no passado em: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing no Google Docs

No passado, era poss√≠vel criar um **documento aparentemente leg√≠timo** e, em um coment√°rio, **mencionar algum e-mail (como @user@gmail.com)**. O Google **enviava um e-mail para esse endere√ßo de e-mail** notificando que foram mencionados no documento.\
Atualmente, isso n√£o funciona, mas se voc√™ **der acesso de e-mail √† v√≠tima ao documento**, o Google enviar√° um e-mail indicando isso. Esta √© a mensagem que aparece quando voc√™ menciona algu√©m:

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
As v√≠timas podem ter mecanismos de prote√ß√£o que n√£o permitem que e-mails indicando que um documento externo foi compartilhado com eles cheguem ao seu e-mail.
{% endhint %}

## Phishing no Google Calendar

Voc√™ pode **criar um evento de calend√°rio** e adicionar tantos endere√ßos de e-mail da empresa que est√° atacando quantos desejar. Agende este evento de calend√°rio em **5 ou 15 minutos** a partir do hor√°rio atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio e um t√≠tulo indicando que eles precisam ler algo** (com o **link de phishing**).

Este √© o alerta que aparecer√° no navegador com um t√≠tulo de reuni√£o "Demitindo Pessoas", ent√£o voc√™ poderia definir um t√≠tulo mais parecido com phishing (e at√© mesmo alterar o nome associado ao seu e-mail).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Para parecer menos suspeito:

* Configure para que **os destinat√°rios n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie e-mails notificando sobre o evento**. Ent√£o, as pessoas s√≥ ver√£o o aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente, usando a API, voc√™ pode definir como **Verdadeiro** que as **pessoas** aceitaram o evento e at√© criar **coment√°rios em nome delas**.

## Phishing de Redirecionamento de Scripts de Aplicativos

√â poss√≠vel criar um script em [https://script.google.com/](https://script.google.com/) e **expor como um aplicativo da web acess√≠vel por todos** que usar√° o dom√≠nio leg√≠timo **`script.google.com`**.  \
Ent√£o, com algum c√≥digo como o seguinte, um atacante poderia fazer o script carregar conte√∫do arbitr√°rio nesta p√°gina sem parar de acessar o dom√≠nio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Por exemplo, ao acessar [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) voc√™ ver√°:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Note que um aviso aparecer√°, pois o conte√∫do √© carregado dentro de um iframe.
{% endhint %}

## Phishing de OAuth de Scripts de Aplicativos

√â poss√≠vel criar Scripts de Aplicativos anexados a documentos para tentar obter acesso ao token OAuth de uma v√≠tima, para mais informa√ß√µes verifique:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing de Aplicativos OAuth

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar um **aplicativo OAuth do Google** que ir√° **solicitar** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** no **aplicativo** (mesmo que esteja solicitando permiss√µes de alto privil√©gio).

{% hint style="info" %}
Observe que o Google apresenta um prompt feio avisando que o aplicativo n√£o √© confi√°vel em v√°rios casos e os administradores do Workspace podem at√© mesmo impedir que as pessoas aceitem aplicativos OAuth.
{% endhint %}

O **Google** permite criar aplicativos que podem **interagir em nome dos usu√°rios** com v√°rios **servi√ßos do Google**: Gmail, Drive, GCP...

Ao criar um aplicativo para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar um **aplicativo OAuth dentro do GCP** e indicar os escopos (permiss√µes) que o aplicativo precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** deseja **usar** esse **aplicativo**, ele ser√° **solicitado** a **aceitar** que o aplicativo ter√° acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito eficaz de **phishing** usu√°rios n√£o t√©cnicos para usar **aplicativos que acessam informa√ß√µes sens√≠veis** porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, existem maneiras de evitar que isso aconte√ßa.

### Prompt de Aplicativo N√£o Verificado

Como mencionado, o Google sempre apresentar√° um **prompt ao usu√°rio para aceitar** as permiss√µes que est√£o dando ao aplicativo em seu nome. No entanto, se o aplicativo for considerado **perigoso**, o Google mostrar√° **primeiro** um **prompt** indicando que √© **perigoso** e **tornando mais dif√≠cil** para o usu√°rio conceder as permiss√µes ao aplicativo.

Este prompt aparece em aplicativos que:

* Usam qualquer escopo que pode acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Aplicativos com menos de 100 usu√°rios (aplicativos > 100 tamb√©m precisam passar por um processo de revis√£o para parar de exibir o prompt n√£o verificado)

### Escopos Interessantes

[Aqui](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos do OAuth do Google.

* **cloud-platform**: Visualize e gerencie seus dados em v√°rios servi√ßos da **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **admin.directory.user.readonly**: Veja e baixe o diret√≥rio do GSuite de sua organiza√ß√£o. Obtenha nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

### Criar um Aplicativo OAuth

**Comece criando um ID de Cliente OAuth**

1. Acesse [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) e clique em configurar a tela de consentimento.
2. Em seguida, ser√° perguntado se o **tipo de usu√°rio** √© **interno** (apenas para pessoas em sua organiza√ß√£o) ou **externo**. Selecione o que se adequar √†s suas necessidades
* Interno pode ser interessante se voc√™ j√° comprometeu um usu√°rio da organiza√ß√£o e est√° criando este aplicativo para fazer phishing em outro.
3. D√™ um **nome** ao aplicativo, um **e-mail de suporte** (observe que voc√™ pode definir um e-mail de grupo do Google para tentar se anonimizar um pouco mais), um **logotipo**, **dom√≠nios autorizados** e outro **e-mail** para **atualiza√ß√µes**.
4. **Selecione** os **escopos OAuth**.
* Esta p√°gina √© dividida em permiss√µes n√£o sens√≠veis, permiss√µes sens√≠veis e permiss√µes restritas. Sempre que voc√™ adicionar uma nova permiss√£o, ela ser√° adicionada em sua categoria. Dependendo das permiss√µes solicitadas, diferentes prompts aparecer√£o para o usu√°rio indicando o qu√£o sens√≠veis essas permiss√µes s√£o.
* Tanto **`admin.directory.user.readonly`** quanto **`cloud-platform`** s√£o permiss√µes sens√≠veis.
5. **Adicione os usu√°rios de teste.** Enquanto o status do aplicativo estiver em teste, apenas esses usu√°rios poder√£o acessar o aplicativo, ent√£o certifique-se de **adicionar o e-mail que voc√™ vai fazer phishing**.

Agora vamos obter **credenciais para um aplicativo da web** usando o **ID de Cliente OAuth previamente criado**:

1. Volte para [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), uma op√ß√£o diferente aparecer√° desta vez.
2. Selecione **criar credenciais para um aplicativo da web**
3. Defina **origens Javascript** necess√°rias e **URIs de redirecionamento**
* Voc√™ pode definir em ambos algo como **`http://localhost:8000/callback`** para testes
4. Obtenha suas **credenciais de aplicativo**

Por fim, vamos **executar um aplicativo da web que usar√° as credenciais do aplicativo OAuth**. Voc√™ pode encontrar um exemplo em [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
V√° para **`http://localhost:8000`**, clique no bot√£o Login com Google, voc√™ ser√° **solicitado** com uma mensagem como esta:

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

O aplicativo mostrar√° o **token de acesso e de atualiza√ß√£o** que podem ser facilmente utilizados. Para mais informa√ß√µes sobre **como usar esses tokens, confira**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `gcloud`

√â poss√≠vel fazer algo usando o gcloud em vez do console web, confira:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch e Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
