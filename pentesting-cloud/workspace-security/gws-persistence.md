# GWS - Persistencia

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

{% hint style="danger" %}
Todas las acciones mencionadas en esta secci贸n que cambian la configuraci贸n generar谩n una **alerta de seguridad al correo electr贸nico e incluso una notificaci贸n push a cualquier m贸vil sincronizado** con la cuenta.
{% endhint %}

## **Persistencia en Gmail**

* Puedes crear **filtros para ocultar** notificaciones de seguridad de Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Esto evitar谩 que los correos electr贸nicos de seguridad lleguen al correo (pero no evitar谩 las notificaciones push al m贸vil)

<details>

<summary>Pasos para crear un filtro de gmail</summary>

(Instrucciones de [**aqu铆**](https://support.google.com/mail/answer/6579))

1. Abre [Gmail](https://mail.google.com/).
2. En el cuadro de b煤squeda en la parte superior, haz clic en Mostrar opciones de b煤squeda ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) .
3. Introduce tus criterios de b煤squeda. Si quieres comprobar que tu b煤squeda es correcta, mira qu茅 correos electr贸nicos aparecen haciendo clic en **Buscar**.&#x20;
4. En la parte inferior de la ventana de b煤squeda, haz clic en **Crear filtro**.
5. Elige lo que te gustar铆a que hiciera el filtro.
6. Haz clic en **Crear filtro**.

Revisa tu filtro actual (para eliminarlos) en [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

* Crea **una direcci贸n de reenv铆o para reenviar informaci贸n sensible** (o todo) - Necesitas acceso manual.
* Crea una direcci贸n de reenv铆o en [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* La direcci贸n receptora necesitar谩 confirmar esto
* Luego, configura para reenviar todos los correos electr贸nicos manteniendo una copia (recuerda hacer clic en guardar cambios):

<figure><img src="../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

Tambi茅n es posible crear filtros y reenviar solo correos electr贸nicos espec铆ficos a la otra direcci贸n de correo electr贸nico.

## Contrase帽as de aplicaciones

Si has logrado **comprometer una sesi贸n de usuario de Google** y el usuario ten铆a **2FA**, puedes **generar** una [**contrase帽a de aplicaci贸n**](https://support.google.com/accounts/answer/185833?hl=en) (sigue el enlace para ver los pasos). Ten en cuenta que **Google ya no recomienda las contrase帽as de aplicaciones y se revocan** cuando el usuario **cambia su contrase帽a de la cuenta de Google.**

**Incluso si tienes una sesi贸n abierta necesitar谩s conocer la contrase帽a del usuario para crear una contrase帽a de aplicaci贸n.**

{% hint style="info" %}
Las contrase帽as de aplicaciones **solo se pueden usar con cuentas que tienen la Verificaci贸n en 2 Pasos** activada.
{% endhint %}

## Cambiar 2-FA y similares

Tambi茅n es posible **desactivar 2-FA o inscribir un nuevo dispositivo** (o n煤mero de tel茅fono) en esta p谩gina [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Tambi茅n es posible generar llaves de paso (a帽adir tu propio dispositivo), cambiar la contrase帽a, a帽adir n煤meros m贸viles para tel茅fonos de verificaci贸n y recuperaci贸n, cambiar el correo electr贸nico de recuperaci贸n y cambiar las preguntas de seguridad).**

{% hint style="danger" %}
Para **evitar que las notificaciones push de seguridad** lleguen al tel茅fono del usuario, podr铆as **cerrar la sesi贸n de su smartphone** (aunque ser铆a extra帽o) porque no puedes volver a iniciar sesi贸n desde aqu铆.

Tambi茅n es posible **localizar el dispositivo.**
{% endhint %}

**Incluso si tienes una sesi贸n abierta necesitar谩s conocer la contrase帽a del usuario para cambiar estos ajustes.**

## Persistencia a trav茅s de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario,** simplemente puedes **aceptar** otorgar todos los permisos posibles a una **aplicaci贸n OAuth**. El 煤nico problema es que Workspace puede configurarse para **no permitir aplicaciones OAuth externas y/o internas sin revisar.**\
Es bastante com煤n que las Organizaciones de Workspace no conf铆en por defecto en aplicaciones OAuth externas pero s铆 en las internas, as铆 que si tienes **suficientes permisos para generar una nueva aplicaci贸n OAuth** dentro de la organizaci贸n y las aplicaciones externas no est谩n permitidas, gen茅rala y **usa esa nueva aplicaci贸n OAuth interna para mantener la persistencia**.

Consulta la siguiente p谩gina para m谩s informaci贸n sobre aplicaciones OAuth:

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persistencia a trav茅s de la delegaci贸n

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante (si se te permite hacer esto). En las **Organizaciones** de Workspace esta opci贸n debe estar **activada**. Puede estar desactivada para todos, activada para algunos usuarios/grupos o para todos (generalmente solo est谩 activada para algunos usuarios/grupos o completamente desactivada).

<details>

<summary>Si eres un administrador de Workspace revisa esto para activar la funci贸n</summary>

(Informaci贸n [copiada de la documentaci贸n](https://support.google.com/a/answer/7223765))

Como administrador de tu organizaci贸n (por ejemplo, tu trabajo o escuela), controlas si los usuarios pueden delegar acceso a su cuenta de Gmail. Puedes permitir que todos tengan la opci贸n de delegar su cuenta. O, solo permitir que personas en ciertos departamentos configuren la delegaci贸n. Por ejemplo, puedes:

* A帽adir un asistente administrativo como delegado en tu cuenta de Gmail para que puedan leer y enviar correos electr贸nicos en tu nombre.&#x20;
* A帽adir un grupo, como tu departamento de ventas, en Grupos como delegado para dar acceso a todos a una cuenta de Gmail.

Los usuarios solo pueden delegar acceso a otro usuario en la misma organizaci贸n, independientemente de su dominio o su unidad organizativa.

### L铆mites y restricciones de delegaci贸n&#x20;

* Opci贸n **Permitir a los usuarios otorgar acceso a su buz贸n a un grupo de Google**: Para usar esta opci贸n, debe estar habilitada para la OU de la cuenta delegada y para la OU de cada miembro del grupo. Los miembros del grupo que pertenecen a una OU sin esta opci贸n habilitada no pueden acceder a la cuenta delegada.
* Con un uso t铆pico, 40 usuarios delegados pueden acceder a una cuenta de Gmail al mismo tiempo. Un uso por encima del promedio por parte de uno o m谩s delegados podr铆a reducir este n煤mero.&#x20;
* Los procesos automatizados que acceden frecuentemente a Gmail tambi茅n podr铆an reducir el n煤mero de delegados que pueden acceder a una cuenta al mismo tiempo. Estos procesos incluyen APIs o extensiones de navegador que acceden a Gmail con frecuencia.
* Una sola cuenta de Gmail admite hasta 1,000 delegados 煤nicos. Un grupo en Grupos cuenta como un delegado hacia el l铆mite.
* La delegaci贸n no aumenta los l铆mites de una cuenta de Gmail. Las cuentas de Gmail con usuarios delegados tienen los l铆mites y pol铆ticas est谩ndar de una cuenta de Gmail. Para m谩s detalles, visita [L铆mites y pol铆ticas de Gmail](https://support.google.com/a/topic/28609).

### Paso 1: Activar la delegaci贸n de Gmail para tus usuarios&#x20;

**Antes de comenzar:** Para aplicar la configuraci贸n a ciertos usuarios, coloca sus cuentas en una [unidad organizativa](https://support.google.com/a/topic/1227584).

1.  [Inicia sesi贸n](https://admin.google.com/) en tu [Consola de administraci贸n de Google](https://support.google.com/a/answer/182076).

Inicia sesi贸n con una _cuenta de administrador_, no con tu cuenta actual CarlosPolop@gmail.com
2. En la Consola de administraci贸n, ve a Men煤 ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Aplicaciones**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Configuraci贸n de usuario**.
3. Para aplicar la configuraci贸n a todos, deja seleccionada la unidad organizativa superior. De lo contrario, selecciona una unidad organizativa hija.
4. Haz clic en **Delegaci贸n de correo**.
5. Marca la casilla **Permitir a los usuarios delegar acceso a su buz贸n a otros usuarios en el dominio**.
6. (Opcional) Para permitir a los usuarios especificar qu茅 informaci贸n del remitente se incluye en los mensajes delegados enviados desde su cuenta, marca la casilla **Permitir a los usuarios personalizar esta configuraci贸n**.
7. Selecciona una opci贸n para la informaci贸n del remitente predeterminada que se incluye en los mensajes enviados por los delegados:&#x20;
* **Mostrar al propietario de la cuenta y al delegado que envi贸 el correo electr贸nico**Los mensajes incluyen las direcciones de correo electr贸nico del propietario de la cuenta de Gmail y del delegado.
* **Mostrar solo al propietario de la cuenta**Los mensajes incluyen la direcci贸n de correo electr贸nico solo del propietario de la cuenta de Gmail. La direcci贸n de correo electr贸nico del delegado no se incluye.
8. (Opcional) Para permitir a los usuarios a帽adir un grupo en Grupos como delegado, marca la casilla **Permitir a los usuarios otorgar acceso a su buz贸n a un grupo de Google**.
9. Haz clic en **Guardar**. Si configuraste una unidad organizativa hija, podr铆as poder **Heredar** o **Sobrescribir** la configuraci贸n de una unidad organizativa padre.
10. (Opcional) Para activar la delegaci贸n de Gmail para otras unidades organizativas, repite los pasos del 3 al 9.

Los cambios pueden tardar hasta 24 horas pero normalmente ocurren m谩s r谩pidamente. [Aprende m谩s](https://support.google.com/a/answer/7514107)

### Paso 2: Haz que los usuarios configuren delegados para sus cuentas

Despu茅s de activar la delegaci贸n, tus usuarios van a su configuraci贸n de Gmail para asignar delegados. Los delegados pueden entonces leer, enviar y recibir mensajes en nombre del usuario. &#x20;

Para m谩s detalles, dirige a los usuarios a [Delegar y colaborar en el correo electr贸nico](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Desde un usuario regular, revisa aqu铆 las instrucciones para intentar delegar tu acceso</summary>

(Info copiada [**de la documentaci贸n**](https://support.google.com/mail/answer/138350))

Puedes a帽adir hasta 10 delegados.

Si est谩s usando Gmail a trav茅s de tu trabajo, escuela u otra organizaci贸n:

* Puedes a帽adir hasta 1000 delegados dentro de tu organizaci贸n.
* Con un uso t铆pico, 40 delegados pueden acceder a una cuenta de Gmail al mismo tiempo.&#x20;
* Si usas procesos automatizados, como APIs o extensiones de navegador, unos pocos delegados pueden acceder a una cuenta de Gmail al mismo tiempo.

1. En tu computadora, abre [Gmail](https://mail.google.com/). No puedes a帽adir delegados desde la aplicaci贸n de Gmail.
2. En la parte superior derecha, haz clic en Configuraci贸n ![Configuraci贸n](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![y luego](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Ver todas las configuraciones**.
3. Haz clic en la pesta帽a **Cuentas e Importaci贸n** o **Cuentas**.
4. En la secci贸n "Conceder acceso a tu cuenta", haz clic en **A帽adir otra cuenta**. Si est谩s usando Gmail a trav茅s de tu trabajo o escuela, tu organizaci贸n puede restringir la delegaci贸n de correo electr贸nico. Si no ves esta configuraci贸n, contacta a tu administrador.
* Si no ves Conceder acceso a tu cuenta, entonces est谩 restringido.
5.  Introduce la direcci贸n de correo electr贸nico de la persona que quieres a帽adir. Si est谩s usando Gmail a trav茅s de tu trabajo, escuela u otra organizaci贸n, y tu administrador lo permite, puedes introducir la direcci贸n de correo electr贸nico de un grupo. Este grupo debe tener el mismo dominio que tu organizaci贸n. Los miembros externos del grupo se les niega el acceso de delegaci贸n. \
\
**Importante:** Si la cuenta que delegas es una cuenta nueva o la contrase帽a fue restablecida, el Administrador debe desactivar el requisito de cambiar la contrase帽a cuando inicies sesi贸n por primera vez.

* [Aprende c贸mo un Administrador puede crear un usuario](https://support.google.com/a/answer/33310).
* [Aprende c贸mo un Administrador puede restablecer contrase帽as](https://support.google.com/a/answer/33319).

6\. Haz clic en **Siguiente paso** ![y luego](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Enviar correo electr贸nico para conceder acceso**.

La persona que a帽adiste recibir谩 un correo electr贸nico pidi茅ndole que confirme. La invitaci贸n caduca despu茅s de una semana.

Si a帽adiste un grupo, todos los miembros del grupo se convertir谩n en delegados sin necesidad de confirmar.&#x20;

Nota: Puede tardar hasta 24 horas para que la delegaci贸n comience a tener efecto.

</details>

## Persistencia a trav茅s de la aplicaci贸n Android

Si tienes una **sesi贸n dentro de la cuenta de Google de la v铆ctima** puedes navegar a la **Play Store** y podr铆as ser capaz de **instalar malware** que ya hayas subido a la tienda directamente **al tel茅fono** para mantener la persistencia y acceder al tel茅fono de la v铆ctima.

## **Persistencia a trav茅s de** App Scripts

Puedes crear **disparadores basados en tiempo** en App Scripts, as铆 que si el App Script es aceptado por el usuario, se **activar谩** incluso **sin que el usuario lo acceda**. Para m谩s informaci贸n sobre c贸mo hacer esto revisa:

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](g
