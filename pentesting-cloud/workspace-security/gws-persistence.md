# GWS - Persistencia

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

{% hint style="danger" %}
Todas las acciones mencionadas en esta secci√≥n que cambien la configuraci√≥n generar√°n una **alerta de seguridad al correo electr√≥nico e incluso una notificaci√≥n push a cualquier dispositivo m√≥vil sincronizado** con la cuenta.
{% endhint %}

## **Persistencia en Gmail**

* Puedes crear **filtros para ocultar** notificaciones de seguridad de Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Esto evitar√° que los correos de seguridad lleguen al correo electr√≥nico (pero no evitar√° las notificaciones push al dispositivo m√≥vil)

<details>

<summary> Pasos para crear un filtro en Gmail</summary>

(Instrucciones de [**aqu√≠**](https://support.google.com/mail/answer/6579))

1. Abre [Gmail](https://mail.google.com/).
2. En la caja de b√∫squeda en la parte superior, haz clic en Mostrar opciones de b√∫squeda ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) .
3. Ingresa tus criterios de b√∫squeda. Si deseas verificar que tu b√∫squeda funcion√≥ correctamente, mira qu√© correos electr√≥nicos aparecen haciendo clic en **Buscar**.&#x20;
4. En la parte inferior de la ventana de b√∫squeda, haz clic en **Crear filtro**.
5. Elige qu√© te gustar√≠a que haga el filtro.
6. Haz clic en **Crear filtro**.

Verifica tus filtros actuales (para eliminarlos) en [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

* Crea una **direcci√≥n de reenv√≠o para enviar informaci√≥n sensible** (o todo) - Necesitar√°s acceso manual.
* Crea una direcci√≥n de reenv√≠o en [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* La direcci√≥n receptora deber√° confirmar esto
* Luego, configura para reenviar todos los correos electr√≥nicos manteniendo una copia (recuerda hacer clic en guardar cambios):

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

Tambi√©n es posible crear filtros y reenviar solo correos electr√≥nicos espec√≠ficos a la otra direcci√≥n de correo electr√≥nico.

## Contrase√±as de aplicaciones

Si lograste **comprometer la sesi√≥n de un usuario de Google** y el usuario ten√≠a **2FA**, puedes **generar** una [**contrase√±a de aplicaci√≥n**](https://support.google.com/accounts/answer/185833?hl=es) (sigue el enlace para ver los pasos). Ten en cuenta que **Google ya no recomienda las contrase√±as de aplicaciones y las revoca** cuando el usuario **cambia su contrase√±a de la cuenta de Google.**

**Incluso si tienes una sesi√≥n abierta, necesitar√°s conocer la contrase√±a del usuario para crear una contrase√±a de aplicaci√≥n.**

{% hint style="info" %}
Las contrase√±as de aplicaciones solo se pueden usar con cuentas que tengan activada la **Verificaci√≥n en dos pasos**.
{% endhint %}

## Cambiar 2-FA y similares

Tambi√©n es posible **desactivar la 2-FA o inscribir un nuevo dispositivo** (o n√∫mero de tel√©fono) en esta p√°gina [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Tambi√©n es posible generar contrase√±as (agregar tu propio dispositivo), cambiar la contrase√±a, agregar n√∫meros de tel√©fono para verificar tel√©fonos y recuperaci√≥n, cambiar el correo electr√≥nico de recuperaci√≥n y cambiar las preguntas de seguridad).**

{% hint style="danger" %}
Para **evitar que las notificaciones de seguridad push** lleguen al tel√©fono del usuario, podr√≠as **cerrar la sesi√≥n de su smartphone** (aunque ser√≠a extra√±o) porque no puedes iniciar sesi√≥n nuevamente desde aqu√≠.

Tambi√©n es posible **localizar el dispositivo.**
{% endhint %}

**Incluso si tienes una sesi√≥n abierta, necesitar√°s conocer la contrase√±a del usuario para cambiar estas configuraciones.**

## Persistencia a trav√©s de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario**, simplemente puedes **aceptar** otorgar todos los permisos posibles a una **Aplicaci√≥n OAuth**. El √∫nico problema es que Workspace puede estar configurado para **prohibir aplicaciones OAuth externas y/o internas no revisadas.**\
Es bastante com√∫n que las Organizaciones de Workspace por defecto no conf√≠en en aplicaciones OAuth externas pero conf√≠en en las internas, por lo que si tienes **suficientes permisos para generar una nueva aplicaci√≥n OAuth** dentro de la organizaci√≥n y las aplicaciones externas est√°n prohibidas, gen√©rala y **utiliza esa nueva aplicaci√≥n OAuth interna para mantener la persistencia**.

Consulta la siguiente p√°gina para obtener m√°s informaci√≥n sobre las Aplicaciones OAuth:

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persistencia a trav√©s de delegaci√≥n

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante (si se te permite hacerlo). En las **Organizaciones** de Workspace esta opci√≥n debe estar **habilitada**. Puede estar deshabilitada para todos, habilitada para algunos usuarios/grupos o para todos (generalmente solo est√° habilitada para algunos usuarios/grupos o completamente deshabilitada).

<details>

<summary>Si eres un administrador de Workspace, verifica esto para habilitar la funci√≥n</summary>

(Informaci√≥n [copiada de la documentaci√≥n](https://support.google.com/a/answer/7223765))

Como administrador de tu organizaci√≥n (por ejemplo, tu trabajo o escuela), controlas si los usuarios pueden delegar el acceso a su cuenta de Gmail. Puedes permitir que todos tengan la opci√≥n de delegar su cuenta. O, solo permitir que las personas en ciertos departamentos configuren la delegaci√≥n. Por ejemplo, puedes:

* Agregar un asistente administrativo como delegado en tu cuenta de Gmail para que pueda leer y enviar correos electr√≥nicos en tu nombre.&#x20;
* Agregar un grupo, como tu departamento de ventas, en Grupos como delegado para dar acceso a todos a una cuenta de Gmail.

Los usuarios solo pueden delegar acceso a otro usuario en la misma organizaci√≥n, independientemente de su dominio o su unidad organizativa.

### L√≠mites y restricciones de delegaci√≥n&#x20;

* Opci√≥n **Permitir a los usuarios otorgar acceso a su buz√≥n a un grupo de Google**: Para usar esta opci√≥n, debe estar habilitada para la OU de la cuenta delegada y para la OU de cada miembro del grupo. Los miembros del grupo que pertenecen a una OU sin esta opci√≥n habilitada no pueden acceder a la cuenta delegada.
* Con un uso t√≠pico, 40 usuarios delegados pueden acceder a una cuenta de Gmail al mismo tiempo. Un uso superior al promedio por uno o m√°s delegados podr√≠a reducir este n√∫mero.&#x20;
* Los procesos automatizados que acceden con frecuencia a Gmail tambi√©n podr√≠an reducir el n√∫mero de delegados que pueden acceder a una cuenta al mismo tiempo. Estos procesos incluyen API o extensiones de navegador que acceden con frecuencia a Gmail.
* Una sola cuenta de Gmail admite hasta 1,000 delegados √∫nicos. Un grupo en Grupos cuenta como un delegado hacia el l√≠mite.
* La delegaci√≥n no aumenta los l√≠mites de una cuenta de Gmail. Las cuentas de Gmail con usuarios delegados tienen los l√≠mites y pol√≠ticas est√°ndar de una cuenta de Gmail. Para m√°s detalles, visita [L√≠mites y pol√≠ticas de Gmail](https://support.google.com/a/topic/28609).
### Paso 1: Activar la delegaci√≥n de Gmail para tus usuarios&#x20;

**Antes de comenzar:** Para aplicar la configuraci√≥n para ciertos usuarios, coloca sus cuentas en una [unidad organizativa](https://support.google.com/a/topic/1227584).

1.  [Inicia sesi√≥n](https://admin.google.com/) en tu [consola de administraci√≥n de Google](https://support.google.com/a/answer/182076).

Inicia sesi√≥n utilizando una _cuenta de administrador_, no tu cuenta actual CarlosPolop@gmail.com
2. En la consola de administraci√≥n, ve a Men√∫ ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Aplicaciones**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Configuraci√≥n de usuario**.
3. Para aplicar la configuraci√≥n a todos, deja seleccionada la unidad organizativa superior. De lo contrario, selecciona una [unidad organizativa](https://support.google.com/a/topic/1227584) secundaria.
4. Haz clic en **Delegaci√≥n de correo**.
5. Marca la casilla **Permitir que los usuarios deleguen acceso a su buz√≥n a otros usuarios del dominio**.
6. (Opcional) Para permitir que los usuarios especifiquen qu√© informaci√≥n del remitente se incluye en los mensajes delegados enviados desde su cuenta, marca la casilla **Permitir a los usuarios personalizar esta configuraci√≥n**.
7. Selecciona una opci√≥n para la informaci√≥n del remitente predeterminada que se incluir√° en los mensajes enviados por los delegados:&#x20;
* **Mostrar el propietario de la cuenta y el delegado que envi√≥ el correo electr√≥nico**‚ÄîLos mensajes incluyen las direcciones de correo electr√≥nico del propietario de la cuenta de Gmail y del delegado.
* **Mostrar solo el propietario de la cuenta**‚ÄîLos mensajes incluyen la direcci√≥n de correo electr√≥nico solo del propietario de la cuenta de Gmail. La direcci√≥n de correo electr√≥nico del delegado no se incluye.
8. (Opcional) Para permitir que los usuarios agreguen un grupo en Grupos como delegado, marca la casilla **Permitir a los usuarios otorgar acceso a su buz√≥n a un grupo de Google**.
9. Haz clic en **Guardar**. Si configuraste una unidad organizativa secundaria, es posible que puedas **Heredar** o **Anular** la configuraci√≥n de una unidad organizativa principal.
10. (Opcional) Para activar la delegaci√≥n de Gmail para otras unidades organizativas, repite los pasos 3‚Äì9.

Los cambios pueden tardar hasta 24 horas, pero generalmente ocurren m√°s r√°pidamente. [M√°s informaci√≥n](https://support.google.com/a/answer/7514107)

### Paso 2: Hacer que los usuarios configuren delegados para sus cuentas

Despu√©s de activar la delegaci√≥n, tus usuarios van a la configuraci√≥n de Gmail para asignar delegados. Los delegados pueden leer, enviar y recibir mensajes en nombre del usuario. &#x20;

Para m√°s detalles, dirige a los usuarios a [Delegar y colaborar en correos electr√≥nicos](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Desde un usuario regular, verifica aqu√≠ las instrucciones para intentar delegar tu acceso</summary>

(Informaci√≥n copiada [**de la documentaci√≥n**](https://support.google.com/mail/answer/138350))

Puedes agregar hasta 10 delegados.

Si est√°s usando Gmail a trav√©s de tu trabajo, escuela u otra organizaci√≥n:

* Puedes agregar hasta 1000 delegados dentro de tu organizaci√≥n.
* Con un uso t√≠pico, 40 delegados pueden acceder a una cuenta de Gmail al mismo tiempo.&#x20;
* Si utilizas procesos automatizados, como APIs o extensiones de navegador, unos pocos delegados pueden acceder a una cuenta de Gmail al mismo tiempo.

1. En tu computadora, abre [Gmail](https://mail.google.com/). No puedes agregar delegados desde la aplicaci√≥n de Gmail.
2. En la esquina superior derecha, haz clic en Configuraci√≥n ![Configuraci√≥n](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![y luego](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Ver todas las configuraciones**.
3. Haz clic en la pesta√±a **Cuentas e importaci√≥n** o **Cuentas**.
4. En la secci√≥n "Conceder acceso a tu cuenta", haz clic en **Agregar otra cuenta**. Si est√°s usando Gmail a trav√©s de tu trabajo o escuela, tu organizaci√≥n puede restringir la delegaci√≥n de correo electr√≥nico. Si no ves esta configuraci√≥n, contacta a tu administrador.
* Si no ves Conceder acceso a tu cuenta, entonces est√° restringido.
5. Ingresa la direcci√≥n de correo electr√≥nico de la persona que deseas agregar. Si est√°s usando Gmail a trav√©s de tu trabajo, escuela u otra organizaci√≥n, y tu administrador lo permite, puedes ingresar la direcci√≥n de correo electr√≥nico de un grupo. Este grupo debe tener el mismo dominio que tu organizaci√≥n. Los miembros externos del grupo no tienen acceso a la delegaci√≥n. \
\
**Importante:** Si la cuenta que delegas es una cuenta nueva o se restableci√≥ la contrase√±a, el administrador debe desactivar el requisito de cambiar la contrase√±a cuando inicies sesi√≥n por primera vez.

* [Aprende c√≥mo un administrador puede crear un usuario](https://support.google.com/a/answer/33310).
* [Aprende c√≥mo un administrador puede restablecer contrase√±as](https://support.google.com/a/answer/33319).

6\. Haz clic en **Siguiente paso** ![y luego](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Enviar correo electr√≥nico para conceder acceso**.

La persona que agregaste recibir√° un correo electr√≥nico pidi√©ndole que confirme. La invitaci√≥n caduca despu√©s de una semana.

Si agregaste un grupo, todos los miembros del grupo se convertir√°n en delegados sin necesidad de confirmar.&#x20;

Nota: Puede tardar hasta 24 horas en que la delegaci√≥n comience a surtir efecto.

</details>

## Persistencia a trav√©s de la aplicaci√≥n de Android

Si tienes una **sesi√≥n dentro de la cuenta de Google de las v√≠ctimas** puedes navegar a la **Play Store** y podr√≠as ser capaz de **instalar malware** que ya has subido a la tienda directamente **en el tel√©fono** para mantener la persistencia y acceder al tel√©fono de las v√≠ctimas.

## **Persistencia a trav√©s de** Scripts de Aplicaciones

Puedes crear **disparadores basados en el tiempo** en Scripts de Aplicaciones, por lo que si el Script de Aplicaci√≥n es aceptado por el usuario, se **activar√°** incluso **sin que el usuario lo acceda**. Para obtener m√°s informaci√≥n sobre c√≥mo hacer esto, consulta:

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](gws-google-platforms-phishing/gws-app-scripts.md)
{% endcontent-ref %}

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de Github.

</details>
