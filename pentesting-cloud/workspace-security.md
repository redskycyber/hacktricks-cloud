# Pentesting de Workspace

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Phishing en Workspace

### Metodolog铆a de Phishing Gen茅rico

### Phishing en Google Groups

Aparentemente, de forma predeterminada en los miembros de Workspace [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electr贸nico que se enviar谩 al usuario **agregando algunos enlaces**. El **correo electr贸nico vendr谩 de una direcci贸n de Google**, por lo que parecer谩 **leg铆timo** y es posible que las personas hagan clic en el enlace.

### Phishing en Hangouts

Es posible que puedas hablar directamente con una persona solo teniendo su direcci贸n de correo electr贸nico o enviar una invitaci贸n para hablar. De cualquier manera, puedes modificar una cuenta de correo electr贸nico, tal vez nombr谩ndola "Seguridad de Google" y agregando algunos logotipos de Google, y las personas pensar谩n que est谩n hablando con Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **misma t茅cnica** se puede utilizar con **Google Chat**.

### Phishing en Google Docs

Puedes crear un **documento aparentemente leg铆timo** y en un comentario **mencionar alg煤n correo electr贸nico (como +usuario@gmail.com)**. Google **enviar谩 un correo electr贸nico a esa direcci贸n de correo electr贸nico** notificando que fueron mencionados en el documento. Puedes **poner un enlace en ese documento** para intentar hacer que la persona acceda a 茅l.

### Phishing en Google Calendar

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo electr贸nico de la empresa que est谩s atacando como tengas. Programa este evento de calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca leg铆timo y **pon un comentario indicando que necesitan leer algo** (con el **enlace de phishing**).\
Para que parezca menos sospechoso:

* Config煤ralo para que **los destinatarios no puedan ver a las dem谩s personas invitadas**
* **NO env铆es correos electr贸nicos notificando sobre el evento**. Entonces, las personas solo ver谩n su advertencia sobre una reuni贸n en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, utilizando la API, puedes establecer en **Verdadero** que **las personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

### Phishing de OAuth

Cualquiera de las t茅cnicas anteriores se puede utilizar para hacer que el usuario acceda a una **aplicaci贸n de OAuth de Google** que solicitar谩 al usuario alg煤n **acceso**. Si el usuario **conf铆a** en la **fuente**, es posible que **conf铆e** en la **aplicaci贸n** (incluso si est谩 solicitando permisos de alto nivel).

Ten en cuenta que Google presenta un mensaje de advertencia poco atractivo que indica que la aplicaci贸n no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones de OAuth. M谩s informaci贸n sobre esto en la secci贸n de OAuth.

## Password Spraying

Para probar contrase帽as con todos los correos electr贸nicos que encontraste (o que has generado en funci贸n de un patr贸n de nombre de correo electr贸nico que hayas descubierto), puedes usar una herramienta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que utilizar谩 AWS lambdas para cambiar la direcci贸n IP.

## Aplicaciones de OAuth

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Cuando se crea una aplicaci贸n para **actuar en nombre de otros usuarios**, el desarrollador debe crear una **aplicaci贸n de OAuth dentro de GCP** e indicar los alcances (permisos) que la aplicaci贸n necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicaci贸n**, se le pedir谩 que **acepte** que la aplicaci贸n tendr谩 acceso a sus datos especificados en los alcances.

Esta es una forma muy interesante de **phishing** a usuarios no t茅cnicos para que utilicen **aplicaciones que acceden a informaci贸n sensible**, porque es posible que no comprendan las consecuencias. Sin embargo, en las cuentas de las organizaciones, hay formas de evitar que esto suceda.

### Mensaje de aplicaci贸n no verificada

Como se mencion贸, Google siempre presentar谩 un **mensaje al usuario para que acepte** los permisos que est谩 otorgando a la aplicaci贸n en su nombre. Sin embargo, si la aplicaci贸n se considera **peligrosa**, Google mostrar谩 **primero** un **mensaje** que indica que es **peligrosa** y **dificulta m谩s** que el usuario otorgue los permisos a la aplicaci贸n.

Este mensaje aparece en aplicaciones que:

* Utilizan cualquier alcance que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (las aplicaciones > 100 tambi茅n requieren un proceso de revisi贸n para dejar de mostrar el mensaje de no verificada)

### Alcances interesantes

[**Aqu铆**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los alcances de OAuth de Google.

* **cloud-platform**: Ver y administrar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **directory.readonly**: Ver y descargar el directorio de GSuite de tu organizaci贸n. Obt茅n nombres, tel茅fonos, URL de calendario de todos los usuarios.

## Scripts de Aplicaciones

Los desarrolladores pueden crear Scripts de Aplicaciones y configurarlos como un proyecto independiente o vincularlos a Google Docs/Sheets/Slides/Forms. Los Scripts de Aplicaciones son c贸digo que se activar谩 cuando un usuario con permisos de editor acceda al documento (y despu茅s de aceptar el mensaje de OAuth)

Sin embargo, incluso si la aplicaci贸n no est谩 verificada, hay un par de formas de no mostrar ese mensaje:

* Si el editor de la aplicaci贸n est谩 en el mismo Workspace que el usuario que accede a ella
* Si el script est谩 en una unidad del usuario
### Bypass de la solicitud de copia de documento no verificado

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder a 茅l, Google te preguntar谩 si quieres **generar una copia del documento**.

{% hint style="warning" %}
Si alguien crea una **copia** de ese **documento** que **contiene el App Script**, tambi茅n estar谩 **copiando el App Script**, por lo tanto, cuando **abre** la **hoja de c谩lculo copiada**, aparecer谩 la **solicitud regular de OAuth**, **burlando la solicitud no verificada**, porque **el usuario ahora es el autor del App Script del archivo copiado**.
{% endhint %}

Este m茅todo tambi茅n puede eludir la restricci贸n del administrador de Workspace:

Pero se puede prevenir con:

### Bypass de la solicitud no verificada de documento compartido

Adem谩s, si alguien te **comparte** un documento con **acceso de editor**, puedes generar **App Scripts dentro del documento** y el **PROPIETARIO (creador) del documento ser谩 el propietario del App Script**.

{% hint style="warning" %}
Esto significa que el **creador del documento aparecer谩 como creador de cualquier App Script** que cualquier persona con acceso de editor cree dentro de 茅l.

Esto tambi茅n significa que el **App Script ser谩 confiable para el entorno de Workspace** del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto tambi茅n significa que si ya exist铆a un **App Script** y las personas han **concedido acceso**, cualquier persona con permiso de **Editor** en el documento puede **modificarlo y abusar de ese acceso**.\
Para abusar de esto, tambi茅n necesitas que las personas activen el App Script. Y un truco interesante es **publicar el script como una aplicaci贸n web**. Cuando las **personas** que ya han **concedido acceso** al App Script accedan a la p谩gina web, **activar谩n el App Script** (esto tambi茅n funciona usando etiquetas `<img>`).
{% endhint %}

## Post-Explotaci贸n

### Google Groups Privesc

De forma predeterminada, en Workspace un **grupo** puede ser **accedido libremente** por cualquier miembro de la organizaci贸n.\
Workspace tambi茅n permite **conceder permisos a grupos** (incluso permisos de GCP), por lo que si los grupos pueden unirse y tienen permisos adicionales, un atacante puede **abusar de esa ruta para escalar privilegios**.

Potencialmente necesitas acceso a la consola para unirte a grupos que permitan unirse a cualquier persona en la organizaci贸n. Verifica la informaci贸n de los grupos en [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoteo de GWS a GCP

* Abusando de la **escalada de privilegios de grupos de Google**, es posible escalar a un grupo con alg煤n tipo de acceso privilegiado a GCP.
* Abusando de las **aplicaciones OAuth**, es posible suplantar a los usuarios y acceder a GCP en su nombre.

### Pivoteo de GCP a GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acceso a informaci贸n de correo de grupos

Si logras **comprometer una sesi贸n de usuario de Google**, desde [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) puedes ver el historial de correos enviados a los grupos de correo de los que el usuario es miembro, y podr铆as encontrar **credenciales** u otros **datos sensibles**.

### Takeout: Descargar todo lo que Google sabe sobre una cuenta

Si tienes una **sesi贸n dentro de la cuenta de Google de la v铆ctima**, puedes descargar todo lo que Google guarda sobre esa cuenta desde [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault: Descargar todos los datos de Workspace de los usuarios

Si una organizaci贸n tiene **Google Vault habilitado**, es posible acceder a [**https://vault.google.com**](https://vault.google.com/u/1/) y **descargar** toda la **informaci贸n**.

### Descarga de contactos

Desde [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) puedes descargar todos los **contactos** del usuario.

### Cloudsearch

En [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) puedes buscar **a trav茅s de todo el contenido de Workspace** (correo electr贸nico, Drive, sitios...) al que un usuario tiene acceso. Ideal para **encontrar r谩pidamente informaci贸n sensible**.

### Currents

En [**https://currents.google.com/**](https://currents.google.com) puedes acceder a un **Chat de Google**, por lo que podr铆as encontrar informaci贸n sensible all铆.

### Miner铆a de Google Drive

Cuando **compartes** un documento, puedes **especificar** las **personas** que pueden acceder a 茅l una por una, **compartirlo** con toda tu **empresa** (**o** con algunos **grupos** espec铆ficos) generando un enlace.

Al compartir un documento, en la configuraci贸n avanzada tambi茅n puedes **permitir que las personas busquen** este archivo (por **defecto**, esto est谩 **desactivado**). Sin embargo, es importante tener en cuenta que una vez que los usuarios ven un documento, pueden buscarlo.

Por simplicidad, la mayor铆a de las personas generar谩n y compartir谩n un enlace en lugar de agregar a las personas que pueden acceder al documento una por una.

Algunas formas propuestas de encontrar todos los documentos:

* Buscar en el chat interno, foros...
* **Rastrear** documentos conocidos buscando **referencias** a otros documentos. Puedes hacer esto dentro de un App Script con [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

En [**https://keep.google.com/**](https://keep.google.com) puedes acceder a las notas del usuario, aqu铆 podr铆a haber **informaci贸n sensible** guardada.

### Persistencia dentro de una cuenta de Google

Si logras **comprometer una sesi贸n de usuario de Google** y el usuario tiene **2FA**, puedes **generar** una [**contrase帽a de aplicaci贸n**](https://support.google.com/accounts/answer/185833?hl=en) y **regenerar los c贸digos de respaldo de 2FA** para asegurarte de que incluso si el usuario cambia la contrase帽a, **podr谩s acceder a su cuenta**. Otra opci贸n, **en lugar** de **regenerar** los c贸digos, es **inscribir tu propia aplicaci贸n de autenticaci贸n** en el 2FA.

### Persistencia a trav茅s de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario**, simplemente puedes **aceptar** otorgar todos los permisos posibles a una **aplicaci贸n OAuth**. El 煤nico problema es que Workspace puede estar configurado para **no permitir aplicaciones OAuth externas y/o internas no revisadas**.\
Es bastante com煤n no confiar por defecto en las aplicaciones OAuth externas pero confiar en las internas, por lo que si tienes **suficientes permisos para generar una nueva aplicaci贸n OAuth** dentro de la organizaci贸n y las aplicaciones externas est谩n deshabilitadas, genera una y **utiliza esa nueva aplicaci贸n OAuth interna para mantener la persistencia**.
### Persistencia mediante delegaci贸n

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante.

### Persistencia mediante la aplicaci贸n de Android

Si tienes una **sesi贸n dentro de la cuenta de Google de la v铆ctima**, puedes navegar hasta la **Play Store** e **instalar malware** que ya has subido directamente **al tel茅fono** para mantener la persistencia y acceder al tel茅fono de la v铆ctima.

### **Persistencia mediante Gmail**

* Puedes crear **filtros para ocultar** las notificaciones de seguridad de Google.
* from: (no-reply@accounts.google.com) "Alerta de seguridad"
* Ocultar correos electr贸nicos de restablecimiento de contrase帽a.
* Crear una **direcci贸n de reenv铆o para enviar informaci贸n sensible** (o todo) - Necesitas acceso manual.
* Crear una direcci贸n de reenv铆o para enviar correos electr贸nicos que contengan la palabra "contrase帽a", por ejemplo.
* Agregar una direcci贸n de correo electr贸nico/tel茅fono de recuperaci贸n bajo el control del atacante.

### **Persistencia mediante App Scripts**

Puedes crear **disparadores basados en el tiempo** en App Scripts, por lo que si el App Script es aceptado por el usuario, se **activar谩** incluso **sin que el usuario lo acceda**.

La documentaci贸n menciona que para usar `ScriptApp.newTrigger("funcion")` necesitas el **alcance** `script.scriptapp`, pero **aparentemente eso no es necesario** siempre y cuando hayas declarado alg煤n otro alcance.

### **Administrar Workspace**

En [**https://admin.google.com**/](https://admin.google.com), es posible que puedas modificar la configuraci贸n de Workspace de toda la organizaci贸n si tienes suficientes permisos.

Tambi茅n puedes encontrar correos electr贸nicos buscando en todas las facturas de los usuarios en [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recuperaci贸n de una cuenta comprometida

* Cerrar sesi贸n en todas las sesiones.
* Cambiar la contrase帽a del usuario.
* Generar nuevos c贸digos de respaldo de 2FA.
* Eliminar contrase帽as de aplicaciones.
* Eliminar aplicaciones de OAuth.
* Eliminar dispositivos de 2FA.
* Eliminar reenviadores de correo electr贸nico.
* Eliminar filtros de correos electr贸nicos.
* Eliminar direcciones de correo electr贸nico/tel茅fonos de recuperaci贸n.
* Eliminar aplicaciones de Android maliciosas.
* Eliminar delegaciones de cuentas maliciosas.

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
