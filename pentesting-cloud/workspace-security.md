# Seguridad de Workspace

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de Workspace

### Metodolog铆a de Phishing Gen茅rica

### Phishing de Grupos de Google

Aparentemente, por defecto en los miembros de Workspace [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electr贸nico que se enviar谩 al usuario **a帽adiendo algunos enlaces**. El **correo electr贸nico vendr谩 de una direcci贸n de Google**, por lo que parecer谩 **leg铆timo** y la gente podr铆a hacer clic en el enlace.

### Phishing de Hangouts

Es posible que puedas hablar directamente con una persona solo teniendo su direcci贸n de correo electr贸nico o enviar una invitaci贸n para hablar. De cualquier manera, puedes modificar una cuenta de correo electr贸nico tal vez nombr谩ndola "Seguridad de Google" y agregando algunos logotipos de Google, y la gente pensar谩 que est谩 hablando con Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **misma t茅cnica** se puede usar con **Google Chat**.

### Phishing de Documentos de Google

Puedes crear un **documento aparentemente leg铆timo** y en un comentario **mencionar alg煤n correo electr贸nico (como +usuario@gmail.com)**. Google **enviar谩 un correo electr贸nico a esa direcci贸n de correo electr贸nico** notificando que fueron mencionados en el documento. Puedes **poner un enlace en ese documento** para intentar hacer que la persona lo acceda.

### Phishing de Calendario de Google

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo electr贸nico de la empresa que est谩s atacando como tengas. Programa este evento de calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca leg铆timo y **pon un comentario indicando que necesitan leer algo** (con el **enlace de phishing**).\
Para que parezca menos sospechoso:

* Config煤ralo para que **los destinatarios no puedan ver a las dem谩s personas invitadas**
* **NO env铆es correos electr贸nicos notificando sobre el evento**. Entonces, las personas solo ver谩n su advertencia sobre una reuni贸n en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, utilizando la API, puedes establecer que **las personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

### Phishing de OAuth

Cualquiera de las t茅cnicas anteriores puede ser utilizada para hacer que el usuario acceda a una **aplicaci贸n de Google OAuth** que solicitar谩 al usuario alg煤n **acceso**. Si el usuario **conf铆a** en la **fuente**, podr铆a **confiar** en la **aplicaci贸n** (incluso si est谩 solicitando permisos de alta privilegiados).

Tenga en cuenta que Google presenta una ventana emergente fea que advierte que la aplicaci贸n no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones de OAuth. M谩s sobre esto en la secci贸n de OAuth.

## Password Spraying

Para probar contrase帽as con todos los correos electr贸nicos que encontraste (o que has generado en funci贸n de un patr贸n de nombre de correo electr贸nico que puedas haber descubierto), puedes usar una herramienta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que utilizar谩 AWS lambdas para cambiar la direcci贸n IP.

## Aplicaciones de OAuth

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicaci贸n para **actuar en nombre de otros usuarios**, el desarrollador debe crear una **aplicaci贸n OAuth dentro de GCP** e indicar los 谩mbitos (permisos) que la aplicaci贸n necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicaci贸n**, se le **pedir谩** que **acepte** que la aplicaci贸n tendr谩 acceso a sus datos especificados en los 谩mbitos.

Esta es una forma muy jugosa de **phishing** a usuarios no t茅cnicos para que usen **aplicaciones que acceden a informaci贸n sensible** porque podr铆an no entender las consecuencias. Sin embargo, en las cuentas de las organizaciones, hay formas de evitar que esto suceda.

### Ventana emergente de aplicaci贸n no verificada

Como se mencion贸, Google siempre presentar谩 una **ventana emergente al usuario para aceptar** los permisos que est谩n dando a la aplicaci贸n en su nombre. Sin embargo, si se considera que la aplicaci贸n es **peligrosa**, Google mostrar谩 **primero** una **ventana emergente** indicando que es **peligrosa** y **haciendo m谩s dif铆cil** que el usuario otorgue los permisos a la aplicaci贸n.

Esta ventana emergente aparece en aplicaciones que:

* Usan cualquier 谩mbito que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (para aplicaciones > 100 tambi茅n se necesita un proceso de revisi贸n para dejar de mostrar la ventana emergente no verificada)

### mbitos interesantes

[**Aqu铆**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los 谩mbitos de Google OAuth.

* **cloud-platform**: Ver y administrar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **directory.readonly**: Ver y descargar el directorio de GSuite de tu organizaci贸n. Obt茅n nombres, tel茅fonos, URL de calendario de todos los usuarios.

## Scripts de aplicaciones

Los desarrolladores pueden crear Scripts de aplicaciones y configurarlos como un proyecto independiente o vincularlos a Google Docs/Sheets/Slides/Forms. Los Scripts de aplicaciones son c贸digo que se activar谩 cuando un usuario con permiso de editor acceda al documento (y despu茅s de aceptar la ventana emergente de OAuth)

Sin embargo, incluso si la aplicaci贸n no est谩 verificada, hay un par de formas de no mostrar esa ventana emergente:

* Si el editor de la aplicaci贸n est谩 en el mismo Workspace que el usuario que la est谩 utilizando
* Si el script est谩 en una unidad del usuario

### Bypass de ventana emergente no verificada de copia de documento

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder, Google te preguntar谩 si quieres **generar una copia del documento.**

{% hint style="warning" %}
Si alguien crea una **copia** de ese **documento** que **conten铆a el Script de aplicaci贸n**, tambi茅n estar谩 **copiando el Script de aplicaci贸n**, por lo que cuando **abra** la **hoja de c谩lculo copiada**, aparecer谩 la **ventana emergente de OAuth regular** **bypassing la ventana emergente no verificada**, porque **el usuario es ahora el autor del Script de aplicaci贸n del archivo copiado**.
{% endhint %}

Este m茅todo tambi茅n podr谩 evitar la restricci贸n del administrador de Workspace:

Pero se puede prevenir con:
### Bypass de la verificaci贸n de documentos compartidos

Adem谩s, si alguien te comparte un documento con acceso de editor, puedes generar Scripts de aplicaciones dentro del documento y el propietario (creador) del documento ser谩 el propietario del Script de la aplicaci贸n.

{% hint style="warning" %}
Esto significa que el creador del documento aparecer谩 como creador de cualquier Script de la aplicaci贸n que cualquier persona con acceso de editor cree dentro de 茅l.

Esto tambi茅n significa que el Script de la aplicaci贸n ser谩 confiable por el entorno de Workspace del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto tambi茅n significa que si ya exist铆a un Script de la aplicaci贸n y las personas han otorgado acceso, cualquier persona con permiso de editor en el documento puede modificarlo y abusar de ese acceso. Para abusar de esto, tambi茅n necesitas que las personas activen el Script de la aplicaci贸n. Y un truco ingenioso es publicar el script como una aplicaci贸n web. Cuando las personas que ya han otorgado acceso al Script de la aplicaci贸n acceden a la p谩gina web, activar谩n el Script de la aplicaci贸n (esto tambi茅n funciona usando etiquetas `<img>`).
{% endhint %}

## Post-Explotaci贸n

### Google Groups Privesc

Por defecto en Workspace, un grupo puede ser accedido libremente por cualquier miembro de la organizaci贸n. Workspace tambi茅n permite otorgar permisos a grupos (incluso permisos de GCP), por lo que si los grupos pueden unirse y tienen permisos adicionales, un atacante puede abusar de ese camino para escalar privilegios.

Potencialmente necesitas acceso a la consola para unirte a grupos que permiten unirse a cualquier persona en la organizaci贸n. Verifica la informaci贸n de los grupos en [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Privesc a GCP Resumen

* Abusando del privesc de grupos de Google, podr铆as ser capaz de escalar a un grupo con alg煤n tipo de acceso privilegiado a GCP.
* Abusando de las aplicaciones OAuth, podr铆as ser capaz de suplantar a los usuarios y acceder a GCP en su nombre.

### Acceso a la informaci贸n de los grupos de correo

Si lograste comprometer una sesi贸n de usuario de Google, desde [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) puedes ver el historial de correos enviados a los grupos de correo de los que el usuario es miembro, y podr铆as encontrar credenciales u otros datos sensibles.

### Takeout - Descarga todo lo que Google sabe sobre una cuenta

Si tienes una sesi贸n dentro de la cuenta de Google de la v铆ctima, puedes descargar todo lo que Google guarda sobre esa cuenta desde [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Descarga todos los datos de Workspace de los usuarios

Si una organizaci贸n tiene habilitado Google Vault, podr铆as ser capaz de acceder a [**https://vault.google.com**](https://vault.google.com/u/1/) y descargar toda la informaci贸n.

### Descarga de contactos

Desde [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) puedes descargar todos los contactos del usuario.

### Cloudsearch

En [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) puedes buscar a trav茅s de todo el contenido de Workspace (correo electr贸nico, drive, sitios...) al que un usuario tiene acceso. Ideal para encontrar r谩pidamente informaci贸n sensible.

### Currents

En [**https://currents.google.com/**](https://currents.google.com) puedes acceder a un chat de Google, por lo que podr铆as encontrar informaci贸n sensible all铆.

### Miner铆a de Google Drive

Cuando compartes un documento, puedes especificar las personas que pueden acceder a 茅l una por una, compartirlo con toda tu empresa (o con algunos grupos espec铆ficos) generando un enlace.

Al compartir un documento, en la configuraci贸n avanzada tambi茅n puedes permitir que las personas busquen este archivo (por defecto esto est谩 desactivado). Sin embargo, es importante tener en cuenta que una vez que los usuarios ven un documento, pueden buscarlo.

Por simplicidad, la mayor铆a de las personas generar谩n y compartir谩n un enlace en lugar de agregar a las personas que pueden acceder al documento una por una.

Algunas formas propuestas de encontrar todos los documentos:

* Buscar en el chat interno, foros...
* Spider de documentos conocidos buscando referencias a otros documentos. Puedes hacer esto dentro de un Script de aplicaci贸n con [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

En [**https://keep.google.com/**](https://keep.google.com) puedes acceder a las notas del usuario, informaci贸n sensible podr铆a estar guardada aqu铆.

### Persistencia dentro de una cuenta de Google

Si lograste comprometer una sesi贸n de usuario de Google y el usuario ten铆a 2FA, puedes generar una [**contrase帽a de aplicaci贸n**](https://support.google.com/accounts/answer/185833?hl=en) y regenerar los c贸digos de respaldo de 2FA para saber que incluso si el usuario cambia la contrase帽a, podr谩s acceder a su cuenta. Otra opci贸n en lugar de regenerar los c贸digos es inscribir tu propia aplicaci贸n de autenticador en el 2FA.

### Persistencia a trav茅s de aplicaciones OAuth

Si has comprometido la cuenta de un usuario, simplemente puedes aceptar otorgar todos los permisos posibles a una aplicaci贸n OAuth. El 煤nico problema es que Workspace puede configurarse para no permitir aplicaciones OAuth externas y/o internas no revisadas. Es bastante com煤n no confiar por defecto en las aplicaciones OAuth externas pero confiar en las internas, por lo que si tienes suficientes permisos para generar una nueva aplicaci贸n OAuth dentro de la organizaci贸n y las aplicaciones externas est谩n deshabilitadas, gen茅rala y usa esa nueva aplicaci贸n OAuth interna para mantener la persistencia.

### Persistencia a trav茅s de la delegaci贸n

Simplemente puedes delegar la cuenta a una cuenta diferente controlada por el atacante.

### Persistencia a trav茅s de la aplicaci贸n Android

Si tienes una sesi贸n dentro de la cuenta de Google de la v铆ctima, puedes navegar hasta la Play Store e instalar malware que ya has cargado directamente en el tel茅fono para mantener la persistencia y acceder al tel茅fono de la v铆ctima.

### **Persistencia a trav茅s de Gmail**

* Puedes crear filtros para ocultar las notificaciones de seguridad de Google
  * from: (no-reply@accounts.google.com) "Security Alert"
  * Ocultar correos electr贸nicos de restablecimiento de contrase帽a
* Crear una direcci贸n de reenv铆o para reenviar informaci贸n sensible (o todo) - Necesitas acceso manual.
  * Crea una direcci贸n de reenv铆o para enviar correos electr贸nicos que contengan la palabra "contrase帽a", por ejemplo.
* Agregar correo electr贸nico/tel茅fono de recuperaci贸n bajo el control del atacante

### **Persistencia a trav茅s de Scripts de aplicaciones**

Puedes crear disparadores basados en el tiempo en Scripts de aplicaciones, por lo que si el usuario acepta el Script de la aplicaci贸n, se activar谩 incluso sin que el usuario lo acceda.

Los documentos mencionan que para usar `ScriptApp.newTrigger("funcion")` necesitas el alcance `script.scriptapp`, pero aparentemente eso no es necesario siempre y cuando hayas declarado alg煤n otro alcance.

### **Administrar Workspace**

En [**https://admin.google.com**/](https://admin.google.com), podr铆as ser capaz de modificar la configuraci贸n de Workspace de toda la organizaci贸n si tienes suficientes permisos.

Tambi茅n puedes encontrar correos electr贸nicos buscando en todas las facturas de los usuarios en [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recuperaci贸n de cuenta comprometida

* Cerrar sesi贸n en todas las sesiones
* Cambiar la contrase帽a del usuario
* Generar nuevos c贸digos de respaldo de 2FA
* Eliminar contrase帽as de aplicaciones
* Eliminar aplicaciones OAuth
* Eliminar dispositivos 2FA
* Eliminar reenviadores de correo electr贸nico
* Eliminar filtros de correo electr贸nico
* Eliminar correo electr贸nico/tel茅fonos de recuperaci贸n
* Eliminar aplicaciones Android maliciosas
* Eliminar delegaciones de cuentas maliciosas
## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: El poder de la magia oscura de Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, 驴C贸mo hago Red Team en GSuite?

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>