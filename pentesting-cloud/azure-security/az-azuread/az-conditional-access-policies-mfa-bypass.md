# Az - Pol√≠ticas de Acceso Condicional / Bypass de MFA

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

Las pol√≠ticas de acceso condicional de Azure son reglas establecidas en Microsoft Azure para hacer cumplir controles de acceso a los servicios y aplicaciones de Azure basados en ciertas **condiciones**. Estas pol√≠ticas ayudan a las organizaciones a asegurar sus recursos aplicando los controles de acceso adecuados en las circunstancias correctas.\
Las pol√≠ticas de acceso condicional b√°sicamente **definen** **Qui√©n** puede acceder a **Qu√©** desde **D√≥nde** y **C√≥mo**.

Aqu√≠ tienes un par de ejemplos:

1. **Pol√≠tica de Riesgo de Inicio de Sesi√≥n**: Esta pol√≠tica podr√≠a configurarse para requerir autenticaci√≥n multifactor (MFA) cuando se detecta un riesgo de inicio de sesi√≥n. Por ejemplo, si el comportamiento de inicio de sesi√≥n de un usuario es inusual en comparaci√≥n con su patr√≥n regular, como iniciar sesi√≥n desde un pa√≠s diferente, el sistema puede solicitar una autenticaci√≥n adicional.
2. **Pol√≠tica de Cumplimiento de Dispositivos**: Esta pol√≠tica puede restringir el acceso a los servicios de Azure solo a dispositivos que cumplan con los est√°ndares de seguridad de la organizaci√≥n. Por ejemplo, el acceso solo podr√≠a permitirse desde dispositivos que tengan software antivirus actualizado o que est√©n ejecutando una cierta versi√≥n del sistema operativo.

## Bypass de Pol√≠ticas de Acceso Condicional

Es posible que una pol√≠tica de acceso condicional est√© **verificando alguna informaci√≥n que pueda ser f√°cilmente manipulada permitiendo un bypass de la pol√≠tica**. Y si, por ejemplo, la pol√≠tica estaba configurando MFA, el atacante podr√° evadirla.

### Plataformas de Dispositivos - Condici√≥n del Dispositivo

Es posible establecer una condici√≥n basada en la **plataforma del dispositivo** (Android, iOS, Windows, macOS), sin embargo, esto se basa en el **user-agent** por lo que es bastante f√°cil de evadir. Incluso **si se hacen cumplir MFA en todas las opciones**, si se utiliza un **user-agent que no reconoce** se podr√° evadir el MFA.

### Ubicaciones: Pa√≠ses, rangos de IP - Condici√≥n del Dispositivo

Por supuesto, si esto est√° configurado en la pol√≠tica condicional, un atacante podr√≠a simplemente usar una **VPN** en el **pa√≠s permitido** o intentar encontrar una forma de acceder desde una **direcci√≥n IP permitida** para evadir estas condiciones.

### Aplicaciones de Cliente de Office365

Se podr√≠a indicar que si los clientes **acceden a las aplicaciones de Office 365 desde el navegador necesitan MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Para evadir esto, es posible fingir que se inicia sesi√≥n en una aplicaci√≥n desde una aplicaci√≥n de escritorio (como en Microsoft Teams en el siguiente ejemplo) lo cual evadir√° la protecci√≥n:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Dado que la aplicaci√≥n Microsoft Teams tiene muchos permisos, podr√°s utilizar ese acceso.

{% hint style="success" %}
Puedes encontrar la **ID de m√°s aplicaciones p√∫blicas** con permisos predefinidos de Office365 en la base de datos de roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Este ataque es especialmente interesante porque por defecto las aplicaciones p√∫blicas de Office365 tendr√°n permisos para acceder a algunos datos.

### Otras aplicaciones

Por defecto, otras aplicaciones creadas por usuarios no tendr√°n permisos y podr√≠an ser privadas.\
Sin embargo, los usuarios tambi√©n podr√≠an crear **aplicaciones p√∫blicas** otorg√°ndoles algunos **permisos**.

Un escenario potencial donde se establece una pol√≠tica para **requerir MFA para acceder a una aplicaci√≥n** cuando el usuario est√° utilizando un **navegador** (quiz√°s porque es una aplicaci√≥n web y por lo tanto ser√° la √∫nica forma), si hay una **aplicaci√≥n proxy** -una aplicaci√≥n permitida para **interactuar con otras aplicaciones en nombre de los usuarios**-, el usuario podr√≠a **iniciar sesi√≥n en la aplicaci√≥n proxy** y luego a trav√©s de esta aplicaci√≥n proxy **iniciar sesi√≥n en la aplicaci√≥n inicialmente protegida por MFA**.

Consulte las t√©cnicas [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) y [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Otros Bypasses de MFA de Az

### Tono de llamada

Una opci√≥n de Azure MFA es **recibir una llamada en el n√∫mero de tel√©fono configurado** donde se pedir√° al usuario que **env√≠e el car√°cter `#`**.

{% hint style="danger" %}
Como los caracteres son solo **tonos**, un atacante podr√≠a **comprometer** el **mensaje de buz√≥n de voz** del n√∫mero de tel√©fono, configurar como mensaje el **tono de `#`** y luego, al solicitar el MFA asegurarse de que el **tel√©fono de la v√≠ctima est√© ocupado** (llam√°ndolo) para que la llamada de Azure se redirija al buz√≥n de voz.
{% endhint %}

### Dispositivos compatibles

Las pol√≠ticas a menudo solicitan un dispositivo compatible o MFA, por lo que un **atacante podr√≠a registrar un dispositivo compatible**, obtener un token **PRT** y **burlar de esta manera el MFA**.

Comience registrando un **dispositivo compatible en Intune**, luego **obtenga el PRT** con:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Encuentra m√°s informaci√≥n sobre este tipo de ataque en la siguiente p√°gina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Herramientas

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Obtener todas las pol√≠ticas
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep es un script de PowerShell que intenta **iniciar sesi√≥n en varios servicios de Microsoft utilizando un conjunto de credenciales proporcionado y tratar√° de identificar si MFA est√° habilitado**. Dependiendo de c√≥mo est√©n configuradas las pol√≠ticas de acceso condicional y otros ajustes de autenticaci√≥n multifactor, algunos protocolos pueden terminar quedando en un solo factor. Tambi√©n tiene una verificaci√≥n adicional para configuraciones de ADFS y puede intentar iniciar sesi√≥n en el servidor ADFS local si se detecta.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token es un conjunto de funciones que tienen como objetivo ayudar a los consultores de seguridad que necesitan validar las Pol√≠ticas de Acceso Condicional, pruebas para portales de Microsoft habilitados para 2FA, etc.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Probar cada portal** si es posible **iniciar sesi√≥n sin MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Debido a que el **portal de Azure** no est√° restringido, es posible **recopilar un token desde el punto final del portal para acceder a cualquier servicio detectado** por la ejecuci√≥n anterior. En este caso, se identific√≥ Sharepoint y se solicita un token para acceder a √©l:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Suponiendo que el token tenga el permiso Sites.Read.All (de Sharepoint), incluso si no puedes acceder a Sharepoint desde la web debido a MFA, es posible usar el token para acceder a los archivos con el token generado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referencias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v/xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
