# Az - Uslovi pristupa / Bypass MFA

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Azure Conditional Access politike su pravila postavljena u Microsoft Azure-u koja primenjuju kontrolu pristupa Azure uslugama i aplikacijama na osnovu odreÄ‘enih **uslova**. Ove politike pomaÅ¾u organizacijama da obezbede svoje resurse primenom odgovarajuÄ‡ih kontrola pristupa u odgovarajuÄ‡im okolnostima.\
Uslovne pristupne politike u osnovi **definiÅ¡u** **Ko** moÅ¾e pristupiti **Å ta** sa **Koje lokacije** i **Kako**.

Evo nekoliko primera:

1. **Politika rizika prijavljivanja**: Ova politika moÅ¾e biti podeÅ¡ena da zahteva viÅ¡estruku autentifikaciju (MFA) kada se detektuje rizik prijavljivanja. Na primer, ako je ponaÅ¡anje prijavljivanja korisnika neobiÄno u poreÄ‘enju sa njihovim uobiÄajenim obrascem, kao Å¡to je prijavljivanje iz druge zemlje, sistem moÅ¾e zatraÅ¾iti dodatnu autentifikaciju.
2. **Politika usaglaÅ¡enosti ureÄ‘aja**: Ova politika moÅ¾e ograniÄiti pristup Azure uslugama samo ureÄ‘ajima koji su usaglaÅ¡eni sa sigurnosnim standardima organizacije. Na primer, pristup moÅ¾e biti dozvoljen samo sa ureÄ‘aja koji imaju aÅ¾uriran softver za antivirus ili pokreÄ‡u odreÄ‘enu verziju operativnog sistema.

## Bypass-ovi za uslovne pristupne politike

MoguÄ‡e je da uslovna pristupna politika **proverava neke informacije koje se lako mogu promeniti, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje politike**. I ako je na primer politika konfigurisala MFA, napadaÄ Ä‡e moÄ‡i da je zaobiÄ‘e.

### Platforme ureÄ‘aja - Uslov ureÄ‘aja

MoguÄ‡e je postaviti uslov zasnovan na **platformi ureÄ‘aja** (Android, iOS, Windows, macOS), meÄ‘utim, ovo se zasniva na **user-agent-u** pa je priliÄno lako zaobiÄ‡i. ÄŒak i ako se **sve opcije postave da primoravaju MFA**, ako koristite **user-agent koji nije prepoznat**, moÄ‡i Ä‡ete da zaobiÄ‘ete MFA.

### Lokacije: Zemlje, IP opsezi - Uslov ureÄ‘aja

Naravno, ako je ovo postavljeno u uslovnoj politici, napadaÄ jednostavno moÅ¾e koristiti **VPN** u **dozvoljenoj zemlji** ili pokuÅ¡ati da pronaÄ‘e naÄin da pristupi sa **dozvoljene IP adrese** kako bi zaobiÅ¡ao ove uslove.

### Office365 klijentske aplikacije

MoÅ¾ete naznaÄiti da ako klijenti **pristupaju Office 365 aplikacijama preko pregledaÄa, potrebna im je MFA**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Da biste zaobiÅ¡li ovo, moguÄ‡e je pretvarati se da se prijavljujete u aplikaciju sa desktop aplikacije (kao Å¡to je Microsoft Teams u sledeÄ‡em primeru), Å¡to Ä‡e zaobiÄ‡i zaÅ¡titu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kako Microsoft Teams aplikacija ima puno dozvola, moÄ‡i Ä‡ete koristiti taj pristup.

{% hint style="success" %}
MoÅ¾ete pronaÄ‡i I**D viÅ¡e javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno interesantan jer Ä‡e podrazumevano javne Office365 aplikacije imati dozvole za pristup odreÄ‘enim podacima.

### Druge aplikacije

Podrazumevano, druge aplikacije koje korisnici kreiraju neÄ‡e imati dozvole i mogu biti privatne.\
MeÄ‘utim, korisnici takoÄ‘e mogu kreirati **javne aplikacije** kojima Ä‡e dodeliti odreÄ‘ene **dozvole**.

Potencijalni scenario u kojem je politika postavljena da **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledaÄ** (moÅ¾da zato Å¡to je to veb aplikacija i to Ä‡e biti jedini naÄin), ako postoji **proksi aplikacija** - aplikacija kojoj je dozvoljeno da **interaguje sa drugim aplikacijama u ime korisnika**-, korisnik moÅ¾e **prijaviti se u proksi aplikaciju** a zatim putem ove proksi aplikacije **prijaviti se u poÄetno zaÅ¡tiÄ‡enu aplikaciju MFA-om**.

Proverite tehnike [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Druge Az MFA zaobilaÅ¾enja

### Zvono

Jedna od opcija Azure MFA je **primanje poziva na konfiguriranom broju telefona** gde Ä‡e korisniku biti zatraÅ¾eno da **poÅ¡alje znak `#`**.

{% hint style="danger" %}
Kako su znakovi samo **tonovi**, napadaÄ bi mogao **ugroziti** **glasovnu poÅ¡tu** broja telefona, konfigurirajuÄ‡i ton `#` kao poruku i zatim, prilikom zahteva za MFA, osigurati da je **telefon Å¾rtve zauzet** (pozivanjem), tako da se Azure poziv preusmeri na glasovnu poÅ¡tu.
{% endhint %}

### UsklaÄ‘eni ureÄ‘aji

Politike Äesto zahtevaju usklaÄ‘eni ureÄ‘aj ili MFA, pa **napadaÄ moÅ¾e registrovati usklaÄ‘eni ureÄ‘aj**, dobiti **PRT** token i **zaobiÄ‡i MFA** na ovaj naÄin.

PoÄnite tako Å¡to Ä‡ete registrovati **usklaÄ‘eni ureÄ‘aj u Intune-u**, a zatim **dobiti PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
PronaÄ‘ite viÅ¡e informacija o ovakvom napadu na sledeÄ‡oj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Dobijte sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokuÅ¡ava **prijaviti se na razliÄite Microsoft usluge koristeÄ‡i pruÅ¾ene akreditacije i pokuÅ¡ava identifikovati da li je MFA omoguÄ‡en**. U zavisnosti od toga kako su konfigurisane politike uslovnog pristupa i druge postavke viÅ¡estrukog faktora autentifikacije, neki protokoli mogu ostati jednofaktorni. TakoÄ‘e, ima dodatnu provjeru za ADFS konfiguracije i moÅ¾e pokuÅ¡ati prijaviti se na lokalni ADFS server ako se otkrije.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu sigurnosnim konsultantima koji trebaju da potvrde Politike uslovnog pristupa, testiraju portale Microsofta sa omoguÄ‡enom dvofaktornom autentifikacijom, itd..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da biste videli da li je moguÄ‡e **prijaviti se bez MFA**:

```plaintext
1. Open the Azure portal.
2. Enter your credentials and click on Sign in.
3. If you are able to login without being prompted for MFA, take note of the portal name.
4. Repeat steps 1-3 for each portal you want to test.
```

```plaintext
1. Otvorite Azure portal.
2. Unesite svoje podatke za prijavu i kliknite na Prijavi se.
3. Ako moÅ¾ete da se prijavite bez traÅ¾enja MFA, zabeleÅ¾ite ime portala.
4. Ponovite korake 1-3 za svaki portal koji Å¾elite da testirate.
```
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato Å¡to **Azure portal** nije ograniÄen, moguÄ‡e je prikupiti token sa portalnog endpointa kako bi se pristupilo bilo kojoj detektovanoj usluzi iz prethodnog izvrÅ¡avanja. U ovom sluÄaju je identifikovan Sharepoint i zahtevan je token za pristup njemu:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}


PretpostavljajuÄ‡i da token ima dozvolu Sites.Read.All (iz Sharepointa), Äak i ako ne moÅ¾ete pristupiti Sharepointu putem weba zbog MFA, moguÄ‡e je koristiti token za pristup datotekama s generiranim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
