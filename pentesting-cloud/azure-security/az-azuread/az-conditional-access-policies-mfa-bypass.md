# Az - Uslovi pristupa / Bypass MFA

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Azure Conditional Access politike su pravila postavljena u Microsoft Azure-u radi sprovoÄ‘enja kontrola pristupa Azure uslugama i aplikacijama na osnovu odreÄ‘enih **uslova**. Ove politike pomaÅ¾u organizacijama da obezbede svoje resurse primenom odgovarajuÄ‡ih kontrola pristupa u odgovarajuÄ‡im okolnostima.\
Uslovi pristupa u osnovi **definiÅ¡u** **Ko** moÅ¾e pristupiti **ÄŒemu** sa **Kojeg mesta** i **Kako**.

Evo nekoliko primera:

1. **Politika rizika prijavljivanja**: Ova politika moÅ¾e biti postavljena da zahteva viÅ¡estruku autentifikaciju (MFA) kada se detektuje rizik prijavljivanja. Na primer, ako je ponaÅ¡anje prijavljivanja korisnika neuobiÄajeno u poreÄ‘enju sa njihovim redovnim obrascem, kao Å¡to je prijavljivanje iz druge zemlje, sistem moÅ¾e zatraÅ¾iti dodatnu autentifikaciju.
2. **Politika usaglaÅ¡enosti ureÄ‘aja**: Ova politika moÅ¾e ograniÄiti pristup Azure uslugama samo ureÄ‘ajima koji su usaglaÅ¡eni sa sigurnosnim standardima organizacije. Na primer, pristup bi mogao biti dozvoljen samo sa ureÄ‘aja koji imaju aÅ¾uriran antivirus softver ili koriste odreÄ‘enu verziju operativnog sistema.

## Bypass-ovi uslova pristupa

MoguÄ‡e je da uslov pristupa proverava neke informacije koje se lako mogu promeniti, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje politike. I ako je na primer politika konfigurisala MFA, napadaÄ Ä‡e moÄ‡i da je zaobiÄ‘e.

### Platforme ureÄ‘aja - Uslov ureÄ‘aja

MoguÄ‡e je postaviti uslov zasnovan na **platformi ureÄ‘aja** (Android, iOS, Windows, macOS), meÄ‘utim, ovo se zasniva na **user-agent**-u pa je priliÄno lako zaobiÄ‡i. ÄŒak i ako su **sve opcije postavljene da primoravaju MFA**, ako koristite **user-agent koji nije prepoznat**, moÄ‡i Ä‡ete da zaobiÄ‘ete MFA.

### Lokacije: Zemlje, IP opsezi - Uslov ureÄ‘aja

Naravno, ako je ovo postavljeno u uslovnoj politici, napadaÄ bi jednostavno mogao koristiti **VPN** u **dozvoljenoj zemlji** ili pokuÅ¡ati da pronaÄ‘e naÄin da pristupi sa **dozvoljene IP adrese** kako bi zaobiÅ¡ao ove uslove.

### Office365 klijentske aplikacije

MoÅ¾ete naznaÄiti da ako klijenti **pristupaju Office 365 aplikacijama preko pregledaÄa, potrebna im je MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Da biste zaobiÅ¡li ovo, moguÄ‡e je pretvarati se da se prijavljujete u aplikaciju sa desktop aplikacije (na primer u Microsoft Teams u sledeÄ‡em primeru) Å¡to Ä‡e zaobiÄ‡i zaÅ¡titu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kako Microsoft Teams aplikacija ima puno dozvola, moÄ‡i Ä‡ete koristiti taj pristup.

{% hint style="success" %}
MoÅ¾ete pronaÄ‡i **ID viÅ¡e javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools-a:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno zanimljiv jer Ä‡e podrazumevano javne Office365 aplikacije imati dozvole za pristup odreÄ‘enim podacima.

### Druge aplikacije

Podrazumevano, druge aplikacije koje korisnici kreiraju neÄ‡e imati dozvole i mogu biti privatne.\
MeÄ‘utim, korisnici takoÄ‘e mogu kreirati **javne aplikacije** kojima daju odreÄ‘ene **dozvole**.

Potencijalni scenario je postavljanje politike da se **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledaÄ** (moÅ¾da zato Å¡to je to veb aplikacija i stoga Ä‡e to biti jedini naÄin), ako postoji **proxy aplikacija** - aplikacija kojoj je dozvoljeno da **interaguje sa drugim aplikacijama u ime korisnika**-, korisnik bi mogao **da se prijavi u proxy aplikaciju** i zatim preko te proxy aplikacije **da se prijavi u poÄetno MFA zaÅ¡tiÄ‡enu aplikaciju**.

Proverite [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tehnike.

## Druge Az MFA Bypass opcije

### Zvuk zvona

Jedna od opcija Azure MFA je **primiti poziv na konfigurisani broj telefona** gde Ä‡e korisniku biti zatraÅ¾eno da **poÅ¡alje karakter `#`**.

{% hint style="danger" %}
Kako su karakteri samo **tonovi**, napadaÄ bi mogao **ugroziti** **glasovnu poÅ¡tu** broja telefona, konfigurisati ton `#` kao poruku i zatim, prilikom zahteva za MFA, osigurati da je **telefon Å¾rtve zauzet** (pozivajuÄ‡i ga) tako da se Azure poziv preusmeri na glasovnu poÅ¡tu.
{% endhint %}

### UsklaÄ‘eni ureÄ‘aji

Politike Äesto zahtevaju usklaÄ‘eni ureÄ‘aj ili MFA, tako da **napadaÄ moÅ¾e registrovati usklaÄ‘eni ureÄ‘aj**, dobiti **PRT** token i **na taj naÄin zaobiÄ‡i MFA**.

PoÄnite sa registracijom **usklaÄ‘enog ureÄ‘aja u Intune-u**, zatim **dobijte PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
PronaÄ‘ite viÅ¡e informacija o ovom tipu napada na sledeÄ‡oj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Dobijanje svih pravila
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokuÅ¡ava **prijaviti se na razliÄite Microsoft usluge koristeÄ‡i pruÅ¾eni set akreditiva i pokuÅ¡ava identifikovati da li je MFA omoguÄ‡en**. Zavisno o tome kako su konfigurisane politike uslovnog pristupa i druga podeÅ¡avanja viÅ¡efaktorskog autentikacije, neki protokoli mogu ostati jednofaktorski. TakoÄ‘e ima dodatnu proveru za ADFS konfiguracije i moÅ¾e pokuÅ¡ati da se prijavi na lokalni ADFS server ako je otkriven.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu bezbednosnim konsultantima koji treba da potvrde Politike uslovnog pristupa, testiraju portale kompanije Microsoft koji podrÅ¾avaju dvofaktornu autentifikaciju, itd.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da li je moguÄ‡e **prijaviti se bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato Å¡to **Azure portal** nije ograniÄen, moguÄ‡e je **prikupiti token sa krajnje taÄke portala da bi se pristupilo bilo kojoj usluzi detektovanoj** tokom prethodnog izvrÅ¡avanja. U ovom sluÄaju, Sharepoint je identifikovan, i zatraÅ¾en je token za pristup:
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Pretpostavimo da token ima dozvolu Sites.Read.All (iz Sharepointa), Äak i ako ne moÅ¾ete pristupiti Sharepointu sa veba zbog MFA, moguÄ‡e je koristiti token za pristup fajlovima sa generisanim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
