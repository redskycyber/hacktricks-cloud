# Az - Polityki dostpu warunkowego / Bypass MFA

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Polityki dostpu warunkowego w Azure to zasady ustawione w Microsoft Azure, kt贸re narzucaj kontrole dostpu do usug i aplikacji Azure na podstawie okrelonych **warunk贸w**. Te polityki pomagaj organizacjom zabezpieczy swoje zasoby, stosujc odpowiednie kontrole dostpu w odpowiednich okolicznociach.\
Polityki dostpu warunkowego okrelaj **Kto** mo偶e uzyska dostp do **Czego** z **Gdzie** i **Jak**.

Oto kilka przykad贸w:

1. **Polityka ryzyka logowania**: Ta polityka mo偶e wymaga uwierzytelnienia wielopoziomowego (MFA), gdy wykryte zostanie ryzyko logowania. Na przykad, jeli zachowanie logowania u偶ytkownika jest nietypowe w por贸wnaniu z ich regularnym wzorcem, takim jak logowanie z innego kraju, system mo偶e poprosi o dodatkowe uwierzytelnienie.
2. **Polityka zgodnoci urzdzenia**: Ta polityka mo偶e ograniczy dostp do usug Azure tylko do urzdze zgodnych z standardami bezpieczestwa organizacji. Na przykad dostp mo偶e by dozwolony tylko z urzdze posiadajcych aktualne oprogramowanie antywirusowe lub pracujcych na okrelonej wersji systemu operacyjnego.

## Bypassy polityk dostpu warunkowego

Mo偶liwe jest, 偶e polityka dostpu warunkowego **sprawdza pewne informacje, kt贸re mo偶na atwo sfaszowa, umo偶liwiajc obejcie polityki**. A jeli na przykad polityka konfigurowaa MFA, atakujcy bdzie m贸g j omin.

### Platformy urzdze - Warunek urzdzenia

Mo偶liwe jest ustawienie warunku opartego na **platformie urzdzenia** (Android, iOS, Windows, macOS), jednak jest to oparte na **user-agent**, wic jest do atwe do obejcia. Nawet **ustawiajc wszystkie opcje na wymaganie MFA**, jeli u偶yjesz **user-agenta, kt贸rego nie rozpoznaje**, bdziesz m贸g omin MFA.

### Lokalizacje: Kraje, zakresy IP - Warunek urzdzenia

Oczywicie, jeli to jest ustawione w polityce warunkowej, atakujcy m贸gby po prostu u偶y **VPN** w **dozwolonym kraju** lub spr贸bowa znale藕 spos贸b na dostp z **dozwolonego adresu IP**, aby omin te warunki.

### Aplikacje klienta Office365

Mo偶esz wskaza, 偶e jeli klienci **uzyskuj dostp do aplikacji Office 365 z przegldarki, potrzebuj MFA**:

<figure><img src="../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>

Aby omin to, mo偶na udawa, 偶e logujesz si do aplikacji z aplikacji desktopowej (na przykad do Microsoft Teams w poni偶szym przykadzie), co ominie ochron:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Poniewa偶 aplikacja Microsoft Teams ma wiele uprawnie, bdziesz m贸g skorzysta z tego dostpu.

{% hint style="success" %}
Mo偶esz znale藕 **ID bardziej publicznych aplikacji** z predefiniowanymi uprawnieniami Office365 w bazie danych roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

To atak jest szczeg贸lnie interesujcy, poniewa偶 domylnie publiczne aplikacje Office365 bd miay uprawnienia do dostpu do pewnych danych.

### Inne aplikacje

Domylnie inne aplikacje utworzone przez u偶ytkownik贸w nie bd miay uprawnie i mog by prywatne.\
Jednak偶e u偶ytkownicy mog r贸wnie偶 tworzy **publiczne aplikacje**, nadajc im pewne **uprawnienia**.

Potencjalny scenariusz, w kt贸rym ustawiona jest polityka **wymagajca MFA do dostpu do aplikacji** gdy u偶ytkownik korzysta z **przegldarki** (by mo偶e dlatego, 偶e jest to aplikacja internetowa i bdzie to jedyny spos贸b), jeli istnieje **aplikacja proxy** - aplikacja zezwalajca na **interakcj z innymi aplikacjami w imieniu u偶ytkownik贸w**-, u偶ytkownik m贸gby **zalogowa si do aplikacji proxy** a nastpnie poprzez t aplikacj proxy **zalogowa si do pocztkowo chronionej aplikacji MFA**.

Sprawd藕 techniki [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Inne sposoby bypassowania Az MFA

### Dzwonek

Jedn z opcji Azure MFA jest **otrzymanie poczenia na skonfigurowany numer telefonu**, gdzie u偶ytkownikowi zostanie poproszony o **wysanie znaku `#`**.

{% hint style="danger" %}
Poniewa偶 znaki to po prostu **d藕wiki**, atakujcy m贸gby **skompromitowa** wiadomo **na poczcie gosowej** numeru telefonu, skonfigurowa jako wiadomo d藕wikowy znak `#`, a nastpnie, podczas 偶dania MFA, upewni si, 偶e **telefon ofiary jest zajty** (dzwonic), aby poczenie Azure zostao przekierowane na poczt gosow.
{% endhint %}

### Urzdzenia zgodne

Polityki czsto wymagaj zgodnego urzdzenia lub MFA, wic **atakujcy m贸gby zarejestrowa zgodne urzdzenie**, uzyska **token PRT** i **w ten spos贸b omin MFA**.

Zacznij od zarejestrowania **zgodnego urzdzenia w Intune**, a nastpnie **uzyskaj PRT** za pomoc:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Znajd藕 wicej informacji na temat tego rodzaju ataku na nastpnej stronie:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Narzdzia

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pobierz wszystkie zasady.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep to skrypt PowerShell, kt贸ry pr贸buje **zalogowa si do r贸偶nych usug Microsoftu, u偶ywajc podanego zestawu powiadcze, i spr贸buje zidentyfikowa, czy MFA jest wczone**. W zale偶noci od konfiguracji polityk dostpu warunkowego i innych ustawie uwierzytelniania wieloskadnikowego, niekt贸re protokoy mog pozosta jednoskadnikowe. Posiada r贸wnie偶 dodatkow weryfikacj konfiguracji ADFS i mo偶e pr贸bowa zalogowa si do serwera ADFS lokalnie, jeli zostanie wykryty.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token to zestaw funkcji, kt贸re maj na celu pom贸c konsultantom ds. bezpieczestwa, kt贸rzy musz zweryfikowa polityki dostpu warunkowego, testowa portale firmy Microsoft z wczon autoryzacj dwuetapow, itp.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Przetestuj ka偶d z platform**, aby sprawdzi, czy jest mo偶liwe **zalogowanie bez MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Poniewa偶 **portal Azure** nie jest **ograniczony**, istnieje mo偶liwo **pobrania tokena z punktu kocowego portalu w celu uzyskania dostpu do dowolnej usugi wykrytej** podczas poprzedniego wykonania. W tym przypadku zidentyfikowano Sharepoint, a 偶dany jest token dostpu do niego:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Za贸偶my, 偶e token ma uprawnienie Sites.Read.All (z Sharepoint), nawet jeli nie mo偶esz uzyska dostpu do Sharepoint z sieci z powodu MFA, mo偶na u偶y tokenu do uzyskania dostpu do plik贸w za pomoc wygenerowanego tokenu:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Odnoniki

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
