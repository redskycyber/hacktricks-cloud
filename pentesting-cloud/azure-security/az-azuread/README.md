# Az - AzureAD (AAD)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## åŸºæœ¬æƒ…å ±

Azure Active Directoryï¼ˆAzure ADï¼‰ã¯ã€Microsoftã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€å¾“æ¥­å“¡ãŒçµ„ç¹”å†…å¤–ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã«é‡è¦ã§ã‚ã‚Šã€Microsoft 365ã€Azureãƒãƒ¼ã‚¿ãƒ«ã€ãŠã‚ˆã³ã•ã¾ã–ã¾ãªä»–ã®SaaSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚Azure ADã®è¨­è¨ˆã¯ã€**èªè¨¼ã€æ‰¿èªã€ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**ã‚’å«ã‚€é‡è¦ãªã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

Azure ADã®ä¸»ãªæ©Ÿèƒ½ã«ã¯ã€**å¤šè¦ç´ èªè¨¼**ãŠã‚ˆã³**æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹**ãŒå«ã¾ã‚Œã€ä»–ã®Microsoftã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªçµ±åˆãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã€çµ„ç¹”ãŒã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’åŠ¹æœçš„ã«å®Ÿè£…ãŠã‚ˆã³å¼·åˆ¶ã™ã‚‹ã®ã‚’æ”¯æ´ã—ã¾ã™ã€‚Microsoftã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ã€Azure ADã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†ã«ä¸å¯æ¬ ã§ã™ã€‚

## ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

### åˆ—æŒ™

ã“ã®åˆ—æŒ™ã«ã¯ã€[**az cliãƒ„ãƒ¼ãƒ«**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)ã€**PowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/)ï¼ˆã¾ãŸã¯[**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)ï¼‰ã€ãŠã‚ˆã³[**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps)ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

{% hint style="success" %}
Linuxã§ã¯ã€PowerShell Coreã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é•ã„**

- **AzureAD** ã¯ã€Azure AD ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã® Microsoft ã® PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚**Azure AD ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤ºã›ãšã€Azure ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚
- **Az PowerShell** ã¯ã€PowerShell ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ **Azure ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†**ã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

### **æ¥ç¶š**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Raw PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Raw OS" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Azureã«CLIã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€Microsoftã«æ‰€å±ã™ã‚‹ãƒ†ãƒŠãƒ³ãƒˆã®Azureã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ä½œæˆã§ãã‚‹ã‚‚ã®ã®ã‚ˆã†ã«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹**è¨±å¯ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ**ã«ã¯ã™ã¹ã¦è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãŸã¨ãˆã°ã€**powershellã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ãŒèªè¨¼ã«ä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID **`1950a258-227b-4e31-a9cf-717495945fc2`** ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã§ã‚‚ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¯ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’**ãƒ–ãƒ­ãƒƒã‚¯**ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ã‚¢ãƒ—ãƒªã‚’ä»‹ã—ã¦æ¥ç¶šã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã—ã€Azureã«æ¥ç¶šã™ã‚‹ãŸã‚ã«**ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID**ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚Šã¾ã™ï¼š
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### ãƒ¦ãƒ¼ã‚¶ãƒ¼

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

Azure AD user enumeration can be performed using the Azure AD Graph API. By making requests to the API, an attacker can gather information about users in the Azure AD directory, such as usernames, email addresses, and other attributes.

#### Tools

- [**Azure AD Explorer**](https://github.com/fox-it/AzureADExplorer): A tool for exploring Azure AD data using the Azure AD Graph API.

### Group Enumeration

Similar to user enumeration, group enumeration can also be performed using the Azure AD Graph API. This allows an attacker to discover information about groups in the Azure AD directory, such as group names, descriptions, and memberships.

#### Tools

- [**Azure AD Explorer**](https://github.com/fox-it/AzureADExplorer): Can also be used for exploring Azure AD groups.

### Application Enumeration

Azure AD applications can be enumerated using the Azure AD Graph API as well. This enables an attacker to identify registered applications in the Azure AD directory, along with details such as the application name, ID, and permissions.

#### Tools

- [**Azure AD Explorer**](https://github.com/fox-it/AzureADExplorer): Supports enumerating Azure AD applications.

### Tenant Enumeration

Tenant enumeration involves gathering information about the Azure AD tenant itself, such as tenant ID, domain name, and other relevant details. This can be useful for an attacker to understand the target environment better.

#### Tools

- Manual enumeration using the Azure portal or PowerShell commands.

## Azure AD Exploitation

### Password Spraying

Password spraying attacks can be conducted against Azure AD to attempt to gain unauthorized access to user accounts. By trying a few common passwords across multiple accounts, an attacker may find a valid password and gain access.

#### Tools

- Manual password spraying using common password lists or tools like **CrackMapExec**.

### Phishing Attacks

Phishing attacks targeting Azure AD users can be used to steal credentials or deliver malware. Attackers may send fake login pages or emails to trick users into providing their credentials, which can then be used to access Azure AD accounts.

#### Tools

- Various phishing tools and frameworks can be used to create and launch phishing campaigns against Azure AD users.

### Token Impersonation

By obtaining a user's token, an attacker can impersonate that user and access resources on their behalf. This can be achieved through techniques like token theft or token reuse, allowing the attacker to bypass authentication mechanisms.

#### Tools

- Manual techniques using tools like **Impacket** or custom scripts for token impersonation.

### Privilege Escalation

Once access to an Azure AD account is obtained, privilege escalation techniques can be used to elevate permissions and gain further access within the Azure environment. This can involve exploiting misconfigurations, vulnerabilities, or weak permissions.

#### Tools

- Manual enumeration and exploitation techniques, leveraging knowledge of Azure AD and associated services.

{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %}

## Azure AD Enumeration

### Enumerate Azure AD Users

To list all users in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADUser
```

### Enumerate Azure AD Groups

To list all groups in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADGroup
```

### Enumerate Azure AD Applications

To list all applications in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADApplication
```

### Enumerate Azure AD Service Principals

To list all service principals in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADServicePrincipal
```

### Enumerate Azure AD Devices

To list all devices in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDevice
```

### Enumerate Azure AD Domains

To list all domains in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDomain
```

### Enumerate Azure AD Directory Roles

To list all directory roles in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRole
```

### Enumerate Azure AD Directory Role Members

To list all members of a specific directory role in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

### Enumerate Azure AD Directory Role Templates

To list all directory role templates in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleTemplate
```

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText â€“Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password â€“Verbose
```
{% endcode %}

### MFA & Conditional Access Policies

ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«MFAã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ãŒã€ä¸€éƒ¨ã®ä¼æ¥­ã¯è¨­å®šã—ãªã„ã‹ã€ç‰¹å®šã®å ´æ‰€ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€ã¾ãŸã¯**ã‚ã‚‹æ¡ä»¶**ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã«MFAã‚’**å¿…è¦ã¨ã™ã‚‹**æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§è¨­å®šã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã®ãƒãƒªã‚·ãƒ¼ã¯ã€æ­£ã—ãæ§‹æˆã•ã‚Œã¦ã„ãªã„å ´åˆã€**ãƒã‚¤ãƒ‘ã‚¹**ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### ã‚°ãƒ«ãƒ¼ãƒ—

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools can help you gather information about users, groups, and contacts in the Azure AD environment.

#### Using Azure AD Recon

1. **Install Azure AD Recon**: Download and install Azure AD Recon on your local machine.
2. **Run the Tool**: Launch Azure AD Recon and provide the necessary inputs such as the Azure AD domain name and credentials.
3. **Enumerate Users**: Use the tool to enumerate users in the Azure AD environment.

#### Using Azure AD Connect Sync

1. **Install Azure AD Connect Sync**: Set up Azure AD Connect Sync on a machine with network access to the Azure AD environment.
2. **Configure Sync**: Configure the synchronization settings to start syncing Azure AD data.
3. **Enumerate Users**: Once the synchronization is complete, you can enumerate users using the synced data.

### Group Enumeration

To enumerate groups in Azure AD, you can leverage tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools allow you to discover information about the groups present in the Azure AD environment.

#### Using Azure AD Recon

1. **Launch Azure AD Recon**: Open Azure AD Recon on your machine.
2. **Provide Inputs**: Enter the required details such as the Azure AD domain name and authentication credentials.
3. **Enumerate Groups**: Utilize the tool to enumerate groups in Azure AD.

#### Using Azure AD Connect Sync

1. **Access Azure AD Connect Sync**: Log in to the machine where Azure AD Connect Sync is installed.
2. **Check Sync Status**: Ensure that the synchronization process is running and up to date.
3. **Enumerate Groups**: Explore the synced data to enumerate groups in Azure AD.

### Contact Enumeration

For enumerating contacts in Azure AD, you can employ tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools aid in identifying and retrieving information about contacts stored in Azure AD.

#### Using Azure AD Recon

1. **Start Azure AD Recon**: Initiate Azure AD Recon on your system.
2. **Input Details**: Input the Azure AD domain name and valid credentials into the tool.
3. **Enumerate Contacts**: Use the tool to enumerate contacts within Azure AD.

#### Using Azure AD Connect Sync

1. **Launch Azure AD Connect Sync**: Access the machine hosting Azure AD Connect Sync.
2. **Verify Synchronization**: Confirm that the synchronization process is active and functioning properly.
3. **Enumerate Contacts**: Examine the synchronized data to enumerate contacts in Azure AD.

## Summary

Azure AD enumeration involves gathering information about users, groups, and contacts within the Azure AD environment. Tools like `Azure AD Recon` and `Azure AD Connect Sync` facilitate the enumeration process by providing insights into the entities present in Azure AD. By leveraging these tools, pentesters can effectively enumerate and analyze the Azure AD environment for potential security weaknesses.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %}

## Azure AD Enumeration

### Enumerate Azure AD Users

To list all users in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADUser
```

### Enumerate Azure AD Groups

To list all groups in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADGroup
```

### Enumerate Azure AD Applications

To list all applications in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADApplication
```

### Enumerate Azure AD Service Principals

To list all service principals in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADServicePrincipal
```

### Enumerate Azure AD Devices

To list all devices in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDevice
```

### Enumerate Azure AD Domains

To list all domains in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDomain
```

### Enumerate Azure AD Directory Roles

To list all directory roles in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRole
```

### Enumerate Azure AD Directory Role Members

To list all members of a specific directory role in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

Replace `<DirectoryRoleObjectId>` with the actual object ID of the directory role you want to enumerate members for.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
#### ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ 

ã‚°ãƒ«ãƒ¼ãƒ—ã®æ‰€æœ‰è€…ã¯ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã§ãã¾ã™
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
ã‚°ãƒ«ãƒ¼ãƒ—ã¯ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã®æ¡ä»¶ã‚’æº€ãŸã™ã¨ã€ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã•ã‚Œã‚‹**ã¨ã„ã†ã“ã¨ã‚’åŸºæœ¬çš„ã«æ„å‘³ã—ã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€æ¡ä»¶ãŒ**å±æ€§**ã«åŸºã¥ã„ã¦ã„ã‚‹å ´åˆã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ãŒ**åˆ¶å¾¡**ã§ãã‚‹å ´åˆã€ã“ã®æ©Ÿèƒ½ã‚’æ‚ªç”¨ã—ã¦**ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚\
æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« / ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

{% hint style="info" %}
PowerShellç”¨èªã§ã®**Service Principal**ã¯ã€Azureãƒãƒ¼ã‚¿ãƒ«ï¼ˆWebï¼‰ã§ã¯**Enterprise Applications**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD

### Enumeration

Azure AD enumeration can be performed using various techniques such as:

- **User Enumeration**: Enumerating users through the Azure AD Graph API or Microsoft Graph API.
- **Group Enumeration**: Enumerating groups to discover privileged groups or potential targets.
- **Application Enumeration**: Identifying applications registered in Azure AD that may have misconfigurations or vulnerabilities.

### Exploitation

Exploiting Azure AD may involve techniques like:

- **Password Spraying**: Attempting to authenticate using a list of common passwords against Azure AD accounts.
- **Brute Force Attacks**: Trying to guess passwords by systematically checking all possible combinations.
- **OAuth Token Abuse**: Exploiting misconfigured OAuth settings to gain unauthorized access to resources.

### Post-Exploitation

After gaining access to Azure AD, an attacker may perform actions like:

- **User Impersonation**: Impersonating a user to access their resources and perform unauthorized actions.
- **Data Exfiltration**: Stealing sensitive data from Azure AD, such as user credentials or confidential information.
- **Persistence**: Establishing persistence by creating backdoors or adding rogue accounts for future access.

{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}  

## Azure AD Enumeration

### Enumerate Azure AD Users

To list all users in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADUser
```

### Enumerate Azure AD Groups

To list all groups in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADGroup
```

### Enumerate Azure AD Applications

To list all applications in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADApplication
```

### Enumerate Azure AD Service Principals

To list all service principals in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADServicePrincipal
```

### Enumerate Azure AD Devices

To list all devices in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDevice
```

### Enumerate Azure AD Domains

To list all domains in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDomain
```

### Enumerate Azure AD Directory Roles

To list all directory roles in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRole
```

### Enumerate Azure AD Directory Role Members

To list all members of a specific directory role in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

Replace `<DirectoryRoleObjectId>` with the actual object ID of the directory role you want to enumerate members for.

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="ç¿»è¨³" %}Azure ADã®ä¾µå…¥ãƒ†ã‚¹ãƒˆ

Azure ADã¯ã€Microsoft Azureã®èªè¨¼ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚Azure ADã®ä¾µå…¥ãƒ†ã‚¹ãƒˆã¯ã€çµ„ç¹”ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è©•ä¾¡ã—ã€æ½œåœ¨çš„ãªè„†å¼±æ€§ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ä¾µå…¥ãƒ†ã‚¹ãƒˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã€ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã€ãƒ­ãƒ¼ãƒ«ã®æ§‹æˆã€ãƒãƒ«ãƒãƒ•ã‚¡ã‚¯ã‚¿èªè¨¼ãªã©ã€ã•ã¾ã–ã¾ãªå´é¢ã‚’è©•ä¾¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚{% endtab %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
<details>

<summary>å„ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã—ã¦è¿½åŠ ã—ã‚ˆã†</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### ãƒ­ãƒ¼ãƒ«

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD User Enumeration`. These tools can help you gather information about users, such as their usernames, email addresses, and group memberships.

#### Using Azure AD Recon

1. Clone the Azure AD Recon tool from the GitHub repository.
2. Run the tool and provide the necessary parameters, such as the tenant ID and client ID.
3. The tool will enumerate users and display information about them.

#### Using Azure AD User Enumeration

1. Download and install the Azure AD User Enumeration tool.
2. Run the tool and specify the target Azure AD domain.
3. The tool will enumerate users and provide details like usernames and email addresses.

### Group Enumeration

To enumerate groups in Azure AD, tools like `Azure AD Recon` or `Azure AD Group Enumeration` can be used. These tools can help you identify groups in the Azure AD environment and gather information about their members.

#### Using Azure AD Recon

1. Clone the Azure AD Recon tool from the GitHub repository.
2. Execute the tool with the required parameters, including the tenant ID and client ID.
3. The tool will enumerate groups and display information about them.

#### Using Azure AD Group Enumeration

1. Install the Azure AD Group Enumeration tool on your system.
2. Launch the tool and input the Azure AD domain you want to enumerate.
3. The tool will list the groups in the specified Azure AD domain along with their members.

### Application Enumeration

To enumerate applications registered in Azure AD, tools like `Azure AD Recon` or `Azure AD App Enumeration` can be utilized. These tools can provide insights into the applications configured in Azure AD and their associated permissions.

#### Using Azure AD Recon

1. Get the Azure AD Recon tool from the GitHub repository.
2. Specify the necessary parameters when running the tool, such as the tenant ID and client ID.
3. The tool will enumerate applications and present information about them.

#### Using Azure AD App Enumeration

1. Download and set up the Azure AD App Enumeration tool.
2. Execute the tool and indicate the Azure AD domain to target.
3. The tool will list the registered applications in the specified Azure AD domain and their permissions.

{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}

## Azure AD Enumeration

### Enumerate Azure AD Users

To list all users in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADUser
```

### Enumerate Azure AD Groups

To list all groups in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADGroup
```

### Enumerate Azure AD Applications

To list all applications in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADApplication
```

### Enumerate Azure AD Service Principals

To list all service principals in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADServicePrincipal
```

### Enumerate Azure AD Devices

To list all devices in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDevice
```

### Enumerate Azure AD Domains

To list all domains in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDomain
```

### Enumerate Azure AD Directory Roles

To list all directory roles in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRole
```

### Enumerate Azure AD Directory Role Members

To list all members of a specific directory role in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

### Enumerate Azure AD Directory Role Templates

To list all directory role templates in the Azure AD tenant, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleTemplate
```

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="ç¿»è¨³" %}  
Azure ADã®ä¾µå…¥ãƒ†ã‚¹ãƒˆã¯ã€Azure ADç’°å¢ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€æ¨©é™ã®æ˜‡æ ¼ã€ãƒãƒ«ã‚¦ã‚§ã‚¢ã®å±•é–‹ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚Azure ADã®ä¾µå…¥ãƒ†ã‚¹ãƒˆã¯ã€çµ„ç¹”ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚  
{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
### ãƒ‡ãƒã‚¤ã‚¹

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools can help you gather information about users, groups, and contacts in the Azure AD environment.

#### Using Azure AD Recon

1. **Install Azure AD Recon**: Download and install Azure AD Recon on your local machine.
2. **Run the Tool**: Launch Azure AD Recon and provide the necessary inputs such as the Azure AD domain name and credentials.
3. **Enumerate Users**: Use the tool to enumerate users in the Azure AD environment.

#### Using Azure AD Connect Sync

1. **Install Azure AD Connect Sync**: Set up Azure AD Connect Sync on a machine with network access to the Azure AD environment.
2. **Configure Sync**: Configure the synchronization settings to start syncing Azure AD data.
3. **Enumerate Users**: Once the synchronization is complete, you can enumerate users using the synced data.

### Group Enumeration

To enumerate groups in Azure AD, you can leverage tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools allow you to discover information about the groups present in the Azure AD environment.

#### Using Azure AD Recon

1. **Launch Azure AD Recon**: Open Azure AD Recon on your machine.
2. **Provide Inputs**: Enter the required details such as the Azure AD domain name and authentication credentials.
3. **Enumerate Groups**: Utilize the tool to enumerate groups in Azure AD.

#### Using Azure AD Connect Sync

1. **Access Azure AD Connect Sync**: Log in to the machine where Azure AD Connect Sync is installed.
2. **Check Sync Status**: Ensure that the synchronization process is running and up to date.
3. **Enumerate Groups**: Explore the synced data to enumerate groups in Azure AD.

### Contact Enumeration

For enumerating contacts in Azure AD, you can employ tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools aid in identifying and retrieving information about contacts stored in Azure AD.

#### Using Azure AD Recon

1. **Start Azure AD Recon**: Initiate Azure AD Recon on your system.
2. **Input Details**: Input the Azure AD domain name and valid credentials into the tool.
3. **Enumerate Contacts**: Use the tool to enumerate contacts within Azure AD.

#### Using Azure AD Connect Sync

1. **Launch Azure AD Connect Sync**: Access the machine hosting Azure AD Connect Sync.
2. **Verify Synchronization**: Confirm that the synchronization process is active and functioning properly.
3. **Enumerate Contacts**: Examine the synchronized data to enumerate contacts in Azure AD.

## Summary

User enumeration, group enumeration, and contact enumeration are crucial steps in the reconnaissance phase of a penetration test. By leveraging tools like Azure AD Recon and Azure AD Connect Sync, security professionals can gather valuable information about users, groups, and contacts within an Azure AD environment.

{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
ãƒ‡ãƒã‚¤ã‚¹ï¼ˆVMï¼‰ãŒ**AzureADã«å‚åŠ **ã—ã¦ã„ã‚‹å ´åˆã€AzureADã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹**ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\
ã•ã‚‰ã«ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒã‚¤ã‚¹ã®**æ‰€æœ‰è€…**ã§ã‚ã‚‹å ´åˆã€å½¼ã¯**ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…**ã«ãªã‚Šã¾ã™ã€‚
{% endhint %}

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

{% hint style="info" %}
**ã‚¢ãƒ—ãƒª**ã¯ãƒãƒ¼ã‚¿ãƒ«å†…ã®**ã‚¢ãƒ—ãƒªç™»éŒ²**ï¼ˆã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚\
ãŸã ã—ã€å„ã‚¢ãƒ—ãƒªç™»éŒ²ã¯åŒã˜åå‰ã®**ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ï¼ˆ**ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚\
ã•ã‚‰ã«ã€ã‚¢ãƒ—ãƒªãŒ**ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ ã‚¢ãƒ—ãƒª**ã§ã‚ã‚‹å ´åˆã€**åˆ¥ã®**ãƒ†ãƒŠãƒ³ãƒˆã«åŒã˜åå‰ã®**ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º ã‚¢ãƒ—ãƒª**ï¼ˆ**ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**ï¼‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
{% endhint %}

ã‚¢ãƒ—ãƒªãŒç”Ÿæˆã•ã‚Œã‚‹ã¨ã€2ç¨®é¡ã®æ¨©é™ãŒä¸ãˆã‚‰ã‚Œã¾ã™ï¼š

- **ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**ã«ä¸ãˆã‚‰ã‚Œã‚‹**æ¨©é™**
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä»£è¡¨ã—ã¦**ã‚¢ãƒ—ãƒªãŒæŒã¡ã€ä½¿ç”¨ã§ãã‚‹**æ¨©é™**

{% tabs %}
{% tab title="az cli" %}
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}

## Azure AD Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools can help you gather information about users, groups, and contacts in the Azure AD environment.

#### Using Azure AD Recon

1. **Install Azure AD Recon**: Download and install Azure AD Recon on your local machine.
2. **Run the Tool**: Launch Azure AD Recon and provide the necessary inputs such as the Azure AD domain name and credentials.
3. **Enumerate Users**: Use the tool to enumerate users in the Azure AD environment.

#### Using Azure AD Connect Sync

1. **Set up Azure AD Connect Sync**: Configure Azure AD Connect Sync to synchronize on-premises directories with Azure AD.
2. **Run Sync**: Initiate a sync operation to update user information in Azure AD.
3. **Check Azure AD Portal**: Access the Azure AD portal to view the synchronized user information.

### Group Enumeration

To enumerate groups in Azure AD, you can leverage tools like `Azure AD Recon` or `Azure AD Connect Sync`. These tools can assist in identifying and gathering information about groups in the Azure AD environment.

#### Using Azure AD Recon

1. **Launch Azure AD Recon**: Open Azure AD Recon on your machine.
2. **Provide Inputs**: Enter the required details such as the Azure AD domain name and authentication credentials.
3. **Enumerate Groups**: Utilize the tool to enumerate groups present in Azure AD.

#### Using Azure AD Connect Sync

1. **Configure Sync Settings**: Set up Azure AD Connect Sync to synchronize group information.
2. **Initiate Sync**: Run a synchronization process to update group details in Azure AD.
3. **Review Groups**: Check the Azure AD portal to see the synchronized group information.

### Device Enumeration

For enumerating devices in Azure AD, tools like `Azure AD Recon` or `Azure AD Connect Sync` can be beneficial. These tools aid in discovering and retrieving information about devices registered in Azure AD.

#### Using Azure AD Recon

1. **Install the Tool**: Download and install Azure AD Recon.
2. **Launch the Tool**: Open Azure AD Recon and input the Azure AD domain details along with authentication credentials.
3. **Enumerate Devices**: Utilize the tool to enumerate devices within Azure AD.

#### Using Azure AD Connect Sync

1. **Sync Configuration**: Configure Azure AD Connect Sync to include device synchronization.
2. **Run Synchronization**: Initiate a synchronization process to update device information in Azure AD.
3. **Check Device Details**: Access the Azure AD portal to view the synchronized device information.

## Summary

Azure AD enumeration is crucial for understanding the users, groups, and devices present in an Azure AD environment. By utilizing tools like Azure AD Recon and Azure AD Connect Sync, security professionals can gather valuable insights to assess the security posture of Azure AD.

{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}  

## Azure AD Enumeration

### Enumerate Azure AD Users

To list all users in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADUser
```

### Enumerate Azure AD Groups

To list all groups in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADGroup
```

### Enumerate Azure AD Applications

To list all applications in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADApplication
```

### Enumerate Azure AD Service Principals

To list all service principals in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADServicePrincipal
```

### Enumerate Azure AD Devices

To list all devices in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDevice
```

### Enumerate Azure AD Domains

To list all domains in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDomain
```

### Enumerate Azure AD Directory Roles

To list all directory roles in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRole
```

### Enumerate Azure AD Directory Role Members

To list all members of a specific directory role in Azure AD, you can use the following PowerShell command:

```plaintext
Get-AzureADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

Replace `<DirectoryRoleObjectId>` with the actual object ID of the directory role you want to enumerate members for.

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
**`AppRoleAssignment.ReadWrite`** ã®æ¨©é™ã‚’æŒã¤ã‚¢ãƒ—ãƒªã¯ã€è‡ªèº«ã«å½¹å‰²ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ **Global Admin ã«æ˜‡æ ¼** ã§ãã¾ã™ã€‚\
è©³ç´°ã«ã¤ã„ã¦ã¯[**ã“ã¡ã‚‰ã‚’ãƒã‚§ãƒƒã‚¯**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)ã€‚
{% endhint %}

{% hint style="info" %}
ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè‡ªèº«ã®æ­£ä½“ã‚’è¨¼æ˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ç§˜å¯†æ–‡å­—åˆ—ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚\
ã—ãŸãŒã£ã¦ã€ã“ã® **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** ã‚’è¦‹ã¤ã‘ã‚‹ã¨ã€**ãƒ†ãƒŠãƒ³ãƒˆå†…ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«** ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚\
ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç”Ÿæˆæ™‚ã«ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼ˆå¤‰æ›´ã§ãã¾ã™ãŒã€å†åº¦å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰ã€‚\
**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³** ã® **æ‰€æœ‰è€…** ã¯ã€ãã‚Œã« **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ** ã§ãã¾ã™ï¼ˆãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å½è£…ã§ãã¾ã™ï¼‰ã€‚\
ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¨ã—ã¦ã®ãƒ­ã‚°ã‚¤ãƒ³ã¯ **ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã¨ã¯ãƒãƒ¼ã‚¯ã•ã‚Œãšã€MFA ãŒã‚ã‚Šã¾ã›ã‚“ã€‚**
{% endhint %}

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ï¼ˆã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼‰ã®é•ã„

Azure ã«ãŠã‘ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®é•ã„ï¼š

* **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³/ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²**: Azure AD ã«å­˜åœ¨ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«/ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: Azure AD ã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã€Azure ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã® **ç‰¹æ¨©** ã‚’æŒã¤ã“ã¨ãŒã§ãã€è‡ªèº«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã¾ã™
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* ç®¡ç†è€…ã¯ã€éå¸¸ã«æ©Ÿå¯†æ€§ã®é«˜ã„æ¨©é™ã‚’ä¸ãˆã‚‹å ´åˆã€ãã®æ¨©é™ã‚’æ‰¿èªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ **ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ†ãƒŠãƒ³ãƒˆ** ã‚’å®Ÿè¡Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ãã‚Œã‚’ä½¿ç”¨ã—å§‹ã‚ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¸ãˆã‚‹ã¨ã€å¿…è¦ãªæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã« **ã‚ãªãŸã®ãƒ†ãƒŠãƒ³ãƒˆã«ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³/ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™**ã€‚

### ç®¡ç†å˜ä½

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†ã‚’ã‚ˆã‚ŠåŠ¹æœçš„ã«è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ç®¡ç†å˜ä½ã¯ã€çµ„ç¹”å†…ã®ä»»æ„ã®éƒ¨åˆ†ã«æ¨©é™ã‚’åˆ¶é™ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ç®¡ç†å˜ä½ã‚’ä½¿ç”¨ã—ã¦ã€[Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) å½¹å‰²ã‚’åœ°åŸŸã‚µãƒãƒ¼ãƒˆã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã«å§”ä»»ã—ã¦ã€å½¼ã‚‰ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹åœ°åŸŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ç®¡ç†å˜ä½ã«å½¹å‰²ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã€ãã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ãã®å½¹å‰²ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚
```
```
## AzureAD

Azure Active Directory (AzureAD) is Microsoft's cloud-based identity and access management service. It allows organizations to manage user identities and access permissions in the cloud.

### Enumeration

When conducting a penetration test on AzureAD, enumeration is a crucial step. This involves gathering information about users, groups, roles, and permissions within the AzureAD environment.

#### Tools

There are various tools available for enumerating AzureAD, such as:

- **Azure AD PowerShell Module**: Allows you to manage AzureAD resources using PowerShell cmdlets.
- **Azure AD Graph API**: Enables programmatic access to AzureAD resources.
- **Microsoft Graph API**: Provides a unified programmability model to access Microsoft cloud services.

### Exploitation

After enumeration, the next step is to identify and exploit vulnerabilities in the AzureAD environment. This may include password spraying attacks, phishing campaigns, or exploiting misconfigurations in AzureAD settings.

#### Best Practices

To secure AzureAD, it is essential to follow best practices such as enforcing strong password policies, enabling multi-factor authentication, monitoring sign-in logs, and regularly reviewing permissions and roles.

By following these best practices, organizations can enhance the security of their AzureAD environment and protect against unauthorized access and data breaches.
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
## Azure AD Identity Protection (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Identity Protection (AIP)ã¯ã€Azure Active Directoryå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«**è‡ªå‹•æ¤œå‡ºã¨æ˜¯æ­£ã‚’ä½¿ç”¨ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹**ã§ã™ã€‚AIPã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚„ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹æˆã®ãƒªã‚¹ã‚¯ã‚’ç¶™ç¶šçš„ã«ç›£è¦–ã—ã€**é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’è‡ªå‹•çš„ã«é©ç”¨**ã—ã¦ã€å¤šè¦ç´ èªè¨¼ã®è¦æ±‚ã‚„æ½œåœ¨çš„ã«å±é™ºãªæ´»å‹•ã®ãƒ–ãƒ­ãƒƒã‚¯ãªã©ã‚’è¡Œã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€çµ„ç¹”ã¯ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åŸºã¥ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ•ãƒ­ãƒ¼ï¼š

1. Azure AD Identity Protectionã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ´»å‹•ã‚’ç›£è¦–ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€èªè¨¼**ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¾ã™ã€‚
2. ã‚µãƒ¼ãƒ“ã‚¹ã¯ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«**æ©Ÿæ¢°å­¦ç¿’**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
3. Azure AD Identity Protectionã¯è„…å¨ï¼ˆãŸã¨ãˆã°ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼‰ã«**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’å‰²ã‚Šå½“ã¦**ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦è‡ªå‹•çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## Azure AD Password Protection (APP)

Azure AD Password Protection (APP)ã¯ã€Azure Active Directoryå†…ã§**å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é˜²æ­¢ã™ã‚‹**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã§ã™ã€‚APPã¯**ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŠã‚ˆã³ãã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–¢é€£ã®ä¾µå®³ã®ãƒªã‚¹ã‚¯ã‚’ä½æ¸›ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¬ãƒ™ãƒ«ã¨ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®Active Directoryã®ä¸¡æ–¹ã§é©ç”¨ã§ãã€çµ„ç¹”å…¨ä½“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

### å‚è€ƒ

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)
