# Az - AzureAD (AAD)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

Azure Active Directory (Azure AD), Microsoft'un kimlik ve eriÅŸim yÃ¶netimi iÃ§in bulut tabanlÄ± hizmetidir. Ã‡alÄ±ÅŸanlarÄ±n Microsoft 365, Azure portalÄ± ve birÃ§ok diÄŸer SaaS uygulamasÄ± dahil olmak Ã¼zere kuruluÅŸ iÃ§i ve dÄ±ÅŸÄ±ndaki kaynaklara giriÅŸ yapmasÄ±nÄ± saÄŸlamak iÃ§in Ã¶nemli bir rol oynar. Azure AD'nin tasarÄ±mÄ±, **kimlik doÄŸrulama, yetkilendirme ve kullanÄ±cÄ± yÃ¶netimi** gibi temel kimlik hizmetlerini sunmaya odaklanmaktadÄ±r.

Azure AD'nin Ã¶nemli Ã¶zellikleri arasÄ±nda **Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama** ve **koÅŸullu eriÅŸim** bulunur ve diÄŸer Microsoft gÃ¼venlik hizmetleriyle sorunsuz entegrasyon saÄŸlar. Bu Ã¶zellikler, kullanÄ±cÄ± kimliklerinin gÃ¼venliÄŸini Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rÄ±r ve organizasyonlarÄ±n eriÅŸim politikalarÄ±nÄ± etkin bir ÅŸekilde uygulamasÄ±na olanak tanÄ±r. Microsoft'un bulut hizmetleri ekosisteminin temel bir bileÅŸeni olarak, Azure AD, kullanÄ±cÄ± kimliklerinin bulut tabanlÄ± yÃ¶netimi iÃ§in hayati Ã¶neme sahiptir.

## VarlÄ±klar

### SÄ±ralama

Bu sÄ±ralama iÃ§in [**az cli aracÄ±nÄ±**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) PowerShell modÃ¼lÃ¼nÃ¼ (veya [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) ve [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) modÃ¼lÃ¼nÃ¼ kullanabilirsiniz.

{% hint style="success" %}
Linux'ta PowerShell Core'u yÃ¼klemeniz gerekecektir:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **ModÃ¼l farklarÄ±**

* **AzureAD**, Azure AD nesnelerinin tÃ¼m Ã¶zelliklerini gÃ¶stermeyen ve Azure kaynaklarÄ± bilgilerine eriÅŸmek iÃ§in kullanÄ±lamayan Microsoft'un Azure AD yÃ¶netimi iÃ§in bir PowerShell modÃ¼lÃ¼dÃ¼r.
* **Az PowerShell**, PowerShell komut satÄ±rÄ±ndan Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in bir modÃ¼ldÃ¼r.

### **BaÄŸlantÄ±**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% tab title="Ham PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="Ham OS" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

Herhangi bir programla Azure'a **CLI** Ã¼zerinden **giriÅŸ yaptÄ±ÄŸÄ±nÄ±zda**, **Microsoft**'a ait bir **kiracÄ±ya** ait bir **Azure UygulamasÄ±** kullanÄ±yorsunuz. Bu Uygulamalar, hesabÄ±nÄ±zda oluÅŸturabileceÄŸiniz uygulamalar gibi, **bir istemci kimliÄŸine sahiptir**. Konsolda gÃ¶rebileceÄŸiniz **izin verilen uygulama listelerinde hepsini gÃ¶remeyebilirsiniz**, ancak varsayÄ±lan olarak **hepsi izinlidir**.

Ã–rneÄŸin, bir **powershell betiÄŸi** kimlik doÄŸrulamasÄ± iÃ§in **`1950a258-227b-4e31-a9cf-717495945fc2`** istemci kimliÄŸine sahip bir uygulama kullanÄ±r. Uygulama konsolda gÃ¶rÃ¼nmese bile, bir sistem yÃ¶neticisi bu uygulamayÄ± **engelleyebilir**, bÃ¶ylece kullanÄ±cÄ±lar bu uygulama Ã¼zerinden baÄŸlantÄ± kuran araÃ§larÄ± kullanamazlar.

Ancak, Azure'a baÄŸlanmanÄ±za **izin verecek diÄŸer istemci kimlikleri** bulunmaktadÄ±r:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### KullanÄ±cÄ±lar

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% tab title="Az PowerShell" %}

Azure AD, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi hizmetidir. Azure AD, kullanÄ±cÄ±larÄ±n ve uygulamalarÄ±n kimlik doÄŸrulamasÄ±nÄ± ve yetkilendirilmesini saÄŸlar. Azure AD, Azure hizmetlerine ve diÄŸer Microsoft hizmetlerine eriÅŸim saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'yi pentest etmek iÃ§in Az PowerShell kullanabilirsiniz. Az PowerShell, Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir komut satÄ±rÄ± aracÄ±dÄ±r. Azure AD'yi pentest etmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Az PowerShell'i yÃ¼kleyin ve yapÄ±landÄ±rÄ±n.
2. Azure AD'ye baÄŸlanÄ±n.
3. Azure AD'deki kullanÄ±cÄ±larÄ±, gruplarÄ± ve rolleri listeleyin.
4. Azure AD'deki uygulamalarÄ± ve bunlara eriÅŸim izinlerini listeleyin.
5. Azure AD'deki kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
6. Azure AD'deki gÃ¼venlik politikalarÄ±nÄ± kontrol edin.
7. Azure AD'deki denetim kayÄ±tlarÄ±nÄ± kontrol edin.
8. Azure AD'deki hizmet prensiplerini kontrol edin.
9. Azure AD'deki kimlik doÄŸrulama yÃ¶ntemlerini kontrol edin.
10. Azure AD'deki kullanÄ±cÄ± hesaplarÄ±nÄ± ve parolalarÄ±nÄ± test edin.
11. Azure AD'deki oturum aÃ§ma iÅŸlemlerini izleyin ve denetleyin.
12. Azure AD'deki eriÅŸim izinlerini kontrol edin.
13. Azure AD'deki gÃ¼venlik duvarÄ± ayarlarÄ±nÄ± kontrol edin.
14. Azure AD'deki Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
15. Azure AD'deki uygulama eriÅŸim izinlerini kontrol edin.
16. Azure AD'deki veri sÄ±zÄ±ntÄ±larÄ±nÄ± kontrol edin.

Bu adÄ±mlarÄ± izleyerek Azure AD'yi pentest edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### KullanÄ±cÄ± Åifresini DeÄŸiÅŸtirme

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText â€“Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password â€“Verbose
```
{% endcode %}

### MFA ve KoÅŸullu EriÅŸim PolitikalarÄ±

Her kullanÄ±cÄ±ya MFA eklemek Ã§ok Ã¶nerilir, ancak bazÄ± ÅŸirketler bunu ayarlamayabilir veya bir KoÅŸullu EriÅŸim ile ayarlayabilir: KullanÄ±cÄ±, belirli bir konumdan, tarayÄ±cÄ±dan veya **bazÄ± koÅŸullardan** giriÅŸ yaparsa MFA **gereklidir**. Bu politikalar, doÄŸru ÅŸekilde yapÄ±landÄ±rÄ±lmazsa **atlama**lara neden olabilir. Kontrol edin:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Gruplar

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% tab title="Az PowerShell" %}

Azure AD, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi hizmetidir. Azure AD, kullanÄ±cÄ±larÄ±n ve uygulamalarÄ±n kimlik doÄŸrulamasÄ±nÄ± ve yetkilendirilmesini saÄŸlar. Azure AD, Azure hizmetlerine ve diÄŸer Microsoft hizmetlerine eriÅŸim saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'yi pentest etmek iÃ§in Az PowerShell kullanabilirsiniz. Az PowerShell, Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir komut satÄ±rÄ± aracÄ±dÄ±r. Azure AD'yi pentest etmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Az PowerShell'i yÃ¼kleyin ve yapÄ±landÄ±rÄ±n.
2. Azure AD'ye baÄŸlanÄ±n.
3. Azure AD'deki kullanÄ±cÄ±larÄ±, gruplarÄ± ve rolleri listeleyin.
4. Azure AD'deki uygulamalarÄ± ve bunlara eriÅŸim izinlerini listeleyin.
5. Azure AD'deki kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
6. Azure AD'deki gÃ¼venlik politikalarÄ±nÄ± kontrol edin.
7. Azure AD'deki gÃ¼nlÃ¼kleri ve denetim kayÄ±tlarÄ±nÄ± kontrol edin.
8. Azure AD'deki eriÅŸim kontrollerini test edin.
9. Azure AD'deki hata mesajlarÄ±nÄ± analiz edin ve olasÄ± zayÄ±f noktalarÄ± belirleyin.
10. Azure AD'deki kullanÄ±cÄ± hesaplarÄ±nÄ± ve parolalarÄ±nÄ± test edin.
11. Azure AD'deki oturum aÃ§ma iÅŸlemlerini izleyin ve izinsiz eriÅŸim giriÅŸimlerini tespit edin.

Bu adÄ±mlarÄ± izleyerek Azure AD'yi pentest edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
{% endtab %}
{% endtabs %}

#### Gruba kullanÄ±cÄ± ekleme

Grubun sahipleri yeni kullanÄ±cÄ±larÄ± gruba ekleyebilir

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
Gruplar dinamik olabilir, bu da temel olarak **bir kullanÄ±cÄ±nÄ±n belirli koÅŸullarÄ± karÅŸÄ±lamasÄ± durumunda bir gruba eklenmesi** anlamÄ±na gelir. Elbette, koÅŸullar **Ã¶zniteliklere** dayanÄ±yorsa ve bir **kullanÄ±cÄ±** bunlarÄ± **kontrol edebiliyorsa**, bu Ã¶zelliÄŸi **diÄŸer gruplara girmek iÃ§in** kÃ¶tÃ¼ye kullanabilir.\
Dinamik gruplarÄ± nasÄ±l kÃ¶tÃ¼ye kullanacaÄŸÄ±nÄ±zÄ± aÅŸaÄŸÄ±daki sayfada kontrol edin:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### Hizmet Ä°lkeleri / Kurumsal Uygulamalar

{% hint style="info" %}
PowerShell terminolojisinde **Hizmet Ä°lkesi** Azure portalÄ±nda (web) **Kurumsal Uygulamalar** olarak adlandÄ±rÄ±lÄ±r.
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% tab title="Az PowerShell" %}

Azure AD, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi hizmetidir. Azure AD, kullanÄ±cÄ±larÄ±n ve uygulamalarÄ±n kimlik doÄŸrulamasÄ±nÄ± ve yetkilendirilmesini saÄŸlar. Azure AD, Azure hizmetlerine ve diÄŸer Microsoft hizmetlerine eriÅŸim saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'yi pentest etmek iÃ§in Az PowerShell kullanabilirsiniz. Az PowerShell, Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir komut satÄ±rÄ± aracÄ±dÄ±r. Azure AD'yi pentest etmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Az PowerShell'i yÃ¼kleyin ve yapÄ±landÄ±rÄ±n.
2. Azure AD'ye baÄŸlanÄ±n.
3. Azure AD'deki kullanÄ±cÄ±larÄ±, gruplarÄ± ve rolleri listeleyin.
4. Azure AD'deki uygulamalarÄ± ve bunlara eriÅŸim izinlerini listeleyin.
5. Azure AD'deki kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
6. Azure AD'deki gÃ¼venlik politikalarÄ±nÄ± kontrol edin.
7. Azure AD'deki gÃ¼nlÃ¼kleri ve denetim kayÄ±tlarÄ±nÄ± kontrol edin.
8. Azure AD'deki eriÅŸim kontrollerini test edin.
9. Azure AD'deki hata mesajlarÄ±nÄ± analiz edin ve olasÄ± zayÄ±f noktalarÄ± belirleyin.
10. Azure AD'deki kullanÄ±cÄ± hesaplarÄ±nÄ± ve parolalarÄ±nÄ± test edin.
11. Azure AD'deki oturum aÃ§ma iÅŸlemlerini izleyin ve izinsiz eriÅŸim giriÅŸimlerini tespit edin.

Bu adÄ±mlarÄ± izleyerek Azure AD'yi pentest edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
# Azure AD

## Introduction

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

## Azure AD Security

When performing a penetration test on Azure AD, there are several areas to focus on:

### User Enumeration

User enumeration involves identifying valid user accounts in Azure AD. This can be done through various methods, such as querying the Azure AD Graph API or using tools like `az` command-line interface.

### Password Attacks

Password attacks involve attempting to crack or guess user passwords in Azure AD. This can be done through techniques like brute-forcing, password spraying, or using password cracking tools.

### Privilege Escalation

Privilege escalation involves gaining higher levels of access in Azure AD. This can be achieved by exploiting misconfigurations, vulnerabilities, or weak access controls.

### Token Manipulation

Token manipulation involves manipulating authentication tokens in Azure AD to gain unauthorized access to resources. This can be done through techniques like token replay, token theft, or token forgery.

### Federation Attacks

Federation attacks involve exploiting vulnerabilities in the federation trust between Azure AD and other identity providers. This can lead to unauthorized access to Azure AD resources.

### Account Takeover

Account takeover involves gaining unauthorized access to user accounts in Azure AD. This can be done through techniques like password spraying, phishing, or exploiting weak authentication mechanisms.

## Conclusion

Azure AD is a critical component of the Azure cloud environment, and securing it is essential for maintaining the overall security of an organization's Azure resources. By understanding the various security risks and vulnerabilities associated with Azure AD, organizations can take proactive measures to protect their Azure AD environment.
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir Hizmet Ä°lkesinin Sahibi, ÅŸifresini deÄŸiÅŸtirebilir.
{% endhint %}

<details>

<summary>Her Kurumsal Uygulamada bir istemci sÄ±rrÄ± listele ve eklemeyi deneyin</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### Roller

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% tab title="Az PowerShell" %}

Azure AD, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi hizmetidir. Azure AD, kullanÄ±cÄ±larÄ±n ve uygulamalarÄ±n kimlik doÄŸrulamasÄ±nÄ± ve yetkilendirilmesini saÄŸlar. Azure AD, Azure hizmetlerine ve diÄŸer Microsoft hizmetlerine eriÅŸim saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'yi pentest etmek iÃ§in Az PowerShell kullanabilirsiniz. Az PowerShell, Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir komut satÄ±rÄ± aracÄ±dÄ±r. Azure AD'yi pentest etmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Az PowerShell'i yÃ¼kleyin ve yapÄ±landÄ±rÄ±n.
2. Azure AD'ye baÄŸlanÄ±n.
3. Azure AD'deki kullanÄ±cÄ±larÄ±, gruplarÄ± ve rolleri listeleyin.
4. Azure AD'deki uygulamalarÄ± ve bunlara eriÅŸim izinlerini listeleyin.
5. Azure AD'deki kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
6. Azure AD'deki gÃ¼venlik politikalarÄ±nÄ± kontrol edin.
7. Azure AD'deki gÃ¼nlÃ¼kleri ve denetim kayÄ±tlarÄ±nÄ± kontrol edin.
8. Azure AD'deki zayÄ±f noktalarÄ± ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmek iÃ§in otomatik araÃ§lar kullanÄ±n.

Azure AD'yi pentest etmek iÃ§in Az PowerShell'i kullanmak, Azure AD'nin gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmek ve dÃ¼zeltmek iÃ§in Ã¶nemli bir adÄ±mdÄ±r. Bu sayede Azure AD'nin gÃ¼venliÄŸini artÄ±rabilir ve potansiyel saldÄ±rÄ±lara karÅŸÄ± korunabilirsiniz.

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
# Azure AD

## Introduction

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

## Azure AD Security

When performing a penetration test on Azure AD, there are several areas to focus on:

### User Enumeration

User enumeration involves identifying valid user accounts in Azure AD. This can be done through various methods, such as querying the Azure AD Graph API or using tools like `az` command-line interface.

### Password Attacks

Password attacks involve attempting to crack or guess user passwords in Azure AD. This can be done through techniques like brute-forcing, dictionary attacks, or password spraying.

### Privilege Escalation

Privilege escalation involves gaining higher levels of access in Azure AD. This can be achieved by exploiting misconfigurations, vulnerabilities, or weak access controls.

### Token Manipulation

Token manipulation involves manipulating authentication tokens in Azure AD to gain unauthorized access to resources. This can be done through techniques like token replay attacks or token forging.

### Federation Attacks

Federation attacks involve exploiting vulnerabilities in the federation trust between Azure AD and other identity providers. This can lead to unauthorized access to Azure AD resources.

### Data Exfiltration

Data exfiltration involves stealing or leaking sensitive data from Azure AD. This can be done through techniques like exploiting misconfigurations, using malicious applications, or leveraging weak permissions.

## Conclusion

Azure AD is a critical component of the Azure cloud environment, and securing it is essential for maintaining the overall security of an organization's resources. By understanding the various security risks and implementing appropriate countermeasures, organizations can better protect their Azure AD environment.
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

### Cihazlar

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir cihaz (VM) **AzureAD katÄ±lÄ±mlÄ±** ise, AzureAD kullanÄ±cÄ±larÄ± **giriÅŸ yapabilir**.\
AyrÄ±ca, oturum aÃ§an kullanÄ±cÄ± cihazÄ±n **Sahibi** ise, o kullanÄ±cÄ± **yerel yÃ¶netici** olacaktÄ±r.
{% endhint %}

### Uygulamalar

{% hint style="info" %}
**Uygulamalar**, portalda **Uygulama KayÄ±tlarÄ±**dÄ±r (Kurumsal Uygulamalar deÄŸil).\
Ancak, her Uygulama KaydÄ± aynÄ± isme sahip bir **Kurumsal Uygulama** (**Hizmet Ä°lkesi**) oluÅŸturur.\
AyrÄ±ca, Uygulama **Ã§ok kiracÄ±lÄ± bir Uygulama** ise, **baÅŸka bir** Kurumsal Uygulama (**Hizmet Ä°lkesi**) aynÄ± isimle **o kiracÄ±da** oluÅŸturulur.
{% endhint %}

Bir Uygulama oluÅŸturulduÄŸunda, 2 tÃ¼r izin verilir:

* **Hizmet Ä°lkesine** verilen **Ä°zinler**
* **KullanÄ±cÄ± adÄ±na** uygulamanÄ±n sahip olabileceÄŸi ve kullanabileceÄŸi **Ä°zinler**.

{% tabs %}
{% tab title="az cli" %}
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD{% endtab %}
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% tab title="Az PowerShell" %}

Azure AD, Microsoft'un bulut tabanlÄ± kimlik ve eriÅŸim yÃ¶netimi hizmetidir. Azure AD, kullanÄ±cÄ±larÄ±n ve uygulamalarÄ±n kimlik doÄŸrulamasÄ±nÄ± ve yetkilendirilmesini saÄŸlar. Azure AD, Azure hizmetlerine ve diÄŸer Microsoft hizmetlerine eriÅŸim saÄŸlamak iÃ§in kullanÄ±lÄ±r.

Azure AD'yi pentest etmek iÃ§in Az PowerShell kullanabilirsiniz. Az PowerShell, Azure kaynaklarÄ±nÄ± yÃ¶netmek iÃ§in kullanÄ±lan bir komut satÄ±rÄ± aracÄ±dÄ±r. Azure AD'yi pentest etmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz:

1. Az PowerShell'i yÃ¼kleyin ve yapÄ±landÄ±rÄ±n.
2. Azure AD'ye baÄŸlanÄ±n.
3. Azure AD'deki kullanÄ±cÄ±larÄ±, gruplarÄ± ve rolleri listeleyin.
4. Azure AD'deki uygulamalarÄ± ve bunlara eriÅŸim izinlerini listeleyin.
5. Azure AD'deki kimlik doÄŸrulama ayarlarÄ±nÄ± kontrol edin.
6. Azure AD'deki gÃ¼venlik politikalarÄ±nÄ± kontrol edin.
7. Azure AD'deki gÃ¼nlÃ¼kleri ve denetim kayÄ±tlarÄ±nÄ± kontrol edin.
8. Azure AD'deki eriÅŸim kontrollerini test edin.
9. Azure AD'deki hata mesajlarÄ±nÄ± analiz edin ve olasÄ± zayÄ±f noktalarÄ± belirleyin.
10. Azure AD'deki kullanÄ±cÄ± hesaplarÄ±nÄ± ve parolalarÄ±nÄ± test edin.
11. Azure AD'deki oturum aÃ§ma iÅŸlemlerini izleyin ve izinsiz eriÅŸim giriÅŸimlerini tespit edin.

Bu adÄ±mlarÄ± izleyerek Azure AD'yi pentest edebilir ve gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit edebilirsiniz.

{% endtab %}
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Bir uygulama, **AppRoleAssignment.ReadWrite** izniyle kendisine rol vererek **Global Admin'e yÃ¼kseltilebilir**.\
Daha fazla bilgi iÃ§in [**burayÄ± kontrol edin**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).
{% endhint %}

{% hint style="info" %}
Bir uygulamanÄ±n bir belirteÃ§ istediÄŸinde kimliÄŸini kanÄ±tlamak iÃ§in kullandÄ±ÄŸÄ± gizli dizedir.\
Bu **parolayÄ±** bulursanÄ±z, **kiracÄ±** iÃ§indeki **hizmet baÅŸkanÄ±** olarak eriÅŸebilirsiniz.\
Bu parola yalnÄ±zca oluÅŸturulduÄŸunda gÃ¶rÃ¼nÃ¼r (deÄŸiÅŸtirebilirsiniz, ancak tekrar alamazsÄ±nÄ±z).\
**UygulamanÄ±n sahibi**, ona bir parola **ekleyebilir** (bÃ¶ylece onun yerine geÃ§ebilir).\
Bu hizmet baÅŸkanlarÄ±yla yapÄ±lan oturum aÃ§malar **riskli olarak iÅŸaretlenmez** ve **MFA'ya sahip olmazlar**.
{% endhint %}

### Uygulamalar ve (Kurumsal Uygulamalar veya Hizmet BaÅŸkanlarÄ±) ArasÄ±ndaki Fark

Azure'da bir uygulama ile bir Hizmet BaÅŸkanÄ± arasÄ±ndaki fark:

* **Uygulama/Uygulama KayÄ±tlarÄ±**: Azure AD'nizde bulunan uygulamalardÄ±r
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Hizmet BaÅŸkanÄ±/Kurumsal Uygulamalar**: Azure AD'nizdeki gÃ¼venlik nesneleridir ve Azure Dizini'nde **ayrÄ±calÄ±klara** sahip olabilirler ve uygulamanÄ±za veya Ã¼Ã§Ã¼ncÃ¼ taraf bir uygulamaya baÄŸlÄ±dÄ±r
* `(Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* EÄŸer izinler Ã§ok hassassa, bir yÃ¶netici bu izinleri onaylamak zorunda kalabilir.

Bir uygulama, **ÃœÃ§Ã¼ncÃ¼ taraf kiracÄ±**da Ã§alÄ±ÅŸabilir ve onu kullanmaya baÅŸladÄ±ÄŸÄ±nÄ±zda ve eriÅŸim verdiÄŸinizde, ihtiyaÃ§ duyduÄŸu bilgilere eriÅŸim saÄŸlamak iÃ§in **kendi kiracÄ±nÄ±zda bir Kurumsal Uygulama/Hizmet BaÅŸkanÄ± oluÅŸturulur**:

### YÃ¶netim Birimleri

KullanÄ±cÄ±larÄ±n daha iyi yÃ¶netimi iÃ§in kullanÄ±lÄ±r.

YÃ¶netim birimleri, bir roldeki izinleri tanÄ±mladÄ±ÄŸÄ±nÄ±z kuruluÅŸunuzun herhangi bir bÃ¶lÃ¼mÃ¼ne **izinleri sÄ±nÄ±rlar**. Ã–rneÄŸin, yÃ¶netim birimlerini kullanarak [YardÄ±m MasasÄ± YÃ¶neticisi](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) rolÃ¼nÃ¼ bÃ¶lgesel destek uzmanlarÄ±na devredebilir ve yalnÄ±zca destekledikleri bÃ¶lgedeki kullanÄ±cÄ±larÄ± yÃ¶netmelerine izin verebilirsiniz.

Bu nedenle, yÃ¶netici birimine roller atayabilir ve Ã¼yeleri bu rolleri alÄ±r.
```
```
# AzureAD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It is used to manage user identities and control access to resources in the Azure cloud environment.

## Enumeration

### User Enumeration

To enumerate users in Azure AD, you can use the following methods:

1. **Azure Portal**: Navigate to the Azure AD section in the Azure Portal and view the list of users.
2. **Azure AD Graph API**: Use the Azure AD Graph API to query for user information.
3. **Microsoft Graph API**: Use the Microsoft Graph API to query for user information.

### Group Enumeration

To enumerate groups in Azure AD, you can use the following methods:

1. **Azure Portal**: Navigate to the Azure AD section in the Azure Portal and view the list of groups.
2. **Azure AD Graph API**: Use the Azure AD Graph API to query for group information.
3. **Microsoft Graph API**: Use the Microsoft Graph API to query for group information.

### Application Enumeration

To enumerate applications in Azure AD, you can use the following methods:

1. **Azure Portal**: Navigate to the Azure AD section in the Azure Portal and view the list of applications.
2. **Azure AD Graph API**: Use the Azure AD Graph API to query for application information.
3. **Microsoft Graph API**: Use the Microsoft Graph API to query for application information.

## Exploitation

### Password Spray Attack

A password spray attack is a type of brute-force attack where a single password is tested against multiple user accounts. This attack is often used to bypass account lockout policies that are triggered by multiple failed login attempts.

To perform a password spray attack against Azure AD, you can use the following methods:

1. **Azure Portal**: Use the Azure Portal to manually test a single password against multiple user accounts.
2. **Azure AD Graph API**: Use the Azure AD Graph API to automate the password spray attack.
3. **Microsoft Graph API**: Use the Microsoft Graph API to automate the password spray attack.

### Password Hash Cracking

If you have obtained the password hashes of user accounts in Azure AD, you can attempt to crack them using password cracking tools such as Hashcat or John the Ripper.

### Token Impersonation

If you have obtained a valid access token for a user account in Azure AD, you can use it to impersonate that user and perform actions on their behalf. This can be done by modifying the token's claims or by using the token to authenticate requests to Azure AD.

### Privilege Escalation

To escalate privileges in Azure AD, you can try the following methods:

1. **Group Membership**: Check if the user account is a member of any privileged groups in Azure AD.
2. **Application Permissions**: Check if the user account has any privileged application permissions in Azure AD.
3. **Role-Based Access Control (RBAC)**: Check if the user account has any privileged RBAC roles assigned in Azure AD.

## Post-Exploitation

### Data Exfiltration

To exfiltrate data from Azure AD, you can use the following methods:

1. **Azure Portal**: Manually download or export data from the Azure Portal.
2. **Azure AD Graph API**: Use the Azure AD Graph API to programmatically retrieve and exfiltrate data.
3. **Microsoft Graph API**: Use the Microsoft Graph API to programmatically retrieve and exfiltrate data.

### Persistence

To maintain persistence in Azure AD, you can try the following methods:

1. **Service Principals**: Create a service principal with the necessary permissions to access Azure AD resources.
2. **Application Registrations**: Register an application in Azure AD and configure it to have the necessary permissions.
3. **Conditional Access Policies**: Configure conditional access policies to control access to Azure AD resources.

### Lateral Movement

To move laterally within Azure AD, you can try the following methods:

1. **Group Membership**: Add the compromised user account to privileged groups in Azure AD.
2. **Application Permissions**: Grant the compromised user account privileged application permissions in Azure AD.
3. **Role-Based Access Control (RBAC)**: Assign privileged RBAC roles to the compromised user account in Azure AD.

### Covering Tracks

To cover your tracks in Azure AD, you can try the following methods:

1. **Audit Logs**: Delete or modify audit logs to remove evidence of your activities.
2. **Azure AD Sign-Ins**: Delete or modify sign-in logs to remove evidence of your activities.
3. **Azure AD Directory Logs**: Delete or modify directory logs to remove evidence of your activities.

## References

- [Azure Active Directory Documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
- [Azure AD Graph API Documentation](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-graph-api)
- [Microsoft Graph API Documentation](https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-1.0)
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

## Azure AD Kimlik Koruma (AIP) <a href="#title-text" id="title-text"></a>

Azure AD Kimlik Koruma (AIP), Azure Active Directory'deki kullanÄ±cÄ± kimliklerini tehlikeye atÄ±lmaktan korumak iÃ§in otomatik tespit ve dÃ¼zeltme kullanarak bir gÃ¼venlik hizmetidir. AIP sÃ¼rekli olarak kullanÄ±cÄ± oturum aÃ§malarÄ±nÄ± ve kimlik yapÄ±landÄ±rmalarÄ±nÄ± izler ve risk deÄŸerlendirmesi yapar, Ã§ok faktÃ¶rlÃ¼ kimlik doÄŸrulama gerektirme veya potansiyel olarak tehlikeli faaliyetleri engelleme gibi uygun gÃ¼venlik Ã¶nlemlerini otomatik olarak uygular. Bu, kuruluÅŸlarÄ±n kimlik temelli gÃ¼venlik ihlallerini Ã¶nlemelerine yardÄ±mcÄ± olur.

AkÄ±ÅŸ:

1. Azure AD Kimlik Koruma, kullanÄ±cÄ± etkinliklerini izler ve oturum aÃ§malar, kimlik doÄŸrulama olaylarÄ± ve diÄŸer ilgili etkinlikler hakkÄ±nda veri toplar.
2. Hizmet, bu verileri analiz etmek ve potansiyel gÃ¼venlik tehditlerini tespit etmek iÃ§in makine Ã¶ÄŸrenimi algoritmalarÄ±nÄ± kullanÄ±r.
3. Azure AD Kimlik Koruma, tehdide (Ã¶rneÄŸin, oturum aÃ§ma) bir risk seviyesi atar ve gerektiÄŸinde otomatik bir eylem gerÃ§ekleÅŸtirmek iÃ§in bir uyarÄ± oluÅŸturur.

## Azure AD Åifre Koruma (APP)

Azure AD Åifre Koruma (APP), Azure Active Directory'de zayÄ±f ÅŸifreleri engelleyerek gÃ¼Ã§lÃ¼ ÅŸifre politikalarÄ±nÄ± zorlamaya yardÄ±mcÄ± olan bir gÃ¼venlik Ã¶zelliÄŸidir. APP, yaygÄ±n olarak kullanÄ±lan zayÄ±f ÅŸifreleri ve bunlarÄ±n varyantlarÄ±nÄ± engelleyerek ÅŸifreyle ilgili ihlallerin riskini azaltÄ±r. Hem bulut dÃ¼zeyinde hem de yerinde Active Directory'de uygulanabilir ve kuruluÅŸ genelinde ÅŸifre gÃ¼venliÄŸini artÄ±rÄ±r.

### Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da takip edin ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live).
* Hacking hilelerinizi gÃ¶ndererek **HackTricks** ve **HackTricks Cloud** github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
