# Az - AzureAD (AAD)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Active Directoryï¼ˆAzure ADï¼‰æ˜¯å¾®è½¯åŸºäºäº‘çš„èº«ä»½å’Œè®¿é—®ç®¡ç†æœåŠ¡ã€‚å®ƒåœ¨ä½¿å‘˜å·¥èƒ½å¤Ÿç™»å½•å¹¶è®¿é—®èµ„æºæ–¹é¢å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œæ— è®ºæ˜¯åœ¨ç»„ç»‡å†…éƒ¨è¿˜æ˜¯è¶…å‡ºç»„ç»‡èŒƒå›´ï¼ŒåŒ…æ‹¬Microsoft 365ã€Azureé—¨æˆ·å’Œä¼—å¤šå…¶ä»–SaaSåº”ç”¨ç¨‹åºã€‚Azure ADçš„è®¾è®¡ä¾§é‡äºæä¾›åŸºæœ¬çš„èº«ä»½æœåŠ¡ï¼Œä¸»è¦åŒ…æ‹¬**èº«ä»½éªŒè¯ã€æˆæƒå’Œç”¨æˆ·ç®¡ç†**ã€‚

Azure ADçš„å…³é”®åŠŸèƒ½åŒ…æ‹¬**å¤šå› ç´ èº«ä»½éªŒè¯**å’Œ**æ¡ä»¶è®¿é—®**ï¼Œä»¥åŠä¸å…¶ä»–Microsoftå®‰å…¨æœåŠ¡çš„æ— ç¼é›†æˆã€‚è¿™äº›åŠŸèƒ½æ˜¾è‘—æå‡äº†ç”¨æˆ·èº«ä»½çš„å®‰å…¨æ€§ï¼Œå¹¶ä½¿ç»„ç»‡èƒ½å¤Ÿæœ‰æ•ˆåœ°å®æ–½å’Œæ‰§è¡Œå…¶è®¿é—®ç­–ç•¥ã€‚ä½œä¸ºMicrosoftäº‘æœåŠ¡ç”Ÿæ€ç³»ç»Ÿçš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼ŒAzure ADå¯¹äºç”¨æˆ·èº«ä»½çš„åŸºäºäº‘çš„ç®¡ç†è‡³å…³é‡è¦ã€‚

## å®ä½“

### æšä¸¾

æ‚¨å¯ä»¥ä½¿ç”¨[**az cliå·¥å…·**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)\*\*ï¼Œ\*\*PowerShellæ¨¡å—[**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/)ï¼ˆæˆ–[**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)ï¼‰å’Œ[Az PowerShell](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps)æ¨¡å—è¿›è¡Œæ­¤æšä¸¾ã€‚

{% hint style="success" %}
åœ¨Linuxä¸­ï¼Œæ‚¨éœ€è¦å®‰è£…PowerShell Core:

```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **æ¨¡å—å·®å¼‚**

* **AzureAD** æ˜¯å¾®è½¯çš„ PowerShell æ¨¡å—ï¼Œç”¨äº**ç®¡ç† Azure ADã€‚å®ƒä¸æ˜¾ç¤º Azure AD å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¹Ÿä¸èƒ½ç”¨äºè®¿é—® Azure èµ„æºä¿¡æ¯**ã€‚
* **Az PowerShell** æ˜¯ä¸€ä¸ªç”¨äº**ç®¡ç† Azure èµ„æº**çš„æ¨¡å—ï¼Œå¯é€šè¿‡ PowerShell å‘½ä»¤è¡Œä½¿ç”¨ã€‚

### **è¿æ¥**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="åŸå§‹ PowerShell" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="åŸå§‹æ“ä½œç³»ç»Ÿ" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

å½“æ‚¨é€šè¿‡CLIç™»å½•åˆ°Azureæ—¶ï¼Œæ‚¨æ­£åœ¨ä½¿ç”¨å±äºMicrosoftçš„ç§Ÿæˆ·çš„Azureåº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºï¼Œå°±åƒæ‚¨å¯ä»¥åœ¨æ‚¨çš„å¸æˆ·ä¸­åˆ›å»ºçš„åº”ç”¨ç¨‹åºä¸€æ ·ï¼Œéƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯IDã€‚æ‚¨åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°çš„**å…è®¸åº”ç”¨ç¨‹åºåˆ—è¡¨**ä¸­**ä¸ä¼šçœ‹åˆ°æ‰€æœ‰è¿™äº›åº”ç”¨ç¨‹åº**ï¼Œä½†å®ƒä»¬é»˜è®¤æ˜¯å…è®¸çš„ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ª**PowerShellè„šæœ¬**è¿›è¡Œèº«ä»½éªŒè¯æ—¶ä½¿ç”¨çš„åº”ç”¨ç¨‹åºå…·æœ‰å®¢æˆ·ç«¯ID **`1950a258-227b-4e31-a9cf-717495945fc2`**ã€‚å³ä½¿è¯¥åº”ç”¨ç¨‹åºåœ¨æ§åˆ¶å°ä¸­ä¸å¯è§ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä»ç„¶å¯ä»¥**é˜»æ­¢è¯¥åº”ç”¨ç¨‹åº**ï¼Œä»¥ä¾¿ç”¨æˆ·æ— æ³•ä½¿ç”¨é€šè¿‡è¯¥åº”ç”¨ç¨‹åºè¿æ¥çš„å·¥å…·è¿›è¡Œè®¿é—®ã€‚

ç„¶è€Œï¼Œè¿˜æœ‰**å…¶ä»–åº”ç”¨ç¨‹åºçš„å®¢æˆ·ç«¯ID**å°†å…è®¸æ‚¨è¿æ¥åˆ°Azureï¼š

```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```

### ç”¨æˆ·

```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD user enumeration can be performed using the Graph API. By making requests to `https://graph.windows.net/<TENANT_ID>/users`, an attacker can retrieve a list of users in the Azure AD tenant. This information can be useful for further attacks such as password spraying or targeted phishing campaigns.

**Group Enumeration**

Similarly, group enumeration can be done by querying `https://graph.windows.net/<TENANT_ID>/groups`. This can help an attacker identify different groups within the Azure AD tenant and understand the relationships between users and groups.

#### Password Attacks

**Password Spraying**

Password spraying attacks can be conducted against Azure AD using tools like `MSOLSpray` or custom scripts. By trying a small number of common passwords against a large number of usernames, an attacker can attempt to gain access to accounts without triggering account lockouts.

**Brute Force Attacks**

Brjson is a powerful tool for performing brute force attacks against Azure AD accounts. Attackers can use password lists and customize attack parameters to crack weak passwords and gain unauthorized access.

#### Phishing

Phishing attacks targeting Azure AD users can be highly effective. By creating convincing phishing emails or login pages that mimic Azure AD prompts, attackers can trick users into revealing their credentials. These credentials can then be used to access sensitive resources within the Azure AD environment.

#### Token Manipulation

Azure AD tokens can be manipulated to escalate privileges or gain unauthorized access to resources. Techniques like token replay attacks or token forgery can be used to exploit weaknesses in token handling and authentication mechanisms.

#### Account Takeover

Once an attacker has obtained valid credentials, they can perform an account takeover within Azure AD. This can lead to unauthorized access to sensitive data, impersonation of users, or further lateral movement within the Azure AD environment.

#### Monitoring and Detection

Monitoring Azure AD logs and setting up alerts for suspicious activities can help detect and respond to potential security incidents. By monitoring sign-in logs, audit logs, and other relevant events, organizations can identify unauthorized access attempts and take appropriate actions to secure their Azure AD environment.

#### Recommendations

* Implement strong password policies and multi-factor authentication to protect Azure AD accounts.
* Regularly review and update group memberships to ensure least privilege access.
* Educate users about phishing techniques and encourage reporting of suspicious emails or activities.
* Enable logging and monitoring in Azure AD to track and analyze user activities for signs of compromise.
* Conduct regular security assessments and penetration testing to identify and address vulnerabilities in the Azure AD environment.

```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```

### Az PowerShell

#### Description

The Az PowerShell module is used to manage Azure resources using PowerShell. It provides cmdlets that allow you to interact with Azure services and automate tasks.

#### Usage

1.  Install the Az PowerShell module:

    ```powershell
    Install-Module -Name Az -AllowClobber -Scope CurrentUser
    ```
2.  Import the Az module:

    ```powersjson
    Import-Module Az
    ```
3.  Connect to your Azure account:

    ```powershell
    Connect-AzAccount
    ```
4.  Run cmdlets to manage Azure resources:

    ```powershell
    Get-AzResourceGroup
    New-AzVM
    ```

#### Additional Resources

* [Az PowerShell Documentation](https://docs.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-6.0.0)
* [Az PowerShell GitHub Repository](https://github.com/Azure/azure-powershell)

```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```

#### æ›´æ”¹ç”¨æˆ·å¯†ç 

{% code overflow="wrap" %}
```
```
{% endcode %}

```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText â€“Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password â€“Verbose
```

### MFA & Conditional Access Policies

å¼ºçƒˆå»ºè®®ä¸ºæ¯ä¸ªç”¨æˆ·æ·»åŠ MFAï¼Œç„¶è€Œï¼Œä¸€äº›å…¬å¸å¯èƒ½ä¸ä¼šè®¾ç½®å®ƒï¼Œæˆ–è€…å¯èƒ½ä¼šé€šè¿‡æ¡ä»¶è®¿é—®è®¾ç½®å®ƒï¼šå¦‚æœç”¨æˆ·ä»ç‰¹å®šä½ç½®ã€æµè§ˆå™¨æˆ–æŸäº›æ¡ä»¶ç™»å½•ï¼Œåˆ™**éœ€è¦MFA**ã€‚å¦‚æœè¿™äº›ç­–ç•¥é…ç½®ä¸æ­£ç¡®ï¼Œå¯èƒ½ä¼šå®¹æ˜“å—åˆ°**ç»•è¿‡**æ”»å‡»ã€‚æ£€æŸ¥ï¼š

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Groups

```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data inconsistencies and security vulnerabilities in Azure AD.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Reports

Leveraging security reports in Azure AD can help identify security weaknesses, track suspicious activities, and improve overall security posture.

#### Threat Detection

Utilizing threat detection capabilities in Azure AD can help detect and respond to suspicious activities, potential breaches, and advanced threats.

#### Security Best Practices

Following security best practices for Azure AD can help mitigate risks, protect sensitive data, and enhance the overall security of the environment.

#### Compliance Assessments

Conducting compliance assessments in Azure AD can ensure that security controls are properly implemented, and regulatory requirements are met.

#### Incident Response

Establishing an incident response plan for Azure AD can help organizations effectively respond to security incidents, minimize impact, and facilitate recovery.

#### Security Automation

Implementing security automation tools and processes in Azure AD can help streamline security operations, improve incident response times, and enhance overall security posture.

#### Security Training

Providing security training to users and administrators in Azure AD can raise awareness about security risks, promote best practices, and enhance security awareness.

#### Third-Party Integrations

Evaluating security implications of third-party integrations with Azure AD can help identify potential risks, ensure data protection, and maintain a secure environment.

#### Data Encryption

Implementing data encryption mechanisms in Azure AD can help protect sensitive information, prevent unauthorized access, and maintain data confidentiality.

#### Network Security

Implementing network security controls in Azure AD can help defend against network-based attacks, secure communication channels, and protect data in transit.

#### Vulnerability Management

Regularly scanning for and remediating vulnerabilities in Azure AD can help prevent exploitation by attackers, reduce security risks, and safeguard the environment.

#### Patch Management

Applying security patches and updates to Azure AD components can address known vulnerabilities, improve system security, and protect against exploits.

#### Secure Configuration

Applying secure configurations to Azure AD components can reduce security gaps, minimize attack surfaces, and enhance overall security posture.

#### Log Management

Implementing robust log management practices in Azure AD can help track security events, investigate incidents, and meet compliance requirements.

#### Intrusion Detection

Deploying intrusion detection systems in Azure AD can help detect and respond to unauthorized access attempts, malicious activities, and security breaches.

#### Penetration Testing

Conducting penetration tests against Azure AD can help identify security weaknesses, validate defenses, and improve incident response preparedness.

#### Security Monitoring

Implementing continuous security monitoring in Azure AD can help detect anomalies, identify threats, and respond to security incidents in a timely manner.

#### Disaster Recovery

Establishing disaster recovery plans for Azure AD can help ensure business continuity, minimize data loss, and recover from security incidents effectively.

#### Cloud Security Posture Management

Utilizing cloud security posture management tools in Azure AD can help assess security posture, enforce compliance, and mitigate risks in the cloud environment.

#### Conclusion

Securing Azure AD is essential to protecting identities, data, and resources in the cloud environment. By understanding common security risks and implementing best practices, organizations can enhance the security posture of their Azure AD deployment.

```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@company.com
    ```
4.  **Output**

    The script will output the roles assigned to the specified user or group.
5.  **Impact**

    This information can be used to understand the level of access a user or group has within Azure AD.
6.  **Recommendation**

    Regularly review and audit Azure AD roles to ensure least privilege access is maintained.

```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```

#### å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„

ç»„çš„æ‰€æœ‰è€…å¯ä»¥å°†æ–°ç”¨æˆ·æ·»åŠ åˆ°ç»„ä¸­

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
ç»„å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€**å¦‚æœç”¨æˆ·æ»¡è¶³æŸäº›æ¡ä»¶ï¼Œä»–å°†è¢«æ·»åŠ åˆ°ä¸€ä¸ªç»„ä¸­**ã€‚å½“ç„¶ï¼Œå¦‚æœæ¡ä»¶æ˜¯åŸºäº**ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„å±æ€§**ï¼Œä»–å¯èƒ½ä¼šæ»¥ç”¨è¿™ä¸ªåŠŸèƒ½æ¥**è¿›å…¥å…¶ä»–ç»„**ã€‚\
æŸ¥çœ‹å¦‚ä½•æ»¥ç”¨åŠ¨æ€ç»„åœ¨ä»¥ä¸‹é¡µé¢ï¼š
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### æœåŠ¡ä¸»ä½“ / ä¼ä¸šåº”ç”¨ç¨‹åº

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨ PowerShell æœ¯è¯­ä¸­**Service Principal**åœ¨ Azure é—¨æˆ·ï¼ˆWebï¼‰ä¸­è¢«ç§°ä¸º**Enterprise Applications**ã€‚
{% endhint %}

```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```

### Azure AD Enumeration

#### User Enumeration

To enumerate users in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you gather information about users, groups, and contacts in the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Collect user information** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather user information from Azure AD.

#### Group Enumeration

To enumerate groups in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you identify different groups and their members within the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Enumerate groups** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather group information from Azure AD.

#### Contact Enumeration

To enumerate contacts in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you discover information about contacts stored in the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Retrieve contact information** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather contact information from Azure AD.

### Summary

Enumerating users, groups, and contacts in Azure AD is essential for understanding the structure and relationships within the Azure AD environment. By using tools like Azure AD Recon or Azure AD Connect, you can gather valuable information that may assist in further penetration testing activities.

```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@domain.com
    ```
4.  **Impact**

    This script helps identify the roles assigned to users and groups in Azure AD, which can be useful for understanding the level of access different entities have within the Azure environment.
5.  **Recommendation**

    Regularly review and audit the roles assigned in Azure AD to ensure that users and groups have appropriate access levels.

```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```

```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

<details>

<summary>åˆ—å‡ºå¹¶å°è¯•åœ¨æ¯ä¸ªä¼ä¸šåº”ç”¨ç¨‹åºä¸Šæ·»åŠ å®¢æˆ·ç«¯å¯†é’¥</summary>

\`\`\`powershell # Just call Add-AzADAppSecret Function Add-AzADAppSecret { <# .SYNOPSIS Add client secret to the applications.

.PARAMETER GraphToken Pass the Graph API Token

.EXAMPLE PS C:> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0\&tabs=http https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0\&tabs=http #>

\[CmdletBinding()] param( \[Parameter(Mandatory=$True)] \[String] $GraphToken = $null )

$AppList = $null $AppPassword = $null

## List All the Applications

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications" "Method" = "GET" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

try { $AppList = Invoke-RestMethod @Params -UseBasicParsing } catch { }

## Add Password in the Application

if($AppList -ne $null) { \[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value) { $ID = $App.ID $psobj = New-Object PSObject

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword" "Method" = "POST" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

$Body = @{ "passwordCredential"= @{ "displayName" = "Password" } }

try { $AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json) Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText $Details.Add($psobj) | Out-Null } catch { Write-Output "Failed to add new client secret to '$($App.displayName)' Application." } } if($Details -ne $null) { Write-Output "" Write-Output "Client secret added to : " Write-Output $Details | fl \* } } else { Write-Output "Failed to Enumerate the Applications." } }

````
</details>

### è§’è‰²

<div data-gb-custom-block data-tag="tabs"></div>

<div data-gb-custom-block data-tag="tab" data-title='az cli'>

```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
````

</details>

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@contoso.com
    ```
4.  **Output**

    The script will output the roles assigned to the specified user or group.

```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```

```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

#### è®¾å¤‡

```bash
# If you know how to do this send a PR!
```

### Azure AD Enumeration

#### User Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate users.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated user enumeration.

#### Group Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate groups.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated group enumeration.

#### Application Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate applications.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated application enumeration.

#### Device Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate devices.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated device enumeration.

### Azure AD Exploitation

#### Password Spraying

1. **Password Sprjsonaying**: Use tools like `MSOLSpray` or `AzureSpray` for password spraying attacks against Azure AD.

#### Password Cracking

1. **Password Cracking**: Use tools like `Hashcat` or `John the Ripper` for cracking Azure AD passwords.

#### Token Impersonation

1. **Token Impersonation**: Exploit token impersonation vulnerabilities to gain unauthorized access.

#### Password Policies

1. **Password Policies**: Check for weak password policies in Azure AD that can be exploited.

#### Privilege Escalation

1. **Privilege Escalation**: Exploit misconfigurations or vulnerabilities to escalate privileges within Azure AD.

#### Federation Trust

1. **Federation Trust**: Exploit misconfigurations in federation trust to gain unauthorized access.

#### OAuth Abuse

1. **OAuth Abuse**: Abuse OAuth vulnerabilities to gain unauthorized access to resources.

#### SAML Abuse

1. **SAML Abuse**: Abuse SAML vulnerabilities to gain unauthorized access to resources.

#### Phishing

1. **Phishing**: Conduct phishing attacks to steal credentials or sensitive information.

#### MFA Bypass

1. **MFA Bypass**: Bypass multi-factor authentication controls to gain unauthorized access.

#### Account Takeover

1. **Account Takeover**: Take over user accounts by exploiting vulnerabilities or weak credentials.

#### Data Exfiltration

1. **Data Exfiltration**: Extract sensitive data from Azure AD using various techniques.

#### Persistence

1. **Persistence**: Maintain access to Azure AD by establishing persistence mechanisms.

#### Enumeration

1. **Enumeration**: Continuously enumerate Azure AD for new information and potential vulnerabilities.

#### Reporting

1. **Reporting**: Document all findings and prepare a detailed report for the client.

```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```

{% hint style="warning" %}
å¦‚æœè®¾å¤‡ï¼ˆVMï¼‰åŠ å…¥äº†**AzureAD**ï¼Œåˆ™æ¥è‡ªAzureADçš„ç”¨æˆ·å°†èƒ½å¤Ÿ**ç™»å½•**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœç™»å½•ç”¨æˆ·æ˜¯è®¾å¤‡çš„**æ‰€æœ‰è€…**ï¼Œä»–å°†æˆä¸º**æœ¬åœ°ç®¡ç†å‘˜**ã€‚
{% endhint %}

### åº”ç”¨ç¨‹åº

{% hint style="info" %}
**åº”ç”¨ç¨‹åº**æ˜¯é—¨æˆ·ä¸­çš„**åº”ç”¨æ³¨å†Œ**ï¼ˆä¸æ˜¯ä¼ä¸šåº”ç”¨ç¨‹åºï¼‰ã€‚\
ä½†æ˜¯ï¼Œæ¯ä¸ªåº”ç”¨æ³¨å†Œå°†åˆ›å»ºä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„**ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼ˆ**æœåŠ¡ä¸»ä½“**ï¼‰ã€‚\
æ­¤å¤–ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ˜¯**å¤šç§Ÿæˆ·åº”ç”¨ç¨‹åº**ï¼Œå°†åœ¨**è¯¥ç§Ÿæˆ·**ä¸­åˆ›å»ºå¦ä¸€ä¸ª**ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼ˆ**æœåŠ¡ä¸»ä½“**ï¼‰å…·æœ‰ç›¸åŒçš„åç§°ã€‚
{% endhint %}

ç”Ÿæˆåº”ç”¨ç¨‹åºæ—¶ä¼šèµ‹äºˆä¸¤ç§ç±»å‹çš„æƒé™ï¼š

* èµ‹äºˆ**æœåŠ¡ä¸»ä½“**çš„**æƒé™**
* **åº”ç”¨ç¨‹åº**å¯ä»¥æ‹¥æœ‰å¹¶ä»£è¡¨**ç”¨æˆ·**ä½¿ç”¨çš„**æƒé™**ã€‚

```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```

### Azure AD Enumeration

#### Description

Azure AD enumeration is the process of gathering information about Azure AD users, groups, roles, and permissions. This information can be used by attackers to identify potential targets for further attacks.

#### Techniques

1. **Enumerate Users**: Use PowerShell scripts to list all Azure AD users and their properties.
2. **Enumerate Groups**: Use PowerShell scripts to list all Azure AD groups and their members.
3. **Enumerate Roles**: Use PowerShell scripts to list all Azure AD roles and their assigned members.
4. **Enumerate Permissions**: Use PowerShell scripts to list all Azure AD permissions assigned to users, groups, or roles.

#### Impact

Azure AD enumeration can help attackers identify high-value targets within an organization, understand the structure of the Azure AD environment, and plan further attacks such as privilege escalation or lateral movement.

#### Detection

Monitor Azure AD logs for suspicious activities related to user, group, role, or permission enumeration. Look for multiple failed login attempts, unusual patterns of access, or changes to user permissions.

#### Prevention

1. Implement strong password policies and multi-factor authentication to prevent unauthorized access to Azure AD accounts.
2. Regularly review and update user permissions to ensure least privilege access.
3. Monitor Azure AD logs for unusual activities and investigate any suspicious behavior promptly.

#### References

* [Microsoft Azure Active Directory documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
* [Azure AD PowerShell module documentation](https://docs.microsoft.com/en-us/powershell/azure/active-directory/overview)

```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```

{% hint style="warning" %}
å…·æœ‰æƒé™ **`AppRoleAssignment.ReadWrite`** çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡æˆäºˆè‡ªèº«è§’è‰²æ¥**å‡çº§ä¸ºå…¨å±€ç®¡ç†å‘˜**ã€‚\
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[**æ­¤å¤„**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)ã€‚
{% endhint %}

{% hint style="info" %}
åº”ç”¨ç¨‹åºç”¨äºåœ¨è¯·æ±‚ä»¤ç‰Œæ—¶è¯æ˜å…¶èº«ä»½çš„ç§˜å¯†å­—ç¬¦ä¸²æ˜¯åº”ç”¨ç¨‹åºå¯†ç ã€‚\
å› æ­¤ï¼Œå¦‚æœæ‰¾åˆ°æ­¤**å¯†ç **ï¼Œæ‚¨å¯ä»¥ä½œä¸º**æœåŠ¡ä¸»ä½“** **åœ¨** **ç§Ÿæˆ·å†…**è®¿é—®ã€‚\
è¯·æ³¨æ„ï¼Œæ­¤å¯†ç ä»…åœ¨ç”Ÿæˆæ—¶å¯è§ï¼ˆæ‚¨å¯ä»¥æ›´æ”¹å®ƒï¼Œä½†æ— æ³•å†æ¬¡è·å–å®ƒï¼‰ã€‚\
**åº”ç”¨ç¨‹åº**çš„**æ‰€æœ‰è€…**å¯ä»¥ä¸ºå…¶**æ·»åŠ å¯†ç **ï¼ˆä»¥ä¾¿å†’å……å®ƒï¼‰ã€‚\
ä»¥è¿™äº›æœåŠ¡ä¸»ä½“çš„èº«ä»½ç™»å½•**ä¸ä¼šè¢«æ ‡è®°ä¸ºé£é™©**ï¼Œä¹Ÿ**ä¸ä¼šæœ‰å¤šé‡èº«ä»½éªŒè¯**ã€‚
{% endhint %}

### åº”ç”¨ç¨‹åºå’Œï¼ˆä¼ä¸šåº”ç”¨ç¨‹åºæˆ–æœåŠ¡ä¸»ä½“ï¼‰çš„åŒºåˆ«

Azure ä¸­åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“ä¹‹é—´çš„åŒºåˆ«ï¼š

* **åº”ç”¨ç¨‹åº/åº”ç”¨æ³¨å†Œ**ï¼šå­˜åœ¨äºæ‚¨çš„ Azure AD ä¸­çš„åº”ç”¨ç¨‹åº
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **æœåŠ¡ä¸»ä½“/ä¼ä¸šåº”ç”¨ç¨‹åº**ï¼šAzure AD ä¸­çš„å®‰å…¨å¯¹è±¡ï¼Œå¯ä»¥åœ¨ Azure ç›®å½•ä¸­å…·æœ‰**ç‰¹æƒ**ï¼Œå¹¶ä¸æ‚¨çš„åº”ç”¨ç¨‹åºæˆ–ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå…³è”
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* å¦‚æœæƒé™éå¸¸æ•æ„Ÿï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦æ‰¹å‡†ç»™å®šçš„æƒé™ã€‚

ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥åœ¨**ç¬¬ä¸‰æ–¹ç§Ÿæˆ·**ä¸­è¿è¡Œï¼Œä¸€æ—¦å¼€å§‹ä½¿ç”¨å®ƒå¹¶æˆäºˆè®¿é—®æƒé™ï¼Œ**åœ¨æ‚¨çš„ç§Ÿæˆ·ä¸­å°†åˆ›å»ºä¸€ä¸ªä¼ä¸šåº”ç”¨ç¨‹åº/æœåŠ¡ä¸»ä½“**ï¼Œä»¥ä¾¿ä¸ºå…¶æä¾›æ‰€éœ€çš„ä¿¡æ¯è®¿é—®æƒé™ï¼š

### ç®¡ç†å•å…ƒ

ç”¨äºæ›´å¥½åœ°ç®¡ç†ç”¨æˆ·ã€‚

ç®¡ç†å•å…ƒ**å°†è§’è‰²çš„æƒé™é™åˆ¶ä¸ºæ‚¨å®šä¹‰çš„ç»„ç»‡çš„ä»»ä½•éƒ¨åˆ†**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç®¡ç†å•å…ƒå°†[Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator)è§’è‰²å§”æ´¾ç»™åŒºåŸŸæ”¯æŒä¸“å‘˜ï¼Œä»¥ä¾¿ä»–ä»¬ä»…èƒ½ç®¡ç†å…¶æ”¯æŒçš„åŒºåŸŸä¸­çš„ç”¨æˆ·ã€‚

å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†è§’è‰²åˆ†é…ç»™ç®¡ç†å‘˜å•å…ƒï¼Œå…¶æˆå‘˜å°†å…·æœ‰è¿™äº›è§’è‰²ã€‚

```
```

### AzureAD Enumeration

#### User Enumeration

To enumerate users in AzureAD, you can use tools like `Azure AD Connect` or `Azure AD Graph API`. These tools can help you gather information about users, groups, and other directory objects in the Azure Active Directory.

**Using Azure AD Connect**

1. Install and configure Azure AD Connect on your local machine.
2. Use the synchronization feature to sync Azure AD with your local AD.
3. Once synced, you can use the Azure AD Connect interface to view and manage user accounts.

**Using Azure AD Graph API**

1. Authenticate with Azure AD Graph API using tools like `Postman` or `curl`.
2. Send API requests to query user information suchjson as user IDs, emails, and group memberships.

#### Group Enumeration

To enumerate groups in AzureAD, you can use the same tools mentioned above (`Azure AD Connect` or `Azure AD Graph API`). These tools allow you to retrieve information about groups, including their members and permissions.

**Using Azure AD Connect**

Follow the same steps as for user enumeration, but focus on groups instead of individual user accounts.

**Using Azure AD Graph API**

Send API requests to query group information such as group names, member lists, and group permissions.

#### Device Enumeration

To enumerate devices in AzureAD, you can again utilize tools like `Azure AD Connect` or `Azure AD Graph API`. These tools enable you to collect information about devices registered in the Azure Active Directory.

**Using Azure AD Connect**

Similar to user and group enumeration, install and configure Azure AD Connect, then navigate to the device management section to view device details.

**Using Azure AD Graph API**

Authenticate with Azure AD Graph API and send API requests to retrieve device information such as device IDs, types, and registration status.

### Summary

AzureAD enumeration is crucial for understanding the structure and entities within an Azure Active Directory environment. By leveraging tools like `Azure AD Connect` and `Azure AD Graph API`, you can gather valuable information about users, groups, and devices, aiding in the overall security assessment of the AzureAD environment.

\`\`\`powershell # Get Administrative Units Get-AzureADMSAdministrativeUnit Get-AzureADMSAdministrativeUnit -Id # Get ID of admin unit by string $adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'" # List the users, groups, and devices affected by the administrative unit Get-AzureADMSAdministrativeUnitMember -Id # Get the roles users have over the members of the AU Get-AzureADMSScopedRoleMembership -Id | fl #Get role ID and role members \`\`\` ## Azure ADèº«ä»½ä¿æŠ¤ï¼ˆAIPï¼‰

Azure ADèº«ä»½ä¿æŠ¤ï¼ˆAIPï¼‰æ˜¯ä¸€é¡¹å®‰å…¨æœåŠ¡ï¼Œåˆ©ç”¨**è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤**æ¥å¸®åŠ©ä¿æŠ¤Azure Active Directoryä¸­ç”¨æˆ·èº«ä»½ä¸è¢« compromiseã€‚AIPæŒç»­ç›‘è§†å’Œè¯„ä¼°ç”¨æˆ·ç™»å½•å’Œèº«ä»½é…ç½®çš„é£é™©ï¼Œ**è‡ªåŠ¨åº”ç”¨é€‚å½“çš„å®‰å…¨æªæ–½**ï¼Œå¦‚è¦æ±‚å¤šé‡èº«ä»½éªŒè¯æˆ–é˜»æ­¢æ½œåœ¨å±é™©æ´»åŠ¨ã€‚è¿™æœ‰åŠ©äºç»„ç»‡é¢„é˜²åŸºäºèº«ä»½çš„å®‰å…¨æ¼æ´ã€‚

æµç¨‹ï¼š

1. Azure ADèº«ä»½ä¿æŠ¤**ç›‘è§†ç”¨æˆ·æ´»åŠ¨**ï¼Œæ”¶é›†ç”¨æˆ·**ç™»å½•ã€è®¤è¯**äº‹ä»¶å’Œå…¶ä»–ç›¸å…³æ´»åŠ¨çš„æ•°æ®ã€‚
2. è¯¥æœåŠ¡ä½¿ç”¨**æœºå™¨å­¦ä¹ **ç®—æ³•åˆ†æè¿™äº›æ•°æ®ï¼Œæ£€æµ‹æ½œåœ¨çš„å®‰å…¨å¨èƒã€‚
3. Azure ADèº«ä»½ä¿æŠ¤**ä¸ºå¨èƒï¼ˆä¾‹å¦‚ç™»å½•ï¼‰åˆ†é…é£é™©çº§åˆ«**ï¼Œå¹¶åœ¨éœ€è¦æ—¶ç”Ÿæˆè­¦æŠ¥ä»¥æ‰§è¡Œä¸€äº›è‡ªåŠ¨æ“ä½œã€‚

### Azure ADå¯†ç ä¿æŠ¤ï¼ˆAPPï¼‰

Azure ADå¯†ç ä¿æŠ¤ï¼ˆAPPï¼‰æ˜¯ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œ**é€šè¿‡å¼ºåˆ¶æ‰§è¡Œå¼ºå¯†ç ç­–ç•¥**ï¼Œå¸®åŠ©é˜²æ­¢Azure Active Directoryä¸­çš„å¼±å¯†ç ã€‚APPé˜»æ­¢**å¸¸ç”¨çš„å¼±å¯†ç **åŠå…¶å˜ä½“ï¼Œé™ä½ä¸å¯†ç ç›¸å…³çš„é£é™©ã€‚å®ƒå¯ä»¥åœ¨äº‘çº§åˆ«å’Œæœ¬åœ°Active Directoryä¸Šéƒ½åº”ç”¨ï¼Œå¢å¼ºç»„ç»‡æ•´ä½“å¯†ç å®‰å…¨ã€‚

#### å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)
