# Az - Registracija ureÄ‘aja

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Kada se ureÄ‘aj pridruÅ¾i AzureAD-u, novi objekat se kreira u AzureAD-u.

Prilikom registracije ureÄ‘aja, **korisnik se traÅ¾i da se prijavi sa svojim nalogom** (uz zahtev za MFA ako je potrebno), zatim se traÅ¾e tokeni za servis registracije ureÄ‘aja, nakon Äega se traÅ¾i konaÄna potvrda.

Zatim, dva RSA para kljuÄeva se generiÅ¡u na ureÄ‘aju: **kljuÄ ureÄ‘aja** (**javni** kljuÄ) koji se Å¡alje **AzureAD-u** i **transportni** kljuÄ (**privatni** kljuÄ) koji se Äuva u TPM-u ako je moguÄ‡e.

Zatim, **objekat** se generiÅ¡e u **AzureAD-u** (ne u Intune-u) i AzureAD vraÄ‡a ureÄ‘aju **sertifikat** koji je potpisan od strane njega. MoÅ¾ete proveriti da li je **ureÄ‘aj pridruÅ¾en AzureAD-u** i informacije o **sertifikatu** (kao Å¡to je da li je zaÅ¡tiÄ‡en TPM-om).:
```bash
dsregcmd /status
```
Nakon registracije ureÄ‘aja, modul LSASS CloudAP zahteva **Primarni osveÅ¾avajuÄ‡i token (PRT)** i dodeljuje ga ureÄ‘aju. Uz PRT se takoÄ‘e dostavlja **kljuÄ sesije koji je Å¡ifrovan tako da samo ureÄ‘aj moÅ¾e da ga deÅ¡ifruje** (koristeÄ‡i javni kljuÄ transportnog kljuÄa) i **potreban je za koriÅ¡Ä‡enje PRT-a**.

Za viÅ¡e informacija o tome Å¡ta je PRT, pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** Å¡titi od **izvlaÄenja kljuÄeva** sa iskljuÄenog ureÄ‘aja (ako je zaÅ¡tiÄ‡en PIN-om) i od izvlaÄenja privatnog materijala sa OS sloja.\
MeÄ‘utim, **ne Å¡titi** od **snifiranja** fiziÄke veze izmeÄ‘u TPM-a i CPU-a ili od **koriÅ¡Ä‡enja kriptografskog materijala** u TPM-u dok sistem radi iz procesa sa **SYSTEM** privilegijama.

Ako proverite sledeÄ‡u stranicu, videÄ‡ete da **ukradeni PRT** moÅ¾e biti koriÅ¡Ä‡en za pristup kao **korisnik**, Å¡to je odliÄno jer se **PRT nalazi na ureÄ‘ajima**, pa ga je moguÄ‡e ukrasti (ili ako nije ukraden, zloupotrebiti za generisanje novih potpisnih kljuÄeva):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registracija ureÄ‘aja sa SSO tokenima

NapadaÄ bi mogao da zatraÅ¾i token za Microsoft-ovu uslugu registracije ureÄ‘aja sa kompromitovanog ureÄ‘aja i da ga registruje:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Å to Ä‡e vam dati **sertifikat koji moÅ¾ete koristiti za traÅ¾enje PRT-ova u buduÄ‡nosti**. Na taj naÄin odrÅ¾avate postojanost i **zaobilazite MFA** jer je originalni PRT token koji se koristio za registraciju novog ureÄ‘aja **veÄ‡ imao dozvole za MFA**.

{% hint style="success" %}
Imajte na umu da za izvoÄ‘enje ovog napada trebate dozvole za **registraciju novih ureÄ‘aja**. TakoÄ‘e, registracija ureÄ‘aja ne znaÄi da Ä‡e ureÄ‘aj biti **dopuÅ¡ten za upisivanje u Intune**.
{% endhint %}

{% hint style="danger" %}
Ovaj napad je popravljen u septembru 2021. godine, jer viÅ¡e nije moguÄ‡e registrovati nove ureÄ‘aje koristeÄ‡i SSO tokene. MeÄ‘utim, i dalje je moguÄ‡e registrovati ureÄ‘aje na legitimni naÄin (imajuÄ‡i korisniÄko ime, lozinku i MFA ako je potrebno). Proverite: [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Prebrisavanje tiketa ureÄ‘aja

Bilo je moguÄ‡e **zatraÅ¾iti tiket ureÄ‘aja**, **prebrisati** trenutni tiket ureÄ‘aja i tokom toga **ukrasti PRT** (tako da nije potrebno kradenje iz TPM-a. Za viÅ¡e informacija [**proverite ovaj govor**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
MeÄ‘utim, ovo je ispravljeno.
{% endhint %}

## Prebrisavanje WHFB kljuÄa

**[Proverite originalne slajdove ovde](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

SaÅ¾etak napada:

* MoguÄ‡e je **prebrisati** registrovani WHFB kljuÄ sa **ureÄ‘aja** putem SSO-a
* To **zaobilazi TPM zaÅ¡titu** jer se kljuÄ **presreÄ‡e tokom generisanja** novog kljuÄa
* Ovo takoÄ‘e pruÅ¾a **postojanost**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Korisnici mogu izmeniti svoj svojstvo searchableDeviceKey putem Azure AD Graph-a, meÄ‘utim, napadaÄ mora imati ureÄ‘aj u zakupu (registrovan na licu mesta ili ukraden sertifikat + kljuÄ sa legitimnog ureÄ‘aja) i vaÅ¾eÄ‡i pristupni token za AAD Graph.

Zatim je moguÄ‡e generisati novi kljuÄ sa:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
a zatim PROMENITE informacije o searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

MoguÄ‡e je dobiti pristupni token od korisnika putem **device code phishing** i iskoristiti prethodne korake da **ukradete njegov pristup**. Za viÅ¡e informacija pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Reference

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
