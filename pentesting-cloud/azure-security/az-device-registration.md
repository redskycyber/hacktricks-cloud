# Az - è®¾å¤‡æ³¨å†Œ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

å½“è®¾å¤‡åŠ å…¥AzureADæ—¶ï¼Œåœ¨AzureADä¸­åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚

åœ¨æ³¨å†Œè®¾å¤‡æ—¶ï¼Œ**ç”¨æˆ·è¢«è¦æ±‚ä½¿ç”¨è‡ªå·±çš„å¸æˆ·ç™»å½•**ï¼ˆå¦‚æœéœ€è¦ï¼Œä¼šè¦æ±‚è¿›è¡ŒMFAéªŒè¯ï¼‰ï¼Œç„¶åè¯·æ±‚è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼Œç„¶åè¦æ±‚æœ€ç»ˆç¡®è®¤æç¤ºã€‚

ç„¶åï¼Œåœ¨è®¾å¤‡ä¸Šç”Ÿæˆä¸¤å¯¹RSAå¯†é’¥ï¼š**è®¾å¤‡å¯†é’¥**ï¼ˆ**å…¬é’¥**ï¼‰å‘é€åˆ°**AzureAD**ï¼Œ**ä¼ è¾“**å¯†é’¥ï¼ˆ**ç§é’¥**ï¼‰å¦‚æœå¯èƒ½çš„è¯åˆ™å­˜å‚¨åœ¨TPMä¸­ã€‚

ç„¶åï¼Œåœ¨**AzureAD**ä¸­ç”Ÿæˆ**å¯¹è±¡**ï¼ˆè€Œä¸æ˜¯åœ¨Intuneä¸­ï¼‰ï¼ŒAzureADä¼šå‘è®¾å¤‡è¿”å›ç”±å…¶ç­¾åçš„**è¯ä¹¦**ã€‚æ‚¨å¯ä»¥æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²åŠ å…¥AzureADä»¥åŠæœ‰å…³è¯ä¹¦çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚æ˜¯å¦ç”±TPMä¿æŠ¤ï¼‰ã€‚
```bash
dsregcmd /status
```
åœ¨è®¾å¤‡æ³¨å†Œåï¼ŒLSASS CloudAP æ¨¡å—ä¼šè¯·æ±‚ä¸€ä¸ª**ä¸»åˆ·æ–°ä»¤ç‰Œï¼ˆPrimary Refresh Tokenï¼ŒPRTï¼‰**å¹¶å°†å…¶æä¾›ç»™è®¾å¤‡ã€‚PRT è¿˜ä¼šä¼ é€**ä¼šè¯å¯†é’¥ä»¥åŠ å¯†ï¼Œåªæœ‰è®¾å¤‡æ‰èƒ½è§£å¯†**ï¼ˆä½¿ç”¨ä¼ è¾“å¯†é’¥çš„å…¬é’¥ï¼‰ï¼Œè¿™æ˜¯**ä½¿ç”¨ PRT æ‰€å¿…éœ€çš„**ã€‚

æœ‰å…³ PRT çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - å—ä¿¡ä»»å¹³å°æ¨¡å—

**TPM** å¯ä»¥**é˜²æ­¢**åœ¨è®¾å¤‡å…³æœºæ—¶ï¼ˆå¦‚æœå— PIN ä¿æŠ¤ï¼‰ä»ä¸­æå–å¯†é’¥ï¼Œå¹¶é˜²æ­¢ä» OS å±‚æå–ç§æœ‰ææ–™ã€‚\
ä½†å®ƒ**æ— æ³•é˜²æ­¢**åœ¨ TPM ä¸ CPU ä¹‹é—´çš„ç‰©ç†è¿æ¥è¢«**çªƒå¬**ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ä»å…·æœ‰**SYSTEM**æƒé™çš„è¿›ç¨‹ä¸­**ä½¿ç”¨ TPM ä¸­çš„åŠ å¯†ææ–™**ã€‚

å¦‚æœæ‚¨æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨å°†çœ‹åˆ°**çªƒå– PRT**å¯ç”¨äºåƒ**ç”¨æˆ·**ä¸€æ ·è®¿é—®ï¼Œè¿™å¾ˆæ£’ï¼Œå› ä¸º**PRT å­˜å‚¨åœ¨è®¾å¤‡ä¸­**ï¼Œå› æ­¤å¯ä»¥ä»ä¸­çªƒå–ï¼ˆæˆ–è€…å¦‚æœæœªè¢«çªƒå–ï¼Œåˆ™æ»¥ç”¨ä»¥ç”Ÿæˆæ–°çš„ç­¾åå¯†é’¥ï¼‰ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ä½¿ç”¨ SSO ä»¤ç‰Œæ³¨å†Œè®¾å¤‡

æ”»å‡»è€…å¯ä»¥ä»å—æŸè®¾å¤‡è¯·æ±‚ Microsoft è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼š
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
ç„¶åï¼Œæ‚¨å¯ä»¥æ³¨å†Œè®¾å¤‡ï¼š

<figure><img src="../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

è¿™å°†ä¸ºæ‚¨æä¾›ä¸€ä¸ª**è¯ä¹¦ï¼Œæ‚¨å¯ä»¥å°†æ¥ç”¨æ¥è¯·æ±‚PRTs**ã€‚å› æ­¤ï¼Œä¿æŒæŒä¹…æ€§å¹¶**ç»•è¿‡MFA**ï¼Œå› ä¸ºç”¨äºæ³¨å†Œæ–°è®¾å¤‡çš„åŸå§‹PRTä»¤ç‰Œ**å·²ç»è·å¾—äº†MFAæƒé™**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œè¦æ‰§è¡Œæ­¤æ”»å‡»ï¼Œæ‚¨å°†éœ€è¦æƒé™æ¥**æ³¨å†Œæ–°è®¾å¤‡**ã€‚æ­¤å¤–ï¼Œæ³¨å†Œè®¾å¤‡å¹¶ä¸æ„å‘³ç€è¯¥è®¾å¤‡å°†è¢«**å…è®¸åŠ å…¥åˆ°Intune**ä¸­ã€‚
{% endhint %}

{% hint style="danger" %}
æ­¤æ”»å‡»å·²åœ¨2021å¹´9æœˆä¿®å¤ï¼Œå› ä¸ºæ‚¨ä¸å†å¯ä»¥ä½¿ç”¨SSOä»¤ç‰Œæ³¨å†Œæ–°è®¾å¤‡ã€‚ä½†æ˜¯ï¼Œä»ç„¶å¯ä»¥ä»¥åˆæ³•æ–¹å¼æ³¨å†Œè®¾å¤‡ï¼ˆå¦‚æœéœ€è¦ï¼Œå…·æœ‰ç”¨æˆ·åã€å¯†ç å’ŒMFAï¼‰ã€‚æŸ¥çœ‹ï¼š[**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)ã€‚
{% endhint %}

## è¦†ç›–è®¾å¤‡ç¥¨è¯

å¯ä»¥**è¯·æ±‚è®¾å¤‡ç¥¨è¯**ï¼Œ**è¦†ç›–**è®¾å¤‡çš„å½“å‰ç¥¨è¯ï¼Œå¹¶åœ¨æµç¨‹ä¸­**çªƒå–PRT**ï¼ˆå› æ­¤æ— éœ€ä»TPMä¸­çªƒå–ï¼‰ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[**æ­¤æ¼”è®²**](https://youtu.be/BduCn8cLV1A)ã€‚

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ç„¶è€Œï¼Œè¿™å·²ç»è¢«ä¿®å¤ã€‚
{% endhint %}

## è¦†ç›–WHFBå¯†é’¥

[åœ¨æ­¤å¤„æŸ¥çœ‹åŸå§‹å¹»ç¯ç‰‡](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

æ”»å‡»æ‘˜è¦ï¼š

* å¯ä»¥é€šè¿‡SSO**è¦†ç›–**è®¾å¤‡çš„**æ³¨å†ŒWHFB**å¯†é’¥
* å®ƒ**å‡»è´¥äº†TPMä¿æŠ¤**ï¼Œå› ä¸ºå¯†é’¥åœ¨ç”Ÿæˆæ–°å¯†é’¥çš„è¿‡ç¨‹ä¸­**è¢«å—…æ¢**
* è¿™ä¹Ÿæä¾›äº†**æŒä¹…æ€§**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥é€šè¿‡Azure AD Graphä¿®æ”¹è‡ªå·±çš„searchableDeviceKeyå±æ€§ï¼Œä½†æ˜¯æ”»å‡»è€…éœ€è¦åœ¨ç§Ÿæˆ·ä¸­æ‹¥æœ‰ä¸€ä¸ªè®¾å¤‡ï¼ˆå³æ—¶æ³¨å†Œæˆ–ä»åˆæ³•è®¾å¤‡çªƒå–è¯ä¹¦+å¯†é’¥ï¼‰ä»¥åŠå¯¹AAD Graphçš„æœ‰æ•ˆè®¿é—®ä»¤ç‰Œã€‚

ç„¶åï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°å¯†é’¥ï¼š
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

ç„¶åå¯¹å¯æœç´¢è®¾å¤‡å¯†é’¥çš„ä¿¡æ¯è¿›è¡ŒPATCHæ“ä½œï¼š

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥é€šè¿‡**è®¾å¤‡ä»£ç é’“é±¼**ä»ç”¨æˆ·é‚£é‡Œè·å–è®¿é—®ä»¤ç‰Œï¼Œå¹¶æ»¥ç”¨ä¹‹å‰çš„æ­¥éª¤æ¥**çªƒå–ä»–çš„è®¿é—®æƒé™**ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## å‚è€ƒèµ„æ–™

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
