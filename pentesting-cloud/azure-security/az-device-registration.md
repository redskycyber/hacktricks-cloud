# Az - Registro de Dispositivos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

Cuando un dispositivo se une a AzureAD, se crea un nuevo objeto en AzureAD.

Al registrar un dispositivo, se **pide al usuario que inicie sesi√≥n con su cuenta** (solicitando MFA si es necesario), luego solicita tokens para el servicio de registro de dispositivos y despu√©s pide una confirmaci√≥n final.

Luego, se generan dos pares de claves RSA en el dispositivo: La **clave del dispositivo** (**clave p√∫blica**) que se env√≠a a **AzureAD** y la **clave de transporte** (**clave privada**) que se almacena en TPM si es posible.

Despu√©s, el **objeto** se genera en **AzureAD** (no en Intune) y AzureAD devuelve al dispositivo un **certificado** firmado por √©l. Puedes verificar que el **dispositivo est√° unido a AzureAD** e informaci√≥n sobre el **certificado** (como si est√° protegido por TPM).
```bash
dsregcmd /status
```
Despu√©s del registro del dispositivo, se solicita un **Primary Refresh Token** por el m√≥dulo CloudAP de LSASS y se entrega al dispositivo. Con el PRT tambi√©n se entrega la **clave de sesi√≥n cifrada para que solo el dispositivo pueda descifrarla** (usando la clave p√∫blica de la clave de transporte) y es **necesaria para usar el PRT.**

Para m√°s informaci√≥n sobre qu√© es un PRT, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

El **TPM** **protege** contra la **extracci√≥n** de claves de un dispositivo apagado (si est√° protegido por PIN) y de extraer el material privado desde la capa del SO.\
Pero **no protege** contra el **interceptado** de la conexi√≥n f√≠sica entre el TPM y la CPU o **usar el material criptogr√°fico** en el TPM mientras el sistema est√° en funcionamiento desde un proceso con derechos de **SYSTEM**.

Si revisas la siguiente p√°gina, ver√°s que **robar el PRT** puede ser utilizado para acceder como el **usuario**, lo cual es genial porque el **PRT se encuentra en dispositivos**, por lo que puede ser robado de ellos (o si no es robado, abusado para generar nuevas claves de firma):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrando un dispositivo con tokens SSO

Ser√≠a posible para un atacante solicitar un token para el servicio de registro de dispositivos de Microsoft desde el dispositivo comprometido:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
Y luego puedes registrar el dispositivo:

<figure><img src="../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

Lo que te dar√° un **certificado que puedes usar para solicitar PRTs en el futuro**. Por lo tanto, manteniendo la persistencia y **evitando MFA** porque el token PRT original utilizado para registrar el nuevo dispositivo **ya ten√≠a permisos MFA concedidos**.

{% hint style="success" %}
Ten en cuenta que para realizar este ataque necesitar√°s permisos para **registrar nuevos dispositivos**. Adem√°s, registrar un dispositivo no significa que el dispositivo estar√° **autorizado para inscribirse en Intune**.
{% endhint %}

{% hint style="danger" %}
Este ataque se corrigi√≥ en septiembre de 2021 ya que ya no puedes registrar nuevos dispositivos utilizando tokens SSO. Sin embargo, todav√≠a es posible registrar dispositivos de manera leg√≠tima (teniendo nombre de usuario, contrase√±a y MFA si es necesario). Consulta: [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Sobrescribir un ticket de dispositivo

Era posible **solicitar un ticket de dispositivo**, **sobrescribir** el actual del dispositivo y durante el flujo **robar el PRT** (as√≠ que no es necesario robarlo del TPM. Para m√°s informaci√≥n consulta esta [**charla**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Sin embargo, esto se corrigi√≥.
{% endhint %}

## Sobrescribir la clave WHFB

Resumen del ataque:

* Es posible **sobrescribir** la clave **WHFB registrada** de un **dispositivo** a trav√©s de SSO
* **Derrota la protecci√≥n TPM** ya que la clave se **intercepta durante la generaci√≥n** de la nueva clave
* Esto tambi√©n proporciona **persistencia**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Los usuarios pueden modificar su propia propiedad searchableDeviceKey a trav√©s de Azure AD Graph, sin embargo, el atacante necesita tener un dispositivo en el inquilino (registrado al momento o teniendo certificado + clave robados de un dispositivo leg√≠timo) y un token de acceso v√°lido para el AAD Graph.

Luego, es posible generar una nueva clave con:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
y luego PATCH la informaci√≥n de searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Es posible obtener un token de acceso de un usuario mediante **phishing de c√≥digo de dispositivo** y abusar de los pasos anteriores para **robar su acceso**. Para m√°s informaci√≥n, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Referencias

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
