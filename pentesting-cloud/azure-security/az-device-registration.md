# Az - è®¾å¤‡æ³¨å†Œ

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

å½“è®¾å¤‡åŠ å…¥AzureADæ—¶ï¼Œä¼šåœ¨AzureADä¸­åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚

æ³¨å†Œè®¾å¤‡æ—¶ï¼Œ**ä¼šè¦æ±‚ç”¨æˆ·ä½¿ç”¨å…¶è´¦æˆ·ç™»å½•**ï¼ˆå¦‚æœéœ€è¦ï¼Œè¯·æ±‚MFAï¼‰ï¼Œç„¶åå®ƒè¯·æ±‚è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼Œç„¶åè¦æ±‚æœ€ç»ˆç¡®è®¤æç¤ºã€‚

ç„¶åï¼Œåœ¨è®¾å¤‡ä¸­ç”Ÿæˆä¸¤ä¸ªRSAå¯†é’¥å¯¹ï¼š**è®¾å¤‡å¯†é’¥**ï¼ˆ**å…¬é’¥**ï¼‰ï¼Œå‘é€åˆ°**AzureAD**ï¼›ä»¥åŠ**ä¼ è¾“å¯†é’¥**ï¼ˆ**ç§é’¥**ï¼‰ï¼Œå¦‚æœå¯èƒ½çš„è¯å­˜å‚¨åœ¨TPMä¸­ã€‚

ç„¶åï¼Œåœ¨**AzureAD**ä¸­ï¼ˆä¸åœ¨Intuneä¸­ï¼‰ç”Ÿæˆ**å¯¹è±¡**ï¼ŒAzureADè¿”å›ç»™è®¾å¤‡ä¸€ä¸ªç”±å…¶ç­¾åçš„**è¯ä¹¦**ã€‚æ‚¨å¯ä»¥æ£€æŸ¥**è®¾å¤‡æ˜¯å¦åŠ å…¥äº†AzureAD**ä»¥åŠæœ‰å…³**è¯ä¹¦**çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚å®ƒæ˜¯å¦å—TPMä¿æŠ¤ï¼‰ã€‚ï¼š
```bash
dsregcmd /status
```
è®¾å¤‡æ³¨å†Œåï¼ŒLSASS CloudAP æ¨¡å—ä¼šè¯·æ±‚ä¸€ä¸ª**Primary Refresh Token**ï¼ˆPRTï¼‰ï¼Œå¹¶å°†å…¶æä¾›ç»™è®¾å¤‡ã€‚PRT ä¹Ÿä¼šäº¤ä»˜ä¸€ä¸ª**ä¼šè¯å¯†é’¥åŠ å¯†ï¼Œå› æ­¤åªæœ‰è®¾å¤‡èƒ½å¤Ÿè§£å¯†å®ƒ**ï¼ˆä½¿ç”¨ä¼ è¾“å¯†é’¥çš„å…¬é’¥ï¼‰ï¼Œå¹¶ä¸”**ä½¿ç”¨ PRT æ˜¯å¿…éœ€çš„ã€‚**

æœ‰å…³ PRT æ˜¯ä»€ä¹ˆçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - å¯ä¿¡å¹³å°æ¨¡å—

**TPM** **ä¿æŠ¤**è®¾å¤‡åœ¨å…³æœºçŠ¶æ€ä¸‹ï¼ˆå¦‚æœé€šè¿‡ PIN ä¿æŠ¤ï¼‰ä¸è¢«æå–å¯†é’¥ï¼Œä»¥åŠé˜²æ­¢ä»æ“ä½œç³»ç»Ÿå±‚æå–ç§æœ‰ææ–™ã€‚\
ä½†å®ƒ**ä¸ä¿æŠ¤**é˜²æ­¢**å—…æ¢** TPM ä¸ CPU ä¹‹é—´çš„ç‰©ç†è¿æ¥ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œç”±å…·æœ‰**SYSTEM**æƒé™çš„è¿›ç¨‹**ä½¿ç”¨ TPM ä¸­çš„åŠ å¯†ææ–™**ã€‚

å¦‚æœæ‚¨æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œæ‚¨ä¼šçœ‹åˆ°**çªƒå– PRT**å¯ä»¥ç”¨æ¥åƒ**ç”¨æˆ·**ä¸€æ ·è®¿é—®ï¼Œè¿™å¾ˆæ£’ï¼Œå› ä¸º**PRT ä½äºè®¾å¤‡ä¸Š**ï¼Œæ‰€ä»¥å¯ä»¥ä»å®ƒä»¬é‚£é‡Œçªƒå–ï¼ˆæˆ–è€…å¦‚æœæ²¡æœ‰è¢«çªƒå–ï¼Œåˆ™å¯ä»¥æ»¥ç”¨ä»¥ç”Ÿæˆæ–°çš„ç­¾åå¯†é’¥ï¼‰ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ä½¿ç”¨ SSO ä»¤ç‰Œæ³¨å†Œè®¾å¤‡

æ”»å‡»è€…å¯èƒ½ä¼šä»å—æŸè®¾å¤‡è¯·æ±‚ Microsoft è®¾å¤‡æ³¨å†ŒæœåŠ¡çš„ä»¤ç‰Œï¼š
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
ç„¶åä½ å¯ä»¥æ³¨å†Œè®¾å¤‡ï¼š

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

è¿™å°†ç»™ä½ ä¸€ä¸ª**è¯ä¹¦ï¼Œå°†æ¥ä½ å¯ä»¥ç”¨å®ƒæ¥è¯·æ±‚ PRTs**ã€‚å› æ­¤ä¿æŒæŒä¹…æ€§å¹¶**ç»•è¿‡ MFA**ï¼Œå› ä¸ºç”¨æ¥æ³¨å†Œæ–°è®¾å¤‡çš„åŸå§‹ PRT ä»¤ç‰Œ**å·²ç»è¢«æˆäºˆäº† MFA æƒé™**ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œè¦æ‰§è¡Œæ­¤æ”»å‡»ï¼Œä½ éœ€è¦æœ‰**æ³¨å†Œæ–°è®¾å¤‡**çš„æƒé™ã€‚æ­¤å¤–ï¼Œæ³¨å†Œè®¾å¤‡å¹¶ä¸æ„å‘³ç€è¯¥è®¾å¤‡å°†è¢«**å…è®¸åŠ å…¥ Intune**ã€‚
{% endhint %}

{% hint style="danger" %}
è¿™ç§æ”»å‡»åœ¨ 2021 å¹´ 9 æœˆè¢«ä¿®å¤ï¼Œå› ä¸ºä½ ä¸å†èƒ½å¤Ÿä½¿ç”¨ SSO ä»¤ç‰Œæ³¨å†Œæ–°è®¾å¤‡ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥ä»¥åˆæ³•æ–¹å¼æ³¨å†Œè®¾å¤‡ï¼ˆå¦‚æœéœ€è¦ï¼Œæœ‰ç”¨æˆ·åã€å¯†ç å’Œ MFAï¼‰ã€‚æŸ¥çœ‹ï¼š[**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)ã€‚
{% endhint %}

## è¦†ç›–è®¾å¤‡ç¥¨æ®

æ›¾ç»å¯ä»¥**è¯·æ±‚è®¾å¤‡ç¥¨æ®**ï¼Œ**è¦†ç›–**è®¾å¤‡å½“å‰çš„ç¥¨æ®ï¼Œå¹¶åœ¨æµç¨‹ä¸­**çªƒå– PRT**ï¼ˆå› æ­¤æ— éœ€ä» TPM ä¸­çªƒå–ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹è¿™ä¸ª[**è®²åº§**](https://youtu.be/BduCn8cLV1A)ã€‚

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ç„¶è€Œï¼Œè¿™å·²ç»è¢«ä¿®å¤ã€‚
{% endhint %}

## è¦†ç›– WHFB å¯†é’¥

æ”»å‡»æ¦‚è¦ï¼š

* å¯ä»¥é€šè¿‡ SSO **è¦†ç›–**ä»**è®¾å¤‡**æ³¨å†Œçš„ **WHFB** å¯†é’¥
* å®ƒ**å‡»è´¥äº† TPM ä¿æŠ¤**ï¼Œå› ä¸ºå¯†é’¥æ˜¯åœ¨ç”Ÿæˆæ–°å¯†é’¥æ—¶**è¢«å—…æ¢**çš„
* è¿™ä¹Ÿæä¾›äº†**æŒä¹…æ€§**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥é€šè¿‡ Azure AD Graph ä¿®æ”¹ä»–ä»¬è‡ªå·±çš„ searchableDeviceKey å±æ€§ï¼Œç„¶è€Œï¼Œæ”»å‡»è€…éœ€è¦åœ¨ç§Ÿæˆ·ä¸­æœ‰ä¸€ä¸ªè®¾å¤‡ï¼ˆå³æ—¶æ³¨å†Œæˆ–ä»åˆæ³•è®¾å¤‡çªƒå–è¯ä¹¦ + å¯†é’¥ï¼‰å’Œä¸€ä¸ªæœ‰æ•ˆçš„ AAD Graph è®¿é—®ä»¤ç‰Œã€‚

ç„¶åï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°å¯†é’¥ï¼š
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
```markdown
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

ç„¶å PATCH å¯æœç´¢è®¾å¤‡å¯†é’¥çš„ä¿¡æ¯ï¼š

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥é€šè¿‡ **è®¾å¤‡ä»£ç é’“é±¼** ä»ç”¨æˆ·é‚£é‡Œè·å–è®¿é—®ä»¤ç‰Œï¼Œå¹¶æ»¥ç”¨å‰é¢çš„æ­¥éª¤æ¥ **çªƒå–ä»–çš„è®¿é—®æƒé™**ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## å‚è€ƒèµ„æ–™

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥ **åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
```
