# Az - Registro de Dispositivos

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Cuando un dispositivo se une a AzureAD se crea un nuevo objeto en AzureAD.

Al registrar un dispositivo, se **solicita al usuario que inicie sesi贸n con su cuenta** (solicitando MFA si es necesario), luego solicita tokens para el servicio de registro de dispositivos y luego solicita una confirmaci贸n final.

Luego, se generan dos pares de claves RSA en el dispositivo: La **clave del dispositivo** (clave **p煤blica**) que se env铆a a **AzureAD** y la **clave de transporte** (clave **privada**) que se almacena en TPM si es posible.

Luego, se genera el **objeto** en **AzureAD** (no en Intune) y AzureAD devuelve al dispositivo un **certificado** firmado por 茅l. Puedes verificar que el **dispositivo se ha unido a AzureAD** e informaci贸n sobre el **certificado** (como si est谩 protegido por TPM).
```bash
dsregcmd /status
```
Despu茅s del registro del dispositivo se solicita un **Token de Actualizaci贸n Principal** por el m贸dulo LSASS CloudAP y se entrega al dispositivo. Con el PRT tambi茅n se entrega la **clave de sesi贸n encriptada para que solo el dispositivo pueda descifrarla** (usando la clave p煤blica de la clave de transporte) y es **necesaria para usar el PRT**.

Para obtener m谩s informaci贸n sobre qu茅 es un PRT, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - M贸dulo de Plataforma Confiable

El **TPM** **protege** contra la **extracci贸n** de claves de un dispositivo apagado (si est谩 protegido por PIN) y contra la extracci贸n del material privado de la capa del sistema operativo.\
Pero no protege contra **interceptar** la conexi贸n f铆sica entre el TPM y la CPU o **usar el material criptogr谩fico** en el TPM mientras el sistema se est谩 ejecutando desde un proceso con derechos de **SYSTEM**.

Si revisas la siguiente p谩gina, ver谩s que **robar el PRT** se puede utilizar para acceder como un **usuario**, lo cual es genial porque el **PRT se encuentra en los dispositivos**, por lo que se puede robar de ellos (o si no se roba, se puede abusar para generar nuevas claves de firma):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrando un dispositivo con tokens SSO

Ser铆a posible para un atacante solicitar un token para el servicio de registro de dispositivos de Microsoft desde el dispositivo comprometido y registrarlo:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Sobrescribir un ticket de dispositivo

Era posible **solicitar un ticket de dispositivo**, **sobrescribir** el actual del dispositivo, y durante el flujo **robar el PRT** (por lo que no es necesario robarlo del TPM. Para m谩s informaci贸n [**ver esta charla**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Sin embargo, esto fue corregido.
{% endhint %}

## Sobrescribir la clave WHFB

**[Ver las diapositivas originales aqu铆](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

Resumen del ataque:

* Es posible **sobrescribir** la **clave WHFB** registrada desde un **dispositivo** a trav茅s de SSO
* **Derrota la protecci贸n del TPM** ya que la clave es **capturada durante la generaci贸n** de la nueva clave
* Esto tambi茅n proporciona **persistencia**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Los usuarios pueden modificar su propia propiedad searchableDeviceKey a trav茅s del Azure AD Graph, sin embargo, el atacante necesita tener un dispositivo en el inquilino (registrado sobre la marcha o haber robado el certificado + clave de un dispositivo leg铆timo) y un token de acceso v谩lido para el Azure AD Graph.

Luego, es posible generar una nueva clave con:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
y luego **ACTUALIZAR** la informaci贸n del searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Es posible obtener un token de acceso de un usuario a trav茅s de **phishing de c贸digo de dispositivo** y abusar de los pasos anteriores para **robar su acceso**. Para obtener m谩s informaci贸n, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Referencias

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
