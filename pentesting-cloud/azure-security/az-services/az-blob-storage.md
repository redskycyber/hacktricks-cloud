# Az - Blob Storage

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blobå­˜å‚¨æ˜¯å¾®è½¯çš„äº‘å¯¹è±¡**å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ã€‚Blobå­˜å‚¨ç»è¿‡ä¼˜åŒ–ï¼Œç”¨äºå­˜å‚¨å¤§é‡éç»“æ„åŒ–æ•°æ®ã€‚éç»“æ„åŒ–æ•°æ®æ˜¯æŒ‡ä¸ç¬¦åˆç‰¹å®šæ•°æ®æ¨¡å‹æˆ–å®šä¹‰çš„æ•°æ®ï¼Œä¾‹å¦‚æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚

Blobå­˜å‚¨æä¾›ä¸‰ç§èµ„æºï¼š

- **å­˜å‚¨è´¦æˆ·**ï¼ˆå”¯ä¸€åç§°ï¼‰
- å­˜å‚¨è´¦æˆ·ä¸­çš„**å®¹å™¨**ï¼ˆæ–‡ä»¶å¤¹ï¼‰
- å®¹å™¨ä¸­çš„**Blob**

<figure><img src="../../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

### ä¸åŒç±»å‹çš„å­˜å‚¨

| **Blobå­˜å‚¨**                   | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azureæ•°æ®æ¹–å­˜å‚¨Gen2**        | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azureæ–‡ä»¶**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **é˜Ÿåˆ—å­˜å‚¨**                   | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **è¡¨å­˜å‚¨**                     | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### å­˜å‚¨è®¿é—® <a href="#about-blob-storage" id="about-blob-storage"></a>

- é€šè¿‡æ”¯æŒçš„**RBACè§’è‰²**ä½¿ç”¨Azure ADä¸»ä½“ã€‚
- **è®¿é—®å¯†é’¥**ï¼šä½¿ç”¨å­˜å‚¨è´¦æˆ·çš„è®¿é—®å¯†é’¥ã€‚è¿™æä¾›å¯¹å­˜å‚¨è´¦æˆ·çš„**å®Œå…¨è®¿é—®æƒé™**ã€‚
- **å…±äº«è®¿é—®ç­¾å**ï¼ˆSASï¼‰ï¼š**æœ‰æ—¶é—´é™åˆ¶**å’Œç‰¹å®šæƒé™ã€‚
- æ‚¨å¯ä»¥ä½¿ç”¨**è®¿é—®å¯†é’¥**ç”ŸæˆSAS URLï¼ˆæ›´éš¾æ£€æµ‹ï¼‰ã€‚
- ç”±äºSASæ˜¯ä»è®¿é—®å¯†é’¥ç”Ÿæˆçš„ï¼Œå¦‚æœå¯†é’¥è¢«æ›´æ–°ï¼ŒSASå°†åœæ­¢å·¥ä½œã€‚

### å…¬å¼€æš´éœ²

å¦‚æœâ€œå…è®¸Blobå…¬å…±è®¿é—®â€å·²**å¯ç”¨**ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºç¦ç”¨ï¼‰ï¼Œåˆ™å¯èƒ½ï¼š

- å…è®¸**å…¬å¼€è®¿é—®ä»¥è¯»å–Blob**ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç§°ï¼‰ã€‚
- **åˆ—å‡ºå®¹å™¨Blob**å¹¶**è¯»å–**å®ƒä»¬ã€‚

### è¿æ¥åˆ°å­˜å‚¨

å¦‚æœæ‰¾åˆ°ä»»ä½•**å­˜å‚¨**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·[**Microsoft Azureå­˜å‚¨èµ„æºç®¡ç†å™¨**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/)æ¥è¿æ¥ã€‚

## SAS URL

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) å…±äº«è®¿é—®ç­¾åï¼ˆSASï¼‰ä¸ºæ‚¨çš„å­˜å‚¨è´¦æˆ·ä¸­çš„èµ„æºæä¾›å®‰å…¨å§”æ‰˜è®¿é—®ã€‚ä½¿ç”¨SASï¼Œæ‚¨å¯ä»¥ç²¾ç»†æ§åˆ¶å®¢æˆ·ç«¯å¦‚ä½•è®¿é—®æ‚¨çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼š

- å®¢æˆ·ç«¯å¯ä»¥è®¿é—®å“ªäº›èµ„æºã€‚
- ä»–ä»¬å¯¹è¿™äº›èµ„æºæœ‰ä»€ä¹ˆæƒé™ã€‚
- SASçš„æœ‰æ•ˆæœŸæ˜¯å¤šä¹…ã€‚

SAS URLçœ‹èµ·æ¥åƒè¿™æ ·ï¼š**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

ä½¿ç”¨[**å­˜å‚¨èµ„æºç®¡ç†å™¨**](https://azure.microsoft.com/en-us/features/storage-explorer/)è®¿é—®æ•°æ®æˆ–ä½¿ç”¨Pythonï¼š

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
### ç”¨æˆ·å§”æ‰˜ SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

æ‚¨å¯ä»¥ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­æ®æˆ–å¸æˆ·å¯†é’¥æ¥ä¸ºè®¿é—®å®¹å™¨ã€ç›®å½•æˆ– Blob **å®‰å…¨åœ°è·å–å…±äº«è®¿é—®ç­¾å (SAS)** ä»¤ç‰Œã€‚è¦åˆ›å»ºç”¨æˆ·å§”æ‰˜ SASï¼Œæ‚¨å¿…é¡»é¦–å…ˆè¯·æ±‚ä¸€ä¸ª **ç”¨æˆ·å§”æ‰˜å¯†é’¥**ï¼Œç„¶åä½¿ç”¨è¯¥å¯†é’¥å¯¹ SAS è¿›è¡Œç­¾åã€‚

**Azure Blob å­˜å‚¨** å’Œ **Azure Data Lake å­˜å‚¨ Gen2** éƒ½æ”¯æŒ **ç”¨æˆ·å§”æ‰˜å…±äº«è®¿é—®ç­¾å (SAS)**ã€‚ä½†æ˜¯ï¼Œè¯·æ³¨æ„ **å­˜å‚¨è®¿é—®ç­–ç•¥** ä¸ç”¨æˆ·å§”æ‰˜ SAS ä¸å…¼å®¹ã€‚

è¯·æ³¨æ„ï¼Œç”¨æˆ·å§”æ‰˜ SAS æ˜¯ä½¿ç”¨ Azure AD å‡­æ®è€Œä¸æ˜¯å­˜å‚¨å¸æˆ·å¯†é’¥æ¥ä¿æŠ¤çš„ã€‚è¿™å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯/åº”ç”¨ç¨‹åºå­˜å‚¨/æ£€ç´¢å­˜å‚¨å¯†é’¥ä»¥åˆ›å»º SASã€‚

### æœåŠ¡ SAS

æœåŠ¡ SAS ä½¿ç”¨ **å­˜å‚¨å¸æˆ·å¯†é’¥** è¿›è¡Œä¿æŠ¤ã€‚æœåŠ¡ SAS **ä»…å§”æ‰˜å¯¹ Azure å­˜å‚¨æœåŠ¡ä¸­çš„ä¸€ä¸ªèµ„æº** çš„è®¿é—®æƒé™ï¼šBlob å­˜å‚¨ã€é˜Ÿåˆ—å­˜å‚¨ã€è¡¨å­˜å‚¨æˆ– Azure æ–‡ä»¶ã€‚æœåŠ¡çº§ SAS çš„ URI ç”±å°†å§”æ‰˜è®¿é—®æƒé™çš„èµ„æºçš„ URIï¼Œåè·Ÿ SAS ä»¤ç‰Œç»„æˆã€‚

è¦ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­æ®ä¸º **å®¹å™¨** æˆ– **Blob** å®‰å…¨åœ°è·å– SASï¼Œè¯·ä½¿ç”¨ **ç”¨æˆ·å§”æ‰˜ SAS**ã€‚

### å¸æˆ· SAS

å¸æˆ· SAS ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª **å­˜å‚¨å¸æˆ·å¯†é’¥** (å…±æœ‰ 2 ä¸ª) è¿›è¡Œä¿æŠ¤ã€‚å¸æˆ· SAS å§”æ‰˜å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨æœåŠ¡ä¸­çš„èµ„æºçš„è®¿é—®æƒé™ã€‚é€šè¿‡æœåŠ¡æˆ–ç”¨æˆ·å§”æ‰˜ SAS å¯ç”¨çš„æ‰€æœ‰æ“ä½œä¹Ÿå¯é€šè¿‡å¸æˆ· SAS è¿›è¡Œã€‚

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) é€šè¿‡åˆ›å»ºå¸æˆ· SASï¼Œæ‚¨å¯ä»¥ï¼š

* å§”æ‰˜æ‰§è¡Œç›®å‰ä½¿ç”¨ç‰¹å®šæœåŠ¡ SAS ä¸å¯ç”¨çš„æœåŠ¡çº§æ“ä½œï¼Œä¾‹å¦‚ `Get/Set Service Properties` å’Œ `Get Service Stats` æ“ä½œã€‚
* ä¸€æ¬¡å§”æ‰˜å¯¹å­˜å‚¨å¸æˆ·ä¸­å¤šä¸ªæœåŠ¡çš„èµ„æºçš„è®¿é—®æƒé™ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å¸æˆ· SAS å§”æ‰˜å¯¹ Azure Blob å­˜å‚¨å’Œ Azure æ–‡ä»¶ä¸­çš„èµ„æºçš„è®¿é—®æƒé™ã€‚
* å§”æ‰˜å¯¹å®¹å™¨ã€é˜Ÿåˆ—ã€è¡¨å’Œæ–‡ä»¶å…±äº«çš„å†™å…¥å’Œåˆ é™¤æ“ä½œçš„è®¿é—®æƒé™ï¼Œè¿™äº›æ“ä½œåœ¨å¯¹è±¡ç‰¹å®š SAS ä¸­ä¸å¯ç”¨ã€‚
* æŒ‡å®šè¦æ¥å—è¯·æ±‚çš„ IP åœ°å€æˆ– IP åœ°å€èŒƒå›´ã€‚
* æŒ‡å®šè¦æ¥å—è¯·æ±‚çš„ HTTP åè®®ï¼ˆHTTPS æˆ– HTTP/HTTPSï¼‰ã€‚

## æšä¸¾

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
