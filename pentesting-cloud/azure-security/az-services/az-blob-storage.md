# Az - Armazenamento de Blob

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Obtenha [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

[Da documenta√ß√£o:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) O armazenamento de Blob do Azure √© a solu√ß√£o de **armazenamento de objetos da Microsoft para a nuvem**. O armazenamento de Blob √© otimizado para armazenar grandes quantidades de dados n√£o estruturados. Dados n√£o estruturados s√£o dados que n√£o seguem um modelo ou defini√ß√£o espec√≠ficos, como dados de texto ou bin√°rios.

O armazenamento de Blob oferece tr√™s tipos de recursos:

- A **conta de armazenamento** (nome exclusivo)
- Um **cont√™iner** na conta de armazenamento (pasta)
- Um **blob** em um cont√™iner

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de armazenamento

| **Armazenamento de Blob**        | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Armazenamento de Dados do Azure Lake Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Arquivos do Azure**            | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Armazenamento de Fila**        | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Armazenamento de Tabela**      | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acesso ao Armazenamento <a href="#about-blob-storage" id="about-blob-storage"></a>

- Use princ√≠pios do Azure AD via fun√ß√µes de **RBAC** suportadas.
- **Chaves de Acesso**: Use chaves de acesso da conta de armazenamento. Isso fornece **acesso total √† conta de armazenamento**.
- **Assinatura de Acesso Compartilhado** (SAS): **Limitada no tempo** e permiss√µes espec√≠ficas.
- Voc√™ pode gerar uma URL SAS com uma **chave de acesso** (mais complicado de detectar).
- Como o SAS √© gerado a partir da chave de acesso, se ela for renovada, o SAS para de funcionar.

### Exposi√ß√£o P√∫blica

Se "Permitir acesso p√∫blico ao Blob" estiver **habilitado** (desabilitado por padr√£o), √© poss√≠vel:

- Dar **acesso p√∫blico para ler blobs** (voc√™ precisa saber o nome).
- **Listar blobs do cont√™iner** e **l√™-los**.

### Conectar ao Armazenamento

Se voc√™ encontrar algum **armazenamento** ao qual pode se conectar, poder√° usar a ferramenta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para fazer isso.

## URLs SAS

[Da documenta√ß√£o:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Uma assinatura de acesso compartilhado (SAS) fornece acesso delegado seguro a recursos em sua conta de armazenamento. Com um SAS, voc√™ tem controle granular sobre como um cliente pode acessar seus dados. Por exemplo:

- Quais recursos o cliente pode acessar.
- Quais permiss√µes eles t√™m para esses recursos.
- Por quanto tempo o SAS √© v√°lido.

Uma URL SAS se parece com isso: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acessar os dados ou python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
### SAS de delega√ß√£o de usu√°rio <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Voc√™ pode **proteger um token de assinatura de acesso compartilhado (SAS)** para acessar um cont√™iner, diret√≥rio ou blob usando as **credenciais do Azure Active Directory (Azure AD) ou uma chave de conta**. Para criar uma SAS de delega√ß√£o de usu√°rio, voc√™ deve primeiro solicitar uma **chave de delega√ß√£o de usu√°rio**, que voc√™ usar√° para assinar a SAS.

O suporte √© fornecido para uma **Assinatura de Acesso Compartilhado (SAS) de Delega√ß√£o de Usu√°rio** tanto no **Armazenamento de Blobs do Azure** quanto no **Armazenamento de Dados do Azure Gen2**. No entanto, √© importante observar que as **Pol√≠ticas de Acesso Armazenado** n√£o s√£o compat√≠veis com uma SAS de Delega√ß√£o de Usu√°rio.

Observe que a SAS de delega√ß√£o de usu√°rio √© **protegida com credenciais do Azure AD em vez de chaves de conta de armazenamento**. Isso impede que clientes/aplicativos armazenem/recuperem chaves de armazenamento para criar SAS.

### SAS de Servi√ßo

Uma SAS de servi√ßo √© protegida com a **chave da conta de armazenamento**. Uma SAS de servi√ßo **delega acesso a um recurso em apenas um** dos servi√ßos de Armazenamento do Azure: Armazenamento de Blobs, Armazenamento de Filas, Armazenamento de Tabelas ou Arquivos do Azure. O URI para uma SAS de n√≠vel de servi√ßo consiste no URI para o recurso para o qual a SAS delegar√° acesso, seguido pelo token SAS.

Para usar as credenciais do Azure Active Directory (Azure AD) para proteger uma SAS para um **cont√™iner** ou **blob**, use uma **SAS de delega√ß√£o de usu√°rio**.

### SAS de Conta

Uma SAS de conta √© protegida com uma das **chaves da conta de armazenamento** (existem 2). Uma SAS de conta delega acesso a recursos em um ou mais dos servi√ßos de armazenamento. Todas as opera√ß√µes dispon√≠veis por meio de uma SAS de servi√ßo ou de delega√ß√£o de usu√°rio tamb√©m est√£o dispon√≠veis por meio de uma SAS de conta.

[da documenta√ß√£o:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Ao criar uma SAS de conta, voc√™ pode:

* Delegar acesso a opera√ß√µes de n√≠vel de servi√ßo que atualmente n√£o est√£o dispon√≠veis com uma SAS espec√≠fica de servi√ßo, como as opera√ß√µes `Get/Set Service Properties` e `Get Service Stats`.
* Delegar acesso a mais de um servi√ßo em uma conta de armazenamento ao mesmo tempo. Por exemplo, voc√™ pode delegar acesso a recursos tanto no Armazenamento de Blobs do Azure quanto nos Arquivos do Azure usando uma SAS de conta.
* Delegar acesso a opera√ß√µes de grava√ß√£o e exclus√£o para cont√™ineres, filas, tabelas e compartilhamentos de arquivos, que n√£o est√£o dispon√≠veis com uma SAS espec√≠fica de objeto.
* Especificar um endere√ßo IP ou um intervalo de endere√ßos IP dos quais aceitar solicita√ß√µes.
* Especificar o protocolo HTTP do qual aceitar solicita√ß√µes (HTTPS ou HTTP/HTTPS).

## Enumera√ß√£o

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
