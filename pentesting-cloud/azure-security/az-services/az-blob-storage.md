# Az - Blob å­˜å‚¨

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ç›´è‡³æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Blob å­˜å‚¨æ˜¯ Microsoft ä¸ºäº‘æä¾›çš„å¯¹è±¡**å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ã€‚Blob å­˜å‚¨ä¸“ä¸ºå­˜å‚¨å¤§é‡éç»“æ„åŒ–æ•°æ®è€Œä¼˜åŒ–ã€‚éç»“æ„åŒ–æ•°æ®æ˜¯ä¸éµå¾ªç‰¹å®šæ•°æ®æ¨¡å‹æˆ–å®šä¹‰çš„æ•°æ®ï¼Œä¾‹å¦‚æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚

Blob å­˜å‚¨æä¾›ä¸‰ç§ç±»å‹çš„èµ„æºï¼š

* **å­˜å‚¨è´¦æˆ·**ï¼ˆå”¯ä¸€åç§°ï¼‰
* å­˜å‚¨è´¦æˆ·ä¸­çš„**å®¹å™¨**ï¼ˆæ–‡ä»¶å¤¹ï¼‰
* å®¹å™¨ä¸­çš„**blob**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### ä¸åŒç±»å‹çš„å­˜å‚¨

| **Blob å­˜å‚¨**                     | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue å­˜å‚¨**                   | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table å­˜å‚¨**                   | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### è®¿é—®å­˜å‚¨ <a href="#about-blob-storage" id="about-blob-storage"></a>

* é€šè¿‡æ”¯æŒçš„ **RBAC è§’è‰²** ä½¿ç”¨ Azure AD ä¸»ä½“ã€‚
* **è®¿é—®å¯†é’¥**ï¼šä½¿ç”¨å­˜å‚¨è´¦æˆ·çš„è®¿é—®å¯†é’¥ã€‚è¿™æä¾›äº†å¯¹å­˜å‚¨è´¦æˆ·çš„**å®Œå…¨è®¿é—®æƒé™**ã€‚
* **å…±äº«è®¿é—®ç­¾å**ï¼ˆSASï¼‰ï¼šæ—¶é—´**æœ‰é™**ä¸”å…·æœ‰ç‰¹å®šæƒé™ã€‚
* æ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®å¯†é’¥ç”Ÿæˆ SAS urlï¼ˆæ›´éš¾ä»¥æ£€æµ‹ï¼‰ã€‚

### å…¬å…±æš´éœ²

å¦‚æœå¯ç”¨äº†â€œå…è®¸ Blob å…¬å…±è®¿é—®â€ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ï¼Œåˆ™å¯ä»¥ï¼š

* æä¾›**å…¬å…±è®¿é—®ä»¥è¯»å– blobs**ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç§°ï¼‰ã€‚
* **åˆ—å‡ºå®¹å™¨ blobs** å¹¶**è¯»å–**å®ƒä»¬ã€‚

### è¿æ¥åˆ°å­˜å‚¨

å¦‚æœæ‚¨å‘ç°ä»»ä½•**å­˜å‚¨**å¯ä»¥è¿æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚

## SAS URLs

å…±äº«è®¿é—®ç­¾åï¼ˆSASï¼‰ä¸ºæ‚¨çš„å­˜å‚¨è´¦æˆ·ä¸­çš„èµ„æºæä¾›å®‰å…¨çš„å§”æ‰˜è®¿é—®ã€‚ä½¿ç”¨ SASï¼Œæ‚¨å¯ä»¥ç²¾ç»†æ§åˆ¶å®¢æˆ·ç«¯å¦‚ä½•è®¿é—®æ‚¨çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼š

* å®¢æˆ·ç«¯å¯ä»¥è®¿é—®å“ªäº›èµ„æºã€‚
* ä»–ä»¬å¯¹è¿™äº›èµ„æºæœ‰ä»€ä¹ˆæƒé™ã€‚
* SAS æœ‰æ•ˆçš„æ—¶é—´é•¿çŸ­ã€‚

SAS URL å¦‚ä¸‹æ‰€ç¤ºï¼š**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

ä½¿ç”¨ [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) è®¿é—®æ•°æ®æˆ– pythonï¼š

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ç”¨æˆ·å§”æ´¾ SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

æ‚¨å¯ä»¥ä½¿ç”¨ Azure Active Directory (Azure AD) **å‡­æ®æˆ–è´¦æˆ·å¯†é’¥**æ¥**ä¿æŠ¤å…±äº«è®¿é—®ç­¾å (SAS)** ä»¤ç‰Œï¼Œä»¥è®¿é—®å®¹å™¨ã€ç›®å½•æˆ– blobã€‚è¦åˆ›å»ºç”¨æˆ·å§”æ´¾ SASï¼Œæ‚¨å¿…é¡»é¦–å…ˆè¯·æ±‚ä¸€ä¸ª**ç”¨æˆ·å§”æ´¾å¯†é’¥**ï¼Œç„¶åä½¿ç”¨å®ƒæ¥ç­¾ç½² SASã€‚

ç”¨æˆ·å§”æ´¾ SAS æ”¯æŒ **Azure Blob å­˜å‚¨** å’Œ **Azure Data Lake å­˜å‚¨ Gen2**ã€‚**ä¸æ”¯æŒå­˜å‚¨è®¿é—®ç­–ç•¥**ç”¨äºç”¨æˆ·å§”æ´¾ SASã€‚

è¯·æ³¨æ„ï¼Œç”¨æˆ·å§”æ´¾ SAS æ˜¯ç”¨ Azure AD å‡­æ®è€Œä¸æ˜¯å­˜å‚¨è´¦æˆ·å¯†é’¥æ¥ä¿æŠ¤çš„ã€‚è¿™é˜²æ­¢äº†å®¢æˆ·ç«¯/åº”ç”¨ç¨‹åºå­˜å‚¨/æ£€ç´¢å­˜å‚¨å¯†é’¥æ¥åˆ›å»º SASã€‚

### æœåŠ¡ SAS

æœåŠ¡ SAS æ˜¯ç”¨**å­˜å‚¨è´¦æˆ·å¯†é’¥**ä¿æŠ¤çš„ã€‚æœåŠ¡ SAS **ä»…å§”æ´¾å¯¹ Azure å­˜å‚¨æœåŠ¡ä¸­çš„ä¸€ä¸ªèµ„æºçš„è®¿é—®æƒé™**ï¼šBlob å­˜å‚¨ã€é˜Ÿåˆ—å­˜å‚¨ã€è¡¨å­˜å‚¨æˆ– Azure æ–‡ä»¶ã€‚æœåŠ¡çº§åˆ« SAS çš„ URI åŒ…æ‹¬ SAS å°†å§”æ´¾è®¿é—®æƒé™çš„èµ„æºçš„ URIï¼Œåè·Ÿ SAS ä»¤ç‰Œã€‚

è¦ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­æ®ä¿æŠ¤**å®¹å™¨**æˆ–**blob**çš„ SASï¼Œè¯·ä½¿ç”¨**ç”¨æˆ·å§”æ´¾ SAS**ã€‚

### è´¦æˆ· SAS

è´¦æˆ· SAS æ˜¯ç”¨**å­˜å‚¨è´¦æˆ·å¯†é’¥**ä¹‹ä¸€ï¼ˆå…±æœ‰ 2 ä¸ªï¼‰ä¿æŠ¤çš„ã€‚è´¦æˆ· SAS å§”æ´¾å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨æœåŠ¡ä¸­çš„èµ„æºçš„è®¿é—®æƒé™ã€‚é€šè¿‡æœåŠ¡æˆ–ç”¨æˆ·å§”æ´¾ SAS å¯ç”¨çš„æ‰€æœ‰æ“ä½œä¹Ÿå¯é€šè¿‡è´¦æˆ· SAS ä½¿ç”¨ã€‚

é€šè¿‡åˆ›å»ºè´¦æˆ· SASï¼Œæ‚¨å¯ä»¥ï¼š

* å§”æ´¾å¯¹å½“å‰ä¸å¯ç”¨äºç‰¹å®šæœåŠ¡ SAS çš„æœåŠ¡çº§æ“ä½œçš„è®¿é—®æƒé™ï¼Œä¾‹å¦‚ `Get/Set Service Properties` å’Œ `Get Service Stats` æ“ä½œã€‚
* åŒæ—¶å§”æ´¾å¯¹å­˜å‚¨è´¦æˆ·ä¸­å¤šä¸ªæœåŠ¡çš„è®¿é—®æƒé™ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è´¦æˆ· SAS å§”æ´¾å¯¹ Azure Blob å­˜å‚¨å’Œ Azure æ–‡ä»¶çš„èµ„æºçš„è®¿é—®æƒé™ã€‚
* å§”æ´¾å¯¹å®¹å™¨ã€é˜Ÿåˆ—ã€è¡¨å’Œæ–‡ä»¶å…±äº«çš„å†™å…¥å’Œåˆ é™¤æ“ä½œçš„è®¿é—®æƒé™ï¼Œè¿™äº›åœ¨ç‰¹å®šå¯¹è±¡ SAS ä¸­ä¸å¯ç”¨ã€‚
* æŒ‡å®šæ¥å—è¯·æ±‚çš„ IP åœ°å€æˆ– IP åœ°å€èŒƒå›´ã€‚
* æŒ‡å®šæ¥å—è¯·æ±‚çš„ HTTP åè®®ï¼ˆHTTPS æˆ– HTTP/HTTPSï¼‰ã€‚

## æšä¸¾

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
