# Az - Blob Storage

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Blob å­˜å‚¨æ˜¯ Microsoft çš„äº‘ç«¯å¯¹è±¡**å­˜å‚¨è§£å†³æ–¹æ¡ˆ**ã€‚Blob å­˜å‚¨ä¸“ä¸ºå­˜å‚¨å¤§é‡éç»“æ„åŒ–æ•°æ®è¿›è¡Œäº†ä¼˜åŒ–ã€‚éç»“æ„åŒ–æ•°æ®æ˜¯æŒ‡ä¸ç¬¦åˆç‰¹å®šæ•°æ®æ¨¡å‹æˆ–å®šä¹‰çš„æ•°æ®ï¼Œä¾‹å¦‚æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚

Blob å­˜å‚¨æä¾›ä¸‰ç§ç±»å‹çš„èµ„æºï¼š

* **å­˜å‚¨å¸æˆ·**ï¼ˆå”¯ä¸€åç§°ï¼‰
* å­˜å‚¨å¸æˆ·ä¸­çš„**å®¹å™¨**ï¼ˆæ–‡ä»¶å¤¹ï¼‰
* å®¹å™¨ä¸­çš„** Blob**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### ä¸åŒç±»å‹çš„å­˜å‚¨

| **Blob å­˜å‚¨**                   | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake å­˜å‚¨ Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **é˜Ÿåˆ—å­˜å‚¨**                   | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **è¡¨å­˜å‚¨**                     | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### è®¿é—®å­˜å‚¨ <a href="#about-blob-storage" id="about-blob-storage"></a>

* ä½¿ç”¨ Azure AD ä¸»ä½“é€šè¿‡æ”¯æŒçš„**RBAC è§’è‰²**ã€‚
* **è®¿é—®å¯†é’¥**ï¼šä½¿ç”¨å­˜å‚¨å¸æˆ·çš„è®¿é—®å¯†é’¥ã€‚è¿™æä¾›å¯¹å­˜å‚¨å¸æˆ·çš„**å®Œå…¨è®¿é—®æƒé™**ã€‚
* **å…±äº«è®¿é—®ç­¾å**ï¼ˆSASï¼‰ï¼šæ—¶é—´**æœ‰é™**ä¸”å…·æœ‰ç‰¹å®šæƒé™ã€‚
* æ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®å¯†é’¥ç”Ÿæˆ SAS URLï¼ˆæ›´éš¾æ£€æµ‹ï¼‰ã€‚

### å…¬å¼€æš´éœ²

å¦‚æœâ€œå…è®¸ Blob å…¬å¼€è®¿é—®â€å·²**å¯ç”¨**ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ï¼Œåˆ™å¯èƒ½ï¼š

* å…¬å¼€è®¿é—®ä»¥è¯»å– Blobï¼ˆéœ€è¦çŸ¥é“åç§°ï¼‰ã€‚
* **åˆ—å‡ºå®¹å™¨ Blob** å¹¶å¯¹å…¶è¿›è¡Œè¯»å–ã€‚

### è¿æ¥åˆ°å­˜å‚¨

å¦‚æœæ‚¨æ‰¾åˆ°ä»»ä½•**å­˜å‚¨**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· [**Microsoft Azure å­˜å‚¨èµ„æºç®¡ç†å™¨**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) è¿›è¡Œè¿æ¥ã€‚

## SAS URL

å…±äº«è®¿é—®ç­¾åï¼ˆSASï¼‰æä¾›å¯¹å­˜å‚¨å¸æˆ·ä¸­èµ„æºçš„å®‰å…¨å§”æ´¾è®¿é—®ã€‚ä½¿ç”¨ SASï¼Œæ‚¨å¯ä»¥å¯¹å®¢æˆ·ç«¯è®¿é—®æ•°æ®çš„æ–¹å¼è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ä¾‹å¦‚ï¼š

* å®¢æˆ·ç«¯å¯ä»¥è®¿é—®å“ªäº›èµ„æºã€‚
* ä»–ä»¬å¯¹è¿™äº›èµ„æºæ‹¥æœ‰ä»€ä¹ˆæƒé™ã€‚
* SAS çš„æœ‰æ•ˆæœŸæ˜¯å¤šé•¿æ—¶é—´ã€‚

SAS URL çš„æ ¼å¼å¦‚ä¸‹ï¼š**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

ä½¿ç”¨ [**å­˜å‚¨èµ„æºç®¡ç†å™¨**](https://azure.microsoft.com/en-us/features/storage-explorer/) è®¿é—®æ•°æ®æˆ–ä½¿ç”¨ Pythonï¼š

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ç”¨æˆ·å§”æ´¾ SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

æ‚¨å¯ä»¥ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­æ®æˆ–å¸æˆ·å¯†é’¥æ¥åˆ›å»ºç”¨æˆ·å§”æ´¾ SASï¼Œä»¥ä¾¿è®¿é—®å®¹å™¨ã€ç›®å½•æˆ– Blobã€‚è¦åˆ›å»ºç”¨æˆ·å§”æ´¾ SASï¼Œæ‚¨å¿…é¡»é¦–å…ˆè¯·æ±‚ä¸€ä¸ªç”¨æˆ·å§”æ´¾å¯†é’¥ï¼Œç„¶åä½¿ç”¨è¯¥å¯†é’¥å¯¹ SAS è¿›è¡Œç­¾åã€‚

ç”¨æˆ·å§”æ´¾ SAS æ”¯æŒ Azure Blob å­˜å‚¨å’Œ Azure Data Lake å­˜å‚¨ Gen2ã€‚ç”¨æˆ·å§”æ´¾ SAS ä¸æ”¯æŒå­˜å‚¨è®¿é—®ç­–ç•¥ã€‚

è¯·æ³¨æ„ï¼Œç”¨æˆ·å§”æ´¾ SAS ä½¿ç”¨ Azure AD å‡­æ®è¿›è¡Œå®‰å…¨ä¿æŠ¤ï¼Œè€Œä¸æ˜¯å­˜å‚¨å¸æˆ·å¯†é’¥ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯/åº”ç”¨ç¨‹åºå­˜å‚¨/æ£€ç´¢å­˜å‚¨å¯†é’¥ä»¥åˆ›å»º SASã€‚

### æœåŠ¡ SAS

æœåŠ¡ SAS ä½¿ç”¨å­˜å‚¨å¸æˆ·å¯†é’¥è¿›è¡Œå®‰å…¨ä¿æŠ¤ã€‚æœåŠ¡ SAS ä»…å§”æ´¾å¯¹ Azure å­˜å‚¨æœåŠ¡ä¸­çš„ä¸€ä¸ªèµ„æºçš„è®¿é—®æƒé™ï¼šBlob å­˜å‚¨ã€é˜Ÿåˆ—å­˜å‚¨ã€è¡¨å­˜å‚¨æˆ– Azure æ–‡ä»¶ã€‚æœåŠ¡çº§ SAS çš„ URI ç”±å°†å§”æ´¾è®¿é—®æƒé™çš„ SAS ä»¤ç‰Œä¹‹åçš„èµ„æºçš„ URI ç»„æˆã€‚

è¦ä½¿ç”¨ Azure Active Directory (Azure AD) å‡­æ®ä¸ºå®¹å™¨æˆ– Blob å®‰å…¨åœ°åˆ›å»º SASï¼Œè¯·ä½¿ç”¨ç”¨æˆ·å§”æ´¾ SASã€‚

### å¸æˆ· SAS

å¸æˆ· SAS ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå­˜å‚¨å¸æˆ·å¯†é’¥ï¼ˆå…±æœ‰ 2 ä¸ªï¼‰è¿›è¡Œå®‰å…¨ä¿æŠ¤ã€‚å¸æˆ· SAS å§”æ´¾å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨æœåŠ¡ä¸­çš„èµ„æºçš„è®¿é—®æƒé™ã€‚é€šè¿‡æœåŠ¡æˆ–ç”¨æˆ·å§”æ´¾ SAS å¯ç”¨çš„æ‰€æœ‰æ“ä½œä¹Ÿå¯é€šè¿‡å¸æˆ· SAS è¿›è¡Œã€‚

é€šè¿‡åˆ›å»ºå¸æˆ· SASï¼Œæ‚¨å¯ä»¥ï¼š

* å§”æ´¾å¯¹ç›®å‰æ— æ³•ä½¿ç”¨ç‰¹å®šäºæœåŠ¡çš„ SAS è¿›è¡Œçš„æœåŠ¡çº§æ“ä½œçš„è®¿é—®æƒé™ï¼Œä¾‹å¦‚ `Get/Set Service Properties` å’Œ `Get Service Stats` æ“ä½œã€‚
* å§”æ´¾åŒæ—¶è®¿é—®å­˜å‚¨å¸æˆ·ä¸­å¤šä¸ªæœåŠ¡çš„æƒé™ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸æˆ· SAS å§”æ´¾å¯¹ Azure Blob å­˜å‚¨å’Œ Azure æ–‡ä»¶ä¸­çš„èµ„æºè¿›è¡Œè®¿é—®ã€‚
* å§”æ´¾å¯¹å®¹å™¨ã€é˜Ÿåˆ—ã€è¡¨å’Œæ–‡ä»¶å…±äº«çš„å†™å…¥å’Œåˆ é™¤æ“ä½œçš„è®¿é—®æƒé™ï¼Œè¿™æ˜¯å¯¹è±¡ç‰¹å®š SAS ä¸å¯ç”¨çš„ã€‚
* æŒ‡å®šè¦æ¥å—è¯·æ±‚çš„ IP åœ°å€æˆ– IP åœ°å€èŒƒå›´ã€‚
* æŒ‡å®šè¦æ¥å—è¯·æ±‚çš„ HTTP åè®®ï¼ˆHTTPS æˆ– HTTP/HTTPSï¼‰ã€‚

## æšä¸¾

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
