# Az - Blob Storage

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage je Microsoft-ovo objektno **re코enje za skladi코tenje u oblaku**. Blob storage je optimizovan za skladi코tenje ogromnih koli캜ina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji se ne pridr쬬vaju odre캠enog modela ili definicije, kao 코to su tekstualni ili binarni podaci.

Blob storage nudi tri vrste resursa:

* **Storage account** (jedinstveno ime)
* **Container** u storage account-u (folder)
* **Blob** u kontejneru

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Razli캜ite vrste skladi코tenja

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Pristup skladi코tu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD principe putem podr쬬nih **RBAC uloga**.
* **Pristupni klju캜evi**: Koristite pristupne klju캜eve storage account-a. Ovo omogu캖ava **puni pristup storage account-u**.
* **Shared Access Signature** (SAS): **Vremenski ograni캜en** i sa specifi캜nim dozvolama.
* Mo쬰te generisati SAS URL sa **pristupnim klju캜em** (te쬰 otkriti).
* Po코to se SAS generi코e iz pristupnog klju캜a, ako se klju캜 obnovi, SAS prestaje da radi.

### Javno izlaganje

Ako je "Allow Blob public access" **omogu캖eno** (po defaultu onemogu캖eno), mogu캖e je:

* Dati **javni pristup za 캜itanje blob-ova** (morate znati ime).
* **Izlistati blob-ove kontejnera** i **캜itati** ih.

### Povezivanje sa skladi코tem

Ako prona캠ete bilo koje **skladi코te** sa kojim mo쬰te da se pove쬰te, mo쬰te koristiti alatku [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URL-ovi

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) pru쬬 siguran delegirani pristup resursima u va코em storage account-u. Sa SAS-om, imate detaljnu kontrolu nad tim kako klijent mo쬰 pristupiti va코im podacima. Na primer:

* Koje resurse klijent mo쬰 pristupiti.
* Koje dozvole imaju za te resurse.
* Koliko dugo je SAS validan.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo쬰te **za코tititi zajedni캜ki pristupni potpis (SAS)** token za pristup kontejneru, direktorijumu ili blobu koriste캖i Azure Active Directory (Azure AD) **poverenice ili klju캜 naloga**. Da biste kreirali korisni캜ki potpis SAS, prvo morate zatra쬴ti **klju캜 za poverenje korisnika**, koji zatim koristite za potpisivanje SAS.

Podr코ka je obezbe캠ena za **User Delegation Shared Access Signature (SAS)** kako u **Azure Blob Storage** tako i u **Azure Data Lake Storage Gen2**. Me캠utim, va쬹o je napomenuti da **Stored Access Policies** nisu kompatibilne sa User Delegation SAS.

Imajte na umu da je korisni캜ki potpis SAS **za코ti캖en Azure AD poverenicama umesto klju캜evima naloga za skladi코tenje**. Ovo spre캜ava klijente/aplikacije da skladi코te/dobavljaju klju캜eve za skladi코tenje kako bi kreirali SAS.

### Service SAS

Service SAS je za코ti캖en sa **klju캜em naloga za skladi코tenje**. Service SAS **delegira pristup resursu samo jednoj** od Azure Storage usluga: Blob storage, Queue storage, Table storage ili Azure Files. URI za SAS na nivou usluge sastoji se od URI-ja do resursa za koji 캖e SAS delegirati pristup, a zatim slijedi SAS token.

Da biste koristili Azure Active Directory (Azure AD) poverenice za za코titu SAS za **kontejner** ili **blob**, koristite **korisni캜ki potpis SAS**.

### Account SAS

Account SAS je za코ti캖en jednim od **klju캜eva naloga za skladi코tenje** (postoje 2). Account SAS delegira pristup resursima u jednoj ili vi코e usluga skladi코tenja. Sve operacije dostupne putem SAS na nivou usluge ili korisni캜kog potpisa SAS tako캠e su dostupne putem account SAS.

[iz dokumentacije:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem account SAS-a mo쬰te:

* Delegirati pristup operacijama na nivou usluge koje trenutno nisu dostupne sa specifi캜nim SAS-om za uslugu, kao 코to su operacije `Get/Set Service Properties` i `Get Service Stats`.
* Delegirati pristup vi코e od jedne usluge u jednom skladi코nom nalogu. Na primer, mo쬰te delegirati pristup resursima kako u Azure Blob Storage tako i u Azure Files koriste캖i account SAS.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljenje fajlova, koje nisu dostupne sa objektno-specifi캜nim SAS-om.
* Odrediti IP adresu ili opseg IP adresa iz kojih 캖e se prihvatati zahtevi.
* Odrediti HTTP protokol iz kojeg 캖e se prihvatati zahtevi (HTTPS ili HTTP/HTTPS).

## Enumeracija

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
