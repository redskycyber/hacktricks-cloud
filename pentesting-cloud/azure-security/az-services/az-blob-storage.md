# Az - Almacenamiento Blob

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

El almacenamiento Blob de Azure es la **soluci√≥n de almacenamiento de objetos para la nube** de Microsoft. Est√° optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son aquellos que no se adhieren a un modelo o definici√≥n de datos particular, como texto o datos binarios.

El almacenamiento Blob ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre √∫nico)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de almacenamiento

| **Almacenamiento Blob**           | <p><code>https://&#x3C;cuenta-almacenamiento>.blob.core.windows.net</code><br><br><code>https://&#x3C;cuenta-stg>.blob.core.windows.net/&#x3C;nombre-contenedor>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Azure Data Lake Storage Gen2** | `https://<cuenta-almacenamiento>.dfs.core.windows.net`                                                                                                                                               |
| **Azure Files**                  | `https://<cuenta-almacenamiento>.file.core.windows.net`                                                                                                                                              |
| **Almacenamiento en Cola**       | `https://<cuenta-almacenamiento>.queue.core.windows.net`                                                                                                                                             |
| **Almacenamiento de Tablas**     | `https://<cuenta-almacenamiento>.table.core.windows.net`                                                                                                                                             |

### Acceso al Almacenamiento <a href="#about-blob-storage" id="about-blob-storage"></a>

* Utilizar principios de Azure AD a trav√©s de roles **RBAC** soportados.
* **Claves de Acceso**: Utilizar claves de acceso de la cuenta de almacenamiento. Esto proporciona **acceso completo a la cuenta de almacenamiento.**
* **Firma de Acceso Compartido** (SAS): Permisos **limitados en tiempo** y espec√≠ficos.
* Puedes generar una URL SAS con una **clave de acceso** (m√°s complicado de detectar).
* Como la SAS se genera a partir de la clave de acceso, si esta se renueva, la SAS deja de funcionar.

### Exposici√≥n P√∫blica

Si "Permitir acceso p√∫blico a Blob" est√° **habilitado** (deshabilitado por defecto), es posible:

* Dar **acceso p√∫blico para leer blobs** (necesitas conocer el nombre).
* **Listar blobs del contenedor** y **leerlos**.

### Conectar al Almacenamiento

Si encuentras alg√∫n **almacenamiento** al que puedas conectarte, podr√≠as usar la herramienta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para hacerlo.

## URLs SAS

Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a recursos en tu cuenta de almacenamiento. Con una SAS, tienes control granular sobre c√≥mo un cliente puede acceder a tus datos. Por ejemplo:

* A qu√© recursos puede acceder el cliente.
* Qu√© permisos tienen sobre esos recursos.
* Cu√°nto tiempo es v√°lida la SAS.

Una URL SAS se ve as√≠: **`https://<nombre_contenedor>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
### SAS de delegaci√≥n de usuario <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puede **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob utilizando **credenciales de Azure Active Directory (Azure AD) o una clave de cuenta**. Para crear un SAS de delegaci√≥n de usuario, primero debe solicitar una \*\* **\_**clave de delegaci√≥n de usuario\*\*\_, que luego utiliza para firmar el SAS.

Un SAS de delegaci√≥n de usuario es compatible con **Azure Blob Storage** y **Azure Data Lake Storage Gen2**. **Las pol√≠ticas de acceso almacenadas no son compatibles** con un SAS de delegaci√≥n de usuario.

Tenga en cuenta que el SAS de delegaci√≥n de usuario est√° **asegurado con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### SAS de servicio

Un SAS de servicio est√° asegurado con la **clave de cuenta de almacenamiento**. Un SAS de servicio **delega acceso a un recurso en solo uno** de los servicios de Azure Storage: Blob storage, Queue storage, Table storage o Azure Files. El URI para un SAS a nivel de servicio consiste en el URI al recurso para el cual el SAS delegar√° acceso, seguido por el token SAS.

Para usar credenciales de Azure Active Directory (Azure AD) para asegurar un SAS para un **contenedor** o **blob**, use un **SAS de delegaci√≥n de usuario**.

### SAS de cuenta

Un SAS de cuenta est√° asegurado con una de las **claves de cuenta de almacenamiento** (hay 2). Un SAS de cuenta delega acceso a recursos en uno o m√°s de los servicios de almacenamiento. Todas las operaciones disponibles a trav√©s de un SAS de servicio o delegaci√≥n de usuario tambi√©n est√°n disponibles a trav√©s de un SAS de cuenta.

Al crear un SAS de cuenta, puede:

* Delegar acceso a operaciones a nivel de servicio que actualmente no est√°n disponibles con un SAS espec√≠fico de servicio, como las operaciones `Get/Set Service Properties` y `Get Service Stats`.
* Delegar acceso a m√°s de un servicio en una cuenta de almacenamiento al mismo tiempo. Por ejemplo, puede delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files utilizando un SAS de cuenta.
* Delegar acceso a operaciones de escritura y eliminaci√≥n para contenedores, colas, tablas y comparticiones de archivos, que no est√°n disponibles con un SAS espec√≠fico de objeto.
* Especificar una direcci√≥n IP o un rango de direcciones IP desde las cuales aceptar solicitudes.
* Especificar el protocolo HTTP desde el cual aceptar solicitudes (ya sea HTTPS o HTTP/HTTPS).

## Enumeraci√≥n

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
## Referencias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
