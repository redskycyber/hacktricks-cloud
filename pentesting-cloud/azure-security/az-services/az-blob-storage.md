# Az - Blob Storage

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage to rozwizanie **przechowywania obiekt贸w Microsoftu w chmurze**. Blob storage jest zoptymalizowany do przechowywania ogromnych iloci danych niestrukturyzowanych. Dane niestrukturyzowane to dane, kt贸re nie podlegaj okrelonemu modelowi danych ani definicji, takie jak tekst lub dane binarne.

Blob storage oferuje trzy rodzaje zasob贸w:

* **Konto magazynu** (unikalna nazwa)
* **Kontener** w koncie magazynu (folder)
* **Blob** w kontenerze

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### R贸偶ne rodzaje przechowywania

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Dostp do magazynu <a href="#about-blob-storage" id="about-blob-storage"></a>

* U偶yj podmiot贸w Azure AD za pomoc obsugiwanych r贸l **RBAC**.
* **Klucze dostpu**: U偶yj kluczy dostpu do konta magazynu. Zapewnia to **peny dostp do konta magazynu**.
* **Wsp贸lny podpis dostpu** (SAS): **Ograniczony czasowo** i okrelone uprawnienia.
* Mo偶esz wygenerowa adres URL SAS z **kluczem dostpu** (trudniejszy do wykrycia).
* Poniewa偶 SAS jest generowany na podstawie klucza dostpu, jeli zostanie odnowiony, SAS przestaje dziaa.

### Publiczne wystawienie

Jeli opcja "Allow Blob public access" jest **wczona** (domylnie wyczona), istnieje mo偶liwo:

* Udostpniania **publicznego dostpu do odczytu blob贸w** (musisz zna nazw).
* **Wylistowania blob贸w kontenera** i **odczytania** ich.

### Poczenie z magazynem

Jeli znajdziesz jakikolwiek **magazyn**, do kt贸rego mo偶esz si podczy, mo偶esz u偶y narzdzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) do tego celu.

## Adresy URL SAS

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Wsp贸lny podpis dostpu (SAS) zapewnia bezpieczny dostp zdelegowany do zasob贸w w Twoim koncie magazynu. Dziki SAS masz szczeg贸ow kontrol nad tym, jak klient mo偶e uzyska dostp do Twoich danych. Na przykad:

* Do jakich zasob贸w klient mo偶e uzyska dostp.
* Jakie uprawnienia maj do tych zasob贸w.
* Jak dugo wa偶ny jest SAS.

Adres URL SAS wyglda tak: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

U偶yj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) do dostpu do danych lub pythona:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Delegacja u偶ytkownika SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Mo偶esz **zabezpieczy token dostpu do wsp贸dzielonego podpisu dostpu (SAS)** dla kontenera, katalogu lub bloku, u偶ywajc **powiadcze Azure Active Directory (Azure AD) lub klucza konta**. Aby utworzy delegacj u偶ytkownika SAS, musisz najpierw poprosi o **klucz delegacji u偶ytkownika**, kt贸ry nastpnie u偶ywasz do podpisania SAS.

Wsparcie jest udostpniane dla **Delegowanego Wsp贸dzielonego Podpisu Dostpu (SAS)** zar贸wno w **Azure Blob Storage**, jak i w **Azure Data Lake Storage Gen2**. Jednak wa偶ne jest zauwa偶enie, 偶e **Zachowane Polityki Dostpu** nie s kompatybilne z Delegowanym SAS u偶ytkownika.

Nale偶y zauwa偶y, 偶e delegacja u偶ytkownika SAS jest **zabezpieczona za pomoc powiadcze Azure AD, a nie kluczy konta magazynu**. Zapobiega to przechowywaniu/pobieraniu kluczy magazynu przez klient贸w/aplikacje w celu utworzenia SAS.

### SAS usugi

SAS usugi jest zabezpieczony za pomoc **klucza konta magazynu**. SAS usugi **deleguje dostp do zasobu tylko w jednej** z usug Azure Storage: Blob storage, Queue storage, Table storage lub Azure Files. URI dla SAS na poziomie usugi skada si z URI do zasobu, dla kt贸rego SAS bdzie delegowa dostp, a nastpnie tokena SAS.

Aby u偶y powiadcze Azure Active Directory (Azure AD) do zabezpieczenia SAS dla **kontenera** lub **bloku**, u偶yj **delegacji u偶ytkownika SAS**.

### SAS konta

SAS konta jest zabezpieczony za pomoc jednego z **kluczy konta magazynu** (istniej 2). SAS konta deleguje dostp do zasob贸w w jednej lub wicej usugach magazynu. Wszystkie operacje dostpne za pomoc SAS na poziomie usugi lub delegacji u偶ytkownika s r贸wnie偶 dostpne za pomoc SAS konta.

[z dokumentacji:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Tworzc SAS konta, mo偶esz:

* Delegowa dostp do operacji na poziomie usugi, kt贸re nie s obecnie dostpne za pomoc SAS dla konkretnej usugi, takich jak operacje `Get/Set Service Properties` i `Get Service Stats`.
* Delegowa dostp do wicej ni偶 jednej usugi w jednym koncie magazynu. Na przykad, mo偶esz delegowa dostp do zasob贸w zar贸wno w Azure Blob Storage, jak i w Azure Files, korzystajc z SAS konta.
* Delegowa dostp do operacji zapisu i usuwania dla kontener贸w, kolejek, tabel i udzia贸w plik贸w, kt贸re nie s dostpne za pomoc SAS dla konkretnego obiektu.
* Okrel adres IP lub zakres adres贸w IP, z kt贸rych mo偶na akceptowa 偶dania.
* Okrel protok贸 HTTP, z kt贸rego mo偶na akceptowa 偶dania (HTTPS lub HTTP/HTTPS).

## Wyliczanie

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Odwoania

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
