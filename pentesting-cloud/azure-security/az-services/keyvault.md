# Az - Key Vault

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vaultæ˜¯ä¸€ä¸ªç”¨äº**å®‰å…¨å­˜å‚¨å’Œè®¿é—®ç§˜å¯†**çš„äº‘æœåŠ¡ã€‚ç§˜å¯†æ˜¯æ‚¨æƒ³è¦**ä¸¥æ ¼æ§åˆ¶è®¿é—®æƒé™**çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚APIå¯†é’¥ã€å¯†ç ã€è¯ä¹¦æˆ–åŠ å¯†å¯†é’¥ã€‚Key VaultæœåŠ¡æ”¯æŒä¸¤ç§ç±»å‹çš„å®¹å™¨ï¼švaultså’Œæ‰˜ç®¡ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰æ± ã€‚Vaultsæ”¯æŒå­˜å‚¨è½¯ä»¶å’ŒHSMæ”¯æŒçš„å¯†é’¥ã€ç§˜å¯†å’Œè¯ä¹¦ã€‚æ‰˜ç®¡HSMæ± ä»…æ”¯æŒHSMæ”¯æŒçš„å¯†é’¥ã€‚æŸ¥çœ‹[Azure Key Vault REST APIæ¦‚è¿°](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)è·å–å®Œæ•´è¯¦æƒ…ã€‚

**URLæ ¼å¼**ä¸º `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` å…¶ä¸­ï¼š

* `vault-name`æ˜¯å¯†é’¥ä¿ç®¡åº“çš„å…¨å±€**å”¯ä¸€**åç§°
* `object-type`å¯ä»¥æ˜¯â€œkeysâ€ã€â€œsecretsâ€æˆ–â€œcertificatesâ€
* `object-name`æ˜¯å¯†é’¥ä¿ç®¡åº“ä¸­å¯¹è±¡çš„**å”¯ä¸€**åç§°
* `object-version`æ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œå¯é€‰ç”¨äºè®¿é—®å¯¹è±¡çš„**å”¯ä¸€ç‰ˆæœ¬**ã€‚

ä¸ºäº†è®¿é—®å­˜å‚¨åœ¨ä¿ç®¡åº“ä¸­çš„ç§˜å¯†ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æƒé™æ¨¡å‹ï¼š

* **Vaultè®¿é—®ç­–ç•¥**
* **Azure RBAC**

### è®¿é—®æ§åˆ¶ <a href="#access-control" id="access-control"></a>

å¯¹Key Vaultèµ„æºçš„è®¿é—®ç”±ä¸¤ä¸ªå¹³é¢æ§åˆ¶ï¼š

* **ç®¡ç†å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯[management.azure.com](http://management.azure.com/)ã€‚
* ç”¨äºç®¡ç†å¯†é’¥ä¿ç®¡åº“å’Œ**è®¿é—®ç­–ç•¥**ã€‚ä»…æ”¯æŒAzureåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆ**RBAC**ï¼‰ã€‚
* **æ•°æ®å¹³é¢**ï¼Œå…¶ç›®æ ‡æ˜¯**`<vault-name>.vault.azure.com`**ã€‚
* ç”¨äºç®¡ç†å’Œè®¿é—®å¯†é’¥ä¿ç®¡åº“ä¸­çš„**æ•°æ®**ï¼ˆå¯†é’¥ã€ç§˜å¯†å’Œè¯ä¹¦ï¼‰ã€‚è¿™æ”¯æŒ**å¯†é’¥ä¿ç®¡åº“è®¿é—®ç­–ç•¥**æˆ–Azure **RBAC**ã€‚

åƒ**Contributor**è¿™æ ·çš„è§’è‰²åœ¨ç®¡ç†å¹³é¢å…·æœ‰ç®¡ç†è®¿é—®ç­–ç•¥çš„æƒé™ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®ç­–ç•¥æ¥è®¿é—®ç§˜å¯†ã€‚

### Key Vault RBACå†…ç½®è§’è‰² <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### ç½‘ç»œè®¿é—®

åœ¨Azure Key Vaultä¸­ï¼Œå¯ä»¥è®¾ç½®**é˜²ç«å¢™**è§„åˆ™ï¼Œä»¥ä¾¿**ä»…å…è®¸æ¥è‡ªæŒ‡å®šè™šæ‹Ÿç½‘ç»œæˆ–IPv4åœ°å€èŒƒå›´çš„æ•°æ®å¹³é¢æ“ä½œ**ã€‚æ­¤é™åˆ¶è¿˜ä¼šå½±å“é€šè¿‡Azureç®¡ç†é—¨æˆ·çš„è®¿é—®ï¼›å¦‚æœç”¨æˆ·çš„ç™»å½•IPåœ°å€ä¸åœ¨æˆæƒèŒƒå›´å†…ï¼Œåˆ™ç”¨æˆ·å°†æ— æ³•åˆ—å‡ºå¯†é’¥ã€ç§˜å¯†æˆ–è¯ä¹¦ã€‚

è¦åˆ†æå’Œç®¡ç†è¿™äº›è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨**Azure CLI**ï¼š
```bash
az keyvault show --name name-vault --query networkAcls
```
å‰ä¸€ä¸ªå‘½ä»¤å°†æ˜¾ç¤º`name-vault`çš„é˜²ç«å¢™è®¾ç½®ï¼ŒåŒ…æ‹¬å¯ç”¨çš„IPèŒƒå›´å’Œæ‹’ç»æµé‡çš„ç­–ç•¥ã€‚

## æšä¸¾

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> â€“AsPlainText
```
## Azure Key Vault

### Key Vault Usage

Azure Key Vault is a cloud service that safeguards encryption keys and secrets like certificates, connection strings, and passwords. It helps secure sensitive information by storing keys and secrets in a centralized cloud location, allowing strict access control policies and auditing.

### Key Vault Features

1. **Secrets Management**: Store and manage application secrets.
2. **Key Management**: Create and control encryption keys.
3. **Certificate Management**: Provision, manage, and deploy SSL/TLS certificates.
4. **Access Policies**: Define who can access specific keys and secrets.
5. **Monitoring**: Track key usage and manage key rotation.

### Key Vault Security Best Practices

1. **Access Control**: Use Azure RBAC to control access to Key Vault resources.
2. **Vault Hierarchy**: Organize vaults based on security requirements.
3. **Key Rotation**: Regularly rotate keys and secrets.
4. **Monitoring and Logging**: Enable logging and monitor for suspicious activities.
5. **Backup and Recovery**: Implement backup and recovery processes for keys and secrets.

### Key Vault Pricing

Azure Key Vault pricing is based on the number of operations and the type of key or secret being stored. There are additional costs for storing and managing HSM-protected keys. Check the Azure website for the most up-to-date pricing information.
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
