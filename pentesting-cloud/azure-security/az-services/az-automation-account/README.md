# Az - Cuenta de Automatizaci贸n

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n b谩sica

Azure Automation ofrece una automatizaci贸n basada en la nube, actualizaciones del sistema operativo y un servicio de configuraci贸n que admite una gesti贸n coherente en sus entornos de Azure y no de Azure. Incluye automatizaci贸n de procesos, gesti贸n de configuraci贸n, gesti贸n de actualizaciones, capacidades compartidas y caracter铆sticas heterog茅neas.

Estos son como "**tareas programadas**" en Azure que le permitir谩n ejecutar cosas (acciones o incluso scripts) para **administrar**, verificar y configurar el **entorno de Azure**.

### Cuenta de Ejecuci贸n

Cuando se utiliza la **Cuenta de Ejecuci贸n**, se crea una **aplicaci贸n de Azure AD** con un certificado autofirmado, se crea un **principal de servicio** y se asigna el rol de **Contribuyente** para la cuenta en la **suscripci贸n actual** (muchos privilegios).\
Microsoft recomienda el uso de una **Identidad Administrada** para la Cuenta de Automatizaci贸n.

{% hint style="warning" %}
Esto se **eliminar谩 el 30 de septiembre de 2023 y se cambiar谩 por Identidades Administradas**.
{% endhint %}

## Compromiso de Runbooks y Trabajos

Los **Runbooks** le permiten **ejecutar c贸digo PowerShell arbitrario**. Esto podr铆a ser **abusado por un atacante** para robar los permisos del **principal adjunto** (si lo hay).\
En el **c贸digo** de los **Runbooks** tambi茅n se pueden encontrar **informaci贸n sensible** (como credenciales).

Si puede **leer** los **trabajos**, h谩galo ya que **contienen** la **salida** de la ejecuci贸n (informaci贸n potencialmente **sensible**).

Vaya a `Cuentas de Automatizaci贸n` --> `<Seleccione la Cuenta de Automatizaci贸n>` --> `Runbooks/Trabajos/Grupos de trabajadores h铆bridos/Tareas de vigilancia/credenciales/variables/certificados/conexiones`

### Trabajador H铆brido

Un Runbook se puede ejecutar en un **contenedor dentro de Azure** o en un **Trabajador H铆brido**.\
El **Agente de An谩lisis de registros** se implementa en la VM para registrarla como un trabajador h铆brido.\
Los trabajos de trabajador h铆brido se ejecutan como **SYSTEM** en Windows y como cuenta **nxautomation** en Linux.\
Cada Trabajador H铆brido se registra en un **Grupo de Trabajadores H铆bridos**.

Por lo tanto, si puede elegir ejecutar un **Runbook** en un **Trabajador H铆brido de Windows**, ejecutar谩 **comandos arbitrarios** dentro de esa m谩quina como **System**.

## Compromiso de Configuraci贸n de Estado (SC)

La **Configuraci贸n de Estado de Automatizaci贸n de Azure** es un servicio de gesti贸n de configuraci贸n de Azure que le permite escribir, administrar y compilar configuraciones de PowerShell Desired State Configuration (DSC) [configuraciones](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations) para nodos en cualquier nube o centro de datos local. El servicio tambi茅n importa [Recursos DSC](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources) y asigna configuraciones a nodos de destino, todo en la nube. Puede acceder a la Configuraci贸n de Estado de Automatizaci贸n de Azure en el portal de Azure seleccionando **Configuraci贸n de estado (DSC)** en **Gesti贸n de configuraci贸n**.

Se podr铆a encontrar **informaci贸n sensible** en estas configuraciones.

### RCE

Es posible abusar de SC para ejecutar scripts arbitrarios en las m谩quinas administradas.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## Enumeraci贸n

{% code overflow="wrap" %}
```powershell
# Comprueba los derechos de usuario para la automatizaci贸n
az extension add --upgrade -n automation
az automation account list # si no devuelve nada, el usuario no es parte de un grupo de automatizaci贸n

# Obtiene las cuentas de automatizaci贸n de Azure en un grupo de recursos
Get-AzAutomationAccount

# Lista y obtiene configuraciones DSC
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Las cuentas de automatizaci贸n con nombre SecurityBaselineConfigurationWS... est谩n ah铆 por defecto (no son interesantes)

# Lista y obtiene el c贸digo de los Runbooks
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRun