# Az - Key Vault

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

[DokÃ¼mantasyondan:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault, **gÃ¼venli bir ÅŸekilde saklama ve eriÅŸim saÄŸlamak iÃ§in** bir bulut hizmetidir. Bir sÄ±r, API anahtarlarÄ±, ÅŸifreler, sertifikalar veya kriptografik anahtarlar gibi **eriÅŸimi sÄ±kÄ± bir ÅŸekilde kontrol etmek istediÄŸiniz her ÅŸeydir**. Key Vault hizmeti, iki tÃ¼r konteyneri destekler: kasa ve yÃ¶netilen donanÄ±m gÃ¼venlik modÃ¼lÃ¼ (HSM) havuzlarÄ±. Kasalar, yazÄ±lÄ±m ve HSM destekli anahtarlarÄ±, sÄ±rlarÄ± ve sertifikalarÄ± saklamayÄ± destekler. YÃ¶netilen HSM havuzlarÄ± yalnÄ±zca HSM destekli anahtarlarÄ± destekler. Tam ayrÄ±ntÄ±lar iÃ§in [Azure Key Vault REST API genel bakÄ±ÅŸÄ±na](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) bakÄ±n.

**URL formatÄ±** ÅŸu ÅŸekildedir: `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` Burada:

* `vault-name`, anahtar kasasÄ±nÄ±n kÃ¼resel olarak **benzersiz** adÄ±dÄ±r
* `object-type`, "keys", "secrets" veya "certificates" olabilir
* `object-name`, anahtar kasasÄ± iÃ§indeki nesnenin **benzersiz** adÄ±dÄ±r
* `object-version`, sistem tarafÄ±ndan oluÅŸturulan ve isteÄŸe baÄŸlÄ± olarak bir nesnenin **benzersiz bir sÃ¼rÃ¼mÃ¼nÃ¼** belirtmek iÃ§in kullanÄ±lÄ±r.

Anahtar kasasÄ±nda saklanan sÄ±rlara eriÅŸmek iÃ§in 2 izin modeli kullanÄ±labilir:

* **Kasa eriÅŸim politikasÄ±**
* **Azure RBAC**

### EriÅŸim KontrolÃ¼ <a href="#access-control" id="access-control"></a>

Bir Anahtar KasasÄ± kaynaÄŸÄ±na eriÅŸim, iki dÃ¼zlem tarafÄ±ndan kontrol edilir:

* **YÃ¶netim dÃ¼zlemi**, hedefi [management.azure.com](http://management.azure.com/) olan bir dÃ¼zlemdir.&#x20;
* Anahtar kasasÄ±nÄ± ve **eriÅŸim politikalarÄ±nÄ± yÃ¶netmek** iÃ§in kullanÄ±lÄ±r. YalnÄ±zca Azure rol tabanlÄ± eriÅŸim kontrolÃ¼ (**RBAC**) desteklenir.
* **Veri dÃ¼zlemi**, hedefi **`<vault-name>.vault.azure.com`** olan bir dÃ¼zlemdir.&#x20;
* Anahtar kasasÄ±ndaki **verileri** (anahtarlar, sÄ±rlar ve sertifikalar) **yÃ¶netmek ve eriÅŸmek** iÃ§in kullanÄ±lÄ±r. Bu, **anahtar kasasÄ± eriÅŸim politikalarÄ±nÄ±** veya Azure **RBAC**'Ä± destekler.

YÃ¶netim dÃ¼zleminde eriÅŸim politikalarÄ±nÄ± yÃ¶netmek iÃ§in izinlere sahip olan **Contributor** gibi bir rol, eriÅŸim politikalarÄ±nÄ± deÄŸiÅŸtirerek sÄ±rlara eriÅŸebilir.

### Anahtar KasasÄ± RBAC YerleÅŸik Roller <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### AÄŸ EriÅŸimi

Azure Key Vault'ta, **gÃ¼venlik duvarÄ±** kurallarÄ± **belirli sanal aÄŸlardan veya IPv4 adres aralÄ±klarÄ±ndan yalnÄ±zca veri dÃ¼zlemi iÅŸlemlerine izin vermek** iÃ§in ayarlanabilir. Bu kÄ±sÄ±tlama, Azure yÃ¶netim portalÄ± Ã¼zerinden eriÅŸimi de etkiler; kullanÄ±cÄ±lar yetkilendirilmiÅŸ aralÄ±k iÃ§inde olmayan bir giriÅŸ IP adresine sahipse anahtar kasasÄ±ndaki anahtarlarÄ±, sÄ±rlarÄ± veya sertifikalarÄ± listeleyemezler.

Bu ayarlarÄ± analiz etmek ve yÃ¶netmek iÃ§in **Azure CLI**'yi kullanabilirsiniz:
```bash
az keyvault show --name name-vault --query networkAcls
```
Ã–nceki komut, `name-vault` adlÄ± anahtar deposunun etkin IP aralÄ±klarÄ±nÄ± ve reddedilen trafiÄŸe yÃ¶nelik politikalarÄ±nÄ± iÃ§eren f**irewall ayarlarÄ±nÄ±** gÃ¶rÃ¼ntÃ¼leyecektir.

## NumaralandÄ±rma

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> â€“AsPlainText
```
{% code %}
## Key Vault

Azure Key Vault is a cloud service that provides a secure storage for secrets, keys, and certificates. It allows you to securely store and manage sensitive information such as passwords, API keys, and connection strings.

### Key Vault Security Best Practices

Here are some best practices to ensure the security of your Key Vault:

1. **Access Control**: Implement proper access control to restrict who can manage and access the Key Vault. Use RBAC (Role-Based Access Control) to assign appropriate roles to users and groups.

2. **Network Security**: Configure network security groups (NSGs) to restrict inbound and outbound traffic to the Key Vault. Use virtual network service endpoints to allow access only from specific virtual networks.

3. **Encryption**: Enable encryption at rest for the Key Vault data. Azure Key Vault automatically encrypts the data using Azure Storage Service Encryption (SSE) and Azure Disk Encryption (ADE).

4. **Monitoring and Logging**: Enable diagnostic logs and monitor the Key Vault activities. Use Azure Monitor to track and analyze the logs for any suspicious activities.

5. **Secret Management**: Follow secure coding practices to handle secrets securely. Avoid hardcoding secrets in code and use Key Vault references or environment variables to retrieve secrets at runtime.

6. **Key Rotation**: Regularly rotate the keys and certificates stored in the Key Vault. This helps to mitigate the risk of compromised keys.

7. **Backup and Recovery**: Implement a backup and recovery strategy for the Key Vault. Regularly backup the Key Vault data and test the recovery process to ensure data availability in case of any failures.

### Key Vault Vulnerabilities and Exploits

Here are some common vulnerabilities and exploits related to Key Vault:

1. **Weak Access Controls**: Improperly configured access controls can allow unauthorized users to manage or access the Key Vault. Always follow the principle of least privilege and regularly review and update access control policies.

2. **Insecure Secrets Management**: Storing secrets in an insecure manner, such as hardcoding them in code or configuration files, can lead to their exposure. Always use secure methods like Key Vault references or environment variables to handle secrets.

3. **Misconfigured Network Security**: Improperly configured network security settings can expose the Key Vault to unauthorized access. Ensure that proper network security groups and virtual network service endpoints are configured.

4. **Lack of Monitoring and Logging**: Without proper monitoring and logging, it becomes difficult to detect and respond to any suspicious activities or breaches in the Key Vault. Enable diagnostic logs and regularly review the logs for any anomalies.

5. **Insufficient Key Rotation**: Failure to regularly rotate keys and certificates increases the risk of compromised keys. Implement a key rotation policy and regularly update the keys and certificates stored in the Key Vault.

6. **Lack of Backup and Recovery**: Without a proper backup and recovery strategy, the Key Vault data may be lost in case of any failures or disasters. Regularly backup the Key Vault data and test the recovery process.

By following these best practices and addressing the vulnerabilities, you can enhance the security of your Key Vault and protect your sensitive information from unauthorized access or exposure.
{% endcode %}
{% endtab %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
