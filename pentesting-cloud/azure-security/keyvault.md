# Az - Keyvault

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Key Vaultæ˜¯ä¸€ä¸ªäº‘æœåŠ¡ï¼Œç”¨äº**å®‰å…¨å­˜å‚¨å’Œè®¿é—®ç§˜å¯†ä¿¡æ¯**ã€‚ç§˜å¯†ä¿¡æ¯æ˜¯æŒ‡æ‚¨æƒ³è¦**ä¸¥æ ¼æ§åˆ¶è®¿é—®æƒé™**çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚APIå¯†é’¥ã€å¯†ç ã€è¯ä¹¦æˆ–åŠ å¯†å¯†é’¥ã€‚Key VaultæœåŠ¡æ”¯æŒä¸¤ç§ç±»å‹çš„å®¹å™¨ï¼švaultså’Œæ‰˜ç®¡ç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)æ± ã€‚Vaultsæ”¯æŒå­˜å‚¨è½¯ä»¶å’ŒHSMæ”¯æŒçš„å¯†é’¥ã€ç§˜å¯†ä¿¡æ¯å’Œè¯ä¹¦ã€‚æ‰˜ç®¡HSMæ± ä»…æ”¯æŒHSMæ”¯æŒçš„å¯†é’¥ã€‚æœ‰å…³å®Œæ•´è¯¦æƒ…ï¼Œè¯·å‚é˜…[Azure Key Vault REST APIæ¦‚è¿°](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)ã€‚

**URLæ ¼å¼**ä¸º `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` å…¶ä¸­ï¼š

* `vault-name` æ˜¯key vaultçš„å…¨çƒ**å”¯ä¸€**åç§°
* `object-type` å¯ä»¥æ˜¯"keys"ã€"secrets"æˆ–"certificates"
* `object-name` æ˜¯key vaultå†…å¯¹è±¡çš„**å”¯ä¸€**åç§°
* `object-version` æ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œå¯é€‰ç”¨æ¥æŒ‡å‘å¯¹è±¡çš„**å”¯ä¸€ç‰ˆæœ¬**ã€‚

ä¸ºäº†è®¿é—®å­˜å‚¨åœ¨vaultä¸­çš„ç§˜å¯†ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨2ç§æƒé™æ¨¡å‹ï¼š

* **Vaultè®¿é—®ç­–ç•¥**
* **Azure RBAC**

### è®¿é—®ç®¡ç†

é€šè¿‡**ä¸¤ä¸ª**å¹³é¢æ§åˆ¶å¯¹vaultçš„è®¿é—®ï¼š

* **ç®¡ç†å¹³é¢ï¼š** ç®¡ç†key vaultå’Œ**è®¿é—®ç­–ç•¥**ã€‚ä»…æ”¯æŒAzureåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)ã€‚
* **æ•°æ®å¹³é¢ï¼š** ç®¡ç†**key vaultä¸­çš„**æ•°æ®ï¼ˆå¯†é’¥ã€ç§˜å¯†ä¿¡æ¯å’Œè¯ä¹¦ï¼‰ã€‚è¿™æ”¯æŒkey vaultè®¿é—®ç­–ç•¥æˆ–Azure RBAC

åƒ**Contributor**è¿™æ ·çš„è§’è‰²ï¼Œå¦‚æœåœ¨ç®¡ç†å¹³é¢æœ‰æƒé™ç®¡ç†è®¿é—®ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®ç­–ç•¥æ¥è®¿é—®ç§˜å¯†ä¿¡æ¯ã€‚

### ç½‘ç»œè®¿é—®

åœ¨Azure Key Vaultä¸­ï¼Œå¯ä»¥è®¾ç½®**é˜²ç«å¢™**è§„åˆ™ï¼Œ**ä»…å…è®¸æ¥è‡ªæŒ‡å®šè™šæ‹Ÿç½‘ç»œæˆ–IPv4åœ°å€èŒƒå›´çš„æ•°æ®å¹³é¢æ“ä½œ**ã€‚è¿™ç§é™åˆ¶ä¹Ÿå½±å“é€šè¿‡Azureç®¡ç†é—¨æˆ·çš„è®¿é—®ï¼›å¦‚æœç”¨æˆ·çš„ç™»å½•IPåœ°å€ä¸åœ¨æˆæƒèŒƒå›´å†…ï¼Œä»–ä»¬å°†æ— æ³•åœ¨key vaultä¸­åˆ—å‡ºå¯†é’¥ã€ç§˜å¯†ä¿¡æ¯æˆ–è¯ä¹¦ã€‚

è¦åˆ†æå’Œç®¡ç†è¿™äº›è®¾ç½®ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**Azure CLI**ï¼š
```bash
az keyvault show --name name-vault --query networkAcls
```
ä¸Šä¸€æ¡å‘½ä»¤å°†æ˜¾ç¤º`name-vault`çš„é˜²ç«å¢™è®¾ç½®ï¼ŒåŒ…æ‹¬å¯ç”¨çš„IPèŒƒå›´å’Œæ‹’ç»æµé‡çš„ç­–ç•¥ã€‚

## æšä¸¾

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1084ea5ba0f2-46ee-1946-ab567de59abc -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> â€“AsPlainText
```
{% endcode %}
{% endtab %}

{% tab title="az" %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
```markdown
{% endtab %}
{% endtabs %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºè‹±é›„ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
```
