# Az - Phishing de Token de Actualizaci贸n Primario (Microsoft Entra)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Publicaci贸n copiada de** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## Informaci贸n B谩sica

Los **Primary Refresh Tokens** se utilizan para Single Sign On en dispositivos que est谩n unidos, registrados o unidos de forma h铆brida a Azure AD/Microsoft Entra. Se pueden utilizar tanto en flujos de inicio de sesi贸n en el navegador para aplicaciones web como para iniciar sesi贸n en aplicaciones m贸viles y de escritorio que se ejecutan en el dispositivo.

Ten en cuenta que los Primary Refresh Tokens se pueden utilizar para **solicitar un token de acceso para acceder a los datos**, pero los Access Tokens no se pueden utilizar para solicitar un Primary Refresh Token.

Para obtener un Primary Refresh Token necesitas comenzar con una identidad de dispositivo y luego usar las credenciales del usuario para solicitar un PRT. Esto limita c贸mo se pueden emitir estos potentes tokens y dificulta que los atacantes los obtengan.

Puedes encontrar m谩s informaci贸n sobre los PRTs en:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## C贸mo Funciona el Flujo

Si se configura una nueva instalaci贸n de Windows, generalmente solo es necesario autenticarse una vez durante el proceso de configuraci贸n, y esto es interesante, ya que en el momento en que comenzamos la configuraci贸n el dispositivo a煤n no est谩 unido o registrado en Azure AD, pero al final tenemos un PRT que se utiliza para SSO, e incluso cumple con los requisitos para aprovisionar las llaves WHFB.

El proceso comienza al iniciar sesi贸n en una **aplicaci贸n espec铆fica**, lo que proporciona a Windows un **token de acceso** y un **token de actualizaci贸n**. Los tokens de acceso se pueden utilizar para **unir el dispositivo a Azure AD** y **configurar la identidad del dispositivo**. Despu茅s del registro del dispositivo, el **token de actualizaci贸n**, que se emiti贸 sin un dispositivo, se utiliza con la **nueva identidad del dispositivo para solicitar un Primary Refresh Token**.

{% hint style="info" %}
Por lo tanto, es posible utilizar un token de actualizaci贸n regular, que no est谩 vinculado a un dispositivo pero s铆 est谩 **vinculado a una aplicaci贸n espec铆fica**, para primero **registrar un dispositivo** y luego **solicitar un token m谩s poderoso** que se puede utilizar en cualquier escenario de inicio de sesi贸n.
{% endhint %}

La "actualizaci贸n" de token de actualizaci贸n normal a Primary Refresh Token no es posible con cada token de actualizaci贸n. Requiere una ID de aplicaci贸n espec铆fica (client ID) en el flujo de inicio de sesi贸n. Windows utiliza el client ID `29d9ed98-a469-4536-ade2-f981bc1d605e` (Microsoft Authentication Broker) y el recurso `https://enrollment.manage.microsoft.com/` para esta solicitud. Podemos emular este flujo con el comando `gettokens` de roadtx, que admite varios flujos de autenticaci贸n diferentes:

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

Si hay una pol铆tica que requiere MFA para iniciar sesi贸n, en su lugar podemos utilizar el m贸dulo `interactiveauth`:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

El token de actualizaci贸n resultante (que se almacena en cach茅 en el archivo `.roadtools_auth`) se puede utilizar para solicitar un token para el servicio de registro de dispositivos, donde podemos crear el dispositivo:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ahora que tenemos una identidad de dispositivo, podemos combinarla con el mismo token de actualizaci贸n para obtener un PRT (ambos tokens de actualizaci贸n acortados para facilitar la lectura):

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Los tokens resultantes de la autenticaci贸n contendr谩n los mismos reclamos de m茅todo de autenticaci贸n que se usaron durante el registro, por lo que **cualquier uso de MFA se transferir谩 al PRT**. El PRT que obtenemos se puede utilizar en cualquier flujo de autenticaci贸n, por lo que podemos ampliar el alcance de nuestro token de actualizaci贸n limitado a cualquier aplicaci贸n posible.

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Tambi茅n podemos usar esto para iniciar sesi贸n en flujos de navegador:

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Aprovisionamiento de llaves Windows Hello for Business <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

Si configuras Windows y WHFB est谩 habilitado para tu dispositivo, utilizar谩 **la misma sesi贸n para aprovisionar la llave WHFB para el dispositivo reci茅n configurado**. Para hacer esto, necesitaremos un token de acceso con el reclamo `ngcmfa` (nueva generaci贸n de credenciales MFA). Mientras hayamos realizado la **autenticaci贸n MFA en los 煤ltimos 10 minutos**, el **PRT** del **paso anterior** es todo lo que necesitamos. Podemos pedirle a **Azure AD que nos d茅 un token para el servicio de registro de dispositivos** que contenga este reclamo, sin requerir m谩s interacci贸n del usuario. Para hacer esto, usamos el comando `prtenrich` de **roadtx**, que solicitar谩 este token.

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Con este nuevo token de acceso, podemos aprovisionar la nueva llave WHFB. Esta llave se puede utilizar para solicitar nuevos PRTs en el futuro, sin necesidad de acceso a la contrase帽a del usuario.

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing de Primary Refresh Tokens <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

Ahora que sabemos c贸mo funciona el proceso, podemos cambiar el enfoque para hacerlo utilizable para phishing. No es posible hacer phishing de PRTs directamente, ya que esto requiere una identidad de dispositivo existente que se utilice durante el flujo. **No podemos enga帽ar a los usuarios o sus endpoints para que nos env铆en la informaci贸n requerida para solicitar directamente un PRT**. Sin embargo, podemos utilizar varios m茅todos para **pedir un token de actualizaci贸n regular con el cliente y recurso correctos**, para luego usar eso para **registrar un dispositivo y solicitar un PRT**.

### Phishing de c贸digo de dispositivo <a href="#device-code-phishing" id="device-code-phishing"></a>

En el paso de autenticaci贸n anterior, utilizamos un nombre de usuario y contrase帽a para autenticarnos. Sin embargo, tambi茅n podemos usar el **flujo de c贸digo de dispositivo para esto**. Aunque Windows no utiliza este flujo para el proceso de registro/uni贸n, es un **flujo OAuth v谩lido** que nos dar谩 el mismo **token de actualizaci贸n:**

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

Como puedes ver, el flujo de c贸digo de dispositivo pide a los usuarios que **ingresen un c贸digo en su propio dispositivo y completen la autenticaci贸n**, lo que proporcionar谩 los tokens en el dispositivo en el que se inici贸. Este flujo tambi茅n es adecuado para phishing, porque si podemos **convencer a nuestra v铆ctima de realizar la autenticaci贸n con un c贸digo de dispositivo, obtendremos tokens en su nombre**. Esta no es una t茅cnica nueva, pero ha sido descrita por varias personas en el pasado. Tambi茅n hay varios kits de herramientas que **facilitan todo el proceso**. Si quieres leer m谩s sobre esta t茅cnica, aqu铆 hay algunas referencias:

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

As铆 que supongamos que **convencemos a un usuario de autenticarse y recibimos el token de actualizaci贸n**. Ahora podemos usar este **token de actualizaci贸n** para:

* **Registrar o unir un dispositivo a Azure AD** si a煤n no tenemos acceso a un dispositivo en el tenant.
* Utilizar el **token de actualizaci贸n para solicitar un PRT**.
* Si el usuario realiz贸 una autenticaci贸n MFA "fresca" al autenticarse con el flujo de c贸digo de dispositivo, tambi茅n podemos **registrar credenciales WHFB en su cuenta para persistencia**.

Hay algunas advertencias a esto, que debes tener en cuenta si est谩s realizando este ataque:

* El **c贸digo de dispositivo solo es v谩lido durante 15 minutos** despu茅s de iniciar el flujo de c贸digo de dispositivo, lo que agrega restricciones adicionales si quieres usar esto para phishing. Algunas herramientas tienen en cuenta esto al crear el c贸digo de dispositivo solo una vez que el usuario interact煤a con el correo electr贸nico, por ejemplo, a trav茅s de un c贸digo QR.
* **Registrar o unir dispositivos podr铆a estar restringido en el tenant solo a usuarios espec铆ficos**. En general, unir dispositivos se restringe con m谩s frecuencia que registrarlos. A menos que haya pol铆ticas espec铆ficas que requieran un cierto estado del dispositivo, no habr谩 una diferencia pr谩ctica en la usabilidad del token.
* **Registrar credenciales WHFB solo es posible si el usuario realiz贸 activamente MFA al usar el c贸digo de dispositivo**. Si usan el c贸digo de dispositivo desde una sesi贸n existente en su dispositivo administrado, el reclamo MFA se transferir谩 al token de actualizaci贸n y lo m谩s probable es que no sea lo suficientemente reciente como para aprovisionar una llave WHFB. En mis pruebas, el estado de inicio de sesi贸n en cach茅 solo se utilizar谩 si el usuario tiene una sesi贸n existente en un dispositivo no administrado, y en los navegadores que iniciaron sesi贸n usando SSO no se utilizar谩 autom谩ticamente el inicio de sesi贸n en cach茅.

El video a continuaci贸n muestra el ataque como una prueba de concepto. En escenarios pr谩cticos, podr铆as usar tu marco de phishing de c贸digo de dispositivo preferido o m茅todo para hacer la parte de phishing.

{% embed url="https://dirkjanm.io/assets/raw/prtphish.mp4" %}

El video anterior utiliza el script [deviceCode2WinHello](https://github.com/kiwids0220/deviceCode2WinHello) que automatiza todos estos pasos, escrito por [Kai](https://twitter.com/mhskai2017) de SpecterOps (ver conclusiones al final del blog). Tambi茅n utiliza el m贸dulo `roadtx keepassauth` para hacer la autenticaci贸n, en realidad tendr铆as que convencer a tu v铆ctima para que haga la autenticaci贸n, pero esto fue m谩s f谩cil para la demostraci贸n.

### Phishing de credenciales <a href="#credential-phishing" id="credential-phishing"></a>

Tambi茅n es posible realizar el ataque de phishing utilizando m茅todos de phishing de credenciales, por ejemplo con evilginx como marco. Si usamos un phishlet de Microsoft 365 para iniciar sesi贸n, por ejemplo [este](https://github.com/BakkerJan/evilginx3/blob/main/microsoft365.yaml) de Jan Bakker, obtendremos las cookies de sesi贸n de la v铆ctima. Estas cookies de sesi贸n se pueden utilizar con roadtx para solicitar los tokens correctos, y a partir de ah铆 el ataque es el mismo:

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

## Prevenci贸n y detecci贸n <a href="#prevention-and-detection" id="prevention-and-detection"></a>

No hay muchas formas de prevenir estos ataques. El phishing de c贸digo de dispositivo es uno de los pocos m茅todos que no se previene al requerir una cierta fuerza de MFA, ya que los usuarios realizan esta autenticaci贸n contra los dominios leg铆timos de Microsoft. Adem谩s, desafortunadamente no hay forma de bloquear ciertos flujos OAuth como el flujo de c贸digo de dispositivo. El enfoque de phishing de credenciales descrito anteriormente es m谩s f谩cil de prevenir, ya que esto ocurrir谩 en un sitio web falso que evitar谩 que algunos m茅todos de MFA funcionen.

La 煤nica forma realmente efectiva de bloquear este ataque es requerir que un dispositivo sea administrado a trav茅s de MDM o MAM, teniendo una pol铆tica de Acceso Condicional en su lugar que requiera un dispositivo compatible o unido de forma h铆brida. Cumplir con esta pol铆tica requerir铆a que el dispositivo reci茅n registrado tambi茅n est茅 inscrito en Intune. Siempre que Intune est茅 lo suficientemente bloqueado para evitar que las personas inscriban dispositivos no corporativos o falsos, nuestro dispositivo reci茅n registrado no podr谩 volverse compatible y cumplir con los requisitos de estas pol铆ticas. Ten en cuenta que el flujo de registro del dispositivo en s铆 no est谩 bloqueado por pol铆ticas que requieren dispositivos compatibles, ya que este flujo est谩 por definici贸n excluido de estas pol铆ticas (no puedes tener ya un dispositivo compatible durante el registro del dispositivo). Por lo tanto, si hay pol铆ticas en vigor que requieren un dispositivo compatible o unido de forma h铆brida, todav铆a es posible obtener un PRT. Sin embargo, el PRT no se puede utilizar para autenticarse o para inscribir las llaves WHFB ya que eso requerir铆a que el dispositivo sea compatible o unido de forma h铆brida.

Afortunadamente, la detecci贸n de esta t茅cnica es m谩s f谩cil. Windows no utilizar谩 el flujo de C贸digo de Dispositivo para registrarse o unirse a Azure AD, sino que pedir谩 al usuario que se autentique de forma interactiva. Dado que el flujo de autenticaci贸n se muestra en los registros de inicio de sesi贸n, es bastante f谩cil escribir consultas de detecci贸n basadas en la ID de la aplicaci贸n y el flujo de autenticaci贸n. Un ejemplo de consulta KQL podr铆a verse as铆:
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
Durante mis conversaciones con Microsoft sobre este tema, me informaron que en algunos casos el flujo de c贸digo de dispositivo se utiliza leg铆timamente por la aplicaci贸n intermediaria, por lo que esta consulta podr铆a generar algunos falsos positivos. Si encuentras coincidencias leg铆timas con esta consulta, no dudes en contactarme para que podamos ver si es posible ajustarla para excluir casos leg铆timos.

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
