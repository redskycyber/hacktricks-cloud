# Az AD Connect - Identidad H√≠brida

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

**AD local** puede ser **integrado** con Azure AD usando **Azure AD Connect** con los siguientes **m√©todos,** los cuales podr√≠an ser abusados para comprometer la **nube desde AD local o viceversa (**o ambos). Cada m√©todo soporta Single Sign-on (SSO):

* **Sincronizaci√≥n de Hash de Contrase√±a (PHS)**: Es posible extraer las contrase√±as de usuarios privilegiados en texto claro del AD, incluso las credenciales de un usuario auto generado con altos privilegios sobre AzureAD.

{% content-ref url="phs-password-hash-sync.md" %}
[phs-password-hash-sync.md](phs-password-hash-sync.md)
{% endcontent-ref %}

* **Autenticaci√≥n de Paso a Trav√©s (PTA)**: Es posible comprometer el agente que se ejecuta en el AD local para validar todas las contrase√±as de usuarios que intentan conectarse a Azure (local -> Nube) y tambi√©n es posible registrar un nuevo agente para validar la autenticaci√≥n en un nuevo lugar (Nube -> local).

{% content-ref url="pta-pass-through-authentication.md" %}
[pta-pass-through-authentication.md](pta-pass-through-authentication.md)
{% endcontent-ref %}

* **Federaci√≥n**: Roba la clave privada usada para firmar el SAML y podr√°s suplantar identidades en local y en la nube.

{% content-ref url="federation.md" %}
[federation.md](federation.md)
{% endcontent-ref %}

* **SSO Sin Problemas:** Roba la contrase√±a del usuario auto creado **AZUREADSSOACC** que se utiliza para firmar tickets de plata de kerberos para acceder a AzureAD, e impersonar a cualquier usuario en la nube.

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

* **Confianza de Kerberos en la Nube**: De Administrador Global a Administrador de Dominio local impersonando usuario modificando el nombre de usuario y SID de usuarios en AzureAD y luego solicitando TGTs a AzureAD.

{% content-ref url="az-cloud-kerberos-trust.md" %}
[az-cloud-kerberos-trust.md](az-cloud-kerberos-trust.md)
{% endcontent-ref %}

Para cada m√©todo, al menos se realiza la **sincronizaci√≥n de usuarios** y se crea una cuenta con el nombre **`MSOL_<installationidentifier>`** en el **AD local**.

Adem√°s, tanto **PHS** como **PTA** **soportan** **SSO Sin Problemas** para iniciar sesi√≥n autom√°ticamente en computadoras de Azure AD **unidas al dominio local**.

Es posible verificar si **Azure AD Connect** est√° instalado con este comando del m√≥dulo AzureADConnectHealthSync que se **instala por defecto** en la instalaci√≥n de **Azure AD Connect**:
```powershell
Get-ADSyncConnector
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
