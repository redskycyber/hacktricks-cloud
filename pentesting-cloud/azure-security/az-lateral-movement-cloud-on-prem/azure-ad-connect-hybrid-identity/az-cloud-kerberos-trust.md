# Az - Cloud Kerberos Trust

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Ovaj post je saÅ¾etak** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **gde moÅ¾ete pronaÄ‡i dodatne informacije o napadu. Ova tehnika je takoÄ‘e objaÅ¡njena u** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Osnovne informacije

### Poverenje

Kada se uspostavi poverenje sa Azure AD, u AD-u se kreira **Read Only Domain Controller (RODC)**. RaÄunara RODC-a se naziva **`AzureADKerberos$`**. TakoÄ‘e, kreira se sekundarni `krbtgt` raÄun nazvan **`krbtgt_AzureAD`**. Ovaj raÄun sadrÅ¾i **Kerberos kljuÄeve** koji se koriste za tikete koje Azure AD kreira.

Dakle, ako se ovaj raÄun kompromituje, moguÄ‡e je preuzeti identitet bilo kog korisnika... iako to nije taÄno jer je ovom raÄunu onemoguÄ‡eno kreiranje tiketa za bilo koju privilegovanu AD grupu kao Å¡to su Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
MeÄ‘utim, u stvarnom scenariju postojaÄ‡e privilegovani korisnici koji nisu u tim grupama. Dakle, **novi krbtgt raÄun, ako je kompromitovan, moÅ¾e se koristiti za preuzimanje njihovog identiteta.**
{% endhint %}

### Kerberos TGT

Osim toga, kada se korisnik autentifikuje na Windows-u koristeÄ‡i hibridni identitet **Azure AD** Ä‡e izdati **delimiÄan Kerberos tiket zajedno sa PRT-om**. TGT je delimiÄan jer **AzureAD ima ograniÄene informacije** o korisniku u lokalnom AD-u (kao Å¡to su sigurnosni identifikator (SID) i ime).\
Windows moÅ¾e zatim **zameniti ovaj delimiÄan TGT za pun TGT** tako Å¡to Ä‡e zatraÅ¾iti servisni tiket za `krbtgt` servis.&#x20;

### NTLM

PoÅ¡to mogu postojati servisi koji ne podrÅ¾avaju Kerberos autentifikaciju veÄ‡ NTLM, moguÄ‡e je zatraÅ¾iti **delimiÄan TGT potpisan pomoÄ‡u sekundarnog `krbtgt`** kljuÄa ukljuÄujuÄ‡i polje **`KERB-KEY-LIST-REQ`** u delu **PADATA** zahteva, a zatim dobiti pun TGT potpisan primarnim `krbtgt` kljuÄem **ukljuÄujuÄ‡i NT hash u odgovoru**.

## Zloupotreba Cloud Kerberos poverenja za dobijanje Domain Admin pristupa <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Kada AzureAD generiÅ¡e **delimiÄan TGT**, koristiÄ‡e informacije koje ima o korisniku. Dakle, ako Globalni administrator moÅ¾e da izmeni podatke kao Å¡to su **sigurnosni identifikator i ime korisnika u AzureAD-u**, prilikom zahteva za TGT za tog korisnika, **sigurnosni identifikator Ä‡e biti drugaÄiji**.

To nije moguÄ‡e uraditi putem Microsoft Graph-a ili Azure AD Graph-a, ali je moguÄ‡e koristiti **API Active Directory Connect** koji se koristi za kreiranje i aÅ¾uriranje sinhronizovanih korisnika, a koji Globalni administratori mogu koristiti da **izmene SAM ime i SID bilo kog hibridnog korisnika**, a zatim, ako se autentifikujemo, dobijamo delimiÄan TGT koji sadrÅ¾i izmenjeni SID.

Imajte na umu da to moÅ¾emo uraditi sa AADInternals i aÅ¾urirati sinhronizovane korisnike putem [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet-a.

### Pretpostavke napada <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Uspeh napada i dobijanje Domain Admin privilegija zavisi od ispunjenja odreÄ‘enih pretpostavki:

* KljuÄno je imati moguÄ‡nost izmene naloga putem Synchronization API-ja. To se moÅ¾e postiÄ‡i imajuÄ‡i ulogu Globalnog administratora ili posedovanjem AD Connect sync naloga. Alternativno, dovoljna bi bila i uloga Hybrid Identity Administratora, jer omoguÄ‡ava upravljanje AD Connect-om i uspostavljanje novih sync naloga.
* Prisustvo **hibridnog naloga** je neophodno. Ovaj nalog mora biti podloÅ¾an izmenama sa detaljima Å¾rtvinog naloga i takoÄ‘e mora biti dostupan za autentifikaciju.
* Neophodno je identifikovati **ciljni Å¾rtveni nalog** u Active Directory-ju. Iako se napad moÅ¾e izvrÅ¡iti na bilo kom veÄ‡ sinhronizovanom nalogu, Azure AD zakupac ne sme imati replikirane sigurnosne identifikatore sa lokalnog AD-a, Å¡to zahteva izmenu nesinhronizovanog naloga radi dobijanja tiketa.
* Ovaj nalog takoÄ‘e treba da ima privilegije ekvivalentne Domain Admin-u, ali ne sme biti Älan tipiÄnih AD administratorskih grupa kako bi se izbeglo generisanje nevaÅ¾eÄ‡ih TGT-ova od strane AzureAD RODC-a.
* Najpogodnija meta je **Active Directory nalog koji se koristi od strane AD Connect Sync servisa**. Ovaj nalog nije sinhronizovan sa Azure AD-om, ostavljajuÄ‡i njegov SID kao moguÄ‡u metu, a inherentno poseduje privilegije ekvivalentne Domain Admin-u zbog svoje uloge u sinhronizaciji heÅ¡eva lozinki (pod pretpostavkom da je Password Hash Sync aktivan). Za domene sa ekspres instalacijom, ovaj nalog ima prefiks **MSOL\_**. Za druge instance, nalog se moÅ¾e pronaÄ‡i enumeracijom svih naloga kojima su dodeljene privilegije replikacije direktorijuma na objektu domene.


### Potpuni napad <a href="#the-full-attack" id="the-full-attack"></a>

Pogledajte originalni post: [https://dirkjanm.io/obtaining-domain-admin-from-
