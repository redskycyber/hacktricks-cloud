# Az - Bulut Kerberos GÃ¼veni

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter'da** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

**Bu yazÄ±, saldÄ±rÄ± hakkÄ±nda daha fazla bilgi iÃ§in kontrol edilebilecek olan** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **adresinin Ã¶zeti niteliÄŸindedir. Bu teknik ayrÄ±ca** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**'de de yorumlanmÄ±ÅŸtÄ±r.**

## Temel Bilgiler

### GÃ¼ven

Azure AD ile bir gÃ¼ven iliÅŸkisi kurulduÄŸunda, AD'de bir **Salt Okunur Etki AlanÄ± Denetleyicisi (RODC) oluÅŸturulur.** RODC bilgisayar hesabÄ±, **`AzureADKerberos$`** adÄ±nda olur. AyrÄ±ca, ikincil bir `krbtgt` hesabÄ± olan **`krbtgt_AzureAD`** adÄ±nda bir hesap oluÅŸturulur. Bu hesap, Azure AD'nin oluÅŸturduÄŸu biletler iÃ§in kullanÄ±lan **Kerberos anahtarlarÄ±nÄ±** iÃ§erir.

Bu nedenle, bu hesap ele geÃ§irilirse herhangi bir kullanÄ±cÄ±yÄ± taklit etmek mÃ¼mkÃ¼n olabilir... ancak bu doÄŸru deÄŸildir Ã§Ã¼nkÃ¼ bu hesap, EriÅŸim Denetleyicileri, Kurumsal YÃ¶neticiler, YÃ¶neticiler gibi yaygÄ±n ayrÄ±calÄ±klÄ± AD grubu iÃ§in bilet oluÅŸturmasÄ±nÄ± engellenmiÅŸtir...

{% hint style="danger" %}
Ancak, gerÃ§ek bir senaryoda bu gruplarda olmayan ayrÄ±calÄ±klÄ± kullanÄ±cÄ±lar olacaktÄ±r. Bu nedenle, **yeni krbtgt hesabÄ±, ele geÃ§irildiÄŸinde onlarÄ± taklit etmek iÃ§in kullanÄ±labilir.**
{% endhint %}

### Kerberos TGT

AyrÄ±ca, bir kullanÄ±cÄ± bir hibrit kimlik kullanarak Windows Ã¼zerinde kimlik doÄŸruladÄ±ÄŸÄ±nda, **Azure AD**, PRT ile birlikte **kÄ±smi Kerberos bilet**i oluÅŸturur. TGT, AzureAD'nin yerindeki AD hakkÄ±nda **sÄ±nÄ±rlÄ± bilgiye** sahip olduÄŸu iÃ§in kÄ±smidir (gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ± (SID) ve ad gibi).\
Windows, bu kÄ±smi TGT'yi, `krbtgt` hizmeti iÃ§in bir hizmet biletiÄŸi isteyerek **tam bir TGT ile deÄŸiÅŸtirebilir**.&#x20;

### NTLM

Kerberos kimlik doÄŸrulamasÄ±nÄ± desteklemeyen hizmetler olabileceÄŸinden, istekte **`KERB-KEY-LIST-REQ`** alanÄ±nÄ± iÃ§eren ikincil bir `krbtgt` anahtarÄ±yla imzalanmÄ±ÅŸ **kÄ±smi bir TGT** talep etmek ve ardÄ±ndan yanÄ±tta **NT karma deÄŸerini iÃ§eren bir tam TGT** almak mÃ¼mkÃ¼ndÃ¼r.

## Bulut Kerberos GÃ¼venini KÃ¶tÃ¼ye Kullanarak Etki AlanÄ± YÃ¶neticisi Elde Etme <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureAD, **kÄ±smi bir TGT** oluÅŸturduÄŸunda, kullanÄ±cÄ± hakkÄ±nda sahip olduÄŸu ayrÄ±ntÄ±larÄ± kullanÄ±r. Bu nedenle, bir Global YÃ¶netici, AzureAD'deki kullanÄ±cÄ±nÄ±n **gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ±nÄ± ve adÄ±nÄ± deÄŸiÅŸtirebilirse**, o kullanÄ±cÄ± iÃ§in bir TGT istendiÄŸinde **gÃ¼venlik tanÄ±mlayÄ±cÄ±sÄ± farklÄ± olacaktÄ±r**.

Bu, Microsoft Graph veya Azure AD Graph aracÄ±lÄ±ÄŸÄ±yla yapÄ±lamaz, ancak Global YÃ¶neticiler tarafÄ±ndan kullanÄ±labilen **API Active Directory Connect** kullanarak senkronize edilen kullanÄ±cÄ±larÄ± oluÅŸturmak ve gÃ¼ncellemek iÃ§in kullanÄ±labilir ve bu ÅŸekilde kimlik doÄŸrulama yaparsak, deÄŸiÅŸtirilmiÅŸ SID iÃ§eren bir kÄ±smi TGT alÄ±rÄ±z.

AADInternals ile bunu yapabilir ve senkronize edilen kullanÄ±cÄ±larÄ± [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet'i aracÄ±lÄ±ÄŸÄ±yla gÃ¼ncelleyebiliriz.

### SaldÄ±rÄ± Ã¶nkoÅŸullarÄ± <a href="#attack-prerequisites" id="attack-prerequisites"></a>

SaldÄ±rÄ±nÄ±n baÅŸarÄ±sÄ± ve Etki AlanÄ± YÃ¶neticisi ayrÄ±calÄ±klarÄ±nÄ±n elde edilmesi, belirli Ã¶nkoÅŸullarÄ±n karÅŸÄ±lanmasÄ±na baÄŸlÄ±dÄ±r:

* HesaplarÄ± Synchronization API aracÄ±lÄ±ÄŸÄ±yla deÄŸiÅŸtirebilme yeteneÄŸi Ã¶nemlidir. Bu, Global YÃ¶netici rolÃ¼ne sahip olmak veya bir AD Connect senkronizasyon hesabÄ±na sahip olmakla elde edilebilir. Alternatif olarak, Hibrit Kimlik YÃ¶neticisi rolÃ¼ yeterli olacaktÄ±r, Ã§Ã¼nkÃ¼ AD Connect'i yÃ¶netme ve yeni senkronizasyon hesaplarÄ± oluÅŸturma yeteneÄŸi saÄŸlar.
* Bir **hibrit hesabÄ±n** varlÄ±ÄŸÄ± Ã¶nemlidir. Bu hesap, kurban hesabÄ±nÄ±n ayrÄ±ntÄ±larÄ±yla deÄŸiÅŸtirilebilir olmalÄ± ve kimlik doÄŸrulamasÄ± iÃ§in eriÅŸilebilir olmalÄ±dÄ±r.
* Active Directory iÃ§inde bir **hedef kurban hesabÄ±nÄ±n** belirlenmesi gerekmektedir. SaldÄ±rÄ± herhangi bir senkronize edilmiÅŸ hesap Ã¼zerinde gerÃ§ekleÅŸtirilebilir olsa da, Azure AD kiracÄ±nÄ±n yerindeki gÃ¼venlik tanÄ±mlayÄ±cÄ±larÄ±nÄ±n Ã§oÄŸaltÄ±lmamasÄ± gerektiÄŸinden senkronize edilmemiÅŸ bir hesabÄ±n deÄŸiÅŸtirilmesi gerekmektedir.
* AyrÄ±ca, bu hesap, etkisiz TGT'lerin AzureAD RODC tarafÄ±ndan oluÅŸturulmasÄ±nÄ± Ã¶nlemek iÃ§in tipik AD yÃ¶netici gruplarÄ±nÄ±n Ã¼yesi olmamalÄ±dÄ±r, ancak etki alanÄ± yÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahip olmalÄ±dÄ±r.
* En uygun hedef, AD Connect Sync hizmeti tarafÄ±ndan kullanÄ±lan **Active Directory hesabÄ±dÄ±r**. Bu hesap Azure AD ile senkronize edilmez, bu nedenle SID'si hedeflenebilir durumdadÄ±r ve ÅŸifre karma deÄŸerlerini senkronize etme rolÃ¼ nedeniyle doÄŸal olarak Etki AlanÄ± YÃ¶neticisi eÅŸdeÄŸer ayrÄ±calÄ±klara sahiptir (Åifre Karma Senkronizasyonu etkinse). Express kurulumlu alanlar iÃ§in bu hesap **MSOL\_** ile baÅŸlar. DiÄŸer durumlar iÃ§in, etki alanÄ± nesnesindeki Veri Ã‡oÄŸaltma ayrÄ±calÄ±klar
