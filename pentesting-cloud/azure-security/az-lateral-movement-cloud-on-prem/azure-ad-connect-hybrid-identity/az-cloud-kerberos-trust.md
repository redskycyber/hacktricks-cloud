# Az - Cloud Kerberos Trust

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**Ten post jest podsumowaniem** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/), **kt贸ry mo偶na sprawdzi, aby uzyska wicej informacji na temat ataku. Ta technika jest r贸wnie偶 om贸wiona w** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Podstawowe informacje

### Zaufanie

Gdy nawizywane jest zaufanie z Azure AD, w AD tworzony jest **Read Only Domain Controller (RODC)**. Konto komputera **RODC** nosi nazw **`AzureADKerberos$`**. Dodatkowo, tworzone jest drugie konto `krbtgt` o nazwie **`krbtgt_AzureAD`**. To konto zawiera **klucze Kerberos** u偶ywane do tworzenia bilet贸w, kt贸re tworzy Azure AD.

Dlatego, jeli to konto zostanie skompromitowane, mo偶liwe bdzie podszywanie si pod dowolnego u偶ytkownika... cho nie jest to prawd, poniewa偶 to konto jest zabezpieczone przed tworzeniem bilet贸w dla jakiejkolwiek zwykej uprzywilejowanej grupy AD, takiej jak Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Jednak w rzeczywistym scenariuszu bd istnie uprzywilejowani u偶ytkownicy, kt贸rzy nie nale偶 do tych grup. Dlatego **nowe konto krbtgt, jeli zostanie skompromitowane, mo偶e by u偶ywane do podszywania si pod nich**.
{% endhint %}

### Kerberos TGT

Ponadto, gdy u偶ytkownik uwierzytelnia si w systemie Windows przy u偶yciu hybrydowego to偶samoci **Azure AD**, Azure AD wydaje **czciowy bilet Kerberos wraz z PRT**. TGT jest czciowy, poniewa偶 **AzureAD ma ograniczone informacje** o u偶ytkowniku w lokalnym AD (takie jak identyfikator zabezpiecze (SID) i nazwa).\
System Windows mo偶e nastpnie **wymieni ten czciowy TGT na peny TGT**, 偶dajc biletu usugi dla usugi `krbtgt`.&#x20;

### NTLM

Poniewa偶 mog istnie usugi, kt贸re nie obsuguj uwierzytelniania Kerberos, ale NTLM, mo偶liwe jest 偶danie **czciowego TGT podpisanego przy u偶yciu drugiego klucza `krbtgt`**, zawierajcego pole **`KERB-KEY-LIST-REQ`** w czci **PADATA** 偶dania, a nastpnie uzyskanie penego TGT podpisanego przy u偶yciu g贸wnego klucza `krbtgt`, **zawierajcego skr贸t NT w odpowiedzi**.

## Wykorzystanie zaufania Cloud Kerberos do uzyskania uprawnie Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Gdy AzureAD generuje **czciowy TGT**, u偶ywa informacji, kt贸re posiada o u偶ytkowniku. Dlatego, jeli Global Admin mo偶e zmodyfikowa dane takie jak **identyfikator zabezpiecze i nazwa u偶ytkownika w AzureAD**, podczas 偶dania TGT dla tego u偶ytkownika **identyfikator zabezpiecze bdzie inny**.

Nie jest to mo偶liwe za pomoc Microsoft Graph ani Azure AD Graph, ale mo偶na to zrobi za pomoc **API Active Directory Connect**, kt贸re u偶ywa Global Admins do tworzenia i aktualizowania zsynchronizowanych u偶ytkownik贸w, co pozwala na **modyfikacj nazwy SAM i SID dowolnego hybrydowego u偶ytkownika**, a nastpnie, jeli uwierzytelnimy si, otrzymamy czciowy TGT zawierajcy zmodyfikowany SID.

Nale偶y zauwa偶y, 偶e mo偶na to zrobi za pomoc narzdzia AADInternals i aktualizacji zsynchronizowanych u偶ytkownik贸w za pomoc polecenia [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Wymagania wstpne ataku <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Sukces ataku i uzyskanie uprawnie Domain Admin zale偶y od spenienia pewnych wymaga wstpnych:

* Kluczowe jest posiadanie mo偶liwoci modyfikacji kont za pomoc interfejsu API synchronizacji. Mo偶na to osign, posiadajc rol Global Admin lub posiadajc konto synchronizacji AD Connect. Alternatywnie, wystarczy mie rol Hybrid Identity Administrator, kt贸ra umo偶liwia zarzdzanie AD Connect i tworzenie nowych kont synchronizacji.
* Istotne jest posiadanie **konta hybrydowego**. To konto musi by podatne na modyfikacj z wykorzystaniem danych konta ofiary i powinno by r贸wnie偶 dostpne do uwierzytelniania.
* Konieczne jest zidentyfikowanie **docelowego konta ofiary** w Active Directory. Chocia偶 atak mo偶na przeprowadzi na dowolnym ju偶 zsynchronizowanym koncie, dzier偶awca Azure AD nie mo偶e mie zreplikowanych identyfikator贸w zabezpiecze z lokalnego AD, co wymaga modyfikacji niesynchronizowanego konta w celu uzyskania biletu.
* Ponadto, to konto powinno posiada uprawnienia r贸wnowa偶ne uprawnieniom Domain Admin, ale nie powinno by czonkiem typowych grup administrator贸w AD, aby unikn generowania nieprawidowych TGT przez AzureAD RODC.
* Najodpowiedniejszym celem jest **konto Active Directory u偶ywane przez usug synchronizacji AD Connect**. To konto nie jest synchronizowane z Azure AD, co czyni jego SID celowym, a samo konto posiada uprawnienia r贸wnowa偶ne uprawnieniom Domain Admin ze wzgldu na swoj rol w synchronizacji skr贸t贸w hase (o ile aktywna jest synchronizacja skr贸t贸w hase). Dla domen z instalacj express, to konto ma prefiks **MSOL\_**. W innych przypadkach, konto mo偶na zlokalizowa, wyliczajc wszystkie konta posiadajce uprawnienia replikacji katalogowej dla obiektu domeny.


### Peny atak <a href="#the-full-attack" id="the-full-attack"></
