# Az - PTA - é€ä¼ èº«ä»½éªŒè¯

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directoryï¼ˆAzure ADï¼‰é€ä¼ èº«ä»½éªŒè¯å…è®¸æ‚¨çš„ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„å¯†ç **ç™»å½•åˆ°æœ¬åœ°å’ŒåŸºäºäº‘çš„åº”ç”¨ç¨‹åº**ã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒ - å‡å°‘äº†éœ€è¦è®°ä½çš„å¯†ç æ•°é‡ï¼Œå¹¶é™ä½äº†ITå¸®åŠ©å°æˆæœ¬ï¼Œå› ä¸ºç”¨æˆ·æ›´ä¸å¤ªå¯èƒ½å¿˜è®°å¦‚ä½•ç™»å½•ã€‚å½“ç”¨æˆ·ä½¿ç”¨Azure ADç™»å½•æ—¶ï¼Œæ­¤åŠŸèƒ½**ç›´æ¥éªŒè¯ç”¨æˆ·çš„å¯†ç **ä¸æ‚¨çš„æœ¬åœ°Active Directoryã€‚

åœ¨PTAä¸­ï¼Œ**èº«ä»½**æ˜¯**åŒæ­¥çš„**ï¼Œä½†**å¯†ç **ä¸åƒåœ¨PHSä¸­é‚£æ ·ã€‚

è®¤è¯åœ¨æœ¬åœ°ADä¸­éªŒè¯ï¼Œä¸äº‘çš„é€šä¿¡ç”±åœ¨**æœ¬åœ°æœåŠ¡å™¨**ä¸Šè¿è¡Œçš„**è®¤è¯ä»£ç†**ï¼ˆä¸éœ€è¦åœ¨æœ¬åœ°DCä¸Šï¼‰å®Œæˆã€‚

### è®¤è¯æµç¨‹

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. ç”¨æˆ·è¢«é‡å®šå‘åˆ°**Azure AD**ä»¥è¿›è¡Œ**ç™»å½•**ï¼Œåœ¨é‚£é‡Œä»–å‘é€**ç”¨æˆ·å**å’Œ**å¯†ç **
2. **å‡­æ®**è¢«**åŠ å¯†**å¹¶è®¾ç½®åœ¨Azure ADä¸­çš„**é˜Ÿåˆ—**ä¸­
3. **æœ¬åœ°è®¤è¯ä»£ç†**ä»é˜Ÿåˆ—ä¸­æ”¶é›†**å‡­æ®**å¹¶å¯¹å…¶è¿›è¡Œ**è§£å¯†**ã€‚æ­¤ä»£ç†ç§°ä¸º**â€œé€ä¼ èº«ä»½éªŒè¯ä»£ç†â€**æˆ–**PTAä»£ç†**ã€‚
4. **ä»£ç†**å°†å‡­æ®ä¸**æœ¬åœ°AD**è¿›è¡ŒéªŒè¯ï¼Œå¹¶å°†**å“åº”**å‘é€å›Azure ADï¼Œå¦‚æœå“åº”æ˜¯ç§¯æçš„ï¼Œåˆ™**å®Œæˆç”¨æˆ·çš„ç™»å½•**ã€‚

{% hint style="warning" %}
å¦‚æœæ”»å‡»è€…**å…¥ä¾µ**äº†**PTA**ï¼Œä»–å¯ä»¥**æŸ¥çœ‹**é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰**å‡­æ®**ï¼ˆä»¥**æ˜æ–‡**å½¢å¼ï¼‰ã€‚\
ä»–è¿˜å¯ä»¥å°†ä»»ä½•å‡­æ®**éªŒè¯**åˆ°AzureADï¼ˆç±»ä¼¼äºSkeleton keyçš„æ”»å‡»ï¼‰ã€‚
{% endhint %}

### æœ¬åœ° -> äº‘

å¦‚æœæ‚¨å…·æœ‰åœ¨è¿è¡Œ**PTAä»£ç†**çš„**Azure AD ConnectæœåŠ¡å™¨**ä¸Šçš„**ç®¡ç†å‘˜**è®¿é—®æƒé™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**AADInternals**æ¨¡å—**æ’å…¥åé—¨**ï¼Œå°†**éªŒè¯æ‰€æœ‰è¾“å…¥çš„å¯†ç **ï¼ˆå› æ­¤æ‰€æœ‰å¯†ç éƒ½å°†æœ‰æ•ˆè¿›è¡Œèº«ä»½éªŒè¯ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
å¦‚æœ**å®‰è£…å¤±è´¥**ï¼Œå¯èƒ½æ˜¯ç”±äºç¼ºå°‘[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)ã€‚

è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ cmdlet åœ¨å…ˆå‰å®‰è£…äº†åé—¨çš„è®¡ç®—æœºä¸Š**æŸ¥çœ‹å‘é€åˆ° PTA ä»£ç†çš„æ˜æ–‡å¯†ç **ï¼š 
{% endhint %}
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
è¿™ä¸ªåé—¨å°†ä¼šï¼š

* åˆ›å»ºä¸€ä¸ªéšè—æ–‡ä»¶å¤¹ `C:\PTASpy`
* å°† `PTASpy.dll` å¤åˆ¶åˆ° `C:\PTASpy`
* å°† `PTASpy.dll` æ³¨å…¥åˆ° `AzureADConnectAuthenticationAgentService` è¿›ç¨‹ä¸­

{% hint style="info" %}
å½“ AzureADConnectAuthenticationAgent æœåŠ¡é‡æ–°å¯åŠ¨æ—¶ï¼ŒPTASpy å°†è¢«â€œå¸è½½â€ï¼Œå¿…é¡»é‡æ–°å®‰è£…ã€‚
{% endhint %}

### äº‘ -> æœ¬åœ°

{% hint style="danger" %}
åœ¨äº‘ç«¯è·å¾— **GA ç‰¹æƒ** åï¼Œå¯ä»¥é€šè¿‡åœ¨ **æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨** ä¸Šè®¾ç½®ä¸€ä¸ªæ–°çš„ **PTA ä»£ç†** æ¥ **æ³¨å†Œ**ã€‚ä¸€æ—¦ä»£ç† **è®¾ç½®å®Œæˆ**ï¼Œæˆ‘ä»¬å¯ä»¥ **é‡å¤** **ä¹‹å‰çš„** æ­¥éª¤æ¥ **ä½¿ç”¨ä»»ä½•å¯†ç è¿›è¡Œèº«ä»½éªŒè¯**ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ **ä»¥æ˜æ–‡å½¢å¼è·å–å¯†ç **ã€‚
{% endhint %}

### æ— ç¼ SSO

å¯ä»¥ä½¿ç”¨æ— ç¼ SSO ä¸ PTAï¼Œè¿™å¯¹å…¶ä»–æ»¥ç”¨è¡Œä¸ºæ˜¯æœ‰æ¼æ´çš„ã€‚åœ¨ä»¥ä¸‹ä½ç½®æ£€æŸ¥ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„ **å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥ **åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
