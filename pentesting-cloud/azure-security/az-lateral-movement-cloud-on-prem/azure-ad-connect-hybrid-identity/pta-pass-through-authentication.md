# Az - PTA - Autoryzacja przekazywana

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Autoryzacja przekazywana Azure Active Directory (Azure AD) umoÅ¼liwia Twoim uÅ¼ytkownikom **logowanie siÄ™ zarÃ³wno do aplikacji lokalnych, jak i opartych na chmurze, za pomocÄ… tych samych haseÅ‚**. Ta funkcja zapewnia Twoim uÅ¼ytkownikom lepsze doÅ›wiadczenie - jedno hasÅ‚o mniej do zapamiÄ™tania i zmniejsza koszty pomocy technicznej IT, poniewaÅ¼ uÅ¼ytkownicy sÄ… mniej skÅ‚onni do zapomnienia, jak siÄ™ zalogowaÄ‡. Gdy uÅ¼ytkownicy logujÄ… siÄ™ za pomocÄ… Azure AD, ta funkcja **sprawdza hasÅ‚a uÅ¼ytkownikÃ³w bezpoÅ›rednio w Twoim lokalnym Active Directory**.

W PTA **toÅ¼samoÅ›ci** sÄ… **synchronizowane**, ale **hasÅ‚a** **nie sÄ…**, tak jak w PHS.

Autoryzacja jest sprawdzana w lokalnym AD, a komunikacja z chmurÄ… odbywa siÄ™ za pomocÄ… **agenta autoryzacji** dziaÅ‚ajÄ…cego na serwerze lokalnym (nie musi byÄ‡ na lokalnym DC).

### Przebieg autoryzacji

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Aby **zalogowaÄ‡ siÄ™**, uÅ¼ytkownik zostaje przekierowany do **Azure AD**, gdzie wysyÅ‚a **nazwÄ™ uÅ¼ytkownika** i **hasÅ‚o**.
2. **PoÅ›wiadczenia** sÄ… **szyfrowane** i umieszczane w **kolejce** w Azure AD.
3. **Agent autoryzacji lokalnej** pobiera **poÅ›wiadczenia** z kolejki i **odszyfrowuje** je. Ten agent nazywany jest **"Agentem autoryzacji przekazywanej"** lub **agentem PTA**.
4. **Agent** **sprawdza** poÅ›wiadczenia w **lokalnym AD** i wysyÅ‚a **odpowiedÅº** z powrotem do Azure AD, ktÃ³re, jeÅ›li odpowiedÅº jest pozytywna, **zakoÅ„cza logowanie** uÅ¼ytkownika.

{% hint style="warning" %}
JeÅ›li atakujÄ…cy **przejmuje kontrolÄ™** nad **PTA**, moÅ¼e **zobaczyÄ‡** wszystkie **poÅ›wiadczenia** z kolejki (w **czystym tekÅ›cie**).\
MoÅ¼e rÃ³wnieÅ¼ **sprawdziÄ‡ dowolne poÅ›wiadczenia** w AzureAD (podobny atak do klucza szkieletowego).
{% endhint %}

### Lokalny -> chmura

JeÅ›li masz **dostÄ™p admina** do **serwera Azure AD Connect** z uruchomionym **agentem PTA**, moÅ¼esz uÅ¼yÄ‡ moduÅ‚u **AADInternals**, aby **wstawiÄ‡ tylnÄ… furtkÄ™**, ktÃ³ra **sprawdzi WSZYSTKIE hasÅ‚a** wprowadzone (wiÄ™c wszystkie hasÅ‚a bÄ™dÄ… waÅ¼ne do autoryzacji):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
JeÅ›li **instalacja nie powiedzie siÄ™**, prawdopodobnie jest to spowodowane brakiem [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

MoÅ¼liwe jest rÃ³wnieÅ¼ **zobaczenie haseÅ‚ w czystym tekÅ›cie wysyÅ‚anych do agenta PTA** za pomocÄ… nastÄ™pujÄ…cego polecenia na maszynie, na ktÃ³rej zostaÅ‚ zainstalowany poprzedni backdoor:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ta tylna furtka bÄ™dzie:

* TworzyÄ‡ ukryty folder `C:\PTASpy`
* KopiowaÄ‡ `PTASpy.dll` do `C:\PTASpy`
* WstrzykiwaÄ‡ `PTASpy.dll` do procesu `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Po ponownym uruchomieniu usÅ‚ugi AzureADConnectAuthenticationAgent, PTASpy jest "odÅ‚adowywany" i musi zostaÄ‡ ponownie zainstalowany.
{% endhint %}

### Chmura -> On-Prem

{% hint style="danger" %}
Po uzyskaniu **uprawnieÅ„ GA** w chmurze, moÅ¼liwe jest **zarejestrowanie nowego agenta PTA**, ustawiajÄ…c go na **maszynie kontrolowanej przez atakujÄ…cego**. Po **skonfigurowaniu** agenta moÅ¼emy **powtÃ³rzyÄ‡** **poprzednie** kroki, aby **uwierzytelniÄ‡ siÄ™, uÅ¼ywajÄ…c dowolnego hasÅ‚a** i rÃ³wnieÅ¼ **otrzymaÄ‡ hasÅ‚a w postaci tekstu jawnego**.
{% endhint %}

### Bezszwowe SSO

MoÅ¼liwe jest uÅ¼ycie Bezszwowego SSO z PTA, co jest podatne na inne naduÅ¼ycia. SprawdÅº to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## OdwoÅ‚ania

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
