# Az - PTA - Proslje캠ivanje autentifikacije

<details>

<summary><strong>Nau캜ite hakiranje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite vidjeti **ogla코avanje va코e kompanije u HackTricks-u** ili **preuzeti HackTricks u PDF formatu** Provjerite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podijelite svoje hakiraju캖e trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Proslje캠ivanje autentifikacije omogu캖ava va코im korisnicima da se **prijave na lokalne i cloud aplikacije koriste캖i iste lozinke**. Ova funkcionalnost pru쬬 korisnicima bolje iskustvo - jednu manje lozinku koju treba zapamtiti, i smanjuje tro코kove IT helpdeska jer je manja vjerovatno캖a da 캖e korisnici zaboraviti kako se prijaviti. Kada korisnici se prijave koriste캖i Azure AD, ova funkcionalnost **validira korisni캜ke lozinke direktno protiv lokalnog Active Directory-ja**.

U PTA **identiteti** su **sinhronizovani** ali **lozinke** **nisu** kao kod PHS.

Autentifikacija se validira u lokalnom AD-u, a komunikacija sa cloud-om se vr코i putem **agent za autentifikaciju** koji se izvr코ava na **lokalnom serveru** (ne mora biti na lokalnom DC-u).

### Tok autentifikacije

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Da bi se **prijavio**, korisnik je preusmjeren na **Azure AD**, gdje 코alje **korisni캜ko ime** i **lozinku**
2. **Pristupni podaci** su **enkriptovani** i postavljeni u **red** u Azure AD-u
3. **Agent za autentifikaciju na lokalnom serveru** prikuplja **pristupne podatke** iz reda i **dekriptuje** ih. Ovaj agent se naziva **"Pass-through authentication agent"** ili **PTA agent**.
4. **Agent** **validira** pristupne podatke protiv lokalnog AD-a i 코alje **odgovor** **nazad** Azure AD-u koji, ako je odgovor pozitivan, **zavr코ava prijavu** korisnika.

{% hint style="warning" %}
Ako napada캜 **kompromituje** **PTA**, mo쬰 **vidjeti** sve **pristupne podatke** iz reda (u **캜istom tekstu**).\
Tako캠e mo쬰 **validirati bilo koje pristupne podatke** prema AzureAD-u (sli캜an napad kao Skeleton key).
{% endhint %}

### Lokalno -> cloud

Ako imate **admin** pristup **Azure AD Connect serveru** sa pokrenutim **PTA** **agentom**, mo쬰te koristiti modul **AADInternals** da **ubacite tajni ulaz** koji 캖e **validirati SVE lozinke** unesene (tako da 캖e sve lozinke biti validne za autentifikaciju):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ako **instalacija ne uspe**, verovatno je zbog nedostaju캖ih [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Tako캠e je mogu캖e **videti lozinke u 캜istom tekstu koje su poslate PTA agentu** koriste캖i slede캖u cmdlet komandu na ma코ini gde je prethodna zadnja vrata instalirana:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ova zadnja vrata 캖e:

* Kreirati skriveni folder `C:\PTASpy`
* Kopirati `PTASpy.dll` u `C:\PTASpy`
* Umetnuti `PTASpy.dll` u proces `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Kada se ponovno pokrene AzureADConnectAuthenticationAgent servis, PTASpy se "isklju캜uje" i mora biti ponovno instaliran.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nakon sticanja **GA privilegija** na cloud-u, mogu캖e je **registrovati novi PTA agent** postavljanjem na **napada캜evu kontrolisanu ma코inu**. Kada je agent **postavljen**, mo쬰mo **ponoviti** **prethodne** korake da bismo se **autentifikovali koriste캖i bilo koju lozinku** i tako캠e, **dobili lozinke u 캜istom tekstu**.
{% endhint %}

### Seamless SSO

Mogu캖e je koristiti Seamless SSO sa PTA, 코to je ranjivo na druge zloupotrebe. Proverite to u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
