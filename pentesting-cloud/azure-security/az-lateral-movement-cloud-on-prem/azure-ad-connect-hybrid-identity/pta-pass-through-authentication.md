# PTA - Autenticaci贸n de paso

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci贸n b谩sica

La autenticaci贸n de paso de Azure Active Directory (Azure AD) permite a tus usuarios **iniciar sesi贸n en aplicaciones tanto locales como basadas en la nube utilizando las mismas contrase帽as**. Esta funci贸n proporciona a tus usuarios una mejor experiencia, ya que solo necesitan recordar una contrase帽a y reduce los costos del servicio de asistencia t茅cnica de TI, ya que es menos probable que los usuarios olviden c贸mo iniciar sesi贸n. Cuando los usuarios inician sesi贸n utilizando Azure AD, esta funci贸n **valida las contrase帽as de los usuarios directamente en tu Active Directory local**.

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

En PTA, las **identidades** se **sincronizan** pero las **contrase帽as** **no**, como en PHS.

La autenticaci贸n se valida en el AD local y la comunicaci贸n con la nube se realiza mediante un **agente de autenticaci贸n** que se ejecuta en un **servidor local** (no es necesario que est茅 en el controlador de dominio local).

### Flujo de autenticaci贸n

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Para **iniciar sesi贸n**, el usuario es redirigido a **Azure AD**, donde env铆a el **nombre de usuario** y la **contrase帽a**.
2. Las **credenciales** se **encriptan** y se almacenan en una **cola** en Azure AD.
3. El **agente de autenticaci贸n local** recopila las **credenciales** de la cola y las **descifra**. Este agente se llama **"Agente de autenticaci贸n de paso"** o **agente PTA**.
4. El **agente** **valida** las credenciales frente al **AD local** y env铆a la **respuesta** de vuelta a Azure AD, que, si la respuesta es positiva, **completa la sesi贸n** del usuario.

{% hint style="warning" %}
Si un atacante **compromete** el **PTA**, puede **ver** todas las **credenciales** de la cola (en **texto claro**).\
Tambi茅n puede **validar cualquier credencial** en AzureAD (ataque similar a la clave Skeleton).
{% endhint %}

### Local -> nube

Si tienes acceso de **administrador** al servidor **Azure AD Connect** con el **agente PTA** en ejecuci贸n, puedes usar el m贸dulo **AADInternals** para **insertar una puerta trasera** que **validar谩 TODAS las contrase帽as** introducidas (por lo que todas las contrase帽as ser谩n v谩lidas para la autenticaci贸n):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si la **instalaci贸n falla**, esto probablemente se debe a la falta de [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Tambi茅n es posible **ver las contrase帽as en texto claro enviadas al agente PTA** utilizando el siguiente cmdlet en la m谩quina donde se instal贸 la puerta trasera anteriormente:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Esta puerta trasera realizar谩 lo siguiente:

* Crear谩 una carpeta oculta `C:\PTASpy`
* Copiar谩 `PTASpy.dll` a `C:\PTASpy`
* Inyectar谩 `PTASpy.dll` en el proceso `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Cuando se reinicie el servicio AzureADConnectAuthenticationAgent, PTASpy se "descargar谩" y deber谩 ser reinstalado.
{% endhint %}

### Nube -> Local

{% hint style="danger" %}
Despu茅s de obtener privilegios de **GA** en la nube, es posible **registrar un nuevo agente PTA** configur谩ndolo en una **m谩quina controlada por el atacante**. Una vez que el agente est茅 **configurado**, podemos **repetir** los **pasos anteriores** para **autenticarnos usando cualquier contrase帽a** y tambi茅n **obtener las contrase帽as en texto claro**.
{% endhint %}

### SSO sin interrupciones

Es posible utilizar SSO sin interrupciones con PTA, lo cual es vulnerable a otros abusos. Verificar en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si deseas ver tu **empresa anunciada en HackTricks** o si deseas acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
