# Az - PTA - Provera autenti캜nosti prenosa

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodi캜u PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Provera autenti캜nosti prenosa (PTA) u Azure Active Directory (Azure AD) omogu캖ava va코im korisnicima da **se prijave na lokalne i cloud aplikacije koriste캖i iste lozinke**. Ova funkcija pru쬬 korisnicima bolje iskustvo - jedna manje lozinka koju treba zapamtiti, i smanjuje tro코kove IT podr코ke jer su korisnici manje verovatno da 캖e zaboraviti kako da se prijave. Kada korisnici se prijave koriste캖i Azure AD, ova funkcija **validira korisni캜ke lozinke direktno protiv va코eg lokalnog Active Directory-a**.

U PTA **identiteti** su **sinhronizovani** ali **lozinke** **nisu** kao u PHS.

Autentikacija se validira u lokalnom AD-u i komunikacija sa oblakom se vr코i preko **agent za autentikaciju** koji se izvr코ava na **lokalnom serveru** (ne mora biti na lokalnom DC).

### Tok autentikacije

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Da bi se **prijavio** korisnik je preusmeren na **Azure AD**, gde 코alje **korisni캜ko ime** i **lozinku**
2. **Poverljivi podaci** su **코ifrovani** i postavljeni u **red** u Azure AD
3. **Agent za autentikaciju na lokalnom serveru** prikuplja **poverljive podatke** iz reda i ih **de코ifruje**. Ovaj agent se naziva **"Agent za proveru autenti캜nosti prenosa"** ili **PTA agent.**
4. **Agent** **validira** podatke protiv **lokalnog AD-a** i 코alje **odgovor** **nazad** u Azure AD koji, ako je odgovor pozitivan, **zavr코ava prijavu** korisnika.

{% hint style="warning" %}
Ako napada캜 **kompromituje** **PTA** on mo쬰 **videti** sve **poverljive podatke** iz reda (u **캜istom tekstu**).\
Tako캠e mo쬰 **validirati bilo koje poverljive podatke** ka AzureAD (sli캜an napad kao Skeleton key).
{% endhint %}

### Lokalno -> oblak

Ako imate **admin** pristup **Azure AD Connect serveru** sa **PTA** **agentom** koji se izvr코ava, mo쬰te koristiti **AADInternals** modul da **ubacite tajnu vrata** koja 캖e **validirati SVE lozinke** unete (tako da 캖e sve lozinke biti validne za autentikaciju):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ako **instalacija ne uspe**, verovatno je to zbog nedostaju캖ih [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Tako캠e je mogu캖e **videti lozinke u 캜istom tekstu koje su poslate agentu PTA** kori코캖enjem slede캖eg cmdlet-a na ma코ini gde je prethodna tajna vrata instalirana:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ova vrata 캖e:

* Napraviti skriveni folder `C:\PTASpy`
* Kopirati `PTASpy.dll` u `C:\PTASpy`
* Ubaciti `PTASpy.dll` u proces `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Kada se usluga AzureADConnectAuthenticationAgent ponovo pokrene, PTASpy se "isklju캜uje" i mora ponovo biti instaliran.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nakon sticanja **GA privilegija** u oblaku, mogu캖e je **registrovati novog PTA agenta** postavljaju캖i ga na **ma코inu kojom upravlja napada캜**. Kada je agent **postavljen**, mo쬰mo **ponoviti** **prethodne** korake da bismo se **autentifikovali koriste캖i bilo koju lozinku** i tako캠e, **dobili lozinke u 캜istom tekstu**.
{% endhint %}

### Seamless SSO

Mogu캖e je koristiti Seamless SSO sa PTA, 코to je ranjivo na druge zloupotrebe. Proverite u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
