# Az - PTA - Pass-through Authentication

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimizden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

[DokÃ¼mantasyondan alÄ±nan bilgilere gÃ¶re:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication, kullanÄ±cÄ±larÄ±nÄ±zÄ±n **aynÄ± ÅŸifreleri kullanarak hem yerel hem de bulut tabanlÄ± uygulamalara giriÅŸ yapmasÄ±na olanak tanÄ±r**. Bu Ã¶zellik, kullanÄ±cÄ±larÄ±nÄ±za daha iyi bir deneyim sunar - hatÄ±rlanmasÄ± gereken bir ÅŸifre daha az olduÄŸu iÃ§in ve kullanÄ±cÄ±larÄ±nÄ±zÄ±n giriÅŸ yapmayÄ± unutma olasÄ±lÄ±ÄŸÄ± daha dÃ¼ÅŸÃ¼k olduÄŸu iÃ§in IT yardÄ±m masasÄ± maliyetlerini azaltÄ±r. KullanÄ±cÄ±lar Azure AD kullanarak giriÅŸ yaptÄ±ÄŸÄ±nda, bu Ã¶zellik kullanÄ±cÄ±larÄ±n ÅŸifrelerini doÄŸrudan yerel Active Directory'nizde doÄŸrular.

PTA'da **kimlikler** senkronize edilirken **ÅŸifreler** senkronize edilmez, PHS'deki gibi.

Kimlik doÄŸrulama, yerel AD'de doÄŸrulanÄ±r ve bulutla iletiÅŸim, bir **kimlik doÄŸrulama ajanÄ±** tarafÄ±ndan gerÃ§ekleÅŸtirilir ve bu ajan bir **yerel sunucuda** Ã§alÄ±ÅŸÄ±r (yerel DC'de olmasÄ± gerekmez).

### Kimlik doÄŸrulama akÄ±ÅŸÄ±

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. **KullanÄ±cÄ± giriÅŸ yapmak** iÃ§in Azure AD'ye yÃ¶nlendirilir, burada **kullanÄ±cÄ± adÄ±** ve **ÅŸifre** gÃ¶nderir.
2. **Kimlik bilgileri**, Azure AD'deki bir **kuyruÄŸa** **ÅŸifrelenmiÅŸ** olarak yerleÅŸtirilir.
3. **Yerel kimlik doÄŸrulama ajanÄ±**, kuyruktan **kimlik bilgilerini** toplar ve **ÅŸifreleri** **ÅŸifre Ã§Ã¶zer**. Bu ajan **"Pass-through authentication agent"** veya **PTA ajanÄ±** olarak adlandÄ±rÄ±lÄ±r.
4. **Ajan**, kimlik bilgilerini **yerel AD'ye** karÅŸÄ± doÄŸrular ve yanÄ±tÄ± Azure AD'ye gÃ¶nderir. EÄŸer yanÄ±t olumlu ise, Azure AD kullanÄ±cÄ±nÄ±n giriÅŸini **tamamlar**.

{% hint style="warning" %}
Bir saldÄ±rgan, **PTA'yÄ±** ele geÃ§irirse, kuyruktaki tÃ¼m **kimlik bilgilerini** (aÃ§Ä±k metin olarak) **gÃ¶rebilir**.\
AyrÄ±ca, AzureAD'ye herhangi bir kimlik bilgisini **doÄŸrulayabilir** (Skeleton key saldÄ±rÄ±sÄ±na benzer bir saldÄ±rÄ±).
{% endhint %}

### Yerel -> bulut

EÄŸer **PTA ajanÄ±** Ã§alÄ±ÅŸan **Azure AD Connect sunucusuna** **yÃ¶netici** eriÅŸiminiz varsa, **AADInternals** modÃ¼lÃ¼nÃ¼ kullanarak **geri kapÄ±** ekleyebilirsiniz. Bu geri kapÄ±, **girilen TÃœM ÅŸifreleri** doÄŸrulayacak ÅŸekilde Ã§alÄ±ÅŸÄ±r:
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
EÄŸer **kurulum baÅŸarÄ±sÄ±z olursa**, bunun muhtemelen [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe) eksikliÄŸinden kaynaklandÄ±ÄŸÄ±nÄ± belirtmek gerekir.
{% endhint %}

AyrÄ±ca, Ã¶nceki arka kapÄ±nÄ±n kurulduÄŸu makinede aÅŸaÄŸÄ±daki cmdlet kullanÄ±larak **PTA ajanÄ±na gÃ¶nderilen aÃ§Ä±k metin parolalarÄ± gÃ¶rÃ¼ntÃ¼lemek mÃ¼mkÃ¼ndÃ¼r**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Bu arka kapÄ± ÅŸunlarÄ± yapacak:

* Gizli bir `C:\PTASpy` klasÃ¶rÃ¼ oluÅŸturacak
* `PTASpy.dll` dosyasÄ±nÄ± `C:\PTASpy` klasÃ¶rÃ¼ne kopyalayacak
* `PTASpy.dll`'yi `AzureADConnectAuthenticationAgentService` iÅŸlemine enjekte edecek

{% hint style="info" %}
AzureADConnectAuthenticationAgent hizmeti yeniden baÅŸlatÄ±ldÄ±ÄŸÄ±nda, PTASpy "boÅŸaltÄ±lÄ±r" ve yeniden yÃ¼klenmesi gerekir.
{% endhint %}

### Bulut -> On-Prem

{% hint style="danger" %}
Bulutta **GA yetkilerine** sahip olduktan sonra, bir **saldÄ±rgan kontrolÃ¼ndeki makineye** bir **PTA ajanÄ± kaydederek** yeni bir PTA ajanÄ± **oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r**. Ajan **kurulduktan sonra**, Ã¶nceki adÄ±mlarÄ± **tekrarlayarak** herhangi bir ÅŸifre ile **kimlik doÄŸrulamasÄ± yapabilir** ve ayrÄ±ca **ÅŸifreleri aÃ§Ä±k metin olarak alabiliriz**.
{% endhint %}

### Sorunsuz SSO

PTA ile Sorunsuz SSO kullanmak mÃ¼mkÃ¼ndÃ¼r ve bu da diÄŸer kÃ¶tÃ¼ye kullanÄ±mlara aÃ§Ä±ktÄ±r. AÅŸaÄŸÄ±daki baÄŸlantÄ±da kontrol edebilirsiniz:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
