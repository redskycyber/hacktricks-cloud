# Az - PTA - Uwierzytelnianie przekazywane

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Uwierzytelnianie przekazywane w usÅ‚udze Azure Active Directory (Azure AD) pozwala Twoim uÅ¼ytkownikom **zalogowaÄ‡ siÄ™ do aplikacji zarÃ³wno lokalnych, jak i opartych na chmurze, uÅ¼ywajÄ…c tych samych haseÅ‚**. Ta funkcja zapewnia Twoim uÅ¼ytkownikom lepsze doÅ›wiadczenie - mniej haseÅ‚ do zapamiÄ™tania i zmniejsza koszty dziaÅ‚u pomocy technicznej IT, poniewaÅ¼ uÅ¼ytkownicy sÄ… mniej skÅ‚onni zapomnieÄ‡, jak siÄ™ zalogowaÄ‡. Gdy uÅ¼ytkownicy logujÄ… siÄ™ za pomocÄ… Azure AD, ta funkcja **sprawdza hasÅ‚a uÅ¼ytkownikÃ³w bezpoÅ›rednio w Twoim lokalnym katalogu Active Directory**.

W PTA **toÅ¼samoÅ›ci** sÄ… **synchronizowane**, ale **hasÅ‚a** **nie sÄ…**, jak w przypadku PHS.

Uwierzytelnianie jest weryfikowane w lokalnym AD, a komunikacja z chmurÄ… odbywa siÄ™ za pomocÄ… **agenta uwierzytelniania** dziaÅ‚ajÄ…cego na **serwerze lokalnym** (nie musi byÄ‡ to kontroler domeny lokalnej).

### PrzepÅ‚yw uwierzytelniania

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Aby **zalogowaÄ‡** uÅ¼ytkownika, jest on przekierowywany do **Azure AD**, gdzie wysyÅ‚a **nazwÄ™ uÅ¼ytkownika** i **hasÅ‚o**
2. **PoÅ›wiadczenia** sÄ… **szyfrowane** i umieszczone w **kolejce** w Azure AD
3. **Agent uwierzytelniania lokalnego** pobiera **poÅ›wiadczenia** z kolejki i je **deszyfruje**. Ten agent nazywa siÄ™ **"Agentem uwierzytelniania przekazywanego"** lub **agentem PTA.**
4. **Agent** **sprawdza** poÅ›wiadczenia w **lokalnym AD** i wysyÅ‚a **odpowiedÅº** **z powrotem** do Azure AD, ktÃ³re, jeÅ›li odpowiedÅº jest pozytywna, **zakoÅ„cza logowanie** uÅ¼ytkownika.

{% hint style="warning" %}
JeÅ›li atakujÄ…cy **przejmuje kontrolÄ™ nad** **PTA**, moÅ¼e **zobaczyÄ‡** wszystkie **poÅ›wiadczenia** z kolejki (w **czystym tekÅ›cie**).\
MoÅ¼e rÃ³wnieÅ¼ **zweryfikowaÄ‡ dowolne poÅ›wiadczenia** do AzureAD (podobny atak do klucza szkieletowego).
{% endhint %}

### Lokalnie -> chmura

JeÅ›li masz **dostÄ™p admina** do **serwera Azure AD Connect** z uruchomionym **agentem PTA**, moÅ¼esz uÅ¼yÄ‡ moduÅ‚u **AADInternals** do **wstawienia tylnych drzwi**, ktÃ³re bÄ™dÄ… **weryfikowaÄ‡ WSZYSTKIE hasÅ‚a** wprowadzone (wiÄ™c wszystkie hasÅ‚a bÄ™dÄ… waÅ¼ne do uwierzytelniania):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
JeÅ›li **instalacja zawiedzie**, prawdopodobnie jest to spowodowane brakiem [Rozdystrybuowalnych pakietÃ³w Microsoft Visual C++ 2015](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

MoÅ¼liwe jest rÃ³wnieÅ¼ **zobaczenie haseÅ‚ w tekÅ›cie jawnym wysyÅ‚anych do agenta PTA** za pomocÄ… nastÄ™pujÄ…cego polecenia cmdlet na maszynie, na ktÃ³rej zainstalowano poprzednie tylne drzwi:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
To backdoor bÄ™dzie:

* Utworzy ukryty folder `C:\PTASpy`
* Skopiuj `PTASpy.dll` do `C:\PTASpy`
* Wstrzyknie `PTASpy.dll` do procesu `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Po ponownym uruchomieniu usÅ‚ugi AzureADConnectAuthenticationAgent, PTASpy jest "odÅ‚Ä…czony" i musi zostaÄ‡ ponownie zainstalowany.
{% endhint %}

### Chmura -> Lokalnie

{% hint style="danger" %}
Po uzyskaniu **uprawnieÅ„ GA** w chmurze, moÅ¼liwe jest **zarejestrowanie nowego agenta PTA**, ustawiajÄ…c go na **maszynie kontrolowanej przez atakujÄ…cego**. Gdy agent jest **skonfigurowany**, moÅ¼emy **powtÃ³rzyÄ‡** **poprzednie** kroki, aby **uwierzytelniÄ‡ siÄ™, uÅ¼ywajÄ…c dowolnego hasÅ‚a** i rÃ³wnieÅ¼ **uzyskaÄ‡ hasÅ‚a w postaci czystego tekstu**.
{% endhint %}

### Bezproblemowe SSO

MoÅ¼liwe jest korzystanie z Bezproblemowego SSO z PTA, co jest podatne na inne naduÅ¼ycia. SprawdÅº to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## OdnoÅ›niki

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
