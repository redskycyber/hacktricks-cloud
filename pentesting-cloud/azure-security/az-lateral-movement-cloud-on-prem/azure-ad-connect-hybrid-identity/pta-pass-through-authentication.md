# PTA - é€ä¼ èº«ä»½éªŒè¯

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

Azure Active Directoryï¼ˆAzure ADï¼‰é€ä¼ èº«ä»½éªŒè¯å…è®¸ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„å¯†ç ç™»å½•æœ¬åœ°å’ŒåŸºäºäº‘çš„åº”ç”¨ç¨‹åºã€‚æ­¤åŠŸèƒ½ä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒ-åªéœ€è®°ä½ä¸€ä¸ªå¯†ç ï¼Œå¹¶å‡å°‘äº† IT å¸®åŠ©å°çš„æˆæœ¬ï¼Œå› ä¸ºç”¨æˆ·ä¸å¤ªå¯èƒ½å¿˜è®°å¦‚ä½•ç™»å½•ã€‚å½“ç”¨æˆ·ä½¿ç”¨ Azure AD ç™»å½•æ—¶ï¼Œæ­¤åŠŸèƒ½ä¼šç›´æ¥å¯¹ç”¨æˆ·çš„å¯†ç è¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯æ–¹å¼æ˜¯é’ˆå¯¹æœ¬åœ° Active Directory è¿›è¡ŒéªŒè¯ã€‚

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

åœ¨ PTA ä¸­ï¼Œèº«ä»½åŒæ­¥ï¼Œä½†å¯†ç ä¸åŒæ­¥ï¼Œä¸ PHS ä¸åŒã€‚

èº«ä»½éªŒè¯åœ¨æœ¬åœ° AD ä¸­è¿›è¡ŒéªŒè¯ï¼Œä¸äº‘ç«¯çš„é€šä¿¡ç”±åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šè¿è¡Œçš„èº«ä»½éªŒè¯ä»£ç†ï¼ˆä¸éœ€è¦åœ¨æœ¬åœ° DC ä¸Šè¿è¡Œï¼‰å®Œæˆã€‚

### èº«ä»½éªŒè¯æµç¨‹

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. ç”¨æˆ·è¢«é‡å®šå‘åˆ° Azure AD è¿›è¡Œç™»å½•ï¼Œç”¨æˆ·å‘é€ç”¨æˆ·åå’Œå¯†ç ã€‚
2. å‡­æ®è¢«åŠ å¯†å¹¶è®¾ç½®åœ¨ Azure AD çš„é˜Ÿåˆ—ä¸­ã€‚
3. æœ¬åœ°èº«ä»½éªŒè¯ä»£ç†ä»é˜Ÿåˆ—ä¸­è·å–å‡­æ®å¹¶å¯¹å…¶è¿›è¡Œè§£å¯†ã€‚æ­¤ä»£ç†ç§°ä¸ºâ€œé€ä¼ èº«ä»½éªŒè¯ä»£ç†â€æˆ– PTA ä»£ç†ã€‚
4. ä»£ç†å°†å‡­æ®ä¸æœ¬åœ° AD è¿›è¡ŒéªŒè¯ï¼Œå¹¶å°†å“åº”å‘é€å› Azure ADï¼Œå¦‚æœå“åº”ä¸ºæ­£é¢ï¼Œåˆ™å®Œæˆç”¨æˆ·çš„ç™»å½•ã€‚

{% hint style="warning" %}
å¦‚æœæ”»å‡»è€…å…¥ä¾µäº† PTAï¼Œä»–å¯ä»¥æŸ¥çœ‹é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‡­æ®ï¼ˆä»¥æ˜æ–‡å½¢å¼ï¼‰ã€‚ä»–è¿˜å¯ä»¥å¯¹ AzureAD éªŒè¯ä»»ä½•å‡­æ®ï¼ˆç±»ä¼¼äº Skeleton key æ”»å‡»ï¼‰ã€‚
{% endhint %}

### æœ¬åœ° -> äº‘ç«¯

å¦‚æœæ‚¨å…·æœ‰åœ¨è¿è¡Œ PTA ä»£ç†çš„ Azure AD Connect æœåŠ¡å™¨ä¸Šçš„ç®¡ç†å‘˜è®¿é—®æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ AADInternals æ¨¡å—æ’å…¥åé—¨ï¼Œä»¥éªŒè¯æ‰€æœ‰è¾“å…¥çš„å¯†ç ï¼ˆå› æ­¤æ‰€æœ‰å¯†ç éƒ½å°†æœ‰æ•ˆè¿›è¡Œèº«ä»½éªŒè¯ï¼‰ï¼š
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
å¦‚æœ**å®‰è£…å¤±è´¥**ï¼Œå¯èƒ½æ˜¯ç”±äºç¼ºå°‘[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)ã€‚
{% endhint %}

è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ä¹‹å‰å®‰è£…äº†åé—¨çš„æœºå™¨ä¸Š**æŸ¥çœ‹å‘é€ç»™ PTA ä»£ç†çš„æ˜æ–‡å¯†ç **ï¼š
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
è¿™ä¸ªåé—¨å°†ä¼šï¼š

* åˆ›å»ºä¸€ä¸ªéšè—æ–‡ä»¶å¤¹ `C:\PTASpy`
* å°† `PTASpy.dll` å¤åˆ¶åˆ° `C:\PTASpy`
* æ³¨å…¥ `PTASpy.dll` åˆ° `AzureADConnectAuthenticationAgentService` è¿›ç¨‹ä¸­

{% hint style="info" %}
å½“ AzureADConnectAuthenticationAgent æœåŠ¡é‡æ–°å¯åŠ¨æ—¶ï¼ŒPTASpy å°†è¢«â€œå¸è½½â€ï¼Œå¿…é¡»é‡æ–°å®‰è£…ã€‚
{% endhint %}

### äº‘ -> On-Prem

{% hint style="danger" %}
åœ¨äº‘ç«¯è·å¾— **GA ç‰¹æƒ** åï¼Œå¯ä»¥é€šè¿‡å°†å…¶è®¾ç½®åœ¨ **æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨ä¸Š** æ¥ **æ³¨å†Œä¸€ä¸ªæ–°çš„ PTA ä»£ç†**ã€‚ä¸€æ—¦ä»£ç† **è®¾ç½®å®Œæˆ**ï¼Œæˆ‘ä»¬å¯ä»¥ **é‡å¤** ä¸Šè¿°æ­¥éª¤æ¥ **ä½¿ç”¨ä»»æ„å¯†ç è¿›è¡Œèº«ä»½éªŒè¯**ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ **è·å–æ˜æ–‡å¯†ç **ã€‚
{% endhint %}

### æ— ç¼ SSO

å¯ä»¥ä½¿ç”¨ PTA è¿›è¡Œæ— ç¼ SSOï¼Œè¿™ä¹Ÿå®¹æ˜“å—åˆ°å…¶ä»–æ»¥ç”¨çš„æ”»å‡»ã€‚åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
