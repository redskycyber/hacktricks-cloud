# Az - Roadtx - Autenticaci√≥n

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Post copiado de** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Informaci√≥n B√°sica

ROADtools Token eXchange (roadtx) es una herramienta para **intercambiar y utilizar diferentes tipos de tokens emitidos por Azure AD**. Soporta muchos flujos de autenticaci√≥n diferentes, registro de dispositivos y operaciones relacionadas con PRT.

Puede hacer lo siguiente:

* Registrar y unir dispositivos a Azure AD.
* Solicitar Tokens de Actualizaci√≥n Primarios a partir de credenciales de usuario u otros tokens v√°lidos.
* Utilizar Tokens de Actualizaci√≥n Primarios de manera similar a como lo hace el Administrador de Cuentas Web (WAM) en Windows.
* Realizar todo tipo de flujos de canje de tokens Oauth2.
* Realizar inicios de sesi√≥n interactivos basados en SSO de navegador inyectando el Token de Actualizaci√≥n Primario en el flujo de autenticaci√≥n.
* A√±adir capacidades de SSO a Chrome mediante el plugin de cuentas de Windows 10 y una implementaci√≥n personalizada de browsercore.
* Automatizar inicios de sesi√≥n, MFA y solicitudes de tokens para varios recursos en Azure AD utilizando Selenium.
* Posibilidad de cargar credenciales y semillas TOTP de MFA desde una base de datos de KeePass para usar en flujos automatizados.

## Registrando un dispositivo

La mayor√≠a de los m√≥dulos de roadtx est√°n dise√±ados en torno a Tokens de Actualizaci√≥n Primarios e identidades de dispositivos. **Para obtener un PRT, primero debemos registrar un dispositivo en Azure AD**.\
Registrar un dispositivo **requiere** un **token de acceso** al recurso de servicio de registro de dispositivos. El token de acceso debe ser un **token sin una reclamaci√≥n de dispositivo**, por lo que no puedes usar inicio de sesi√≥n √∫nico o un PRT existente para solicitar uno. Hay **varias formas de obtener dicho token con roadtx**, donde algunos m√©todos soportan MFA y otros no.\
**Podr√≠a ser necesario MFA para registrar un dispositivo, dependiendo de la configuraci√≥n del inquilino**. Si no es as√≠, puedes solicitar un token para el servicio de registro de dispositivos (especificado aqu√≠ a trav√©s del alias _devicereg_) solo con un nombre de usuario y contrase√±a:
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
Si se requiere MFA, puedes usar el flujo de autenticaci√≥n de dispositivos para solicitar los tokens desde una **ventana de navegador en alg√∫n lugar**:
```bash
roadtx gettokens --device-auth -r devicereg
```
Alternativamente, utilizamos una **ventana basada en Selenium para MFA**, mientras completamos autom√°ticamente el nombre de usuario + contrase√±a:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
Cualquiera de los comandos anteriores **guardar√° un token de acceso en el archivo `.roadtools_auth`**. El comando de registro de dispositivo lo cargar√° autom√°ticamente desde este archivo. Puedes personalizar lo que desees para las propiedades del dispositivo con varios par√°metros de l√≠nea de comandos para el m√≥dulo `roadtx device`:

<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Registramos un dispositivo unido a Azure AD con el nombre ‚Äúblogdevice‚Äù:
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
Obtenemos dos piezas de datos que identifican nuestro dispositivo: La primera es el **certificado del dispositivo** guardado en `blogdevice.pem`, que es emitido por Azure AD y **identifica nuestro dispositivo**. La segunda parte es el archivo `blogdevice.key`, que contiene la **clave privada del certificado** y tambi√©n se utiliza como clave de transporte. Ahora que tenemos el certificado del dispositivo, podemos realizar **operaciones que requieren una identidad de dispositivo**. La m√°s √∫til es **solicitar un Primary Refresh Token**, ya que eso nos permitir√° agregar capacidades de Single Sign On a nuestras solicitudes de token (interactivas o automatizadas).

## Solicitando un Primary Refresh Token <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

Un primary refresh token se solicita m√°s a menudo con un nombre de usuario y contrase√±a. Cuando inicias sesi√≥n en una estaci√≥n de trabajo unida a Azure AD o h√≠brida con tu **nombre de usuario y contrase√±a**, Windows inmediatamente **solicita un PRT** de Azure AD. He hablado sobre las tecnicidades detr√°s de este flujo en mis charlas de Troopers y Romhack [talks](https://dirkjanm.io/talks/) en el pasado, as√≠ que si est√°s interesado en las tecnicidades, echa un vistazo a esas diapositivas. **Para solicitar un PRT con roadtx, ejecuta el comando `roadtx prt`**, especifica el certificado/clave del dispositivo y el nombre de usuario + contrase√±a a utilizar, y obtendr√°s un PRT:

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
{% endcode %}

El comando nos proporcionar√° un **PRT** (en forma de un token encriptado) y una **clave de sesi√≥n** que necesitamos para usar el PRT. Por defecto, el PRT se guarda en `roadtx.prt`, donde puede ser utilizado por otros m√≥dulos de roadtx.

Un PRT por defecto es v√°lido por 90 d√≠as, pero podemos **renovarlo en cualquier momento** para extender su validez por otros 90 d√≠as con la acci√≥n `renew`:
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
Tenga en cuenta que el PRT que solicitamos aqu√≠ se basa √∫nicamente en una contrase√±a, por lo que **cualquier autenticaci√≥n que requiera MFA fallar√° incluso si usamos el PRT**. Tambi√©n podemos actualizar o "enriquecer" el PRT con una afirmaci√≥n de MFA, esto se muestra en la siguiente secci√≥n sobre autenticaci√≥n basada en Selenium.

## Usando Tokens de Actualizaci√≥n Primarios en la l√≠nea de comandos <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

Una vez que tenemos un PRT, podemos usarlo para **iniciar sesi√≥n en recursos que aceptan autenticaci√≥n de Azure AD**. Puede hacer esto ya sea con el comando **`roadtx gettokens`**, y **especificar el PRT y la clave de sesi√≥n** en la l√≠nea de comandos, o usar el comando **`roadtx prtauth`**. La diferencia entre los dos es que el comando **`gettokens`** implementa una autenticaci√≥n que se basa en **c√≥mo Chrome realiza el Single Sign On** en el navegador. Este m√©todo es un poco rudimentario y si falla no le dar√° ning√∫n tipo de retroalimentaci√≥n.

El m√≥dulo **`prtauth`** en cambio emula el **Web Account Manager (WAM) que utiliza Windows** si solicitas tokens de acceso desde una aplicaci√≥n o proceso nativo. El WAM act√∫a como un intermediario de tokens y solicita tokens en nombre de otros clientes. Utiliza una combinaci√≥n de solicitudes firmadas y respuestas cifradas para evitar exponer los tokens en tr√°nsito, todo hecho usando la clave de sesi√≥n del PRT.

Por defecto, el m√≥dulo `roadtx prtauth` usar√° el **ID de cliente del M√≥dulo de PowerShell de Azure AD** y el gr√°fico de Azure AD como recurso, pero puede especificar cualquier otro ID de cliente o URL de recurso ya sea por su parte completa o como un alias (que se puede listar con `roadtx listaliases`):
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
Ejemplo utilizando la CLI de Azure como ID de cliente y solicitando tokens para el Azure Resource Manager:
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
Tambi√©n hay otras opciones que puedes usar para especificar otros recursos o la URL de redirecci√≥n correcta para la aplicaci√≥n que est√°s utilizando:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Autenticaci√≥n de Azure AD basada en Selenium <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

Las solicitudes de tokens y su uso basados en l√≠nea de comandos son √∫tiles, pero a menudo te encontrar√°s con alg√∫n flujo que requiere una ventana de navegador para realizar la Autenticaci√≥n de M√∫ltiples Factores, o simplemente quieres usar tu PRT de manera interactiva para navegar por cosas como el Portal de Azure o leer tu correo utilizando un PRT robado.

El principio de las operaciones basadas en Selenium en roadtx es simple: **lanza una ventana de navegador, intenta autocompletar cualquier credencial que hayas suministrado al comando y te permite completar el resto manualmente**. Si tienes tus cuentas configuradas correctamente, realizar√° la autenticaci√≥n de forma totalmente autom√°tica.

### Autenticaci√≥n interactiva <a href="#interactive-authentication" id="interactive-authentication"></a>

En su forma m√°s simple, roadtx lanzar√° un navegador para ti, solicitar√° un token para el servicio indicado, completar√° cualquier credencial que hayas especificado y obtendr√° tokens. Ejemplo:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
Si se requiere **MFA**, puedes ingresar eso y obtener un token con reclamo de MFA. Si no, capturar√° la salida y guardar√° los tokens solicitados. Puedes especificar el **client ID** que deseas usar con `-c` y el recurso para autenticarte con `-r`. Aqu√≠ hay un [**video demostrativo corto**](https://dirkjanm.io/assets/video/selenium_autofill.mp4).

### Usando KeePass para autenticarse en diferentes cuentas <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** admite **obtener credenciales e informaci√≥n de MFA basada en TOTP de un archivo kdbx** (archivo KeePass) o exportaci√≥n XML de KeePass. Para usar esto, utiliza el comando **`roadtx keepassauth`**. Acepta un archivo **KeePass** con el par√°metro **`-kp`** o si dejas este par√°metro fuera, intentar√° cargar `roadtx.kdbx` desde el directorio actual. La **contrase√±a** del archivo KeePass se puede especificar con **`-kpp`** o a trav√©s de la variable de entorno `KPPASS`. El √∫nico par√°metro **requerido** es el **nombre de usuario**, que buscar√° en el archivo KeePass. Rellenar√° autom√°ticamente la contrase√±a y tambi√©n el c√≥digo OTP si "OTP de aplicaci√≥n m√≥vil" est√° habilitado como m√©todo MFA en la cuenta. Esto requiere que la semilla TOTP est√© almacenada en el par√°metro adicional `otp` de la identidad en el archivo KeePass. Para instrucciones sobre c√≥mo configurar esto y algunas advertencias sobre el uso de archivos KeePass, consulta la [wiki de roadtx](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-(roadtx)).

Revisa el [**video demostrativo**](https://dirkjanm.io/assets/video/selenium_kpautofill.mp4).

Adem√°s de solicitar tokens directamente, tambi√©n puedes usar esto como una ventana de navegador interactiva con autenticaci√≥n autom√°tica. Para hacer esto, especifica manualmente una URL que te redirigir√° a la p√°gina de inicio de sesi√≥n de Microsoft. Por ejemplo, usar `-url https://myaccount.microsoft.com` abrir√° un navegador, te autenticar√° e ir√° a la p√°gina "Mi cuenta". Puedes usar `--keep-open` para mantener la ventana del navegador abierta despu√©s de la autenticaci√≥n, lo que hace posible navegar a otras p√°ginas desde una perspectiva autenticada. Ejemplo:

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### Autenticaci√≥n PRT en navegador <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

Un escenario m√°s interesante es usar un Primary Refresh Token que hayas registrado t√∫ mismo o que hayas [robado de un punto final leg√≠timo](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) durante un red team para crear una experiencia interactiva en el navegador. Supongamos que **extrajimos un PRT y clave de sesi√≥n usando Mimikatz de un punto final** (esto solo es posible si no utiliza un Trusted Platform Module). Podemos usar este PRT en la l√≠nea de comandos, o podemos inyectarlo autom√°ticamente en nuestra sesi√≥n de navegador Selenium. roadtx hace esto al proxyar el tr√°fico del navegador a trav√©s de s√≠ mismo e inyectar una cookie PRT en varios puntos durante la autenticaci√≥n. En el punto final de la v√≠ctima, podemos usar Mimikatz para volcar el PRT y la clave de sesi√≥n.

Puedes **verificar los comandos** para volcar el PRT y la clave de sesi√≥n y luego usar los valores con **`roadtx`** en la [**Opci√≥n 2 del m√©todo mimikatz para Pass the PRT**](pass-the-prt.md#attack-mimikatz)**.**

### Uso de PRT con otras cuentas <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

Un caso de uso interesante para los Primary Refresh Tokens robados es que tambi√©n puedes **usarlos para otras cuentas para agregar reclamaciones de dispositivo** a la autenticaci√≥n. Por ejemplo, si hay una pol√≠tica de acceso condicional que requiere un dispositivo corporativo compatible o h√≠brido unido para acceder a recursos espec√≠ficos, la reclamaci√≥n del dispositivo proviene del primary refresh token utilizado durante la autenticaci√≥n. Esta reclamaci√≥n tambi√©n puede ser utilizada para otros usuarios. As√≠ que si tengo un **PRT robado de un dispositivo compatible** para el usuario `tpmtest@iminyour.cloud`, puedo usar este **PRT con las credenciales de `newlowpriv@iminyour.cloud`** para iniciar sesi√≥n y pasar la prueba de cumplimiento.

En este ejemplo todav√≠a tenemos el PRT robado de `tpmtest@iminyour.cloud` utilizado en el ejemplo anterior guardado como `roadtx.prt`. Puedo usar este **PRT junto con las credenciales de `newlowpriv`** que est√°n almacenadas en mi archivo KeePass para iniciar sesi√≥n en Microsoft Teams y acceder a datos all√≠ con el comando `roadtx browserprtinject`.
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
El token de acceso emitido contendr√° la afirmaci√≥n `deviceid`, que es el dispositivo del cual robamos el PRT. Dado que este dispositivo est√° gestionado por Intune y cumple con los requisitos, pasa el requisito de conformidad:

<figure><img src="../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

### A√±adiendo afirmaciones de MFA a un PRT existente <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

Volviendo a los PRT que robamos y regresando al PRT que registramos anteriormente usando una combinaci√≥n de nombre de usuario + contrase√±a. Si queremos tener un **PRT con afirmaci√≥n de MFA, tenemos que usar una sesi√≥n interactiva** que solicitar√° un token de actualizaci√≥n especial de Azure AD para "enriquecer" nuestro PRT. El comando para esto es **`roadtx prtenrich`**, que como los comandos anteriores acepta una identidad en un archivo KeePass para autocompletar la informaci√≥n de MFA, o puedes hacer esto manualmente.
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
El resultado es un token de actualizaci√≥n especial que podemos utilizar para solicitar un nuevo PRT. Para esto, volvemos al m√≥dulo `roadtx prt`:
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
El nuevo PRT se escribe en disco y cuando lo usamos para solicitar tokens vemos la afirmaci√≥n MFA:

<figure><img src="../../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

Podemos usar este PRT para obtener tokens para recursos que requieren MFA utilizando cualquiera de los m√©todos anteriores.

### SSO usando Chrome y un browsercore personalizado <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

En la siguiente p√°gina tienes informaci√≥n sobre c√≥mo Google Chrome usa **`browsercore.exe`** para autenticarse a trav√©s de SSO:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** tiene `browsercore.py`, puedes usar un PTR de **`roadtx`** (o uno que hayas robado en otro lugar) para autenticarte autom√°ticamente en tu navegador Chrome en tu host controlado por el atacante. No necesitas tener una ventana de Selenium, sino que puedes usar el PRT directamente como si estuvieras en la m√°quina de la v√≠ctima en un navegador leg√≠timo.

El SSO personalizado requiere algunos pasos para configurarse:

* Debes colocar los archivos `browsercore.py` y `manifest.json` [archivos](https://github.com/dirkjanm/ROADtools/tree/master/browsercore) en alguna ubicaci√≥n en disco, por ejemplo en `C:\browsercore\`.
* Instala roadtx y coloca un archivo `roadtx.prt` en el mismo directorio.
* Modifica `HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore` para que apunte a `C:\browsercore\manifest.json`.
* Prueba si todo funciona usando `bctest.py`
* Borra cualquier cookie existente en Chrome para `login.microsoftonline.com`

Las instrucciones completas de instalaci√≥n est√°n en el [wiki de ROADtools](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py). Despu√©s de la configuraci√≥n, Chrome deber√≠a usar el PRT autom√°ticamente durante el inicio de sesi√≥n. La primera vez puede necesitar una pista para el nombre de usuario para funcionar correctamente.

Con esta configuraci√≥n puedes navegar por cualquier recurso conectado a Azure AD con SSO y las afirmaciones del PRT, incluyendo el estado del dispositivo y la informaci√≥n MFA almacenada.

## Otras utilidades <a href="#other-utilities" id="other-utilities"></a>

Hay algunas otras utilidades en roadtx, principalmente para facilitar mi propia investigaci√≥n:

* `roadtx decrypt` puede descifrar respuestas encriptadas dada una clave de sesi√≥n PRT o una clave de transporte de dispositivo
* `roadtx getotp` puede calcular un c√≥digo OTP a partir de una semilla o de la propiedad otp almacenada en un archivo KeePass (si necesitas hacer MFA para ese usuario)
* `roadtx codeauth` puede realizar el flujo de redenci√≥n de c√≥digo OAuth2 para clientes p√∫blicos y confidenciales.
* `roadtx listaliases` lista todos los alias que son compatibles para recursos y clientes. Si necesitas cualquier otro alias que uses frecuentemente, no dudes en abrir un problema o enviarme un mensaje.

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
