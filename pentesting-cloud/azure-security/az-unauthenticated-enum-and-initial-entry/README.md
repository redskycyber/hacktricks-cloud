# Az - æœªç»è®¤è¯çš„æšä¸¾ä¸åˆå§‹å…¥å£

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Azureç§Ÿæˆ·

### ç§Ÿæˆ·æšä¸¾

æœ‰ä¸€äº›**å…¬å…±Azure API**ï¼Œä»…å‡­çŸ¥é“**ç§Ÿæˆ·çš„åŸŸå**ï¼Œæ”»å‡»è€…å°±å¯ä»¥æŸ¥è¯¢ä»¥æ”¶é›†æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯ã€‚\
æ‚¨å¯ä»¥ç›´æ¥æŸ¥è¯¢APIæˆ–ä½¿ç”¨PowerShellåº“ [**AADInternals**](https://github.com/Gerenios/AADInternals)**ï¼š**

| API                                                                  | ä¿¡æ¯                                                                                          | AADInternalså‡½æ•°                                  |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **ç™»å½•ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·ID                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **ç§Ÿæˆ·çš„æ‰€æœ‰åŸŸå**                                                                            | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **ç§Ÿæˆ·çš„ç™»å½•ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·åç§°å’ŒåŸŸå**è®¤è¯ç±»å‹**                                            | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | ç™»å½•ä¿¡æ¯ï¼ŒåŒ…æ‹¬**æ¡Œé¢SSOä¿¡æ¯**                                                                 | `Get-AADIntLoginInformation -UserName <UserName>` |

æ‚¨å¯ä»¥ä½¿ç”¨ [**AADInternals**](https://github.com/Gerenios/AADInternals) **åº“çš„ä»…ä¸€ä¸ªå‘½ä»¤æŸ¥è¯¢Azureç§Ÿæˆ·çš„æ‰€æœ‰ä¿¡æ¯**ï¼š
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure ç§Ÿæˆ·ä¿¡æ¯è¾“å‡ºç¤ºä¾‹ï¼š
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
ä»è¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›®æ ‡ç»„ç»‡çš„ç§Ÿæˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·åç§°ã€IDå’Œâ€œå“ç‰Œâ€åç§°ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°**æ¡Œé¢å•ç‚¹ç™»å½•ï¼ˆåˆå**[**æ— ç¼å•ç‚¹ç™»å½•**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**ï¼‰æ˜¯å¦å¯ç”¨**ã€‚å¦‚æœå¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾å‡ºç›®æ ‡ç»„ç»‡ä¸­æ˜¯å¦å­˜åœ¨ç»™å®šç”¨æˆ·ï¼ˆç”¨æˆ·æšä¸¾ï¼‰ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ç›®æ ‡ç§Ÿæˆ·çš„æ‰€æœ‰ï¼ˆå·²éªŒè¯ï¼‰åŸŸååŠå…¶èº«ä»½ç±»å‹ã€‚å¯¹äºè”åˆåŸŸï¼Œè¿˜ä¼šæ˜¾ç¤ºæ‰€ä½¿ç”¨çš„èº«ä»½æä¾›è€…ï¼ˆé€šå¸¸æ˜¯ADFSæœåŠ¡å™¨ï¼‰çš„FQDNã€‚MXåˆ—æŒ‡ç¤ºç”µå­é‚®ä»¶æ˜¯å¦å‘é€åˆ°Exchangeåœ¨çº¿ã€‚SPFåˆ—æŒ‡ç¤ºExchangeåœ¨çº¿æ˜¯å¦åˆ—ä¸ºç”µå­é‚®ä»¶å‘é€è€…ã€‚**æ³¨æ„ï¼**ç›®å‰ï¼Œä¾¦å¯ŸåŠŸèƒ½ä¸éµå¾ªSPFè®°å½•çš„includeè¯­å¥ï¼Œå› æ­¤å¯èƒ½ä¼šæœ‰è¯¯æŠ¥ã€‚

### ç”¨æˆ·æšä¸¾

å¯ä»¥**æ£€æŸ¥ç§Ÿæˆ·å†…æ˜¯å¦å­˜åœ¨ç”¨æˆ·å**ã€‚è¿™ä¹ŸåŒ…æ‹¬**è®¿å®¢ç”¨æˆ·**ï¼Œå…¶ç”¨æˆ·åæ ¼å¼ä¸ºï¼š
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
ç”µå­é‚®ä»¶æ˜¯ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ï¼Œå…¶ä¸­â€œ@â€è¢«ä¸‹åˆ’çº¿â€œ\_â€æ›¿æ¢ã€‚

ä½¿ç”¨ [**AADInternals**](https://github.com/Gerenios/AADInternals)ï¼Œæ‚¨å¯ä»¥è½»æ¾æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Azure æœªç»è®¤è¯çš„æšä¸¾å’Œåˆå§‹å…¥å£

åœ¨å¯¹Azureç¯å¢ƒè¿›è¡Œæ¸—é€æµ‹è¯•æ—¶ï¼Œåˆå§‹ä¿¡æ¯æ”¶é›†é˜¶æ®µè‡³å…³é‡è¦ã€‚è¿™ä¸ªé˜¶æ®µçš„ç›®æ ‡æ˜¯è¯†åˆ«å‡ºæ½œåœ¨çš„åˆå§‹æ”»å‡»å‘é‡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœªç»è®¤è¯çš„æšä¸¾æŠ€æœ¯ï¼Œè¿™äº›æŠ€æœ¯å¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•Azureå‡­è¯çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚

## å…¬å…±Blobæ£€æµ‹

Azure Blobå­˜å‚¨æ˜¯ç”¨äºå­˜å‚¨å¤§é‡éç»“æ„åŒ–æ•°æ®çš„æœåŠ¡ã€‚å…¬å…±Blobå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æµ‹ï¼š

- ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¦‚`BlobHunter`ï¼Œè‡ªåŠ¨æ£€æµ‹å…¬å…±Blobã€‚
- æ‰‹åŠ¨æ£€æµ‹ï¼Œé€šè¿‡è®¿é—®`http://<storage_account>.blob.core.windows.net/`å¹¶æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç ã€‚

## Azureæ–‡ä»¶å…±äº«æšä¸¾

Azureæ–‡ä»¶å…±äº«å…è®¸ç”¨æˆ·åˆ›å»ºå’Œä½¿ç”¨SMBæ–‡ä»¶å…±äº«ã€‚æœªç»æˆæƒçš„ç”¨æˆ·å¯èƒ½èƒ½å¤Ÿæšä¸¾æ–‡ä»¶å…±äº«ï¼š

- ä½¿ç”¨`SMBMap`æˆ–`CrackMapExec`ç­‰å·¥å…·ã€‚
- æ‰‹åŠ¨æ£€æµ‹ï¼Œå°è¯•è®¿é—®`\\<storage_account>.file.core.windows.net\`ã€‚

## å­åŸŸæšä¸¾

å­åŸŸå¯èƒ½ä¼šæ³„éœ²æœ‰å…³Azureç¯å¢ƒçš„ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œæšä¸¾ï¼š

- ä½¿ç”¨å­åŸŸæšä¸¾å·¥å…·ï¼Œå¦‚`Amass`æˆ–`Sublist3r`ã€‚
- æ£€æŸ¥DNSè®°å½•ï¼Œå¦‚CNAMEæˆ–Aè®°å½•ï¼Œè¿™å¯èƒ½ä¼šæŒ‡å‘AzureæœåŠ¡ã€‚

## å…ƒæ•°æ®æœåŠ¡æ³„éœ²

Azureå…ƒæ•°æ®æœåŠ¡å¯ä»¥æ³„éœ²å…³äºè™šæ‹Ÿæœºçš„ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡è®¿é—®ç‰¹å®šURLæ¥æ£€ç´¢ï¼š

- è®¿é—®`http://169.254.169.254/metadata/instance?api-version=2021-02-01`ï¼Œå¹¶æ·»åŠ `Metadata: true`å¤´éƒ¨ã€‚

## æœåŠ¡ä¸»ä½“æšä¸¾

æœåŠ¡ä¸»ä½“æ˜¯Azure ADä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œç”¨äºæˆæƒåº”ç”¨ç¨‹åºè®¿é—®èµ„æºã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æµ‹æœªç»æˆæƒçš„æœåŠ¡ä¸»ä½“ï¼š

- ä½¿ç”¨`MicroBurst`å·¥å…·é›†ä¸­çš„`Get-AzureServicePrincipal`è„šæœ¬ã€‚
- æ‰‹åŠ¨æ£€æµ‹ï¼Œé€šè¿‡å°è¯•è®¿é—®Azure ADä¸­çš„æœåŠ¡ä¸»ä½“ã€‚

## æ€»ç»“

è¿™äº›æŠ€æœ¯å¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜åœ¨ä¸éœ€è¦ä»»ä½•å‡­è¯çš„æƒ…å†µä¸‹å‘ç°Azureç¯å¢ƒä¸­çš„æ½œåœ¨æ¼æ´ã€‚ä¸€æ—¦å‘ç°äº†æ½œåœ¨çš„å…¥å£ç‚¹ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥æ¢ç´¢å’Œåˆ©ç”¨è¿™äº›æ¼æ´ã€‚
```
```
UserName         Exists
--------         ------
user@company.com True
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡ŒåŒ…å«ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€ï¼š
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
æœ‰**ä¸‰ç§ä¸åŒçš„æšä¸¾æ–¹æ³•**å¯ä¾›é€‰æ‹©ï¼š

| æ–¹æ³•       | æè¿°                                                                                                                                                                                                 |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | è¿™æŒ‡çš„æ˜¯ä¸Šé¢æåˆ°çš„ GetCredentialType APIã€‚é»˜è®¤æ–¹æ³•ã€‚                                                                                                                                                 |
| Login     | <p>æ­¤æ–¹æ³•å°è¯•ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æ³¨æ„ï¼š</strong>æŸ¥è¯¢å°†è®°å½•åˆ°ç™»å½•æ—¥å¿—ä¸­ã€‚</p>                                                                                                                 |
| Autologon | <p>æ­¤æ–¹æ³•å°è¯•é€šè¿‡è‡ªåŠ¨ç™»å½•ç«¯ç‚¹ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æŸ¥è¯¢ä¸ä¼šè¢«è®°å½•</strong>åˆ°ç™»å½•æ—¥å¿—ä¸­ï¼å› æ­¤ï¼Œä¹Ÿé€‚ç”¨äºå¯†ç å–·æ¶‚å’Œæš´åŠ›ç ´è§£æ”»å‡»ã€‚</p>                                                              |

åœ¨å‘ç°æœ‰æ•ˆçš„ç”¨æˆ·ååï¼Œä½ å¯ä»¥è·å–**å…³äºç”¨æˆ·çš„ä¿¡æ¯**ï¼š
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
è„šæœ¬ [**o365creeper**](https://github.com/LMGsec/o365creeper) ä¹Ÿå…è®¸æ‚¨å‘ç°**ç”µå­é‚®ä»¶æ˜¯å¦æœ‰æ•ˆ**ã€‚
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure æœåŠ¡

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†**Azure ç§Ÿæˆ·**æ­£åœ¨ä½¿ç”¨çš„**åŸŸå**ï¼Œæ˜¯æ—¶å€™å°è¯•æ‰¾å‡º**æš´éœ²çš„ Azure æœåŠ¡**äº†ã€‚

ä½ å¯ä»¥ä½¿ç”¨ [**MicroBust**](https://github.com/NetSPI/MicroBurst) ä¸­çš„ä¸€ä¸ªæ–¹æ³•æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚è¿™ä¸ªå‡½æ•°å°†åœ¨å‡ ä¸ª**Azure æœåŠ¡åŸŸå**ä¸­æœç´¢åŸºç¡€åŸŸåï¼ˆä»¥åŠä¸€äº›å˜ä½“ï¼‰ï¼š
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## å¼€æ”¾å­˜å‚¨

æ‚¨å¯ä»¥ä½¿ç”¨åƒ [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) è¿™æ ·çš„å·¥å…·æ¥å‘ç°å¼€æ”¾å­˜å‚¨ï¼Œå®ƒå°†ä½¿ç”¨æ–‡ä»¶ **`Microburst/Misc/permitations.txt`** ç”Ÿæˆæ’åˆ—ï¼ˆéå¸¸ç®€å•ï¼‰ï¼Œä»¥å°è¯•**æ‰¾åˆ°å¼€æ”¾çš„å­˜å‚¨è´¦æˆ·**ã€‚
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**å…±äº«è®¿é—®ç­¾å**_ï¼ˆSASï¼‰URL æ˜¯ä¸€ä¸ªæä¾›å¯¹å­˜å‚¨å¸æˆ·æŸéƒ¨åˆ†è®¿é—®æƒé™çš„ URLï¼ˆå¯ä»¥æ˜¯å®Œæ•´çš„å®¹å™¨ã€æ–‡ä»¶ç­‰ï¼‰ï¼Œå…·æœ‰å¯¹èµ„æºçš„ç‰¹å®šæƒé™ï¼ˆè¯»ã€å†™ç­‰ï¼‰ã€‚å¦‚æœä½ å‘ç°ä¸€ä¸ªæ³„éœ²çš„ SAS URLï¼Œä½ å¯èƒ½èƒ½å¤Ÿè®¿é—®æ•æ„Ÿä¿¡æ¯ï¼Œå®ƒä»¬çœ‹èµ·æ¥åƒè¿™æ ·ï¼ˆè¿™æ˜¯ä¸ºäº†è®¿é—®ä¸€ä¸ªå®¹å™¨ï¼Œå¦‚æœå®ƒåªæ˜¯æˆäºˆå¯¹ä¸€ä¸ªæ–‡ä»¶çš„è®¿é—®æƒé™ï¼ŒURL çš„è·¯å¾„ä¹Ÿä¼šåŒ…å«è¯¥æ–‡ä»¶ï¼‰ï¼š

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

ä½¿ç”¨ [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) æ¥è®¿é—®æ•°æ®

## å¦¥åå‡­è¯

### é’“é±¼

* [**å¸¸è§é’“é±¼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)ï¼ˆå‡­è¯æˆ– OAuth åº”ç”¨ç¨‹åº -[éæ³•åŒæ„æˆäºˆæ”»å‡»](az-illicit-consent-grant.md)-ï¼‰
* [**è®¾å¤‡ä»£ç è®¤è¯** é’“é±¼](az-device-code-authentication-phishing.md)

### å¯†ç å–·æ¶‚ / æš´åŠ›ç ´è§£

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
