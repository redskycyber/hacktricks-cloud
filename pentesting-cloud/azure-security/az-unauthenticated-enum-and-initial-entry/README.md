# Az - Enumeraci贸n no autenticada y entrada inicial

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Azure Tenant

### Enumeraci贸n de Tenant

Existen algunas **APIs p煤blicas de Azure** que, con solo conocer el **dominio del tenant**, un atacante podr铆a consultar para recopilar m谩s informaci贸n sobre 茅l.\
Puedes consultar directamente la API o usar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informaci贸n                                                                                                                                                                                                                                           | Funci贸n de AADInternals                           |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informaci贸n de inicio de sesi贸n**, incluyendo el ID del tenant                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del tenant                                                                                                                                                                                                                     | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informaci贸n de inicio de sesi贸n</strong> del tenant, incluyendo el nombre del tenant y el dominio <strong>tipo de autenticaci贸n.</strong><br>Si <code>NameSpaceType</code> es <strong><code>Managed</code></strong>, significa que se utiliza <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informaci贸n de inicio de sesi贸n, incluyendo **informaci贸n de SSO de escritorio**                                                                                                                                                                      | `Get-AADIntLoginInformation -UserName <UserName>` |

Puedes consultar toda la informaci贸n de un tenant de Azure con **solo un comando de la** [**biblioteca AADInternals**](https://github.com/Gerenios/AADInternals)**:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Ejemplo de salida de la informaci贸n del tenant de Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Del resultado podemos ver la informaci贸n del inquilino de la organizaci贸n objetivo, incluyendo el nombre del inquilino, id y el nombre de "marca". Tambi茅n podemos ver **si el Desktop SSO (tambi茅n conocido como** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) est谩 habilitado**. Si est谩 habilitado, podemos averiguar si un usuario dado existe en la organizaci贸n objetivo o no (enumeraci贸n de usuarios).

Tambi茅n podemos ver los nombres de todos los dominios (verificados) y sus tipos de identidad del inquilino objetivo. Para los dominios federados, tambi茅n se muestra el FQDN del proveedor de identidad utilizado (generalmente servidor ADFS). La columna MX indica si el correo electr贸nico se env铆a a Exchange online o no. La columna SPF indica si Exchange online est谩 listado como remitente de correo electr贸nico. **隆Nota!** Actualmente, la funci贸n de reconocimiento no sigue las declaraciones include de los registros SPF, por lo que puede haber falsos negativos.

### Enumeraci贸n de Usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto incluye tambi茅n a los **usuarios invitados**, cuyo nombre de usuario tiene el formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
El correo electr贸nico es la direcci贸n de correo del usuario donde el "@" se reemplaza por un guion bajo "\_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puedes verificar f谩cilmente si el usuario existe o no:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Enumeraci贸n no autenticada e ingreso inicial en Azure

La enumeraci贸n no autenticada en Azure puede proporcionar una gran cantidad de informaci贸n que puede ser utilizada para un ingreso inicial. Algunas t茅cnicas incluyen:

## Listado de blobs p煤blicos

Los blobs p煤blicos en Azure pueden contener informaci贸n sensible. Utiliza herramientas como `AzCopy` o `Microsoft Azure Storage Explorer` para listar y descargar blobs.

## Fugas de claves en repositorios

Las claves de acceso pueden estar presentes en repositorios p煤blicos. Herramientas como `truffleHog` o `git-secrets` pueden ayudar a identificarlas.

## Subdominios de Azure

Los subdominios de Azure pueden revelar informaci贸n sobre la infraestructura. Herramientas como `Sublist3r` o `Amass` pueden ser 煤tiles para enumerar subdominios.

## Fugas de informaci贸n en plantillas de ARM

Las plantillas de Azure Resource Manager (ARM) pueden contener datos sensibles. Revisa las plantillas en busca de posibles fugas.

## B煤squeda de informaci贸n en redes sociales y foros

La informaci贸n sobre la infraestructura de Azure puede ser compartida en redes sociales y foros. Utiliza t茅cnicas de OSINT para recopilar datos.

## Enumeraci贸n de espacios de trabajo de Azure DevOps

Los espacios de trabajo de Azure DevOps pueden contener informaci贸n valiosa. Intenta enumerar proyectos y repositorios.

## Fugas de informaci贸n en configuraciones de CI/CD

Las configuraciones de integraci贸n continua y entrega continua (CI/CD) pueden exponer claves y secretos. Examina estas configuraciones cuidadosamente.

## Enumeraci贸n de contenedores y Kubernetes

Azure Kubernetes Service (AKS) y contenedores pueden ser configurados incorrectamente. Utiliza herramientas como `kube-hunter` o `kubeaudit` para la enumeraci贸n.

## Fugas de informaci贸n en registros de auditor铆a y logs

Los registros de auditor铆a y logs pueden contener informaci贸n sensible. Revisa los registros en busca de datos que puedan ser explotados.

## Enumeraci贸n de recursos de Azure mediante APIs

Las APIs de Azure ofrecen otra v铆a para la enumeraci贸n de recursos. Utiliza scripts o herramientas como `Postman` para explorar las APIs.

## Fugas de informaci贸n en configuraciones de almacenamiento

Las configuraciones de almacenamiento de Azure pueden estar mal configuradas y exponer datos. Verifica las configuraciones de acceso y permisos.

## Enumeraci贸n de servicios expuestos

Los servicios expuestos en Azure pueden ser vulnerables. Identifica servicios accesibles p煤blicamente y eval煤a su configuraci贸n de seguridad.

## Fugas de informaci贸n en dashboards y paneles de control

Los dashboards y paneles de control de Azure pueden revelar informaci贸n cr铆tica. Aseg煤rate de revisar cualquier interfaz accesible p煤blicamente.

## Enumeraci贸n de identidades y roles

Las identidades y roles en Azure pueden ser mal administrados. Enumera y eval煤a las asignaciones de roles y pol铆ticas de acceso.

## Fugas de informaci贸n en scripts y c贸digo

Los scripts y el c贸digo pueden contener claves y configuraciones sensibles. Revisa el c贸digo en busca de posibles fugas.

Recuerda que estas t茅cnicas deben ser utilizadas de manera responsable y dentro del marco legal.
```
```
UserName         Exists
--------         ------
user@company.com True
```
Tambi茅n puedes usar un archivo de texto que contenga una direcci贸n de correo electr贸nico por fila:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Hay **tres m茅todos de enumeraci贸n diferentes** para elegir:

| M茅todo    | Descripci贸n                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Se refiere a la API GetCredentialType mencionada anteriormente. El m茅todo predeterminado.                                                                                                               |
| Login     | <p>Este m茅todo intenta iniciar sesi贸n como el usuario.<br><strong>Nota:</strong> las consultas se registrar谩n en el log de inicios de sesi贸n.</p>                                                       |
| Autologon | <p>Este m茅todo intenta iniciar sesi贸n como el usuario a trav茅s del punto final de autologon.<br><strong>Las consultas no se registran</strong> en el log de inicios de sesi贸n. Por lo tanto, funciona bien tambi茅n para ataques de rociado de contrase帽as y fuerza bruta.</p> |

Despu茅s de descubrir los nombres de usuario v谩lidos, puedes obtener **informaci贸n sobre un usuario** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
El script [**o365creeper**](https://github.com/LMGsec/o365creeper) tambi茅n te permite descubrir **si un correo electr贸nico es v谩lido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Servicios de Azure

Ahora que sabemos los **dominios que el inquilino de Azure** est谩 utilizando, es hora de intentar encontrar **servicios de Azure expuestos**.

Puedes utilizar un m茅todo de [**MicroBust**](https://github.com/NetSPI/MicroBurst) para tal fin. Esta funci贸n buscar谩 el nombre de dominio base (y algunas permutaciones) en varios **dominios de servicios de azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Almacenamiento Abierto

Podr铆as descubrir almacenamiento abierto con una herramienta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que utilizar谩 el archivo **`Microburst/Misc/permitations.txt`** para generar permutaciones (muy simples) para intentar **encontrar cuentas de almacenamiento abiertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Una URL de _**firma de acceso compartido**_ (SAS) es una URL que **proporciona acceso** a cierta parte de una cuenta de Almacenamiento (puede ser un contenedor completo, un archivo...) con algunos permisos espec铆ficos (leer, escribir...) sobre los recursos. Si encuentras una filtrada podr铆as acceder a informaci贸n sensible, se ven as铆 (esto es para acceder a un contenedor, si solo otorgara acceso a un archivo, la ruta de la URL tambi茅n contendr铆a ese archivo):

`https://<nombre_cuenta_almacenamiento>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos

## Comprometer Credenciales

### Phishing

* [**Phishing Com煤n**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciales o aplicaci贸n OAuth -[Ataque de Concesi贸n de Consentimiento Il铆cito](az-illicit-consent-grant.md)-)
* [**Phishing de Autenticaci贸n de C贸digo de Dispositivo**](az-device-code-authentication-phishing.md)

### Rociado de Contrase帽as / Fuerza Bruta

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referencias

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repos de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
