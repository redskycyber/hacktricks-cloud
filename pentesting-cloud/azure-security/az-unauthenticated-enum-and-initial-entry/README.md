# Az - Nieuwierzytelniona Enumeracja i PoczÄ…tkowe WejÅ›cie

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Azure Tenant

### Enumeracja TenantÃ³w

IstniejÄ… **publiczne interfejsy API Azure**, ktÃ³re znajÄ…c jedynie **domenÄ™ tenantÃ³w**, atakujÄ…cy moÅ¼e zapytaÄ‡, aby uzyskaÄ‡ wiÄ™cej informacji na ich temat.\
MoÅ¼esz zapytaÄ‡ bezpoÅ›rednio API lub skorzystaÄ‡ z biblioteki PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informacje                                                                                                                                                                                                                                           | Funkcja AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacje logowania**, w tym identyfikator tenantÃ³w                                                                                                                                                                                                | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Wszystkie domeny** tenantÃ³w                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacje logowania</strong> tenantÃ³w, w tym nazwa tenantÃ³w i domena <strong>typu uwierzytelniania.</strong><br>JeÅ›li <code>NameSpaceType</code> to <strong><code>Managed</code></strong>, oznacza to, Å¼e uÅ¼ywane jest <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacje logowania, w tym **informacje o jednokrotnym logowaniu do pulpitu**                                                                                                                                                                         | `Get-AADIntLoginInformation -UserName <UserName>` |

MoÅ¼esz zapytaÄ‡ o wszystkie informacje dotyczÄ…ce tenantÃ³w Azure za pomocÄ… **tylko jednej komendy z** [**biblioteki AADInternals**](https://github.com/Gerenios):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
PrzykÅ‚adowy wynik informacji o dzierÅ¼awcy Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
MoÅ¼liwe jest obserwowanie szczegÃ³Å‚Ã³w dotyczÄ…cych nazwy, identyfikatora i nazwy "marki" najemcy. Dodatkowo wyÅ›wietlany jest status funkcji Jednokrotnego Logowania do Pulpitu (SSO), znanej rÃ³wnieÅ¼ jako [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Gdy jest wÅ‚Ä…czona, ta funkcja uÅ‚atwia okreÅ›lenie obecnoÅ›ci (enumeracji) okreÅ›lonego uÅ¼ytkownika w organizacji docelowej.

Co wiÄ™cej, wynik prezentuje nazwy wszystkich zweryfikowanych domen powiÄ…zanych z docelowym najemcÄ…, wraz z odpowiadajÄ…cymi im typami toÅ¼samoÅ›ci. W przypadku domen federowanych ujawniany jest rÃ³wnieÅ¼ PeÅ‚na Nazwa Domeny (FQDN) dostawcy toÅ¼samoÅ›ci uÅ¼ywanego, zazwyczaj serwera ADFS. Kolumna "MX" okreÅ›la, czy e-maile sÄ… kierowane do Exchange Online, podczas gdy kolumna "SPF" oznacza wymienienie Exchange Online jako nadawcy e-maili. Warto zauwaÅ¼yÄ‡, Å¼e obecna funkcja rozpoznawania nie analizuje instrukcji "include" w rekordach SPF, co moÅ¼e prowadziÄ‡ do faÅ‚szywych negatywÃ³w.

### Enumeracja UÅ¼ytkownikÃ³w

MoÅ¼liwe jest **sprawdzenie, czy nazwa uÅ¼ytkownika istnieje** wewnÄ…trz najemcy. Dotyczy to rÃ³wnieÅ¼ **uÅ¼ytkownikÃ³w goÅ›ci**, ktÃ³rych nazwa uÅ¼ytkownika ma format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Adres e-mail to adres e-mail uÅ¼ytkownika, w ktÃ³rym znak â€@â€ zostaÅ‚ zastÄ…piony podkreÅ›leniem â€\_â€œ.

Z [**AADInternals**](https://github.com/Gerenios/AADInternals) Å‚atwo sprawdzisz, czy uÅ¼ytkownik istnieje, czy nie:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Nieskategoryzowane: Wyliczanie i PoczÄ…tkowe WejÅ›cie

W tym module dowiesz siÄ™, jak przeprowadziÄ‡ wyliczanie informacji i uzyskaÄ‡ poczÄ…tkowy dostÄ™p do zasobÃ³w Azure bez uwierzytelnienia. To obejmuje wykorzystanie publicznie dostÄ™pnych informacji, takich jak subdomeny, adresy IP, nazwy kontenerÃ³w i wiele innych, aby zebraÄ‡ istotne informacje i znaleÅºÄ‡ potencjalne wejÅ›cia do ataku.
```
UserName         Exists
--------         ------
user@company.com True
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ pliku tekstowego zawierajÄ…cego jeden adres e-mail na wiersz:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
IstniejÄ… **trzy rÃ³Å¼ne metody wyliczania** do wyboru:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Odnosi siÄ™ to do wspomnianego powyÅ¼ej interfejsu API GetCredentialType. Metoda domyÅ›lna.                                                                                                                |
| Login     | <p>Ta metoda prÃ³buje zalogowaÄ‡ siÄ™ jako uÅ¼ytkownik.<br><strong>Uwaga:</strong> zapytania zostanÄ… zapisane w dzienniku logowaÅ„ logowaÅ„.</p>                                                               |
| Autologon | <p>Ta metoda prÃ³buje zalogowaÄ‡ siÄ™ jako uÅ¼ytkownik za pomocÄ… punktu koÅ„cowego autologowania.<br><strong>Zapytania nie sÄ… rejestrowane</strong> w dzienniku logowaÅ„ logowaÅ„! Dlatego dobrze dziaÅ‚a rÃ³wnieÅ¼ dla atakÃ³w typu password spray i brute-force.</p> |

Po odkryciu prawidÅ‚owych nazw uÅ¼ytkownikÃ³w moÅ¼esz uzyskaÄ‡ **informacje o uÅ¼ytkowniku** za pomocÄ…:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skrypt [**o365creeper**](https://github.com/LMGsec/o365creeper) pozwala rÃ³wnieÅ¼ odkryÄ‡, **czy adres e-mail jest poprawny**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Wymienianie uÅ¼ytkownikÃ³w za pomocÄ… Microsoft Teams**

Kolejnym dobrym ÅºrÃ³dÅ‚em informacji jest Microsoft Teams.

API Microsoft Teams umoÅ¼liwia wyszukiwanie uÅ¼ytkownikÃ³w. W szczegÃ³lnoÅ›ci punkty koÅ„cowe "wyszukiwanie uÅ¼ytkownikÃ³w" **externalsearchv3** i **searchUsers** mogÄ… byÄ‡ uÅ¼ywane do Å¼Ä…dania ogÃ³lnych informacji o kontach uÅ¼ytkownikÃ³w zarejestrowanych w Teams.

W zaleÅ¼noÅ›ci od odpowiedzi API moÅ¼na odrÃ³Å¼niÄ‡ miÄ™dzy nieistniejÄ…cymi uÅ¼ytkownikami a istniejÄ…cymi uÅ¼ytkownikami posiadajÄ…cymi waÅ¼nÄ… subskrypcjÄ™ Teams.

Skrypt [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) moÅ¼e byÄ‡ uÅ¼yty do sprawdzenia okreÅ›lonego zestawu nazw uÅ¼ytkownikÃ³w w stosunku do API Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Nieskategoryzowane: Wyliczanie i PoczÄ…tkowe WejÅ›cie

W tym module omÃ³wimy techniki wyliczania informacji i poczÄ…tkowego dostÄ™pu bez uwierzytelnienia. To obejmuje identyfikacjÄ™ publicznie dostÄ™pnych zasobÃ³w, wykorzystanie niezabezpieczonych interfejsÃ³w API, przeglÄ…danie publicznie dostÄ™pnych repozytoriÃ³w kodu ÅºrÃ³dÅ‚owego, oraz inne techniki pozwalajÄ…ce na zdobycie informacji lub dostÄ™p do systemu bez koniecznoÅ›ci posiadania poprawnych danych uwierzytelniajÄ…cych.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Ponadto istnieje moÅ¼liwoÅ›Ä‡ wyliczenia informacji o dostÄ™pnoÅ›ci istniejÄ…cych uÅ¼ytkownikÃ³w, takich jak:

- DostÄ™pny
- Z dala
- Nie przeszkadzaÄ‡
- ZajÄ™ty
- Offline

JeÅ›li skonfigurowano **wiadomoÅ›Ä‡ o nieobecnoÅ›ci**, moÅ¼liwe jest rÃ³wnieÅ¼ pobranie tej wiadomoÅ›ci za pomocÄ… TeamsEnum. JeÅ›li okreÅ›lono plik wyjÅ›ciowy, wiadomoÅ›ci o nieobecnoÅ›ci sÄ… automatycznie przechowywane w pliku JSON:
```
jq . teamsenum-output.json
```
## Nieuweryfikowana enumeracja i poczÄ…tkowe wejÅ›cie

W przypadku braku autoryzacji, atakujÄ…cy moÅ¼e wykorzystaÄ‡ rÃ³Å¼ne techniki do zbierania informacji i uzyskiwania dostÄ™pu do zasobÃ³w w chmurze. PoniÅ¼ej znajdujÄ… siÄ™ niektÃ³re z tych technik:

### Enumeracja usÅ‚ug

AtakujÄ…cy moÅ¼e przeprowadziÄ‡ enumeracjÄ™ usÅ‚ug chmurowych, takich jak Storage Accounts, Databases, Key Vaults, czy Virtual Machines, aby zebraÄ‡ informacje na temat dostÄ™pnych zasobÃ³w.

### Skanowanie otwartych portÃ³w

WykorzystujÄ…c narzÄ™dzia do skanowania portÃ³w, atakujÄ…cy moÅ¼e identyfikowaÄ‡ otwarte porty na maszynach w chmurze, co moÅ¼e pomÃ³c w okreÅ›leniu potencjalnych wektorÃ³w ataku.

### Analiza konfiguracji

Analiza konfiguracji zasobÃ³w chmurowych moÅ¼e ujawniÄ‡ sÅ‚abe punkty, takie jak niewÅ‚aÅ›ciwe ustawienia uprawnieÅ„ dostÄ™pu czy niezabezpieczone dane, ktÃ³re mogÄ… zostaÄ‡ wykorzystane do uzyskania nieautoryzowanego dostÄ™pu.

### PrÃ³by atakÃ³w sÅ‚ownikowych

AtakujÄ…cy moÅ¼e przeprowadzaÄ‡ prÃ³by atakÃ³w sÅ‚ownikowych na interfejsy API lub panele logowania, aby uzyskaÄ‡ dostÄ™p do kont uÅ¼ytkownikÃ³w lub kluczy API.

### Wykorzystanie luk w zabezpieczeniach

WykorzystujÄ…c znalezione luki w zabezpieczeniach, atakujÄ…cy moÅ¼e zdobyÄ‡ dostÄ™p do poufnych danych lub uzyskaÄ‡ kontrolÄ™ nad zasobami w chmurze.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## UsÅ‚ugi Azure

Teraz, gdy znamy **domeny, ktÃ³rych uÅ¼ywa najemca Azure**, czas sprÃ³bowaÄ‡ znaleÅºÄ‡ **odsÅ‚oniÄ™te usÅ‚ugi Azure**.

MoÅ¼esz skorzystaÄ‡ z metody z [**MicroBust**](https://github.com/NetSPI/MicroBurst) w celu osiÄ…gniÄ™cia tego celu. Ta funkcja bÄ™dzie przeszukiwaÄ‡ nazwÄ™ domeny podstawowej (oraz kilka permutacji) w kilku **domenach usÅ‚ug Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otwarte magazynowanie

MoÅ¼esz odkryÄ‡ otwarte magazynowanie za pomocÄ… narzÄ™dzia takiego jak [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1), ktÃ³re bÄ™dzie uÅ¼ywaÄ‡ pliku **`Microburst/Misc/permitations.txt`** do generowania permutacji (bardzo proste) w celu **znalezienia otwartych kont magazynowych**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

_**WspÃ³lny podpis dostÄ™pu**_ (SAS) to URL, ktÃ³ry **zapewnia dostÄ™p** do okreÅ›lonej czÄ™Å›ci konta Storage (moÅ¼e to byÄ‡ peÅ‚ny kontener, plik...) z okreÅ›lonymi uprawnieniami (odczyt, zapis...) do zasobÃ³w. JeÅ›li znajdziesz wyciekÅ‚y, moÅ¼esz uzyskaÄ‡ dostÄ™p do poufnych informacji, wyglÄ…dajÄ… one tak (to jest dostÄ™p do kontenera, jeÅ›li dotyczyÅ‚ tylko pliku, Å›cieÅ¼ka URL rÃ³wnieÅ¼ zawieraÅ‚aby ten plik):

`https://<nazwa_konta_storage>.blob.core.windows.net/nowykontener?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

UÅ¼yj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), aby uzyskaÄ‡ dostÄ™p do danych

## Skompromitowane Dane Logowania

### Phishing

* [**Powszechne Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (dane logowania lub OAuth App -[Atak Illegitymnej Zgody](az-illicit-consent-grant.md)-)
* [**Phishing Autoryzacji Kodu UrzÄ…dzenia**](az-device-code-authentication-phishing.md)

### Spraying HasÅ‚a / Bruteforce

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## OdnoÅ›niki

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
