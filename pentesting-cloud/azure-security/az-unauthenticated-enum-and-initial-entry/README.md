# Az - Neautentifikovano Enumerisanje & Po캜etni pristup

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Azure Tenant

### Enumeracija Tenanta

Postoje neke **javne Azure API-je** za koje samo poznavanje **domena tenanta** napada캜u omogu캖ava da pretra쬿je vi코e informacija o njemu.\
Mo쬰te direktno pretra쬴vati API ili koristiti PowerShell biblioteku [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Informacije                                                                                                                                                                                                                                           | Funkcija AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacije za prijavljivanje**, uklju캜uju캖i ID tenanta                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Svi domeni** tenanta                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacije za prijavljivanje</strong> tenanta, uklju캜uju캖i ime tenanta i domen <strong>tip autentifikacije.</strong><br>Ako je <code>NameSpaceType</code> <strong><code>Managed</code></strong>, to zna캜i da se koristi <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacije za prijavljivanje, uklju캜uju캖i **informacije o Desktop SSO-u**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

Mo쬰te pretra쬴ti sve informacije o Azure tenantu sa **samo jednom komandom** [**AADInternals**](https://github.com/Gerenios) **biblioteke**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Primer izlaza informacija o Azure zakupcu:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Mogu캖e je posmatrati detalje o imenu zakupca, ID-u i imenu "brenda". Dodatno, prikazan je status Desktop Single Sign-On (SSO), poznat i kao [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Kada je omogu캖ena ova funkcija olak코ava odre캠ivanje prisustva (enumeracije) odre캠enog korisnika unutar ciljne organizacije.

Osim toga, izlaz prikazuje imena svih verifikovanih domena povezanih sa ciljnim zakupcem, zajedno sa njihovim odgovaraju캖im tipovima identiteta. U slu캜aju federiranih domena, potpuno kvalifikovano ime domena (FQDN) identitetskog provajdera koji se koristi, obi캜no ADFS server, tako캠e je otkriveno. Kolona "MX" specificira da li se e-po코ta usmerava ka Exchange Online-u, dok kolona "SPF" ozna캜ava Exchange Online kao po코iljaoca e-po코te. Va쬹o je napomenuti da trenutna funkcija izvi캠anja ne analizira "include" izjave unutar SPF zapisa, 코to mo쬰 rezultirati la쬹im negativima.

### Enumeracija Korisnika

Mogu캖e je **proveriti da li korisni캜ko ime postoji** unutar zakupca. To uklju캜uje i **gostuju캖e korisnike**, 캜ije je korisni캜ko ime u formatu:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Email adresa je korisnikova email adresa gde se simbol "@" zamenjuje sa donjom crtom "\_".

Sa [**AADInternals**](https://github.com/Gerenios/AADInternals), mo쬰te lako proveriti da li korisnik postoji ili ne:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Neautentifikovano nabrajanje i po캜etni ulaz

U ovom scenariju, napada캜 ima pristup Azure Workspace-u, ali nije autentifikovan. Ovo mo쬰 biti zbog neispravne konfiguracije pristupa ili propusta u politikama bezbednosti. Napada캜 mo쬰 iskoristiti ovu situaciju za nabrajanje resursa i eventualno dobiti po캜etni ulaz u sistem.

### Koraci napada:

1. **Nabrajanje resursa**: Napada캜 mo쬰 koristiti alate poput `az` komandne linije ili Azure Portal-a za nabrajanje resursa kao 코to su virtuelne ma코ine, skladi코ta podataka, baze podataka i druge resurse.

2. **Identifikacija osetljivih informacija**: Analizom nabrajanih resursa, napada캜 mo쬰 identifikovati osetljive informacije kao 코to su lozinke, klju캜evi ili druge kriti캜ne informacije.

3. **Eksploatacija propusta**: Na osnovu identifikovanih osetljivih informacija, napada캜 mo쬰 iskoristiti propuste u konfiguraciji ili politikama bezbednosti da bi dobio po캜etni ulaz u sistem.

### Mere za코tite:

- Konfigurisati pravilno pristupne kontrole i politike bezbednosti.
- Redovno proveravati i nadgledati aktivnosti u Azure Workspace-u radi otkrivanja neobi캜nih ili sumnjivih aktivnosti.
- Koristiti vi코efaktorsku autentifikaciju i sna쬹e lozinke za dodatni sloj sigurnosti.
```
UserName         Exists
--------         ------
user@company.com True
```
Mo쬰te tako캠e koristiti tekstualni fajl koji sadr쬴 jednu email adresu po redu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Postoje **tri razli캜ite metode enumeracije** koje mo쬰te odabrati:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Ovo se odnosi na GetCredentialType API pomenut gore. Podrazumevana metoda.                                                                                                                              |
| Prijava    | <p>Ova metoda poku코ava da se prijavi kao korisnik.<br><strong>Napomena:</strong> upiti 캖e biti zabele쬰ni u logovima prijava.</p>                                                                         |
| Autologon | <p>Ova metoda poku코ava da se prijavi kao korisnik putem autologon endpointa.<br><strong>Upiti nisu zabele쬰ni</strong> u logovima prijava! Stoga dobro funkcioni코e i za napade poput prskanja lozinki i napada grubom silom.</p> |

Nakon otkrivanja validnih korisni캜kih imena mo쬰te dobiti **informacije o korisniku** sa:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skripta [**o365creeper**](https://github.com/LMGsec/o365creeper) tako캠e vam omogu캖ava da otkrijete **da li je email validan**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumeracija korisnika putem Microsoft Teams-a**

Jo코 jedan dobar izvor informacija je Microsoft Teams.

API Microsoft Teams-a omogu캖ava pretragu korisnika. Konkretno, endpointovi "externalsearchv3" i "searchUsers" mogu se koristiti za zahtevanje op코tih informacija o korisni캜kim nalozima u Teams-u.

Na osnovu odgovora API-ja mogu캖e je razlikovati nepostoje캖e korisnike od postoje캖ih korisnika koji imaju va쬰캖u pretplatu na Teams.

Skripta [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) mo쬰 se koristiti za proveru datog skupa korisni캜kih imena prema Teams API-ju.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Neautentifikovano nabrajanje i po캜etni ulaz

U ovom scenariju, napada캜 캖e izvr코iti nabrajanje resursa bez autentifikacije i poku코ati da pristupi Azure okru쬰nju.

### Koraci

1. **Nabrajanje resursa bez autentifikacije**: Napada캜 mo쬰 koristiti alate poput `azurerm_resource_group` i `azurerm_virtual_network` za nabrajanje resursa bez potrebe za autentifikacijom.

2. **Poku코aj pristupa Azure okru쬰nju**: Nakon uspe코nog nabrajanja resursa, napada캜 mo쬰 poku코ati da pristupi Azure okru쬰nju kori코캖enjem dobijenih informacija.

### Za코tita

- Konfiguri코ite pravilno pristupne kontrole i autentifikaciju kako biste spre캜ili neovla코캖eni pristup resursima.
- Redovno pratite i analizirajte logove kako biste otkrili sumnjive aktivnosti.
- Edukujte osoblje o bezbednosnim praksama i upozorite ih na potencijalne pretnje.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Tako캠e je mogu캖e nabrojati informacije o dostupnosti postoje캖ih korisnika kao 코to su:

- Dostupan
- Odsutan
- Nemoj ometati
- Zauzet
- Van mre쬰

Ako je konfigurisana **poruka van kancelarije**, tako캠e je mogu캖e preuzeti poruku pomo캖u TeamsEnum-a. Ako je navedena izlazna datoteka, poruke van kancelarije automatski se 캜uvaju u JSON datoteci:
```
jq . teamsenum-output.json
```
## Neautentifikovano nabrajanje i po캜etni ulaz

U ovom scenariju, napada캜 ima pristup Azure Workspace-u, ali nije autentifikovan. Kori코캖enjem razli캜itih tehnika, napada캜 mo쬰 da izvr코i nabrajanje resursa, kao i da prona캠e po캜etni ulaz za dalje istra쬴vanje i napade.

### Nabrajanje resursa

Napada캜 mo쬰 koristiti alate poput `az` komandne linije ili Azure portal-a za nabrajanje resursa kao 코to su virtuelne ma코ine, skladi코ta podataka, baze podataka i druge komponente sistema.

### Pronala쬰nje po캜etnog ulaza

Kori코캖enjem informacija dobijenih tokom nabrajanja resursa, napada캜 mo쬰 identifikovati potencijalne ranjivosti ili slabosti sistema koje mogu biti iskori코캖ene za dalje napade. Na primer, otkrivanje nea쬿riranih softverskih komponenti ili lo코e konfigurisanih resursa mo쬰 omogu캖iti napada캜u da pristupi osetljivim podacima ili da izvr코i druge vrste napada.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Usluge

Sada kada znamo **domene koje Azure zakupac** koristi, vreme je da poku코amo da prona캠emo **izlo쬰ne Azure usluge**.

Mo쬰te koristiti metod iz [**MicroBurst**](https://github.com/NetSPI/MicroBurst) za ovaj cilj. Ova funkcija 캖e pretra쬴ti osnovno ime domena (i nekoliko permutacija) u nekoliko **Azure servisnih domena:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otvoreno skladi코tenje

Mo쬰te otkriti otvoreno skladi코tenje pomo캖u alata poput [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) koji 캖e koristiti datoteku **`Microburst/Misc/permitations.txt`** za generisanje permutacija (vrlo jednostavno) kako bi poku코ao **prona캖i otvorene skladi코ne naloge**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL-ovi

_**URL deljenog pristupa**_ (SAS) je URL koji **omogu캖ava pristup** odre캠enom delu skladi코nog naloga (mo쬰 biti cela kontejner, datoteka...) sa odre캠enim dozvolama (캜itanje, pisanje...) nad resursima. Ako prona캠ete procureli URL, mo쬰te pristupiti osetljivim informacijama, izgledaju ovako (ovo je za pristup kontejneru, ako je samo davao pristup datoteci, putanja URL-a 캖e tako캠e sadr쬬ti tu datoteku):

`https://<ime_skladi코nog_naloga>.blob.core.windows.net/novikontejner?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima

## Kompromitovanje Kredencijala

### Fi코ing

* [**Uobi캜ajeni Fi코ing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (kredencijali ili OAuth aplikacija -[Napad na neovla코캖eno davanje pristanka](az-illicit-consent-grant.md)-)
* [**Fi코ing za autentikaciju ure캠aja koda**](az-device-code-authentication-phishing.md)

### Prskanje lozinki / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Reference

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
