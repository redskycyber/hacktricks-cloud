# Az - æœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œåˆå§‹å…¥å£

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Azureç§Ÿæˆ·

### ç§Ÿæˆ·æšä¸¾

æœ‰ä¸€äº›**å…¬å…±Azure API**ï¼Œåªè¦çŸ¥é“æ”»å‡»è€…å¯ä»¥æŸ¥è¯¢çš„**ç§Ÿæˆ·åŸŸ**ï¼Œå°±å¯ä»¥æŸ¥è¯¢æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯ã€‚\
æ‚¨å¯ä»¥ç›´æ¥æŸ¥è¯¢APIï¼Œæˆ–ä½¿ç”¨PowerShellåº“[**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | ä¿¡æ¯                                                                                                                                                                                                                                           | AADInternalså‡½æ•°                             |
| -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **ç™»å½•ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·ID                                                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | ç§Ÿæˆ·çš„**æ‰€æœ‰åŸŸ**                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>ç§Ÿæˆ·çš„ç™»å½•ä¿¡æ¯</strong>ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·åç§°å’ŒåŸŸå<strong>èº«ä»½éªŒè¯ç±»å‹ã€‚</strong><br>å¦‚æœ<code>NameSpaceType</code>æ˜¯<strong><code>Managed</code></strong>ï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨<strong>AzureAD</strong>ã€‚</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | ç™»å½•ä¿¡æ¯ï¼ŒåŒ…æ‹¬**æ¡Œé¢SSOä¿¡æ¯**                                                                                                                                                                                                                 | `Get-AADIntLoginInformation -UserName <UserName>` |

æ‚¨å¯ä»¥ä½¿ç”¨[**AADInternals**](https://github.com/Gerenios) **åº“çš„ä¸€ä¸ªå‘½ä»¤æŸ¥è¯¢Azureç§Ÿæˆ·çš„æ‰€æœ‰ä¿¡æ¯**ï¼š
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azureç§Ÿæˆ·ä¿¡æ¯çš„è¾“å‡ºç¤ºä¾‹ï¼š
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
å¯ä»¥è§‚å¯Ÿåˆ°ç§Ÿæˆ·çš„åç§°ã€IDå’Œâ€œå“ç‰Œâ€åç§°çš„è¯¦ç»†ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œè¿˜æ˜¾ç¤ºäº†æ¡Œé¢å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰çš„çŠ¶æ€ï¼Œä¹Ÿç§°ä¸º[**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)ã€‚å¯ç”¨æ­¤åŠŸèƒ½æœ‰åŠ©äºç¡®å®šç›®æ ‡ç»„ç»‡ä¸­ç‰¹å®šç”¨æˆ·çš„å­˜åœ¨ï¼ˆæšä¸¾ï¼‰ã€‚

æ­¤å¤–ï¼Œè¾“å‡ºæ˜¾ç¤ºäº†ä¸ç›®æ ‡ç§Ÿæˆ·å…³è”çš„æ‰€æœ‰ç»è¿‡éªŒè¯çš„åŸŸçš„åç§°ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„èº«ä»½ç±»å‹ã€‚å¯¹äºè”åˆåŸŸï¼Œé€šå¸¸ä¼šæŠ«éœ²æ­£åœ¨ä½¿ç”¨çš„èº«ä»½æä¾›è€…çš„å®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª ADFS æœåŠ¡å™¨ã€‚"MX" åˆ—æŒ‡å®šç”µå­é‚®ä»¶æ˜¯å¦è·¯ç”±åˆ° Exchange Onlineï¼Œè€Œ "SPF" åˆ—è¡¨ç¤º Exchange Online ä½œä¸ºç”µå­é‚®ä»¶å‘ä»¶äººçš„åˆ—è¡¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“å‰çš„ä¾¦å¯ŸåŠŸèƒ½ä¸è§£æ SPF è®°å½•ä¸­çš„ "include" è¯­å¥ï¼Œè¿™å¯èƒ½å¯¼è‡´è¯¯æŠ¥ã€‚

### ç”¨æˆ·æšä¸¾

å¯ä»¥**æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨**åœ¨ç§Ÿæˆ·å†…ã€‚è¿™ä¹ŸåŒ…æ‹¬**è®¿å®¢ç”¨æˆ·**ï¼Œå…¶ç”¨æˆ·åæ ¼å¼ä¸ºï¼š
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
é‚®ç®±æ˜¯ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ï¼Œåœ¨â€œ@â€å¤„ç”¨ä¸‹åˆ’çº¿â€œ\_â€æ›¿æ¢ã€‚

ä½¿ç”¨[**AADInternals**](https://github.com/Gerenios/AADInternals)ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## æœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œåˆå§‹å…¥å£

åœ¨è¿›è¡Œäº‘å®‰å…¨æ¸—é€æµ‹è¯•æ—¶ï¼Œæœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œåˆå§‹å…¥å£æ˜¯ä¸€ä¸ªé‡è¦çš„æ­¥éª¤ã€‚é€šè¿‡è¯†åˆ«ç›®æ ‡ç³»ç»Ÿä¸­å¯èƒ½å­˜åœ¨çš„æ¼æ´å’Œå¼±ç‚¹ï¼Œé»‘å®¢å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯æ¥è·å–æœªç»æˆæƒè®¿é—®æƒé™ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æŠ€æœ¯å’Œæ–¹æ³•ï¼Œå¯ç”¨äºæ‰§è¡Œæœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œè·å–åˆå§‹å…¥å£ï¼š

### æœªç»èº«ä»½éªŒè¯çš„æšä¸¾

- **æœåŠ¡å‘ç°**ï¼šä½¿ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥è¯†åˆ«ç›®æ ‡ç³»ç»Ÿä¸Šè¿è¡Œçš„æœåŠ¡å’Œåº”ç”¨ç¨‹åºã€‚
- **æ•æ„Ÿæ–‡ä»¶å’Œç›®å½•æ‰«æ**ï¼šæ‰«æç³»ç»Ÿä»¥æŸ¥æ‰¾å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶å’Œç›®å½•ã€‚
- **é»˜è®¤å‡­è¯**ï¼šå°è¯•ä½¿ç”¨å¸¸è§çš„é»˜è®¤å‡­è¯æ¥è®¿é—®ç³»ç»Ÿï¼Œä¾‹å¦‚admin/adminã€root/rootç­‰ã€‚
- **å…¬å¼€ä¿¡æ¯æ”¶é›†**ï¼šæœç´¢äº’è”ç½‘å’Œå…¬å¼€æ¥æºï¼ŒæŸ¥æ‰¾ä¸ç›®æ ‡ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ã€‚

### åˆå§‹å…¥å£

- **å¼±å¯†ç æ”»å‡»**ï¼šä½¿ç”¨æš´åŠ›ç ´è§£æˆ–å¯†ç å­—å…¸æ”»å‡»æ¥ç ´è§£å¼±å¯†ç ã€‚
- **ç¤¾ä¼šå·¥ç¨‹å­¦**ï¼šé€šè¿‡æ¬ºéª—ç”¨æˆ·æˆ–å‘˜å·¥æ¥è·å–è®¿é—®æƒé™ï¼Œä¾‹å¦‚é’“é±¼æ”»å‡»ã€‚
- **æ¼æ´åˆ©ç”¨**ï¼šåˆ©ç”¨å·²çŸ¥çš„æ¼æ´æ¥è·å–ç³»ç»Ÿè®¿é—®æƒé™ã€‚
- **åé—¨å®‰è£…**ï¼šåœ¨ç³»ç»Ÿä¸­å®‰è£…åé—¨ï¼Œä»¥ä¾¿åœ¨æœªæ¥è®¿é—®ç³»ç»Ÿã€‚

åœ¨æ‰§è¡Œæœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œè·å–åˆå§‹å…¥å£æ—¶ï¼Œé»‘å®¢éœ€è¦è°¨æ…è¡Œäº‹ï¼Œä»¥é¿å…è¢«æ£€æµ‹åˆ°å¹¶è§¦å‘å®‰å…¨è­¦æŠ¥ã€‚
```
UserName         Exists
--------         ------
user@company.com True
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ¯è¡ŒåŒ…å«ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€çš„æ–‡æœ¬æ–‡ä»¶ï¼š
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
æœ‰**ä¸‰ç§ä¸åŒçš„æšä¸¾æ–¹æ³•**å¯ä¾›é€‰æ‹©ï¼š

| æ–¹æ³•       | æè¿°                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æ­£å¸¸       | è¿™æ˜¯æŒ‡ä¸Šé¢æåˆ°çš„GetCredentialType APIã€‚é»˜è®¤æ–¹æ³•ã€‚                                                                                                                           |
| ç™»å½•       | <p>æ­¤æ–¹æ³•å°è¯•ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æ³¨æ„ï¼š</strong>æŸ¥è¯¢å°†è®°å½•åœ¨ç™»å½•æ—¥å¿—ä¸­ã€‚</p>                                                                                       |
| è‡ªåŠ¨ç™»å½•    | <p>æ­¤æ–¹æ³•å°è¯•é€šè¿‡è‡ªåŠ¨ç™»å½•ç«¯ç‚¹ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æŸ¥è¯¢ä¸ä¼š</strong>è®°å½•åœ¨ç™»å½•æ—¥å¿—ä¸­ï¼å› æ­¤ï¼Œä¹Ÿé€‚ç”¨äºå¯†ç å–·æ´’å’Œæš´åŠ›æ”»å‡»ã€‚</p> |

å‘ç°æœ‰æ•ˆç”¨æˆ·ååï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è·å–**æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯**ï¼š
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
è„šæœ¬ [**o365creeper**](https://github.com/LMGsec/o365creeper) ä¹Ÿå…è®¸æ‚¨å‘ç°**ç”µå­é‚®ä»¶æ˜¯å¦æœ‰æ•ˆ**ã€‚
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure æœåŠ¡

ç°åœ¨æˆ‘ä»¬çŸ¥é“ Azure ç§Ÿæˆ·æ­£åœ¨ä½¿ç”¨çš„**åŸŸ**ï¼Œæ˜¯æ—¶å€™å°è¯•æ‰¾åˆ°**æš´éœ²çš„ Azure æœåŠ¡**äº†ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨[**MicroBust**](https://github.com/NetSPI/MicroBurst)ä¸­çš„ä¸€ç§æ–¹æ³•æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚æ­¤åŠŸèƒ½å°†åœ¨å‡ ä¸ª**Azure æœåŠ¡åŸŸ**ä¸­æœç´¢åŸºæœ¬åŸŸåï¼ˆä»¥åŠä¸€äº›æ’åˆ—ç»„åˆï¼‰ã€‚
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## å¼€æ”¾å­˜å‚¨

æ‚¨å¯ä»¥ä½¿ç”¨è¯¸å¦‚[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)ä¹‹ç±»çš„å·¥å…·ï¼Œè¯¥å·¥å…·å°†ä½¿ç”¨æ–‡ä»¶**`Microburst/Misc/permitations.txt`**ç”Ÿæˆæ’åˆ—ç»„åˆï¼ˆéå¸¸ç®€å•ï¼‰ï¼Œä»¥å°è¯•**æŸ¥æ‰¾å¼€æ”¾çš„å­˜å‚¨è´¦æˆ·**ã€‚
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

ä¸€ä¸ª**å…±äº«è®¿é—®ç­¾å**ï¼ˆSASï¼‰URLæ˜¯ä¸€ä¸ªURLï¼Œ**æä¾›å¯¹å­˜å‚¨è´¦æˆ·çš„æŸä¸ªéƒ¨åˆ†çš„è®¿é—®æƒé™**ï¼ˆå¯ä»¥æ˜¯å®Œæ•´çš„å®¹å™¨ã€ä¸€ä¸ªæ–‡ä»¶...ï¼‰ï¼Œå…·æœ‰ä¸€äº›ç‰¹å®šçš„æƒé™ï¼ˆè¯»å–ã€å†™å…¥...ï¼‰æ¥è®¿é—®èµ„æºã€‚å¦‚æœå‘ç°æ³„éœ²äº†ä¸€ä¸ªè¿™æ ·çš„URLï¼Œä½ å¯èƒ½èƒ½å¤Ÿè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ï¼Œå®ƒä»¬çœ‹èµ·æ¥åƒè¿™æ ·ï¼ˆè¿™æ˜¯ç”¨äºè®¿é—®ä¸€ä¸ªå®¹å™¨çš„ï¼Œå¦‚æœåªæ˜¯æˆäºˆå¯¹æ–‡ä»¶çš„è®¿é—®æƒé™ï¼ŒURLçš„è·¯å¾„ä¹Ÿå°†åŒ…å«è¯¥æ–‡ä»¶ï¼‰ï¼š

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

ä½¿ç”¨[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)æ¥è®¿é—®æ•°æ®

## å±å®³å‡­è¯

### é’“é±¼

* [**å¸¸è§é’“é±¼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)ï¼ˆå‡­è¯æˆ–OAuthåº”ç”¨ -[éæ³•åŒæ„æˆäºˆæ”»å‡»](az-illicit-consent-grant.md)-ï¼‰
* [**è®¾å¤‡ä»£ç è®¤è¯** é’“é±¼](az-device-code-authentication-phishing.md)

### å¯†ç å–·æ´’ / æš´åŠ›ç ´è§£

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
