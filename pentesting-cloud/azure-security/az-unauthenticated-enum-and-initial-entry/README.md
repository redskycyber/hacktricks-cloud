# Az - Enumeraci贸n no autenticada y entrada inicial

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inquilino de Azure

### Enumeraci贸n de inquilinos

Hay algunas **API p煤blicas de Azure** que, solo conociendo el **dominio del inquilino**, un atacante podr铆a consultar para recopilar m谩s informaci贸n sobre 茅l.\
Puede consultar directamente la API o utilizar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informaci贸n                                                                                   | Funci贸n AADInternals                             |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informaci贸n de inicio de sesi贸n**, incluido el ID del inquilino                                | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del inquilino                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **Informaci贸n de inicio de sesi贸n** del inquilino, incluido el nombre del inquilino y el **tipo de autenticaci贸n de dominio** | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informaci贸n de inicio de sesi贸n, incluida la **informaci贸n de SSO de escritorio**               | `Get-AADIntLoginInformation -UserName <UserName>` |

Puede consultar toda la informaci贸n de un inquilino de Azure con **solo un comando de la** biblioteca [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```

Ejemplo de salida de informaci贸n del inquilino de Azure:

```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```

A partir de la salida, podemos ver la informaci贸n del inquilino de la organizaci贸n objetivo, incluido el nombre del inquilino, el ID y el nombre de la "marca". Tambi茅n podemos ver si se habilit贸 el **SSO de escritorio (tambi茅n conocido como** [**SSO sin interrupciones**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**)**. Si est谩 habilitado, podemos averiguar si un usuario determinado existe en la organizaci贸n objetivo o no (enumeraci贸n de usuarios).

Tambi茅n podemos ver los nombres de todos los dominios (verificados) y sus tipos de identidad del inquilino objetivo. Para los dominios federados, tambi茅n se muestra el FQDN del proveedor de identidad utilizado (generalmente el servidor ADFS). La columna MX indica si el correo electr贸nico se env铆a a Exchange en l铆nea o no. La columna SPF indica si Exchange en l铆nea est谩 incluido como remitente de correo electr贸nico. **隆Nota!** Actualmente, la funci贸n de reconocimiento no sigue las declaraciones de inclusi贸n de registros SPF, por lo que puede haber falsos negativos.

### Enumeraci贸n de usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto tambi茅n incluye a los **usuarios invitados**, cuyo nombre de usuario tiene el siguiente formato:

```
<email>#EXT#@<tenant name>.onmicrosoft.com
```

El correo electr贸nico es la direcci贸n de correo electr贸nico del usuario donde "@" se reemplaza por gui贸n bajo "_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puede verificar f谩cilmente si el usuario existe o no:

```powershell
# Verificar si el usuario existe
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```

Salida:

```
UserName         Exists
--------         ------
user@company.com True
```

Tambi茅n puede usar un archivo de texto que contenga una direcci贸n de correo electr贸nico por fila:

```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invocar la enumeraci贸n de usuarios
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```

Hay **tres m茅todos de enumeraci贸n diferentes** para elegir:

| M茅todo    | Descripci贸n                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Esto se refiere a la API GetCredentialType mencionada anteriormente.