# Az - Neautentifikovano nabrojavanje i po캜etni unos

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Azure Tenant

### Nabrojavanje tenanta

Postoje neki **javni Azure API-ji** za koje samo poznavanje **domena tenanta** napada캜u omogu캖ava da pretra쬿je vi코e informacija o njemu.\
Mo쬰te direktno pretra쬴vati API ili koristiti PowerShell biblioteku [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informacije                                                                                                                                                                                                                                           | AADInternals funkcija                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacije o prijavi**, uklju캜uju캖i ID tenanta                                                                                                                                                                                                            | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Svi domeni** tenanta                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacije o prijavi</strong> tenanta, uklju캜uju캖i ime tenanta i domen <strong>tipa autentifikacije.</strong><br>Ako je <code>NameSpaceType</code> <strong><code>Managed</code></strong>, to zna캜i da se koristi <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacije o prijavi, uklju캜uju캖i **informacije o Desktop SSO-u**                                                                                                                                                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

Mo쬰te pretra쬴ti sve informacije o Azure tenantu sa **samo jednom komandom** [**AADInternals**](https://github.com/Gerenios/AADInternals) **biblioteke**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Primer izlaza informacija o Azure zakupcu:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Mogu캖e je posmatrati detalje o imenu, ID-u i "brend" imenu zakupca. Dodatno, prikazan je status Desktop Single Sign-On (SSO), poznat i kao [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Kada je omogu캖ena, ova funkcija olak코ava odre캠ivanje prisustva (enumeracije) odre캠enog korisnika unutar ciljne organizacije.

Osim toga, izlaz prikazuje imena svih verifikovanih domena povezanih sa ciljnim zakupcem, zajedno sa njihovim odgovaraju캖im tipovima identiteta. U slu캜aju federativnih domena, tako캠e se otkriva Potpuno kvalifikovano ime domena (FQDN) identitetskog provajdera koji se koristi, obi캜no ADFS servera. Kolona "MX" ozna캜ava da li se e-po코ta usmerava ka Exchange Online-u, dok kolona "SPF" ozna캜ava da li je Exchange Online naveden kao po코iljalac e-po코te. Va쬹o je napomenuti da trenutna funkcija izvi캠anja ne analizira "include" izjave unutar SPF zapisa, 코to mo쬰 rezultirati la쬹im negativima.

### Enumeracija korisnika

Mogu캖e je **proveriti da li korisni캜ko ime postoji** unutar zakupca. Ovo uklju캜uje i **gostuju캖e korisnike**, 캜ije korisni캜ko ime ima slede캖i format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Email adresa je korisni캜ka email adresa gde se znak "@" zamenjuje sa donjom crtom "\_".

Sa [**AADInternals**](https://github.com/Gerenios/AADInternals) alatom, mo쬰te lako proveriti da li korisnik postoji ili ne:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Az unauthenticated enum and initial entry

Ovde 캖emo razmotriti neke tehnike za izvr코avanje neautentifikovane enumeracije i inicijalnog ulaska u Azure okru쬰nje.

## 1. Enumeracija Azure Workspace-ova

Da biste izvr코ili enumeraciju Azure Workspace-ova, mo쬰te koristiti slede캖e metode:

- **DNS enumeracija**: Koristite alate poput `dnsrecon` ili `dnsenum` za pronala쬰nje poddomena Workspace-a.
- **Whois enumeracija**: Koristite `whois` alat za pronala쬰nje informacija o vlasniku domena i drugim relevantnim podacima.
- **Google Hacking**: Koristite Google pretragu sa odgovaraju캖im klju캜nim re캜ima kako biste prona코li javno dostupne informacije o Workspace-ovima.

## 2. Pronala쬰nje neza코ti캖enih Azure Storage kontejnera

Da biste prona코li neza코ti캖ene Azure Storage kontejnere, mo쬰te koristiti slede캖e metode:

- **Azure Storage Explorer**: Koristite Azure Storage Explorer za pregled i pronala쬰nje neza코ti캖enih kontejnera.
- **Azure CLI**: Koristite Azure CLI komandu `az storage container list` za pronala쬰nje svih kontejnera u okviru odre캠enog Storage naloga.
- **Automatizovani alati**: Koristite alate poput `azurite` ili `azurite-scan` za automatsko skeniranje Azure Storage naloga i pronala쬰nje neza코ti캖enih kontejnera.

## 3. Pronala쬰nje neza코ti캖enih Azure Key Vault-ova

Da biste prona코li neza코ti캖ene Azure Key Vault-ove, mo쬰te koristiti slede캖e metode:

- **Azure Portal**: Pregledajte Azure Portal kako biste prona코li neza코ti캖ene Key Vault-ove.
- **Azure CLI**: Koristite Azure CLI komandu `az keyvault list` za pronala쬰nje svih Key Vault-ova u okviru odre캠enog Azure naloga.
- **Automatizovani alati**: Koristite alate poput `azurite` ili `azurite-scan` za automatsko skeniranje Azure naloga i pronala쬰nje neza코ti캖enih Key Vault-ova.

## 4. Pronala쬰nje neza코ti캖enih Azure SQL baza podataka

Da biste prona코li neza코ti캖ene Azure SQL baze podataka, mo쬰te koristiti slede캖e metode:

- **Azure Portal**: Pregledajte Azure Portal kako biste prona코li neza코ti캖ene SQL baze podataka.
- **Azure CLI**: Koristite Azure CLI komandu `az sql server list` za pronala쬰nje svih SQL servera u okviru odre캠enog Azure naloga.
- **Automatizovani alati**: Koristite alate poput `azurite` ili `azurite-scan` za automatsko skeniranje Azure naloga i pronala쬰nje neza코ti캖enih SQL baza podataka.

## 5. Pronala쬰nje neza코ti캖enih Azure Cosmos DB baza podataka

Da biste prona코li neza코ti캖ene Azure Cosmos DB baze podataka, mo쬰te koristiti slede캖e metode:

- **Azure Portal**: Pregledajte Azure Portal kako biste prona코li neza코ti캖ene Cosmos DB baze podataka.
- **Azure CLI**: Koristite Azure CLI komandu `az cosmosdb list` za pronala쬰nje svih Cosmos DB naloga u okviru odre캠enog Azure naloga.
- **Automatizovani alati**: Koristite alate poput `azurite` ili `azurite-scan` za automatsko skeniranje Azure naloga i pronala쬰nje neza코ti캖enih Cosmos DB baza podataka.
```
UserName         Exists
--------         ------
user@company.com True
```
Mo쬰te koristiti tekstualni fajl koji sadr쬴 jednu email adresu po redu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Postoje **tri razli캜ite metode enumeracije** koje mo쬰te odabrati:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Ovo se odnosi na API GetCredentialType koji je pomenut gore. Podrazumevana metoda.                                                                                                                      |
| Prijava    | <p>Ova metoda poku코ava da se prijavi kao korisnik.<br><strong>Napomena:</strong> upiti 캖e biti zabele쬰ni u logovima prijava.</p>                                                                         |
| Autologon  | <p>Ova metoda poku코ava da se prijavi kao korisnik putem autologon endpointa.<br><strong>Upiti nisu zabele쬰ni</strong> u logovima prijava! Zbog toga dobro funkcioni코e i za napade poput prskanja lozinki i brute-force napada.</p> |

Nakon otkrivanja validnih korisni캜kih imena, mo쬰te dobiti **informacije o korisniku** pomo캖u:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skripta [**o365creeper**](https://github.com/LMGsec/o365creeper) tako캠e vam omogu캖ava da otkrijete **da li je email validan**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure usluge

Sada kada znamo **domene koje Azure zakupac** koristi, vreme je da poku코amo da prona캠emo **izlo쬰ne Azure usluge**.

Mo쬰te koristiti metod iz [**MicroBurst**](https://github.com/NetSPI/MicroBurst) za ovaj cilj. Ova funkcija 캖e pretra쬴vati osnovno ime domene (i nekoliko permutacija) u nekoliko **Azure domena usluga:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otvoreno skladi코te

Mo쬰te otkriti otvoreno skladi코te pomo캖u alata kao 코to je [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) koji 캖e koristiti datoteku **`Microburst/Misc/permitations.txt`** za generisanje permutacija (vrlo jednostavno) kako bi poku코ao **prona캖i otvorene naloge za skladi코tenje**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URL-ovi

_**URL sa deljenim pristupnim potpisom**_ (SAS) je URL koji **omogu캖ava pristup** odre캠enom delu skladi코nog naloga (mo쬰 biti cela kontejner, datoteka...) sa odre캠enim dozvolama (캜itanje, pisanje...) nad resursima. Ako prona캠ete procureli URL, mo쬰te imati pristup osetljivim informacijama. Izgledaju ovako (ovo je primer za pristup kontejneru, ako bi pristup bio samo datoteci, putanja URL-a bi tako캠e sadr쬬vala tu datoteku):

`https://<naziv_skladi코nog_naloga>.blob.core.windows.net/novi_kontejner?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima.

## Kompromitovanje akreditacija

### Fi코ing

* [**Uobi캜ajeni fi코ing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (akreditacije ili OAuth aplikacija -[Napad sa neovla코캖enim pristankom](az-illicit-consent-grant.md)-)
* [**Fi코ing autentifikacije ure캠aja**](az-device-code-authentication-phishing.md)

### Prskanje lozinki / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Reference

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od po캜etnika do stru캜njaka sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **ogla코avanje va코e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
