# Az - Nicht authentifizierte Enumeration & Erstzugriff

<details>

<summary><strong>Erlernen Sie das Hacken von AWS von Null auf Heldenniveau mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories senden**.

</details>

## Azure-Mandant

### Mandanten-Enumeration

Es gibt einige **√∂ffentliche Azure-APIs**, die ein Angreifer nur durch Kenntnis der **Dom√§ne des Mandanten** abfragen k√∂nnte, um weitere Informationen dar√ºber zu sammeln.\
Sie k√∂nnen die API direkt abfragen oder die PowerShell-Bibliothek [**AADInternals**](https://github.com/Gerenios/AADInternals)** verwenden:**

| API                                                                  | Informationen                                                                                                                                                                                                                                           | AADInternals-Funktion                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Anmeldeinformationen**, einschlie√ülich Mandanten-ID                                                                                                                                                                                                   | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Alle Dom√§nen** des Mandanten                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Anmeldeinformationen</strong> des Mandanten, einschlie√ülich Mandantenname und Dom√§ne <strong>Authentifizierungstyp.</strong><br>Wenn <code>NameSpaceType</code> <strong><code>Managed</code></strong> ist, bedeutet dies, dass <strong>AzureAD</strong> verwendet wird.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Anmeldeinformationen, einschlie√ülich **Desktop SSO-Informationen**                                                                                                                                                                                     | `Get-AADIntLoginInformation -UserName <UserName>` |

Sie k√∂nnen alle Informationen eines Azure-Mandanten mit **nur einem Befehl der** [**AADInternals**](https://github.com/Gerenios/AADInternals) **Bibliothek abfragen**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Beispiel f√ºr die Ausgabe der Azure-Mandanteninformationen:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Es ist m√∂glich, Details zum Namen, zur ID und zum "Markennamen" des Mandanten zu beobachten. Dar√ºber hinaus wird der Status des Desktop Single Sign-On (SSO), auch bekannt als [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), angezeigt. Wenn diese Funktion aktiviert ist, erleichtert sie die Bestimmung der Anwesenheit (Aufz√§hlung) eines bestimmten Benutzers innerhalb der Zielorganisation.

Dar√ºber hinaus zeigt die Ausgabe die Namen aller √ºberpr√ºften Dom√§nen an, die mit dem Zielmandanten verbunden sind, zusammen mit ihren jeweiligen Identit√§tstypen. Im Fall von f√∂derierten Dom√§nen wird auch der vollst√§ndig qualifizierte Dom√§nenname (FQDN) des verwendeten Identit√§tsanbieters, in der Regel ein ADFS-Server, offengelegt. Die Spalte "MX" gibt an, ob E-Mails an Exchange Online weitergeleitet werden, w√§hrend die Spalte "SPF" die Auflistung von Exchange Online als E-Mail-Absender angibt. Es ist wichtig zu beachten, dass die aktuelle Aufkl√§rungsfunktion die "include"-Anweisungen innerhalb von SPF-Eintr√§gen nicht analysiert, was zu falschen Negativen f√ºhren kann.

### Benutzer-Aufz√§hlung

Es ist m√∂glich zu **√ºberpr√ºfen, ob ein Benutzername** innerhalb eines Mandanten existiert. Dies umfasst auch **Gastbenutzer**, deren Benutzername im Format vorliegt:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Die E-Mail ist die E-Mail-Adresse des Benutzers, bei der das "@" durch einen Unterstrich "_" ersetzt wird.

Mit [**AADInternals**](https://github.com/Gerenios/AADInternals) k√∂nnen Sie einfach √ºberpr√ºfen, ob der Benutzer existiert oder nicht:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Nicht authentifizierte Enumeration und Erstzugriff

In diesem Abschnitt werden verschiedene nicht authentifizierte Angriffstechniken beschrieben, die von Angreifern verwendet werden k√∂nnen, um Informationen zu sammeln und den Einstiegspunkt in Azure-Ressourcen zu identifizieren. Diese Techniken k√∂nnen dazu beitragen, Schwachstellen in der Konfiguration aufzudecken und Sicherheitsl√ºcken zu identifizieren, die es einem Angreifer erm√∂glichen k√∂nnten, Zugriff auf Azure-Ressourcen zu erlangen.
```
UserName         Exists
--------         ------
user@company.com True
```
Du kannst auch eine Textdatei verwenden, die eine E-Mail-Adresse pro Zeile enth√§lt:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Es gibt **drei verschiedene Aufz√§hlungsmethoden**, aus denen Sie w√§hlen k√∂nnen:

| Methode    | Beschreibung                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Dies bezieht sich auf die oben erw√§hnte GetCredentialType-API. Die Standardmethode.                                                                                                                           |
| Login     | <p>Diese Methode versucht, sich als Benutzer anzumelden.<br><strong>Hinweis:</strong> Abfragen werden im Anmeldeprotokoll protokolliert.</p>                                                                                       |
| Autologon | <p>Diese Methode versucht, sich als Benutzer √ºber den Autologon-Endpunkt anzumelden.<br><strong>Abfragen werden nicht protokolliert</strong> im Anmeldeprotokoll! Funktioniert daher auch gut f√ºr Passwort-Spray- und Brute-Force-Angriffe.</p> |

Nachdem Sie die g√ºltigen Benutzernamen entdeckt haben, k√∂nnen Sie **Informationen √ºber einen Benutzer** erhalten:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Das Skript [**o365creeper**](https://github.com/LMGsec/o365creeper) erm√∂glicht es auch, herauszufinden, **ob eine E-Mail g√ºltig ist**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Benutzerenumerierung √ºber Microsoft Teams**

Eine weitere gute Informationsquelle ist Microsoft Teams.

Die API von Microsoft Teams erm√∂glicht die Suche nach Benutzern. Insbesondere die Endpunkte "externalsearchv3" und "searchUsers" k√∂nnten verwendet werden, um allgemeine Informationen √ºber Teams-registrierte Benutzerkonten abzurufen.

Je nach API-Antwort ist es m√∂glich, zwischen nicht vorhandenen Benutzern und vorhandenen Benutzern mit g√ºltigem Teams-Abonnement zu unterscheiden.

Das Skript [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) k√∂nnte verwendet werden, um einen bestimmten Satz von Benutzernamen gegen die Teams-API zu validieren.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Nicht authentifizierte Enumeration und Erstzugriff

In diesem Abschnitt werden verschiedene nicht authentifizierte Techniken zur Informationsgewinnung und zum Erstzugriff auf Azure-Ressourcen behandelt.

### Nicht authentifizierte Enumeration

#### 1. Azure-AD-Enumeration

Azure AD Connect Discovery kann verwendet werden, um Benutzer, Gruppen und Computer im Azure AD zu enumerieren.

```bash
adfind -b "CN=Users,DC=domain,DC=com" -f "objectcategory=person" -list
```

#### 2. Azure-AD-Gruppenmitgliedschaft

Die Mitgliedschaft in Azure AD-Gruppen kann mit dem Tool `Get-AzureADGroupMember` √ºberpr√ºft werden.

```bash
Get-AzureADGroupMember -ObjectId <group_object_id>
```

### Erstzugriff

#### 1. Azure-VM-Initialzugriff

Bei Azure-VMs kann der Zugriff √ºber RDP oder SSH erlangt werden, wenn die entsprechenden Ports ge√∂ffnet sind.

```bash
ssh user@<azure_vm_ip>
```

#### 2. Azure-Storage-Konto√ºbernahme

Durch die √úbernahme eines Azure-Storage-Kontos kann auf gespeicherte Daten zugegriffen werden.

```bash
azcopy copy "https://<source_storage_account>.blob.core.windows.net/<container>/<file>" "<destination_file>"
```
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Dar√ºber hinaus ist es m√∂glich, Verf√ºgbarkeitsinformationen √ºber vorhandene Benutzer wie folgt aufzulisten:

- Verf√ºgbar
- Abwesend
- Bitte nicht st√∂ren
- Besch√§ftigt
- Offline

Wenn eine **Abwesenheitsnachricht** konfiguriert ist, ist es auch m√∂glich, die Nachricht mithilfe von TeamsEnum abzurufen. Wenn eine Ausgabedatei angegeben wurde, werden die Abwesenheitsnachrichten automatisch in der JSON-Datei gespeichert:
```
jq . teamsenum-output.json
```
## Nicht authentifizierte Enumeration und Erstzugriff

In diesem Abschnitt werden wir uns damit befassen, wie wir nicht authentifizierte Informationen √ºber die Zielsysteme sammeln k√∂nnen, um einen ersten Zugriff zu erhalten. Wir werden verschiedene Techniken und Tools verwenden, um Schwachstellen zu identifizieren und potenzielle Angriffspunkte zu erkennen. Es ist wichtig zu beachten, dass diese Techniken nur in autorisierten Tests anzuwenden sind und die Zustimmung des Eigent√ºmers des Zielsystems erforderlich ist.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure-Dienste

Nun, da wir die **Dom√§nen des Azure-Mandanten** kennen, ist es an der Zeit, zu versuchen, **exponierte Azure-Dienste zu finden**.

Sie k√∂nnen eine Methode aus [**MicroBust**](https://github.com/NetSPI/MicroBurst) f√ºr dieses Ziel verwenden. Diese Funktion wird den Basisdom√§nennamen (und ein paar Permutationen) in mehreren **Azure-Dienst-Dom√§nen** suchen:
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Offener Speicher

Sie k√∂nnten offenen Speicher mit einem Tool wie [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) entdecken, das die Datei **`Microburst/Misc/permitations.txt`** verwendet, um Permutationen (sehr einfach) zu generieren, um zu versuchen, **offene Speicherkonten zu finden**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

Ein _**Shared Access Signature**_ (SAS) URL ist eine URL, die **Zugriff** auf einen bestimmten Teil eines Speicherkontos (k√∂nnte ein vollst√§ndiger Container, eine Datei usw. sein) mit bestimmten Berechtigungen (Lesen, Schreiben usw.) √ºber die Ressourcen gew√§hrt. Wenn Sie einen solchen URL finden, der √∂ffentlich zug√§nglich ist, k√∂nnten Sie auf sensible Informationen zugreifen. Sie sehen so aus (um auf einen Container zuzugreifen, wenn der Zugriff nur auf eine Datei gew√§hrt wurde, w√ºrde der Pfad der URL auch diese Datei enthalten):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Verwenden Sie [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), um auf die Daten zuzugreifen

## Zugangsdaten kompromittieren

### Phishing

* [**G√§ngiges Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (Zugangsdaten oder OAuth-App -[Illicit Consent Grant Attack](az-illicit-consent-grant.md)-)
* [**Phishing mit Ger√§tecode-Authentifizierung**](az-device-code-authentication-phishing.md)

### Passwort-Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referenzen

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
