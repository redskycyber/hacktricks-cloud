# Az - æœªç»èº«ä»½éªŒè¯çš„æšä¸¾å’Œåˆå§‹å…¥å£

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Azure ç§Ÿæˆ·

### ç§Ÿæˆ·æšä¸¾

æœ‰ä¸€äº›**å…¬å…± Azure API**ï¼Œåªè¦çŸ¥é“**ç§Ÿæˆ·çš„åŸŸå**ï¼Œæ”»å‡»è€…å°±å¯ä»¥æŸ¥è¯¢æ›´å¤šå…³äºç§Ÿæˆ·çš„ä¿¡æ¯ã€‚\
æ‚¨å¯ä»¥ç›´æ¥æŸ¥è¯¢ API æˆ–ä½¿ç”¨ PowerShell åº“ [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | ä¿¡æ¯                                                                                         | AADInternals å‡½æ•°                                 |
| -------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **ç™»å½•ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ç§Ÿæˆ· ID                                                                   | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover.s.outlook.com/autodiscover/autodiscover.svc             | ç§Ÿæˆ·çš„**æ‰€æœ‰åŸŸå**                                                                             | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | ç§Ÿæˆ·çš„**ç™»å½•ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·åç§°å’ŒåŸŸå**èº«ä»½éªŒè¯ç±»å‹**                                         | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | ç™»å½•ä¿¡æ¯ï¼ŒåŒ…æ‹¬**æ¡Œé¢ SSO ä¿¡æ¯**                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

æ‚¨å¯ä»¥ä½¿ç”¨ [**AADInternals**](https://github.com/Gerenios/AADInternals) **åº“çš„ä¸€ä¸ªå‘½ä»¤**æŸ¥è¯¢ Azure ç§Ÿæˆ·çš„æ‰€æœ‰ä¿¡æ¯ï¼š
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azureç§Ÿæˆ·ä¿¡æ¯çš„è¾“å‡ºç¤ºä¾‹ï¼š

```plaintext
Tenant ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Tenant Name: My Azure Tenant
```

```plaintext
ç§Ÿæˆ·IDï¼šxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ç§Ÿæˆ·åç§°ï¼šæˆ‘çš„Azureç§Ÿæˆ·
```
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
ä»è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›®æ ‡ç»„ç»‡çš„ç§Ÿæˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç§Ÿæˆ·åç§°ã€IDå’Œâ€œå“ç‰Œâ€åç§°ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°**æ˜¯å¦å¯ç”¨äº†æ¡Œé¢SSOï¼ˆä¹Ÿç§°ä¸º**[**æ— ç¼SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**ï¼‰**ã€‚å¦‚æœå¯ç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šç»™å®šçš„ç”¨æˆ·æ˜¯å¦å­˜åœ¨äºç›®æ ‡ç»„ç»‡ä¸­ï¼ˆç”¨æˆ·æšä¸¾ï¼‰ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ç›®æ ‡ç§Ÿæˆ·çš„æ‰€æœ‰ï¼ˆå·²éªŒè¯ï¼‰åŸŸçš„åç§°å’Œèº«ä»½ç±»å‹ã€‚å¯¹äºè”åˆåŸŸï¼Œè¿˜æ˜¾ç¤ºäº†æ‰€ä½¿ç”¨èº«ä»½æä¾›è€…çš„FQDNï¼ˆé€šå¸¸æ˜¯ADFSæœåŠ¡å™¨ï¼‰ã€‚MXåˆ—æŒ‡ç¤ºé‚®ä»¶æ˜¯å¦å‘é€åˆ°Exchange Onlineã€‚SPFåˆ—æŒ‡ç¤ºExchange Onlineæ˜¯å¦è¢«åˆ—ä¸ºé‚®ä»¶å‘é€è€…ã€‚**æ³¨æ„ï¼**ç›®å‰ï¼Œreconå‡½æ•°ä¸ä¼šéµå¾ªSPFè®°å½•çš„includeè¯­å¥ï¼Œå› æ­¤å¯èƒ½ä¼šæœ‰è¯¯æŠ¥ã€‚

### ç”¨æˆ·æšä¸¾

å¯ä»¥**æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨**äºç§Ÿæˆ·ä¸­ã€‚è¿™ä¹ŸåŒ…æ‹¬**è®¿å®¢ç”¨æˆ·**ï¼Œå…¶ç”¨æˆ·åçš„æ ¼å¼ä¸ºï¼š
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
ç”µå­é‚®ä»¶æ˜¯ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ï¼Œå…¶ä¸­â€œ@â€è¢«ä¸‹åˆ’çº¿â€œ\_â€æ›¿æ¢ã€‚

ä½¿ç”¨[**AADInternals**](https://github.com/Gerenios/AADInternals)ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
ä»¥ä¸‹æ˜¯å…³äºé»‘å®¢æŠ€æœ¯çš„ä¸€æœ¬ä¹¦ä¸­çš„å†…å®¹ã€‚ä»¥ä¸‹å†…å®¹æ¥è‡ªæ–‡ä»¶/hive/hacktricks-cloud/pentesting-cloud/azure-security/az-unauthenticated-enum-and-initial-entry/README.mdã€‚å°†ç›¸å…³çš„è‹±æ–‡æ–‡æœ¬ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶è¿”å›ç¿»è¯‘ç»“æœï¼Œä¿æŒå®Œå…¨ç›¸åŒçš„markdownå’Œhtmlè¯­æ³•ã€‚è¯·ä¸è¦ç¿»è¯‘ä»£ç ã€é»‘å®¢æŠ€æœ¯åç§°ã€é»‘å®¢æœ¯è¯­ã€äº‘/SaaSå¹³å°åç§°ï¼ˆå¦‚Workspaceã€awsã€gcp...ï¼‰ã€æ³„æ¼ä¸€è¯ã€æ¸—é€æµ‹è¯•å’Œmarkdownæ ‡ç­¾ã€‚åŒæ—¶ï¼Œè¯·ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„å†…å®¹ï¼Œåªéœ€æä¾›ç¿»è¯‘å’Œmarkdownè¯­æ³•å³å¯ã€‚
```
UserName         Exists
--------         ------
user@company.com True
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡ŒåŒ…å«ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€ï¼š
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
æœ‰ä¸‰ç§ä¸åŒçš„æšä¸¾æ–¹æ³•å¯ä¾›é€‰æ‹©ï¼š

| æ–¹æ³•       | æè¿°                                                                                                                                                                                                 |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æ­£å¸¸       | è¿™æ˜¯ä¸Šé¢æåˆ°çš„ GetCredentialType API çš„é»˜è®¤æ–¹æ³•ã€‚                                                                                                                                                      |
| ç™»å½•       | <p>æ­¤æ–¹æ³•å°è¯•ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æ³¨æ„ï¼š</strong>æŸ¥è¯¢å°†è¢«è®°å½•åˆ°ç™»å½•æ—¥å¿—ä¸­ã€‚</p>                                                                                                                 |
| è‡ªåŠ¨ç™»å½•   | <p>æ­¤æ–¹æ³•é€šè¿‡è‡ªåŠ¨ç™»å½•ç«¯ç‚¹å°è¯•ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚<br><strong>æŸ¥è¯¢ä¸ä¼šè¢«è®°å½•</strong>åˆ°ç™»å½•æ—¥å¿—ä¸­ï¼å› æ­¤ï¼Œå¯¹äºå¯†ç å–·æ´’å’Œæš´åŠ›æ”»å‡»ä¹Ÿå¾ˆæœ‰æ•ˆã€‚</p>                                                                         |

åœ¨å‘ç°æœ‰æ•ˆçš„ç”¨æˆ·ååï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è·å–æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼š
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
è„šæœ¬[**o365creeper**](https://github.com/LMGsec/o365creeper)è¿˜å¯ä»¥å¸®åŠ©ä½ å‘ç°ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€æ˜¯å¦æœ‰æ•ˆã€‚
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## AzureæœåŠ¡

ç°åœ¨æˆ‘ä»¬çŸ¥é“Azureç§Ÿæˆ·ä½¿ç”¨çš„**åŸŸå**ï¼Œæ˜¯æ—¶å€™å°è¯•æ‰¾åˆ°**æš´éœ²çš„AzureæœåŠ¡**äº†ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨[**MicroBurst**](https://github.com/NetSPI/MicroBurst)ä¸­çš„ä¸€ç§æ–¹æ³•æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚è¯¥å‡½æ•°å°†åœ¨å‡ ä¸ª**AzureæœåŠ¡åŸŸå**ä¸­æœç´¢åŸºæœ¬åŸŸåï¼ˆä»¥åŠä¸€äº›æ’åˆ—ç»„åˆï¼‰ï¼š
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## å¼€æ”¾å­˜å‚¨

æ‚¨å¯ä»¥ä½¿ç”¨è¯¸å¦‚[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)è¿™æ ·çš„å·¥å…·æ¥å‘ç°å¼€æ”¾å­˜å‚¨ã€‚è¯¥å·¥å…·å°†ä½¿ç”¨æ–‡ä»¶**`Microburst/Misc/permitations.txt`**ç”Ÿæˆæ’åˆ—ç»„åˆï¼ˆéå¸¸ç®€å•ï¼‰ï¼Œä»¥å°è¯•**æ‰¾åˆ°å¼€æ”¾çš„å­˜å‚¨è´¦æˆ·**ã€‚
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**å…±äº«è®¿é—®ç­¾å**_ï¼ˆSASï¼‰URLæ˜¯ä¸€ä¸ªURLï¼Œå®ƒæä¾›å¯¹å­˜å‚¨è´¦æˆ·çš„æŸä¸ªç‰¹å®šéƒ¨åˆ†ï¼ˆå¯ä»¥æ˜¯å®Œæ•´çš„å®¹å™¨ã€æ–‡ä»¶ç­‰ï¼‰çš„è®¿é—®æƒé™ï¼ˆè¯»å–ã€å†™å…¥ç­‰ï¼‰ã€‚å¦‚æœå‘ç°æ³„éœ²çš„SAS URLï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®æ•æ„Ÿä¿¡æ¯ï¼Œå®ƒä»¬çš„æ ¼å¼å¦‚ä¸‹ï¼ˆè¿™æ˜¯è®¿é—®å®¹å™¨çš„URLï¼Œå¦‚æœåªæ˜¯æˆäºˆå¯¹æ–‡ä»¶çš„è®¿é—®æƒé™ï¼ŒURLçš„è·¯å¾„ä¸­ä¹Ÿä¼šåŒ…å«è¯¥æ–‡ä»¶ï¼‰ï¼š

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

ä½¿ç”¨[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)è®¿é—®æ•°æ®

## æŸå®³å‡­æ®

### é’“é±¼

* [**å¸¸è§é’“é±¼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)ï¼ˆå‡­æ®æˆ–OAuthåº”ç”¨ç¨‹åº-[éæ³•åŒæ„æˆæƒæ”»å‡»](az-illicit-consent-grant.md)-ï¼‰
* [**è®¾å¤‡ä»£ç èº«ä»½éªŒè¯**é’“é±¼](az-device-code-authentication-phishing.md)

### å¯†ç å–·æ´’/æš´åŠ›ç ´è§£

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
