# Az - Enumeraci贸n no autenticada y entrada inicial

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Azure Tenant

### Enumeraci贸n de Tenant

Existen algunas **APIs p煤blicas de Azure** que, con solo conocer el **dominio del tenant**, un atacante podr铆a consultar para recopilar m谩s informaci贸n sobre 茅l.\
Puedes consultar directamente la API o usar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informaci贸n                                                                                   | Funci贸n de AADInternals                           |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informaci贸n de inicio de sesi贸n**, incluyendo el ID del tenant                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del tenant                                                             | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **Informaci贸n de inicio de sesi贸n** del tenant, incluyendo el nombre del tenant y el **tipo de autenticaci贸n del dominio** | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informaci贸n de inicio de sesi贸n, incluyendo **informaci贸n de SSO de escritorio**              | `Get-AADIntLoginInformation -UserName <UserName>` |

Puedes consultar toda la informaci贸n de un tenant de Azure con **solo un comando de la** [**biblioteca AADInternals**](https://github.com/Gerenios/AADInternals)**:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Ejemplo de salida de la informaci贸n del tenant de Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Del resultado podemos ver la informaci贸n del inquilino de la organizaci贸n objetivo, incluyendo el nombre del inquilino, id y el nombre de la "marca". Tambi茅n podemos ver **si el Desktop SSO (tambi茅n conocido como** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) est谩 habilitado**. Si est谩 habilitado, podemos averiguar si un usuario dado existe en la organizaci贸n objetivo o no (enumeraci贸n de usuarios).

Tambi茅n podemos ver los nombres de todos los dominios (verificados) y sus tipos de identidad del inquilino objetivo. Para los dominios federados, tambi茅n se muestra el FQDN del proveedor de identidad utilizado (generalmente servidor ADFS). La columna MX indica si el correo electr贸nico se env铆a a Exchange online o no. La columna SPF indica si Exchange online est谩 listado como remitente de correo electr贸nico. **隆Nota!** Actualmente, la funci贸n de reconocimiento no sigue las declaraciones include de los registros SPF, por lo que puede haber falsos negativos.

### Enumeraci贸n de Usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto incluye tambi茅n a los **usuarios invitados**, cuyo nombre de usuario tiene el formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
El correo electr贸nico es la direcci贸n de correo del usuario donde el "@" se reemplaza por un guion bajo "\_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puedes verificar f谩cilmente si el usuario existe o no:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Enumeraci贸n no autenticada e ingreso inicial en Azure

La enumeraci贸n no autenticada en Azure puede proporcionar una gran cantidad de informaci贸n que puede ser utilizada para un ataque m谩s dirigido. Algunas t茅cnicas incluyen:

- **Descubrimiento de blobs**: Los blobs de Azure pueden estar mal configurados y permitir el acceso an贸nimo. Herramientas como `AzCopy` y `Microsoft Azure Storage Explorer` pueden ser utilizadas para descubrir y acceder a estos blobs.
- **Enumeraci贸n de contenedores**: Similar a los blobs, los contenedores pueden estar expuestos. Herramientas como `BlobHunter` pueden ayudar a identificar contenedores accesibles p煤blicamente.
- **Fugas de claves de acceso**: Las claves de acceso almacenadas en repositorios p煤blicos o expuestas en configuraciones pueden ser descubiertas utilizando herramientas de escaneo de c贸digo y b煤squeda en repositorios como `GitLeaks` o `truffleHog`.

Una vez que se ha recopilado informaci贸n suficiente, se puede intentar un ingreso inicial. Esto puede incluir el uso de claves de acceso filtradas para acceder a recursos de Azure o la explotaci贸n de configuraciones incorrectas.

## Herramientas y t茅cnicas

- `AzCopy`: Utilidad de l铆nea de comandos para copiar datos hacia y desde contenedores de almacenamiento de Azure.
- `Microsoft Azure Storage Explorer`: Interfaz gr谩fica para administrar y acceder a recursos de almacenamiento en Azure.
- `BlobHunter`: Herramienta para identificar blobs de Azure accesibles p煤blicamente.
- `GitLeaks`: Herramienta para buscar claves de acceso y tokens secretos en repositorios de Git.
- `truffleHog`: Herramienta que busca en el historial de git y archivos por claves secretas.

## Conclusi贸n

La enumeraci贸n no autenticada es un paso cr铆tico en el pentesting de Azure. Identificar recursos mal configurados o claves de acceso expuestas puede abrir la puerta a ataques m谩s sofisticados. El uso de las herramientas adecuadas es esencial para realizar una enumeraci贸n efectiva y un ingreso inicial exitoso.
```
```
UserName         Exists
--------         ------
user@company.com True
```
Tambi茅n puedes usar un archivo de texto que contenga una direcci贸n de correo electr贸nico por fila:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Hay **tres diferentes m茅todos de enumeraci贸n** para elegir:

| M茅todo    | Descripci贸n                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Se refiere a la API GetCredentialType mencionada anteriormente. El m茅todo predeterminado.                                                                                                               |
| Login     | <p>Este m茅todo intenta iniciar sesi贸n como el usuario.<br><strong>Nota:</strong> las consultas se registrar谩n en el log de inicios de sesi贸n.</p>                                                       |
| Autologon | <p>Este m茅todo intenta iniciar sesi贸n como el usuario a trav茅s del punto final de autologon.<br><strong>Las consultas no se registran</strong> en el log de inicios de sesi贸n. Por lo tanto, funciona bien tambi茅n para ataques de rociado de contrase帽as y fuerza bruta.</p> |

Despu茅s de descubrir los nombres de usuario v谩lidos, puedes obtener **informaci贸n sobre un usuario** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
El script [**o365creeper**](https://github.com/LMGsec/o365creeper) tambi茅n te permite descubrir **si un correo electr贸nico es v谩lido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Servicios de Azure

Ahora que sabemos los **dominios que el inquilino de Azure** est谩 utilizando, es hora de intentar encontrar **servicios de Azure expuestos**.

Puedes utilizar un m茅todo de [**MicroBust**](https://github.com/NetSPI/MicroBurst) para tal fin. Esta funci贸n buscar谩 el nombre de dominio base (y algunas permutaciones) en varios **dominios de servicios de azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Almacenamiento Abierto

Podr铆as descubrir almacenamiento abierto con una herramienta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que utilizar谩 el archivo **`Microburst/Misc/permitations.txt`** para generar permutaciones (muy simples) para intentar **encontrar cuentas de almacenamiento abiertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Una URL de _**firma de acceso compartido**_ (SAS) es una URL que **proporciona acceso** a cierta parte de una cuenta de almacenamiento (puede ser un contenedor completo, un archivo...) con algunos permisos espec铆ficos (leer, escribir...) sobre los recursos. Si encuentras una filtrada podr铆as acceder a informaci贸n sensible, se ven as铆 (esto es para acceder a un contenedor, si solo otorgara acceso a un archivo, la ruta de la URL tambi茅n contendr铆a ese archivo):

`https://<nombre_de_cuenta_de_almacenamiento>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos

## Comprometer Credenciales

### Phishing

* [**Phishing Com煤n**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciales o aplicaci贸n OAuth -[Ataque de Concesi贸n de Consentimiento Il铆cito](az-illicit-consent-grant.md)-)
* [**Phishing de Autenticaci贸n de C贸digo de Dispositivo**](az-device-code-authentication-phishing.md)

### Rociado de Contrase帽as / Fuerza Bruta

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referencias

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
