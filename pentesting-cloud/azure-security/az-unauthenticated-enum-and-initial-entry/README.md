# Az - Nieuwierzytelniona enumeracja i pocztkowe wejcie

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Azure Tenant

### Enumeracja tenant贸w

Istniej niekt贸re **publiczne interfejsy API Azure**, kt贸re, znajc **domen tenant贸w**, atakujcy mo偶e zapyta, aby uzyska wicej informacji na ich temat.\
Mo偶esz zapyta bezporednio API lub u偶y biblioteki PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informacje                                                                                                                                                                                                                                           | Funkcja AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacje o logowaniu**, w tym identyfikator tenant贸w                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Wszystkie domeny** tenant贸w                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacje o logowaniu</strong> tenant贸w, w tym nazwa tenant贸w i domena <strong>typu uwierzytelniania.</strong><br>Jeli <code>NameSpaceType</code> to <strong><code>Managed</code></strong>, oznacza to, 偶e u偶ywane jest <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacje o logowaniu, w tym **informacje o jednokrotnym logowaniu na pulpicie**                                                                                                                                                                       | `Get-AADIntLoginInformation -UserName <UserName>` |

Mo偶esz zapyta o wszystkie informacje dotyczce tenant贸w Azure za pomoc **tylko jednej komendy z biblioteki** [**AADInternals**](https://github.com/Gerenios/AADInternals):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Przykadowy wynik informacji o Azure tenant:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Jest mo偶liwe obserwowanie szczeg贸贸w dotyczcych nazwy, identyfikatora i nazwy "marki" najemcy. Dodatkowo wywietlany jest status jednokrotnego logowania do pulpitu (SSO), znany r贸wnie偶 jako [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Po wczeniu tej funkcji uatwia to okrelenie obecnoci (enumeracji) okrelonego u偶ytkownika w organizacji docelowej.

Ponadto, wynik prezentuje nazwy wszystkich zweryfikowanych domen powizanych z docelowym najemc, wraz z ich odpowiednimi typami to偶samoci. W przypadku domen federacyjnych ujawniany jest r贸wnie偶 peny nazwa domeny (FQDN) dostawcy to偶samoci, zwykle serwera ADFS. Kolumna "MX" okrela, czy e-maile s kierowane do Exchange Online, natomiast kolumna "SPF" oznacza umieszczenie Exchange Online jako nadawcy e-maili. Wa偶ne jest zauwa偶enie, 偶e bie偶ca funkcja rozpoznawania nie analizuje instrukcji "include" w rekordach SPF, co mo偶e prowadzi do faszywych negatyw贸w.

### Enumeracja u偶ytkownik贸w

Jest mo偶liwe **sprawdzenie, czy nazwa u偶ytkownika istnieje** wewntrz najemcy. Dotyczy to r贸wnie偶 **u偶ytkownik贸w goci**, kt贸rych nazwa u偶ytkownika ma format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Adres e-mail to adres e-mail u偶ytkownika, w kt贸rym znak "@" jest zastpiony podkrelnikiem "\_".

Z [**AADInternals**](https://github.com/Gerenios/AADInternals) mo偶na atwo sprawdzi, czy u偶ytkownik istnieje czy nie:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enumeracja i pocztkowe wejcie do Azure (brak uwierzytelnienia)

Ten dokument opisuje techniki i narzdzia, kt贸re mo偶na wykorzysta do przeprowadzenia test贸w penetracyjnych w chmurze Azure bez uwierzytelnienia.

## 1. Enumeracja

### 1.1. Enumeracja subskrypcji

Aby zebra informacje o subskrypcji, wykonaj nastpujce kroki:

1. U偶yj narzdzia `az account show` lub `az account list` w celu uzyskania informacji o bie偶cej subskrypcji.
2. U偶yj narzdzia `az account list-locations` w celu uzyskania listy dostpnych lokalizacji.
3. U偶yj narzdzia `az account list-offers` w celu uzyskania listy dostpnych ofert.

### 1.2. Enumeracja grup zasob贸w

Aby zebra informacje o grupach zasob贸w, wykonaj nastpujce kroki:

1. U偶yj narzdzia `az group list` w celu uzyskania listy grup zasob贸w.
2. U偶yj narzdzia `az group show` w celu uzyskania szczeg贸owych informacji o konkretnej grupie zasob贸w.

### 1.3. Enumeracja zasob贸w

Aby zebra informacje o zasobach, wykonaj nastpujce kroki:

1. U偶yj narzdzia `az resource list` w celu uzyskania listy zasob贸w.
2. U偶yj narzdzia `az resource show` w celu uzyskania szczeg贸owych informacji o konkretnym zasobie.

## 2. Pocztkowe wejcie

### 2.1. Przechwytywanie ruchu sieciowego

Aby przechwyci ruch sieciowy, wykonaj nastpujce kroki:

1. U偶yj narzdzia `az network watcher create` w celu utworzenia obiektu monitorowania sieciowego.
2. U偶yj narzdzia `az network watcher packet-capture create` w celu rozpoczcia przechwytywania ruchu sieciowego.
3. U偶yj narzdzia `az network watcher packet-capture show-status` w celu sprawdzenia statusu przechwytywania.
4. U偶yj narzdzia `az network watcher packet-capture show` w celu pobrania przechwyconych pakiet贸w.

### 2.2. Wykorzystywanie podatnoci

Aby wykorzysta podatnoci, wykonaj nastpujce kroki:

1. Zidentyfikuj podatnoci, korzystajc z narzdzi takich jak `Nmap`, `Metasploit` lub `OpenVAS`.
2. Wykorzystaj znalezione podatnoci, aby uzyska dostp do systemu lub danych.

## 3. Zabezpieczenia

Aby zabezpieczy rodowisko Azure, nale偶y wzi pod uwag nastpujce czynniki:

- U偶ywanie silnych hase i wieloczynnikowej autoryzacji.
- Regularne aktualizacje systemu operacyjnego i oprogramowania.
- Konfiguracja odpowiednich uprawnie dostpu do zasob贸w.
- Monitorowanie i analiza log贸w systemowych.
- Wdra偶anie zabezpiecze warstwy sieciowej, takich jak grupy zabezpiecze sieciowych (NSG) i listy kontrolne dostpu (ACL).
- Regularne przeprowadzanie test贸w penetracyjnych w celu identyfikacji i naprawy podatnoci.

## 4. Podsumowanie

W tym dokumencie om贸wiono techniki i narzdzia, kt贸re mo偶na wykorzysta do przeprowadzenia test贸w penetracyjnych w chmurze Azure bez uwierzytelnienia. Przed przystpieniem do test贸w nale偶y jednak pamita o przestrzeganiu zasad etyki hackingu i uzyskaniu odpowiednich uprawnie.
```
UserName         Exists
--------         ------
user@company.com True
```
Mo偶esz r贸wnie偶 u偶y pliku tekstowego zawierajcego jeden adres e-mail na ka偶dym wierszu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Istniej **trzy r贸偶ne metody wyliczania** do wyboru:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Odnosi si do wspomnianego powy偶ej interfejsu API GetCredentialType. Metoda domylna.                                                                                                                  |
| Logowanie | <p>Ta metoda pr贸buje zalogowa si jako u偶ytkownik.<br><strong>Uwaga:</strong> zapytania zostan zapisane w dzienniku logowania log贸w logowa.</p>                                                       |
| Autologon | <p>Ta metoda pr贸buje zalogowa si jako u偶ytkownik za pomoc punktu kocowego autologowania.<br><strong>Zapytania nie s rejestrowane</strong> w dzienniku logowania log贸w logowa! Dziaa wic r贸wnie偶 w przypadku atak贸w typu password spray i brute-force.</p> |

Po odkryciu prawidowych nazw u偶ytkownik贸w mo偶esz uzyska **informacje o u偶ytkowniku** za pomoc:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skrypt [**o365creeper**](https://github.com/LMGsec/o365creeper) pozwala r贸wnie偶 odkry, **czy adres e-mail jest prawidowy**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Usugi Azure

Teraz, gdy ju偶 znamy **domeny, kt贸rych u偶ywa dzier偶awca Azure**, czas spr贸bowa znale藕 **odsonite usugi Azure**.

Mo偶esz skorzysta z metody z [**MicroBurst**](https://github.com/NetSPI/MicroBurst), aby osign ten cel. Ta funkcja bdzie wyszukiwa podstawow nazw domeny (oraz kilka permutacji) w kilku **domenach usug Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otwarte magazynowanie

Mo偶esz odkry otwarte magazynowanie za pomoc narzdzia takiego jak [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1), kt贸re bdzie u偶ywa pliku **`Microburst/Misc/permitations.txt`** do generowania permutacji (bardzo proste) w celu pr贸by **znalezienia otwartych kont magazynowych**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**Podpis URL dostpu wsp贸dzielonego**_ (SAS) to URL, kt贸ry **zapewnia dostp** do okrelonej czci konta Storage (mo偶e to by peny kontener, plik...) z okrelonymi uprawnieniami (odczyt, zapis...) do zasob贸w. Jeli znajdziesz wycieky taki URL, mo偶esz uzyska dostp do poufnych informacji. Wygldaj one tak (to jest przykad dostpu do kontenera, jeli dotyczyoby to tylko dostpu do pliku, cie偶ka URL r贸wnie偶 zawieraaby ten plik):

`https://<nazwa_konta_storage>.blob.core.windows.net/nowy_kontener?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

U偶yj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), aby uzyska dostp do danych.

## Kompromitacja powiadcze

### Phishing

* [**Powszechne metody phishingu**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (powiadczenia lub aplikacja OAuth - [Atak nielegalnego udzielenia zgody](az-illicit-consent-grant.md) -)
* [**Phishing uwierzytelniania kodem urzdzenia**](az-device-code-authentication-phishing.md)

### Spraying hasa / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Odnoniki

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
