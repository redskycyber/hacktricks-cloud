# Az - Concesi贸n de consentimiento il铆cito

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de aplicaci贸n OAuth

Las **aplicaciones de Azure** solicitan permisos para acceder a los **datos del usuario** (informaci贸n b谩sica, pero tambi茅n acceso a documentos, env铆o de correos electr贸nicos, etc.).\
Si se **permite**, un usuario normal solo puede otorgar consentimiento para **"Permisos de bajo impacto"**. En **todos los dem谩s** casos, se requiere **consentimiento de administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcionar consentimiento en todo el inquilino.

Solo los permisos que **no requieren consentimiento de administrador** se clasifican como de **bajo impacto**. Estos son los permisos necesarios para **iniciar sesi贸n b谩sica: openid, perfil, correo electr贸nico, User.Read y offline\_access**. Si una **organizaci贸n** **permite** el consentimiento del usuario para **todas las aplicaciones**, un empleado puede otorgar consentimiento a una aplicaci贸n para **leer lo anterior de su perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Por lo tanto, un atacante podr铆a preparar una **aplicaci贸n maliciosa** y con un **phishing**, hacer que el usuario **acepte la aplicaci贸n y robe sus datos**.

### Verificar si los usuarios pueden otorgar consentimiento

Verifique si los usuarios pueden otorgar consentimiento a las aplicaciones:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Deshabilitar el consentimiento del usuario**: los usuarios no pueden otorgar permisos a las aplicaciones.
* **Los usuarios pueden otorgar consentimiento a aplicaciones de editores verificados o de su organizaci贸n, pero solo para los permisos que seleccione**: todos los usuarios solo pueden otorgar consentimiento a aplicaciones que fueron publicadas por un editor verificado y aplicaciones que est谩n registradas en su inquilino.
* **Los usuarios pueden otorgar consentimiento a todas las aplicaciones**: permite que todos los usuarios otorguen consentimiento a cualquier permiso que no requiera consentimiento de administrador,
* **Pol铆tica de consentimiento de aplicaciones personalizada**

## 驴Qu茅 es el ataque de concesi贸n de consentimiento il铆cito?

En un ataque de concesi贸n de consentimiento il铆cito, el atacante crea una **aplicaci贸n registrada de Azure que solicita acceso a datos como informaci贸n de contacto, correo electr贸nico o documentos**. Luego, el atacante enga帽a a un usuario final para que otorgue consentimiento a la aplicaci贸n para que el atacante pueda acceder a los datos a los que el usuario objetivo tiene acceso. Despu茅s de que se haya otorgado el consentimiento de la aplicaci贸n, tiene acceso a nivel de cuenta de usuario a los datos sin necesidad de una cuenta organizativa.

En palabras simples, cuando la v铆ctima hace clic en ese hermoso bot贸n azul de "Aceptar", Azure AD env铆a un token al sitio de terceros que pertenece a un atacante donde el atacante usar谩 el token para realizar acciones en nombre de las v铆ctimas como acceder a todos los archivos, leer correos electr贸nicos, enviar correos electr贸nicos, etc.

## Flujo de ataque

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar este ataque contra la empresa "ecorp", el atacante podr铆a registrar un dominio con el nombre "safedomainlogin.com" y crear un subdominio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) donde **aloj贸 la aplicaci贸n para capturar el c贸digo de autorizaci贸n** y luego solicitar los tokens de acceso.

Luego, registre una aplicaci贸n de varios inquilinos en su inquilino de Azure y n贸mbrela como "ecorp" y agregue la URL de redireccionamiento que apunta a "ecorp.safedomainlogin.com" que aloja una aplicaci贸n para capturar el c贸digo de autorizaci贸n.

El atacante tambi茅n crea un nuevo secreto de cliente y agrega algunos permisos de **API** como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` en la aplicaci贸n. Para que una vez que el **usuario otorgue el consentimiento a la aplicaci贸n**, el atacante pueda **extraer la informaci贸n sensible** en nombre del usuario.

Finalmente, el atacante crea el **enlace** que conten铆a el ID de cliente de la aplicaci贸n maliciosa y **comparti贸** el enlace con los **usuarios objetivo** para obtener su consentimiento.

## 365-Stealer

Puede realizar este ataque con [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como paso adicional, si tiene alg煤n **acceso sobre un usuario en la organizaci贸n v铆ctima**, puede verificar si la pol铆tica le permitir谩 **aceptar aplicaciones**:

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Si "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", puede
```

Para este ataque, deber谩 crear una **nueva aplicaci贸n en su inquilino de Azure** (en registros de aplicaciones) con, por ejemplo, los siguientes permisos:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est谩 dentro de `Microsoft Graph` en `Permisos delegados`. (Los permisos de aplicaci贸n siempre necesitar谩n aprobaci贸n adicional).

* `User.ReadBasic.All` es el permiso que le permitir谩 **leer informaci贸n de todos los usuarios** en la organizaci贸n si se otorga.
* Recuerde que solo `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcion