# Az - Osnovne informacije

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Hijerarhija organizacije

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupa za upravljanje

Ako vaÅ¡a organizacija ima **mnogo Azure pretplata**, moÅ¾da Ä‡e vam biti potreban naÄin da efikasno **upravljate pristupom**, politikama i usaglaÅ¡enoÅ¡Ä‡u za te **pretplate**. **Grupe za upravljanje** pruÅ¾aju **obim upravljanja iznad pretplata**.

Imajte na umu da se u jednom direktorijumu moÅ¾e podrÅ¾ati **10.000 grupa za upravljanje**, a stablo grupa za upravljanje moÅ¾e podrÅ¾ati **do Å¡est nivoa dubine**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[Iz dokumentacije](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Svaki direktorijum ima jednu **grupu za upravljanje najviÅ¡eg nivoa koja se naziva koren**. Koren grupa za upravljanje je ugraÄ‘en u hijerarhiju kako bi **sve grupe za upravljanje i pretplate bile povezane sa njim**. Ova koren grupa za upravljanje omoguÄ‡ava primenu **globalnih politika i Azure uloga** na nivou direktorijuma. [Azure AD **Globalni administrator** treba da se uzdigne](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) na **ulogu administratora pristupa korisnika ove korenske grupe**. Nakon podizanja pristupa, administrator moÅ¾e **dodeliti bilo koju Azure ulogu drugim korisnicima ili grupama direktorijuma za upravljanje hijerarhijom**. Kao administrator, moÅ¾ete dodeliti **sopstveni nalog kao vlasnika** korenske grupe za upravljanje.

Koren grupa za upravljanje **ne moÅ¾e se premestiti ili izbrisati**, za razliku od drugih grupa za upravljanje.

Grupe za upravljanje vam omoguÄ‡avaju upravljanje na nivou preduzeÄ‡a bez obzira na vrstu pretplata koje imate. MeÄ‘utim, **sve pretplate unutar jedne grupe za upravljanje** moraju verovati **istom Azure Active Directory (Azure AD) zakupcu**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure pretplate

U Azure-u, pretplata sluÅ¾i kao **logiÄki kontejner** za svrhu **provisioniranja** poslovnih ili tehniÄkih **resursa**. Ovaj kontejner Äuva **detalje o resursima** kao Å¡to su virtuelne maÅ¡ine (VM), baze podataka i drugi. Prilikom kreiranja Azure resursa, kao Å¡to je VM, specificira se **povezana pretplata**. Ova struktura olakÅ¡ava delegiranje pristupa, koristeÄ‡i mehanizme kontrole pristupa zasnovane na ulogama.

### Grupe resursa

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa resursa je **kontejner** koji sadrÅ¾i **povezane resurse** za Azure reÅ¡enje. Grupa resursa moÅ¾e ukljuÄivati sve resurse za reÅ¡enje, ili samo one **resurse koje Å¾elite upravljati kao grupu**. OpÄ‡enito, dodajte **resurse** koji dele **isti Å¾ivotni ciklus** u istu grupu resursa kako biste ih lako mogli implementirati, aÅ¾urirati i brisati kao grupu.

Svi **resursi** moraju biti **unutar grupe resursa** i mogu pripadati samo jednoj grupi, a ako se grupa resursa izbriÅ¡e, svi resursi unutar nje takoÄ‘e se briÅ¡u.

### Administrativne jedinice

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Administrativne jedinice vam omoguÄ‡avaju da **podelite** vaÅ¡u organizaciju na **bilo koju jedinicu** koju Å¾elite, a zatim **dodelite specifiÄne administratore** koji mogu **upravljati samo Älanovima** te jedinice. Na primer, moÅ¾ete koristiti administrativne jedinice da biste delegirali dozvole administratorima svake Å¡kole na velikom univerzitetu, tako da mogu kontrolisati pristup, upravljati korisnicima i postavljati politike samo u Å koli inÅ¾enjeringa.

Samo **korisnici**, **grupe** i **ureÄ‘aji** mogu biti **Älanovi** administrativne jedinice.

Stoga Ä‡e **administrativna jedinica** sadrÅ¾ati neke **Älanove**, a drugi **principali** Ä‡e biti **dodeljeni dozvole nad tom** administrativnom **jedinicom** koje mogu koristiti za **upravljanje Älanovima** administrativne jedinice.

## Azure vs Azure AD vs Azure AD Domain Services

VaÅ¾no je napomenuti da je **Azure AD** usluga **unutar** **Azure-a**. **Azure** je Microsoftova **cloud platforma**, dok je **Azure AD** korporativna **identitetska** **usluga** u Azure-u.\
Osim toga, **Azure AD nije kao Windows Active Directory**, to je identitetska usluga koja radi na potpuno drugaÄiji naÄin. Ako Å¾elite pokrenuti **Domain Controller u Azure-u** za vaÅ¡e Windows Active Directory okruÅ¾enje, morate koristiti **Azure AD Domain Services**.

## Principali

Azure podrÅ¾ava razliÄite vrste principala:

* **Korisnik**: ObiÄna **osoba** sa pristupnim podacima.
* **Grupa**: **Grupa principala** koja se zajedno upravlja. **Dozvole** dodeljene grupama se **nasleÄ‘uju** od njenih **Älanova**.
* **Service Principal/Enterprise Applications**: To je **identitet** koji je kreiran za **koriÅ¡Ä‡enje** sa **aplikacijama**, hostovanim uslugama i automatizovanim alatima za pristup Azure resursima. Ovaj pristup je **ograniÄen ulogama koje su dodeljene** servisnom principalu, Å¡to vam omoguÄ‡ava kontrolu nad **kojim resursima se moÅ¾e pristupiti** i na kojem
## Uloge i dozvole

**Uloge** se **dodeljuju** **principima** na **opsegu**: `principal -[IMA ULOGU]->(opseg)`

**Uloge** dodeljene **grupama** se **nasleÄ‘uju** od svih **Älanova** grupe.

Zavisno od opsega na koji je uloga dodeljena, **uloga** se moÅ¾e **naslediti** na **druge resurse** unutar kontejnera opsega. Na primer, ako korisnik A ima **ulogu na pretplati**, imaÄ‡e tu **ulogu na svim grupama resursa** unutar pretplate i na **svim resursima** unutar grupe resursa.

### **KlasiÄne uloge**

| **Vlasnik**                   | <ul><li>Potpuni pristup svim resursima</li><li>MoÅ¾e upravljati pristupom drugim korisnicima</li></ul> | Svi tipovi resursa |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Saradnik**                  | <ul><li>Potpuni pristup svim resursima</li><li>Ne moÅ¾e upravljati pristupom</li></ul>     | Svi tipovi resursa |
| **ÄŒitalac**                   | â€¢ Pregled svih resursa                                                                  | Svi tipovi resursa |
| **Administrator pristupa korisnika** | <ul><li>Pregled svih resursa</li><li>MoÅ¾e upravljati pristupom drugim korisnicima</li></ul>           | Svi tipovi resursa |

### UgraÄ‘ene uloge

[Iz dokumentacije: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ima nekoliko Azure **ugraÄ‘enih uloga** koje moÅ¾ete **dodeliti** **korisnicima, grupama, servisnim principima i upravljanim identitetima**. Dodeljivanje uloga je naÄin na koji kontroliÅ¡ete **pristup Azure resursima**. Ako ugraÄ‘ene uloge ne zadovoljavaju specifiÄne potrebe vaÅ¡e organizacije, moÅ¾ete kreirati [**Azure prilagoÄ‘ene uloge**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**UgraÄ‘ene** uloge se primenjuju samo na **resurse** za koje su **namenjene**, na primer pogledajte ova 2 primera **ugraÄ‘enih uloga nad resursima Compute**:

| [ÄŒitaÄ rezervne kopije diska](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | PruÅ¾a dozvolu za izvrÅ¡avanje rezervne kopije diska.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Korisnik prijave virtuelne maÅ¡ine](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Pregled virtuelnih maÅ¡ina u portalu i prijava kao obiÄan korisnik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ove uloge se **takoÄ‘e mogu dodeliti nad logiÄkim kontejnerima** (kao Å¡to su upravljaÄke grupe, pretplate i grupe resursa) i principali koji su pogoÄ‘eni Ä‡e ih imati **nad resursima unutar tih kontejnera**.

* PronaÄ‘ite ovde listu [**svih Azure ugraÄ‘enih uloga**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* PronaÄ‘ite ovde listu [**svih Azure AD ugraÄ‘enih uloga**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### PrilagoÄ‘ene uloge

Azure takoÄ‘e omoguÄ‡ava kreiranje [**prilagoÄ‘enih uloga**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) sa dozvolama koje korisniku trebaju.

### Odbijen pristup

* Da bi **princip imao pristup resursu**, mora mu biti dodeljena eksplicitna uloga koja mu **dodeljuje tu dozvolu**.
* Eksplicitno **odbijanje dodele uloge ima prednost** nad ulogom koja dodeljuje dozvolu.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Globalni administrator

Korisnici sa ulogom globalnog administratora imaju moguÄ‡nost da '**poveÄ‡aju' pristup korisnika administratora pristupa Azure ulozi do korenske upravljaÄke grupe**. To znaÄi da Ä‡e globalni administrator moÄ‡i da upravlja pristupom **svim Azure pretplatama i upravljaÄkim grupama**.\
Ovo poveÄ‡anje se moÅ¾e izvrÅ¡iti na kraju stranice: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure politike

Azure politike su skup **pravila i propisa u Microsoft Azuru**, cloud computing servisu, koji pomaÅ¾u u upravljanju i sprovoÄ‘enju organizacionih standarda i procene usaglaÅ¡enosti na velikoj skali. Ove politike sprovode razliÄita pravila nad vaÅ¡im **Azure resursima**, obezbeÄ‘ujuÄ‡i da ti resursi ostanu usaglaÅ¡eni sa korporativnim standardima i sporazumima o nivou usluge.

Azure politike su kljuÄne za upravljanje i bezbednost u oblaku, pomaÅ¾uÄ‡i da se osigura pravilno i efikasno koriÅ¡Ä‡enje resursa, kao i usaglaÅ¡enost sa spoljnim propisima i internim politikama.\
Neki primeri:

1. **ObezbeÄ‘ivanje usaglaÅ¡enosti sa odreÄ‘enim Azure regionima**: Ova politika obezbeÄ‘uje da se svi resursi implementiraju u odreÄ‘enim Azure regionima. Na primer, kompanija moÅ¾e Å¾eleti da obezbedi da se svi njeni podaci Äuvaju u Evropi radi usaglaÅ¡enosti sa GDPR-om.
2. **SprovoÄ‘enje standarda za imenovanje**: Politike mogu da sprovode konvencije za imenovanje Azure resursa. Ovo pomaÅ¾e u organizaciji i lakom identifikovanju resursa na osnovu njihovih imena, Å¡to je korisno u velikim okruÅ¾enjima.
3. **OgraniÄavanje odreÄ‘enih tipova resursa**: Ova politika moÅ¾e ograniÄiti kreiranje odreÄ‘enih tipova resursa. Na primer, politika moÅ¾e biti postavljena da spreÄi kreiranje skupih tipova resursa, poput odreÄ‘enih veliÄina virtuelnih maÅ¡ina, radi kontrole troÅ¡kova.
4. **SprovoÄ‘enje politika o oznaÄavanju**: Oznake su parovi kljuÄ-vrednost koji se dodeljuju Azure resursima radi upravljanja resursima. Politike mogu da obezbede da odreÄ‘ene oznake moraju biti prisutne ili imaju odreÄ‘ene vrednosti za sve resurse. Ovo je korisno za praÄ‡enje troÅ¡kova, vlasniÅ¡tva ili kategorizacije resursa.
5. **OgraniÄavanje javnog pristupa resursima**: Politike mogu da obezbede da odreÄ‘eni resursi, poput skladiÅ¡nih naloga ili baza podataka, nemaju javne krajnje taÄke, Äime se osigurava da im se moÅ¾e pristupiti samo unutar mreÅ¾e organizacije.
6. **Automatsko primenjivanje bezbednosnih podeÅ¡avanja**: Politike se mogu koristiti za automatsko primenjivanje bezbednosnih podeÅ¡avanja na resurse, kao Å¡to je primena odreÄ‘ene grupe mreÅ¾nih bezbednosnih grupa na sve virtuelne maÅ¡ine ili osiguravanje da svi skladiÅ¡ni nalozi koriste enkripciju.

Imajte na umu da se Azure politike mogu primeniti na bilo koji nivo Azure hijerarhije, ali se **obiÄno koriste u korenskoj upravljaÄkoj grupi** ili drugim upravljaÄkim grupama.

###
### Podrazumevana korisniÄka ovlaÅ¡Ä‡enja

Osnovni korisnik Ä‡e imati neka **podrazumevana ovlaÅ¡Ä‡enja** za enumeraciju odreÄ‘enih delova AzureAD:

* ÄŒitanje svih korisnika, grupa, aplikacija, ureÄ‘aja, uloga, pretplata i njihovih javnih svojstava
* Pozivanje gostiju (_moÅ¾e se iskljuÄiti_)
* Kreiranje sigurnosnih grupa
* ÄŒitanje ne-skrivenih Älanstava u grupama
* Dodavanje gostiju u vlasniÄke grupe
* Kreiranje nove aplikacije (_moÅ¾e se iskljuÄiti_)
* Dodavanje do 50 ureÄ‘aja u Azure (_moÅ¾e se iskljuÄiti_)

MoÅ¾ete videti punu [**listu podrazumevanih ovlaÅ¡Ä‡enja korisnika** u dokumentaciji](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). TakoÄ‘e, obratite paÅ¾nju da u toj listi moÅ¾ete videti i **listu podrazumevanih ovlaÅ¡Ä‡enja gostiju**.

{% hint style="info" %}
Zapamtite da bi korisnik mogao da enumeriÅ¡e Azure resurse, korisniku je potrebno eksplicitno odobrenje za to ovlaÅ¡Ä‡enje.
{% endhint %}

### Privileged Identity Management (PIM)

Privileged Identity Management (PIM) u Azure-u je alat koji **upravlja, kontroliÅ¡e i nadgleda privilegovani pristup** u Azure Active Directory i Azure-u. PoboljÅ¡ava bezbednost pruÅ¾anjem **privremenog i vremenski ograniÄenog privilegovanog pristupa**, **sprovoÄ‘enjem odobravanja tokova rada i zahtevanjem dodatne autentifikacije**. Ovaj pristup minimizira rizik od neovlaÅ¡Ä‡enog pristupa tako Å¡to se osigurava da se poviÅ¡ena ovlaÅ¡Ä‡enja dodeljuju samo kada je to potrebno i za odreÄ‘eno vreme.

## Autentifikacioni tokeni

Postoje **tri vrste tokena** koji se koriste u OIDC:

* [**Pristupni tokeni**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klijent predstavlja ovaj token serveru resursa da bi **pristupio resursima**. MoÅ¾e se koristiti samo za odreÄ‘enu kombinaciju korisnika, klijenta i resursa i **ne moÅ¾e se opozvati** do isteka - podrazumevano je 1 sat. Detekcija je niska pri koriÅ¡Ä‡enju ovog tokena.
* **ID tokeni**: Klijent dobija ovaj **token od autorizacionog servera**. SadrÅ¾i osnovne informacije o korisniku. **Povezan je sa odreÄ‘enom kombinacijom korisnika i klijenta**.
* **OsvjeÅ¾avajuÄ‡i tokeni**: Dodeljeni klijentu zajedno sa pristupnim tokenom. Koriste se za **dobijanje novih pristupnih i ID tokena**. Povezani su sa odreÄ‘enom kombinacijom korisnika i klijenta i mogu se opozvati. Podrazumevani rok trajanja je **90 dana** za neaktivne osvjeÅ¾avajuÄ‡e tokene i **bez roka trajanja za aktivne tokene**.

{% hint style="warning" %}
Informacije za **uslovni pristup** su **smeÅ¡tene** unutar **JWT**-a. Dakle, ako zatraÅ¾ite **token sa dozvoljene IP adrese**, ta **IP adresa** Ä‡e biti **smeÅ¡tena** u tokenu i zatim moÅ¾ete koristiti taj token sa **ne-dozvoljene IP adrese da pristupite resursima**.
{% endhint %}

Proverite sledeÄ‡u stranicu da biste nauÄili razliÄite naÄine za **zahtevanje pristupnih tokena** i prijavljivanje sa njima:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

NajÄeÅ¡Ä‡e koriÅ¡Ä‡ene API taÄke su:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph koji je zastareo je graph.windows.net)

## Reference

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
