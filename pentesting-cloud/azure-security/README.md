# Azureæ¸—é€æµ‹è¯•

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æˆ‘ä»åœ¨æ„å»ºAzureæ–¹æ³•è®º

## åŸºæœ¬ä¿¡æ¯

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azureæ¸—é€æµ‹è¯•/çº¢é˜Ÿæ–¹æ³•è®º

ä¸ºäº†å®¡è®¡Azureç¯å¢ƒï¼Œäº†è§£ä»¥ä¸‹ä¿¡æ¯éå¸¸é‡è¦ï¼šæ­£åœ¨ä½¿ç”¨å“ªäº›**æœåŠ¡**ï¼Œæ­£åœ¨**æš´éœ²**ä»€ä¹ˆï¼Œè°æœ‰æƒè®¿é—®ä»€ä¹ˆï¼Œä»¥åŠå†…éƒ¨AzureæœåŠ¡å’Œ**å¤–éƒ¨æœåŠ¡**å¦‚ä½•è¿æ¥ã€‚

ä»çº¢é˜Ÿçš„è§’åº¦æ¥çœ‹ï¼Œ**å…¥ä¾µAzureç¯å¢ƒçš„ç¬¬ä¸€æ­¥**æ˜¯è®¾æ³•è·å–ä¸€äº›Azure ADçš„**å‡­æ®**ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›è·å–å‡­æ®çš„æ–¹æ³•ï¼š

* åœ¨githubï¼ˆæˆ–ç±»ä¼¼ç½‘ç«™ï¼‰ä¸Šçš„**æ³„éœ²** - OSINT
* **ç¤¾äº¤**å·¥ç¨‹
* **å¯†ç **é‡ç”¨ï¼ˆå¯†ç æ³„éœ²ï¼‰
* Azureæ‰˜ç®¡åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´
* [**æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)å¹¶è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹
* **æœ¬åœ°æ–‡ä»¶è¯»å–**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* åœ¨az cli 2.30ä¹‹å‰çš„æ–‡ä»¶**`accessTokens.json`**ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨äº†**è®¿é—®ä»¤ç‰Œ**
* æ–‡ä»¶**`azureProfile.json`**åŒ…å«äº†æœ‰å…³å·²ç™»å½•ç”¨æˆ·çš„**ä¿¡æ¯**
* **`az logout`**ä¼šåˆ é™¤ä»¤ç‰Œ
* æ—§ç‰ˆæœ¬çš„**`Az PowerShell`**ä»¥æ˜æ–‡å½¢å¼åœ¨**`TokenCache.dat`**ä¸­å­˜å‚¨**è®¿é—®ä»¤ç‰Œ**ã€‚å®ƒè¿˜ä»¥æ˜æ–‡å½¢å¼åœ¨**`AzureRmContext.json`**ä¸­å­˜å‚¨**ServicePrincipalSecret**ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤**`Save-AzContext`**æ¥**å­˜å‚¨**ä»¤ç‰Œã€‚\
ä½¿ç”¨`Disconnect-AzAccount`æ¥åˆ é™¤å®ƒä»¬ã€‚
* ç¬¬ä¸‰æ–¹**é­åˆ°å…¥ä¾µ**
* **å†…éƒ¨**å‘˜å·¥
* [**å¸¸è§çš„é’“é±¼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)ï¼ˆå‡­æ®æˆ–Oauthåº”ç”¨ç¨‹åºï¼‰
* [è®¾å¤‡ä»£ç èº«ä»½éªŒè¯é’“é±¼](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **å¯†ç å–·æ´’**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

å³ä½¿æ‚¨æ²¡æœ‰å…¥ä¾µAzureç§Ÿæˆ·ä¸­çš„ä»»ä½•ç”¨æˆ·ï¼Œæ‚¨ä»ç„¶å¯ä»¥ä»ä¸­**æ”¶é›†ä¸€äº›ä¿¡æ¯**ï¼š

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
åœ¨æˆåŠŸè·å–å‡­æ®åï¼Œæ‚¨éœ€è¦çŸ¥é“è¿™äº›å‡­æ®å±äº**è°**ï¼Œä»¥åŠä»–ä»¬æœ‰æƒè®¿é—®ä»€ä¹ˆï¼Œå› æ­¤æ‚¨éœ€è¦æ‰§è¡Œä¸€äº›åŸºæœ¬æšä¸¾æ“ä½œï¼š
{% endhint %}

## åŸºæœ¬æšä¸¾

{% hint style="info" %}
è¯·è®°ä½ï¼Œæšä¸¾çš„**æœ€åµé—¹çš„éƒ¨åˆ†**æ˜¯**ç™»å½•**ï¼Œè€Œä¸æ˜¯æšä¸¾æœ¬èº«ã€‚
{% endhint %}

### SSRF

å¦‚æœæ‚¨åœ¨Azureä¸­çš„æŸå°æœºå™¨ä¸Šå‘ç°äº†SSRFæ¼æ´ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ä»¥è·å–æŠ€å·§ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### ç»•è¿‡ç™»å½•æ¡ä»¶

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

åœ¨æ‚¨æ‹¥æœ‰ä¸€äº›æœ‰æ•ˆå‡­æ®ä½†æ— æ³•ç™»å½•çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹å¸¸è§ä¿æŠ¤æªæ–½ï¼š

* **IPç™½åå•** -- æ‚¨éœ€è¦å…¥ä¾µä¸€ä¸ªæœ‰æ•ˆçš„IP
* **åœ°ç†é™åˆ¶** -- æ‰¾å‡ºç”¨æˆ·æ‰€åœ¨çš„åŸå¸‚æˆ–å…¬å¸çš„åŠå…¬åœ°ç‚¹ï¼Œå¹¶è·å–ç›¸åŒåŸå¸‚ï¼ˆæˆ–è‡³å°‘ç›¸åŒå›½å®¶ï¼‰çš„IP
* **æµè§ˆå™¨** -- å¯èƒ½åªå…è®¸ç‰¹å®šæ“ä½œç³»ç»Ÿï¼ˆWindowsã€Linuxã€Macã€Androidã€iOSï¼‰çš„æµè§ˆå™¨ç™»å½•ã€‚æ‰¾å‡ºå—å®³è€…/å…¬å¸ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿã€‚
* æ‚¨è¿˜å¯ä»¥å°è¯•**å…¥ä¾µæœåŠ¡ä¸»ä½“å‡­æ®**ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸å—é™è¾ƒå°‘ï¼Œå…¶ç™»å½•å—åˆ°çš„å®¡æŸ¥è¾ƒå°‘

ç»•è¿‡è¿™äº›ä¿æŠ¤æªæ–½åï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæ¢å¤åˆ°åˆå§‹è®¾ç½®ï¼Œå¹¶ä¸”ä»ç„¶å…·æœ‰è®¿é—®æƒé™ã€‚

### Whoami

{% hint style="danger" %}
åœ¨[**Az - AzureAD**](az-services/az-azuread.md)éƒ¨åˆ†äº†è§£**å¦‚ä½•å®‰è£…**az cliã€AzureADå’ŒAz PowerShellã€‚
{% endhint %}

æ‚¨éœ€è¦äº†è§£çš„ç¬¬ä¸€ä»¶äº‹æ˜¯**æ‚¨æ˜¯è°**ï¼ˆæ‚¨åœ¨å“ªä¸ªç¯å¢ƒä¸­ï¼‰ï¼š

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% tab title="AzureAD" %}AzureAD
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% tab title="Az PowerShell" %}

ä»¥ä¸‹æ˜¯ä½¿ç”¨ Az PowerShell è¿›è¡Œ Azure å®‰å…¨æµ‹è¯•çš„ä¸€äº›æŠ€å·§å’Œå»ºè®®ã€‚

## å®‰è£… Az PowerShell æ¨¡å—

è¦ä½¿ç”¨ Az PowerShell è¿›è¡Œ Azure å®‰å…¨æµ‹è¯•ï¼Œé¦–å…ˆéœ€è¦å®‰è£… Az PowerShell æ¨¡å—ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

## è¿æ¥åˆ° Azure è®¢é˜…

åœ¨ä½¿ç”¨ Az PowerShell è¿›è¡Œ Azure å®‰å…¨æµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦è¿æ¥åˆ° Azure è®¢é˜…ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿æ¥ï¼š

```powershell
Connect-AzAccount
```

## è·å– Azure èµ„æº

ä½¿ç”¨ Az PowerShellï¼Œå¯ä»¥è·å– Azure è®¢é˜…ä¸­çš„å„ç§èµ„æºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ç¤ºä¾‹ï¼š

- è·å–æ‰€æœ‰èµ„æºç»„ï¼š

  ```powershell
  Get-AzResourceGroup
  ```

- è·å–ç‰¹å®šèµ„æºç»„ä¸­çš„æ‰€æœ‰èµ„æºï¼š

  ```powershell
  Get-AzResource -ResourceGroupName <ResourceGroupName>
  ```

- è·å–ç‰¹å®šç±»å‹çš„èµ„æºï¼š

  ```powershell
  Get-AzResource -ResourceType <ResourceType>
  ```

## æ£€æŸ¥ Azure èµ„æºçš„å®‰å…¨é…ç½®

ä½¿ç”¨ Az PowerShellï¼Œå¯ä»¥æ£€æŸ¥ Azure èµ„æºçš„å®‰å…¨é…ç½®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ç¤ºä¾‹ï¼š

- æ£€æŸ¥å­˜å‚¨å¸æˆ·çš„è®¿é—®æƒé™ï¼š

  ```powershell
  Get-AzStorageAccount | Get-AzStorageAccountNetworkRuleSet
  ```

- æ£€æŸ¥è™šæ‹Ÿæœºçš„ç½‘ç»œå®‰å…¨ç»„è§„åˆ™ï¼š

  ```powershell
  Get-AzNetworkSecurityGroup | Get-AzNetworkSecurityRuleConfig
  ```

- æ£€æŸ¥åº”ç”¨æœåŠ¡è®¡åˆ’çš„ SSL è®¾ç½®ï¼š

  ```powershell
  Get-AzAppServicePlan | Get-AzWebAppSSLBinding
  ```

## æ£€æµ‹ Azure èµ„æºçš„æ¼æ´

ä½¿ç”¨ Az PowerShellï¼Œå¯ä»¥æ£€æµ‹ Azure èµ„æºçš„æ¼æ´ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ç¤ºä¾‹ï¼š

- æ£€æµ‹å­˜å‚¨å¸æˆ·çš„å…¬å…±è®¿é—®æƒé™ï¼š

  ```powershell
  Get-AzStorageAccount | Where-Object { $_.IsPublicAccessAllowed -eq $true }
  ```

- æ£€æµ‹è™šæ‹Ÿæœºçš„å¼€æ”¾ç«¯å£ï¼š

  ```powershell
  Get-AzNetworkSecurityGroup | Get-AzNetworkSecurityRuleConfig | Where-Object { $_.Access -eq "Allow" -and $_.Direction -eq "Inbound" -and $_.DestinationPortRange -ne "*" }
  ```

- æ£€æµ‹åº”ç”¨æœåŠ¡è®¡åˆ’çš„å¼± SSL/TLS é…ç½®ï¼š

  ```powershell
  Get-AzAppServicePlan | Get-AzWebAppSSLBinding | Where-Object { $_.Protocol -eq "TLSv1" -or $_.Protocol -eq "SSLv3" }
  ```

## æ€»ç»“

ä½¿ç”¨ Az PowerShellï¼Œå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œ Azure å®‰å…¨æµ‹è¯•ã€‚é€šè¿‡è·å–å’Œæ£€æŸ¥ Azure èµ„æºçš„å®‰å…¨é…ç½®ï¼Œä»¥åŠæ£€æµ‹ Azure èµ„æºçš„æ¼æ´ï¼Œå¯ä»¥å¸®åŠ©å‘ç°å’Œä¿®å¤æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚

{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
åœ¨æšä¸¾ Azure æ—¶ï¼Œæœ€é‡è¦çš„å‘½ä»¤ä¹‹ä¸€æ˜¯æ¥è‡ª Az PowerShell çš„ **`Get-AzResource`**ï¼Œå®ƒå¯ä»¥è®©ä½ **äº†è§£å½“å‰ç”¨æˆ·å¯è§çš„èµ„æº**ã€‚

ä½ å¯ä»¥åœ¨**Web æ§åˆ¶å°**ä¸­è·å–ç›¸åŒçš„ä¿¡æ¯ï¼Œè®¿é—® [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) æˆ–æœç´¢ "All resources"ã€‚
{% endhint %}

### AzureAD æšä¸¾

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•ç”¨æˆ·éƒ½åº”è¯¥æœ‰**è¶³å¤Ÿçš„æƒé™æ¥æšä¸¾**ç”¨æˆ·ã€ç»„ã€è§’è‰²ã€æœåŠ¡ä¸»ä½“ç­‰å†…å®¹ï¼ˆæŸ¥çœ‹[é»˜è®¤ AzureAD æƒé™](az-basic-information.md#default-user-permissions)ï¼‰ã€‚\
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªæŒ‡å—ï¼š

{% content-ref url="az-services/az-azuread.md" %}
[az-azuread.md](az-services/az-azuread.md)
{% endcontent-ref %}

{% hint style="info" %}
ç°åœ¨ï¼Œä½ å·²ç»**è·å–äº†ä¸€äº›å…³äºä½ çš„å‡­æ®çš„ä¿¡æ¯**ï¼ˆå¦‚æœä½ æ˜¯çº¢é˜Ÿï¼Œå¸Œæœ›ä½ **æ²¡æœ‰è¢«å‘ç°**ï¼‰ã€‚ç°åœ¨æ˜¯æ—¶å€™å¼„æ¸…æ¥šç¯å¢ƒä¸­ä½¿ç”¨äº†å“ªäº›æœåŠ¡äº†ã€‚\
åœ¨ä¸‹é¢çš„éƒ¨åˆ†ä¸­ï¼Œä½ å¯ä»¥æŸ¥çœ‹ä¸€äº›**æšä¸¾ä¸€äº›å¸¸è§æœåŠ¡çš„æ–¹æ³•**ã€‚
{% endhint %}

## æœåŠ¡ä¸»ä½“å’Œè®¿é—®ç­–ç•¥

Azure æœåŠ¡å¯ä»¥æœ‰ä¸€ä¸ªç³»ç»Ÿæ ‡è¯†ï¼ˆæœåŠ¡æœ¬èº«ï¼‰æˆ–ä½¿ç”¨ç”¨æˆ·åˆ†é…çš„æ‰˜ç®¡æ ‡è¯†ã€‚è¿™ä¸ªæ ‡è¯†å¯ä»¥æœ‰è®¿é—®ç­–ç•¥ï¼Œä¾‹å¦‚ï¼Œè®¿é—® KeyVault ä»¥è¯»å–å¯†é’¥ã€‚è¿™äº›è®¿é—®ç­–ç•¥åº”è¯¥æ˜¯å—é™åˆ¶çš„ï¼ˆæœ€å°æƒé™åŸåˆ™ï¼‰ï¼Œä½†å¯èƒ½å…·æœ‰æ¯”æ‰€éœ€æƒé™æ›´å¤šçš„æƒé™ã€‚é€šå¸¸ï¼Œåº”ç”¨æœåŠ¡å°†ä½¿ç”¨ KeyVault æ¥æ£€ç´¢å¯†é’¥å’Œè¯ä¹¦ã€‚

å› æ­¤ï¼Œæ¢ç´¢è¿™äº›æ ‡è¯†æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

## App Service SCM

ä½¿ç”¨ Kudu æ§åˆ¶å°ç™»å½•åˆ° App Service çš„ 'container'ã€‚

## Webshell

ä½¿ç”¨ portal.azure.com å¹¶é€‰æ‹© shellï¼Œæˆ–ä½¿ç”¨ shell.azure.comï¼Œç”¨äº bash æˆ– powershellã€‚è¿™ä¸ª shell çš„ 'disk' å­˜å‚¨ä¸ºå­˜å‚¨å¸æˆ·ä¸­çš„ä¸€ä¸ªé•œåƒæ–‡ä»¶ã€‚

## Azure DevOps

Azure DevOps ä¸ Azure æ˜¯åˆ†å¼€çš„ã€‚å®ƒæœ‰å­˜å‚¨åº“ã€ç®¡é“ï¼ˆyaml æˆ–å‘å¸ƒï¼‰ã€çœ‹æ¿ã€ç»´åŸºç­‰ç­‰ã€‚å˜é‡ç»„ç”¨äºå­˜å‚¨å˜é‡å€¼å’Œå¯†é’¥ã€‚

## è‡ªåŠ¨åŒ–ä¾¦å¯Ÿå·¥å…·

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHoundæ˜¯ä¸€ä¸ªç”¨äºåœ¨Azureç¯å¢ƒä¸­è¿›è¡Œæƒé™åˆ†æå’Œæ”»å‡»è·¯å¾„æ¢ç´¢çš„å·¥å…·ã€‚å®ƒæ˜¯åŸºäºBloodHoundé¡¹ç›®çš„æ‰©å±•ï¼Œå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜è¯†åˆ«Azure ADä¸­çš„æƒé™é—®é¢˜å’Œæ½œåœ¨çš„æ”»å‡»è·¯å¾„ã€‚AzureHoundä½¿ç”¨Azure APIæ¥æ”¶é›†æœ‰å…³Azure ADã€Azureèµ„æºå’ŒAzureè®¢é˜…çš„ä¿¡æ¯ï¼Œå¹¶å°†å…¶å¯¼å…¥BloodHoundå›¾æ•°æ®åº“ä¸­è¿›è¡Œåˆ†æã€‚

ä½¿ç”¨AzureHoundä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨Azure ADä¸­åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸ºè¯¥åº”ç”¨ç¨‹åºæˆäºˆå¿…è¦çš„æƒé™ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨AzureHoundæ¥æ”¶é›†å’Œå¯¼å…¥Azure ADçš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨BloodHoundè¿›è¡Œæƒé™åˆ†æå’Œæ”»å‡»è·¯å¾„æ¢ç´¢ã€‚

è¯·æ³¨æ„ï¼Œä½¿ç”¨AzureHoundéœ€è¦ä¸€å®šçš„Azure ADå’ŒBloodHoundçš„çŸ¥è¯†ã€‚åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»äº†è§£è¿™äº›å·¥å…·çš„åŸºæœ¬åŸç†å’Œæ“ä½œæ–¹æ³•ã€‚

æ›´å¤šå…³äºAzureHoundçš„ä¿¡æ¯å’Œä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒ[GitHubé¡µé¢](https://github.com/BloodHoundAD/AzureHound)ã€‚
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the â€˜Contributorâ€™ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

Azucaræ˜¯ä¸€ä¸ªç”¨äºAzureäº‘ç¯å¢ƒçš„å®‰å…¨è¯„ä¼°å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€äº›æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜å‘ç°å’Œåˆ©ç”¨Azureäº‘ç¯å¢ƒä¸­çš„å®‰å…¨æ¼æ´ã€‚

#### åŠŸèƒ½

- **Azure AD**ï¼šAzucarå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜å‘ç°Azure Active Directoryï¼ˆAzure ADï¼‰ä¸­çš„å®‰å…¨é—®é¢˜ã€‚å®ƒå¯ä»¥æ£€æŸ¥ç”¨æˆ·ã€ç»„ã€åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“çš„æƒé™é…ç½®ï¼Œå¹¶æŸ¥æ‰¾å¯èƒ½å­˜åœ¨çš„æ¼æ´ã€‚

- **Azureèµ„æº**ï¼šAzucarå¯ä»¥æ‰«æAzureèµ„æºï¼Œå¦‚è™šæ‹Ÿæœºã€å­˜å‚¨è´¦æˆ·å’Œæ•°æ®åº“ï¼Œä»¥å‘ç°å¯èƒ½å­˜åœ¨çš„å®‰å…¨é—®é¢˜ã€‚å®ƒå¯ä»¥æ£€æŸ¥è®¿é—®æ§åˆ¶ã€ç½‘ç»œé…ç½®å’Œæ•°æ®å­˜å‚¨ç­‰æ–¹é¢çš„æ¼æ´ã€‚

- **Azureå‡½æ•°**ï¼šAzucarå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜è¯„ä¼°Azureå‡½æ•°çš„å®‰å…¨æ€§ã€‚å®ƒå¯ä»¥æ£€æŸ¥å‡½æ•°çš„æƒé™é…ç½®ã€è¾“å…¥éªŒè¯å’Œä»£ç æ‰§è¡Œç­‰æ–¹é¢çš„æ¼æ´ã€‚

- **Azureå®¹å™¨å®ä¾‹**ï¼šAzucarå¯ä»¥æ‰«æAzureå®¹å™¨å®ä¾‹ï¼Œä»¥å‘ç°å¯èƒ½å­˜åœ¨çš„å®‰å…¨é—®é¢˜ã€‚å®ƒå¯ä»¥æ£€æŸ¥å®¹å™¨å®ä¾‹çš„æƒé™é…ç½®ã€ç½‘ç»œè®¿é—®å’Œå®¹å™¨æ˜ åƒç­‰æ–¹é¢çš„æ¼æ´ã€‚

#### ä½¿ç”¨æ–¹æ³•

1. å…‹éš†Azucarå­˜å‚¨åº“ï¼š

   ```
   git clone https://github.com/nccgroup/azucar.git
   ```

2. å®‰è£…ä¾èµ–é¡¹ï¼š

   ```
   pip install -r requirements.txt
   ```

3. é…ç½®Azureå‡­æ®ï¼š

   åœ¨`azucar.py`æ–‡ä»¶ä¸­ï¼Œå°†`AZURE_CLIENT_ID`ã€`AZURE_CLIENT_SECRET`å’Œ`AZURE_TENANT_ID`æ›¿æ¢ä¸ºæœ‰æ•ˆçš„Azureå‡­æ®ã€‚

4. è¿è¡ŒAzucarï¼š

   ```
   python azucar.py
   ```

   Azucarå°†å¼€å§‹æ‰«æAzureäº‘ç¯å¢ƒï¼Œå¹¶æŠ¥å‘Šå‘ç°çš„å®‰å…¨é—®é¢˜ã€‚

#### æ³¨æ„äº‹é¡¹

- åœ¨ä½¿ç”¨Azucarä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²è·å¾—åˆæ³•çš„æˆæƒï¼Œå¹¶éµå®ˆé€‚ç”¨çš„æ³•å¾‹æ³•è§„ã€‚

- Azucarä»…ç”¨äºåˆæ³•çš„æ¸—é€æµ‹è¯•å’Œå®‰å…¨è¯„ä¼°ç›®çš„ã€‚è¯·å‹¿å°†å…¶ç”¨äºéæ³•æ´»åŠ¨ã€‚

- åœ¨ä½¿ç”¨AzucaræœŸé—´ï¼Œè¯·å°å¿ƒæ“ä½œï¼Œä»¥å…å¯¹ç›®æ ‡ç¯å¢ƒé€ æˆä¸å¿…è¦çš„æŸå®³ã€‚

- ä½œè€…å’Œè´¡çŒ®è€…å¯¹ä½¿ç”¨Azucaré€ æˆçš„ä»»ä½•æŸå¤±æ¦‚ä¸è´Ÿè´£ã€‚ä½¿ç”¨è€…åº”è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨Azucarçš„é£é™©ã€‚

#### è´¡çŒ®

å¦‚æœæ‚¨å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·åœ¨Azucarå­˜å‚¨åº“ä¸­æå‡ºé—®é¢˜æˆ–æäº¤æ‹‰å–è¯·æ±‚ã€‚æˆ‘ä»¬æ¬¢è¿å¹¶æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)

MicroBurstæ˜¯ä¸€æ¬¾ç”¨äºåœ¨Azureäº‘ç¯å¢ƒä¸­è¿›è¡Œç½‘ç»œæµé‡åˆ†æçš„å·¥å…·ã€‚å®ƒå¯ä»¥å¸®åŠ©æ¸—é€æµ‹è¯•äººå‘˜è¯†åˆ«æ½œåœ¨çš„å®‰å…¨æ¼æ´å’Œæ”»å‡»è·¯å¾„ã€‚è¯¥å·¥å…·ä½¿ç”¨Azure Monitor APIæ¥æ•è·å’Œåˆ†æç½‘ç»œæµé‡ï¼Œä»¥ä¾¿å‘ç°å¯èƒ½å­˜åœ¨çš„å®‰å…¨é—®é¢˜ã€‚ä½¿ç”¨MicroBurstï¼Œæ‚¨å¯ä»¥æ£€æµ‹åˆ°å¯èƒ½çš„æ•°æ®æ³„éœ²ã€æ¶æ„æ´»åŠ¨å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)

PowerZureæ˜¯ä¸€ä¸ªç”¨äºåœ¨Azureç¯å¢ƒä¸­è¿›è¡Œæ¸—é€æµ‹è¯•å’Œæƒé™æå‡çš„å·¥å…·é›†ã€‚å®ƒåŸºäºPowerShellï¼Œå¹¶æä¾›äº†ä¸€äº›åŠŸèƒ½å¼ºå¤§çš„æ¨¡å—ï¼Œç”¨äºå‘ç°Azureèµ„æºã€æ‰§è¡Œå‘½ä»¤ã€æ¨ªå‘ç§»åŠ¨å’Œæå‡æƒé™ã€‚

#### å®‰è£…

ä½ å¯ä»¥ä»GitHubä¸Šçš„PowerZureä»“åº“ä¸‹è½½PowerZureçš„æœ€æ–°ç‰ˆæœ¬ã€‚ä¸‹è½½å®Œæˆåï¼Œä½ å¯ä»¥å°†PowerZureè§£å‹åˆ°ä½ çš„æœ¬åœ°æœºå™¨ä¸Šã€‚

#### ä½¿ç”¨

åœ¨ä½¿ç”¨PowerZureä¹‹å‰ï¼Œä½ éœ€è¦å…ˆå®‰è£…Azure PowerShellæ¨¡å—ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š

```powershell
Install-Module -Name Az -AllowClobber -Force
```

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å¯¼å…¥PowerZureæ¨¡å—ï¼š

```powershell
Import-Module .\PowerZure.psd1
```

#### åŠŸèƒ½

PowerZureæä¾›äº†ä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

- **AzAccount**ï¼šç”¨äºç®¡ç†Azureè´¦æˆ·çš„æ¨¡å—ï¼ŒåŒ…æ‹¬ç™»å½•ã€æ³¨é”€å’Œåˆ‡æ¢è´¦æˆ·ã€‚
- **AzResource**ï¼šç”¨äºç®¡ç†Azureèµ„æºçš„æ¨¡å—ï¼ŒåŒ…æ‹¬åˆ—å‡ºèµ„æºã€åˆ›å»ºèµ„æºå’Œåˆ é™¤èµ„æºã€‚
- **AzCommand**ï¼šç”¨äºæ‰§è¡Œå‘½ä»¤çš„æ¨¡å—ï¼ŒåŒ…æ‹¬åœ¨Azureè™šæ‹Ÿæœºä¸Šæ‰§è¡Œå‘½ä»¤å’Œåœ¨Azureå‡½æ•°åº”ç”¨ä¸Šæ‰§è¡Œå‘½ä»¤ã€‚
- **AzLateralMovement**ï¼šç”¨äºæ¨ªå‘ç§»åŠ¨çš„æ¨¡å—ï¼ŒåŒ…æ‹¬åœ¨Azureè™šæ‹Ÿæœºä¹‹é—´è¿›è¡Œç«¯å£è½¬å‘å’Œåœ¨Azureè™šæ‹Ÿç½‘ç»œä¹‹é—´è¿›è¡Œæµé‡è½¬å‘ã€‚
- **AzPrivilegeEscalation**ï¼šç”¨äºæå‡æƒé™çš„æ¨¡å—ï¼ŒåŒ…æ‹¬åœ¨Azureè™šæ‹Ÿæœºä¸ŠæŸ¥æ‰¾ææƒæ¼æ´å’Œåˆ©ç”¨Azure ADæƒé™æå‡ã€‚

#### ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä½¿ç”¨PowerZureçš„ä¸€äº›ç¤ºä¾‹ï¼š

- ç™»å½•åˆ°Azureè´¦æˆ·ï¼š

```powershell
Login-AzAccount
```

- åˆ—å‡ºæ‰€æœ‰Azureèµ„æºï¼š

```powershell
Get-AzResource
```

- åœ¨Azureè™šæ‹Ÿæœºä¸Šæ‰§è¡Œå‘½ä»¤ï¼š

```powershell
Invoke-AzCommand -ResourceGroupName MyResourceGroup -VMName MyVM -Command "ipconfig"
```

- åœ¨Azureè™šæ‹Ÿæœºä¹‹é—´è¿›è¡Œç«¯å£è½¬å‘ï¼š

```powershell
Invoke-AzLateralMovement -SourceVMName MyVM1 -DestinationVMName MyVM2 -SourcePort 8080 -DestinationPort 80
```

- åœ¨Azureè™šæ‹Ÿæœºä¸ŠæŸ¥æ‰¾ææƒæ¼æ´ï¼š

```powershell
Invoke-AzPrivilegeEscalation -VMName MyVM
```

#### æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨PowerZureè¿›è¡Œæ¸—é€æµ‹è¯•æ—¶ï¼Œè¯·ç¡®ä¿ä½ å·²ç»è·å¾—äº†åˆæ³•çš„æˆæƒï¼Œå¹¶ä¸”éµå®ˆé€‚ç”¨çš„æ³•å¾‹æ³•è§„ã€‚ä½¿ç”¨PowerZureè¿›è¡Œæœªç»æˆæƒçš„æ¸—é€æµ‹è¯•æ˜¯è¿æ³•è¡Œä¸ºï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„æ³•å¾‹åæœã€‚è¯·è°¨æ…ä½¿ç”¨PowerZureï¼Œå¹¶å§‹ç»ˆéµå®ˆæ³•å¾‹å’Œé“å¾·è§„èŒƒã€‚
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„å…¬å¸åœ¨ HackTricks ä¸­è¢«å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
