# AWS - í˜ë”ë ˆì´ì…˜ ë‚¨ìš©

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## SAML

SAMLì— ëŒ€í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAMLì„ í†µí•œ Identity Federation**ì„ êµ¬ì„±í•˜ë ¤ë©´ **ì´ë¦„**ê³¼ **SAML êµ¬ì„±**(**ì—”ë“œí¬ì¸íŠ¸**, **ê³µê°œ í‚¤ê°€ ìˆëŠ” ì¸ì¦ì„œ**)ì„ í¬í•¨í•œ **ë©”íƒ€ë°ì´í„° XML**ì„ ì œê³µí•˜ë©´ ë©ë‹ˆë‹¤.

## OIDC - Github Actions ë‚¨ìš©

Identity ê³µê¸‰ìë¡œ github actionì„ ì¶”ê°€í•˜ë ¤ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•˜ì„¸ìš”:

1. _ê³µê¸‰ì ìœ í˜•_ìœ¼ë¡œ **OpenID Connect**ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
2. _ê³µê¸‰ì URL_ì— `https://token.actions.githubusercontent.com`ì„ ì…ë ¥í•©ë‹ˆë‹¤.
3. _Get thumbprint_ë¥¼ í´ë¦­í•˜ì—¬ ê³µê¸‰ìì˜ ì¸í”„ë¦°íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
4. _Audience_ì— `sts.amazonaws.com`ì„ ì…ë ¥í•©ë‹ˆë‹¤.
5. github actionì´ í•„ìš”ë¡œ í•˜ëŠ” **ê¶Œí•œ**ê³¼ ê³µê¸‰ìë¥¼ ì‹ ë¢°í•˜ëŠ” **ì‹ ë¢° ì •ì±…**ì„ ê°€ì§„ **ìƒˆ ì—­í• **ì„ ìƒì„±í•©ë‹ˆë‹¤. ì˜ˆì‹œ:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. ì´ì „ ì •ì±…ì—ì„œ íŠ¹ì • **íŠ¸ë¦¬ê±°**ë¡œ **ì¡°ì§**ì˜ **ì €ì¥ì†Œ**ì˜ **ë¸Œëœì¹˜**ë§Œ í—ˆìš©ë˜ì—ˆìŒì„ í™•ì¸í•˜ì„¸ìš”.
7. github actionì´ **ê°€ì¥í•˜ê²Œ ë ** **ì—­í• **ì˜ **ARN**ì€ github actionì´ ì•Œì•„ì•¼ í•˜ëŠ” "ë¹„ë°€"ì´ë¯€ë¡œ **í™˜ê²½** ë‚´ì˜ **ë¹„ë°€**ì— ì €ì¥í•˜ì„¸ìš”.
8. ë§ˆì§€ë§‰ìœ¼ë¡œ github actionì„ ì‚¬ìš©í•˜ì—¬ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©í•  AWS ìê²© ì¦ëª…ì„ êµ¬ì„±í•˜ì„¸ìš”.
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS ë‚¨ìš©

In this section, we will discuss how to abuse the OpenID Connect (OIDC) authentication mechanism in Amazon Elastic Kubernetes Service (EKS) to gain unauthorized access to resources.

ì´ ì„¹ì…˜ì—ì„œëŠ” Amazon Elastic Kubernetes Service (EKS)ì—ì„œ OpenID Connect (OIDC) ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì„ ë‚¨ìš©í•˜ì—¬ ë¬´ë‹¨ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ë…¼ì˜í•©ë‹ˆë‹¤.

### Introduction

### ì†Œê°œ

Amazon EKS allows you to use OIDC to authenticate users and applications to your Kubernetes cluster. OIDC is an open standard for authentication that allows users to authenticate to multiple applications using a single set of credentials. EKS uses OIDC to authenticate users and applications by leveraging AWS Identity and Access Management (IAM) roles.

Amazon EKSëŠ” OIDCë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì¸ì¦í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. OIDCëŠ” ì‚¬ìš©ìê°€ ë‹¨ì¼ ìê²© ì¦ëª… ì„¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¸ì¦í•  ìˆ˜ ìˆëŠ” ì¸ì¦ì„ ìœ„í•œ ê°œë°©í˜• í‘œì¤€ì…ë‹ˆë‹¤. EKSëŠ” AWS Identity and Access Management (IAM) ì—­í• ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¸ì¦í•˜ê¸° ìœ„í•´ OIDCë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### Exploiting OIDC in EKS

### EKSì—ì„œ OIDC ì•…ìš©í•˜ê¸°

To exploit OIDC in EKS, an attacker needs to perform the following steps:

EKSì—ì„œ OIDCë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ ê³µê²©ìëŠ” ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

1. Identify the target EKS cluster and the associated IAM roles.

   ëŒ€ìƒ EKS í´ëŸ¬ìŠ¤í„°ì™€ ê´€ë ¨ëœ IAM ì—­í• ì„ ì‹ë³„í•©ë‹ˆë‹¤.

2. Enumerate the permissions and policies associated with the IAM roles.

   IAM ì—­í• ê³¼ ê´€ë ¨ëœ ê¶Œí•œ ë° ì •ì±…ì„ ì—´ê±°í•©ë‹ˆë‹¤.

3. Identify the OIDC provider URL and the client ID associated with the EKS cluster.

   EKS í´ëŸ¬ìŠ¤í„°ì™€ ê´€ë ¨ëœ OIDC ì œê³µì URL ë° í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.

4. Register a malicious application with the OIDC provider using the client ID.

   í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ì‚¬ìš©í•˜ì—¬ OIDC ì œê³µìì— ì•…ì„± ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë“±ë¡í•©ë‹ˆë‹¤.

5. Obtain an authorization code by redirecting the victim to the malicious application.

   í”¼í•´ìë¥¼ ì•…ì„± ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ì—¬ ì¸ê°€ ì½”ë“œë¥¼ íšë“í•©ë‹ˆë‹¤.

6. Exchange the authorization code for an access token and ID token.

   ì¸ê°€ ì½”ë“œë¥¼ ì•¡ì„¸ìŠ¤ í† í° ë° ID í† í°ìœ¼ë¡œ êµí™˜í•©ë‹ˆë‹¤.

7. Use the obtained tokens to authenticate and gain unauthorized access to resources in the EKS cluster.

   íšë“í•œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ EKS í´ëŸ¬ìŠ¤í„°ì˜ ë¦¬ì†ŒìŠ¤ì— ì¸ì¦í•˜ê³  ë¬´ë‹¨ìœ¼ë¡œ ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤.

### Mitigation

### ì™„í™” ë°©ë²•

To mitigate the abuse of OIDC in EKS, consider the following measures:

EKSì—ì„œ OIDC ë‚¨ìš©ì„ ì™„í™”í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì¡°ì¹˜ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”:

- Regularly review and audit the IAM roles associated with your EKS cluster to ensure they have the least privileges necessary.

  EKS í´ëŸ¬ìŠ¤í„°ì™€ ê´€ë ¨ëœ IAM ì—­í• ì„ ì •ê¸°ì ìœ¼ë¡œ ê²€í† í•˜ê³  ê°ì‚¬í•˜ì—¬ í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ê°€ì§€ë„ë¡ í•©ë‹ˆë‹¤.

- Implement strong authentication mechanisms, such as multi-factor authentication (MFA), to protect the OIDC provider.

  OIDC ì œê³µìë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ë‹¤ì¤‘ ì¸ì¦ (MFA)ì™€ ê°™ì€ ê°•ë ¥í•œ ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

- Regularly monitor and analyze the logs and events generated by the OIDC provider and the EKS cluster for any suspicious activities.

  OIDC ì œê³µì ë° EKS í´ëŸ¬ìŠ¤í„°ì—ì„œ ìƒì„±ëœ ë¡œê·¸ ë° ì´ë²¤íŠ¸ë¥¼ ì •ê¸°ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ë¶„ì„í•˜ì—¬ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ì„ ê°ì§€í•©ë‹ˆë‹¤.

- Educate users and administrators about the risks and best practices associated with OIDC and EKS security.

  OIDC ë° EKS ë³´ì•ˆê³¼ ê´€ë ¨ëœ ìœ„í—˜ ë° ëª¨ë²” ì‚¬ë¡€ì— ëŒ€í•´ ì‚¬ìš©ì ë° ê´€ë¦¬ìì—ê²Œ êµìœ¡ì„ ì œê³µí•©ë‹ˆë‹¤.
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
**OIDC ê³µê¸‰ì**ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ **EKS** í´ëŸ¬ìŠ¤í„°ì—ì„œ ê°„ë‹¨íˆ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„°ì˜ **OIDC URL**ì„ **ìƒˆë¡œìš´ Open ID Identity ê³µê¸‰ì**ë¡œ ì„¤ì •í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ì´ëŠ” ì¼ë°˜ì ì¸ ê¸°ë³¸ ì •ì±…ì…ë‹ˆë‹¤:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
ì´ ì •ì±…ì€ **id**ê°€ `20C159CDF6F2349B68846BEC03BE031B`ì¸ **EKS í´ëŸ¬ìŠ¤í„°ë§Œ** ì—­í• ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤ê³  ì˜¬ë°”ë¥´ê²Œ ë‚˜íƒ€ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì–´ë–¤ ì„œë¹„ìŠ¤ ê³„ì •ì´ ê·¸ ì—­í• ì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚´ì§€ ì•Šê³  ìˆìœ¼ë¯€ë¡œ, **ì›¹ ì‹ ì› í† í°ì„ ê°€ì§„ ì•„ë¬´ ì„œë¹„ìŠ¤ ê³„ì •ì´** ì—­í• ì„ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

**ì–´ë–¤ ì„œë¹„ìŠ¤ ê³„ì •ì´ ì—­í• ì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ”ì§€ë¥¼ ì§€ì •**í•˜ê¸° ìœ„í•´ì„œëŠ” **ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ì´ ì§€ì •ëœ ì¡°ê±´**ì„ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´:

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## ì°¸ê³  ìë£Œ

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
