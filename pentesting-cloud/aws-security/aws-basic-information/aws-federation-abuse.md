# AWS - ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‚ªç”¨

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**githubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## SAML

SAMLã«ã¤ã„ã¦ã®æƒ…å ±ã¯ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAMLã‚’é€šã˜ãŸã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€**åå‰**ã¨SAMLè¨­å®š(**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã€å…¬é–‹éµã‚’å«ã‚€**è¨¼æ˜æ›¸**)ã‚’å«ã‚€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿XML**ã‚’æä¾›ã™ã‚‹ã ã‘ã§ã™ã€‚

## OIDC - Github Actionsã®æ‚ªç”¨

Githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã«ã¯:

1. _Provider type_ ã§ã€**OpenID Connect**ã‚’é¸æŠã—ã¾ã™ã€‚
2. _Provider URL_ ã« `https://token.actions.githubusercontent.com` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
3. _Get thumbprint_ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ã‚µãƒ ãƒ—ãƒªãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
4. _Audience_ ã« `sts.amazonaws.com` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
5. Githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã¨ã™ã‚‹**æ¨©é™**ã‚’æŒã¤**æ–°ã—ã„ãƒ­ãƒ¼ãƒ«**ã‚’ä½œæˆã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä¿¡é ¼ã™ã‚‹**ä¿¡é ¼ãƒãƒªã‚·ãƒ¼**ã‚’è¨­å®šã—ã¾ã™ã€‚ä¾‹ãˆã°:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. å‰è¿°ã®ãƒãƒªã‚·ãƒ¼ã§ã¯ã€ç‰¹å®šã®**ãƒˆãƒªã‚¬ãƒ¼**ã‚’æŒã¤**çµ„ç¹”**ã®**ãƒªãƒã‚¸ãƒˆãƒª**ã®**ãƒ–ãƒ©ãƒ³ãƒ**ã®ã¿ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
7. Githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ**ãªã‚Šã™ã¾ã™**ã“ã¨ãŒã§ãã‚‹**ãƒ­ãƒ¼ãƒ«**ã®**ARN**ã¯ã€Githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹"ç§˜å¯†"ã«ãªã‚‹ã®ã§ã€**ç’°å¢ƒ**å†…ã®**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**ã«**ä¿å­˜**ã—ã¦ãã ã•ã„ã€‚
8. æœ€å¾Œã«ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã‚‹AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«githubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS ã®æ‚ªç”¨
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®OIDC URLã‚’æ–°ã—ã„Open ID Identity providerã¨ã—ã¦è¨­å®šã™ã‚‹ã“ã¨ã§ã€OIDC providersã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯ä¸€èˆ¬çš„ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ã§ã™ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
ã“ã®ãƒãƒªã‚·ãƒ¼ã¯ã€**id** `20C159CDF6F2349B68846BEC03BE031B` ã‚’æŒã¤**EKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**ã®ã¿ãŒãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ­£ã—ãç¤ºã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãã‚Œã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ãªã„ãŸã‚ã€**ã‚¦ã‚§ãƒ–ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ãŒãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã¹ãã‹**ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ã¯ã€**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹**æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
## å‚è€ƒæ–‡çŒ®

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
