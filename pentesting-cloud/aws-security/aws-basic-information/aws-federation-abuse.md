# AWS - è”åˆæ»¥ç”¨

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## SAML

æœ‰å…³ SAML çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

è¦é€šè¿‡ SAML é…ç½®**èº«ä»½è”åˆ**ï¼Œæ‚¨åªéœ€è¦æä¾›ä¸€ä¸ª**åç§°**å’ŒåŒ…å«æ‰€æœ‰ SAML é…ç½®ï¼ˆ**ç«¯ç‚¹**ã€**å¸¦æœ‰å…¬é’¥çš„è¯ä¹¦**ï¼‰çš„**å…ƒæ•°æ® XML**ã€‚

## OIDC - Github Actions æ»¥ç”¨

è¦å°† github action æ·»åŠ ä¸ºèº«ä»½æä¾›è€…ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. å¯¹äº _Provider type_ï¼Œé€‰æ‹© **OpenID Connect**ã€‚
2. å¯¹äº _Provider URL_ï¼Œè¾“å…¥ `https://token.actions.githubusercontent.com`ã€‚
3. å•å‡» _Get thumbprint_ ä»¥è·å–æä¾›è€…çš„ thumbprintã€‚
4. å¯¹äº _Audience_ï¼Œè¾“å…¥ `sts.amazonaws.com`ã€‚
5. åˆ›å»ºä¸€ä¸ªå…·æœ‰ github action éœ€è¦çš„**æƒé™**å’Œ**ä¿¡ä»»ç­–ç•¥**çš„**æ–°è§’è‰²**ï¼Œè¯¥ç­–ç•¥ä¿¡ä»»æä¾›è€…ï¼Œä¾‹å¦‚ï¼š
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. è¯·æ³¨æ„ï¼Œåœ¨ä¸Šè¿°ç­–ç•¥ä¸­ï¼Œåªæœ‰æ¥è‡ªç»„ç»‡çš„å­˜å‚¨åº“çš„**åˆ†æ”¯**è¢«æˆæƒä½¿ç”¨ç‰¹å®šçš„**è§¦å‘å™¨**ã€‚
7. github action å°†èƒ½å¤Ÿ**å†’å……**çš„**è§’è‰²**çš„**ARN**å°†æˆä¸º github action éœ€è¦çŸ¥é“çš„"ç§˜å¯†"ï¼Œå› æ­¤å°†å…¶å­˜å‚¨åœ¨ç¯å¢ƒçš„**ç§˜å¯†**ä¸­ã€‚
8. æœ€åï¼Œä½¿ç”¨ github action é…ç½®è¦ç”±å·¥ä½œæµç¨‹ä½¿ç”¨çš„ AWS å‡­æ®ï¼š
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS æ»¥ç”¨

In this section, we will discuss how to abuse the OpenID Connect (OIDC) authentication mechanism in Amazon Elastic Kubernetes Service (EKS) to gain unauthorized access to resources.

### Introduction

Amazon EKS allows users to authenticate to their Kubernetes clusters using OIDC. This authentication mechanism relies on the integration between EKS and AWS Identity and Access Management (IAM). When a user authenticates using OIDC, EKS verifies the user's identity with IAM and grants the necessary permissions to access the cluster.

### OIDC Federation Abuse

An attacker can abuse the OIDC federation feature in EKS to gain unauthorized access to the cluster. This can be done by creating a malicious OIDC provider and associating it with the EKS cluster. The attacker can then create a role mapping that grants excessive permissions to the malicious provider.

To abuse OIDC federation in EKS, the attacker needs to perform the following steps:

1. Create a malicious OIDC provider using the AWS CLI or SDKs.
2. Associate the malicious provider with the EKS cluster using the `eksctl` command or the AWS Management Console.
3. Create a role mapping that grants excessive permissions to the malicious provider.
4. Authenticate to the EKS cluster using the malicious provider.

By following these steps, the attacker can gain unauthorized access to the EKS cluster and perform actions that they are not supposed to be able to do.

### Mitigation

To mitigate the abuse of OIDC federation in EKS, it is recommended to follow these best practices:

1. Regularly review and audit the role mappings associated with the OIDC provider.
2. Limit the permissions granted to the OIDC provider to only what is necessary for its intended purpose.
3. Monitor the EKS cluster for any unauthorized access attempts or suspicious activities.
4. Implement strong authentication mechanisms, such as multi-factor authentication (MFA), to protect the OIDC provider.

By implementing these best practices, the risk of OIDC federation abuse in EKS can be significantly reduced.

### Conclusion

Abusing the OIDC federation feature in EKS can lead to unauthorized access to Kubernetes clusters and potential data breaches. It is important for organizations to be aware of this risk and take appropriate measures to secure their EKS clusters. Regular monitoring, auditing, and implementing strong authentication mechanisms are crucial in mitigating the abuse of OIDC federation in EKS.
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
å¯ä»¥é€šè¿‡å°†é›†ç¾¤çš„ OIDC URL è®¾ç½®ä¸ºæ–°çš„ Open ID Identity æä¾›è€…ï¼Œç®€å•åœ°åœ¨ EKS é›†ç¾¤ä¸­ç”Ÿæˆ OIDC æä¾›è€…ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é»˜è®¤ç­–ç•¥ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
è¿™ä¸ªç­–ç•¥æ­£ç¡®åœ°æŒ‡ç¤ºäº†åªæœ‰å…·æœ‰IDä¸º`20C159CDF6F2349B68846BEC03BE031B`çš„EKSé›†ç¾¤å¯ä»¥æ‰®æ¼”è¿™ä¸ªè§’è‰²ã€‚ç„¶è€Œï¼Œå®ƒæ²¡æœ‰æŒ‡æ˜å“ªä¸ªæœåŠ¡è´¦å·å¯ä»¥æ‰®æ¼”è¿™ä¸ªè§’è‰²ï¼Œè¿™æ„å‘³ç€**ä»»ä½•å…·æœ‰Webèº«ä»½ä»¤ç‰Œçš„æœåŠ¡è´¦å·**éƒ½å¯ä»¥æ‰®æ¼”è¿™ä¸ªè§’è‰²ã€‚

ä¸ºäº†æŒ‡å®š**å“ªä¸ªæœåŠ¡è´¦å·å¯ä»¥æ‰®æ¼”è¿™ä¸ªè§’è‰²**ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ª**æ¡ä»¶**ï¼Œå…¶ä¸­åŒ…æ‹¬æŒ‡å®šæœåŠ¡è´¦å·åç§°ï¼Œä¾‹å¦‚ï¼š&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## å‚è€ƒèµ„æ–™

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
