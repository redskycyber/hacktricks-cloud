# AWS - Osnovne informacije

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Organizaciona hijerarhija

![](<../../../.gitbook/assets/image (151).png>)

### Nalozi

U AWS-u postoji **root nalog,** koji je **roditeljski kontejner za sve naloge** vaÅ¡e **organizacije**. MeÄ‘utim, nije potrebno koristiti taj nalog za implementaciju resursa, moÅ¾ete kreirati **druge naloge da biste razdvojili razliÄite AWS** infrastrukture meÄ‘u njima.

Ovo je veoma interesantno sa **bezbednosnog** aspekta, jer **jedan nalog neÄ‡e moÄ‡i pristupiti resursima iz drugog naloga** (osim ako su mostovi specifiÄno kreirani), na ovaj naÄin moÅ¾ete kreirati granice izmeÄ‘u implementacija.

Stoga, postoje **dva tipa naloga u organizaciji** (govorimo o AWS nalozima, a ne korisniÄkim nalozima): jedan nalog koji je odreÄ‘en kao nalog za upravljanje, i jedan ili viÅ¡e Älanskih naloga.

*   **Nalog za upravljanje (root nalog)** je nalog koji koristite za kreiranje organizacije. Iz upravljaÄkog naloga organizacije, moÅ¾ete uraditi sledeÄ‡e:

* Kreirati naloge u organizaciji
* Pozvati druge postojeÄ‡e naloge u organizaciju
* Ukloniti naloge iz organizacije
* Upravljati pozivima
* Primeniti politike na entitete (root, OU ili nalozi) unutar organizacije
* OmoguÄ‡iti integraciju sa podrÅ¾anim AWS uslugama kako bi se obezbedila funkcionalnost usluge Å¡irom svih naloga u organizaciji.
* MoguÄ‡e je prijaviti se kao root korisnik koristeÄ‡i email i lozinku koriÅ¡tene za kreiranje ovog root naloga/organizacije.

Nalog za upravljanje ima **odgovornosti platnog naloga** i odgovoran je za plaÄ‡anje svih troÅ¡kova koji se akumuliraju od strane Älanskih naloga. Ne moÅ¾ete promeniti nalog za upravljanje organizacijom.
* **ÄŒlanski nalozi** Äine sve ostale naloge u organizaciji. Nalog moÅ¾e biti Älan samo jedne organizacije u isto vreme. MoÅ¾ete priloÅ¾iti politiku na nalog da biste primenili kontrole samo na taj nalog.
* ÄŒlanski nalozi **moraÄ‡e koristiti validnu email adresu** i mogu imati **ime**, generalno neÄ‡e moÄ‡i upravljati fakturisanjem (ali im moÅ¾e biti omoguÄ‡en pristup).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organizacione jedinice**

Nalozi mogu biti grupisani u **Organizacione jedinice (OU)**. Na ovaj naÄin, moÅ¾ete kreirati **polise** za Organizacionu jedinicu koje Ä‡e biti **primenjene na sve podraÄune**. Imajte na umu da OU moÅ¾e imati druge OU kao podraÄune.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Politika kontrole usluga (SCP)

**Politika kontrole usluga (SCP)** je politika koja specificira usluge i akcije koje korisnici i uloge mogu koristiti u raÄunima na koje SCP utiÄe. SCP-ovi su **sliÄni IAM** politikama dozvola osim Å¡to **ne dodeljuju nikakve dozvole**. Umesto toga, SCP-ovi specificiraju **maksimalne dozvole** za organizaciju, organizacionu jedinicu (OU) ili raÄun. Kada priloÅ¾ite SCP organizacionom korenu ili OU, **SCP ograniÄava dozvole za entitete u Älanovskim raÄunima**.

Ovo je **JEDINI naÄin** da **Äak i korisnik korena bude zaustavljen** u obavljanju odreÄ‘enih radnji. Na primer, moÅ¾e se koristiti za spreÄavanje korisnika da onemoguÄ‡e CloudTrail ili briÅ¡u rezervne kopije.\
Jedini naÄin zaobiÄ‡i ovo je kompromitovati **glavni raÄun** koji konfiguriÅ¡e SCP-ove (glavni raÄun ne moÅ¾e biti blokiran).

{% hint style="warning" %}
Imajte na umu da **SCP-ovi samo ograniÄavaju principe u raÄunu**, tako da drugi raÄuni nisu pogoÄ‘eni. To znaÄi da zabrana SCP-a za `s3:GetObject` neÄ‡e zaustaviti ljude da **pristupaju javnom S3 spremiÅ¡tu** u vaÅ¡em raÄunu.
{% endhint %}

Primeri SCP-a:

* Potpuna zabrana korenskog raÄuna
* Dozvoljene samo odreÄ‘ene regione
* Dozvoljene samo bele-listirane usluge
*   Zabrana onemoguÄ‡avanja GuardDuty, CloudTrail-a i pristupa javnom S3 spremiÅ¡tu
*   Zabrana brisanja sigurnosnih/odgovornih uloga

ili njihovog menjanja.
* Zabrana brisanja rezervnih kopija.
* Zabrana kreiranja IAM korisnika i pristupnih kljuÄeva

PronaÄ‘ite **JSON primere** na [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** je **jedinstveno ime** koje svaki resurs unutar AWS-a ima, sastavljen je na sledeÄ‡i naÄin:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Napomena da postoje 4 particije u AWS-u, ali samo 3 naÄina da ih nazovete:

* AWS Standard: `aws`
* AWS Kina: `aws-cn`
* AWS US javni internet (GovCloud): `aws-us-gov`
* AWS Tajno (US Klasifikovano): `aws`

## IAM - Identitet i Upravljanje pristupom

IAM je usluga koja Ä‡e vam omoguÄ‡iti da upravljate **Autentifikacijom**, **Autorizacijom** i **Kontrolom pristupa** unutar vaÅ¡eg AWS naloga.

* **Autentifikacija** - Proces definisanja identiteta i verifikacije tog identiteta. Ovaj proces moÅ¾e biti podijeljen na: Identifikaciju i verifikaciju.
* **Autorizacija** - OdreÄ‘uje na Å¡ta identitet moÅ¾e pristupiti unutar sistema nakon Å¡to je autentifikovan.
* **Kontrola pristupa** - Metod i proces kako se pristup odobrava sigurnom resursu.

IAM se moÅ¾e definisati po svojoj sposobnosti da upravlja, kontroliÅ¡e i vlada autentifikacijom, autorizacijom i mehanizmima kontrole pristupa identiteta vaÅ¡im resursima unutar vaÅ¡eg AWS naloga.

### [Korisnik korenskog naloga AWS-a](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Kada prvi put kreirate Amazon Web Services (AWS) nalog, poÄinjete sa jednim identitetom za prijavljivanje koji ima **potpuni pristup svim** AWS uslugama i resursima u nalogu. Ovo je AWS nalog _**korenskog korisnika**_ i pristupa mu se prijavljivanjem sa **email adresom i lozinkom koju ste koristili prilikom kreiranja naloga**.

Napomena da Ä‡e novi **admin korisnik** imati **manje dozvola od korenskog korisnika**.

Sa aspekta bezbednosti, preporuÄljivo je kreirati druge korisnike i izbegavati koriÅ¡Ä‡enje ovog.

### [IAM korisnici](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAM _korisnik_ je entitet koji kreirate u AWS-u da **predstavlja osobu ili aplikaciju** koja ga koristi za **interakciju sa AWS-om**. Korisnik u AWS-u se sastoji od imena i akreditacija (lozinke i do dva pristupna kljuÄa).

Kada kreirate IAM korisnika, dodeljujete mu **dozvole** tako Å¡to ga Äinite **Älanom grupe korisnika** koja ima odgovarajuÄ‡e politike dozvola pridruÅ¾ene (preporuÄljivo), ili **direktnim pridruÅ¾ivanjem politika** korisniku.

Korisnici mogu imati **omoguÄ‡en MFA za prijavljivanje** putem konzole. API tokeni korisnika sa omoguÄ‡enim MFA nisu zaÅ¡tiÄ‡eni MFA-om. Ako Å¾elite **ograniÄiti pristup API kljuÄevima korisnika koriÅ¡Ä‡enjem MFA** morate naznaÄiti u politici da je potrebno prisustvo MFA za obavljanje odreÄ‘enih akcija (primer [**ovde**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID pristupnog kljuÄa**: 20 nasumiÄnih velikih alfanumeriÄkih karaktera poput AKHDNAPO86BSHKDIRYT
* **Tajni ID pristupnog kljuÄa**: 40 nasumiÄnih velikih i malih karaktera: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nije moguÄ‡e povratiti izgubljene tajne ID pristupne kljuÄeve).

Kada god trebate **promeniti pristupni kljuÄ** ovo je proces koji trebate pratiti:\
_Kreirajte novi pristupni kljuÄ -> Primijenite novi kljuÄ na sistem/aplikaciju -> oznaÄite originalni kao neaktivan -> Testirajte i verifikujte da novi pristupni kljuÄ radi -> ObriÅ¡ite stari pristupni kljuÄ_

### MFA - ViÅ¡efaktorska autentifikacija

Koristi se da **kreira dodatni faktor za autentifikaciju** pored vaÅ¡ih postojeÄ‡ih metoda, poput lozinke, stvarajuÄ‡i tako viÅ¡efaktorski nivo autentifikacije.\
MoÅ¾ete koristiti **besplatnu virtuelnu aplikaciju ili fiziÄki ureÄ‘aj**. MoÅ¾ete koristiti aplikacije poput google autentifikacije besplatno da aktivirate MFA u AWS-u.

Politike sa MFA uslovima mogu biti pridruÅ¾ene sledeÄ‡em:

* IAM korisniku ili grupi
* Resursu poput Amazon S3 kante, Amazon SQS reda ili Amazon SNS teme
* PovereniÄkoj politici IAM uloge koju moÅ¾e preuzeti korisnik

Ako Å¾elite **pristupiti putem CLI-ja** resursu koji **proverava MFA** morate pozvati **`GetSessionToken`**. To Ä‡e vam dati token sa informacijama o MFA.\
Napomena da **povereniÄki podaci `AssumeRole` ne sadrÅ¾e ove informacije**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Kako je [**navedeno ovde**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), postoji mnogo razliÄitih sluÄajeva gde se **MFA ne moÅ¾e koristiti**.

### [IAM grupe korisnika](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [grupa korisnika](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) je naÄin da se **pridruÅ¾e politike viÅ¡e korisnika** istovremeno, Å¡to moÅ¾e olakÅ¡ati upravljanje dozvolama za te korisnike. **Uloge i grupe ne mogu biti deo grupe**.

MoÅ¾ete pridruÅ¾iti **politiku zasnovanu na identitetu grupi korisnika** tako da svi **korisnici** u grupi korisnika **dobiju dozvole politike**. Ne moÅ¾ete identifikovati **grupu korisnika** kao **`Principal`** u **politici** (kao Å¡to je politika zasnovana na resursima) jer grupe se odnose na dozvole, a ne na autentifikaciju, a principali su autentifikovani IAM entiteti.

Evo nekih vaÅ¾nih karakteristika grupa korisnika:

* Jedna **grupa** moÅ¾e **sadrÅ¾avati mnogo korisnika**, a **korisnik** moÅ¾e **pripadati viÅ¡e grupa**.
* **Grupe korisnika ne mogu biti ugnjeÅ¾dene**; mogu sadrÅ¾avati samo korisnike, a ne druge grupe korisnika.
* Ne postoji **podrazumevana grupa korisnika koja automatski ukljuÄuje sve korisnike u AWS nalogu**. Ako Å¾elite da imate takvu grupu korisnika, morate je kreirati i dodeliti svakom novom korisniku.
* Broj i veliÄina IAM resursa u AWS nalogu, kao Å¡to su broj grupa i broj grupa kojima korisnik moÅ¾e pripadati, su ograniÄeni. Za viÅ¡e informacija, pogledajte [IAM i AWS STS kvote](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [IAM uloge](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **uloga** je veoma **sliÄna** **korisniku**, jer je to **identitet sa politikama dozvola koje odreÄ‘uju Å¡ta** moÅ¾e i ne moÅ¾e raditi u AWS. MeÄ‘utim, uloga **nema nikakve akreditive** (Å¡ifru ili pristupne kljuÄeve) povezane sa njom. Umesto Å¡to je jedinstveno povezana sa jednom osobom, uloga je namenjena da bude **preuzimljiva od strane bilo koga ko je potreban (i ima dovoljno dozvola)**. IAM korisnik moÅ¾e preuzeti ulogu da privremeno preuzme razliÄite dozvole za odreÄ‘eni zadatak. Uloga moÅ¾e biti **dodeljena** [**federativnom korisniku**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) koji se prijavljuje koristeÄ‡i spoljni provajder identiteta umesto IAM-a.

IAM uloga se sastoji od **dva tipa politika**: **povereniÄka politika**, koja ne moÅ¾e biti prazna, definiÅ¡e **ko moÅ¾e preuzeti** ulogu, i **dozvole politike**, koje ne mogu biti prazne, definiÅ¡u **na Å¡ta moÅ¾e pristupiti**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) je web servis koji olakÅ¡ava **izdavanje privremenih, ograniÄenih privilegovanih akreditiva**. SpecifiÄno je prilagoÄ‘en za:

### [Privremeni akreditivi u IAM-u](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Privremeni akreditivi se koriste preteÅ¾no sa IAM ulogama**, ali postoje i drugi sluÄajevi. MoÅ¾ete zatraÅ¾iti privremene akreditive koji imaju set dozvola sa stroÅ¾ijim ograniÄenjima od vaÅ¡eg standardnog IAM korisnika. Ovo **spreÄava** vas da **sluÄajno obavljate zadatke koji nisu dozvoljeni** sa stroÅ¾ijim akreditivima. Prednost privremenih akreditiva je Å¡to automatski istiÄu nakon odreÄ‘enog vremenskog perioda. Imate kontrolu nad trajanjem vaÅ¾enja akreditiva.

### Politike

#### Dozvole politika

Koriste se za dodelu dozvola. Postoje 2 tipa:

* AWS upravljane politike (unapred konfigurisane od strane AWS-a)
* KorisniÄki upravljane politike: Konfigurisane od strane vas. MoÅ¾ete kreirati politike zasnovane na AWS upravljanim politikama (modifikujuÄ‡i jednu od njih i kreirajuÄ‡i svoju), koristeÄ‡i generator politika (GUI prikaz koji vam pomaÅ¾e da dodeljujete i odbijate dozvole) ili piÅ¡uÄ‡i svoje vlastite..

Po **podrazumevanom pristupu** je **odbijen**, pristup Ä‡e biti odobren ako je eksplicitno navedena uloga.\
Ako postoji **jedno "Odbij" pravilo, ono Ä‡e prebrisati "Dozvoli"**, osim za zahteve koji koriste osnovne bezbednosne akreditive AWS naloga (koji su podrazumevano dozvoljeni).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalna polja koja se mogu koristiti za uslove u bilo kojoj usluzi dokumentovana su ovde](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[SpecifiÄna polja koja se mogu koristiti za uslove po usluzi dokumentovana su ovde](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Politike

Ova vrsta politika se **direktno dodeljuje** korisniku, grupi ili ulozi. Zatim, ne pojavljuju se u listi politika kao Å¡to se mogu koristiti druge.\
Inline politike su korisne ako Å¾elite da **odrÅ¾avate strogu jedan-na-jedan vezu izmeÄ‘u politike i identiteta** na koji se primenjuje. Na primer, Å¾elite da budete sigurni da dozvole u politici nisu nenamerno dodeljene identitetu za koji nisu namenjene. Kada koristite inline politiku, dozvole u politici ne mogu biti nenamerno pridodate pogreÅ¡nom identitetu. Pored toga, kada koristite AWS Management konzolu za brisanje tog identiteta, politike ugraÄ‘ene u identitet takoÄ‘e se briÅ¡u. To je zato Å¡to su deo glavne entiteta.

#### Politike za resurse

Ovo su **politike** koje se mogu definisati u **resursima**. **Nisu svi resursi AWS-a podrÅ¾ani**.

Ako glavni subjekt nema eksplicitno odbijanje na njima, i politika resursa im dodeljuje pristup, tada su dozvoljeni.

### IAM Granice

IAM granice se mogu koristiti da **ograniÄe dozvole koje korisnik ili uloga treba da ima pristup**. Na ovaj naÄin, Äak i ako korisniku bude dodeljen **razliÄit set dozvola** putem **razliÄite politike**, operacija Ä‡e **neuspeti** ako pokuÅ¡a da ih koristi.

Granica je samo politika pridruÅ¾ena korisniku koja **ukazuje na maksimalni nivo dozvola koje korisnik ili uloga mogu imati**. Dakle, **Äak i ako korisnik ima administratorski pristup**, ako granica ukazuje da moÅ¾e samo Äitati S3 kante, to je maksimum koji moÅ¾e uraditi.

**Ovo**, **SCPs** i **princip najmanjih privilegija** su naÄini da se kontroliÅ¡e da korisnici nemaju viÅ¡e dozvola nego Å¡to im je potrebno.

### Politike sesije

Politika sesije je **politika postavljena kada se uloga pretpostavi** na neki naÄin. To Ä‡e biti kao **IAM granica za tu sesiju**: To znaÄi da politika sesije ne dodeljuje dozvole veÄ‡ ih **ograniÄava na one navedene u politici** (pri Äemu su maksimalne dozvole one koje uloga ima).

Ovo je korisno za **mere bezbednosti**: Kada administrator preuzima veoma privilegovanu ulogu, moÅ¾e ograniÄiti dozvole samo na one navedene u politici sesije u sluÄaju da sesija bude kompromitovana.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Napomena da **AWS po defaultu moÅ¾e dodati sesijske politike sesijama** koje Ä‡e biti generisane zbog treÄ‡ih razloga. Na primer, u [neautentifikovanim kognito pretpostavljenim ulogama](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) po defaultu (koristeÄ‡i poboljÅ¡anu autentifikaciju), AWS Ä‡e generisati **sesijske akreditive sa sesijskom politikom** koja ograniÄava usluge kojima sesija moÅ¾e pristupiti [**na sledeÄ‡oj listi**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Stoga, ako u nekom trenutku naiÄ‘ete na greÅ¡ku "... jer nijedna sesijska politika ne dozvoljava ...", a uloga ima pristup za obavljanje radnje, to je zato Å¡to **postoji sesijska politika koja to spreÄava**.

### Identitetska federacija

Identitetska federacija **omoguÄ‡ava korisnicima iz spoljnih provajdera identiteta** da pristupe AWS resursima bezbedno, bez potrebe za snabdevanjem AWS korisniÄkim akreditivima iz validnog IAM korisniÄkog naloga.\
Primer identitetskog provajdera moÅ¾e biti vaÅ¡ sopstveni korporativni **Microsoft Active Directory**(putem **SAML**) ili **OpenID** servisi (kao Å¡to je **Google**). Federisani pristup Ä‡e zatim omoguÄ‡iti korisnicima unutar njega pristup AWS-u.

Za konfigurisanje ovog poverenja, generiÅ¡e se **IAM provajder identiteta (SAML ili OAuth)** koji Ä‡e **poveriti** **drugu platformu**. Zatim, bar jedna **IAM uloga je dodeljena (poverava se) provajderu identiteta**. Ako korisnik sa poverene platforme pristupi AWS-u, pristupiÄ‡e kao pomenuta uloga.

MeÄ‘utim, obiÄno Ä‡ete Å¾eleti da dodelite **razliÄitu ulogu u zavisnosti od grupe korisnika** u platformi treÄ‡eg lica. Zatim, nekoliko **IAM uloga moÅ¾e poveriti** provajderu identiteta treÄ‡eg lica i treÄ‡a platforma Ä‡e omoguÄ‡iti korisnicima da pretpostave jednu ili drugu ulogu.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM Centar identiteta

AWS IAM Centar identiteta (naslednik AWS Single Sign-On) proÅ¡iruje moguÄ‡nosti AWS Identity and Access Management (IAM) pruÅ¾ajuÄ‡i **centralno mesto** koje objedinjuje **administraciju korisnika i njihov pristup AWS** nalozima i cloud aplikacijama.

Domen za prijavu Ä‡e biti neÅ¡to poput `<user_input>.awsapps.com`.

Za prijavu korisnika, mogu se koristiti 3 izvora identiteta:

* Direktorijum Centra identiteta: Redovni AWS korisnici
* Active Directory: PodrÅ¾ava razliÄite konektore
* Spoljni provajder identiteta: Svi korisnici i grupe dolaze iz spoljnog provajdera identiteta (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

U najjednostavnijem sluÄaju direktorijuma Centra identiteta, **Centar identiteta Ä‡e imati listu korisnika i grupa** i moÄ‡i Ä‡e im **dodeliti politike** za **bilo koji od naloga** organizacije.

Da bi se omoguÄ‡io pristup korisniku/grupi Centra identiteta na nalog, **SAML provajder identiteta koji poverava Centar identiteta Ä‡e biti kreiran**, i **uloga koja poverava provajdera identiteta sa naznaÄenim politikama Ä‡e biti kreirana** u odrediÅ¡nom nalogu.

#### AwsSSOInlinePolicy

MoguÄ‡e je **dodeliti dozvole putem ugraÄ‘enih politika ulogama kreiranim putem IAM Centra identiteta**. Uloge kreirane u nalozima kojima su dodeljene **ugraÄ‘ene politike u AWS Centru identiteta** Ä‡e imati ove dozvole u ugraÄ‘enoj politici nazvanoj **`AwsSSOInlinePolicy`**.

Stoga, Äak i ako vidite 2 uloge sa ugraÄ‘enom politikom nazvanom **`AwsSSOInlinePolicy`**, to **ne znaÄi da imaju iste dozvole**.

### Poverenja i uloge izmeÄ‘u naloga

**Korisnik** (poverava) moÅ¾e kreirati ulogu izmeÄ‘u naloga sa odreÄ‘enim politikama i zatim, **dozvoliti drugom korisniku** (poverenom) da **pristupi njegovom nalogu** ali samo **sa pristupom naznaÄenim u politikama nove uloge**. Da biste to kreirali, jednostavno kreirajte novu ulogu i izaberite Ulogu izmeÄ‘u naloga. Uloge za pristup izmeÄ‘u naloga nude dve opcije. PruÅ¾anje pristupa izmeÄ‘u AWS naloga koje posedujete, i pruÅ¾anje pristupa izmeÄ‘u naloga koje posedujete i AWS naloga treÄ‡eg lica.\
PreporuÄuje se da **specifikujete korisnika koji je poveren i ne stavljate neÅ¡to generiÄko** jer u suprotnom, drugi autentifikovani korisnici poput federisanih korisnika takoÄ‘e Ä‡e moÄ‡i zloupotrebiti ovo poverenje.

### AWS Jednostavni AD

Nije podrÅ¾ano:

* Poverenja
* AD Admin Centar
* Potpuna podrÅ¡ka za PS API
* AD Korpa za otpatke
* Grupisani upravljani servisni nalozi
* ProÅ¡irenja Å¡eme
* Nema direktnog pristupa OS-u ili instancama

#### Web federacija ili OpenID autentifikacija

Aplikacija koristi AssumeRoleWithWebIdentity za kreiranje privremenih akreditiva. MeÄ‘utim, ovo ne daje pristup AWS konzoli, veÄ‡ pristup resursima unutar AWS-a.

### Druge IAM opcije

* MoÅ¾ete **postaviti politiku lozinke** sa opcijama kao Å¡to su minimalna duÅ¾ina i zahtevi za lozinku.
* MoÅ¾ete **preuzeti "IzveÅ¡taj o akreditivima"** sa informacijama o trenutnim akreditivima (kao Å¡to su vreme kreiranja korisnika, da li je lozinka omoguÄ‡ena...). MoÅ¾ete generisati izveÅ¡taj o akreditivima najÄeÅ¡Ä‡e jednom svakih **Äetiri sata**.

AWS Identity and Access Management (IAM) pruÅ¾a **detaljnu kontrolu pristupa** Å¡irom AWS-a. Sa IAM-om, moÅ¾ete odrediti **ko moÅ¾e pristupiti kojim uslugama i resursima**, i pod kojim uslovima. Sa IAM politikama, upravljate dozvolama vaÅ¡em radnom osoblju i sistemima kako biste **osigurali dozvole sa najmanje privilegija**.

### IAM ID Prefiksi

Na [**ovoj stranici**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) moÅ¾ete pronaÄ‡i **IAM ID prefikse** kljuÄeva u zavisnosti od njihove prirode:

| ABIA | [AWS STS servisni nosilac tokena](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kontekstualni specifiÄni akreditiv                                                                                                                                                                                           |
| AGPA | KorisniÄka grupa                                                                                                                                                                                                            |
| AIDA | IAM korisnik                                                                                                                                                                                                              |
| AIPA | Amazon EC2 profil instance                                                                                                                                                                                           |
| AKIA | Pristupni kljuÄ                                                                                                                                                                                                            |
| ANPA | Upravljana politika                                                                                                                                                                                                        |
| ANVA | Verzija u upravljanoj politici                                                                                                                                                                                           |
| APKA | Javni kljuÄ                                                                                                                                                                                                            |
| AROA | Uloga                                                                                                                                                                                                                  |
| ASCA | Sertifikat                                                                                                                                                                                                           |
| ASIA | [Privremeni (AWS STS) ID kljuÄevi pristupa](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) koriste ovaj prefiks, ali su jedinstveni samo u kombinaciji sa tajnim pristupnim kljuÄem i tokenom sesije. |

### PreporuÄene dozvole za proveru naloga

SledeÄ‡e privilegije omoguÄ‡avaju razliÄit pristup metapodacima:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Razno

### CLI Autentifikacija

Da bi obiÄan korisnik autentifikovao se na AWS putem CLI-a, potrebno je imati **lokalne akreditive**. Po defaultu ih moÅ¾ete konfigurisati **ruÄno** u `~/.aws/credentials` ili **pokretanjem** `aws configure`.\
U tom fajlu moÅ¾ete imati viÅ¡e od jednog profila, ako **nije specificiran profil** koristeÄ‡i **aws cli**, biÄ‡e koriÅ¡Ä‡en onaj nazvan **`[default]`** u tom fajlu.\
Primer fajla sa akreditivima sa viÅ¡e od 1 profila:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Ako treba da pristupite **razliÄitim AWS nalozima** i vaÅ¡em profilu je data dozvola da **pretpostavi ulogu unutar tih naloga**, ne morate ruÄno pozivati STS svaki put (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurisati akreditive.

MoÅ¾ete koristiti datoteku `~/.aws/config` da [**naznaÄite koje uloge pretpostaviti**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a zatim koristiti `--profile` parametar kao i obiÄno (pretpostavljanje uloge Ä‡e se obaviti na transparentan naÄin za korisnika).\
Primer konfiguracione datoteke:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Sa ovom konfiguracionom datotekom moÅ¾ete koristiti aws cli na sledeÄ‡i naÄin:
```
aws --profile acc2 ...
```
Ako traÅ¾ite neÅ¡to **sliÄno** ovome ali za **pregledaÄ** moÅ¾ete proveriti **dodatak** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Reference

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
