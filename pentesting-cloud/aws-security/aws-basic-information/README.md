# AWS - Podstawowe informacje

<details>

<summary><strong>Zacznij nauk hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>

## Hierarchia Organizacyjna

![](<../../../.gitbook/assets/image (151).png>)

### Konta

W AWS istnieje **konto g贸wne,** kt贸re jest **kontenerem nadrzdnym dla wszystkich kont** twojej **organizacji**. Jednak nie musisz u偶ywa tego konta do wdra偶ania zasob贸w, mo偶esz tworzy **inne konta do separacji r贸偶nych infrastruktur AWS** midzy nimi.

Jest to bardzo interesujce z punktu widzenia **bezpieczestwa**, poniewa偶 **jedno konto nie bdzie mogo uzyska dostpu do zasob贸w z innego konta** (chyba 偶e zostan specjalnie utworzone mosty), dziki czemu mo偶na tworzy granice midzy wdro偶eniami.

Dlatego istniej **dwa rodzaje kont w organizacji** (m贸wimy tutaj o kontach AWS, a nie kontach u偶ytkownik贸w): jedno konto, kt贸re jest wyznaczone jako konto zarzdzajce, oraz jedno lub wicej kont czonkowskich.

*   **Konto zarzdzajce (konto g贸wne)** to konto, kt贸re u偶ywasz do tworzenia organizacji. Z konta zarzdzajcego organizacj mo偶esz:

* Tworzy konta w organizacji
* Zaprasza inne istniejce konta do organizacji
* Usuwa konta z organizacji
* Zarzdza zaproszeniami
* Stosowa zasady do jednostek (korzenie, OU lub konta) w ramach organizacji
* Wcza integracj z obsugiwanymi usugami AWS, aby zapewni funkcjonalno usugi we wszystkich kontach w organizacji.
* Mo偶liwe jest zalogowanie si jako u偶ytkownik g贸wny, u偶ywajc adresu e-mail i hasa u偶ytych do utworzenia tego konta g贸wnego/organizacji.

Konto zarzdzajce ma **obowizki konta patnika** i odpowiada za opacanie wszystkich opat naliczanych przez konta czonkowskie. Nie mo偶na zmieni konta zarzdzajcego organizacj.
* **Konta czonkowskie** stanowi wszystkie pozostae konta w organizacji. Konto mo偶e by czonkiem tylko jednej organizacji w danym czasie. Mo偶esz doczy zasad do konta, aby zastosowa kontrole tylko do tego jednego konta.
* Konta czonkowskie **musz u偶ywa prawidowego adresu e-mail** i mog mie **nazw**, zazwyczaj nie bd mogy zarzdza rozliczeniami (ale mog otrzyma do nich dostp).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Jednostki Organizacyjne**

Konta mo偶na grupowa w **Jednostki Organizacyjne (OU)**. W ten spos贸b mo偶na tworzy **polityki** dla Jednostki Organizacyjnej, kt贸re zostan **zastosowane do wszystkich kont potomnych**. Zauwa偶, 偶e OU mo偶e mie inne OU jako dzieci.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Polityka kontroli usug (SCP)

**Polityka kontroli usug (SCP)** to polityka okrelajca usugi i dziaania, kt贸rych u偶ytkownicy i role mog u偶ywa w kontach, na kt贸re wpywa SCP. SCP s **podobne do polityk uprawnie IAM**, z tym 偶e **nie przyznaj 偶adnych uprawnie**. Zamiast tego SCP okrelaj **maksymalne uprawnienia** dla organizacji, jednostki organizacyjnej (OU) lub konta. Gdy doczysz SCP do korzenia organizacji lub OU, **SCP ogranicza uprawnienia dla podmiot贸w w kontach czonkowskich**.

To jest **JEDYNY spos贸b, aby nawet u偶ytkownik root m贸g zosta zatrzymany** przed zrobieniem czego. Na przykad, mo偶e by u偶yty do zatrzymania u偶ytkownik贸w przed wyczeniem CloudTrail lub usuwaniem kopii zapasowych.\
Jedynym sposobem obejcia tego jest skompromitowanie r贸wnie偶 **konta g贸wnego**, kt贸re konfiguruje SCP (konto g贸wne nie mo偶e by zablokowane).

{% hint style="warning" %}
Zauwa偶, 偶e **SCPy ograniczaj tylko podmioty w koncie**, wic inne konta nie s dotknite. Oznacza to, 偶e odmowa SCP dla `s3:GetObject` nie zatrzyma ludzi przed **dostpem do publicznego kubeka S3** w twoim koncie.
{% endhint %}

Przykady SCP:

* Zablokuj konto root w caoci
* Pozw贸l tylko na okrelone regiony
* Pozw贸l tylko na usugi z biaej listy
*   Zablokuj mo偶liwo wyczenia GuardDuty, CloudTrail i dostpu do publicznego kubeka S3
*   Zablokuj mo偶liwo usuwania lub modyfikowania r贸l bezpieczestwa/reagowania na incydenty
* Zablokuj usuwanie kopii zapasowych
* Zablokuj tworzenie u偶ytkownik贸w IAM i kluczy dostpu

Znajd藕 **przykady JSON** pod adresem [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** to **unikalna nazwa**, kt贸r ma ka偶dy zas贸b w AWS, jest ona skonstruowana w ten spos贸b:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Zauwa偶, 偶e w AWS s 4 partycje, ale tylko 3 sposoby, aby si do nich odwoa:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM to usuga, kt贸ra umo偶liwia zarzdzanie **Autoryzacj**, **Uwierzytelnianiem** i **Kontrol Dostpu** wewntrz Twojego konta AWS.

* **Uwierzytelnianie** - Proces definiowania to偶samoci i weryfikacji tej to偶samoci. Proces ten mo偶na podzieli na: Identyfikacj i weryfikacj.
* **Autoryzacja** - Okrela, do czego dana to偶samo mo偶e uzyska dostp w systemie po uwierzytelnieniu.
* **Kontrola Dostpu** - Metoda i proces przyznawania dostpu do zasobu zabezpieczonego

IAM mo偶na zdefiniowa poprzez zdolno do zarzdzania, kontrolowania i regulowania mechanizm贸w uwierzytelniania, autoryzacji i kontroli dostpu to偶samoci do zasob贸w w Twoim koncie AWS.

### [Konto g贸wne u偶ytkownika AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Gdy tworzysz konto Amazon Web Services (AWS), zaczynasz od pojedynczej to偶samoci logowania, kt贸ra ma **peny dostp do wszystkich** usug i zasob贸w AWS w koncie. Jest to u偶ytkownik _**root**_ konta AWS i uzyskuje si do niego, logujc si za pomoc **adresu e-mail i hasa, kt贸rych u偶ye do utworzenia konta**.

Nowy **u偶ytkownik admina** bdzie mia **mniej uprawnie ni偶 u偶ytkownik root**.

Z punktu widzenia bezpieczestwa zaleca si tworzenie innych u偶ytkownik贸w i unikanie korzystania z tego.

### [U偶ytkownicy IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

U偶ytkownik IAM to jednostka, kt贸r tworzysz w AWS, aby **reprezentowa osob lub aplikacj**, kt贸ra z niej korzysta do **interakcji z AWS**. U偶ytkownik w AWS skada si z nazwy i powiadcze (hasa i maksymalnie dw贸ch kluczy dostpu).

Tworzc u偶ytkownika IAM, nadajesz mu **uprawnienia**, uczyniajc go **czonkiem grupy u偶ytkownik贸w** z odpowiednimi polisami uprawnie (zalecane), lub **bezporednio doczajc polisy** do u偶ytkownika.

U偶ytkownicy mog mie **wczone MFA do logowania** przez konsol. Tokeny API u偶ytkownik贸w z wczonym MFA nie s chronione przez MFA. Jeli chcesz **ograniczy dostp kluczy API u偶ytkownik贸w za pomoc MFA**, musisz wskaza w polisie, 偶e do wykonania okrelonych dziaa wymagane jest MFA (przykad [**tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID klucza dostpu**: 20 losowych wielkich liter i cyfr, np. AKHDNAPO86BSHKDIRYT
* **Tajny klucz dostpu**: 40 losowych du偶ych i maych liter: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nie mo偶na odzyska utraconego tajnego klucza dostpu).

Zawsze gdy chcesz **zmieni klucz dostpu**, powiniene postpowa zgodnie z tym procesem:\
_Utw贸rz nowy klucz dostpu -> Zastosuj nowy klucz do systemu/aplikacji -> oznacz oryginalny jako nieaktywny -> Przetestuj i zweryfikuj, czy nowy klucz dostpu dziaa -> Usu stary klucz dostpu_

### MFA - Multi Factor Authentication

Su偶y do **utworzenia dodatkowego czynnika uwierzytelniania** opr贸cz istniejcych metod, takich jak haso, tworzc tym samym wieloczynnikowy poziom uwierzytelniania.\
Mo偶esz u偶y **darmowej aplikacji wirtualnej lub urzdzenia fizycznego**. Mo偶esz u偶y aplikacji, takiej jak uwierzytelnianie Google za darmo, aby aktywowa MFA w AWS.

Polisy z warunkami MFA mog by doczone do:

* U偶ytkownika IAM lub grupy
* Zasobu, takiego jak kubeek Amazon S3, kolejka Amazon SQS lub temat Amazon SNS
* Polityki zaufania roli IAM, kt贸r mo偶e przyj u偶ytkownik

Jeli chcesz **uzyska dostp za pomoc CLI** do zasobu, kt贸ry **sprawdza MFA**, musisz wywoa **`GetSessionToken`**. To dostarczy Ci token z informacj o MFA.\
Zauwa偶, 偶e **powiadczenia z `AssumeRole` nie zawieraj tej informacji**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Jak [**stwierdzono tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), istnieje wiele r贸偶nych przypadk贸w, w kt贸rych **MFA nie mo偶e by u偶ywane**.

### [Grupy u偶ytkownik贸w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Grupa u偶ytkownik贸w IAM to spos贸b **doczania zasad do wielu u偶ytkownik贸w** jednoczenie, co uatwia zarzdzanie uprawnieniami dla tych u偶ytkownik贸w. **Role i grupy nie mog by czci grupy**.

Mo偶esz doczy **zasad opart na to偶samoci do grupy u偶ytkownik贸w**, dziki czemu wszyscy **u偶ytkownicy** w grupie u偶ytkownik贸w **otrzymuj uprawnienia z zasad**. **Nie mo偶esz** zidentyfikowa **grupy u偶ytkownik贸w** jako **`Principal`** w **zasadzie** (takiej jak zasada oparta na zasobach), poniewa偶 grupy odnosz si do uprawnie, a nie uwierzytelniania, a podmioty s uwierzytelnionymi jednostkami IAM.

Oto kilka wa偶nych cech grup u偶ytkownik贸w:

* Grupa **mo偶e zawiera wielu u偶ytkownik贸w**, a **u偶ytkownik** mo偶e nale偶e do wielu grup**.
* **Grupy u偶ytkownik贸w nie mog by zagnie偶d偶ane**; mog zawiera tylko u偶ytkownik贸w, a nie inne grupy u偶ytkownik贸w.
* Nie ma **domylnej grupy u偶ytkownik贸w, kt贸ra automatycznie zawieraaby wszystkich u偶ytkownik贸w w koncie AWS**. Jeli chcesz mie tak grup u偶ytkownik贸w, musisz j utworzy i przypisa do niej ka偶dego nowego u偶ytkownika.
* Liczba i rozmiar zasob贸w IAM w koncie AWS, takich jak liczba grup i liczba grup, do kt贸rych u偶ytkownik mo偶e nale偶e, s ograniczone. Aby uzyska wicej informacji, zobacz [limity IAM i AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Role IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Rola IAM jest bardzo **podobna** do **u偶ytkownika**, poniewa偶 jest to **to偶samo z zasadami uprawnie okrelajcymi**, co mo偶e i czego nie mo偶e robi w AWS. Jednak rola **nie ma przypisanych 偶adnych powiadcze** (hasa ani kluczy dostpu). Zamiast by unikalnie powizan z jedn osob, rola ma by **przyjmowalna przez ka偶dego, kto jej potrzebuje (i ma wystarczajce uprawnienia)**. U偶ytkownik IAM mo偶e przyj rol, aby tymczasowo **przyj inne uprawnienia do okrelonego zadania**. Rol mo偶na **przypisa do** [**u偶ytkownika federacyjnego**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html), kt贸ry loguje si, korzystajc z zewntrznego dostawcy to偶samoci zamiast IAM.

Rola IAM skada si z **dw贸ch rodzaj贸w zasad**: **zasady zaufania**, kt贸ra nie mo偶e by pusta, okrelajca **kto mo偶e przyj** rol, oraz **zasady uprawnie**, kt贸ra nie mo偶e by pusta, okrelajca **do czego ma dostp**.

#### Usuga AWS Security Token Service (STS)

Usuga AWS Security Token Service (STS) to usuga sieciowa uatwiajca **wydawanie tymczasowych, ograniczonych uprawnie**. Jest ona specjalnie dostosowana do:

### [Tymczasowe powiadczenia w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tymczasowe powiadczenia s g贸wnie u偶ywane z rolami IAM**, ale istniej tak偶e inne zastosowania. Mo偶esz poprosi o tymczasowe powiadczenia, kt贸re maj bardziej ograniczony zestaw uprawnie ni偶 standardowy u偶ytkownik IAM. **Zapobiega to** przypadkowemu wykonywaniu zada, kt贸re nie s dozwolone przez bardziej ograniczone powiadczenia. Korzyci z tymczasowych powiadcze jest automatyczne wyganicie po okrelonym czasie. Masz kontrol nad czasem wa偶noci powiadcze.

### Zasady

#### Uprawnienia zasad

Su偶 do przypisywania uprawnie. Istniej 2 rodzaje:

* Zarzdzane przez AWS zasady (prekonfigurowane przez AWS)
* Zasady zarzdzane przez klienta: Skonfigurowane przez Ciebie. Mo偶esz tworzy zasady oparte na zarzdzanych przez AWS zasadach (modyfikujc jedn z nich i tworzc swoj wasn), korzystajc z generatora zasad (widok GUI, kt贸ry pomaga w przyznawaniu i odmawianiu uprawnie) lub piszc wasne.

Domylnie dostp jest **zablokowany**, dostp zostanie udzielony, jeli zostaa okrelona jasna rola.\
Jeli istnieje **pojedyncze "Odm贸w", to zastpi "Zezw贸l"**, z wyjtkiem 偶da korzystajcych z podstawowych powiadcze bezpieczestwa konta AWS (kt贸re s domylnie dozwolone).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalne pola, kt贸re mo偶na u偶ywa do warunk贸w w dowolnej usudze s udokumentowane tutaj](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[Specyficzne pola, kt贸re mo偶na u偶ywa do warunk贸w na poziomie usugi s udokumentowane tutaj](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Polityki osadzone

Ten rodzaj polityk jest **bezporednio przypisany** do u偶ytkownika, grupy lub roli. Wtedy nie pojawiaj si one na licie polityk, poniewa偶 ka偶dy inny mo偶e ich u偶ywa.\
Osadzone polityki s przydatne, jeli chcesz **utrzyma ciy zwizek jeden do jednego midzy polityk a to偶samoci**, do kt贸rej jest zastosowana. Na przykad chcesz upewni si, 偶e uprawnienia w polityce nie s przypadkowo przypisane do to偶samoci innego ni偶 ta, dla kt贸rej s przeznaczone. Gdy u偶ywasz osadzonej polityki, uprawnienia w polityce nie mog by przypadkowo przypisane do niewaciwej to偶samoci. Ponadto, gdy u偶ywasz AWS Management Console do usunicia tej to偶samoci, osadzone w to偶samoci polityki r贸wnie偶 s usuwane. Dzieje si tak, poniewa偶 s one czci podmiotu g贸wnego.

#### Polityki zasob贸w kubeka

S to **polityki**, kt贸re mo偶na zdefiniowa w **zasobach**. **Nie wszystkie zasoby AWS je obsuguj**.

Jeli podmiot nie ma jawnego odmowy dostpu do nich, a polityka zasobu przyznaje im dostp, to s one dozwolone.

### Granice IAM

Granice IAM mo偶na u偶y do **ograniczenia uprawnie, do kt贸rych u偶ytkownik lub rola powinny mie dostp**. W ten spos贸b, nawet jeli inny zestaw uprawnie jest przyznany u偶ytkownikowi przez **inn polityk**, operacja **zakoczy si niepowodzeniem**, jeli spr贸buje ich u偶y.

Granica to po prostu polityka doczona do u偶ytkownika, kt贸ra **wskazuje maksymalny poziom uprawnie, jakie u偶ytkownik lub rola mog mie**. Tak wic, **nawet jeli u偶ytkownik ma dostp administratora**, jeli granica wskazuje, 偶e mo偶e tylko czyta kubeki S路, to jest to maksimum, jakie mo偶e zrobi.

**To**, **SCPs** i **stosowanie zasady najmniejszych uprawnie** s sposobami kontroli, aby u偶ytkownicy nie mieli wicej uprawnie, ni偶 potrzebuj.

### Polityki sesji

Polityka sesji to **polityka ustawiona podczas przejcia roli** w jaki spos贸b. Bdzie to jak **granica IAM dla tej sesji**: Oznacza to, 偶e polityka sesji nie przyznaje uprawnie, ale **ogranicza je do tych wskazanych w polityce** (maksymalne uprawnienia to te, kt贸re ma rola).

Jest to przydatne dla **rodk贸w bezpieczestwa**: Gdy administrator ma przej bardzo uprzywilejowan rol, mo偶e ograniczy uprawnienia tylko do tych wskazanych w polityce sesji w przypadku skompromitowania sesji.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Zauwa偶, 偶e domylnie **AWS mo偶e doda polityki sesji do sesji**, kt贸re zostan wygenerowane z powodu innych powod贸w. Na przykad, w [nieuwierzytelnionych rolach przyjtych przez Cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) domylnie (korzystajc z ulepszonej uwierzytelniania), AWS wygeneruje **powiadczenia sesji z polityk sesji**, kt贸ra ogranicza usugi, do kt贸rych sesja mo偶e uzyska dostp [**do nastpujcej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dlatego jeli w pewnym momencie napotkasz bd "... poniewa偶 偶adna polityka sesji nie zezwala na...", a rola ma dostp do wykonania akcji, oznacza to, 偶e **istnieje polityka sesji, kt贸ra temu zapobiega**.

### Federacja To偶samoci

Federacja to偶samoci **pozwala u偶ytkownikom z dostawc贸w to偶samoci zewntrznych** do AWS na bezpieczny dostp do zasob贸w AWS bez koniecznoci podawania powiadcze u偶ytkownika AWS z wa偶nego konta IAM.\
Przykadem dostawcy to偶samoci mo偶e by wasne korporacyjne **Microsoft Active Directory**(za pomoc **SAML**) lub usugi **OpenID** (jak **Google**). Dostp federacyjny pozwoli u偶ytkownikom w nim zawartym na dostp do AWS.

Aby skonfigurowa to zaufanie, generowany jest **Dostawca To偶samoci IAM (SAML lub OAuth)**, kt贸ry bdzie **ufa** **innemu platformie**. Nastpnie, przynajmniej jedna **rola IAM jest przypisana (ufajca) Dostawcy To偶samoci**. Jeli u偶ytkownik z zaufanej platformy uzyska dostp do AWS, bdzie dziaa jako wspomniana rola.

Jednak zazwyczaj chcesz nada **inn rol w zale偶noci od grupy u偶ytkownika** w platformie zewntrznej. Nastpnie, kilka **r贸l IAM mo偶e ufa** dostawcy to偶samoci zewntrznej, a platforma zewntrzna bdzie decydowa, kt贸ra rola mo偶e by przyjta.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Centrum To偶samoci IAM

Centrum To偶samoci IAM AWS (nastpca AWS Single Sign-On) rozszerza mo偶liwoci Zarzdzania To偶samociami i Dostpem AWS (IAM), zapewniajc **centralne miejsce**, kt贸re czy **zarzdzanie u偶ytkownikami i ich dostpem do kont AWS** oraz aplikacji chmurowych.

Domena logowania bdzie miaa posta `<user_input>.awsapps.com`.

Do logowania u偶ytkownik贸w mo偶na u偶y 3 藕r贸de to偶samoci:

* Katalog Centrum To偶samoci: Zwykli u偶ytkownicy AWS
* Active Directory: Obsuguje r贸偶ne czniki
* Zewntrzny Dostawca To偶samoci: Wszyscy u偶ytkownicy i grupy pochodz z zewntrznego Dostawcy To偶samoci (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

W najprostszym przypadku katalogu Centrum To偶samoci, **Centrum To偶samoci bdzie miao list u偶ytkownik贸w i grup** oraz bdzie mogo **przypisywa im polityki** do **dowolnego z kont** organizacji.

Aby da dostp u偶ytkownikowi/grupie z Centrum To偶samoci do konta, zostanie utworzony **Dostawca To偶samoci SAML ufajcy Centrum To偶samoci**, a **rola ufajca Dostawcy To偶samoci z okrelonymi politykami zostanie utworzona** w koncie docelowym.

#### AwsSSOInlinePolicy

Mo偶liwe jest **nadanie uprawnie za pomoc polityk wbudowanych dla r贸l utworzonych za pomoc Centrum To偶samoci IAM**. Role utworzone w kontach, kt贸rym nadano **polityki wbudowane w Centrum To偶samoci AWS**, bd miay te uprawnienia w polityce wbudowanej o nazwie **`AwsSSOInlinePolicy`**.

Dlatego nawet jeli zobaczysz 2 role z polityk wbudowan o nazwie **`AwsSSOInlinePolicy`**, **nie oznacza to, 偶e maj takie same uprawnienia**.

### Zaufanie i Role Midzykontowe

**U偶ytkownik** (ufajcy) mo偶e utworzy Rol Midzykontow z pewnymi politykami, a nastpnie **umo偶liwi innemu u偶ytkownikowi** (ufanemu) **dostp do swojego konta**, ale tylko **z dostpem okrelonym w nowych politykach roli**. Aby to zrobi, wystarczy utworzy now Rol i wybra Rol Midzykontow. Role do Dostpu Midzykontowego oferuj dwie opcje. Zapewnienie dostpu midzy kontami AWS, kt贸re posiadasz, oraz zapewnienie dostpu midzy kontem, kt贸re posiadasz, a kontem AWS strony trzeciej.\
Zaleca si **okrelenie u偶ytkownika, kt贸ry jest ufay, a nie podawanie og贸lnego okrelenia**, poniewa偶 w przeciwnym razie inni uwierzytelnieni u偶ytkownicy, tak jak u偶ytkownicy federowani, bd r贸wnie偶 mogli nadu偶ywa tego zaufania.

### AWS Simple AD

Nieobsugiwane:

* Relacje Zaufania
* Centrum Administracyjne AD
* Pene wsparcie dla interfejsu API PS
* Kosz AD
* Zarzdzane konta usugowe grupy
* Rozszerzenia schematu
* Brak bezporedniego dostpu do systemu operacyjnego lub instancji

#### Federacja Sieciowa lub Uwierzytelnianie OpenID

Aplikacja korzysta z AssumeRoleWithWebIdentity do tworzenia tymczasowych powiadcze. Jednak nie zapewnia to dostpu do konsoli AWS, a jedynie dostp do zasob贸w w AWS.

### Inne opcje IAM

* Mo偶esz **ustawi polityk hasa** z opcjami takimi jak minimalna dugo i wymagania dotyczce hasa.
* Mo偶esz **pobra "Raport powiadcze"** z informacjami o bie偶cych powiadczeniach (jak czas utworzenia u偶ytkownika, czy haso jest wczone...). Mo偶esz generowa raport powiadcze co najmniej raz co **cztery godziny**.

Zarzdzanie To偶samociami i Dostpem AWS (IAM) zapewnia **dokadn kontrol dostpu** we wszystkich usugach AWS. Dziki IAM mo偶esz okreli **kto mo偶e uzyska dostp do jakich usug i zasob贸w**, oraz pod jakimi warunkami. Dziki politykom IAM zarzdzasz uprawnieniami dla swojej siy roboczej i system贸w, aby **zapewni uprawnienia o najmniejszym poziomie**.

### Prefiksy ID IAM

Na [**tej stronie**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) znajdziesz **prefiksy ID IAM** kluczy w zale偶noci od ich charakteru:

| ABIA | [Token posiadacza usugi AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Powiadczenie okrelone kontekstowo                                                                                                                                                                                           |
| AGPA | Grupa u偶ytkownik贸w                                                                                                                                                                                                            |
| AIDA | U偶ytkownik IAM                                                                                                                                                                                                              |
| AIPA | Profil instancji Amazon EC2                                                                                                                                                                                           |
| AKIA | Klucz dostpu                                                                                                                                                                                                            |
| ANPA | Zarzdzana polityka                                                                                                                                                                                                        |
| ANVA | Wersja w zarzdzanej polityce                                                                                                                                                                                           |
| APKA | Klucz publiczny                                                                                                                                                                                                            |
| AROA | Rola                                                                                                                                                                                                                  |
| ASCA | Certyfikat                                                                                                                                                                                                           |
| ASIA | [Tymczasowe identyfikatory kluczy dostpu (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) u偶ywaj ten prefiks, ale s unikalne tylko w poczeniu z tajnym kluczem dostpu i tokenem sesji. |

### Rekomendowane uprawnienia do audytowania kont

Nastpujce uprawnienia umo偶liwiaj r贸偶ne rodzaje odczytu metadanych:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## R贸偶ne

### Autentykacja CLI

Aby zwyky u偶ytkownik m贸g uwierzytelni si w AWS za pomoc CLI, potrzebujesz **lokalnych powiadcze**. Domylnie mo偶esz je skonfigurowa **rcznie** w `~/.aws/credentials` lub **uruchamiajc** `aws configure`.\
W tym pliku mo偶esz mie wicej ni偶 jeden profil, jeli **nie okrelono profilu** za pomoc **aws cli**, zostanie u偶yty ten o nazwie **`[default]`** w tym pliku.\
Przykad pliku z powiadczeniami zawierajcym wicej ni偶 1 profil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Jeli musisz uzyska dostp do **r贸偶nych kont AWS** i Tw贸j profil otrzyma dostp do **przyjcia roli w tych kontach**, nie musisz wywoywa rcznie STS za ka偶dym razem (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurowa powiadcze.

Mo偶esz u偶y pliku `~/.aws/config` do [**wskazania, kt贸re role przyj**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a nastpnie u偶y parametru `--profile` jak zwykle (operacja `assume-role` zostanie wykonana w spos贸b transparentny dla u偶ytkownika).\
Przykad pliku konfiguracyjnego:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Z tym plikiem konfiguracyjnym mo偶esz u偶ywa aws cli w ten spos贸b:
```
aws --profile acc2 ...
```
Jeli szukasz czego **podobnego** do tego, ale dla **przegldarki**, mo偶esz sprawdzi **rozszerzenie** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Odnoniki

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Zdobd藕 wiedz na temat hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
