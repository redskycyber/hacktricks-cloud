# AWS - ECR Privesc

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

**`ecr:GetAuthorizationToken`** ã¨ **`ecr:BatchGetImage`** ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ECRã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã«ã¤ã„ã¦ã®è©³ç´°ã¯:

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’å‚å—ã™ã‚‹ã“ã¨ã«ã‚ˆã‚‹é–“æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `ecr:GetAuthorizationToken`,`ecr:BatchCheckLayerAvailability`,`ecr:CompleteLayerUpload`,`ecr:InitiateLayerUpload`,`ecr:PutImage`,`ecr:UploadLayerPart`

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’ã™ã¹ã¦æŒã¤æ”»æ’ƒè€…ã¯ã€**ECRã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™**ã€‚ã“ã‚Œã¯ã€ãã‚Œã‚‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä»–ã®ç’°å¢ƒã§æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã®ã«å½¹ç«‹ã¤å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°ã™ã‚‹æ–¹æ³•ã‚’å­¦ã¶ã«ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã§ã™ãŒã€å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªç”¨ã§ã™ã€‚

### `ecr:SetRepositoryPolicy`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**ãƒªãƒã‚¸ãƒˆãƒª** **ãƒãƒªã‚·ãƒ¼**ã‚’**å¤‰æ›´**ã—ã¦ã€è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯èª°ã§ã‚‚ï¼‰ã«**èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹**ã‚’è¨±å¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ä¾‹ãˆã°ã€ã“ã®ä¾‹ã§ã¯èª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹ã‚’å…¨å“¡ã«ä¸ãˆã¦ã„ã¾ã™ã€‚
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
`my-policy.json`ã®å†…å®¹ï¼š
```json
{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã§ã™ãŒã€å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªç”¨ã§ã™ã€‚\
æ”»æ’ƒè€…ã¯ã€ECR Publicãƒªãƒã‚¸ãƒˆãƒªã®**ãƒªãƒã‚¸ãƒˆãƒªãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´**ã—ã¦ã€ä¸æ­£ãªå…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ãŸã‚Šã€è‡ªèº«ã®æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
bashCopy code# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
**æ½œåœ¨çš„å½±éŸ¿**ï¼šECR Publicãƒªãƒã‚¸ãƒˆãƒªã¸ã®ä¸æ­£ãªå…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒ—ãƒ«ã€ã¾ãŸã¯å‰Šé™¤ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### `ecr:PutRegistryPolicy`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒãƒªã‚·ãƒ¼**ã‚’**å¤‰æ›´**ã—ã¦ã€è‡ªåˆ†è‡ªèº«ã€è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã¾ãŸã¯èª°ã§ã‚‚ï¼‰ã«**èª­ã¿æ›¸ãã‚¢ã‚¯ã‚»ã‚¹**ã‚’è¨±å¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„å ´åˆ**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã‚„[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>
