# AWS - Apigateway æƒé™æå‡

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Apigateway

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

æ‹¥æœ‰æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆé…ç½®çš„APIçš„APIå¯†é’¥ï¼ˆæŒ‰åŒºåŸŸï¼‰ã€‚
```bash
aws --region <region> apigateway create-api-key
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯ä¸èƒ½è¿›è¡Œæƒé™æå‡ï¼Œä½†ä½ å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:GET`

æ‹¥æœ‰æ­¤æƒé™ï¼Œä½ å¯ä»¥è·å–é…ç½®çš„ APIï¼ˆæŒ‰åŒºåŸŸï¼‰ç”Ÿæˆçš„ API å¯†é’¥ã€‚
```bash
aws --region apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯ä¸èƒ½è¿›è¡Œæƒé™æå‡ï¼Œä½†ä½ å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

æ‹¥æœ‰è¿™äº›æƒé™å¯ä»¥ä¿®æ”¹APIçš„èµ„æºç­–ç•¥ï¼Œä»¥ä¾¿ç»™è‡ªå·±è°ƒç”¨æƒé™ï¼Œå¹¶æ»¥ç”¨APIç½‘å…³å¯èƒ½æ‹¥æœ‰çš„æ½œåœ¨è®¿é—®æƒé™ï¼ˆä¾‹å¦‚è°ƒç”¨ä¸€ä¸ªæ˜“å—æ”»å‡»çš„lambdaï¼‰ã€‚

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š** é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æ— æ³•ç›´æ¥é€šè¿‡è¿™ç§æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†æ‚¨å¯èƒ½ä¼šè®¿é—®åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:PutIntegration`ã€`apigateway:CreateDeployment`ã€`iam:PassRole`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰ `apigateway:PutIntegration`ã€`apigateway:CreateDeployment` å’Œ `iam:PassRole` æƒé™çš„æ”»å‡»è€…å¯ä»¥**å‘ç°æœ‰çš„ API Gateway REST API æ·»åŠ ä¸€ä¸ªæ–°çš„é›†æˆï¼Œè¯¥é›†æˆä½¿ç”¨äº†é™„åŠ äº† IAM è§’è‰²çš„ Lambda å‡½æ•°**ã€‚ç„¶åæ”»å‡»è€…å¯ä»¥**è§¦å‘ Lambda å‡½æ•°æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¯èƒ½è·å¾—ä¸ IAM è§’è‰²å…³è”çš„èµ„æºçš„è®¿é—®æƒé™**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**æ½œåœ¨å½±å“**ï¼šè®¿é—®ä¸Lambdaå‡½æ•°çš„IAMè§’è‰²å…³è”çš„èµ„æºã€‚

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:UpdateAuthorizer`å’Œ`apigateway:CreateDeployment`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„API Gatewayæˆæƒå™¨**ï¼Œä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥æˆ–åœ¨è¿›è¡ŒAPIè¯·æ±‚æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œæœªæˆæƒè®¿é—®APIèµ„æºã€‚

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:UpdateVpcLink`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„VPCé“¾æ¥ï¼Œä½¿å…¶æŒ‡å‘ä¸åŒçš„ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ï¼Œå¯èƒ½å°†ç§æœ‰APIæµé‡é‡å®šå‘åˆ°æœªæˆæƒæˆ–æ¶æ„èµ„æº**ã€‚
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**æ½œåœ¨å½±å“**ï¼šæœªæˆæƒè®¿é—®ç§æœ‰ API èµ„æºï¼Œæ‹¦æˆªæˆ–ä¸­æ–­ API æµé‡ã€‚

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
