# AWS - Apigatewayææƒ

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Apigateway

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### `apigateway:POST`

é€šè¿‡æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆé…ç½®çš„APIçš„APIå¯†é’¥ï¼ˆæŒ‰åŒºåŸŸåˆ’åˆ†ï¼‰ã€‚
```bash
aws --region <region> apigateway create-api-key
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨æ­¤æŠ€æœ¯æ— æ³•è¿›è¡Œæƒé™æå‡ï¼Œä½†å¯èƒ½å¯ä»¥è®¿é—®æ•æ„Ÿä¿¡æ¯ã€‚

### `apigateway:GET`

é€šè¿‡æ­¤æƒé™ï¼Œæ‚¨å¯ä»¥è·å–é…ç½®çš„ APIï¼ˆæŒ‰åŒºåŸŸï¼‰çš„ç”Ÿæˆçš„ API å¯†é’¥ã€‚
```bash
aws --region apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**æ½œåœ¨å½±å“ï¼š** ä½¿ç”¨è¿™ç§æŠ€æœ¯æ— æ³•è¿›è¡Œæƒé™æå‡ï¼Œä½†å¯èƒ½ä¼šè·å¾—è®¿é—®æ•æ„Ÿä¿¡æ¯çš„æƒé™ã€‚

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

é€šè¿‡è¿™äº›æƒé™ï¼Œå¯ä»¥ä¿®æ”¹ API çš„èµ„æºç­–ç•¥ï¼Œä»¥ä¾¿è‡ªå·±å¯ä»¥è°ƒç”¨å®ƒå¹¶æ»¥ç”¨ API ç½‘å…³å¯èƒ½å…·æœ‰çš„è®¿é—®æƒé™ï¼ˆä¾‹å¦‚è°ƒç”¨ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ Lambda å‡½æ•°ï¼‰ã€‚

{% code overflow="wrap" %}
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
{% endcode %}

**æ½œåœ¨å½±å“ï¼š**é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æ— æ³•ç›´æ¥ä½¿ç”¨æ­¤æŠ€æœ¯è¿›è¡Œæƒé™æå‡ï¼Œä½†å¯èƒ½ä¼šè·å¾—å¯¹æ•æ„Ÿä¿¡æ¯çš„è®¿é—®æƒé™ã€‚

### `apigateway:PutIntegration`ï¼Œ`apigateway:CreateDeployment`ï¼Œ`iam:PassRole`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

å…·æœ‰`apigateway:PutIntegration`ï¼Œ`apigateway:CreateDeployment`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥**å‘ç°æœ‰çš„API Gateway REST APIæ·»åŠ æ–°çš„é›†æˆï¼Œè¯¥é›†æˆä½¿ç”¨é™„åŠ äº†IAMè§’è‰²çš„Lambdaå‡½æ•°**ã€‚ç„¶åï¼Œæ”»å‡»è€…å¯ä»¥**è§¦å‘Lambdaå‡½æ•°ä»¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¹¶å¯èƒ½è·å¾—ä¸IAMè§’è‰²å…³è”çš„èµ„æºçš„è®¿é—®æƒé™**ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®ä¸Lambdaå‡½æ•°çš„IAMè§’è‰²ç›¸å…³çš„èµ„æºã€‚

### `apigateway:UpdateAuthorizer`ï¼Œ`apigateway:CreateDeployment`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

å…·æœ‰`apigateway:UpdateAuthorizer`å’Œ`apigateway:CreateDeployment`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„API Gatewayæˆæƒç¨‹åº**ï¼Œä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥æˆ–åœ¨è¿›è¡ŒAPIè¯·æ±‚æ—¶æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œæœªç»æˆæƒè®¿é—®APIèµ„æºã€‚

### `apigateway:UpdateVpcLink`

{% hint style="info" %}
éœ€è¦æµ‹è¯•
{% endhint %}

æ‹¥æœ‰`apigateway:UpdateVpcLink`æƒé™çš„æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ç°æœ‰çš„VPCé“¾æ¥ï¼Œå°†å…¶æŒ‡å‘ä¸åŒçš„ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ï¼Œä»è€Œå¯èƒ½å°†ç§æœ‰APIæµé‡é‡å®šå‘åˆ°æœªç»æˆæƒæˆ–æ¶æ„èµ„æº**ã€‚
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**æ½œåœ¨å½±å“**ï¼šæœªç»æˆæƒè®¿é—®ç§æœ‰APIèµ„æºï¼Œæ‹¦æˆªæˆ–ä¸­æ–­APIæµé‡ã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
