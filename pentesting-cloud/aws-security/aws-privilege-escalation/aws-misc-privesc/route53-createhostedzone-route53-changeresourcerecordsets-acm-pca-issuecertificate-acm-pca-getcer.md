# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Investigaci贸n copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)

## Secuestro de llamadas de API de AWS

### Usando la modificaci贸n de Route53 y los certificados ACM-PCA

Publicado el 11 de marzo de 2022

Hace alg煤n tiempo realic茅 una investigaci贸n sobre posibles amenazas de Man-in-the-Middle en AWS. Esta publicaci贸n de blog describe los resultados de esta investigaci贸n y muestra una forma interesante de escalar los privilegios IAM en el VPC de AWS.

Comencemos con los requisitos previos de que el atacante haya tomado el control del rol IAM que permite realizar modificaciones en Route53 y emitir los certificados firmados por CA privada de ACM-PCA.

Los permisos IAM m铆nimos que el rol debe tener para realizar la misma explotaci贸n son:

```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```

Los otros permisos IAM que pueden ser 煤tiles en la enumeraci贸n pero no son obligatorios para explotar son:

```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```

Una vez que el atacante tiene permisos IAM m铆nimos en route53 y acm-pca, podr铆a secuestrar las llamadas a la API de AWS y escalar con 茅xito los privilegios IAM en la implementaci贸n de AWS, reenviando las llamadas de API de AWS secuestradas a los puntos finales relevantes de VPC y leyendo las respuestas, por ejemplo, la llamada secretsmanager:GetSecretValue.

Me sorprendi贸 que esto fuera posible, debido a mi falsa suposici贸n de que: 1) el SDK de AWS utiliza una especie de fijaci贸n de certificado, 2) tanto route53 como acm-pca no permitir铆an controlar los nombres de dominio internos de AWS.

Todas esas suposiciones no son ciertas. Se consult贸 a la seguridad de AWS, pero result贸 que no es un error de seguridad. Hay casos de uso en los que los clientes quieren configurar el proxy o el enrutamiento personalizado para el tr谩fico a las API de AWS. He decidido documentar y compartir este comportamiento, ya que puede ser 煤til para otros pen-testers en la nube.

### Descubrimiento <a href="#discovery" id="discovery"></a>

El descubrimiento comenz贸 jugando con route53, creando primero la zona alojada para amazonaws.com, lo que fall贸:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Hice lo mismo para us-east-1.amazonaws.com, que dio los mismos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Pero para mi sorpresa, funcion贸 secretsmanager.us-east-1.amazonaws.com:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Ahora, se puede crear un registro A para secretsmanager.us-east-1.amazonaws.com que apunte a alguna IP interna dentro del VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando la lista de secretos de la v铆ctima en la m谩quina de la v铆ctima y en la m谩quina del atacante, recibimos la conexi贸n que es tr谩fico cifrado TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La comunicaci贸n est谩 cifrada con TLS, pero si las aplicaciones en el VPC conf铆an en la CA privada administrada por ACM-PCA y el atacante tiene permisos IAM para controlar esa CA privada en ACM-PCA, ser铆a posible hacer un Man-In-The-Middle completo y escalar los privilegios IAM.

### Explotaci贸n <a href="#exploitation" id="exploitation"></a>

Puedes ver toda la explotaci贸n aqu铆:

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Si prefieres leer y ver las capturas de pantalla, sigue leyendo.

Para fines de demostraci贸n, supongamos que el atacante comprometi贸 uno de los ec2 con el siguiente rol IAM asumido:

![aws\_hijack](https://github.com/niebardzo/niebard