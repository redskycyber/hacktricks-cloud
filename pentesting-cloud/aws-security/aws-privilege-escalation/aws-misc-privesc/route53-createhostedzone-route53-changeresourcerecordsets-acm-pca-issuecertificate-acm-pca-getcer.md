# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**ç ”ç©¶æ¥æºï¼š**[**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## åŠ«æŒ AWS API è°ƒç”¨

### ä½¿ç”¨ Route53 ä¿®æ”¹å’Œ ACM-PCA è¯ä¹¦

å‘å¸ƒäº 2022 å¹´ 3 æœˆ 11 æ—¥

å‰æ®µæ—¶é—´ï¼Œæˆ‘å¯¹ AWS ä¸­å¯èƒ½å­˜åœ¨çš„ä¸­é—´äººæ”»å‡»è¿›è¡Œäº†ä¸€äº›ç ”ç©¶ã€‚æœ¬åšæ–‡æè¿°äº†è¿™é¡¹ç ”ç©¶çš„ç»“æœï¼Œå¹¶å±•ç¤ºäº†ä¸€ç§æå‡ AWS VPC ä¸­ IAM æƒé™çš„æœ‰è¶£æ–¹æ³•ã€‚

è®©æˆ‘ä»¬ä»æ”»å‡»è€…å·²æ¥ç®¡å…è®¸å¯¹ Route53 è¿›è¡Œä¿®æ”¹å¹¶ç”± ACM-PCA ç­¾ç½²ç§æœ‰ CA è¯ä¹¦çš„ IAM è§’è‰²çš„å…ˆå†³æ¡ä»¶å¼€å§‹ã€‚

è¦æ‰§è¡Œç›¸åŒçš„åˆ©ç”¨ï¼Œè§’è‰²å¿…é¡»å…·æœ‰çš„æœ€ä½ IAM æƒé™ä¸ºï¼š
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
å…¶ä»–IAMæƒé™å¯ä»¥ç”¨äºæšä¸¾ï¼Œä½†ä¸æ˜¯åˆ©ç”¨çš„å¿…è¦æ¡ä»¶ï¼š
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
ä¸€æ—¦æ”»å‡»è€…åœ¨route53å’Œacm-pcaä¸Šæ‹¥æœ‰æœ€ä½çš„IAMæƒé™ï¼Œä»–æˆ–å¥¹å°†èƒ½å¤ŸåŠ«æŒå¯¹AWS APIçš„è°ƒç”¨ï¼Œå¹¶æˆåŠŸå‡çº§AWSéƒ¨ç½²ä¸­çš„IAMæƒé™-é€šè¿‡å°†åŠ«æŒçš„AWS APIè°ƒç”¨è½¬å‘åˆ°ç›¸å…³çš„VPCç»ˆç«¯èŠ‚ç‚¹å¹¶è¯»å–å“åº”ï¼Œä¾‹å¦‚secretsmanager:GetSecretValueè°ƒç”¨ã€‚

æˆ‘å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶ï¼Œå› ä¸ºæˆ‘é”™è¯¯åœ°è®¤ä¸ºï¼š1ï¼‰AWS SDKä½¿ç”¨æŸç§è¯ä¹¦å›ºå®šï¼Œ2ï¼‰route53å’Œacm-pcaéƒ½ä¸å…è®¸æ§åˆ¶AWSå†…éƒ¨åŸŸåã€‚

æ‰€æœ‰è¿™äº›å‡è®¾éƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚å·²ç»å’¨è¯¢äº†AWSå®‰å…¨å›¢é˜Ÿï¼Œä½†ç»“æœè¡¨æ˜è¿™ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ¼æ´ã€‚æœ‰ä¸€äº›ç”¨ä¾‹éœ€è¦å®¢æˆ·ä¸ºæµé‡åˆ°AWS APIè®¾ç½®ä»£ç†æˆ–è‡ªå®šä¹‰è·¯ç”±ã€‚æˆ‘å†³å®šè®°å½•å¹¶åˆ†äº«è¿™ç§è¡Œä¸ºï¼Œå› ä¸ºå®ƒå¯èƒ½å¯¹å…¶ä»–äº‘æ¸—é€æµ‹è¯•äººå‘˜æœ‰ç”¨ã€‚

### å‘ç° <a href="#discovery" id="discovery"></a>

å‘ç°å§‹äºå¯¹route53çš„æ¢ç´¢ï¼Œé¦–å…ˆå°è¯•ä¸ºamazonaws.comåˆ›å»ºæ‰˜ç®¡åŒºåŸŸï¼Œä½†å¤±è´¥äº†ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

æˆ‘å°è¯•äº†us-east-1.amazonaws.comï¼Œç»“æœç›¸åŒï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

ä½†ä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼Œsecretsmanager.us-east-1.amazonaws.comèµ·ä½œç”¨äº†ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

ç°åœ¨ï¼Œå¯ä»¥ä¸ºsecretsmanager.us-east-1.amazonaws.comåˆ›å»ºæŒ‡å‘VPCå†…éƒ¨IPçš„Aè®°å½•ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

æ¨¡æ‹Ÿå—å®³è€…åœ¨å—å®³è€…æœºå™¨ä¸Šåˆ—å‡ºç§˜å¯†ï¼Œåœ¨æ”»å‡»è€…çš„æœºå™¨ä¸Šæ¥æ”¶åˆ°TLSåŠ å¯†çš„æµé‡ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

é€šä¿¡æ˜¯TLSåŠ å¯†çš„ï¼Œä½†å¦‚æœVPCä¸­çš„åº”ç”¨ç¨‹åºä¿¡ä»»ç”±ACM-PCAç®¡ç†çš„ç§æœ‰CAï¼Œå¹¶ä¸”æ”»å‡»è€…å…·æœ‰IAMæƒé™æ¥æ§åˆ¶ACM-PCAä¸­çš„ç§æœ‰CAï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡Œå®Œå…¨çš„ä¸­é—´äººæ”»å‡»å¹¶å‡çº§IAMæƒé™ã€‚

### åˆ©ç”¨ <a href="#exploitation" id="exploitation"></a>

æ‚¨å¯ä»¥åœ¨æ­¤å¤„è§‚çœ‹æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ï¼š

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

å¦‚æœæ‚¨æ›´å–œæ¬¢é˜…è¯»å¹¶æŸ¥çœ‹å±å¹•æˆªå›¾ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚

ä¸ºäº†æ¼”ç¤ºç›®çš„ï¼Œå‡è®¾æ”»å‡»è€…å…¥ä¾µäº†å…·æœ‰ä»¥ä¸‹IAMè§’è‰²çš„ec2ä¹‹ä¸€ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œec2ä¸åº”å…·æœ‰å¦‚æ­¤å¹¿æ³›çš„æƒé™ï¼Œä½†æ‚¨å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å¼€å‘äººå‘˜æˆ–DevOpsè§’è‰²å…·æœ‰æ­¤ç±»æƒé™ã€‚

å…·æœ‰ç‰¹æƒIAMè§’è‰²çš„å—æŸec2çš„å†…éƒ¨IPä¸º10.0.0.87ï¼Œå—å®³è€…åº”ç”¨ç¨‹åºè¿è¡Œåœ¨å…·æœ‰IP 10.0.0.224çš„ec2ä¸Šã€‚

ç°åœ¨ï¼Œåœ¨æ”»å‡»è€…æ‹¥æœ‰çš„æœºå™¨ä¸Šï¼Œæˆ‘ä»¬ä¸ºsecretsmanager.us-east-1.amazonaws.comåˆ›å»ºæ‰˜ç®¡åŒºåŸŸï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

ç„¶åå°†Aè®°å½•è®¾ç½®ä¸ºå°†secretsmanager.us-east-1.amazonaws.comæŒ‡å‘10.0.0.87ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

æˆ‘ä»¬çŸ¥é“ACM-PCAä¸­å®šä¹‰äº†ä¸€ä¸ªç§æœ‰CAï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

è¿è¡Œåœ¨å—å®³è€…æœºå™¨ï¼ˆ10.0.0.224ï¼‰ä¸Šçš„Javaåº”ç”¨ç¨‹åºä¿¡ä»»æ­¤ç§æœ‰CAä»¥ç­¾ç½²WebæœåŠ¡è¯ä¹¦ã€‚ç§æœ‰CAä½äºJava TrustStoreä¸­ã€‚

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

ç°åœ¨ï¼Œåœ¨æ”»å‡»è€…çš„æœºå™¨ä¸Šï¼Œæˆ‘ä»¬ç”Ÿæˆç§é’¥å’ŒCSRã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨acm-caä»¥ç”±ç§æœ‰CAç­¾ç½²çš„è¯ä¹¦ã€‚APIå“åº”åŒ…å«å·²ç­¾ç½²çš„è¯ä¹¦ARNï¼š![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

ç„¶åï¼Œæ”»å‡»è€…ä»ACM-PCAæ£€ç´¢å·²ç­¾ç½²çš„è¯ä¹¦ï¼š

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

ä¸ºäº†æ¨¡æ‹ŸJavaåº”ç”¨ç¨‹åºä»å—å®³è€…æœºå™¨è°ƒç”¨Secrets Managerï¼Œæˆ‘é€šè¿‡mavenè¿è¡Œäº†JUnitæµ‹è¯•ï¼Œåœ¨ä¸‹é¢çš„å±å¹•æˆªå›¾ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¼‚å¸¸ï¼Œè¿™æ„å‘³ç€è¯ä¹¦æ˜¯å—ä¿¡ä»»çš„ï¼š![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

æœ€åï¼Œåœ¨ncatä¾¦å¬å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Javaåº”ç”¨ç¨‹åºä»AWS SDKå‘é€çš„HTTPè¯·æ±‚ã€‚![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

å¦‚ä½•åˆ©ç”¨è¿™ä¸€ç‚¹æ¥å‡çº§IAMæƒé™ï¼Ÿæˆ‘ä»¬æ²¡æœ‰æƒé™å¯¹ä»»ä½•s3å¯¹è±¡æ‰§è¡Œs3:GetObjectæ“ä½œï¼Œä¹Ÿæ²¡æœ‰æƒé™æ‰§è¡Œsecretsmanager:GetSecretValueæ“ä½œï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å—…æ¢åˆ°ä¸è¿™äº›è°ƒç”¨ç›¸å…³çš„S3æˆ–secretsmanagerçš„æµé‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„VPCEï¼Œå¹¶è·å¾—å¯¹å­˜å‚¨åœ¨S3ä¸­çš„å¯¹è±¡æˆ–å­˜å‚¨åœ¨secretsmanagerä¸­çš„ç§˜å¯†çš„è®¿é—®æƒé™ã€‚
### ç»“è®º <a href="#conclusions" id="conclusions"></a>

å»ºè®®é¿å…åœ¨åˆ›å»ºç§æœ‰æ‰˜ç®¡åŒºåŸŸæˆ–æ— é™åˆ¶çš„route53:ChangeResourceRecordSetsæ–¹é¢ä½¿ç”¨å¹¿æ³›çš„route53 IAMæƒé™ã€‚ç”±äºACM-PCAä¸å…è®¸å¯¹ç§æœ‰CAå¯ä»¥ç­¾ç½²çš„åŸŸåè¯ä¹¦åº”ç”¨é™åˆ¶ï¼Œå› æ­¤å»ºè®®ç‰¹åˆ«æ³¨æ„acm-pca:IssueCertificate IAMæƒé™ã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
