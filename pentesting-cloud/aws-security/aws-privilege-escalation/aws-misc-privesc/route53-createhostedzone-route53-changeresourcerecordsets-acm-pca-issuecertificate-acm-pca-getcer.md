# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Investigaci贸n copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## Secuestro de llamadas a la API de AWS

### Utilizando la modificaci贸n de Route53 y los certificados ACM-PCA

Publicado el 11 de marzo de 2022

Hace alg煤n tiempo realic茅 una investigaci贸n sobre posibles amenazas de Man-in-the-Middle en AWS. Esta entrada de blog describe los resultados de esta investigaci贸n y muestra una forma interesante de escalar los privilegios IAM en el VPC de AWS.

Empecemos con los requisitos previos que el atacante ha tomado el rol IAM que permite hacer modificaciones en Route53 y emitir los certificados firmados por una CA privada de ACM-PCA.

Los permisos m铆nimos de IAM que el rol debe tener para hacer la misma explotaci贸n son:
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
Los otros permisos de IAM que pueden ser 煤tiles en la enumeraci贸n pero no son obligatorios para explotar:
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
Una vez que el atacante tiene permisos m铆nimos de IAM en route53 y acm-pca, 茅l o ella podr铆an secuestrar las llamadas a la API de AWS y escalar con 茅xito los privilegios de IAM en la implementaci贸n de AWS, al reenviar las llamadas secuestradas de la API de AWS a los respectivos Puntos Finales de VPC y leer las respuestas, por ejemplo, la llamada secretsmanager:GetSecretValue.

Me sorprendi贸 que esto fuera posible, debido a mi falsa suposici贸n de que: 1) AWS SDK utiliza una especie de fijaci贸n de certificados, 2) Ni route53 ni acm-pca permitir铆an controlar los nombres de dominio internos de AWS.

Todas esas suposiciones no son ciertas. Se consult贸 a AWS Security, pero result贸 que no es un fallo de seguridad. Hay casos de uso donde los clientes quieren configurar un proxy o enrutamiento personalizado para el tr谩fico a las APIs de AWS. He decidido documentar y compartir este comportamiento, ya que podr铆a ser 煤til para otros pentesters de la nube.

### Descubrimiento <a href="#discovery" id="discovery"></a>

El descubrimiento comenz贸 jugando con route53, al crear primero la zona alojada para amazonaws.com, lo cual fall贸:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Intent茅 lo mismo para us-east-1.amazonaws.com, que dio los mismos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Pero para mi sorpresa, secretsmanager.us-east-1.amazonaws.com funcion贸:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Ahora, uno puede crear un registro A para secretsmanager.us-east-1.amazonaws.com apuntando a alguna IP interna dentro del VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando que la v铆ctima lista secretos en la m谩quina de la v铆ctima y en la m谩quina del atacante, recibimos la conexi贸n que es tr谩fico cifrado TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La comunicaci贸n est谩 cifrada con TLS, pero si las aplicaciones en el VPC conf铆an en la CA privada gestionada por ACM-PCA y el atacante tiene permisos de IAM para controlar esa CA privada en ACM-PCA, ser铆a posible realizar un ataque Man-In-The-Middle completo y escalar los privilegios de IAM.

### Explotaci贸n <a href="#exploitation" id="exploitation"></a>

Puedes ver toda la explotaci贸n aqu铆:

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Si prefieres leer y seguir las capturas de pantalla, contin煤a.

Para el prop贸sito de la demostraci贸n, supongamos que el atacante comprometi贸 uno de los ec2 con el siguiente rol de IAM asumido:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

En el mundo real, el ec2 no deber铆a tener permisos tan amplios, pero podr铆as encontrar alg煤n rol de desarrollador o DevOps que los tenga.

El ec2 comprometido con el rol de IAM privilegiado tiene la IP interna 10.0.0.87, la aplicaci贸n v铆ctima se ejecuta en el ec2 con IP 10.0.0.224.

Ahora, en la m谩quina controlada por el atacante, creamos la zona alojada para secretsmanager.us-east-1.amazonaws.com:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

Luego configuramos el registro A para secretsmanager.us-east-1.amazonaws.com apuntando al 10.0.0.87:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

Sabemos que hay una CA Privada definida en ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

La Aplicaci贸n Java que se ejecuta en la m谩quina de la v铆ctima (10.0.0.224) conf铆a en esta CA Privada para firmar el certificado del servicio web. La CA Privada est谩 en el Java TrustStore.

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

Ahora, en la m谩quina del atacante, generamos la clave privada y CSR. Luego, llamamos a acm-ca para emitir un certificado firmado por la CA privada. La API responde con el ARN del certificado firmado: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

Luego, el atacante recupera el certificado firmado de ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

Para simular las llamadas de la Aplicaci贸n Java a Secrets Manager desde la m谩quina de la v铆ctima, he ejecutado las pruebas JUnit a trav茅s de maven, en la captura de pantalla a continuaci贸n puedes ver que no hay excepciones, lo que significa que el certificado es de confianza: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

Finalmente, en el oyente de ncat, podemos ver la solicitud HTTP enviada por AWS SDK desde la Aplicaci贸n Java. ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

驴C贸mo escalar los privilegios de IAM usando eso? No tenemos permisos para hacer s3:GetObject en ning煤n objeto de s3 o para hacer secretsmanager:GetSecretValue, pero si olfateamos el tr谩fico a S3 o secretsmanager con esas llamadas, podemos reenviar las solicitudes a los respectivos VPCE y obtener acceso a Objetos almacenados en S3 o secretos almacenados en secretsmanager.
### Conclusiones <a href="#conclusions" id="conclusions"></a>

Se recomienda evitar permisos IAM de route53 demasiado amplios en lo que respecta a la creaci贸n de una zona alojada privada o route53:ChangeResourceRecordSets sin restricciones. Dado que ACM-PCA no permite aplicar restricciones sobre qu茅 certificado de dominio puede ser firmado por la CA privada, tambi茅n se recomienda prestar especial atenci贸n a los permisos IAM de acm-pca:IssueCertificate.

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
