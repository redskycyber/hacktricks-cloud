# AWS - STS Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>

## STS

### `sts:AssumeRole`

ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«ã¯**ãƒ­ãƒ¼ãƒ«ä¿¡é ¼ãƒãƒªã‚·ãƒ¼**ã¨ã¨ã‚‚ã«ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã¯**èª°ãŒä½œæˆã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹**ã‚’ç¤ºã—ã¾ã™ã€‚**åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®ãƒ­ãƒ¼ãƒ«ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãã‚Œã‚’å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨è¨€ã£ã¦ã„ã‚‹å ´åˆã€ãã‚Œã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ï¼ˆãã—ã¦æ½œåœ¨çš„ã«**privesc**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼‰ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ãƒ­ãƒ¼ãƒ«ä¿¡é ¼ãƒãƒªã‚·ãƒ¼ã¯èª°ã§ã‚‚å¼•ãå—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ç¤ºã—ã¦ã„ã‚‹ãŸã‚ã€**ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ãƒ­ãƒ¼ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸæ¨©é™ã«privescã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
å½¹å‰²ã‚’æ¨¡å€£ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

{% hint style="danger" %}
ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€`sts:AssumeRole` æ¨©é™ãŒæ”»æ’ƒè€…ã«å±ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã§ã¯ãªãã€**æ‚ªç”¨ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã«** **æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**
ãŸã ã—ã€ä¾‹å¤–ã¨ã—ã¦ã€**ç•°ãªã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹**ãŸã‚ã«ã¯ã€æ”»æ’ƒè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚ãã®ãƒ­ãƒ¼ãƒ«ã«å¯¾ã—ã¦ **`sts:AssumeRole`** ã‚’ **æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**
{% endhint %}

### `sts:AssumeRoleWithSAML`

ã“ã®ãƒ­ãƒ¼ãƒ«ã®ä¿¡é ¼ãƒãƒªã‚·ãƒ¼ã¯ã€**SAMLçµŒç”±ã§èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ¼ãƒ«ã®ãªã‚Šã™ã¾ã—ã‚’è¨±å¯ã—ã¾ã™ã€‚**

ã“ã®æ¨©é™ã‚’æŒã¤ä¿¡é ¼ãƒãƒªã‚·ãƒ¼ã®ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
å½¹å‰²ã‚’ä¸€èˆ¬çš„ã«æ¨¡å€£ã™ã‚‹ãŸã‚ã®èªè¨¼æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
ã—ã‹ã—ã€**ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**ã¯ã“ã‚Œã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã®**ç‹¬è‡ªã®ãƒ„ãƒ¼ãƒ«**ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€[onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)ã®ã‚ˆã†ã«ï¼š

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** ãƒ­ãƒ¼ãƒ«ã¸ã®æ¨©é™æ˜‡æ ¼ã€‚

### `sts:AssumeRoleWithWebIdentity`

ã“ã®æ¨©é™ã¯ã€**ãƒ¢ãƒã‚¤ãƒ«ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€EKS...** ã§èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ™‚çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚[ã“ã¡ã‚‰ã§è©³ç´°ã‚’å­¦ã¶ã€‚](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRoleWithWebIdentity.html)

ä¾‹ãˆã°ã€**EKSã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ãŒ**IAMãƒ­ãƒ¼ãƒ«ã‚’ãªã‚Šã™ã¾ã™**ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å ´åˆã€**`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã€ãƒ­ãƒ¼ãƒ«ã‚’**æƒ³å®šã—ã¦èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‚ªç”¨

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
