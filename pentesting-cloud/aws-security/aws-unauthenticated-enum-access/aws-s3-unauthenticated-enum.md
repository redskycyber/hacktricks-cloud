# AWS - S3 Enumeraci칩n sin Autenticaci칩n

<details>

<summary><strong>Aprende hacking de AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## S3 Buckets P칰blicos

Un bucket se considera **"p칰blico"** si **cualquier usuario puede listar su contenido**, y **"privado"** si el contenido del bucket **solo puede ser listado o escrito por ciertos usuarios**.

Las empresas pueden tener **permisos de buckets mal configurados** dando acceso ya sea a todo o a cualquier persona autenticada en AWS en cualquier cuenta (as칤 que a cualquiera). Ten en cuenta que, incluso con tales malas configuraciones, algunas acciones podr칤an no poder realizarse ya que los buckets pueden tener sus propias listas de control de acceso (ACLs).

**Aprende sobre la mala configuraci칩n de AWS-S3 aqu칤:** [**http://flaws.cloud**](http://flaws.cloud/) **y** [**http://flaws2.cloud/**](http://flaws2.cloud)

### Encontrar Buckets de AWS

Diferentes m칠todos para encontrar cu치ndo una p치gina web est치 utilizando AWS para almacenar algunos recursos:

#### Enumeraci칩n & OSINT:

* Usando el plugin de navegador **wappalyzer**
* Usando burp (**spidering** la web) o navegando manualmente a trav칠s de la p치gina, todos los **recursos** **cargados** se guardar치n en el Historial.
*   **Buscar recursos** en dominios como:

```
http://s3.amazonaws.com/[nombre_del_bucket]/
http://[nombre_del_bucket].s3.amazonaws.com/
```
* Buscar **CNAMES** ya que `resources.domain.com` podr칤a tener el CNAME `bucket.s3.amazonaws.com`
* Revisar [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), una web con **buckets abiertos ya descubiertos**.
* El **nombre del bucket** y el **nombre de dominio del bucket** deben ser **iguales.**
* **flaws.cloud** est치 en **IP** 52.92.181.107 y si vas all칤 te redirige a [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/). Adem치s, `dig -x 52.92.181.107` da `s3-website-us-west-2.amazonaws.com`.
* Para comprobar que es un bucket tambi칠n puedes **visitar** [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/).

#### Fuerza Bruta

Puedes encontrar buckets **fuerza bruta de nombres** relacionados con la empresa que est치s pentesteando:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Contiene una lista con nombres potenciales de buckets)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Generar una lista de palabras para crear permutaciones
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Generar una lista de palabras basada en los dominios y subdominios a probar
## Escribe esos dominios y subdominios en subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Crear permutaciones basadas en una lista con los dominios y subdominios a atacar
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## La herramienta anterior est치 especializada en crear permutaciones para subdominios, vamos a filtrar esa lista
<strong>### Eliminar l칤neas que terminan con "."
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Crear lista sin TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Crear lista sin puntos
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Crear lista sin guiones
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Generar la lista de palabras final
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Llamar a s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Saquear Buckets S3

Dado los buckets S3 abiertos, [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) puede buscar autom치ticamente **informaci칩n interesante**.

### Encontrar la Regi칩n

Puedes encontrar todas las regiones soportadas por AWS en [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html)

#### Por DNS

Puedes obtener la regi칩n de un bucket con un **`dig`** y **`nslookup`** haciendo una **solicitud DNS de la IP descubierta**:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Compruebe que el dominio resuelto contenga la palabra "website".\
Puede acceder al sitio web est치tico yendo a: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
o puede acceder al bucket visitando: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Intentando

Si intenta acceder a un bucket, pero en el **nombre de dominio especifica otra regi칩n** (por ejemplo, el bucket est치 en `bucket.s3.amazonaws.com` pero intenta acceder a `bucket.s3-website-us-west-2.amazonaws.com`), entonces se le **indicar치 la ubicaci칩n correcta**:

![](<../../../.gitbook/assets/image (57).png>)

### Enumerando el bucket

Para probar la apertura del bucket, un usuario puede simplemente ingresar la URL en su navegador web. Un bucket privado responder치 con "Acceso denegado". Un bucket p칰blico listar치 los primeros 1,000 objetos que se han almacenado.

Abierto a todos:

![](<../../../.gitbook/assets/image (67).png>)

Privado:

![](<../../../.gitbook/assets/image (78).png>)

Tambi칠n puede comprobar esto con la cli:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Si el bucket no tiene un nombre de dominio, al intentar enumerarlo, **solo coloca el nombre del bucket** y no todo el dominio de AWSs3. Ejemplo: `s3://<BUCKETNAME>`

### Plantilla de URL p칰blica
```
https://{user_provided}.s3.amazonaws.com
```
### Obtener ID de cuenta de un Bucket p칰blico

Es posible determinar una cuenta de AWS aprovechando la nueva **`S3:ResourceAccount`** **Clave de Condici칩n de Pol칤tica**. Esta condici칩n **restringe el acceso basado en el bucket de S3** en el que se encuentra una cuenta (otras pol칤ticas basadas en cuentas restringen bas치ndose en la cuenta en la que se encuentra el principal solicitante).\
Y debido a que la pol칤tica puede contener **comodines**, es posible encontrar el n칰mero de cuenta **un n칰mero a la vez**.

Esta herramienta automatiza el proceso:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
## Referencias

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

<details>

<summary><strong>Aprende AWS hacking de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
