# AWS - IAM & STS Unauthenticated Enum

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Wylicz role i nazwy uÅ¼ytkownikÃ³w w koncie

### ~~PrÃ³buj siÅ‚owo przejÄ…Ä‡ rolÄ™~~

{% hint style="danger" %}
**Ta technika juÅ¼ nie dziaÅ‚a**, poniewaÅ¼ niezaleÅ¼nie od tego, czy rola istnieje, czy nie, zawsze otrzymasz ten bÅ‚Ä…d:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

MoÅ¼esz **to przetestowaÄ‡ uruchamiajÄ…c**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

PrÃ³ba **przejÄ™cia roli bez wymaganych uprawnieÅ„** wywoÅ‚uje komunikat o bÅ‚Ä™dzie AWS. Na przykÅ‚ad, jeÅ›li nieautoryzowany, AWS moÅ¼e zwrÃ³ciÄ‡:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
To potwierdza istnienie roli, ale wskazuje, Å¼e jej polityka przyjÄ™cia roli nie zezwala na twoje zaÅ‚oÅ¼enie. Natomiast prÃ³ba **zaÅ‚oÅ¼enia nieistniejÄ…cej roli prowadzi do innego bÅ‚Ä™du**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
InteresujÄ…co, ta metoda **rozrÃ³Å¼niania miÄ™dzy istniejÄ…cymi a nieistniejÄ…cymi rolami** jest stosowalna nawet w rÃ³Å¼nych kontach AWS. DziÄ™ki poprawnemu identyfikatorowi konta AWS i docelowemu sÅ‚ownikowi, moÅ¼na wyliczyÄ‡ role obecne w koncie bez Å¼adnych ograniczeÅ„.

MoÅ¼esz uÅ¼yÄ‡ tego [skryptu do wyliczenia potencjalnych podmiotÃ³w](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) naduÅ¼ywajÄ…c tego problemu.

### Polityki zaufania: Brutalne narzÄ™dzie do przeglÄ…dania rÃ³l i uÅ¼ytkownikÃ³w miÄ™dzykontowych

Konfigurowanie lub aktualizowanie **polityki zaufania roli IAM polega na zdefiniowaniu, ktÃ³re zasoby lub usÅ‚ugi AWS majÄ… prawo przejÄ…Ä‡ tÄ™ rolÄ™** i uzyskaÄ‡ tymczasowe poÅ›wiadczenia. JeÅ›li okreÅ›lony zasÃ³b w polityce **istnieje**, polityka zaufania zapisuje siÄ™ **pomyÅ›lnie**. Jednak jeÅ›li zasÃ³b **nie istnieje**, generowany jest **bÅ‚Ä…d**, wskazujÄ…cy, Å¼e podano nieprawidÅ‚owego podmiotu.

{% hint style="warning" %}
ZauwaÅ¼, Å¼e w tym zasobie moÅ¼esz okreÅ›liÄ‡ rolÄ™ lub uÅ¼ytkownika miÄ™dzykontowego:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

To przykÅ‚ad polityki:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

To jest **bÅ‚Ä…d**, ktÃ³ry zostanie wyÅ›wietlony, jeÅ›li uÅ¼yjesz **roli, ktÃ³ra nie istnieje**. JeÅ›li rola **istnieje**, polityka zostanie **zapisana** bez Å¼adnych bÅ‚Ä™dÃ³w. (BÅ‚Ä…d dotyczy aktualizacji, ale dziaÅ‚a rÃ³wnieÅ¼ podczas tworzenia)

![](<../../../.gitbook/assets/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
MoÅ¼esz zautomatyzowaÄ‡ ten proces za pomocÄ… [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

KorzystajÄ…c z [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Rola `admin` uÅ¼yta w przykÅ‚adzie to **rola w twoim koncie, ktÃ³rÄ… ma zimpersonowaÄ‡** pacu, aby utworzyÄ‡ wymagane przez niego zasady dla wyliczenia

### Privesc

W przypadku Åºle skonfigurowanej roli, ktÃ³ra pozwala kaÅ¼demu na jej przejÄ™cie:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
AtakujÄ…cy mÃ³gÅ‚ po prostu zaÅ‚oÅ¼yÄ‡ to.

## Federacja OIDC strony trzeciej

WyobraÅº sobie, Å¼e udaÅ‚o ci siÄ™ odczytaÄ‡ **przepÅ‚yw pracy Github Actions**, ktÃ³ry uzyskuje dostÄ™p do **roli** w **AWS**.\
To zaufanie moÅ¼e daÄ‡ dostÄ™p do roli z nastÄ™pujÄ…cÄ… **politykÄ… zaufania**:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
To zaufanie polityki moÅ¼e byÄ‡ poprawne, ale **brak dodatkowych warunkÃ³w** powinien skÅ‚oniÄ‡ do nieufnoÅ›ci.\
Jest to dlatego, Å¼e poprzedniÄ… rolÄ™ moÅ¼e przejÄ…Ä‡ **KTOKOLWIEK z Github Actions**! NaleÅ¼y okreÅ›liÄ‡ w warunkach takÅ¼e inne rzeczy, takie jak nazwa org., nazwa repozytorium, Å›rodowisko, gaÅ‚Ä…Åº...

Innym potencjalnym bÅ‚Ä™dem konfiguracji jest **dodanie warunku** takiego jak poniÅ¼ej:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
ZauwaÅ¼ **znak wieloznaczny** (\*) przed **dwukropkiem** (:). MoÅ¼esz utworzyÄ‡ org o nazwie **org\_name1** i **przyjÄ…Ä‡ rolÄ™** z akcji Github.

## Referencje

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
