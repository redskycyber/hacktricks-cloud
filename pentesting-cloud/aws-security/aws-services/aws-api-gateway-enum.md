# AWS - API Gateway Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## API Gateway

### Osnovne informacije

AWS API Gateway je sveobuhvatna usluga koju nudi Amazon Web Services (AWS) dizajnirana za developere da **kreiraju, objave i nadgledaju API-je u velikom obimu**. FunkcioniÅ¡e kao ulazna taÄka u aplikaciju, omoguÄ‡avajuÄ‡i developerima da uspostave okvir pravila i procedura. Ovaj okvir upravlja pristupom spoljnih korisnika odreÄ‘enim podacima ili funkcionalnostima unutar aplikacije.

API Gateway vam omoguÄ‡ava da definiÅ¡ete **kako zahtevi ka vaÅ¡im API-jima treba da budu obraÄ‘eni**, i moÅ¾e kreirati prilagoÄ‘ene API endpointove sa specifiÄnim metodama (npr. GET, POST, PUT, DELETE) i resursima. TakoÄ‘e moÅ¾e generisati SDK-ove za klijente (Software Development Kits) kako bi olakÅ¡ao developerima pozivanje vaÅ¡ih API-ja iz njihovih aplikacija.

### Tipovi API Gateway-a

* **HTTP API**: Izgradite nisko-latentne i ekonomiÄne REST API-je sa ugraÄ‘enim funkcijama kao Å¡to su OIDC i OAuth2, i nativnom CORS podrÅ¡kom. Radi sa sledeÄ‡im: Lambda, HTTP backend-ovi.
* **WebSocket API**: Izgradite WebSocket API koristeÄ‡i perzistentne veze za realno-vremenske sluÄajeve upotrebe kao Å¡to su aplikacije za Äet ili kontrolne table. Radi sa sledeÄ‡im: Lambda, HTTP, AWS usluge.
* **REST API**: Razvijte REST API gde imate potpunu kontrolu nad zahtevom i odgovorom zajedno sa moguÄ‡nostima upravljanja API-jem. Radi sa sledeÄ‡im: Lambda, HTTP, AWS usluge.
* **REST API Private**: Kreirajte REST API koji je dostupan samo iz unutar VPC-a.

### Glavne komponente API Gateway-a

1. **Resursi**: U API Gateway-u, resursi su komponente koje **Äine strukturu vaÅ¡eg API-ja**. Oni predstavljaju **razliÄite putanje ili endpointove** vaÅ¡eg API-ja i odgovaraju razliÄitim akcijama koje vaÅ¡ API podrÅ¾ava. Resurs je svaka metoda (npr. GET, POST, PUT, DELETE) **unutar svake putanje** (/, ili /korisnici, ili /korisnik/{id}).
2. **Faze**: Faze u API Gateway-u predstavljaju **razliÄite verzije ili okruÅ¾enja** vaÅ¡eg API-ja, kao Å¡to su razvoj, staging ili produkcija. MoÅ¾ete koristiti faze za upravljanje i implementaciju **viÅ¡e verzija vaÅ¡eg API-ja istovremeno**, omoguÄ‡avajuÄ‡i vam testiranje novih funkcionalnosti ili ispravki bagova bez uticaja na produkciono okruÅ¾enje. Faze takoÄ‘e **podrÅ¾avaju varijable faze**, koje su parovi kljuÄ-vrednost koji se mogu koristiti za konfigurisanje ponaÅ¡anja vaÅ¡eg API-ja na osnovu trenutne faze. Na primer, mogli biste koristiti varijable faze da usmerite zahteve API-ja ka razliÄitim Lambda funkcijama ili drugim backend servisima u zavisnosti od faze.
* Faza je naznaÄena na poÄetku URL-a endpointa API Gateway-a.
3. **Autorizatori**: Autorizatori u API Gateway-u su odgovorni za **kontrolu pristupa vaÅ¡em API-ju** proverom identiteta pozivaoca pre nego Å¡to se zahtev odobri. MoÅ¾ete koristiti **AWS Lambda funkcije** kao prilagoÄ‘ene autorizatore, Å¡to vam omoguÄ‡ava da implementirate svoju sopstvenu logiku autentifikacije i autorizacije. Kada zahtev stigne, API Gateway prosleÄ‘uje autorizacioni token zahteva Lambda autorizatoru, koji obraÄ‘uje token i vraÄ‡a IAM politiku koja odreÄ‘uje koje akcije je pozivaocu dozvoljeno da izvrÅ¡i. API Gateway takoÄ‘e podrÅ¾ava **ugraÄ‘ene autorizatore**, kao Å¡to su **AWS Identity and Access Management (IAM)** i **Amazon Cognito**.
4. **Politika resursa**: Politika resursa u API Gateway-u je JSON dokument koji **definiÅ¡e dozvole za pristup vaÅ¡em API-ju**. SliÄno je IAM politici, ali je posebno prilagoÄ‘ena za API Gateway. MoÅ¾ete koristiti politiku resursa da kontroliÅ¡ete ko moÅ¾e pristupiti vaÅ¡em API-ju, koje metode mogu pozvati i sa kojih IP adresa ili VPC-a mogu da se poveÅ¾u. **Politike resursa se mogu koristiti u kombinaciji sa autorizatorima** kako bi pruÅ¾ile detaljnu kontrolu pristupa vaÅ¡em API-ju.
* Da bi politika resursa imala efekta, API mora biti **ponovo implementiran nakon** Å¡to se politika resursa izmeni.

### Logovanje

Podrazumevano, **CloudWatch Logs** su **iskljuÄeni**, **Pristupno logovanje** je **iskljuÄeno**, a **X-Ray praÄ‡enje** je takoÄ‘e **iskljuÄeno**.

### Enumeracija

{% hint style="success" %}
Imajte na umu da u oba AWS API-ja za enumeraciju resursa (**`apigateway`** i **`apigatewayv2`**) jedina dozvola koja vam je potrebna i jedina dozvola za Äitanje koja se moÅ¾e dodeliti je **`apigateway:GET`**, sa tim moÅ¾ete **enumerisati sve**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %} 

### Enumerating AWS API Gateway v2

#### Enumerating API Gateway v2

API Gateway v2 is the latest version of API Gateway and provides WebSocket APIs. When enumerating API Gateway v2, you can use the following methods:

1. **Enumerating API Gateway v2 APIs**: Use the `getApis` API to list all APIs in the account.

2. **Enumerating API Gateway v2 Integrations**: Use the `getIntegrations` API to list all integrations for a specific API.

3. **Enumerating API Gateway v2 Routes**: Use the `getRoutes` API to list all routes for a specific API.

4. **Enumerating API Gateway v2 Deployments**: Use the `getDeployments` API to list all deployments for a specific API.

5. **Enumerating API Gateway v2 Stages**: Use the `getStages` API to list all stages for a specific API.

6. **Enumerating API Gateway v2 Domain Names**: Use the `getDomainNames` API to list all custom domain names for a specific API.

7. **Enumerating API Gateway v2 Authorizers**: Use the `getAuthorizers` API to list all authorizers for a specific API.

8. **Enumerating API Gateway v2 Models**: Use the `getModels` API to list all models for a specific API.

9. **Enumerating API Gateway v2 VPC Links**: Use the `getVpcLinks` API to list all VPC links for a specific API.

10. **Enumerating API Gateway v2 Tags**: Use the `getTags` API to list all tags for a specific API.

By enumerating these different aspects of API Gateway v2, you can gain a better understanding of the configuration and potential security issues in your AWS environment.
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## RazliÄite autorizacije za pristup API Gateway endpointima

### Politika resursa

MoguÄ‡e je koristiti politike resursa da definiÅ¡emo ko moÅ¾e pozvati API endpointe.\
U sledeÄ‡em primeru moÅ¾ete videti da **oznaÄena IP adresa ne moÅ¾e pozvati** endpoint `/resource_policy` putem GET zahteva.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM Autorizator

MoguÄ‡e je postaviti da metodi unutar putanje (resursa) zahtevaju IAM autentifikaciju da bi bili pozvani.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Kada je ovo podeÅ¡eno, dobiÄ‡ete greÅ¡ku `{"message":"Missing Authentication Token"}` kada pokuÅ¡ate da pristupite endpointu bez autorizacije.

Jedan jednostavan naÄin da generiÅ¡ete oÄekivani token pomoÄ‡u aplikacije je koriÅ¡Ä‡enjem **`Authorization`** tipa **`AWS Signature`** unutar **Postman**-a.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Postavite pristupni kljuÄ i tajni kljuÄ naloga koji Å¾elite da koristite i moÅ¾ete se autentifikovati protiv API endpointa.

GenerisaÄ‡e **Authorization** **header** kao Å¡to je:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
### Potrebno potpisivanje zahteva koriÅ¡Ä‡enjem Python-a
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### PrilagoÄ‘eni Lambda autorizator

MoguÄ‡e je koristiti lambda funkciju koja Ä‡e na osnovu datog tokena **vratiti IAM politiku** koja Ä‡e pokazati da li je korisnik **ovlaÅ¡Ä‡en da pozove API endpoint**.\
MoÅ¾ete postaviti svaku metodu resursa koja Ä‡e koristiti autorizator.

<details>

<summary>Primer koda Lambda autorizatora</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Pozovite ga neÄim poput:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
U zavisnosti od Lambda koda, ova autorizacija moÅ¾e biti ranjiva
{% endhint %}

Imajte na umu da ako je generisana i vraÄ‡ena **deny politika**, greÅ¡ka koju vraÄ‡a API Gateway je: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Na ovaj naÄin moÅ¾ete **identifikovati ovu autorizaciju** koja je na snazi.

### Potreban API kljuÄ

MoguÄ‡e je postaviti API endpointove koji zahtevaju **validan API kljuÄ** da bi se kontaktirali.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

MoguÄ‡e je generisati API kljuÄeve u portalu API Gateway-a i Äak postaviti koliko se moÅ¾e koristiti (u pogledu zahteva po sekundi i u pogledu zahteva meseÄno).

Da bi API kljuÄ radio, morate ga dodati u **Usage Plan**, ovaj plan koriÅ¡Ä‡enja mora biti dodat na **API Stage** i povezani API stage mora imati konfigurisan **method throttling** za **endpoint** koji zahteva API kljuÄ:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Neautentifikovan pristup

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Eksploatacija

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
