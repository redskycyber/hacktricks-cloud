# AWS - API Gateway Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## API Gateway

### Basic Information

AWS API Gatewayã¯ã€Amazon Web Servicesï¼ˆAWSï¼‰ãŒæä¾›ã™ã‚‹å®Œå…¨ã«ç®¡ç†ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚Šã€**ä»»æ„ã®ã‚¹ã‚±ãƒ¼ãƒ«ã§APIï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’ä½œæˆã€å…¬é–‹ã€ç¶­æŒã€ç›£è¦–ã€ãŠã‚ˆã³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ API Gatewayã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆAmazon Elastic Compute Cloudï¼ˆEC2ï¼‰ã‚„AWS Lambdaã€ã¾ãŸã¯ä»»æ„ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã¾ãŸã¯æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®**ã€Œãƒ•ãƒ­ãƒ³ãƒˆãƒ‰ã‚¢ã€**ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

API Gatewayã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®**å‡¦ç†æ–¹æ³•ã‚’å®šç¾©**ã™ã‚‹ã“ã¨ãŒã§ãã€ç‰¹å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGETã€POSTã€PUTã€DELETEãªã©ï¼‰ã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã¾ãŸã€é–‹ç™ºè€…ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰APIã‚’å‘¼ã³å‡ºã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKï¼ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚­ãƒƒãƒˆï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### API Gatewayã®ç¨®é¡

* **HTTP API**: çµ„ã¿è¾¼ã¿ã®OIDCãŠã‚ˆã³OAuth2ã€ãŠã‚ˆã³ãƒã‚¤ãƒ†ã‚£ãƒ–ã®CORSã‚µãƒãƒ¼ãƒˆãªã©ã®æ©Ÿèƒ½ã‚’å‚™ãˆãŸã€ä½é…å»¶ã‹ã¤ã‚³ã‚¹ãƒˆåŠ¹æœã®é«˜ã„REST APIã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€‚
* **WebSocket API**: ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã€æŒç¶šçš„ãªæ¥ç¶šã‚’ä½¿ç”¨ã—ã¦WebSocket APIã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€‚
* **REST API**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å®Œå…¨ãªåˆ¶å¾¡æ¨©ã‚’æŒã¡ã€APIç®¡ç†æ©Ÿèƒ½ã‚‚å‚™ãˆãŸREST APIã‚’é–‹ç™ºã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€‚
* **REST API Private**: VPCå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªREST APIã‚’ä½œæˆã—ã¾ã™ã€‚

### API Gatewayã®ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

1. **ãƒªã‚½ãƒ¼ã‚¹**: API Gatewayã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã¯APIã®æ§‹é€ ã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã¯ã€APIãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ã•ã¾ã–ã¾ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã™ã‚‹ã€APIã®ç•°ãªã‚‹ãƒ‘ã‚¹ã¾ãŸã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ã—ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã¯ã€å„ãƒ‘ã‚¹ï¼ˆ/ã€/usersã€ã¾ãŸã¯/user/{id}ãªã©ï¼‰ã®å„ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGETã€POSTã€PUTã€DELETEãªã©ï¼‰ã§ã™ã€‚
2. **ã‚¹ãƒ†ãƒ¼ã‚¸**: API Gatewayã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€é–‹ç™ºã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã€ã¾ãŸã¯æœ¬ç•ªãªã©ã€APIã®**ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ç’°å¢ƒ**ã‚’è¡¨ã—ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®APIã‚’åŒæ™‚ã«ç®¡ç†ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€æœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãªãæ–°æ©Ÿèƒ½ã‚„ãƒã‚°ä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã¾ãŸã€ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦APIã®å‹•ä½œã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ãƒšã‚¢ã§ã™ã€‚ãŸã¨ãˆã°ã€ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç•°ãªã‚‹Lambdaé–¢æ•°ã‚„ä»–ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€API Gatewayã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®URLã®å…ˆé ­ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
3. **èªè¨¼è€…**: API Gatewayã®èªè¨¼è€…ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç¶šè¡Œã•ã‚Œã‚‹å‰ã«å‘¼ã³å‡ºã—å…ƒã®èº«å…ƒã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ èªè¨¼è€…ã¨ã—ã¦**AWS Lambdaé–¢æ•°**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ç‹¬è‡ªã®èªè¨¼ãŠã‚ˆã³èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¨ã€API Gatewayã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Lambdaèªè¨¼è€…ã«æ¸¡ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†ã—ã¦å‘¼ã³å‡ºã—å…ƒãŒå®Ÿè¡Œã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹IAMãƒãƒªã‚·ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚API Gatewayã¯ã¾ãŸã€**AWS Identity and Access Managementï¼ˆIAMï¼‰**ã‚„**Amazon Cognito**ãªã©ã®**çµ„ã¿è¾¼ã¿èªè¨¼è€…**ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
4. **ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼**: API Gatewayã®ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯ã€APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å®šç¾©ã™ã‚‹JSONãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚ã“ã‚Œã¯IAMãƒãƒªã‚·ãƒ¼ã«ä¼¼ã¦ã„ã¾ã™ãŒã€API Gatewayã«ç‰¹åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€å‘¼ã³å‡ºã›ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€æ¥ç¶šã§ãã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯VPCã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯èªè¨¼è€…ã¨çµ„ã¿åˆã‚ã›ã¦**ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€APIã®ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ãŸå¾Œã¯ã€APIã‚’**å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

### ãƒ­ã‚®ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**CloudWatch Logs**ã¯**ã‚ªãƒ•**ã€**ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**ã¯**ã‚ªãƒ•**ã€**X-Rayãƒˆãƒ¬ãƒ¼ã‚¹**ã‚‚**ã‚ªãƒ•**ã§ã™ã€‚

### åˆ—æŒ™åŒ–
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws --profile myadmin --region eu-west-1 apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
## API Gatewayã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ç•°ãªã‚‹èªè¨¼æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹

### ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼

ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€**æŒ‡å®šã•ã‚ŒãŸIPã¯GETãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦`/resource_policy`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM Authorizer

ãƒ‘ã‚¹ï¼ˆãƒªã‚½ãƒ¼ã‚¹ï¼‰å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«IAMèªè¨¼ãŒå¿…è¦ãªè¨­å®šã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

ã“ã®è¨­å®šãŒã•ã‚Œã¦ã„ã‚‹å ´åˆã€èªè¨¼ãªã—ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€`{"message":"Missing Authentication Token"}`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦æœŸå¾…ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ç°¡å˜ãªæ–¹æ³•ã¯ã€**Postman**å†…ã§**`Authorization`**ã‚¿ã‚¤ãƒ—ã‚’**`AWS Signature`**ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

ä½¿ç”¨ã—ãŸã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’è¨­å®šã—ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãª**Authorizationãƒ˜ãƒƒãƒ€ãƒ¼**ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
ä»–ã®å ´åˆã§ã¯ã€**Authorizer**ãŒ**ä¸é©åˆ‡ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**ã•ã‚Œã¦ãŠã‚Šã€**Authorizationãƒ˜ãƒƒãƒ€ãƒ¼**ã«**ä½•ã§ã‚‚**é€ä¿¡ã™ã‚‹ã ã‘ã§ã€**éš ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚«ã‚¹ã‚¿ãƒ Lambda Authorizer

ç‰¹å®šã®ãƒˆãƒ¼ã‚¯ãƒ³ã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™æ¨©é™**ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã™IAMãƒãƒªã‚·ãƒ¼ã‚’**è¿”ã™Lambda**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
Authorizerã‚’ä½¿ç”¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ã€‚

<details>

<summary>Lambda Authorizerã®ã‚³ãƒ¼ãƒ‰ä¾‹</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

ä»¥ä¸‹ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã¾ã™ï¼š

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambdaã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã¯ã€ã“ã®èªè¨¼ã¯è„†å¼±ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
{% endhint %}

**æ‹’å¦ãƒãƒªã‚·ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦è¿”ã•ã‚Œã‚‹**å ´åˆã€API Gatewayã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š`{"Message":"User is not authorized to access this resource with an explicit deny"}`

ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®èªè¨¼ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒ**ç‰¹å®š**ã§ãã¾ã™ã€‚

### å¿…è¦ãªAPIã‚­ãƒ¼

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã€ãã‚Œã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯**æœ‰åŠ¹ãªAPIã‚­ãƒ¼ãŒå¿…è¦**ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

APIã‚­ãƒ¼ã¯API Gatewayãƒãƒ¼ã‚¿ãƒ«ã§ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã€ä½¿ç”¨å›æ•°ï¼ˆç§’ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŠã‚ˆã³æœˆã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

APIã‚­ãƒ¼ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€ãã‚Œã‚’**ä½¿ç”¨ãƒ—ãƒ©ãƒ³**ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä½¿ç”¨ãƒ—ãƒ©ãƒ³ã¯**APIã‚¹ãƒ†ãƒ¼ã‚¸**ã«è¿½åŠ ã•ã‚Œã€é–¢é€£ã™ã‚‹APIã‚¹ãƒ†ãƒ¼ã‚¸ã«ã¯**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã«å¯¾ã—ã¦**ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°**ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

## èªè¨¼ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## ç‰¹æ¨©æ˜‡æ ¼

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### æ°¸ç¶šåŒ–

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
