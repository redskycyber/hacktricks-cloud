# AWS - Enumeraci贸n de API Gateway

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## API Gateway

### Informaci贸n B谩sica

AWS API Gateway es un servicio integral ofrecido por Amazon Web Services (AWS) dise帽ado para que los desarrolladores **crean, publiquen y supervisen APIs a gran escala**. Funciona como un punto de entrada a una aplicaci贸n, permitiendo a los desarrolladores establecer un marco de reglas y procedimientos. Este marco controla el acceso que los usuarios externos tienen a ciertos datos o funcionalidades dentro de la aplicaci贸n.

API Gateway te permite definir **c贸mo deben manejarse las solicitudes a tus APIs**, y puede crear puntos finales de API personalizados con m茅todos espec铆ficos (por ejemplo, GET, POST, PUT, DELETE) y recursos. Tambi茅n puede generar SDKs de cliente (Kits de Desarrollo de Software) para que sea m谩s f谩cil para los desarrolladores llamar a tus APIs desde sus aplicaciones.

### Tipos de API Gateways

* **API HTTP**: Construye APIs REST de baja latencia y rentables con funciones integradas como OIDC y OAuth2, y soporte nativo de CORS. Funciona con lo siguiente: Lambda, backends HTTP.
* **API WebSocket**: Crea una API WebSocket utilizando conexiones persistentes para casos de uso en tiempo real como aplicaciones de chat o paneles de control. Funciona con lo siguiente: Lambda, HTTP, Servicios de AWS.
* **API REST**: Desarrolla una API REST donde obtienes control completo sobre la solicitud y respuesta junto con capacidades de gesti贸n de API. Funciona con lo siguiente: Lambda, HTTP, Servicios de AWS.
* **API REST Privada**: Crea una API REST que solo es accesible desde dentro de una VPC.

### Componentes Principales de API Gateway

1. **Recursos**: En API Gateway, los recursos son los componentes que **componen la estructura de tu API**. Representan **los diferentes caminos o puntos finales** de tu API y corresponden a las diversas acciones que tu API admite. Un recurso es cada m茅todo (por ejemplo, GET, POST, PUT, DELETE) **dentro de cada camino** (/, o /usuarios, o /usuario/{id}).
2. **Etapas**: Las etapas en API Gateway representan **diferentes versiones o entornos** de tu API, como desarrollo, puesta en escena o producci贸n. Puedes usar etapas para gestionar e implementar **m煤ltiples versiones de tu API simult谩neamente**, lo que te permite probar nuevas funciones o correcciones de errores sin afectar el entorno de producci贸n. Las etapas tambi茅n **soportan variables de etapa**, que son pares clave-valor que se pueden utilizar para configurar el comportamiento de tu API en funci贸n de la etapa actual. Por ejemplo, podr铆as usar variables de etapa para dirigir las solicitudes de API a diferentes funciones Lambda u otros servicios backend seg煤n la etapa.
* La etapa se indica al principio de la URL del punto final de API Gateway.
3. **Autorizadores**: Los autorizadores en API Gateway son responsables de **controlar el acceso a tu API** verificando la identidad del solicitante antes de permitir que la solicitud contin煤e. Puedes usar **funciones Lambda de AWS** como autorizadores personalizados, lo que te permite implementar tu propia l贸gica de autenticaci贸n y autorizaci贸n. Cuando llega una solicitud, API Gateway pasa el token de autorizaci贸n de la solicitud al autorizador Lambda, que procesa el token y devuelve una pol铆tica IAM que determina qu茅 acciones se le permite realizar al solicitante. API Gateway tambi茅n admite **autorizadores integrados**, como **Identity and Access Management (IAM) de AWS** y **Amazon Cognito**.
4. **Pol铆tica de Recursos**: Una pol铆tica de recursos en API Gateway es un documento JSON que **define los permisos para acceder a tu API**. Es similar a una pol铆tica IAM pero espec铆ficamente dise帽ada para API Gateway. Puedes usar una pol铆tica de recursos para controlar qui茅n puede acceder a tu API, qu茅 m茅todos pueden llamar y desde qu茅 direcciones IP o VPC pueden conectarse. **Las pol铆ticas de recursos se pueden utilizar en combinaci贸n con autorizadores** para proporcionar un control de acceso detallado para tu API.
* Para que la API haga efecto, es necesario que sea **implementada nuevamente despu茅s de** que se modifique la pol铆tica de recursos.

### Registro

Por defecto, los **registros de CloudWatch** est谩n **apagados**, el **registro de acceso** est谩 **apagado**, y el **seguimiento de X-Ray** tambi茅n est谩 **apagado**.

### Enumeraci贸n

{% hint style="success" %}
Ten en cuenta que en ambas APIs de AWS para enumerar recursos (**`apigateway`** y **`apigatewayv2`**) el 煤nico permiso que necesitas y el 煤nico permiso de lectura que se puede otorgar es **`apigateway:GET`**, con eso puedes **enumerar todo**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %} 

### Enumeraci贸n de AWS API Gateway v2

#### Descripci贸n

La enumeraci贸n en AWS API Gateway v2 se puede realizar a trav茅s de la API de Management. Esto puede revelar informaci贸n sobre las API existentes, como nombres, descripciones, rutas y configuraciones.

#### Pasos de enumeraci贸n

1. **Listar APIs**: Utilice la operaci贸n `getApis` para enumerar las APIs disponibles en la cuenta.
   
2. **Obtener detalles de API**: Utilice la operaci贸n `getApi` para obtener detalles espec铆ficos de una API, como la configuraci贸n de autorizaci贸n y la definici贸n de rutas.

3. **Enumerar rutas**: Utilice la operaci贸n `getRoutes` para enumerar las rutas definidas en una API espec铆fica.

4. **Enumerar integraciones**: Utilice la operaci贸n `getIntegrations` para enumerar las integraciones configuradas en una ruta espec铆fica.

#### Impacto de la enumeraci贸n

La enumeraci贸n de AWS API Gateway v2 puede revelar informaci贸n sensible sobre la arquitectura de las API, lo que podr铆a ayudar a un atacante a identificar posibles puntos de entrada o vulnerabilidades en el sistema.

Recomendamos realizar una enumeraci贸n cuidadosa y limitar el acceso a la API de Management para reducir el riesgo de exposici贸n de informaci贸n confidencial.

{% endtab %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## Diferentes autorizaciones para acceder a los puntos finales de API Gateway

### Pol铆tica de recursos

Es posible utilizar pol铆ticas de recursos para definir qui茅n puede llamar a los puntos finales de la API.\
En el siguiente ejemplo se puede ver que la **IP indicada no puede llamar** al punto final `/resource_policy` a trav茅s de GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Autorizador IAM

Es posible establecer que un m茅todo dentro de una ruta (un recurso) requiere autenticaci贸n IAM para llamarlo.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Cuando esto est谩 configurado, recibir谩s el error `{"message":"Missing Authentication Token"}` cuando intentes acceder al punto final sin ninguna autorizaci贸n.

Una forma sencilla de generar el token esperado por la aplicaci贸n es utilizar el tipo de **`Autorizaci贸n`** **`Firma AWS`** dentro de **Postman**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Establece la accessKey y la SecretKey de la cuenta que deseas utilizar y podr谩s autenticarte contra el punto final de la API.

Generar谩 un encabezado de **Autorizaci贸n** como este:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Ten en cuenta que en otros casos el **Autorizador** podr铆a haber sido **mal codificado** y simplemente enviar **cualquier cosa** dentro del **encabezado de Autorizaci贸n** permitir谩 ver el contenido oculto.

### Firma de solicitud usando Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Autorizador Lambda Personalizado

Es posible utilizar una funci贸n lambda que, basada en un token dado, **devolver谩 una pol铆tica IAM** indicando si el usuario est谩 **autorizado para llamar al punto de conexi贸n de la API**.\
Puedes configurar cada m茅todo de recurso que utilizar谩 el autorizador.

<details>

<summary>Ejemplo de C贸digo del Autorizador Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Ll谩malo con algo como:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Dependiendo del c贸digo de Lambda, esta autorizaci贸n podr铆a ser vulnerable
{% endhint %}

Ten en cuenta que si se genera y devuelve una **pol铆tica de denegaci贸n**, el error devuelto por API Gateway es: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

De esta manera podr铆as **identificar esta autorizaci贸n** que est谩 en su lugar.

### Clave de API requerida

Es posible configurar puntos finales de API que **requieran una clave de API v谩lida** para contactarlos.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Es posible generar claves de API en el portal de API Gateway e incluso establecer cu谩nto puede ser utilizado (en t茅rminos de solicitudes por segundo y en t茅rminos de solicitudes por mes).

Para que una clave de API funcione, debes agregarla a un **Plan de uso**, este plan de uso debe ser agregado a la **Etapa de API** y la etapa de API asociada necesita tener configurado un **control de velocidad del m茅todo** hacia el **punto final** que requiere la clave de API:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Acceso no autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Elevaci贸n de privilegios

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Explotaci贸n

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
