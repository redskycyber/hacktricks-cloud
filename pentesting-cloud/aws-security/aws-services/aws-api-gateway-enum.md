# AWS - API Gateway Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ã‚’ä½¿ã£ã¦ AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„å ´åˆ**ã‚„**HackTricks ã‚’ PDF ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ PEASS & HackTricks ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFT**](https://opensea.io/collection/the-peass-family) ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm) ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## API Gateway

### åŸºæœ¬æƒ…å ±

AWS API Gateway ã¯ã€Amazon Web Services (AWS) ãŒæä¾›ã™ã‚‹å®Œå…¨ã«ç®¡ç†ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã€**ä»»æ„ã®è¦æ¨¡ã§** **API (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)** ã‚’ä½œæˆã€å…¬é–‹ã€ç¶­æŒã€ç›£è¦–ã€ãŠã‚ˆã³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚API Gateway ã¯ã€Amazon Elastic Compute Cloud (**EC2**), AWS **Lambda**, ã¾ãŸã¯ä»»æ„ã®**ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ãªã©ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã¾ãŸã¯æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**ã€Œãƒ•ãƒ­ãƒ³ãƒˆãƒ‰ã‚¢ã€**ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

API Gateway ã§ã¯ã€API ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†æ–¹æ³•ã‚’å®šç¾©ã§ãã€ç‰¹å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ (ä¾‹: GET, POST, PUT, DELETE) ã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ  API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚ã¾ãŸã€é–‹ç™ºè€…ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ API ã‚’å‘¼ã³å‡ºã—ã‚„ã™ãã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ SDK (ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚­ãƒƒãƒˆ) ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### API Gateway ã®ã‚¿ã‚¤ãƒ—

* **HTTP API**: OIDC ã¨ OAuth2ã€ãƒã‚¤ãƒ†ã‚£ãƒ– CORS ã‚µãƒãƒ¼ãƒˆãªã©ã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ä½é…å»¶ã‹ã¤ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ REST API ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚æ¬¡ã®ã‚‚ã®ã¨é€£æºã—ã¾ã™: Lambda, HTTP ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€‚
* **WebSocket API**: ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã€æ°¸ç¶šçš„ãªæ¥ç¶šã‚’ä½¿ç”¨ã™ã‚‹ WebSocket API ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚æ¬¡ã®ã‚‚ã®ã¨é€£æºã—ã¾ã™: Lambda, HTTP, AWS ã‚µãƒ¼ãƒ“ã‚¹ã€‚
* **REST API**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®Œå…¨ã«åˆ¶å¾¡ã—ã€API ç®¡ç†æ©Ÿèƒ½ã‚’å‚™ãˆãŸ REST API ã‚’é–‹ç™ºã—ã¾ã™ã€‚æ¬¡ã®ã‚‚ã®ã¨é€£æºã—ã¾ã™: Lambda, HTTP, AWS ã‚µãƒ¼ãƒ“ã‚¹ã€‚
* **REST API Private**: VPC å†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª REST API ã‚’ä½œæˆã—ã¾ã™ã€‚

### API Gateway ã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

1. **ãƒªã‚½ãƒ¼ã‚¹**: API Gateway ã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã¯**API ã®æ§‹é€ ã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ã§ã™ã€‚ãã‚Œã‚‰ã¯ API ã®**ç•°ãªã‚‹ãƒ‘ã‚¹ã¾ãŸã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã‚’è¡¨ã—ã€API ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ã•ã¾ã–ã¾ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã¯ã€å„ãƒ‘ã‚¹å†…ã®å„ãƒ¡ã‚½ãƒƒãƒ‰ (ä¾‹: GET, POST, PUT, DELETE) ã§ã™ (/, /users, /user/{id} ãªã©)ã€‚
2. **ã‚¹ãƒ†ãƒ¼ã‚¸**: API Gateway ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€é–‹ç™ºã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã€ã¾ãŸã¯æœ¬ç•ªãªã©ã€API ã®**ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ãŸã¯ç’°å¢ƒ**ã‚’è¡¨ã—ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€**API ã®è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åŒæ™‚ã«ç®¡ç†ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤**ã§ãã€æ–°æ©Ÿèƒ½ã‚„ãƒã‚°ä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆã—ãªãŒã‚‰æœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãªãè¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã¯**ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚‚ã‚µãƒãƒ¼ãƒˆ**ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯ API ã®å‹•ä½œã‚’ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦ç•°ãªã‚‹ Lambda é–¢æ•°ã‚„ä»–ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã« API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒ‡ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ API Gateway ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã® URL ã®å§‹ã¾ã‚Šã«ç¤ºã•ã‚Œã¾ã™ã€‚
3. **ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼**: API Gateway ã®ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹å‰ã«å‘¼ã³å‡ºã—å…ƒã®èº«å…ƒã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§**API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹**è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã¨ã—ã¦**AWS Lambda é–¢æ•°**ã‚’ä½¿ç”¨ã§ãã€ç‹¬è‡ªã®èªè¨¼ãŠã‚ˆã³æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã‚‹ã¨ã€API Gateway ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Lambda ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã«æ¸¡ã—ã€ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†ã—ã¦ã€å‘¼ã³å‡ºã—å…ƒãŒå®Ÿè¡Œã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹ IAM ãƒãƒªã‚·ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚API Gateway ã¯**çµ„ã¿è¾¼ã¿ã®ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼**ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€**AWS Identity and Access Management (IAM)** ã‚„**Amazon Cognito**ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
4. **ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼**: API Gateway ã®ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯ã€**API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å®šç¾©ã™ã‚‹** JSON ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚IAM ãƒãƒªã‚·ãƒ¼ã«ä¼¼ã¦ã„ã¾ã™ãŒã€API Gateway ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€èª°ãŒ API ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã€ã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã‚‹ã‹ã€ã©ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ VPC ã‹ã‚‰æ¥ç¶šã§ãã‚‹ã‹ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚**ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨**ã•ã‚Œã€API ã«å¯¾ã™ã‚‹ãã‚ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’æä¾›ã§ãã¾ã™ã€‚
* ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ãŸå¾Œã€API ãŒ**å†ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

### ãƒ­ã‚®ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**CloudWatch Logs** ã¯**ã‚ªãƒ•**ã€**ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**ã¯**ã‚ªãƒ•**ã€**X-Ray ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°**ã‚‚**ã‚ªãƒ•**ã§ã™ã€‚

### åˆ—æŒ™

{% hint style="success" %}
ãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã®ä¸¡æ–¹ã® AWS API (**`apigateway`** ã¨ **`apigatewayv2`**) ã§å¿…è¦ãªå”¯ä¸€ã®æ¨©é™ã§ã‚ã‚Šã€ä»˜ä¸å¯èƒ½ãªå”¯ä¸€ã®èª­ã¿å–ã‚Šæ¨©é™ã¯ **`apigateway:GET`** ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã™ã¹ã¦ã‚’åˆ—æŒ™ã§ãã¾ã™ã€‚**
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## API Gateway ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã™ã‚‹ç•°ãªã‚‹èªè¨¼æ–¹æ³•

### ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼

ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
æ¬¡ã®ä¾‹ã§ã¯ã€**æŒ‡å®šã•ã‚ŒãŸ IP ã¯** `/resource_policy` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ GET çµŒç”±ã§å‘¼ã³å‡ºã™ã“ã¨ãŒã§ããªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM èªè¨¼

ãƒ‘ã‚¹å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆãƒªã‚½ãƒ¼ã‚¹ï¼‰ãŒ IAM èªè¨¼ã‚’å¿…è¦ã¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

ã“ã‚ŒãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€èªè¨¼ãªã—ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ `{"message":"Missing Authentication Token"}` ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœŸå¾…ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ç°¡å˜ãªæ–¹æ³•ã¯ã€**Postman** å†…ã§ **`Authorization`** ã‚¿ã‚¤ãƒ—ã® **`AWS Signature`** ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

ä½¿ç”¨ã—ãŸã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® accessKey ã¨ SecretKey ã‚’è¨­å®šã™ã‚‹ã¨ã€API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡ã®ã‚ˆã†ãª **Authorization** **ãƒ˜ãƒƒãƒ€ãƒ¼** ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
ä»–ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€**Authorizer**ãŒ**ä¸é©åˆ‡ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã€**Authorization header**å†…ã«**ä½•ã‹ã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§ã€éš ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹**ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### ã‚«ã‚¹ã‚¿ãƒ  Lambda Authorizer

ä¸ãˆã‚‰ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™æ¨©é™ãŒã‚ã‚‹ã‹ã©ã†ã‹**ã‚’ç¤ºã™**IAMãƒãƒªã‚·ãƒ¼ã‚’è¿”ã™**Lambdaã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ä½¿ç”¨ã™ã‚‹ã‚ªãƒ¼ã‚½ãƒ©ã‚¤ã‚¶ãƒ¼ã§å„ãƒªã‚½ãƒ¼ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨­å®šã§ãã¾ã™ã€‚

<details>

<summary>Lambda Authorizer ã‚³ãƒ¼ãƒ‰ä¾‹</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

ä»¥ä¸‹ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã¾ã™ï¼š

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambdaã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã¯ã€ã“ã®èªè¨¼ãŒè„†å¼±ã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
{% endhint %}

**æ‹’å¦ãƒãƒªã‚·ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦è¿”ã•ã‚ŒãŸå ´åˆ**ã€API Gatewayã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š`{"Message":"User is not authorized to access this resource with an explicit deny"}`

ã“ã®æ–¹æ³•ã§ã€ã“ã®èªè¨¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’**ç‰¹å®šã§ãã¾ã™**ã€‚

### å¿…è¦ãªAPIã‚­ãƒ¼

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã€æœ‰åŠ¹ãªAPIã‚­ãƒ¼ãŒãªã„ã¨æ¥è§¦ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

API Gatewayãƒãƒ¼ã‚¿ãƒ«ã§APIã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã€ä½¿ç”¨å¯èƒ½ãªå›æ•°ï¼ˆç§’é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŠã‚ˆã³æœˆé–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®è¦³ç‚¹ã‹ã‚‰ï¼‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

APIã‚­ãƒ¼ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€ãã‚Œã‚’**ä½¿ç”¨è¨ˆç”»**ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã®ä½¿ç”¨è¨ˆç”»ã¯**APIã‚¹ãƒ†ãƒ¼ã‚¸**ã«è¿½åŠ ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã€é–¢é€£ã™ã‚‹APIã‚¹ãƒ†ãƒ¼ã‚¸ã¯APIã‚­ãƒ¼ãŒå¿…è¦ãª**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã«å¯¾ã—ã¦**ãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°**ã‚’è¨­å®šã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## èªè¨¼ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## æ¨©é™æ˜‡æ ¼

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## æ”»æ’ƒå¾Œã®æ´»å‹•

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### æŒç¶šæ€§

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã—ã¦ãã ã•ã„**ã€‚

</details>
