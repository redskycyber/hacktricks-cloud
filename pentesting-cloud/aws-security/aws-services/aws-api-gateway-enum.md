# AWS - API Gateway Enum

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹**

</details>

## API Gateway

### åŸºæœ¬æƒ…å ±

AWS API Gatewayã¯ã€é–‹ç™ºè€…ãŒ**å¤§è¦æ¨¡ãªAPIã‚’ä½œæˆã€å…¬é–‹ã€ç›£è¦–**ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAmazon Web Servicesï¼ˆAWSï¼‰ãŒæä¾›ã™ã‚‹åŒ…æ‹¬çš„ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã“ã‚Œã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã—ã€é–‹ç™ºè€…ãŒãƒ«ãƒ¼ãƒ«ã¨æ‰‹é †ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºç«‹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚„æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è¦å®šã—ã¾ã™ã€‚

API Gatewayã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†æ–¹æ³•ã‚’å®šç¾©ã§ãã€ç‰¹å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆä¾‹ï¼šGETã€POSTã€PUTã€DELETEï¼‰ã¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚ã¾ãŸã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKï¼ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚­ãƒƒãƒˆï¼‰ã‚’ç”Ÿæˆã—ã¦ã€é–‹ç™ºè€…ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰APIã‚’å‘¼ã³å‡ºã—ã‚„ã™ãã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### API Gatewayã®ç¨®é¡

- **HTTP API**: OIDCã‚„OAuth2ãªã©ã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’å‚™ãˆãŸä½é…å»¶ã‹ã¤ã‚³ã‚¹ãƒˆåŠ¹æœã®é«˜ã„REST APIã‚’æ§‹ç¯‰ã—ã€ãƒã‚¤ãƒ†ã‚£ãƒ–CORSã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€‚
- **WebSocket API**: ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å‘ã‘ãŸæ°¸ç¶šçš„æ¥ç¶šã‚’ä½¿ç”¨ã—ã¦WebSocket APIã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€‚
- **REST API**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å®Œå…¨ãªåˆ¶å¾¡æ¨©ã‚’æŒã¡ã€APIç®¡ç†æ©Ÿèƒ½ã‚’å‚™ãˆãŸREST APIã‚’é–‹ç™ºã—ã¾ã™ã€‚ä»¥ä¸‹ã¨é€£æºã—ã¾ã™ï¼šLambdaã€HTTPã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€‚
- **REST API Private**: VPCå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªREST APIã‚’ä½œæˆã—ã¾ã™ã€‚

### API Gatewayã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

1. **ãƒªã‚½ãƒ¼ã‚¹**: API Gatewayã§ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã¯APIã®æ§‹é€ ã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ã“ã‚Œã‚‰ã¯APIã®ç•°ãªã‚‹ãƒ‘ã‚¹ã‚„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ã—ã€APIãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ã•ã¾ã–ã¾ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã¯ã€å„ãƒ‘ã‚¹ï¼ˆ/ã€ã¾ãŸã¯/usersã€ã¾ãŸã¯/user/{id}å†…ã®å„ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆä¾‹ï¼šGETã€POSTã€PUTã€DELETEï¼‰ã‚’è¡¨ã—ã¾ã™ã€‚
2. **ã‚¹ãƒ†ãƒ¼ã‚¸**: API Gatewayã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€é–‹ç™ºã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã€æœ¬ç•ªãªã©ã®APIã®ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ç’°å¢ƒã‚’è¡¨ã—ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®APIã‚’åŒæ™‚ã«ç®¡ç†ãŠã‚ˆã³å±•é–‹ã—ã€æ–°æ©Ÿèƒ½ã‚„ãƒã‚°ä¿®æ­£ã‚’æœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãªããƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã¾ãŸã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦APIã®å‹•ä½œã‚’æ§‹æˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã§ã‚ã‚‹**ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç•°ãªã‚‹Lambdaé–¢æ•°ã‚„ä»–ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€API Gatewayã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®URLã®å…ˆé ­ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
3. **èªè¨¼è€…**: API Gatewayã®èªè¨¼è€…ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç¶šè¡Œã•ã‚Œã‚‹å‰ã«å‘¼ã³å‡ºã—å…ƒã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ èªè¨¼è€…ã¨ã—ã¦**AWS Lambdaé–¢æ•°**ã‚’ä½¿ç”¨ã§ãã€ç‹¬è‡ªã®èªè¨¼ãŠã‚ˆã³æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¨ã€API Gatewayã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Lambdaèªè¨¼è€…ã«æ¸¡ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†ã—ã¦å‘¼ã³å‡ºã—å…ƒãŒå®Ÿè¡Œã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹IAMãƒãƒªã‚·ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚API Gatewayã¯ã¾ãŸã€**AWS Identity and Access Managementï¼ˆIAMï¼‰**ã‚„**Amazon Cognito**ãªã©ã®**çµ„ã¿è¾¼ã¿èªè¨¼è€…**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
4. **ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼**: API Gatewayã®ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯ã€APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å®šç¾©ã™ã‚‹JSONãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚ã“ã‚Œã¯IAMãƒãƒªã‚·ãƒ¼ã«ä¼¼ã¦ã„ã¾ã™ãŒã€API Gatewayã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€å‘¼ã³å‡ºã›ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€æ¥ç¶šã§ãã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„VPCã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚**ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã¯èªè¨¼è€…ã¨çµ„ã¿åˆã‚ã›ã¦**ã€APIã®ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’æä¾›ã§ãã¾ã™ã€‚
- ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ãŸå¾Œã¯ã€APIã‚’**å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

### ãƒ­ã‚®ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**CloudWatch Logs**ã¯**ã‚ªãƒ•**ã€**ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**ã¯**ã‚ªãƒ•**ã€**X-Rayãƒˆãƒ¬ãƒ¼ã‚¹**ã‚‚**ã‚ªãƒ•**ã§ã™ã€‚

### åˆ—æŒ™

{% hint style="success" %}
AWSã®ä¸¡æ–¹ã®APIã§ãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå”¯ä¸€ã®æ¨©é™ï¼ˆ**`apigateway:GET`**ï¼‰ã¨ä»˜ä¸å¯èƒ½ãªå”¯ä¸€ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã™ã¹ã¦ã‚’åˆ—æŒ™ã§ãã¾ã™**ã€‚
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}

### AWS API Gateway v2 Enumerations

#### Supported Protocols

- **HTTP**
- **WEBSOCKET**

#### Integration Types

- **AWS_PROXY**
- **HTTP_PROXY**
- **HTTP**
- **AWS**
- **MOCK**

#### Payload Encoding

- **1.0**
- **2.0**

#### Route Key Types

- **METHOD**
- **PATH**

#### Security Types

- **NONE**
- **AWS_IAM**
- **CUSTOM**

#### Authorization Types

- **NONE**
- **AWS_IAM**
- **CUSTOM**

#### Connection Types

- **INTERNET**
- **VPC_LINK**

#### API Endpoint Types

- **REGIONAL**
- **PRIVATE**
- **EDGE**

#### Route Selection Expressions

- **$request.method**
- **$request.path**
- **$request.header**
- **$request.querystring**
- **$request.body**
- **$context.authorizer.claims**
- **$context.authorizer.principalId**
- **$context.authorizer.integrationLatency**
- **$context.identity.sourceIp**
-json:api-gateway-v2-enum.md

{% endtab %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## API Gatewayã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

### ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã«ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
æ¬¡ã®ä¾‹ã§ã¯ã€**æŒ‡å®šã•ã‚ŒãŸIPã¯**GETçµŒç”±ã§`/resource_policy`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

### IAMèªè¨¼

ãƒ‘ã‚¹ï¼ˆãƒªã‚½ãƒ¼ã‚¹ï¼‰å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒIAMèªè¨¼ã‚’å¿…è¦ã¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

ã“ã‚Œã‚’è¨­å®šã™ã‚‹ã¨ã€èªè¨¼ãªã—ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆ°é”ã—ã‚ˆã†ã¨ã™ã‚‹ã¨`{"message":"Missing Authentication Token"}`ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

æœŸå¾…ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ç”Ÿæˆã™ã‚‹ç°¡å˜ãªæ–¹æ³•ã¯ã€**Postman**å†…ã§**`Authorization`**ã‚¿ã‚¤ãƒ—ã‚’**`AWS Signature`**ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (168).png" alt=""><figcaption></figcaption></figure>

ä½¿ç”¨ã—ãŸã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®accessKeyã¨SecretKeyã‚’è¨­å®šã™ã‚‹ã¨ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦èªè¨¼ã§ãã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ãª**Authorization** **ãƒ˜ãƒƒãƒ€ãƒ¼**ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
æ³¨æ„ï¼šä»–ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€**Authorizer** ãŒ**ä¸é©åˆ‡ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**ã•ã‚Œã¦ãŠã‚Šã€**Authorizationãƒ˜ãƒƒãƒ€ãƒ¼**ã«**ä½•ã§ã‚‚**é€ä¿¡ã™ã‚‹ã ã‘ã§**éè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### Pythonã‚’ä½¿ç”¨ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆç½²å
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### ã‚«ã‚¹ã‚¿ãƒ Lambdaèªè¨¼è€…

ç‰¹å®šã®ãƒˆãƒ¼ã‚¯ãƒ³ã«åŸºã¥ã„ã¦IAMãƒãƒªã‚·ãƒ¼ã‚’è¿”ã™Lambdaã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™æ¨©é™ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚\
èªè¨¼è€…ã‚’ä½¿ç”¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨­å®šã§ãã¾ã™ã€‚

<details>

<summary>Lambdaèªè¨¼è€…ã®ã‚³ãƒ¼ãƒ‰ä¾‹</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å‘¼ã³å‡ºã—ã¾ã™ï¼š

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambdaã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã¯ã€ã“ã®èªè¨¼ãŒè„†å¼±ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
{% endhint %}

**æ‹’å¦ãƒãƒªã‚·ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦è¿”ã•ã‚Œã‚‹**å ´åˆã€API Gatewayã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š`{"Message":"User is not authorized to access this resource with an explicit deny"}`

ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®èªè¨¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒ**ç‰¹å®š**ã§ãã¾ã™ã€‚

### å¿…é ˆAPIã‚­ãƒ¼

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã€ãã‚Œã«é€£çµ¡ã™ã‚‹ãŸã‚ã«**æœ‰åŠ¹ãªAPIã‚­ãƒ¼ãŒå¿…è¦**ãªã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

<figure><img src="../../../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

API Gatewayãƒãƒ¼ã‚¿ãƒ«ã§APIã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã€ãã‚ŒãŒä½¿ç”¨ã§ãã‚‹å›æ•°ï¼ˆç§’ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŠã‚ˆã³æœˆã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

APIã‚­ãƒ¼ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€ãã‚Œã‚’**ä½¿ç”¨ãƒ—ãƒ©ãƒ³**ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä½¿ç”¨ãƒ—ãƒ©ãƒ³ã¯**APIã‚¹ãƒ†ãƒ¼ã‚¸**ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€é–¢é€£ã™ã‚‹APIã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€APIã‚­ãƒ¼ãŒå¿…è¦ãª**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã«**ãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°**ã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

## èªè¨¼ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## ç‰¹æ¨©æ˜‡æ ¼

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### æ°¸ç¶šæ€§

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã³ã¾ã—ã‚‡ã†ï¼</summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹

</details>
