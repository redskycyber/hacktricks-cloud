# AWS - Wymienianie bramki API

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Bramka API

### Podstawowe informacje

AWS API Gateway to kompleksowa usuga oferowana przez Amazon Web Services (AWS), zaprojektowana dla programist贸w, aby **tworzy, publikowa i nadzorowa interfejsy API na du偶 skal**. Funkcjonuje jako punkt wejcia do aplikacji, pozwalajc programistom ustanowi ramy regu i procedur. Te ramy reguluj dostp, jaki zewntrzni u偶ytkownicy maj do okrelonych danych lub funkcji w aplikacji.

Bramka API umo偶liwia zdefiniowanie **sposobu obsugi 偶da do twoich interfejs贸w API**, mo偶e tworzy niestandardowe punkty kocowe API z okrelonymi metodami (np. GET, POST, PUT, DELETE) i zasobami. Mo偶e r贸wnie偶 generowa zestawy SDK klienta (Software Development Kits), aby uatwi programistom wywoywanie twoich interfejs贸w API z ich aplikacji.

### Typy bramek API

* **API HTTP**: Buduj niskopoziomowe i opacalne interfejsy REST z wbudowanymi funkcjami takimi jak OIDC i OAuth2 oraz natywnym wsparciem dla CORS. Dziaa z nastpujcymi: Lambda, backendami HTTP.
* **API WebSocket**: Buduj interfejs WebSocket z u偶yciem trwaych pocze do zastosowa czasu rzeczywistego, takich jak aplikacje czatowe lub pulpity nawigacyjne. Dziaa z nastpujcymi: Lambda, HTTP, Usugami AWS.
* **API REST**: Opracuj interfejs REST, w kt贸rym zyskujesz pen kontrol nad 偶daniem i odpowiedzi wraz z mo偶liwociami zarzdzania interfejsem API. Dziaa z nastpujcymi: Lambda, HTTP, Usugami AWS.
* **Prywatne API REST**: Utw贸rz interfejs REST, kt贸ry jest dostpny tylko z wewntrz VPC.

### G贸wne skadniki bramki API

1. **Zasoby**: W bramce API zasoby to komponenty, kt贸re **tworz struktur twojego interfejsu API**. Reprezentuj **r贸偶ne cie偶ki lub punkty kocowe** twojego interfejsu API i odpowiadaj r贸偶nym dziaaniom, kt贸re obsuguje twoje API. Zas贸b to ka偶da metoda (np. GET, POST, PUT, DELETE) **wewntrz ka偶dej cie偶ki** (/, lub /u偶ytkownicy, lub /u偶ytkownik/{id}.
2. **Etap**: Etapy w bramce API reprezentuj **r贸偶ne wersje lub rodowiska** twojego interfejsu API, takie jak rozw贸j, staging lub produkcja. Mo偶esz u偶ywa etap贸w do zarzdzania i wdra偶ania **wielu wersji twojego interfejsu jednoczenie**, pozwalajc na testowanie nowych funkcji lub poprawek bd贸w bez wpywu na rodowisko produkcyjne. Etapy obsuguj r贸wnie偶 **zmienne etapu**, kt贸re s parami klucz-warto, kt贸re mo偶na u偶y do konfigurowania zachowania twojego interfejsu API na podstawie bie偶cego etapu. Na przykad, mo偶na u偶y zmiennych etapu do kierowania 偶da interfejsu API do r贸偶nych funkcji Lambda lub innych usug backendowych w zale偶noci od etapu.
* Etap jest wskazany na pocztku adresu URL punktu kocowego bramki API.
3. **Autoryzatory**: Autoryzatory w bramce API s odpowiedzialne za **kontrol dostpu do twojego interfejsu API** poprzez weryfikacj to偶samoci osoby dzwonicej przed zezwoleniem na kontynuacj 偶dania. Mo偶esz u偶ywa **funkcji AWS Lambda** jako autoryzator贸w niestandardowych, co pozwala na zaimplementowanie wasnej logiki uwierzytelniania i autoryzacji. Gdy wpynie 偶danie, bramka API przekazuje token autoryzacji 偶dania do autoryzatora Lambda, kt贸ry przetwarza token i zwraca polityk IAM, kt贸ra okrela, jakie dziaania osoba dzwonica ma zezwolenie na wykonanie. Bramka API obsuguje r贸wnie偶 **wbudowane autoryzatory**, takie jak **AWS Identity and Access Management (IAM)** i **Amazon Cognito**.
4. **Polityka zasobu**: Polityka zasobu w bramce API to dokument JSON, kt贸ry **definiuje uprawnienia dostpu do twojego interfejsu API**. Jest podobna do polityki IAM, ale specjalnie dostosowana do bramki API. Mo偶esz u偶y polityki zasobu do kontrolowania, kto mo偶e uzyska dostp do twojego interfejsu API, jakie metody mog wywoa i z jakich adres贸w IP lub VPC mog si poczy. **Polityki zasob贸w mo偶na u偶ywa w poczeniu z autoryzatorami**, aby zapewni precyzyjn kontrol dostpu do twojego interfejsu API.
* Aby zastosowa zmiany, API musi zosta **ponownie wdro偶one po** zmodyfikowaniu polityki zasobu.

### Logowanie

Domylnie **dzienniki CloudWatch** s **wyczone**, **Logowanie dostpu** jest **wyczone**, a **ledzenie X-Ray** r贸wnie偶 jest **wyczone**.

### Wymienianie

{% hint style="success" %}
Zauwa偶, 偶e w obu interfejsach API AWS do wymieniania zasob贸w (**`apigateway`** i **`apigatewayv2`**) jedyn wymagan uprawnieniem i jedynym uprawnieniem do odczytu, kt贸re mo偶na udzieli, jest **`apigateway:GET`**, dziki czemu mo偶na **wymienia wszystko**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %} 

### Enumerating AWS API Gateway v2

#### Enumerating API Gateway v2

1. **List API Gateways v2**: 
   - Use the `getApis` API to list all API Gateways v2 in the account.

2. **Describe API Gateway v2**:
   - Use the `getApi` API to get detailed information about a specific API Gateway v2.

3. **List API Gateway v2 Integrations**:
   - Use the `getIntegrations` API to list all integrations for a specific API Gateway v2.

4. **Describe API Gateway v2 Integration**:
   - Use the `getIntegration` API to get detailed information about a specific integration in an API Gateway v2.

5. **List API Gateway v2 Routes**:
   - Use the `getRoutes` API to list all routes for a specific API Gateway v2.

6. **Describe API Gateway v2 Route**:
   - Use the `getRoute` API to get detailed information about a specific route in an API Gateway v2.

7. **List API Gateway v2 Authorizers**:
   - Use the `getAuthorizers` API to list all authorizers for a specific API Gateway v2.

8. **Describe API Gateway v2 Authorizer**:
   - Use the `getAuthorizer` API to get detailed information about a specific authorizer in an API Gateway v2.

9. **List API Gateway v2 Deployments**:
   - Use the `getDeployments` API to list all deployments for a specific API Gateway v2.

10. **Describe API Gateway v2 Deployment**:
    - Use the `getDeployment` API to get detailed information about a specific deployment in an API Gateway v2.

11. **List API Gateway v2 Stages**:
    - Use the `getStages` API to list all stages for a specific API Gateway v2.

12. **Describe API Gateway v2 Stage**:
    - Use the `getStage` API to get detailed information about a specific stage in an API Gateway v2.

13. **List API Gateway v2 Domain Names**:
    - Use the `getDomainNames` API to list all custom domain names for a specific API Gateway v2.

14. **Describe API Gateway v2 Domain Name**:
    - Use the `getDomainName` API to get detailed information about a specific custom domain name in an API Gateway v2.

15. **List API Gateway v2 Models**:
    - Use the `getModels` API to list all models for a specific API Gateway v2.

16. **Describe API Gateway v2 Model**:
    - Use the `getModel` API to get detailed information about a specific model in an API Gateway v2.

17. **List API Gateway v2 Tags**:
    - Use the `getTags` API to list all tags for a specific API Gateway v2.

18. **Describe API Gateway v2 Tag**:
    - Use the `getTag` API to get detailed information about a specific tag in an API Gateway v2.

{% endtab %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## R贸偶ne uprawnienia do dostpu do punkt贸w kocowych bramy API

### Polityka zasob贸w

Mo偶na u偶y polityk zasob贸w do okrelenia, kto mo偶e wywoa punkty kocowe API.\
W poni偶szym przykadzie mo偶na zobaczy, 偶e **wskazany adres IP nie mo偶e wywoa** punktu kocowego `/resource_policy` za pomoc metody GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Autoryzator IAM

Mo偶na ustawi, 偶e metody wewntrz cie偶ki (zasobu) wymagaj uwierzytelnienia IAM, aby je wywoa.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Gdy to jest ustawione, otrzymasz bd `{"message":"Brak tokenu uwierzytelniajcego"}` gdy spr贸bujesz dotrze do punktu kocowego bez 偶adnej autoryzacji.

atwym sposobem na wygenerowanie oczekiwanego tokenu przez aplikacj jest u偶ycie typu **`Authorization`** **`AWS Signature`** w **Postmanie**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Ustaw dostp do klucza i klucza uwierzytelniajcego konta, kt贸rego chcesz u偶y, i mo偶esz teraz uwierzytelnia si wobec punktu kocowego API.

Wygeneruje to nag贸wek **Authorization** taki jak:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
### Podpis 偶dania za pomoc Pythona
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Niestandardowy autoryzator Lambda

Istnieje mo偶liwo u偶ycia funkcji lambda, kt贸ra na podstawie okrelonego tokena **zwr贸ci polityk IAM**, wskazujc, czy u偶ytkownik jest **uprawniony do wywoania punktu kocowego interfejsu API**.\
Mo偶na ustawi ka偶d metod zasobu, kt贸ra bdzie korzysta z autoryzatora.

<details>

<summary>Przykad kodu autoryzatora Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Wywoaj to co w ten spos贸b:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
W zale偶noci od kodu Lambda, ta autoryzacja mo偶e by podatna
{% endhint %}

Zauwa偶, 偶e jeli **zostaa wygenerowana i zwr贸cona polityka odrzucenia**, bd zwr贸cony przez bram API to: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

W ten spos贸b mo偶na **zidentyfikowa t autoryzacj**.

### Wymagany klucz API

Mo偶liwe jest ustawienie punkt贸w kocowych API, kt贸re **wymagaj poprawnego klucza API** do kontaktu.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Mo偶liwe jest generowanie kluczy API w portalu Bramy API i nawet ustawienie, ile mo偶e by u偶ywane (pod wzgldem 偶da na sekund i pod wzgldem 偶da na miesic).

Aby klucz API dziaa, musisz doda go do **Planu U偶ycia**, ten plan u偶ycia musi by dodany do **Etapu API** i skojarzony etap API musi mie skonfigurowane **ograniczenie metod** do **punktu kocowego** wymagajcego klucza API:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Nieuwierzytelniony dostp

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF** Sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
