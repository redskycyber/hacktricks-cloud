# AWS - API Gateway æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## API ç½‘å…³

### åŸºæœ¬ä¿¡æ¯

AWS API ç½‘å…³æ˜¯äºšé©¬é€Šç½‘ç»œæœåŠ¡ï¼ˆAWSï¼‰æä¾›çš„ä¸€é¡¹å®Œå…¨æ‰˜ç®¡æœåŠ¡ï¼Œå…è®¸æ‚¨åˆ›å»ºã€å‘å¸ƒã€ç»´æŠ¤ã€ç›‘æ§å’Œä¿æŠ¤**ä»»ä½•è§„æ¨¡çš„APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰**ã€‚API ç½‘å…³å……å½“åº”ç”¨ç¨‹åºè®¿é—®æ•°æ®ã€ä¸šåŠ¡é€»è¾‘æˆ–åç«¯æœåŠ¡åŠŸèƒ½çš„**â€œå‰é—¨â€**ï¼Œä¾‹å¦‚åœ¨äºšé©¬é€Šå¼¹æ€§è®¡ç®—äº‘ï¼ˆ**EC2**ï¼‰ã€AWS **Lambda**æˆ–ä»»ä½•**ç½‘ç»œåº”ç”¨ç¨‹åº**ä¸Šè¿è¡Œçš„å·¥ä½œè´Ÿè½½ã€‚

API ç½‘å…³ä½¿æ‚¨èƒ½å¤Ÿå®šä¹‰**å¦‚ä½•å¤„ç†å¯¹APIçš„è¯·æ±‚**ï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºå…·æœ‰ç‰¹å®šæ–¹æ³•ï¼ˆä¾‹å¦‚ï¼ŒGETã€POSTã€PUTã€DELETEï¼‰å’Œèµ„æºçš„è‡ªå®šä¹‰APIç«¯ç‚¹ã€‚å®ƒè¿˜å¯ä»¥ç”Ÿæˆå®¢æˆ·ç«¯SDKï¼ˆè½¯ä»¶å¼€å‘å·¥å…·åŒ…ï¼‰ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜æ›´å®¹æ˜“åœ°ä»ä»–ä»¬çš„åº”ç”¨ç¨‹åºè°ƒç”¨æ‚¨çš„APIã€‚

### API ç½‘å…³ç±»å‹

* **HTTP API**ï¼šä½¿ç”¨å†…ç½®åŠŸèƒ½ï¼ˆå¦‚OIDCå’ŒOAuth2ï¼Œä»¥åŠåŸç”ŸCORSæ”¯æŒï¼‰æ„å»ºä½å»¶è¿Ÿå’Œæˆæœ¬æ•ˆç›Šé«˜çš„REST APIã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambda, HTTPåç«¯ã€‚
* **WebSocket API**ï¼šä½¿ç”¨æŒä¹…è¿æ¥æ„å»ºWebSocket APIï¼Œé€‚ç”¨äºå®æ—¶ç”¨ä¾‹ï¼Œå¦‚èŠå¤©åº”ç”¨ç¨‹åºæˆ–ä»ªè¡¨æ¿ã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambda, HTTP, AWSæœåŠ¡ã€‚
* **REST API**ï¼šå¼€å‘REST APIï¼Œåœ¨è¯·æ±‚å’Œå“åº”ä»¥åŠAPIç®¡ç†èƒ½åŠ›æ–¹é¢æ‚¨å¯ä»¥å®Œå…¨æ§åˆ¶ã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambda, HTTP, AWSæœåŠ¡ã€‚
* **REST API ç§æœ‰**ï¼šåˆ›å»ºä»…åœ¨VPCå†…éƒ¨å¯è®¿é—®çš„REST APIã€‚

### API ç½‘å…³ä¸»è¦ç»„ä»¶

1. **èµ„æº**ï¼šåœ¨APIç½‘å…³ä¸­ï¼Œèµ„æºæ˜¯**æ„æˆAPIç»“æ„çš„ç»„ä»¶**ã€‚å®ƒä»¬ä»£è¡¨äº†APIçš„**ä¸åŒè·¯å¾„æˆ–ç«¯ç‚¹**ï¼Œå¯¹åº”äºAPIæ”¯æŒçš„å„ç§æ“ä½œã€‚èµ„æºæ˜¯æ¯ä¸ªè·¯å¾„ï¼ˆ/, æˆ– /users, æˆ– /user/{id}ï¼‰**å†…çš„æ¯ç§æ–¹æ³•**ï¼ˆä¾‹å¦‚ï¼ŒGETã€POSTã€PUTã€DELETEï¼‰ã€‚
2. **é˜¶æ®µ**ï¼šAPIç½‘å…³ä¸­çš„é˜¶æ®µä»£è¡¨äº†APIçš„**ä¸åŒç‰ˆæœ¬æˆ–ç¯å¢ƒ**ï¼Œå¦‚å¼€å‘ã€é¢„å‘å¸ƒæˆ–ç”Ÿäº§ã€‚æ‚¨å¯ä»¥ä½¿ç”¨é˜¶æ®µæ¥ç®¡ç†å’Œéƒ¨ç½²**APIçš„å¤šä¸ªç‰ˆæœ¬**ï¼Œå…è®¸æ‚¨åœ¨ä¸å½±å“ç”Ÿäº§ç¯å¢ƒçš„æƒ…å†µä¸‹æµ‹è¯•æ–°åŠŸèƒ½æˆ–é”™è¯¯ä¿®å¤ã€‚é˜¶æ®µè¿˜**æ”¯æŒé˜¶æ®µå˜é‡**ï¼Œè¿™äº›æ˜¯å¯ä»¥ç”¨æ¥æ ¹æ®å½“å‰é˜¶æ®µé…ç½®APIè¡Œä¸ºçš„é”®å€¼å¯¹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é˜¶æ®µå˜é‡å°†APIè¯·æ±‚å¼•å¯¼åˆ°ä¸åŒçš„Lambdaå‡½æ•°æˆ–å…¶ä»–åç«¯æœåŠ¡ã€‚
* é˜¶æ®µåœ¨APIç½‘å…³ç«¯ç‚¹çš„URLå¼€å¤´å¤„æŒ‡ç¤ºã€‚
3. **æˆæƒè€…**ï¼šAPIç½‘å…³ä¸­çš„æˆæƒè€…è´Ÿè´£**æ§åˆ¶å¯¹APIçš„è®¿é—®**ï¼Œé€šè¿‡åœ¨å…è®¸è¯·æ±‚ç»§ç»­ä¹‹å‰éªŒè¯è°ƒç”¨è€…çš„èº«ä»½ã€‚æ‚¨å¯ä»¥ä½¿ç”¨**AWS Lambdaå‡½æ•°**ä½œä¸ºè‡ªå®šä¹‰æˆæƒè€…ï¼Œè¿™å…è®¸æ‚¨å®ç°è‡ªå·±çš„è®¤è¯å’Œæˆæƒé€»è¾‘ã€‚å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒAPIç½‘å…³å°†è¯·æ±‚çš„æˆæƒä»¤ç‰Œä¼ é€’ç»™Lambdaæˆæƒè€…ï¼Œåè€…å¤„ç†ä»¤ç‰Œå¹¶è¿”å›ä¸€ä¸ªIAMç­–ç•¥ï¼Œå†³å®šè°ƒç”¨è€…è¢«å…è®¸æ‰§è¡Œçš„æ“ä½œã€‚APIç½‘å…³è¿˜æ”¯æŒ**å†…ç½®æˆæƒè€…**ï¼Œå¦‚**AWSèº«ä»½å’Œè®¿é—®ç®¡ç†ï¼ˆIAMï¼‰**å’Œ**äºšé©¬é€ŠCognito**ã€‚
4. **èµ„æºç­–ç•¥**ï¼šAPIç½‘å…³ä¸­çš„èµ„æºç­–ç•¥æ˜¯ä¸€ä¸ªJSONæ–‡æ¡£ï¼Œ**å®šä¹‰äº†è®¿é—®APIçš„æƒé™**ã€‚å®ƒç±»ä¼¼äºIAMç­–ç•¥ï¼Œä½†ä¸“é—¨ä¸ºAPIç½‘å…³é‡èº«å®šåˆ¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨èµ„æºç­–ç•¥æ¥æ§åˆ¶è°å¯ä»¥è®¿é—®æ‚¨çš„APIï¼Œä»–ä»¬å¯ä»¥è°ƒç”¨å“ªäº›æ–¹æ³•ï¼Œä»¥åŠä»–ä»¬å¯ä»¥ä»å“ªäº›IPåœ°å€æˆ–VPCè¿æ¥ã€‚**èµ„æºç­–ç•¥å¯ä»¥ä¸æˆæƒè€…ç»“åˆä½¿ç”¨**ï¼Œä¸ºæ‚¨çš„APIæä¾›ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ã€‚
* ä¸ºäº†ä½¿APIç”Ÿæ•ˆï¼Œä¿®æ”¹èµ„æºç­–ç•¥åéœ€è¦**å†æ¬¡éƒ¨ç½²**ã€‚

### æ—¥å¿—è®°å½•

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**CloudWatchæ—¥å¿—**æ˜¯**å…³é—­çš„**ï¼Œ**è®¿é—®æ—¥å¿—**æ˜¯**å…³é—­çš„**ï¼Œ**X-Rayè¿½è¸ª**ä¹Ÿæ˜¯**å…³é—­çš„**ã€‚

### æšä¸¾
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws --profile myadmin --region eu-west-1 apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
## è®¿é—®API Gatewayç«¯ç‚¹çš„ä¸åŒæˆæƒæ–¹å¼

### èµ„æºç­–ç•¥

å¯ä»¥ä½¿ç”¨èµ„æºç­–ç•¥å®šä¹‰è°å¯ä»¥è°ƒç”¨APIç«¯ç‚¹ã€‚\
åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°**æŒ‡å®šçš„IPæ— æ³•**é€šè¿‡GETè°ƒç”¨ç«¯ç‚¹`/resource_policy`ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM æˆæƒè€…

å¯ä»¥è®¾ç½®è·¯å¾„ï¼ˆèµ„æºï¼‰å†…çš„æ–¹æ³•éœ€è¦IAMèº«ä»½éªŒè¯æ‰èƒ½è°ƒç”¨ã€‚

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

è®¾ç½®æ­¤é¡¹åï¼Œå¦‚æœæ‚¨å°è¯•åœ¨æ²¡æœ‰ä»»ä½•æˆæƒçš„æƒ…å†µä¸‹è®¿é—®ç«¯ç‚¹ï¼Œå°†æ”¶åˆ°é”™è¯¯`{"message":"Missing Authentication Token"}`ã€‚

åœ¨**Postman**ä¸­ä½¿ç”¨**`Authorization`** ç±»å‹ **`AWS Signature`** æ˜¯ç”Ÿæˆåº”ç”¨ç¨‹åºæœŸæœ›çš„ä»¤ç‰Œçš„ä¸€ç§ç®€å•æ–¹æ³•ã€‚

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

è®¾ç½®æ‚¨æƒ³è¦ä½¿ç”¨çš„è´¦æˆ·çš„accessKeyå’ŒSecretKeyï¼Œç°åœ¨æ‚¨å¯ä»¥å¯¹APIç«¯ç‚¹è¿›è¡Œèº«ä»½éªŒè¯äº†ã€‚

å®ƒå°†ç”Ÿæˆä¸€ä¸ª**Authorization** **header**ï¼Œå¦‚ï¼š
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
è¯·æ³¨æ„ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œ**Authorizer** å¯èƒ½ç¼–ç ä¸ä½³ï¼Œåªè¦åœ¨ **Authorization header** ä¸­å‘é€ **ä»»ä½•å†…å®¹** å°±ä¼š **å…è®¸æŸ¥çœ‹éšè—å†…å®¹**ã€‚

### è‡ªå®šä¹‰ Lambda Authorizer

å¯ä»¥ä½¿ç”¨ä¸€ä¸ª lambdaï¼Œæ ¹æ®ç»™å®šçš„ä»¤ç‰Œï¼Œ**è¿”å›ä¸€ä¸ª IAM ç­–ç•¥**ï¼ŒæŒ‡ç¤ºç”¨æˆ·æ˜¯å¦ **æˆæƒè°ƒç”¨ API ç«¯ç‚¹**ã€‚\
æ‚¨å¯ä»¥è®¾ç½®å°†ä½¿ç”¨æˆæƒè€…çš„æ¯ä¸ªèµ„æºæ–¹æ³•ã€‚

<details>

<summary>Lambda Authorizer ä»£ç ç¤ºä¾‹</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹æ–¹å¼è°ƒç”¨ï¼š

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
æ ¹æ®Lambdaä»£ç ï¼Œè¿™ç§æˆæƒå¯èƒ½å­˜åœ¨æ¼æ´
{% endhint %}

æ³¨æ„ï¼Œå¦‚æœç”Ÿæˆå¹¶è¿”å›äº†**æ‹’ç»ç­–ç•¥**ï¼ŒAPI Gatewayè¿”å›çš„é”™è¯¯æ˜¯ï¼š`{"Message":"User is not authorized to access this resource with an explicit deny"}`

è¿™æ ·ä½ å¯ä»¥**è¯†åˆ«è¿™ç§æˆæƒ**æ˜¯å¦åˆ°ä½ã€‚

### éœ€è¦APIå¯†é’¥

å¯ä»¥è®¾ç½®APIç«¯ç‚¹ï¼Œ**éœ€è¦æœ‰æ•ˆçš„APIå¯†é’¥**æ‰èƒ½è”ç³»å®ƒã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥åœ¨API Gatewayé—¨æˆ·ä¸­ç”ŸæˆAPIå¯†é’¥ï¼Œç”šè‡³å¯ä»¥è®¾ç½®å…¶ä½¿ç”¨é‡ï¼ˆæŒ‰æ¯ç§’è¯·æ±‚æ¬¡æ•°å’Œæ¯æœˆè¯·æ±‚æ¬¡æ•°ï¼‰ã€‚

è¦ä½¿APIå¯†é’¥å·¥ä½œï¼Œä½ éœ€è¦å°†å…¶æ·»åŠ åˆ°**ä½¿ç”¨è®¡åˆ’**ä¸­ï¼Œè¿™ä¸ªä½¿ç”¨è®¡åˆ’å¿…é¡»æ·»åŠ åˆ°**APIé˜¶æ®µ**ï¼Œå¹¶ä¸”å…³è”çš„APIé˜¶æ®µéœ€è¦ä¸ºéœ€è¦APIå¯†é’¥çš„**ç«¯ç‚¹**é…ç½®**æ–¹æ³•é™æµ**ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## æœªç»è®¤è¯çš„è®¿é—®

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## æƒé™æå‡

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## åæœŸåˆ©ç”¨

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>
