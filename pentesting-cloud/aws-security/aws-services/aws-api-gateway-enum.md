# AWS - API Gateway æšä¸¾

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## API Gateway

### åŸºæœ¬ä¿¡æ¯

AWS API Gateway æ˜¯ç”±äºšé©¬é€Šç½‘ç»œæœåŠ¡ï¼ˆAWSï¼‰æä¾›çš„å…¨æ‰˜ç®¡æœåŠ¡ï¼Œå…è®¸æ‚¨ä»¥ä»»ä½•è§„æ¨¡åˆ›å»ºã€å‘å¸ƒã€ç»´æŠ¤ã€ç›‘æ§å’Œä¿æŠ¤ **APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰**ã€‚API Gateway å……å½“åº”ç”¨ç¨‹åºè®¿é—®åç«¯æœåŠ¡ï¼ˆå¦‚è¿è¡Œåœ¨ Amazon Elastic Compute Cloudï¼ˆ**EC2**ï¼‰ã€AWS **Lambda** æˆ–ä»»ä½• **Web åº”ç”¨ç¨‹åº**ä¸Šçš„å·¥ä½œè´Ÿè½½ï¼‰çš„ **"å‰é—¨"**ã€‚

API Gateway å¯ä»¥å®šä¹‰ **å¦‚ä½•å¤„ç†å¯¹ API çš„è¯·æ±‚**ï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºå…·æœ‰ç‰¹å®šæ–¹æ³•ï¼ˆä¾‹å¦‚ GETã€POSTã€PUTã€DELETEï¼‰å’Œèµ„æºçš„è‡ªå®šä¹‰ API ç«¯ç‚¹ã€‚å®ƒè¿˜å¯ä»¥ç”Ÿæˆå®¢æˆ·ç«¯ SDKï¼ˆè½¯ä»¶å¼€å‘å·¥å…·åŒ…ï¼‰ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜å¯ä»¥æ›´è½»æ¾åœ°ä»å…¶åº”ç”¨ç¨‹åºè°ƒç”¨æ‚¨çš„ APIã€‚

### API Gateway ç±»å‹

* **HTTP API**ï¼šä½¿ç”¨å†…ç½®åŠŸèƒ½ï¼ˆå¦‚ OIDC å’Œ OAuth2ï¼‰å’Œæœ¬åœ° CORS æ”¯æŒæ„å»ºä½å»¶è¿Ÿå’Œæˆæœ¬æ•ˆç›Šçš„ REST APIã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambdaã€HTTP åç«¯ã€‚
* **WebSocket API**ï¼šä½¿ç”¨æŒä¹…è¿æ¥æ„å»º WebSocket APIï¼Œç”¨äºå®æ—¶ä½¿ç”¨æ¡ˆä¾‹ï¼Œå¦‚èŠå¤©åº”ç”¨ç¨‹åºæˆ–ä»ªè¡¨æ¿ã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambdaã€HTTPã€AWS æœåŠ¡ã€‚
* **REST API**ï¼šå¼€å‘ REST APIï¼Œå¯ä»¥å®Œå…¨æ§åˆ¶è¯·æ±‚å’Œå“åº”ï¼Œä»¥åŠ API ç®¡ç†åŠŸèƒ½ã€‚é€‚ç”¨äºä»¥ä¸‹å†…å®¹ï¼šLambdaã€HTTPã€AWS æœåŠ¡ã€‚
* **REST API Private**ï¼šåˆ›å»ºä»…å¯ä» VPC å†…éƒ¨è®¿é—®çš„ REST APIã€‚

### API Gateway ä¸»è¦ç»„ä»¶

1. **èµ„æº**ï¼šåœ¨ API Gateway ä¸­ï¼Œèµ„æºæ˜¯æ„æˆ API ç»“æ„çš„ç»„ä»¶ã€‚å®ƒä»¬ä»£è¡¨ API çš„ä¸åŒè·¯å¾„æˆ–ç«¯ç‚¹ï¼Œå¹¶å¯¹åº”äº API æ”¯æŒçš„å„ç§æ“ä½œã€‚èµ„æºæ˜¯æ¯ä¸ªè·¯å¾„ï¼ˆ/ã€/users æˆ– /user/{id}ï¼‰ä¸­çš„æ¯ä¸ªæ–¹æ³•ï¼ˆä¾‹å¦‚ GETã€POSTã€PUTã€DELETEï¼‰ã€‚
2. **é˜¶æ®µ**ï¼šAPI Gateway ä¸­çš„é˜¶æ®µè¡¨ç¤º API çš„ä¸åŒç‰ˆæœ¬æˆ–ç¯å¢ƒï¼Œä¾‹å¦‚å¼€å‘ã€æš‚å­˜æˆ–ç”Ÿäº§ã€‚æ‚¨å¯ä»¥ä½¿ç”¨é˜¶æ®µæ¥ç®¡ç†å’Œéƒ¨ç½² **å¤šä¸ªç‰ˆæœ¬çš„ API**ï¼Œä»è€Œå¯ä»¥åœ¨ä¸å½±å“ç”Ÿäº§ç¯å¢ƒçš„æƒ…å†µä¸‹æµ‹è¯•æ–°åŠŸèƒ½æˆ–é”™è¯¯ä¿®å¤ã€‚é˜¶æ®µè¿˜æ”¯æŒ **é˜¶æ®µå˜é‡**ï¼Œå®ƒä»¬æ˜¯å¯ä»¥ç”¨äºæ ¹æ®å½“å‰é˜¶æ®µé…ç½® API è¡Œä¸ºçš„é”®å€¼å¯¹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é˜¶æ®µå˜é‡æ ¹æ®é˜¶æ®µå°† API è¯·æ±‚å®šå‘åˆ°ä¸åŒçš„ Lambda å‡½æ•°æˆ–å…¶ä»–åç«¯æœåŠ¡ã€‚
* é˜¶æ®µåœ¨ API Gateway ç«¯ç‚¹çš„ URL å¼€å¤´æŒ‡ç¤ºã€‚
3. **æˆæƒè€…**ï¼šAPI Gateway ä¸­çš„æˆæƒè€…è´Ÿè´£é€šè¿‡éªŒè¯è°ƒç”¨è€…çš„èº«ä»½æ¥æ§åˆ¶å¯¹ API çš„è®¿é—®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ **AWS Lambda å‡½æ•°**ä½œä¸ºè‡ªå®šä¹‰æˆæƒè€…ï¼Œä»è€Œå¯ä»¥å®ç°è‡ªå·±çš„èº«ä»½éªŒè¯å’Œæˆæƒé€»è¾‘ã€‚å½“è¯·æ±‚è¿›å…¥æ—¶ï¼ŒAPI Gateway å°†è¯·æ±‚çš„æˆæƒä»¤ç‰Œä¼ é€’ç»™ Lambda æˆæƒè€…ï¼Œåè€…å¤„ç†ä»¤ç‰Œå¹¶è¿”å›ç¡®å®šè°ƒç”¨è€…å…è®¸æ‰§è¡Œçš„æ“ä½œçš„ IAM ç­–ç•¥ã€‚API Gateway è¿˜æ”¯æŒ **å†…ç½®æˆæƒè€…**ï¼Œä¾‹å¦‚ **AWS Identity and Access Managementï¼ˆIAMï¼‰** å’Œ **Amazon Cognito**ã€‚
4. **èµ„æºç­–ç•¥**ï¼šAPI Gateway ä¸­çš„èµ„æºç­–ç•¥æ˜¯ä¸€ä¸ª JSON æ–‡æ¡£ï¼Œç”¨äº **å®šä¹‰è®¿é—® API çš„æƒé™**ã€‚å®ƒç±»ä¼¼äº IAM ç­–ç•¥ï¼Œä½†ä¸“é—¨é’ˆå¯¹ API Gateway è¿›è¡Œäº†è°ƒæ•´ã€‚æ‚¨å¯ä»¥ä½¿ç”¨èµ„æºç­–ç•¥æ¥æ§åˆ¶è°å¯ä»¥è®¿é—®æ‚¨çš„ APIï¼Œä»–ä»¬å¯ä»¥è°ƒç”¨å“ªäº›æ–¹æ³•ï¼Œä»¥åŠä»–ä»¬å¯ä»¥è¿æ¥åˆ°å“ªäº› IP åœ°å€æˆ– VPCã€‚**èµ„æºç­–ç•¥å¯ä»¥ä¸æˆæƒè€…ç»“åˆä½¿ç”¨**ï¼Œä¸ºæ‚¨çš„ API æä¾›ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ã€‚
* åœ¨ä¿®æ”¹èµ„æºç­–ç•¥åï¼Œéœ€è¦é‡æ–°éƒ¨ç½² API æ‰èƒ½ç”Ÿæ•ˆã€‚

### æ—¥å¿—è®°å½•

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**CloudWatch Logs** å¤„äºå…³é—­çŠ¶æ€ï¼Œ**è®¿é—®æ—¥å¿—è®°å½•** å¤„äºå…³é—­çŠ¶æ€ï¼Œ**X-Ray è¿½è¸ª** ä¹Ÿå¤„äºå…³é—­çŠ¶æ€ã€‚

### æšä¸¾
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws --profile myadmin --region eu-west-1 apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
## è®¿é—®API Gatewayç«¯ç‚¹çš„ä¸åŒæˆæƒæ–¹å¼

### èµ„æºç­–ç•¥

å¯ä»¥ä½¿ç”¨èµ„æºç­–ç•¥æ¥å®šä¹‰è°å¯ä»¥è°ƒç”¨APIç«¯ç‚¹ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°**æŒ‡å®šçš„IPæ— æ³•é€šè¿‡GETè°ƒç”¨**ç«¯ç‚¹`/resource_policy`ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAMæˆæƒè€…

å¯ä»¥è®¾ç½®è·¯å¾„ï¼ˆèµ„æºï¼‰å†…çš„æ–¹æ³•éœ€è¦IAMèº«ä»½éªŒè¯æ‰èƒ½è°ƒç”¨ã€‚

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

å½“è®¾ç½®äº†è¿™ä¸ªé€‰é¡¹åï¼Œå¦‚æœæ‚¨å°è¯•åœ¨æ²¡æœ‰ä»»ä½•æˆæƒçš„æƒ…å†µä¸‹è®¿é—®ç«¯ç‚¹ï¼Œæ‚¨å°†æ”¶åˆ°é”™è¯¯æ¶ˆæ¯`{"message":"Missing Authentication Token"}`ã€‚

ç”Ÿæˆåº”ç”¨ç¨‹åºæ‰€æœŸæœ›çš„ä»¤ç‰Œçš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯åœ¨**Postman**ä¸­ä½¿ç”¨**`Authorization`**ç±»å‹**`AWS Signature`**ã€‚

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

è®¾ç½®è¦ä½¿ç”¨çš„å¸æˆ·çš„accessKeyå’ŒSecretKeyï¼Œç„¶åæ‚¨å°±å¯ä»¥å¯¹APIç«¯ç‚¹è¿›è¡Œèº«ä»½éªŒè¯ã€‚

å®ƒå°†ç”Ÿæˆä¸€ä¸ªåä¸º**Authorization**çš„**header**ï¼Œä¾‹å¦‚ï¼š
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
è¯·æ³¨æ„ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œ**æˆæƒè€…ï¼ˆAuthorizerï¼‰**å¯èƒ½å·²ç»**ç¼–ç ä¸å½“**ï¼Œåªè¦åœ¨**æˆæƒå¤´ï¼ˆAuthorization headerï¼‰**ä¸­å‘é€**ä»»ä½•å†…å®¹**ï¼Œå°±å¯ä»¥**æŸ¥çœ‹éšè—çš„å†…å®¹**ã€‚

### è‡ªå®šä¹‰ Lambda æˆæƒè€…ï¼ˆAuthorizerï¼‰

å¯ä»¥ä½¿ç”¨åŸºäºç»™å®šä»¤ç‰Œçš„ Lambda å‡½æ•°ï¼Œæ ¹æ®ä»¤ç‰Œ**è¿”å›ä¸€ä¸ª IAM ç­–ç•¥**ï¼ŒæŒ‡ç¤ºç”¨æˆ·æ˜¯å¦**æœ‰æƒè°ƒç”¨ API ç«¯ç‚¹**ã€‚\
æ‚¨å¯ä»¥è®¾ç½®å°†ä½¿ç”¨æˆæƒè€…çš„æ¯ä¸ªèµ„æºæ–¹æ³•ã€‚

<details>

<summary>Lambda æˆæƒè€…ä»£ç ç¤ºä¾‹</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹å‘½ä»¤è°ƒç”¨ï¼š

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
æ ¹æ®Lambdaä»£ç çš„ä¸åŒï¼Œæ­¤æˆæƒå¯èƒ½å­˜åœ¨æ¼æ´
{% endhint %}

è¯·æ³¨æ„ï¼Œå¦‚æœç”Ÿæˆå¹¶è¿”å›äº†**æ‹’ç»ç­–ç•¥**ï¼ŒAPI Gatewayè¿”å›çš„é”™è¯¯æ˜¯ï¼š`{"Message":"User is not authorized to access this resource with an explicit deny"}`

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥**è¯†åˆ«æ­¤æˆæƒ**æ˜¯å¦å·²ç»ç”Ÿæ•ˆã€‚

### éœ€è¦ API å¯†é’¥

å¯ä»¥è®¾ç½®éœ€è¦**æœ‰æ•ˆ API å¯†é’¥**æ‰èƒ½è®¿é—®çš„ API ç«¯ç‚¹ã€‚

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

å¯ä»¥åœ¨ API Gateway é—¨æˆ·ä¸­ç”Ÿæˆ API å¯†é’¥ï¼Œç”šè‡³å¯ä»¥è®¾ç½®å…¶ä½¿ç”¨é‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°å’Œæ¯æœˆè¯·æ±‚æ•°ï¼‰ã€‚

è¦ä½¿ API å¯†é’¥èµ·ä½œç”¨ï¼Œæ‚¨éœ€è¦å°†å…¶æ·»åŠ åˆ°**ä½¿ç”¨è®¡åˆ’**ä¸­ï¼Œæ­¤ä½¿ç”¨è®¡åˆ’å¿…é¡»æ·»åŠ åˆ°**API é˜¶æ®µ**ä¸­ï¼Œå¹¶ä¸”ç›¸å…³è”çš„ API é˜¶æ®µéœ€è¦ä¸ºéœ€è¦ API å¯†é’¥çš„**ç«¯ç‚¹**é…ç½®**æ–¹æ³•é™åˆ¶**ï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

## æœªç»èº«ä»½éªŒè¯çš„è®¿é—®

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## ææƒ

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## åæ¸—é€

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…åŒ–

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
