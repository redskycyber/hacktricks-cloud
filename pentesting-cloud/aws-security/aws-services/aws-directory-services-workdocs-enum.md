# AWS - Services de r√©pertoire / Enum√©ration WorkDocs

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Services de r√©pertoire

Le service AWS Directory pour Microsoft Active Directory est un service g√©r√© qui facilite la **configuration, l'exploitation et la mise √† l'√©chelle d'un r√©pertoire** dans le cloud AWS. Il est bas√© sur **Microsoft Active Directory** r√©el et s'int√®gre √©troitement avec d'autres services AWS, facilitant la gestion de vos charges de travail sensibles au r√©pertoire et des ressources AWS. Avec AWS Managed Microsoft AD, vous pouvez **utiliser vos utilisateurs, groupes et strat√©gies Active Directory existants** pour g√©rer l'acc√®s √† vos ressources AWS. Cela peut aider √† simplifier votre gestion des identit√©s et √† r√©duire le besoin de solutions d'identit√© suppl√©mentaires. AWS Managed Microsoft AD fournit √©galement des sauvegardes automatiques et des capacit√©s de reprise apr√®s sinistre, contribuant √† garantir la disponibilit√© et la durabilit√© de votre r√©pertoire. Dans l'ensemble, le service AWS Directory pour Microsoft Active Directory peut vous aider √† gagner du temps et des ressources en fournissant un service Active Directory g√©r√©, hautement disponible et √©volutif dans le cloud AWS.

### Options

Les Services de r√©pertoire permettent de cr√©er 5 types de r√©pertoires :

* **AWS Managed Microsoft AD** : Qui ex√©cutera un nouveau **Microsoft AD dans AWS**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **Simple AD** : Qui sera un serveur Active Directory compatible avec **Linux-Samba**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **AD Connector** : Un proxy pour **rediriger les demandes de r√©pertoire vers votre Active Directory Microsoft existant** sans mettre en cache d'informations dans le cloud. Il √©coutera dans un **VPC** et vous devrez fournir des **informations d'identification pour acc√©der √† l'AD existant**.
* **Pools d'utilisateurs Amazon Cognito** : Il s'agit de la m√™me chose que les Pools d'utilisateurs Cognito.
* **Cloud Directory** : C'est le **plus simple**. Un r√©pertoire **sans serveur** o√π vous indiquez le **sch√©ma** √† utiliser et √™tes **factur√© en fonction de l'utilisation**.

Les services de r√©pertoire AWS permettent de **synchroniser** avec votre **AD Microsoft sur site** existant, **d'ex√©cuter le v√¥tre** dans AWS ou de synchroniser avec **d'autres types de r√©pertoires**.

### Laboratoire

Vous trouverez ici un tutoriel pour cr√©er votre propre Microsoft AD dans AWS : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### √ânum√©ration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Connexion

Notez que si la **description** du r√©pertoire contient un **domaine** dans le champ **`AccessUrl`**, c'est parce qu'un **utilisateur** peut probablement **se connecter** avec ses **identifiants AD** √† certains **services AWS :**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### √âl√©vation de privil√®ges

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistance

### Utilisation d'un utilisateur AD

Un **utilisateur AD** peut se voir accorder **l'acc√®s √† la console de gestion AWS** via un r√¥le √† assumer. Le **nom d'utilisateur par d√©faut est Admin** et il est possible de **changer son mot de passe** depuis la console AWS.

Par cons√©quent, il est possible de **changer le mot de passe d'Admin**, **cr√©er un nouvel utilisateur** ou **changer le mot de passe** d'un utilisateur et accorder √† cet utilisateur un r√¥le pour maintenir l'acc√®s.\
Il est √©galement possible d'**ajouter un utilisateur √† un groupe dans AD** et de **donner √† ce groupe AD l'acc√®s √† un r√¥le** (pour rendre cette persistance plus discr√®te).

### Partage AD (de la victime √† l'attaquant)

Il est possible de partager un environnement AD de la victime √† l'attaquant. De cette mani√®re, l'attaquant pourra continuer √† acc√©der √† l'environnement AD.\
Cependant, cela implique de partager l'AD g√©r√© et de cr√©er une connexion VPC peering.

Vous pouvez trouver un guide ici : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Partage AD (de l'attaquant √† la victime)~~

Il ne semble pas possible d'accorder l'acc√®s AWS √† des utilisateurs d'un environnement AD diff√©rent √† un compte AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs est un service de **stockage et de partage de fichiers** bas√© sur le cloud. Il fait partie de la suite de services de cloud computing AWS et est con√ßu pour fournir une solution s√©curis√©e et √©volutive aux organisations pour stocker, partager et collaborer sur des fichiers et des documents.

AWS WorkDocs fournit une interface bas√©e sur le web pour que les utilisateurs puissent t√©l√©charger, acc√©der et g√©rer leurs fichiers et documents. Il offre √©galement des fonctionnalit√©s telles que le contr√¥le des versions, la collaboration en temps r√©el et l'int√©gration avec d'autres services AWS et des outils tiers.

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### √âl√©vation de privil√®ges

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
