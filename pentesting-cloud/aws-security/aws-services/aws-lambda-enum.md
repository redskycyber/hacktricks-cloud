# AWS - Lambda æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Lambda

Amazon Web Services (AWS) Lambda è¢«æè¿°ä¸ºä¸€ç§**è®¡ç®—æœåŠ¡**ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ— éœ€æœåŠ¡å™¨é…ç½®æˆ–ç®¡ç†çš„æƒ…å†µä¸‹æ‰§è¡Œä»£ç ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿ**è‡ªåŠ¨å¤„ç†æ‰§è¡Œä»£ç æ‰€éœ€çš„èµ„æºåˆ†é…**ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§ã€å¯æ‰©å±•æ€§å’Œå®‰å…¨æ€§ã€‚Lambdaçš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å…¶å®šä»·æ¨¡å‹ï¼Œå…¶ä¸­**è´¹ç”¨ä»…åŸºäºä½¿ç”¨çš„è®¡ç®—æ—¶é—´**ï¼Œæ— éœ€åˆå§‹æŠ•èµ„æˆ–é•¿æœŸæ‰¿è¯ºã€‚

è¦è°ƒç”¨lambdaï¼Œå¯ä»¥é€šè¿‡Cloudwatch**é¢‘ç¹åœ°è°ƒç”¨**ï¼Œ**æš´éœ²**ä¸€ä¸ª**URL**ç«¯ç‚¹å¹¶è°ƒç”¨å®ƒï¼Œé€šè¿‡**API Gateway**è°ƒç”¨å®ƒï¼Œç”šè‡³å¯ä»¥åŸºäº**äº‹ä»¶**è°ƒç”¨ï¼Œä¾‹å¦‚**S3**å­˜å‚¨æ¡¶ä¸­æ•°æ®çš„**å˜åŒ–**æˆ–**DynamoDB**è¡¨çš„æ›´æ–°ã€‚

Lambdaçš„**ä»£ç **å­˜å‚¨åœ¨**`/var/task`**ä¸­ã€‚

### Lambda åˆ«åæƒé‡

ä¸€ä¸ªLambdaå¯ä»¥æœ‰**å¤šä¸ªç‰ˆæœ¬**ã€‚\
å¹¶ä¸”å¯ä»¥é€šè¿‡**åˆ«å**æš´éœ²**å¤šäº1ä¸ª**ç‰ˆæœ¬ã€‚åœ¨åˆ«åä¸­æš´éœ²çš„**æ¯ä¸ª**ç‰ˆæœ¬çš„**æƒé‡**å°†å†³å®š**å“ªä¸ªåˆ«åæ¥æ”¶è°ƒç”¨**ï¼ˆä¾‹å¦‚å¯ä»¥æ˜¯90%-10%ï¼‰ã€‚\
å¦‚æœ**å…¶ä¸­ä¸€ä¸ª**åˆ«åçš„ä»£ç æ˜¯**æ˜“å—æ”»å‡»çš„**ï¼Œä½ å¯ä»¥å‘é€**è¯·æ±‚ç›´åˆ°æ˜“å—æ”»å‡»çš„**ç‰ˆæœ¬æ¥æ”¶åˆ°æ¼æ´åˆ©ç”¨ã€‚

![](<../../../.gitbook/assets/image (16) (1).png>)

### èµ„æºç­–ç•¥

Lambdaèµ„æºç­–ç•¥å…è®¸**ç»™å…¶ä»–æœåŠ¡/è´¦æˆ·è®¿é—®æƒé™ä»¥è°ƒç”¨**lambdaã€‚\
ä¾‹å¦‚ï¼Œè¿™æ˜¯å…è®¸**ä»»ä½•äººè®¿é—®é€šè¿‡URLæš´éœ²çš„lambda**çš„ç­–ç•¥ï¼š

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

æˆ–è€…è¿™ä¸ªå…è®¸API Gatewayè°ƒç”¨å®ƒï¼š

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda æ•°æ®åº“ä»£ç†

å½“æœ‰**æ•°ç™¾ä¸ª**å¹¶å‘çš„lambdaè¯·æ±‚æ—¶ï¼Œå¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦**è¿æ¥å’Œå…³é—­æ•°æ®åº“è¿æ¥**ï¼Œè¿™æ˜¯è¡Œä¸é€šçš„ï¼ˆlambdasæ˜¯æ— çŠ¶æ€çš„ï¼Œä¸èƒ½ä¿æŒè¿æ¥æ‰“å¼€ï¼‰ã€‚\
é‚£ä¹ˆï¼Œå¦‚æœä½ çš„**Lambdaå‡½æ•°ä¸RDSä»£ç†äº¤äº’**è€Œä¸æ˜¯ä½ çš„æ•°æ®åº“å®ä¾‹ã€‚å®ƒå¤„ç†äº†ç”±å¹¶å‘Lambdaå‡½æ•°åˆ›å»ºçš„è®¸å¤šåŒæ—¶è¿æ¥æ‰€éœ€çš„è¿æ¥æ± ã€‚è¿™å…è®¸æ‚¨çš„Lambdaåº”ç”¨ç¨‹åº**é‡ç”¨ç°æœ‰è¿æ¥**ï¼Œè€Œä¸æ˜¯ä¸ºæ¯æ¬¡å‡½æ•°è°ƒç”¨åˆ›å»ºæ–°è¿æ¥ã€‚

### Lambda EFS æ–‡ä»¶ç³»ç»Ÿ

ä¸ºäº†ä¿å­˜ç”šè‡³å…±äº«æ•°æ®ï¼Œ**Lambdaså¯ä»¥è®¿é—®EFSå¹¶æŒ‚è½½å®ƒä»¬**ï¼Œæ‰€ä»¥Lambdaå°†èƒ½å¤Ÿä»ä¸­è¯»å–å’Œå†™å…¥ã€‚

### Lambda å±‚

Lambda _å±‚_ æ˜¯ä¸€ä¸ª.zipæ–‡ä»¶å­˜æ¡£ï¼Œ**å¯ä»¥åŒ…å«é¢å¤–çš„ä»£ç **æˆ–å…¶ä»–å†…å®¹ã€‚å±‚å¯ä»¥åŒ…å«åº“ã€[è‡ªå®šä¹‰è¿è¡Œæ—¶](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)ã€æ•°æ®æˆ–é…ç½®æ–‡ä»¶ã€‚

æ¯ä¸ªå‡½æ•°æœ€å¤šå¯ä»¥åŒ…å«**äº”ä¸ªå±‚**ã€‚å½“ä½ åœ¨å‡½æ•°ä¸­åŒ…å«ä¸€ä¸ªå±‚æ—¶ï¼Œ**å†…å®¹ä¼šè¢«æå–åˆ°æ‰§è¡Œç¯å¢ƒä¸­çš„`/opt`ç›®å½•**ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ åˆ›å»ºçš„**å±‚**å¯¹ä½ çš„AWSè´¦æˆ·æ˜¯**ç§æœ‰çš„**ã€‚ä½ å¯ä»¥é€‰æ‹©**å…±äº«**ä¸€ä¸ªå±‚ç»™å…¶ä»–è´¦æˆ·ï¼Œæˆ–è€…**ä½¿**å±‚**å…¬å¼€**ã€‚å¦‚æœä½ çš„å‡½æ•°ä½¿ç”¨äº†ä¸åŒè´¦æˆ·å‘å¸ƒçš„å±‚ï¼Œå³ä½¿è¯¥å±‚ç‰ˆæœ¬å·²è¢«åˆ é™¤ï¼Œæˆ–è€…ä½ è®¿é—®è¯¥å±‚çš„æƒé™è¢«æ’¤é”€ï¼Œä½ çš„å‡½æ•°ä¹Ÿå¯ä»¥**ç»§ç»­ä½¿ç”¨è¯¥å±‚ç‰ˆæœ¬**ã€‚ç„¶è€Œï¼Œä½ ä¸èƒ½ä½¿ç”¨å·²åˆ é™¤çš„å±‚ç‰ˆæœ¬åˆ›å»ºæ–°å‡½æ•°æˆ–æ›´æ–°å‡½æ•°ã€‚

ä½œä¸ºå®¹å™¨æ˜ åƒéƒ¨ç½²çš„å‡½æ•°ä¸ä½¿ç”¨å±‚ã€‚ç›¸åï¼Œå½“ä½ æ„å»ºæ˜ åƒæ—¶ï¼Œä½ ä¼šå°†é¦–é€‰çš„è¿è¡Œæ—¶ã€åº“å’Œå…¶ä»–ä¾èµ–é¡¹æ‰“åŒ…åˆ°å®¹å™¨æ˜ åƒä¸­ã€‚

### Lambda æ‰©å±•

Lambdaæ‰©å±•é€šè¿‡ä¸å„ç§**ç›‘æ§ã€å¯è§‚å¯Ÿæ€§ã€å®‰å…¨å’Œæ²»ç†å·¥å…·**é›†æˆæ¥å¢å¼ºå‡½æ•°ã€‚è¿™äº›æ‰©å±•å¯ä»¥é€šè¿‡ä½¿ç”¨Lambdaå±‚çš„[.zipå­˜æ¡£](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)æ·»åŠ ï¼Œæˆ–åŒ…å«åœ¨[å®¹å™¨æ˜ åƒéƒ¨ç½²](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)ä¸­ï¼Œä»¥ä¸¤ç§æ¨¡å¼è¿è¡Œï¼š**å†…éƒ¨**å’Œ**å¤–éƒ¨**ã€‚

* **å†…éƒ¨æ‰©å±•**ä¸è¿è¡Œæ—¶è¿›ç¨‹åˆå¹¶ï¼Œä½¿ç”¨**ç‰¹å®šäºè¯­è¨€çš„ç¯å¢ƒå˜é‡**å’Œ**åŒ…è£…è„šæœ¬**æ“çºµå…¶å¯åŠ¨ã€‚è¿™ç§è‡ªå®šä¹‰é€‚ç”¨äºåŒ…æ‹¬**Java Correto 8å’Œ11, Node.js 10å’Œ12, å’Œ .NET Core 3.1**åœ¨å†…çš„å¤šç§è¿è¡Œæ—¶ã€‚

* **å¤–éƒ¨æ‰©å±•**ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œï¼Œä¸Lambdaå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒæ“ä½œä¸€è‡´ã€‚å®ƒä»¬ä¸å„ç§è¿è¡Œæ—¶å…¼å®¹ï¼Œå¦‚**Node.js 10å’Œ12, Python 3.7å’Œ3.8, Ruby 2.5å’Œ2.7, Java Corretto 8å’Œ11, .NET Core 3.1**ï¼Œä»¥åŠ**è‡ªå®šä¹‰è¿è¡Œæ—¶**ã€‚

### æšä¸¾
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### è°ƒç”¨ Lambda

#### æ‰‹åŠ¨
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### é€šè¿‡æš´éœ²çš„URL
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### é€šè¿‡ URL è°ƒç”¨ Lambda å‡½æ•°

ç°åœ¨æ˜¯æ—¶å€™æ‰¾å‡ºå¯èƒ½æ‰§è¡Œçš„ lambda å‡½æ•°äº†ï¼š
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

ä¸€ä¸ªåä¸º "Level6" çš„ lambda å‡½æ•°å¯ç”¨ã€‚è®©æˆ‘ä»¬æ‰¾å‡ºå¦‚ä½•è°ƒç”¨å®ƒï¼š
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

ç°åœ¨ï¼Œæ‚¨çŸ¥é“äº†åç§°å’ŒIDï¼Œæ‚¨å¯ä»¥è·å–åç§°ï¼š
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
```markdown
![](<../../../.gitbook/assets/image (20).png>)

æœ€åè°ƒç”¨å‡½æ•°è®¿é—®ï¼ˆæ³¨æ„ IDã€Name å’Œ function-name å‡ºç°åœ¨ URL ä¸­ï¼‰ï¼š[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### å…¶ä»–è§¦å‘å™¨

è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ¥æºå¯ä»¥è§¦å‘ lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### æƒé™æå‡

åœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å¦‚ä½•**æ»¥ç”¨ Lambda æƒé™æ¥æå‡æƒé™**ï¼š

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### æœªç»è®¤è¯çš„è®¿é—®

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### åæœŸåˆ©ç”¨

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF** ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
```
