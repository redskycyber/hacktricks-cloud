# AWS - Enumeraci贸n de Lambda

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Lambda

Amazon Web Services (AWS) Lambda es un servicio de c贸mputo que te permite **ejecutar c贸digo sin aprovisionar ni administrar servidores**. Lambda **administra autom谩ticamente los recursos necesarios** para ejecutar tu c贸digo y proporciona funciones de alta disponibilidad, escalabilidad y seguridad. Con Lambda, **solo pagas por el tiempo de c贸mputo que consumes**, y no hay costos iniciales ni compromisos a largo plazo.

Para llamar a una lambda, es posible llamarla tan **frecuentemente como desees** (con Cloudwatch), **exponer** un **punto de conexi贸n de URL** y llamarla, llamarla a trav茅s de **API Gateway** o incluso basado en **eventos** como **cambios** en los datos de un cubo **S3** o actualizaciones en una tabla **DynamoDB**.

El **c贸digo** de una lambda se almacena en **`/var/task`**.

### Pesos de Alias de Lambda

Una Lambda puede tener **varias versiones**.\
Y puede tener **m谩s de 1** versi贸n expuesta a trav茅s de **alias**. Los **pesos** de **cada una** de las **versiones** expuestas dentro de un alias decidir谩n **qu茅 alias recibe la invocaci贸n** (puede ser 90%-10% por ejemplo).\
Si el c贸digo de **uno** de los alias es **vulnerable**, puedes enviar **solicitudes hasta que la versi贸n vulnerable** reciba el exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Pol铆ticas de Recursos de Lambda

Las pol铆ticas de recursos de Lambda permiten **dar acceso a otros servicios/cuentas para invocar** la lambda, por ejemplo.\
Por ejemplo, esta es la pol铆tica para permitir que **cualquiera acceda a una lambda expuesta a trav茅s de una URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

O esto para permitir que un API Gateway lo invoque:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxies de Base de Datos de Lambda

Cuando hay **cientos** de **solicitudes concurrentes de lambda**, si cada una de ellas necesita **conectarse y cerrar una conexi贸n a una base de datos**, simplemente no funcionar谩 (las lambdas no tienen estado, no pueden mantener conexiones abiertas).\
Entonces, si tus **funciones Lambda interact煤an con RDS Proxy en lugar** de tu instancia de base de datos, se encarga del agrupamiento de conexiones necesario para escalar muchas conexiones simult谩neas creadas por funciones Lambda concurrentes. Esto permite que tus aplicaciones Lambda **reutilicen conexiones existentes**, en lugar de crear nuevas conexiones para cada invocaci贸n de funci贸n.

### Sistemas de Archivos EFS de Lambda

Para preservar e incluso compartir datos, **las Lambdas pueden acceder a EFS y montarlos**, de modo que Lambda pueda leer y escribir en ellos.

### Capas de Lambda

Una _capa_ de Lambda es un archivo .zip que **puede contener c贸digo adicional** u otro contenido. Una capa puede contener bibliotecas, un [tiempo de ejecuci贸n personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), datos o archivos de configuraci贸n.

Es posible incluir hasta **cinco capas por funci贸n**. Cuando incluyes una capa en una funci贸n, los **contenidos se extraen al directorio `/opt`** en el entorno de ejecuci贸n.

Por **defecto**, las **capas** que creas son **privadas** para tu cuenta de AWS. Puedes elegir **compartir** una capa con otras cuentas o **hacer** la capa **p煤blica**. Si tus funciones consumen una capa que public贸 una cuenta diferente, tus funciones pueden **seguir utilizando la versi贸n de la capa despu茅s de que se haya eliminado, o despu茅s de que se haya revocado tu permiso para acceder a la capa**. Sin embargo, no puedes crear una nueva funci贸n ni actualizar funciones utilizando una versi贸n de capa eliminada.

Las funciones implementadas como una imagen de contenedor no utilizan capas. En su lugar, empaquetas tu tiempo de ejecuci贸n preferido, bibliotecas y otras dependencias en la imagen del contenedor cuando construyes la imagen.

### Extensiones de Lambda

Las extensiones de Lambda te permiten mejorar tus funciones. Por ejemplo, puedes usar extensiones para integrar tus funciones con tus herramientas de monitoreo, observabilidad, seguridad y gobierno preferidas. Puedes agregar extensiones a funciones de archivos .zip utilizando [capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), o incluirlas en la imagen para [funciones implementadas como im谩genes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* Las **extensiones internas** se ejecutan como **parte** del **proceso de tiempo de ejecuci贸n**, **en el proceso** con tu c贸digo. Te permiten modificar el **inicio del proceso de tiempo de ejecuci贸n** utilizando variables de entorno espec铆ficas del lenguaje y scripts de envoltura. Las extensiones internas permiten casos de uso como la instrumentaci贸n autom谩tica de c贸digo.
* Las **extensiones externas** te permiten **ejecutar procesos separados** del tiempo de ejecuci贸n pero a煤n dentro del **mismo entorno de ejecuci贸n** que la funci贸n Lambda. Las extensiones externas pueden **iniciarse antes del proceso de tiempo de ejecuci贸n** y pueden **continuar despu茅s de que el tiempo de ejecuci贸n** se apague. Las extensiones externas permiten casos de uso como obtener secretos antes de la invocaci贸n o enviar telemetr铆a a un destino personalizado fuera de la invocaci贸n de la funci贸n. Estas extensiones se ejecutan como procesos complementarios a las funciones Lambda.
### Enumeraci贸n

---

#### AWS Lambda

AWS Lambda es un servicio de computaci贸n sin servidor que permite ejecutar c贸digo sin aprovisionar ni administrar servidores. Es una excelente opci贸n para ejecutar c贸digo en respuesta a eventos, como cambios en los datos almacenados en Amazon S3, actualizaciones en una tabla de base de datos de Amazon DynamoDB o solicitudes HTTP enviadas a trav茅s de Amazon API Gateway.

Durante una evaluaci贸n de seguridad en la nube, es importante realizar una enumeraci贸n exhaustiva de los servicios de AWS Lambda para identificar posibles vulnerabilidades y puntos d茅biles en la configuraci贸n.

---

#### Enumerating AWS Lambda Functions

La enumeraci贸n de las funciones de AWS Lambda es un paso crucial en el proceso de evaluaci贸n de seguridad. Aqu铆 hay algunas t茅cnicas que se pueden utilizar para enumerar las funciones de AWS Lambda:

##### 1. Enumeraci贸n manual

La enumeraci贸n manual implica buscar manualmente las funciones de AWS Lambda en la consola de administraci贸n de AWS o utilizando la CLI de AWS. Esto puede ser 煤til para obtener una visi贸n general r谩pida de las funciones existentes.

##### 2. Enumeraci贸n de la API de AWS

La API de AWS proporciona m茅todos para enumerar las funciones de AWS Lambda. Estos m茅todos se pueden utilizar para automatizar la enumeraci贸n y obtener informaci贸n detallada sobre cada funci贸n, como su nombre, ARN, tiempo de ejecuci贸n, tama帽o de memoria y configuraci贸n de permisos.

##### 3. Enumeraci贸n de la consola de administraci贸n de AWS

La consola de administraci贸n de AWS proporciona una interfaz gr谩fica para enumerar y administrar las funciones de AWS Lambda. Puede ser 煤til explorar la consola de administraci贸n para descubrir funciones ocultas o configuraciones incorrectas.

##### 4. Enumeraci贸n de la CLI de AWS

La CLI de AWS ofrece comandos espec铆ficos para enumerar las funciones de AWS Lambda. Estos comandos se pueden utilizar para automatizar la enumeraci贸n y obtener informaci贸n detallada sobre cada funci贸n.

---

#### Enumerating AWS Lambda Event Sources

Adem谩s de enumerar las funciones de AWS Lambda, tambi茅n es importante enumerar las fuentes de eventos que desencadenan la ejecuci贸n de estas funciones. Aqu铆 hay algunas t茅cnicas que se pueden utilizar para enumerar las fuentes de eventos de AWS Lambda:

##### 1. Enumeraci贸n manual

Al igual que con la enumeraci贸n de las funciones de AWS Lambda, la enumeraci贸n manual puede ser 煤til para obtener una visi贸n general r谩pida de las fuentes de eventos existentes. Esto implica buscar manualmente en la consola de administraci贸n de AWS o utilizando la CLI de AWS.

##### 2. Enumeraci贸n de la API de AWS

La API de AWS proporciona m茅todos para enumerar las fuentes de eventos de AWS Lambda. Estos m茅todos se pueden utilizar para automatizar la enumeraci贸n y obtener informaci贸n detallada sobre cada fuente de eventos, como su tipo, configuraci贸n y estado.

##### 3. Enumeraci贸n de la consola de administraci贸n de AWS

La consola de administraci贸n de AWS tambi茅n proporciona una interfaz gr谩fica para enumerar y administrar las fuentes de eventos de AWS Lambda. Explorar la consola de administraci贸n puede revelar fuentes de eventos ocultas o configuraciones incorrectas.

##### 4. Enumeraci贸n de la CLI de AWS

Al igual que con la enumeraci贸n de las funciones de AWS Lambda, la CLI de AWS ofrece comandos espec铆ficos para enumerar las fuentes de eventos de AWS Lambda. Estos comandos se pueden utilizar para automatizar la enumeraci贸n y obtener informaci贸n detallada sobre cada fuente de eventos.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY" --query 'Code.Location' --profile uploadcreds
wget -O lambda-function.zip url-from-previous-query

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Invocar una lambda

#### Manual
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### A trav茅s de URL expuesta

Cuando se realiza una enumeraci贸n de AWS Lambda, una t茅cnica com煤n es buscar URL expuestas que puedan revelar informaci贸n sensible. Esto se debe a que las funciones de Lambda se pueden invocar a trav茅s de una URL 煤nica generada por AWS.

Para realizar esta enumeraci贸n, se pueden utilizar herramientas como `curl` o `wget` para enviar solicitudes HTTP GET a diferentes rutas de URL. Algunas rutas comunes a probar incluyen `/function-name`, `/function-name/index.handler` y `/function-name/index.js`.

Si se encuentra una URL expuesta, se puede obtener informaci贸n valiosa, como el c贸digo fuente de la funci贸n Lambda, los par谩metros de configuraci贸n y cualquier dato sensible que pueda estar presente en la funci贸n.

Es importante tener en cuenta que esta t茅cnica solo funciona si la funci贸n Lambda se ha configurado para ser accesible a trav茅s de una URL p煤blica. Por lo tanto, es recomendable revisar la configuraci贸n de seguridad de la funci贸n Lambda y asegurarse de que no se haya expuesto accidentalmente.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Llamar a una funci贸n Lambda a trav茅s de una URL

Ahora es el momento de descubrir las posibles funciones Lambda para ejecutar:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Una funci贸n lambda llamada "Level6" est谩 disponible. Vamos a averiguar c贸mo llamarla:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

Ahora que conoces el nombre y el ID, puedes obtener el Nombre:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

Y finalmente llama a la funci贸n accediendo (nota que el ID, Nombre y nombre de la funci贸n aparecen en la URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Otros Disparadores

Hay muchas otras fuentes que pueden activar una lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Escalada de Privilegios

En la siguiente p谩gina puedes verificar c贸mo **abusar de los permisos de Lambda para escalar privilegios**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acceso No Autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Explotaci贸n

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
