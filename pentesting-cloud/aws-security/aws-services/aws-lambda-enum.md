# AWS - Lambda Enum

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Lambda

Amazon Web Services (AWS) Lambda je opisan kao **ra캜unarska usluga** koja omogu캖ava izvr코avanje koda bez potrebe za pru쬬njem ili upravljanjem serverima. Karakteri코e je njena sposobnost da **automatski upravlja dodeljivanjem resursa** potrebnih za izvr코avanje koda, obezbe캠uju캖i funkcionalnosti kao 코to su visoka dostupnost, skalabilnost i bezbednost. Zna캜ajan aspekt Lambda-e je njen model naplate, gde se **naplata vr코i isklju캜ivo na osnovu vremena izvr코avanja ra캜unanja**, elimini코u캖i potrebu za po캜etnim investicijama ili dugoro캜nim obavezama.

Da biste pozvali lambda, mogu캖e je pozvati je **koliko god 캜esto 쬰lite** (pomo캖u Cloudwatch-a), **izlo쬴ti** URL **krajnju ta캜ku** i pozvati je, pozvati je putem **API Gateway-a** ili 캜ak na osnovu **dogadjaja** kao 코to su **promene** podataka u **S3** kanti ili a쬿riranja tabele **DynamoDB**.

**Kod** lambda-e se 캜uva u **`/var/task`**.

### Te쬴ne Lambda Alias-a

Lambda mo쬰 imati **vi코e verzija**.\
I mo쬰 imati **vi코e od 1** verzije izlo쬰ne putem **alias-a**. **Te쬴ne** svake od **verzija** izlo쬰ne unutar alias-a 캖e odlu캜iti **koji alias 캖e primiti poziv** (mo쬰 biti 90%-10% na primer).\
Ako je **kod** jednog od alias-a **ranjiv**, mo쬰te slati **zahteve sve dok ranjiva** verzija ne primi eksploataciju.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Politike resursa Lambda

Politike resursa Lambda omogu캖avaju **davanje pristupa drugim uslugama/ra캜unima za pozivanje** lambda-e na primer.\
Na primer, ovo je politika koja omogu캖ava **svakome pristup lambda-i izlo쬰noj putem URL-a**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ili ovo da omogu캖i API Gateway-u da je pozove:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

Kada postoji **stotine** **paralelnih zahteva lambda-e**, ako svaki od njih treba **da se pove쬰 i zatvori konekciju sa bazom podataka**, to jednostavno ne캖e funkcionisati (lambda-e su bez stanja, ne mogu odr쬬vati otvorene konekcije).\
Zatim, ako va코e **Lambda funkcije komuniciraju sa RDS Proxy-jem umesto sa instancom baze podataka**. On rukuje sa bazom podataka za skaliranje mnogih istovremenih konekcija koje stvaraju paralelne Lambda funkcije. To omogu캖ava va코im Lambda aplikacijama da **ponovo koriste postoje캖e konekcije**, umesto da stvaraju nove konekcije za svaki poziv funkcije.

### Lambda EFS Filesystems

Da bi sa캜uvale i 캜ak delile podatke, **Lambda-e mogu pristupiti EFS-u i montirati ih**, tako da 캖e Lambda mo캖i da 캜ita i pi코e iz njega.

### Lambda Layers

Lambda _layer_ je .zip arhiva koja **mo쬰 sadr쬬ti dodatni kod** ili druge sadr쬬je. Layer mo쬰 sadr쬬ti biblioteke, [prilago캠eno izvr코no okru쬰nje](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), podatke ili konfiguracione fajlove.

Mogu캖e je uklju캜iti do **pet slojeva po funkciji**. Kada uklju캜ite sloj u funkciju, **sadr쬬j se izvla캜i u direktorijum `/opt`** u okru쬰nju izvr코avanja.

**Podrazumevano**, **slojevi** koje kreirate su **privatni** za va코 AWS nalog. Mo쬰te odabrati da **podelite** sloj sa drugim nalozima ili da ga **u캜inite javnim**. Ako va코e funkcije koriste sloj koji je objavio drugi nalog, va코e funkcije mogu **nastaviti da koriste verziju sloja nakon 코to je izbrisana ili nakon 코to vam je dozvola za pristup sloju povu캜ena**. Me캠utim, ne mo쬰te kreirati novu funkciju ili a쬿rirati funkcije koriste캖i izbrisane verzije sloja.

Funkcije implementirane kao kontejnerska slika ne koriste slojeve. Umesto toga, pakujete 쬰ljeno izvr코no okru쬰nje, biblioteke i druge zavisnosti u kontejnersku sliku prilikom izgradnje slike.

### Lambda Extensions

Lambda ekstenzije pobolj코avaju funkcije integrisanjem sa raznim **alatima za nadgledanje, posmatranje, bezbednost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva koriste캖i Lambda slojeve](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili uklju캜ene u [implementacije kontejnerskih slika](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), rade u dva moda: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa procesom izvr코avanja, manipuli코u캖i njegovim pokretanjem pomo캖u **jezi캜ki specifi캜nih okru쬰njskih promenljivih** i **omota캜kih skripti**. Ova prilago캠avanja se primenjuju na razne izvr코ne okoline, uklju캜uju캖i **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.

* **Eksterne ekstenzije** se izvr코avaju kao odvojeni procesi, odr쬬vaju캖i uskla캠enost sa 쬴votnim ciklusom Lambda funkcije. Kompatibilne su sa raznim izvr코nim okru쬰njima kao 코to su **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **prilago캠ena izvr코na okru쬰nja
### Enumeracija
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Pozovi lambda funkciju

#### Ru캜no
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Preko izlo쬰nog URL-a

Kada je AWS Lambda funkcija dostupna putem izlo쬰nog URL-a, mo쬰te je iskoristiti za izvr코avanje napada. Ovo se mo쬰 posti캖i slanjem HTTP zahteva na izlo쬰ni URL funkcije.

Da biste otkrili izlo쬰ne URL-ove AWS Lambda funkcija, mo쬰te koristiti alate kao 코to su `AWS CLI` ili `AWS Management Console`. Tako캠e mo쬰te koristiti `AWS SDK` za programski pristup informacijama o funkcijama.

Kada prona캠ete izlo쬰ni URL funkcije, mo쬰te ga iskoristiti za izvr코avanje razli캜itih napada, kao 코to su SQL injection, XSS ili RCE (Remote Code Execution). Ovi napadi mogu biti veoma opasni, jer omogu캖avaju napada캜u da izvr코ava zlonameran kod na serveru.

Da biste se za코titili od ovakvih napada, preporu캜uje se da pa쬷jivo konfiguri코ete pristupne kontrole i dozvole za AWS Lambda funkcije. Tako캠e je va쬹o redovno a쬿rirati funkcije i pratiti izlo쬰ne URL-ove kako biste otkrili eventualne ranjivosti i propuste u bezbednosti.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Poziv funkcije Lambda putem URL-a

Sada je vreme da saznamo mogu캖e lambda funkcije za izvr코avanje:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Dostupna je lambda funkcija nazvana "Level6". Hajde da saznamo kako je pozvati:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

Sada kada znate ime i ID, mo쬰te dobiti ime:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

I na kraju pozovite funkciju pristupaju캖i (primetite da se ID, Ime i ime funkcije pojavljuju u URL-u): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Ostali okida캜i

Postoji mnogo drugih izvora koji mogu pokrenuti lambda funkciju

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privesc

Na slede캖oj stranici mo쬰te proveriti kako **zloupotrebiti dozvole Lambda funkcije da biste pove캖ali privilegije**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Neautentifikovan pristup

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post eksploatacija

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Upornost

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
