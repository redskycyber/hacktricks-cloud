# AWS - EFS Enum

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## EFS

### Informaci√≥n b√°sica

Amazon Elastic File System (EFS) es un sistema de archivos de red completamente **administrado, escalable y el√°stico** de AWS. Permite crear y configurar **sistemas de archivos compartidos entre m√∫ltiples** instancias EC2 y otros servicios de AWS. EFS se escala autom√°ticamente, proporciona acceso de baja latencia, admite cargas de trabajo de alto rendimiento, garantiza la durabilidad de los datos e integra caracter√≠sticas de seguridad de AWS.

De forma **predeterminada**, la carpeta EFS a montar ser√° **`/`**, pero podr√≠a tener un **nombre diferente**.

### Acceso de red

Un EFS se crea en una VPC y, por defecto, ser√≠a **accesible en todas las subredes de la VPC**. Sin embargo, el EFS tendr√° un Grupo de seguridad. Para **dar acceso a una instancia EC2** (u otro servicio de AWS) para montar el EFS, es necesario **permitir en el grupo de seguridad del EFS una regla NFS** (puerto 2049) **entrante desde el grupo de seguridad de la EC2**.

Sin esto, **no podr√°s contactar con el servicio NFS**.

Para obtener m√°s informaci√≥n sobre c√≥mo hacer esto, consulta: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeraci√≥n
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20
```
### Montar EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acceso IAM

Por **defecto**, cualquier persona con **acceso de red a EFS** podr√° montarlo, **leerlo y escribirlo incluso como usuario root**. Sin embargo, podr√≠an existir pol√≠ticas de sistema de archivos que **solo permitan el acceso a los principales con permisos espec√≠ficos**.\
Por ejemplo, esta pol√≠tica de sistema de archivos **no permitir√° ni siquiera montar** el sistema de archivos si no tienes el permiso IAM:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
O esto **evitar√° el acceso an√≥nimo**:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Tenga en cuenta que para montar sistemas de archivos protegidos por IAM DEBE utilizar el tipo "efs" en el comando de montaje:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Puntos de acceso

Los **puntos de acceso** son puntos de entrada espec√≠ficos de una **aplicaci√≥n** en un sistema de archivos EFS que facilitan la gesti√≥n del acceso de la aplicaci√≥n a conjuntos de datos compartidos.

Al crear un punto de acceso, puedes **especificar el propietario y los permisos POSIX** para los archivos y directorios creados a trav√©s del punto de acceso. Tambi√©n puedes **definir un directorio ra√≠z personalizado** para el punto de acceso, ya sea especificando un directorio existente o creando uno nuevo con los permisos deseados. Esto te permite **controlar el acceso a tu sistema de archivos EFS en funci√≥n de la aplicaci√≥n o el usuario**, lo que facilita la gesti√≥n y seguridad de tus datos de archivos compartidos.

**Puedes montar el sistema de archivos desde un punto de acceso de la siguiente manera:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Ten en cuenta que incluso al intentar montar un punto de acceso, a√∫n necesitas poder **contactar el servicio NFS a trav√©s de la red**, y si el EFS tiene una **pol√≠tica de sistema de archivos**, necesitas **suficientes permisos IAM** para montarlo.
{% endhint %}

Los puntos de acceso se pueden utilizar para los siguientes prop√≥sitos:

* **Simplificar la gesti√≥n de permisos**: Al definir un usuario y grupo POSIX para cada punto de acceso, puedes gestionar f√°cilmente los permisos de acceso para diferentes aplicaciones o usuarios sin modificar los permisos subyacentes del sistema de archivos.
* **Imponer un directorio ra√≠z**: Los puntos de acceso pueden restringir el acceso a un directorio espec√≠fico dentro del sistema de archivos EFS, asegurando que cada aplicaci√≥n o usuario opere dentro de su carpeta designada. Esto ayuda a prevenir la exposici√≥n o modificaci√≥n accidental de datos.
* **Acceso m√°s f√°cil al sistema de archivos**: Los puntos de acceso se pueden asociar con una funci√≥n de AWS Lambda o una tarea de AWS Fargate, simplificando el acceso al sistema de archivos para aplicaciones sin servidor y contenerizadas.

## Escalada de privilegios

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Explotaci√≥n

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistencia

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
