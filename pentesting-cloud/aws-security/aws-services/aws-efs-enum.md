# AWS - EFS Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## EFS

### Podstawowe informacje

Amazon Elastic File System (EFS) jest prezentowany przez AWS jako **w peni zarzdzany, skalowalny i elastyczny system plik贸w sieciowych**. Usuga uatwia tworzenie i konfigurowanie **system贸w plik贸w**, kt贸re mog by jednoczenie dostpne przez wiele instancji EC2 i inne usugi AWS. G贸wne cechy EFS obejmuj mo偶liwo automatycznego skalowania bez koniecznoci interwencji manualnej, zapewnienie dostpu o niskim op贸藕nieniu, obsug obci偶e o du偶ej przepustowoci, gwarancj trwaoci danych oraz bezproblemow integracj z r贸偶nymi mechanizmami bezpieczestwa AWS.

Domylnie, folder EFS do zamontowania bdzie **`/`**, ale mo偶e mie **inn nazw**.

### Dostp sieciowy

EFS jest tworzony w VPC i domylnie jest **dostpny we wszystkich podsieciach VPC**. Jednak EFS bdzie mia Grup Zabezpiecze. Aby **udzieli dostpu do montowania EFS** instancji EC2 (lub dowolnej innej usudze AWS), konieczne jest **zezwolenie w grupie zabezpiecze EFS na przychodzce reguy NFS** (port 2049) **z Grupy Zabezpiecze EC2**.

Bez tego **nie bdzie mo偶liwe skontaktowanie si z usug NFS**.

Aby uzyska wicej informacji na temat tego, jak to zrobi, sprawd藕: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Wyliczenie
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Mo偶e si zdarzy, 偶e punkt montowania EFS znajduje si w tej samej VPC, ale w innym podsieci. Jeli chcesz mie pewno, 偶e znajdziesz wszystkie **punkty EFS, lepiej jest przeskanowa mask sieci `/16`**.
{% endhint %}

### Zamontuj EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Dostp IAM

Domylnie ka偶dy z dostpem sieciowym do EFS bdzie m贸g zamontowa, odczyta i zapisywa go nawet jako u偶ytkownik root. Jednak mog obowizywa polityki systemu plik贸w, kt贸re pozwalaj tylko okrelonym podmiotom na dostp do niego. Na przykad ta polityka systemu plik贸w nie pozwoli nawet na zamontowanie systemu plik贸w, jeli nie masz uprawnienia IAM:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Lub to **zapobiegnie anonimowemu dostpowi**:

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

Zauwa偶, 偶e aby zamontowa systemy plik贸w chronione przez IAM, MUSISZ u偶y typu "efs" w poleceniu montowania:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Punkty dostpu

**Punkty dostpu** to **specyficzne dla aplikacji punkty wejcia do systemu plik贸w EFS**, kt贸re uatwiaj zarzdzanie dostpem aplikacji do udostpnionych zbior贸w danych.

Podczas tworzenia punktu dostpu mo偶esz **okreli waciciela i uprawnienia POSIX** dla plik贸w i katalog贸w tworzonych za porednictwem punktu dostpu. Mo偶esz r贸wnie偶 **zdefiniowa niestandardowy katalog g贸wny** dla punktu dostpu, albo poprzez okrelenie istniejcego katalogu, albo poprzez utworzenie nowego z po偶danymi uprawnieniami. Pozwala to **kontrolowa dostp do systemu plik贸w EFS na poziomie aplikacji lub u偶ytkownika**, uatwiajc zarzdzanie i zabezpieczanie udostpnionych danych plik贸w.

**Mo偶esz zamontowa system plik贸w z punktu dostpu w nastpujcy spos贸b:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Zauwa偶, 偶e nawet pr贸bujc zamontowa punkt dostpu, nadal musisz m贸c **skontaktowa si z usug NFS przez sie**, a jeli EFS ma **polityk systemu plik贸w**, potrzebujesz **wystarczajcych uprawnie IAM** do jego zamontowania.
{% endhint %}

Punkty dostpu mog by u偶ywane do nastpujcych cel贸w:

* **Uproszczenie zarzdzania uprawnieniami**: Poprzez zdefiniowanie u偶ytkownika i grupy POSIX dla ka偶dego punktu dostpu, mo偶na atwo zarzdza uprawnieniami dostpu dla r贸偶nych aplikacji lub u偶ytkownik贸w, bez koniecznoci modyfikowania uprawnie podstawowego systemu plik贸w.
* **Wymuszenie katalogu g贸wnego**: Punkty dostpu mog ogranicza dostp do okrelonego katalogu w systemie plik贸w EFS, zapewniajc, 偶e ka偶da aplikacja lub u偶ytkownik dziaa w swoim wyznaczonym folderze. Pomaga to zapobiec przypadkowemu ujawnieniu lub modyfikacji danych.
* **atwiejszy dostp do systemu plik贸w**: Punkty dostpu mog by powizane z funkcj AWS Lambda lub zadaniem AWS Fargate, uatwiajc dostp do systemu plik贸w dla aplikacji bezserwerowych i konteneryzowanych.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
