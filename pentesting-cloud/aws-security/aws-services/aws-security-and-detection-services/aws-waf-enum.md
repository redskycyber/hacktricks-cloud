# AWS - WAF Enum

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

# AWS WAF

AWS WAF est un **pare-feu d'application web** con√ßu pour **prot√©ger les applications web ou les API** contre diverses exploitations web qui peuvent affecter leur disponibilit√©, leur s√©curit√© ou leur consommation de ressources. Il permet aux utilisateurs de contr√¥ler le trafic entrant en mettant en place des **r√®gles de s√©curit√©** qui att√©nuent les vecteurs d'attaque typiques comme l'injection SQL ou le cross-site scripting, et √©galement en d√©finissant des r√®gles de filtrage personnalis√©es.

## Crit√®res de Surveillance (Conditions)

Les conditions sp√©cifient les √©l√©ments des requ√™tes HTTP/HTTPS entrantes qu'AWS WAF surveille, qui incluent XSS, la localisation g√©ographique (GEO), les adresses IP, les contraintes de taille, l'injection SQL et les motifs (correspondances de cha√Ænes et d'expressions r√©guli√®res). Il est important de noter que les requ√™tes restreintes au niveau de CloudFront en fonction du pays n'atteindront pas WAF.

Chaque compte AWS peut configurer :
- **100 conditions** pour chaque type (sauf pour Regex, o√π seulement **10 conditions** sont autoris√©es, mais cette limite peut √™tre augment√©e).
- **100 r√®gles** et **50 Web ACLs**.
- Un maximum de **5 r√®gles bas√©es sur le taux**.
- Un d√©bit de **10 000 requ√™tes par seconde** lorsque WAF est impl√©ment√© avec un √©quilibreur de charge d'application.

## Configuration des R√®gles

Les r√®gles sont √©labor√©es en utilisant les conditions sp√©cifi√©es. Par exemple, une r√®gle peut bloquer une requ√™te si elle r√©pond √† 2 conditions sp√©cifiques. Il existe deux types de r√®gles :

1. **R√®gle R√©guli√®re** : R√®gle standard bas√©e sur les conditions sp√©cifi√©es.
2. **R√®gle Bas√©e sur le Taux** : Compte les requ√™tes provenant d'une adresse IP sp√©cifique sur une p√©riode de cinq minutes. Ici, les utilisateurs d√©finissent un seuil, et si le nombre de requ√™tes provenant d'une IP d√©passe cette limite en cinq minutes, les requ√™tes ult√©rieures de cette IP sont bloqu√©es jusqu'√† ce que le taux de requ√™tes descende en dessous du seuil. Le seuil minimum pour les r√®gles bas√©es sur le taux est de **2000 requ√™tes**.

## Actions

Des actions sont attribu√©es √† chaque r√®gle, avec des options **Autoriser**, **Bloquer** ou **Compter** :

- **Autoriser** : La requ√™te est transmise √† la distribution CloudFront ou √† l'√©quilibreur de charge d'application appropri√©.
- **Bloquer** : La requ√™te est imm√©diatement termin√©e.
- **Compter** : Compte les requ√™tes r√©pondant aux conditions de la r√®gle. Cela est utile pour tester la r√®gle, confirmer l'exactitude de la r√®gle avant de la r√©gler sur Autoriser ou Bloquer.

Si une requ√™te ne correspond √† aucune r√®gle dans le Web ACL, elle subit l'**action par d√©faut** (Autoriser ou Bloquer). L'ordre d'ex√©cution des r√®gles, d√©fini dans un Web ACL, est crucial et suit g√©n√©ralement cette s√©quence :

1. Autoriser les IPs de la liste blanche.
2. Bloquer les IPs de la liste noire.
3. Bloquer les requ√™tes correspondant √† toute signature nuisible.

## Int√©gration CloudWatch

AWS WAF s'int√®gre avec CloudWatch pour la surveillance, offrant des m√©triques comme AllowedRequests, BlockedRequests, CountedRequests et PassedRequests. Ces m√©triques sont rapport√©es chaque minute par d√©faut et conserv√©es pendant une p√©riode de deux semaines.


## √ânum√©ration

Le scope peut √©galement √™tre CLOUDFRONT, mais lors de la v√©rification d'un WAF non li√© √† Cloudfront, vous devez utiliser REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Contournement

{% hint style="success" %}
Du point de vue d'un attaquant, ce service peut aider l'attaquant √† identifier les protections WAF et les expositions r√©seau qui pourraient l'aider √† compromettre d'autres sites web.

Cependant, un attaquant pourrait √©galement √™tre int√©ress√© par la perturbation de ce service afin que les sites web ne soient pas prot√©g√©s par le WAF.
{% endhint %}

TODO : Les PR sont les bienvenues

# R√©f√©rences
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
