# AWS - WAF Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

# AWS WAF

AWS WAF je **web aplikacioni firewall** dizajniran da **zaÅ¡titi web aplikacije ili API-je** od raznih web eksploatacija koje mogu uticati na njihovu dostupnost, sigurnost ili potroÅ¡nju resursa. OmoguÄ‡ava korisnicima da kontroliÅ¡u dolazni saobraÄ‡aj postavljanjem **bezbednosnih pravila** koja umanjuju tipiÄne vektore napada poput SQL injection-a ili cross-site scripting-a, kao i definisanjem prilagoÄ‘enih pravila za filtriranje.

## Kriterijumi za praÄ‡enje (Uslovi)

Uslovi odreÄ‘uju elemente dolaznih HTTP/HTTPS zahteva koje AWS WAF prati, a koji ukljuÄuju XSS, geografsku lokaciju (GEO), IP adrese, ograniÄenja veliÄine, SQL Injection i obrasce (stringove i regex poklapanje). VaÅ¾no je napomenuti da zahtevi ograniÄeni na CloudFront nivou na osnovu zemlje neÄ‡e stiÄ‡i do WAF-a.

Svaki AWS nalog moÅ¾e konfigurisati:
- **100 uslova** za svaki tip (osim za Regex, gde je dozvoljeno samo **10 uslova**, ali ovo ograniÄenje se moÅ¾e poveÄ‡ati).
- **100 pravila** i **50 Web ACL-ova**.
- Maksimalno **5 pravila zasnovana na stopi**.
- Protok od **10.000 zahteva u sekundi** kada se WAF implementira sa balanserom optereÄ‡enja aplikacija.

## Konfiguracija pravila

Pravila se kreiraju koristeÄ‡i odreÄ‘ene uslove. Na primer, pravilo moÅ¾e blokirati zahtev ako ispunjava 2 specifiÄna uslova. Postoje dva tipa pravila:

1. **Regularno pravilo**: Standardno pravilo zasnovano na odreÄ‘enim uslovima.
2. **Pravilo zasnovano na stopi**: Broji zahteve sa odreÄ‘ene IP adrese tokom petominutnog perioda. Korisnici ovde definiÅ¡u prag, i ako broj zahteva sa IP adrese premaÅ¡i ovaj limit u roku od pet minuta, sledeÄ‡i zahtevi sa te IP adrese su blokirani sve dok se stopa zahteva ne smanji ispod praga. Minimalni prag za pravila zasnovana na stopi je **2000 zahteva**.

## Akcije

Akcije se dodeljuju svakom pravilu, a opcije su **Dozvoli**, **Blokiraj** ili **Broj**:

- **Dozvoli**: Zahtev se prosleÄ‘uje odgovarajuÄ‡em CloudFront distribuciji ili balanseru optereÄ‡enja aplikacija.
- **Blokiraj**: Zahtev se odmah prekida.
- **Broj**: Broji zahteve koji ispunjavaju uslove pravila. Ovo je korisno za testiranje pravila, potvrÄ‘ivanje taÄnosti pravila pre nego Å¡to se postavi na Dozvoli ili Blokiraj.

Ako zahtev ne odgovara nijednom pravilu unutar Web ACL-a, podleÅ¾e **podrazumevanoj akciji** (Dozvoli ili Blokiraj). Redosled izvrÅ¡avanja pravila, definisan unutar Web ACL-a, je kljuÄan i obiÄno sledi ovaj redosled:

1. Dozvoli IP adrese sa belih lista.
2. Blokiraj IP adrese sa crnih lista.
3. Blokiraj zahteve koji se poklapaju sa bilo kojim Å¡tetnim potpisima.

## Integracija sa CloudWatch-om

AWS WAF se integriÅ¡e sa CloudWatch-om za praÄ‡enje, pruÅ¾ajuÄ‡i metrike poput AllowedRequests, BlockedRequests, CountedRequests i PassedRequests. Ove metrike se podrazumevano prikazuju svaki minut i Äuvaju se u periodu od dve nedelje.


## Enumeracija

opseg moÅ¾e biti i CLOUDFRONT, ali kada proveravate WAF koji nije povezan sa Cloudfrontom, trebate koristiti REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Eksploatacija / Bypass

{% hint style="success" %}
Sa perspektive napadaÄa, ovaj servis moÅ¾e pomoÄ‡i napadaÄu da identifikuje WAF zaÅ¡tite i mreÅ¾ne izloÅ¾enosti koje bi mu mogle pomoÄ‡i da kompromituje druge veb stranice.

MeÄ‘utim, napadaÄ takoÄ‘e moÅ¾e biti zainteresovan za ometanje ovog servisa kako bi veb stranice bile nezaÅ¡tiÄ‡ene od WAF-a.
{% endhint %}

TODO: PR-ovi su dobrodoÅ¡li

# Reference
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
