# AWS - WAF Enum

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

# AWS WAF

AWS WAF to **zapora aplikacji internetowych** zaprojektowana do **ochrony aplikacji internetowych lub interfejsÃ³w API** przed rÃ³Å¼nymi atakami internetowymi, ktÃ³re mogÄ… wpÅ‚ywaÄ‡ na ich dostÄ™pnoÅ›Ä‡, bezpieczeÅ„stwo lub zuÅ¼ycie zasobÃ³w. UÅ¼ytkownicy mogÄ… kontrolowaÄ‡ przychodzÄ…cy ruch, ustawiajÄ…c **zasady bezpieczeÅ„stwa**, ktÃ³re Å‚agodzÄ… typowe wektory ataku, takie jak wstrzykniÄ™cie SQL lub skryptowanie miÄ™dzywitrynowe, a takÅ¼e definiujÄ…c niestandardowe zasady filtrowania.

## Kryteria monitorowania (warunki)

Warunki okreÅ›lajÄ… elementy przychodzÄ…cych Å¼Ä…daÅ„ HTTP/HTTPS, ktÃ³re monitoruje AWS WAF, w tym XSS, lokalizacjÄ™ geograficznÄ… (GEO), adresy IP, ograniczenia rozmiaru, wstrzykniÄ™cie SQL i wzorce (dopasowanie ciÄ…gÃ³w i wyraÅ¼eÅ„ regularnych). WaÅ¼ne jest zauwaÅ¼enie, Å¼e Å¼Ä…dania ograniczone na poziomie CloudFront na podstawie kraju nie dotrÄ… do WAF.

KaÅ¼de konto AWS moÅ¼e skonfigurowaÄ‡:
- **100 warunkÃ³w** dla kaÅ¼dego typu (z wyjÄ…tkiem wyraÅ¼eÅ„ regularnych, gdzie dozwolone jest tylko **10 warunkÃ³w**, ale ten limit moÅ¼na zwiÄ™kszyÄ‡).
- **100 zasad** i **50 Web ACL**.
- Maksymalnie **5 zasad opartych na czÄ™stoÅ›ci**.
- PrzepustowoÅ›Ä‡ **10 000 Å¼Ä…daÅ„ na sekundÄ™**, gdy WAF jest wdroÅ¼ony z balanserem obciÄ…Å¼enia aplikacji.

## Konfiguracja zasad

Zasady sÄ… tworzone przy uÅ¼yciu okreÅ›lonych warunkÃ³w. Na przykÅ‚ad, zasada moÅ¼e blokowaÄ‡ Å¼Ä…danie, jeÅ›li speÅ‚nia 2 konkretne warunki. IstniejÄ… dwa rodzaje zasad:

1. **Zasada standardowa**: Standardowa zasada oparta na okreÅ›lonych warunkach.
2. **Zasada oparta na czÄ™stoÅ›ci**: Liczy Å¼Ä…dania z okreÅ›lonego adresu IP przez okres piÄ™ciu minut. UÅ¼ytkownicy okreÅ›lajÄ… prÃ³g, i jeÅ›li liczba Å¼Ä…daÅ„ z danego adresu IP przekracza ten limit w ciÄ…gu piÄ™ciu minut, kolejne Å¼Ä…dania z tego adresu IP sÄ… blokowane, dopÃ³ki czÄ™stoÅ›Ä‡ Å¼Ä…daÅ„ nie spadnie poniÅ¼ej progu. Minimalny prÃ³g dla zasad opartych na czÄ™stoÅ›ci to **2000 Å¼Ä…daÅ„**.

## DziaÅ‚ania

DziaÅ‚ania sÄ… przypisywane do kaÅ¼dej zasady, a opcje to **Allow**, **Block** lub **Count**:

- **Allow**: Å»Ä…danie jest przekazywane do odpowiedniego rozprowadzenia CloudFront lub balansera obciÄ…Å¼enia aplikacji.
- **Block**: Å»Ä…danie jest natychmiastowo zakoÅ„czone.
- **Count**: Liczy Å¼Ä…dania speÅ‚niajÄ…ce warunki zasady. Jest to przydatne do testowania zasad, potwierdzania dokÅ‚adnoÅ›ci zasady przed ustawieniem jej na Allow lub Block.

JeÅ›li Å¼Ä…danie nie pasuje do Å¼adnej zasady w Web ACL, podlega **domyÅ›lnej akcji** (Allow lub Block). KolejnoÅ›Ä‡ wykonywania zasad, zdefiniowana w ramach Web ACL, jest istotna i zazwyczaj podÄ…Å¼a za tÄ… sekwencjÄ…:

1. PozwÃ³l na adresy IP z biaÅ‚ej listy.
2. Zablokuj adresy IP z czarnej listy.
3. Zablokuj Å¼Ä…dania pasujÄ…ce do jakichkolwiek szkodliwych sygnatur.

## Integracja z CloudWatch

AWS WAF integruje siÄ™ z CloudWatch w celu monitorowania, oferujÄ…c metryki takie jak AllowedRequests, BlockedRequests, CountedRequests i PassedRequests. Te metryki sÄ… raportowane domyÅ›lnie co minutÄ™ i przechowywane przez okres dwÃ³ch tygodni.


## Wyliczenie

Zakres moÅ¼e rÃ³wnieÅ¼ byÄ‡ CLOUDFRONT, ale przy sprawdzaniu WAF niezwiÄ…zanego z CloudFront naleÅ¼y uÅ¼yÄ‡ REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Bypass

{% hint style="success" %}
Z perspektywy atakujÄ…cego, ta usÅ‚uga moÅ¼e pomÃ³c atakujÄ…cemu zidentyfikowaÄ‡ ochronÄ™ WAF i naraÅ¼enia sieciowe, ktÃ³re mogÄ… mu pomÃ³c w kompromitacji innych stron internetowych.

Jednak atakujÄ…cy moÅ¼e rÃ³wnieÅ¼ byÄ‡ zainteresowany zakÅ‚Ã³ceniem tej usÅ‚ugi, aby strony nie byÅ‚y chronione przez WAF.
{% endhint %}

TODO: PRy sÄ… mile widziane

# References
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
