# AWS - CloudWatch æšä¸¾

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## CloudWatch

**CloudWatch** **æ”¶é›†**ç›‘æ§å’Œæ“ä½œ**æ•°æ®**ï¼Œå½¢å¼ä¸ºæ—¥å¿—/æŒ‡æ ‡/äº‹ä»¶ï¼Œæä¾›AWSèµ„æºã€åº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„**ç»Ÿä¸€è§†å›¾**ã€‚\
CloudWatchæ—¥å¿—äº‹ä»¶å¯¹æ¯æ¡æ—¥å¿—è¡Œæœ‰**256KBçš„å¤§å°é™åˆ¶**ã€‚\
å®ƒå¯ä»¥è®¾ç½®**é«˜åˆ†è¾¨ç‡è­¦æŠ¥**ï¼Œå¹¶æ’å¯è§†åŒ–**æ—¥å¿—**å’Œ**æŒ‡æ ‡**ï¼Œé‡‡å–è‡ªåŠ¨åŒ–æ“ä½œï¼Œæ’é™¤æ•…éšœï¼Œå¹¶å‘ç°æ´å¯Ÿä»¥ä¼˜åŒ–åº”ç”¨ç¨‹åºã€‚

æ‚¨å¯ä»¥ç›‘æ§ä¾‹å¦‚CloudTrailçš„æ—¥å¿—ã€‚è¢«ç›‘æ§çš„äº‹ä»¶åŒ…æ‹¬ï¼š

* å®‰å…¨ç»„å’ŒNACLsçš„å˜æ›´
* å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œç»ˆæ­¢EC2å®ä¾‹
* IAMå’ŒS3å†…çš„å®‰å…¨ç­–ç•¥å˜æ›´
* AWSç®¡ç†æ§åˆ¶å°çš„ç™»å½•å°è¯•å¤±è´¥
* å¯¼è‡´æˆæƒå¤±è´¥çš„APIè°ƒç”¨
* åœ¨cloudwatchä¸­æœç´¢çš„è¿‡æ»¤å™¨ï¼š[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch æ—¥å¿— <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

å…è®¸**èšåˆå’Œç›‘æ§æ¥è‡ªåº”ç”¨ç¨‹åº**å’Œç³»ç»Ÿçš„æ—¥å¿—ï¼ŒåŒ…æ‹¬**AWSæœåŠ¡**ï¼ˆåŒ…æ‹¬CloudTrailï¼‰å’Œ**æ¥è‡ªåº”ç”¨/ç³»ç»Ÿ**çš„æ—¥å¿—ï¼ˆå¯ä»¥åœ¨ä¸»æœºä¸Šå®‰è£…**CloudWatch Agent**ï¼‰ã€‚æ—¥å¿—å¯ä»¥**æ— é™æœŸå­˜å‚¨**ï¼ˆå–å†³äºæ—¥å¿—ç»„è®¾ç½®ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥å¯¼å‡ºã€‚

**å…ƒç´ **ï¼š

| **æ—¥å¿—ç»„**                | ä¸€ç³»åˆ—å…±äº«ç›¸åŒä¿ç•™ã€ç›‘æ§å’Œè®¿é—®æ§åˆ¶è®¾ç½®çš„**æ—¥å¿—æµ**                                                                                   |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **æ—¥å¿—æµ**               | ä¸€ç³»åˆ—å…±äº«**ç›¸åŒæ¥æº**çš„**æ—¥å¿—äº‹ä»¶**                                                                                                                      |
| **è®¢é˜…è¿‡æ»¤å™¨**           | å®šä¹‰ä¸€ä¸ª**åŒ¹é…ç‰¹å®šæ—¥å¿—ç»„ä¸­äº‹ä»¶çš„è¿‡æ»¤æ¨¡å¼**ï¼Œå°†å®ƒä»¬å‘é€åˆ°Kinesis Data Firehoseæµã€Kinesisæµæˆ–Lambdaå‡½æ•°                                                  |

### CloudWatch ç›‘æ§ & äº‹ä»¶

CloudWatch **åŸºç¡€**æ¯**5åˆ†é’Ÿ**èšåˆæ•°æ®ä¸€æ¬¡ï¼ˆ**è¯¦ç»†**çš„æ¯**1åˆ†é’Ÿ**ä¸€æ¬¡ï¼‰ã€‚èšåˆåï¼Œå®ƒä¼š**æ£€æŸ¥è­¦æŠ¥çš„é˜ˆå€¼**ï¼Œä»¥é˜²éœ€è¦è§¦å‘ä¸€ä¸ªã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCloudWatchå¯ä»¥å‡†å¤‡å‘é€ä¸€ä¸ªäº‹ä»¶å¹¶æ‰§è¡Œä¸€äº›è‡ªåŠ¨æ“ä½œï¼ˆAWS lambdaå‡½æ•°ã€SNSä¸»é¢˜ã€SQSé˜Ÿåˆ—ã€Kinesisæµï¼‰

### Agent å®‰è£…

æ‚¨å¯ä»¥åœ¨æ‚¨çš„æœºå™¨/å®¹å™¨å†…å®‰è£…ä»£ç†ï¼Œä»¥è‡ªåŠ¨å°†æ—¥å¿—å‘é€å›CloudWatchã€‚

* **åˆ›å»º**ä¸€ä¸ª**è§’è‰²**å¹¶å°†å…¶**é™„åŠ **åˆ°å…·æœ‰å…è®¸CloudWatchä»å®ä¾‹æ”¶é›†æ•°æ®ä»¥åŠä¸AWSç³»ç»Ÿç®¡ç†å™¨SSMï¼ˆCloudWatchAgentAdminPolicy & AmazonEC2RoleforSSMï¼‰äº¤äº’æƒé™çš„**å®ä¾‹**
* **ä¸‹è½½**å¹¶**å®‰è£…**ä»£ç†åˆ°EC2å®ä¾‹ï¼ˆ[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)ï¼‰ã€‚æ‚¨å¯ä»¥ä»EC2å†…éƒ¨ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨AWSç³»ç»Ÿç®¡ç†å™¨è‡ªåŠ¨å®‰è£…ï¼Œé€‰æ‹©AWS-ConfigureAWSPackageåŒ…
* **é…ç½®**å¹¶**å¯åŠ¨**CloudWatchä»£ç†

ä¸€ä¸ªæ—¥å¿—ç»„æœ‰è®¸å¤šæµã€‚ä¸€ä¸ªæµæœ‰è®¸å¤šäº‹ä»¶ã€‚å¹¶ä¸”åœ¨æ¯ä¸ªæµå†…éƒ¨ï¼Œäº‹ä»¶çš„é¡ºåºæ˜¯æœ‰ä¿è¯çš„ã€‚

## æ“ä½œ

### æšä¸¾
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## é¿å…è¢«æ£€æµ‹

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty æ¯5åˆ†é’Ÿå°†å…¶å‘ç°åŒæ­¥åˆ° Cloudwatch äº‹ä»¶ã€‚ä¿®æ”¹äº‹ä»¶æ¨¡å¼æˆ–äº‹ä»¶çš„ç›®æ ‡**å¯èƒ½ä¼šå‡å°‘ GuardDuty è­¦æŠ¥å’Œè§¦å‘è‡ªåŠ¨ä¿®å¤å‘ç°çš„èƒ½åŠ›**ï¼Œå°¤å…¶æ˜¯åœ¨æˆå‘˜è´¦æˆ·ä¸­è§¦å‘ä¿®å¤æ—¶ï¼Œå› ä¸º GuardDuty ç®¡ç†å‘˜ä¿æŠ¤å¹¶ä¸æ‰©å±•åˆ°æˆå‘˜è´¦æˆ·ä¸­çš„ Cloudwatch äº‹ä»¶ã€‚

{% hint style="info" %}
åœ¨å§”æ‰˜æˆ–é‚€è¯·ç®¡ç†å‘˜çš„ GuardDuty æ¶æ„ä¸­ï¼Œcloudwatch äº‹ä»¶ä»å°†åœ¨ç®¡ç†å‘˜è´¦æˆ·ä¸­åˆ›å»ºã€‚
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## å‚è€ƒèµ„æ–™

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
