# AWS - CloudWatchæšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## CloudWatch

**CloudWatch**ä»¥æ—¥å¿—/æŒ‡æ ‡/äº‹ä»¶çš„å½¢å¼**æ”¶é›†**ç›‘æ§å’Œè¿è¥**æ•°æ®**ï¼Œæä¾›å¯¹AWSèµ„æºã€åº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„**ç»Ÿä¸€è§†å›¾**ã€‚\
CloudWatchæ—¥å¿—äº‹ä»¶æ¯è¡Œæ—¥å¿—æœ‰**256KBçš„å¤§å°é™åˆ¶**ã€‚\
å®ƒå¯ä»¥è®¾ç½®**é«˜åˆ†è¾¨ç‡è­¦æŠ¥**ï¼Œå°†**æ—¥å¿—**å’Œ**æŒ‡æ ‡**å¹¶æ’æ˜¾ç¤ºï¼Œæ‰§è¡Œè‡ªåŠ¨æ“ä½œï¼Œè§£å†³é—®é¢˜ï¼Œå¹¶å‘ç°ä¼˜åŒ–åº”ç”¨ç¨‹åºçš„è§è§£ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç›‘æ§æ¥è‡ªCloudTrailçš„æ—¥å¿—ã€‚ç›‘æ§çš„äº‹ä»¶åŒ…æ‹¬ï¼š

* å®‰å…¨ç»„å’ŒNACLçš„æ›´æ”¹
* å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œç»ˆæ­¢EC2å®ä¾‹
* IAMå’ŒS3ä¸­çš„å®‰å…¨ç­–ç•¥æ›´æ”¹
* å¯¹AWSç®¡ç†æ§åˆ¶å°çš„ç™»å½•å°è¯•å¤±è´¥
* å¯¼è‡´æˆæƒå¤±è´¥çš„APIè°ƒç”¨
* åœ¨cloudwatchä¸­æœç´¢çš„è¿‡æ»¤å™¨ï¼š[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatchæ—¥å¿— <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

å…è®¸**èšåˆå’Œç›‘æ§æ¥è‡ªåº”ç”¨ç¨‹åº**å’Œ**AWSæœåŠ¡**ï¼ˆåŒ…æ‹¬CloudTrailï¼‰ä»¥åŠ**åº”ç”¨ç¨‹åº/ç³»ç»Ÿ**çš„æ—¥å¿—ï¼ˆå¯ä»¥åœ¨ä¸»æœºä¸Šå®‰è£…CloudWatchä»£ç†ï¼‰ã€‚æ—¥å¿—å¯ä»¥**æ— é™æœŸå­˜å‚¨**ï¼ˆå–å†³äºæ—¥å¿—ç»„è®¾ç½®ï¼‰å¹¶ä¸”å¯ä»¥å¯¼å‡ºã€‚

**å…ƒç´ **ï¼š

| **æ—¥å¿—ç»„**            | å…·æœ‰ç›¸åŒä¿ç•™ã€ç›‘æ§å’Œè®¿é—®æ§åˆ¶è®¾ç½®çš„**æ—¥å¿—æµé›†åˆ**                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **æ—¥å¿—æµ**           | å…·æœ‰**ç›¸åŒæ¥æº**çš„**æ—¥å¿—äº‹ä»¶**åºåˆ—                                                                                                |
| **è®¢é˜…è¿‡æ»¤å™¨** | å®šä¹‰ä¸ç‰¹å®šæ—¥å¿—ç»„ä¸­çš„äº‹ä»¶åŒ¹é…çš„**è¿‡æ»¤æ¨¡å¼**ï¼Œå°†å…¶å‘é€åˆ°Kinesis Data Firehoseæµã€Kinesisæµæˆ–Lambdaå‡½æ•° |

### CloudWatchç›‘æ§å’Œäº‹ä»¶

CloudWatch **åŸºæœ¬**æ¯5åˆ†é’Ÿèšåˆä¸€æ¬¡æ•°æ®ï¼ˆ**è¯¦ç»†**æ¨¡å¼æ¯1åˆ†é’Ÿèšåˆä¸€æ¬¡ï¼‰ã€‚èšåˆåï¼Œå®ƒä¼š**æ£€æŸ¥è­¦æŠ¥çš„é˜ˆå€¼**ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦è§¦å‘è­¦æŠ¥ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCloudWatchå¯ä»¥å‡†å¤‡å‘é€äº‹ä»¶å¹¶æ‰§è¡Œä¸€äº›è‡ªåŠ¨æ“ä½œï¼ˆAWS Lambdaå‡½æ•°ã€SNSä¸»é¢˜ã€SQSé˜Ÿåˆ—ã€Kinesisæµï¼‰

### ä»£ç†å®‰è£…

æ‚¨å¯ä»¥åœ¨æ‚¨çš„æœºå™¨/å®¹å™¨å†…å®‰è£…ä»£ç†ï¼Œä»¥è‡ªåŠ¨å°†æ—¥å¿—å‘é€å›CloudWatchã€‚

* **åˆ›å»º**ä¸€ä¸ª**è§’è‰²**å¹¶å°†å…¶**é™„åŠ **åˆ°**å®ä¾‹**ä¸Šï¼Œè¯¥è§’è‰²å…·æœ‰å…è®¸CloudWatchä»å®ä¾‹æ”¶é›†æ•°æ®ä»¥åŠä¸AWSç³»ç»Ÿç®¡ç†å™¨SSMäº¤äº’çš„æƒé™ï¼ˆCloudWatchAgentAdminPolicyå’ŒAmazonEC2RoleforSSMï¼‰
* **ä¸‹è½½**å¹¶**å®‰è£…**ä»£ç†åˆ°EC2å®ä¾‹ï¼ˆ[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)ï¼‰ã€‚æ‚¨å¯ä»¥ä»EC2å†…éƒ¨ä¸‹è½½å®ƒï¼Œæˆ–è€…ä½¿ç”¨AWSç³»ç»Ÿç®¡ç†å™¨è‡ªåŠ¨å®‰è£…å®ƒï¼Œé€‰æ‹©AWS-ConfigureAWSPackageè½¯ä»¶åŒ…
* **é…ç½®**å¹¶**å¯åŠ¨**CloudWatchä»£ç†

ä¸€ä¸ªæ—¥å¿—ç»„æœ‰å¤šä¸ªæµã€‚ä¸€ä¸ªæµæœ‰å¤šä¸ªäº‹ä»¶ã€‚åœ¨æ¯ä¸ªæµä¸­ï¼Œäº‹ä»¶çš„é¡ºåºæ˜¯æœ‰ä¿è¯çš„ã€‚

## æ“ä½œ

### æšä¸¾
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## é¿å…è¢«æ£€æµ‹

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDutyä»¥5åˆ†é’Ÿçš„é¢‘ç‡å°†å…¶å‘ç°ç»“æœå¡«å……åˆ°Cloudwatch Eventsä¸­ã€‚ä¿®æ”¹äº‹ä»¶æ¨¡å¼æˆ–äº‹ä»¶çš„ç›®æ ‡**å¯èƒ½ä¼šé™ä½GuardDutyçš„è­¦æŠ¥èƒ½åŠ›å’Œè§¦å‘å‘ç°ç»“æœçš„è‡ªåŠ¨ä¿®å¤**ï¼Œç‰¹åˆ«æ˜¯åœ¨æˆå‘˜è´¦æˆ·ä¸­è§¦å‘ä¿®å¤æ—¶ï¼ŒGuardDutyç®¡ç†å‘˜ä¿æŠ¤ä¸ä¼šæ‰©å±•åˆ°æˆå‘˜è´¦æˆ·ä¸­çš„Cloudwatchäº‹ä»¶ã€‚

{% hint style="info" %}
åœ¨å§”æ´¾æˆ–é‚€è¯·ç®¡ç†å‘˜GuardDutyæ¶æ„ä¸­ï¼ŒCloudwatchäº‹ä»¶ä»å°†åœ¨ç®¡ç†å‘˜è´¦æˆ·ä¸­åˆ›å»ºã€‚
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## å‚è€ƒèµ„æ–™

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
