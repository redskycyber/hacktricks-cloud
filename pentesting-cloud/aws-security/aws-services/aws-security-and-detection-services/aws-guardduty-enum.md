# AWS - GuardDuty æšä¸¾

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## GuardDuty

æ ¹æ®[**æ–‡æ¡£**](https://aws.amazon.com/guardduty/features/)ï¼šGuardDuty ç»“åˆäº†**æœºå™¨å­¦ä¹ ã€å¼‚å¸¸æ£€æµ‹ã€ç½‘ç»œç›‘æ§å’Œæ¶æ„æ–‡ä»¶å‘ç°**ï¼Œä½¿ç”¨ AWS å’Œä¸šç•Œé¢†å…ˆçš„ç¬¬ä¸‰æ–¹æ¥æºæ¥å¸®åŠ©ä¿æŠ¤ AWS ä¸Šçš„å·¥ä½œè´Ÿè½½å’Œæ•°æ®ã€‚GuardDuty èƒ½å¤Ÿåˆ†ææ•°åäº¿ä¸ªäº‹ä»¶ï¼Œè·¨å¤šä¸ª AWS æ•°æ®æºï¼Œä¾‹å¦‚ AWS CloudTrail äº‹ä»¶æ—¥å¿—ã€Amazon Virtual Private Cloud (VPC) æµæ—¥å¿—ã€Amazon Elastic Kubernetes Service (EKS) å®¡è®¡å’Œç³»ç»Ÿçº§æ—¥å¿—ä»¥åŠ DNS æŸ¥è¯¢æ—¥å¿—ã€‚

Amazon GuardDuty **è¯†åˆ«è´¦æˆ·ä¸­çš„å¼‚å¸¸æ´»åŠ¨**ï¼Œåˆ†ææ´»åŠ¨çš„**å®‰å…¨ç›¸å…³æ€§**ï¼Œå¹¶æä¾›å…¶è¢«è°ƒç”¨çš„**ä¸Šä¸‹æ–‡**ã€‚è¿™ä½¿å¾—å“åº”è€…èƒ½å¤Ÿç¡®å®šæ˜¯å¦åº”è¯¥èŠ±æ—¶é—´è¿›è¡Œè¿›ä¸€æ­¥è°ƒæŸ¥ã€‚

è­¦æŠ¥ä¼šå‡ºç°åœ¨ GuardDuty æ§åˆ¶å°ï¼ˆ90 å¤©ï¼‰å’Œ CloudWatch äº‹ä»¶ä¸­ã€‚

{% hint style="warning" %}
å½“ç”¨æˆ·**ç¦ç”¨ GuardDuty**æ—¶ï¼Œå®ƒå°†åœæ­¢ç›‘æ§æ‚¨çš„ AWS ç¯å¢ƒï¼Œå¹¶ä¸”ä¸ä¼šç”Ÿæˆä»»ä½•æ–°çš„å‘ç°ï¼Œ**ç°æœ‰çš„å‘ç°å°†ä¸¢å¤±**ã€‚\
å¦‚æœåªæ˜¯åœæ­¢å®ƒï¼Œç°æœ‰çš„å‘ç°å°†ä¿ç•™ã€‚
{% endhint %}

### å‘ç°ç¤ºä¾‹

* **ä¾¦å¯Ÿ**ï¼šæ´»åŠ¨è¡¨æ˜æ”»å‡»è€…è¿›è¡Œä¾¦å¯Ÿï¼Œä¾‹å¦‚**å¼‚å¸¸çš„ API æ´»åŠ¨**ã€å¯ç–‘çš„æ•°æ®åº“**ç™»å½•**å°è¯•ã€VPC å†…éƒ¨**ç«¯å£æ‰«æ**ã€å¼‚å¸¸çš„ç™»å½•è¯·æ±‚å¤±è´¥æ¨¡å¼ï¼Œæˆ–è€…æ¥è‡ªå·²çŸ¥æ¶æ„ IP çš„æœªé˜»æ­¢çš„ç«¯å£æ¢æµ‹ã€‚
* **å®ä¾‹è¢«å…¥ä¾µ**ï¼šè¡¨æ˜å®ä¾‹è¢«å…¥ä¾µçš„æ´»åŠ¨ï¼Œä¾‹å¦‚**åŠ å¯†è´§å¸æŒ–çŸ¿ã€åé—¨å‘½ä»¤å’Œæ§åˆ¶ (C\&C)** æ´»åŠ¨ã€ä½¿ç”¨åŸŸç”Ÿæˆç®—æ³• (DGA) çš„æ¶æ„è½¯ä»¶ã€å‡ºç«™æ‹’ç»æœåŠ¡æ´»åŠ¨ã€å¼‚å¸¸**é«˜ç½‘ç»œ**æµé‡é‡ã€å¼‚å¸¸çš„ç½‘ç»œåè®®ã€å®ä¾‹ä¸å·²çŸ¥æ¶æ„ IP çš„å‡ºç«™é€šä¿¡ã€å¤–éƒ¨ IP åœ°å€ä½¿ç”¨çš„ä¸´æ—¶ Amazon EC2 å‡­è¯ï¼Œä»¥åŠä½¿ç”¨ DNS è¿›è¡Œçš„æ•°æ®å¤–æ³„ã€‚
* **è´¦æˆ·è¢«å…¥ä¾µ**ï¼šè¡¨æ˜è´¦æˆ·è¢«å…¥ä¾µçš„å¸¸è§æ¨¡å¼åŒ…æ‹¬æ¥è‡ªå¼‚å¸¸åœ°ç†ä½ç½®æˆ–åŒ¿åä»£ç†çš„ API è°ƒç”¨ã€è¯•å›¾ç¦ç”¨ AWS CloudTrail æ—¥å¿—è®°å½•ã€å‰Šå¼±è´¦æˆ·å¯†ç ç­–ç•¥çš„æ›´æ”¹ã€å¼‚å¸¸çš„å®ä¾‹æˆ–åŸºç¡€æ¶æ„å¯åŠ¨ã€åœ¨å¼‚å¸¸åŒºåŸŸéƒ¨ç½²åŸºç¡€æ¶æ„ã€å‡­è¯ç›—çªƒã€å¯ç–‘çš„æ•°æ®åº“ç™»å½•æ´»åŠ¨ä»¥åŠæ¥è‡ªå·²çŸ¥æ¶æ„ IP åœ°å€çš„ API è°ƒç”¨ã€‚
* **å­˜å‚¨æ¡¶è¢«å…¥ä¾µ**ï¼šè¡¨æ˜å­˜å‚¨æ¡¶è¢«å…¥ä¾µçš„æ´»åŠ¨ï¼Œä¾‹å¦‚è¡¨æ˜å‡­è¯æ»¥ç”¨çš„å¯ç–‘æ•°æ®è®¿é—®æ¨¡å¼ã€æ¥è‡ªè¿œç¨‹ä¸»æœºçš„å¼‚å¸¸ Amazon S3 API æ´»åŠ¨ã€æ¥è‡ªå·²çŸ¥æ¶æ„ IP åœ°å€çš„æœªç»æˆæƒçš„ S3 è®¿é—®ï¼Œä»¥åŠä»ä»¥å‰æ²¡æœ‰è®¿é—®è¿‡è¯¥å­˜å‚¨æ¡¶çš„ç”¨æˆ·æˆ–ä»å¼‚å¸¸ä½ç½®è°ƒç”¨çš„ç”¨æˆ·ä¸­æ£€ç´¢ S3 å­˜å‚¨æ¡¶ä¸­çš„æ•°æ®çš„ API è°ƒç”¨ã€‚Amazon GuardDuty æŒç»­ç›‘æ§å’Œåˆ†æ AWS CloudTrail S3 æ•°æ®äº‹ä»¶ï¼ˆä¾‹å¦‚ GetObjectã€ListObjectsã€DeleteObjectï¼‰ï¼Œä»¥æ£€æµ‹æ‰€æœ‰ Amazon S3 å­˜å‚¨æ¡¶ä¸­çš„å¯ç–‘æ´»åŠ¨ã€‚

<details>

<summary>å‘ç°ä¿¡æ¯</summary>

å‘ç°æ‘˜è¦ï¼š

* å‘ç°ç±»å‹
* ä¸¥é‡ç¨‹åº¦ï¼š7-8.9 é«˜ï¼Œ4-6.9 ä¸­ï¼Œ01-3.9 ä½
* åŒºåŸŸ
* è´¦æˆ· ID
* èµ„æº ID
* æ£€æµ‹æ—¶é—´
* ä½¿ç”¨çš„å¨èƒåˆ—è¡¨

æ­£æ–‡åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

* å—å½±å“çš„èµ„æº
* æ“ä½œ
* æ‰§è¡Œè€…ï¼šIP åœ°å€ã€ç«¯å£å’ŒåŸŸå
* é™„åŠ ä¿¡æ¯

</details>

### æ‰€æœ‰å‘ç°

è®¿é—®æ‰€æœ‰ GuardDuty å‘ç°çš„åˆ—è¡¨ï¼š[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### å¤šè´¦æˆ·

#### é€šè¿‡é‚€è¯·

æ‚¨å¯ä»¥**é‚€è¯·å…¶ä»–è´¦æˆ·**åŠ å…¥ä¸åŒçš„ AWS GuardDuty è´¦æˆ·ï¼Œä»¥ä¾¿**ä»åŒä¸€ä¸ª GuardDuty ç›‘æ§æ‰€æœ‰è´¦æˆ·**ã€‚ä¸»è´¦æˆ·å¿…é¡»é‚€è¯·æˆå‘˜è´¦æˆ·ï¼Œç„¶åæˆå‘˜è´¦æˆ·çš„ä»£è¡¨å¿…é¡»æ¥å—é‚€è¯·ã€‚

#### é€šè¿‡ç»„ç»‡

æ‚¨å¯ä»¥æŒ‡å®šç»„ç»‡ä¸­çš„ä»»ä½•è´¦æˆ·ä¸º**GuardDuty å§”æ´¾ç®¡ç†å‘˜**ã€‚åªæœ‰ç»„ç»‡ç®¡ç†è´¦æˆ·å¯ä»¥æŒ‡å®šå§”æ´¾ç®¡ç†å‘˜ã€‚

è¢«æŒ‡å®šä¸ºå§”æ´¾ç®¡ç†å‘˜çš„è´¦æˆ·å°†æˆä¸º GuardDuty ç®¡ç†å‘˜è´¦æˆ·ï¼Œåœ¨æŒ‡å®šçš„ AWS åŒºåŸŸè‡ªåŠ¨å¯ç”¨ GuardDutyï¼Œå¹¶ä¸”è¿˜å…·æœ‰**åœ¨è¯¥åŒºåŸŸå†…ä¸ºç»„ç»‡ä¸­çš„æ‰€æœ‰è´¦æˆ·å¯ç”¨å’Œç®¡ç† GuardDuty çš„æƒé™**ã€‚ç»„ç»‡ä¸­çš„å…¶ä»–è´¦æˆ·å¯ä»¥è¢«è§†ä¸ºä¸è¯¥å§”æ´¾ç®¡ç†å‘˜è´¦æˆ·å…³è”çš„ GuardDuty æˆå‘˜è´¦æˆ·ï¼Œå¹¶ä¸”å¯ä»¥æŸ¥çœ‹å¹¶æ·»åŠ è¿™äº›è´¦æˆ·ã€‚

## æšä¸¾

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDutyç»•è¿‡

### ä¸€èˆ¬æŒ‡å¯¼

å°½å¯èƒ½å¤šåœ°äº†è§£æ‚¨å°†è¦ä½¿ç”¨çš„å‡­æ®çš„è¡Œä¸ºï¼š

* ä½¿ç”¨çš„æ—¶é—´
* ä½ç½®
* ç”¨æˆ·ä»£ç†/æœåŠ¡ï¼ˆå¯èƒ½æ˜¯ä»awscliã€webconsoleã€lambdaç­‰ä½¿ç”¨ï¼‰
* å¸¸ç”¨çš„æƒé™

æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå°½å¯èƒ½åœ°é‡æ–°åˆ›å»ºç›¸åŒçš„åœºæ™¯æ¥ä½¿ç”¨è®¿é—®æƒé™ï¼š

* å¦‚æœæ˜¯ç”±ç”¨æˆ·è®¿é—®çš„**ç”¨æˆ·æˆ–è§’è‰²**ï¼Œè¯·å°è¯•åœ¨ç›¸åŒçš„æ—¶é—´æ®µå†…ã€ç›¸åŒçš„åœ°ç†ä½ç½®ï¼ˆç”šè‡³æ˜¯ç›¸åŒçš„ISPå’ŒIPï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼‰ä½¿ç”¨å®ƒ
* å¦‚æœæ˜¯ç”±æœåŠ¡ä½¿ç”¨çš„**è§’è‰²**ï¼Œè¯·åœ¨ç›¸åŒçš„åŒºåŸŸåˆ›å»ºç›¸åŒçš„æœåŠ¡ï¼Œå¹¶åœ¨ç›¸åŒçš„æ—¶é—´èŒƒå›´å†…ä½¿ç”¨å®ƒ
* å§‹ç»ˆå°è¯•ä½¿ç”¨æ­¤ä¸»ä½“å·²ä½¿ç”¨çš„**ç›¸åŒæƒé™**
* å¦‚æœæ‚¨éœ€è¦**ä½¿ç”¨å…¶ä»–æƒé™æˆ–æ»¥ç”¨æƒé™**ï¼ˆä¾‹å¦‚ï¼Œä¸‹è½½1,000,000ä¸ªcloudtrailæ—¥å¿—æ–‡ä»¶ï¼‰ï¼Œè¯·**ç¼“æ…¢**è¿›è¡Œï¼Œå¹¶ä¸”ä¸AWSçš„**æœ€å°äº¤äº’æ¬¡æ•°**ï¼ˆawscliæœ‰æ—¶åœ¨å†™å…¥ä¹‹å‰è°ƒç”¨å¤šä¸ªè¯»å–APIï¼‰

### ä¿®æ”¹GuardDuty

#### `guardduty:ListDetectors`ï¼Œ`guardduty:UpdateDetector`

ä½¿ç”¨è¿™äº›æƒé™ï¼Œæ‚¨å¯ä»¥ç¦ç”¨GuardDutyä»¥é¿å…è§¦å‘è­¦æŠ¥ã€‚
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

æ”»å‡»è€…å¯ä»¥åˆ›å»ºæˆ–æ›´æ–°GuardDutyçš„[å—ä¿¡ä»»çš„IPåˆ—è¡¨](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)ï¼ŒåŒ…æ‹¬å°†**è‡ªå·±çš„IPæ·»åŠ åˆ°åˆ—è¡¨ä¸­**ã€‚åœ¨å—ä¿¡ä»»çš„IPåˆ—è¡¨ä¸­çš„ä»»ä½•IPéƒ½**ä¸ä¼šè§¦å‘ä»»ä½•Cloudtrailæˆ–VPCæµæ—¥å¿—è­¦æŠ¥**ã€‚

{% hint style="info" %}
DNSå‘ç°ä¸å—å—ä¿¡ä»»çš„IPåˆ—è¡¨çš„å½±å“ã€‚
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
æ ¹æ®æ‰€éœ€çš„éšè”½ç¨‹åº¦ï¼Œæ–‡ä»¶å¯ä»¥ä¸Šä¼ åˆ°ç›®æ ‡è´¦æˆ·çš„s3å­˜å‚¨æ¡¶ä¸­ï¼Œæˆ–è€…ä¸Šä¼ åˆ°æ”»å‡»è€…æ§åˆ¶çš„è´¦æˆ·ä¸­ã€‚
{% endhint %}

#### `guardduty:CreateFilter`

æ–°åˆ›å»ºçš„GuardDutyå‘ç°å¯ä»¥é€šè¿‡[æŠ‘åˆ¶è§„åˆ™](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)è‡ªåŠ¨å½’æ¡£ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨[è¿‡æ»¤å™¨](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)æ¥è‡ªåŠ¨å½’æ¡£ä»–ä»¬å¯èƒ½ç”Ÿæˆçš„å‘ç°ã€‚

å¯ä»¥ä½¿ç”¨[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)æ¥åˆ›å»ºè¿‡æ»¤å™¨ã€‚
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

æ”»å‡»è€…å¯ä»¥é€šè¿‡[åˆ é™¤è­¦æŠ¥çš„ç›®æ ‡](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)æ¥ç¦ç”¨è­¦æŠ¥ã€‚
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
åˆ é™¤æ­¤å‘å¸ƒç›®æ ‡å°†**ä¸ä¼šå½±å“GuardDutyæ§åˆ¶å°ä¸­çš„å‘ç°ç”Ÿæˆæˆ–å¯è§æ€§**ã€‚GuardDutyå°†ç»§ç»­åˆ†ææ‚¨çš„AWSç¯å¢ƒä¸­çš„äº‹ä»¶ï¼Œè¯†åˆ«å¯ç–‘æˆ–æ„å¤–è¡Œä¸ºï¼Œå¹¶ç”Ÿæˆå‘ç°ã€‚
{% endhint %}

### ç‰¹å®šå‘ç°ç»•è¿‡

#### æ¸—é€æµ‹è¯•å‘ç°

OSçš„GuardDutyæ£€æµ‹åˆ°å¸¸è§æ¸—é€æµ‹è¯•å·¥å…·çš„AWS APIè¯·æ±‚ï¼Œå¹¶è§¦å‘[Pentest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux)ã€‚\
å®ƒæ˜¯é€šè¿‡ä¼ é€’çš„APIè¯·æ±‚ä¸­çš„**ç”¨æˆ·ä»£ç†åç§°**æ¥æ£€æµ‹çš„ã€‚\
å› æ­¤ï¼Œ**ä¿®æ”¹ç”¨æˆ·ä»£ç†**å¯ä»¥é˜²æ­¢GuardDutyæ£€æµ‹åˆ°æ”»å‡»ã€‚

ä½¿ç”¨Ubuntuã€Macæˆ–Windowsç­‰æ“ä½œç³»ç»Ÿå°†é˜²æ­¢è§¦å‘æ­¤è­¦æŠ¥ã€‚

è¦é˜²æ­¢æ­¤é—®é¢˜ï¼Œæ‚¨å¯ä»¥åœ¨`botocore`åŒ…ä¸­çš„è„šæœ¬`session.py`ä¸­æœç´¢ã€‚åœ¨Kali Linuxä¸­ï¼Œå®ƒä½äº`/usr/local/lib/python3.7/dist-packages/botocore/session.py`ã€‚

åœ¨[456è¡Œé™„è¿‘](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°`platform.system()`å’Œ`platform.release()`ã€‚å°†æ­¤**ä»£ç æ›¿æ¢ä¸ºåˆæ³•çš„ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚**[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt)**ä¸­çš„å­—ç¬¦ä¸²**ã€‚

#### Torå®¢æˆ·ç«¯å‘ç°

{% hint style="success" %}
ç»•è¿‡æ­¤é—®é¢˜æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯**ä¸ä½¿ç”¨Torè¿æ¥åˆ°AWS**ï¼ˆå¦‚æœæ‚¨æƒ³ä¿æŒéšèº«å¹¶æ¨¡æ‹Ÿå‡­æ®è¢«å…¥ä¾µçš„æƒ…å†µï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨Torå‘¢ï¼Ÿï¼‰
{% endhint %}

å¦‚æœæ‚¨ä»**Tor**è¿›è¡Œè¿æ¥ï¼Œ**Guarduty**å°†è®¾ç½®è­¦æŠ¥[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**ã€‚**

Guardutyé€šè¿‡[å…¬å…±çš„TorèŠ‚ç‚¹åˆ—è¡¨](https://metrics.torproject.org/exonerator.html)æ¥æ£€æµ‹æ­¤é—®é¢˜ã€‚&#x20;

å¦‚æœæ‚¨éœ€è¦é€šè¿‡Torè¿›è¡Œè¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)æ¥ç»•è¿‡æ­¤é—®é¢˜ã€‚ä½†æ˜¾ç„¶ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯æ ¹æœ¬ä¸ä½¿ç”¨Torè¿›è¡Œè¿æ¥ã€‚

è¦ä½¿ç”¨æ¡¥æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[Obfs4](https://gitlab.com/yawning/obfs4)ï¼ˆ`apt install tor obfs4proxy`ï¼‰å¹¶ä»[bridges.torproject.org](https://bridges.torproject.org/options)è·å–æ¡¥æ¥åœ°å€ã€‚

ä»è¿™é‡Œï¼Œåˆ›å»ºä¸€ä¸ªç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„`torrc`æ–‡ä»¶ï¼š
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
è¿è¡Œ `tor -f torrc`ï¼Œæ‚¨å¯ä»¥è¿æ¥åˆ°ç«¯å£9050ä¸Šçš„å¸¸è§„socks5ä»£ç†ã€‚

#### å‡­è¯æ³„éœ²æ£€æµ‹

å¦‚æœæ‚¨ä»å…ƒæ•°æ®æœåŠ¡ä¸­**çªƒå–EC2å‡­è¯**å¹¶åœ¨**AWSåŸºç¡€è®¾æ–½ä¹‹å¤–**ä½¿ç”¨å®ƒä»¬ï¼Œå°†è§¦å‘è­¦æŠ¥[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)ã€‚

æ­¤å¤–ï¼Œå¦‚æœæ‚¨**ä½¿ç”¨è‡ªå·±çš„EC2å®ä¾‹**æ¥ä½¿ç”¨**çªƒå–çš„å‡­è¯**ï¼Œå°†è§¦å‘è­¦æŠ¥[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)ã€‚

{% hint style="warning" %}
å¦‚æœæ‚¨å·²ç»**å…¥ä¾µ**äº†åŒä¸€**è´¦æˆ·**ä¸­çš„å¦ä¸€ä¸ª**EC2**æœºå™¨ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡Œä½¿ç”¨å‡­è¯è€Œ**ä¸ä¼šè§¦å‘è­¦æŠ¥**ã€‚
{% endhint %}

ç„¶è€Œï¼Œç›®å‰æœ‰ä¸€ç§å¯ä»¥ç»•è¿‡æ­¤é—®é¢˜çš„æ–¹æ³• - [VPCç»ˆç«¯èŠ‚ç‚¹](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)ã€‚ä½¿ç”¨**VPCç»ˆç«¯èŠ‚ç‚¹**å°†**ä¸ä¼šè§¦å‘GuardDutyè­¦æŠ¥**ã€‚è¿™æ„å‘³ç€ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œ`å¦‚æœæ‚¨ä»EC2å®ä¾‹çªƒå–IAMå‡­è¯ï¼Œæ‚¨å¯ä»¥åœ¨é€šè¿‡VPCç»ˆç«¯èŠ‚ç‚¹è·¯ç”±æµé‡çš„è‡ªå·±çš„EC2å®ä¾‹ä¸­ä½¿ç”¨è¿™äº›å‡­è¯ã€‚è¿™ä¸ä¼šè§¦å‘GuardDutyå‘ç°`ã€‚

å·¥å…·[**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints)è¢«åˆ›å»ºç”¨äºè‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚è¯¥é¡¹ç›®é€šè¿‡Terraformåœ¨ç§æœ‰å­ç½‘ä¸­åˆ›å»ºä¸€ä¸ªæ²¡æœ‰äº’è”ç½‘è®¿é—®æƒé™çš„EC2å®ä¾‹ï¼Œå¹¶ä¸ºæ‚¨åˆ›å»ºå¤šä¸ªVPCç»ˆç«¯èŠ‚ç‚¹ä¾›æ‚¨ä½¿ç”¨ã€‚

**ç»•è¿‡æ­¤è­¦æŠ¥çš„å¦ä¸€ç§æ–¹æ³•**æ˜¯åœ¨è¢«çªƒå–å‡­è¯çš„åŒä¸€å°æœºå™¨ä¸Š**æˆ–è€…åŒä¸€è´¦æˆ·ä¸­çš„å…¶ä»–æœºå™¨ä¸Š**ç®€å•åœ°ä½¿ç”¨çªƒå–çš„å‡­è¯ã€‚

## å‚è€ƒèµ„æ–™

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬**æˆ–ä¸‹è½½**PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
