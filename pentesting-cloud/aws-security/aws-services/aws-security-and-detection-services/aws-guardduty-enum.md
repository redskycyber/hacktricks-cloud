# AWS - Enumera√ß√£o do GuardDuty

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GuardDuty

De acordo com a [**documenta√ß√£o**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **aprendizado de m√°quina, detec√ß√£o de anomalias, monitoramento de rede e descoberta de arquivos maliciosos**, usando fontes tanto da AWS quanto de terceiros l√≠deres do setor para ajudar a proteger cargas de trabalho e dados na AWS. O GuardDuty √© capaz de analisar dezenas de bilh√µes de eventos em v√°rias fontes de dados da AWS, como logs de eventos do AWS CloudTrail, logs de fluxo da Amazon Virtual Private Cloud (VPC), auditoria do Amazon Elastic Kubernetes Service (EKS) e logs de n√≠vel de sistema, e logs de consulta DNS.

O Amazon GuardDuty **identifica atividades incomuns dentro de suas contas**, analisa a **relev√¢ncia de seguran√ßa** da atividade e fornece o **contexto** no qual foi invocado. Isso permite que um respondedor determine se deve gastar tempo em investiga√ß√µes adicionais.

Alertas **aparecem no console do GuardDuty (90 dias)** e nos Eventos do CloudWatch.

{% hint style="warning" %}
Quando um usu√°rio **desativa o GuardDuty**, ele deixar√° de monitorar seu ambiente AWS e n√£o gerar√° novas descobertas, e as **descobertas existentes ser√£o perdidas**.\
Se voc√™ apenas parar, as descobertas existentes permanecer√£o.
{% endhint %}

### Exemplo de Descobertas

* **Reconhecimento**: Atividade que sugere reconhecimento por um atacante, como **atividade de API incomum**, tentativas de **login** suspeitas em bancos de dados, **varredura de porta** intra-VPC, padr√µes incomuns de solicita√ß√µes de login falhadas, ou sondagem de porta desbloqueada de um IP malicioso conhecido.
* **Comprometimento da inst√¢ncia**: Atividade que indica um comprometimento da inst√¢ncia, como **minera√ß√£o de criptomoedas, atividade de backdoor de comando e controle (C\&C)**, malware usando algoritmos de gera√ß√£o de dom√≠nio (DGA), atividade de nega√ß√£o de servi√ßo de sa√≠da, volume de tr√°fego de rede **muito alto**, protocolos de rede incomuns, comunica√ß√£o de inst√¢ncia de sa√≠da com um IP malicioso conhecido, credenciais tempor√°rias da Amazon EC2 usadas por um endere√ßo IP externo e exfiltra√ß√£o de dados usando DNS.
* **Comprometimento da conta**: Padr√µes comuns indicativos de comprometimento da conta incluem chamadas de API de uma geolocaliza√ß√£o incomum ou proxy de anonimiza√ß√£o, tentativas de desativar o registro do AWS CloudTrail, altera√ß√µes que enfraquecem a pol√≠tica de senha da conta, lan√ßamentos de inst√¢ncia ou infraestrutura incomuns, implanta√ß√µes de infraestrutura em uma regi√£o incomum, roubo de credenciais, atividade suspeita de login em banco de dados e chamadas de API de endere√ßos IP maliciosos conhecidos.
* **Comprometimento do bucket**: Atividade que indica um comprometimento do bucket, como padr√µes de acesso a dados suspeitos indicando uso indevido de credenciais, atividade incomum da API Amazon S3 de um host remoto, acesso n√£o autorizado ao S3 de endere√ßos IP maliciosos conhecidos e chamadas de API para recuperar dados em buckets S3 de um usu√°rio sem hist√≥rico anterior de acesso ao bucket ou invocado de uma localiza√ß√£o incomum. O Amazon GuardDuty monitora e analisa continuamente os eventos de dados do AWS CloudTrail S3 (por exemplo, GetObject, ListObjects, DeleteObject) para detectar atividades suspeitas em todos os seus buckets do Amazon S3.

<details>

<summary>Informa√ß√µes da Descoberta</summary>

Resumo da descoberta:

* Tipo de descoberta
* Severidade: 7-8.9 Alto, 4-6.9 M√©dio, 01-3.9 Baixo
* Regi√£o
* ID da conta
* ID do recurso
* Hora da detec√ß√£o
* Qual lista de amea√ßas foi usada

O corpo cont√©m estas informa√ß√µes:

* Recurso afetado
* A√ß√£o
* Ator: Endere√ßo IP, porta e dom√≠nio
* Informa√ß√µes adicionais

</details>

### Todas as Descobertas

Acesse uma lista de todas as descobertas do GuardDuty em: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### M√∫ltiplas Contas

#### Por Convite

Voc√™ pode **convidar outras contas** para uma conta diferente do AWS GuardDuty para que **cada conta seja monitorada pelo mesmo GuardDuty**. A conta mestra deve convidar as contas de membros e ent√£o o representante da conta de membro deve aceitar o convite.

#### Via Organiza√ß√£o

Voc√™ pode designar qualquer conta dentro da organiza√ß√£o para ser o **administrador delegado do GuardDuty**. Apenas a conta de gerenciamento da organiza√ß√£o pode designar um administrador delegado.

Uma conta designada como administrador delegado se torna uma conta de administrador do GuardDuty, tem o GuardDuty ativado automaticamente na Regi√£o AWS designada e tamb√©m tem a **permiss√£o para ativar e gerenciar o GuardDuty para todas as contas na organiza√ß√£o dentro dessa Regi√£o**. As outras contas na organiza√ß√£o podem ser visualizadas e adicionadas como contas de membros do GuardDuty associadas a essa conta de administrador delegado.

## Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass do GuardDuty

### Orienta√ß√£o Geral

Tente descobrir o m√°ximo poss√≠vel sobre o comportamento das credenciais que voc√™ vai usar:

* Hor√°rios em que s√£o usados
* Localiza√ß√µes
* Agentes de usu√°rio / Servi√ßos (Pode ser usado a partir de awscli, webconsole, lambda...)
* Permiss√µes regularmente usadas

Com essas informa√ß√µes, recrie o cen√°rio o m√°ximo poss√≠vel para usar o acesso:

* Se for um **usu√°rio ou uma fun√ß√£o acessada por um usu√°rio**, tente us√°-lo nas mesmas horas, da mesma geolocaliza√ß√£o (at√© mesmo o mesmo ISP e IP, se poss√≠vel)
* Se for uma **fun√ß√£o usada por um servi√ßo**, crie o mesmo servi√ßo na mesma regi√£o e use-o de l√° nos mesmos intervalos de tempo
* Sempre tente usar as **mesmas permiss√µes** que esse principal usou
* Se precisar **usar outras permiss√µes ou abusar de uma permiss√£o** (por exemplo, baixar 1.000.000 de arquivos de log do CloudTrail), fa√ßa isso **devagar** e com a **quantidade m√≠nima de intera√ß√µes** com a AWS (awscli √†s vezes chama v√°rias APIs de leitura antes da de escrita)

### Quebrando o GuardDuty

#### `guardduty:UpdateDetector`

Com essa permiss√£o, voc√™ pode desativar o GuardDuty para evitar acionar alertas.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Os atacantes com essa permiss√£o t√™m a capacidade de **utilizar filtros para o arquivamento autom√°tico** de descobertas:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Atacantes com os privil√©gios anteriores poderiam modificar a [**lista de IPs confi√°veis**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) do GuardDuty adicionando seu endere√ßo IP a ela e evitando assim a gera√ß√£o de alertas.
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Os atacantes poderiam remover o destino para evitar alertas:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Excluir este destino de publica√ß√£o **n√£o afetar√° a gera√ß√£o ou visibilidade das descobertas dentro do console GuardDuty**. O GuardDuty continuar√° a analisar eventos em seu ambiente AWS, identificar comportamentos suspeitos ou inesperados e gerar descobertas.
{% endhint %}

### Exemplos de Bypass de Descobertas Espec√≠ficas

Observe que existem dezenas de descobertas do GuardDuty, no entanto, **como Red Teamer nem todas elas ir√£o afet√°-lo**, e o que √© melhor, voc√™ tem a **documenta√ß√£o completa de cada uma delas** em [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) ent√£o d√™ uma olhada antes de tomar qualquer a√ß√£o para n√£o ser pego.

Aqui est√£o alguns exemplos de bypass de descobertas espec√≠ficas do GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

O GuardDuty detecta solicita√ß√µes de API da AWS de ferramentas comuns de teste de penetra√ß√£o e aciona uma [Descoberta de PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
√â detectado pelo **nome do agente do usu√°rio** que √© passado na solicita√ß√£o da API.\
Portanto, **modificando o agente do usu√°rio** √© poss√≠vel evitar que o GuardDuty detecte o ataque.

Para evitar isso, voc√™ pode procurar o script `session.py` no pacote `botocore` e modificar o agente do usu√°rio, ou configurar o Burp Suite como proxy do AWS CLI e alterar o user-agent com o MitM ou simplesmente usar um sistema operacional como Ubuntu, Mac ou Windows para evitar que este alerta seja acionado.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Extrair credenciais do EC2 do servi√ßo de metadados e **utiliz√°-las fora** do ambiente AWS ativa o alerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Por outro lado, usar essas credenciais de sua inst√¢ncia EC2 aciona o alerta [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). No entanto, **usar as credenciais em outra inst√¢ncia EC2 comprometida dentro da mesma conta passa despercebido**, n√£o acionando nenhum alerta.

{% hint style="success" %}
Portanto, **utilize as credenciais exfiltradas de dentro da m√°quina** onde voc√™ as encontrou para n√£o acionar este alerta.
{% endhint %}

## Refer√™ncias

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
