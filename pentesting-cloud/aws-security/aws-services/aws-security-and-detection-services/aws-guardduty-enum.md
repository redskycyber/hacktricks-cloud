# AWS - GuardDuty Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## GuardDuty

Gem√§√ü den [**Dokumenten**](https://aws.amazon.com/guardduty/features/): GuardDuty kombiniert **Maschinelles Lernen, Anomalieerkennung, Netzwerk√ºberwachung und Entdeckung b√∂sartiger Dateien**, unter Verwendung sowohl von AWS als auch von branchenf√ºhrenden Drittanbieterquellen, um Workloads und Daten auf AWS zu sch√ºtzen. GuardDuty ist in der Lage, zehn Milliarden Ereignisse √ºber mehrere AWS-Datenquellen zu analysieren, wie z.B. AWS CloudTrail-Ereignisprotokolle, Amazon Virtual Private Cloud (VPC) Flow-Protokolle, Amazon Elastic Kubernetes Service (EKS) Audit- und Systemprotokolle sowie DNS-Abfrageprotokolle.

Amazon GuardDuty **identifiziert ungew√∂hnliche Aktivit√§ten innerhalb Ihrer Konten**, analysiert die **Sicherheitsrelevanz** der Aktivit√§t und gibt den **Kontext** an, in dem sie aufgerufen wurde. Dies erm√∂glicht einem Responder zu bestimmen, ob sie Zeit f√ºr weitere Untersuchungen aufwenden sollten.

Warnungen **erscheinen in der GuardDuty-Konsole (90 Tage)** und CloudWatch-Ereignissen.

{% hint style="warning" %}
Wenn ein Benutzer **GuardDuty deaktiviert**, wird die √úberwachung Ihrer AWS-Umgebung eingestellt und es werden keine neuen Erkenntnisse generiert, und die **bestehenden Erkenntnisse gehen verloren**.\
Wenn Sie es nur stoppen, bleiben die bestehenden Erkenntnisse erhalten.
{% endhint %}

### Beispiel f√ºr Erkenntnisse

* **Aufkl√§rung**: Aktivit√§ten, die auf eine Aufkl√§rung durch einen Angreifer hinweisen, wie **ungew√∂hnliche API-Aktivit√§ten**, verd√§chtige Datenbank-**Anmeldeversuche**, intra-VPC-**Portscans**, ungew√∂hnliche fehlgeschlagene Anmeldeanforderungsmuster oder unblockiertes Port-Scannen von einer bekannten schlechten IP.
* **Instanzkompromittierung**: Aktivit√§ten, die auf eine Instanzkompromittierung hinweisen, wie **Kryptow√§hrungs-Mining, Backdoor-Befehls- und Kontrollaktivit√§ten (C\&C)**, Malware, die Dom√§nengenerierungsalgorithmen (DGA) verwendet, ausgehender Denial-of-Service-Verkehr, ungew√∂hnlich **hoher Netzwerk**-Datenverkehr, ungew√∂hnliche Netzwerkprotokolle, ausgehende Instanzkommunikation mit einer bekannten b√∂sartigen IP, vor√ºbergehend verwendete Amazon EC2-Anmeldeinformationen von einer externen IP-Adresse und Datenexfiltration √ºber DNS.
* **Kontokompromittierung**: H√§ufige Muster, die auf eine Kontokompromittierung hinweisen, sind API-Aufrufe aus einer ungew√∂hnlichen Geolokalisierung oder einem anonymisierenden Proxy, Versuche, das AWS CloudTrail-Logging zu deaktivieren, √Ñnderungen, die die Kontopasswortrichtlinie schw√§chen, ungew√∂hnliche Instanz- oder Infrastrukturstarts, Infrastrukturbereitstellungen in einer ungew√∂hnlichen Region, Diebstahl von Anmeldeinformationen, verd√§chtige Datenbankanmeldeaktivit√§ten und API-Aufrufe von bekannten b√∂sartigen IP-Adressen.
* **Bucket-Kompromittierung**: Aktivit√§ten, die auf eine Bucket-Kompromittierung hinweisen, wie verd√§chtige Datenzugriffsmuster, die auf den Missbrauch von Anmeldeinformationen hinweisen, ungew√∂hnliche Amazon S3-API-Aktivit√§ten von einem Remote-Host, unberechtigter S3-Zugriff von bekannten b√∂sartigen IP-Adressen und API-Aufrufe zum Abrufen von Daten in S3-Buckets von einem Benutzer ohne vorherige Historie des Zugriffs auf den Bucket oder von einem ungew√∂hnlichen Standort aus. Amazon GuardDuty √ºberwacht und analysiert kontinuierlich AWS CloudTrail S3-Datenereignisse (z.B. GetObject, ListObjects, DeleteObject), um verd√§chtige Aktivit√§ten in allen Ihren Amazon S3-Buckets zu erkennen.

<details>

<summary>Erkenntnisinformationen</summary>

Zusammenfassung der Erkenntnisse:

* Erkenntnistyp
* Schweregrad: 7-8,9 Hoch, 4-6,9 Mittel, 01-3,9 Niedrig
* Region
* Kontonummer
* Ressourcen-ID
* Erkennungszeitpunkt
* Welche Bedrohungsliste wurde verwendet

Der Inhalt enth√§lt diese Informationen:

* Betroffene Ressource
* Aktion
* Akteur: IP-Adresse, Port und Domain
* Zus√§tzliche Informationen

</details>

### Alle Erkenntnisse

Zugriff auf eine Liste aller GuardDuty-Erkenntnisse unter: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Mehrere Konten

#### Durch Einladung

Sie k√∂nnen **andere Konten zu einem anderen AWS GuardDuty-Konto einladen, sodass jedes Konto von derselben GuardDuty √ºberwacht wird**. Das Masterkonto muss die Mitgliedskonten einladen, und dann muss der Vertreter des Mitgliedskontos die Einladung akzeptieren.

#### √úber Organisation

Sie k√∂nnen jedes Konto innerhalb der Organisation als **GuardDuty-Delegationsadministrator** festlegen. Nur das Organisationsmanagementkonto kann einen delegierten Administrator bestimmen.

Ein Konto, das als delegierter Administrator festgelegt wird, wird zu einem GuardDuty-Administrator-Konto, bei dem GuardDuty automatisch in der festgelegten AWS-Region aktiviert wird und auch die **Berechtigung hat, GuardDuty f√ºr alle Konten in der Organisation in dieser Region zu aktivieren und zu verwalten**. Die anderen Konten in der Organisation k√∂nnen als GuardDuty-Mitgliedskonten angesehen und diesem delegierten Administrator-Konto zugeordnet werden.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Umgehung

### Allgemeine Anleitung

Versuchen Sie, so viel wie m√∂glich √ºber das Verhalten der Anmeldeinformationen herauszufinden, die Sie verwenden werden:

* Zeiten, zu denen sie verwendet werden
* Standorte
* Benutzeragenten / Dienste (Es k√∂nnte von awscli, Webkonsole, Lambda verwendet werden...)
* Regelm√§√üig verwendete Berechtigungen

Mit diesen Informationen erstellen Sie so weit wie m√∂glich das gleiche Szenario, um auf die Ressourcen zuzugreifen:

* Wenn es sich um einen **Benutzer oder eine Rolle handelt, auf die ein Benutzer zugegriffen hat**, versuchen Sie, sie zu den gleichen Zeiten zu verwenden, vom gleichen Standort aus (sogar denselben ISP und dieselbe IP, wenn m√∂glich)
* Wenn es sich um eine **Rolle handelt, die von einem Dienst verwendet wird**, erstellen Sie denselben Dienst in derselben Region und verwenden Sie ihn von dort zu den gleichen Zeitbereichen
* Versuchen Sie immer, die **gleichen Berechtigungen** zu verwenden, die dieser Hauptbenutzer verwendet hat
* Wenn Sie **andere Berechtigungen verwenden m√ºssen oder eine Berechtigung missbrauchen** m√ºssen (zum Beispiel das Herunterladen von 1.000.000 CloudTrail-Protokolldateien), tun Sie dies **langsam** und mit der **mindesten Anzahl von Interaktionen** mit AWS (awscli ruft manchmal mehrere Lese-APIs auf, bevor der Schreibvorgang erfolgt)

### Umgehen von GuardDuty

#### `guardduty:UpdateDetector`

Mit dieser Berechtigung k√∂nnten Sie GuardDuty deaktivieren, um das Ausl√∂sen von Warnmeldungen zu vermeiden.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Angreifer mit dieser Berechtigung haben die M√∂glichkeit, **Filter f√ºr das automatische** Archivieren von Ergebnissen zu erstellen:

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
{% endcode %}

#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Angreifer mit den zuvor genannten Berechtigungen k√∂nnten die [**Vertrauensw√ºrdige IP-Liste**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) von GuardDuty √§ndern, indem sie ihre IP-Adresse hinzuf√ºgen und so vermeiden, dass Alarme ausgel√∂st werden.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
{% endcode %}

#### `guardduty:DeletePublishingDestination`

Angreifer k√∂nnten das Ziel entfernen, um die Benachrichtigung zu verhindern:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Das L√∂schen dieses Ver√∂ffentlichungsziels hat **keinen Einfluss auf die Generierung oder Sichtbarkeit von Ergebnissen innerhalb der GuardDuty-Konsole**. GuardDuty wird weiterhin Ereignisse in Ihrer AWS-Umgebung analysieren, verd√§chtiges oder unerwartetes Verhalten identifizieren und Ergebnisse generieren.
{% endhint %}

### Beispiele f√ºr spezifische Umgehungen von Ergebnissen

Beachten Sie, dass es dutzende von GuardDuty-Ergebnissen gibt, jedoch **werden als Red Teamer nicht alle von ihnen Sie betreffen**, und was noch besser ist, Sie haben die **vollst√§ndige Dokumentation** jedes einzelnen unter [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html), also schauen Sie sich diese an, bevor Sie Ma√ünahmen ergreifen, um nicht erwischt zu werden.

Hier sind ein paar Beispiele f√ºr spezifische Umgehungen von GuardDuty-Ergebnissen:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty erkennt AWS-API-Anfragen von g√§ngigen Penetrationstest-Tools und l√∂st ein [PenTest-Ergebnis](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) aus.\
Es wird durch den **User-Agent-Namen** erkannt, der in der API-Anfrage √ºbergeben wird.\
Daher ist es m√∂glich, GuardDuty daran zu hindern, den Angriff zu erkennen, indem man **den User-Agent modifiziert**.

Um dies zu verhindern, k√∂nnen Sie das Skript `session.py` im Paket `botocore` durchsuchen und den User-Agent modifizieren, oder Burp Suite als Proxy f√ºr die AWS CLI einrichten und den User-Agent mit MitM √§ndern oder einfach ein Betriebssystem wie Ubuntu, Mac oder Windows verwenden, um zu verhindern, dass dieser Alarm ausgel√∂st wird.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Das Extrahieren von EC2-Anmeldeinformationen aus dem Metadatendienst und **der Einsatz au√üerhalb** der AWS-Umgebung aktiviert den Alarm [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Im Gegensatz dazu l√∂st der Einsatz dieser Anmeldeinformationen von Ihrer EC2-Instanz aus den Alarm [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) aus. **Die Verwendung der Anmeldeinformationen auf einer anderen kompromittierten EC2-Instanz im selben Konto bleibt unentdeckt**, ohne einen Alarm auszul√∂sen.

{% hint style="success" %}
Verwenden Sie daher die extrahierten Anmeldeinformationen innerhalb der Maschine, in der Sie sie gefunden haben, um diesen Alarm nicht auszul√∂sen.
{% endhint %}

## Referenzen

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen** oder **HackTricks als PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
