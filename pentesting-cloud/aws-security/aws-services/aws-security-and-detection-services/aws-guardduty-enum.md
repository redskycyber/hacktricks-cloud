# AWS - Enumeraci贸n de GuardDuty

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## GuardDuty

Amazon GuardDuty es un servicio de detecci贸n de amenazas inteligente basado en regiones, el primero de su tipo ofrecido por AWS, que permite a los usuarios **monitorear** su **cuenta de AWS** en busca de **comportamientos inusuales e inesperados analizando los registros de flujo de VPC, los registros de eventos de administraci贸n de AWS CloudTrail, los registros de eventos de datos de S3 de CloudTrail y los registros de DNS**. Utiliza **fuentes de inteligencia de amenazas**, como listas de direcciones IP y dominios maliciosos, y **aprendizaje autom谩tico** para identificar **actividades inesperadas y potencialmente no autorizadas y maliciosas** dentro de su entorno de AWS. Esto puede incluir problemas como escalaciones de privilegios, uso de credenciales expuestas o comunicaci贸n con direcciones IP o dominios maliciosos.

Las alertas **aparecen en la consola de GuardDuty (90 d铆as)** y en los eventos de CloudWatch.

Por ejemplo, GuardDuty puede detectar instancias de **EC2 comprometidas que sirven malware o realizan miner铆a** de bitcoin. Tambi茅n monitorea el **comportamiento de acceso a la cuenta de AWS en busca de signos de compromiso**, como implementaciones de infraestructura no autorizadas, como instancias implementadas en una **regi贸n que nunca se ha utilizado**, o **llamadas API inusuales**, como un cambio de pol铆tica de contrase帽a para reducir la fuerza de la contrase帽a.\
Puede **cargar una lista de direcciones IP permitidas y denegadas** para que GuardDuty tenga en cuenta esa informaci贸n.

Resumen de los hallazgos:

* Tipo de hallazgo
* Gravedad: 7-8.9Alta, 4-6.9Media, 01-3.9Baja
* Regi贸n
* ID de cuenta
* ID de recurso
* Hora de detecci贸n
* Qu茅 lista de amenazas se utiliz贸

El cuerpo tiene esta informaci贸n:

* Recurso afectado
* Acci贸n
* Actor: direcci贸n IP, puerto y dominio
* Informaci贸n adicional

Puede **invitar a otras cuentas** a una cuenta de AWS GuardDuty diferente para que **cada cuenta sea monitoreada desde el mismo GuardDuty**. La cuenta principal debe invitar a las cuentas de miembros y luego el representante de la cuenta de miembro debe aceptar la invitaci贸n.\
Existen diferentes permisos de rol de IAM para permitir que GuardDuty obtenga la informaci贸n y para permitir que un usuario **cargue direcciones IP permitidas y denegadas**.\
GuarDuty utiliza un rol vinculado al servicio llamado "AWSServiceRoleForAmazonGuardDuty" que le permite recuperar metadatos de los puntos finales afectados.

Paga por el procesamiento de tus archivos de registro, por cada mill贸n de eventos por mes de CloudTrail y por GB de registros analizados de VPC Flow.

Cuando un usuario **deshabilita GuardDuty**, dejar谩 de monitorear su entorno de AWS y no generar谩 nuevos hallazgos en absoluto, y los **hallazgos existentes se perder谩n**.\
Si simplemente lo detiene, los hallazgos existentes permanecer谩n.

## Acciones

### Enumeraci贸n

```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```

## Evitar la detecci贸n

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Con esos permisos, podr铆a deshabilitar GuardDuty para evitar activar alertas.

```bash
# Deshabilitar el detector
aws guardduty update-detector \
    --detector-id <detector-id> \
    --no-enable 

# Eliminar s3 como fuente de registro
aws guardduty update-detector \
    --detector-id <detector-id> \
    --data-sources S3Logs={Enable=false}

# Aumentar el tiempo de actualizaci贸n de hallazgos a 6 horas
aws guardduty update-detector \
    --detector-id <detector-id> \
    --finding-publishing-frequency SIX_HOURS
```

### `guardduty:ListDetectors`, `guardduty:
### Detecci贸n de Exfiltraci贸n de Credenciales

Si se **roban credenciales de EC2** del servicio de metadatos y se usan **fuera de la infraestructura de AWS**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws).

Adem谩s, si se **utiliza una instancia EC2 propia** para usar las **credenciales robadas**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws).

Sin embargo, actualmente hay un bypass funcional para esto - [Puntos de conexi贸n de VPC](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). El uso de **Puntos de conexi贸n de VPC** no activar谩 la alerta de GuardDuty. Lo que significa que, como atacante, `si se roban credenciales IAM de una instancia EC2, se pueden usar esas credenciales desde su propia instancia EC2 mientras se enruta el tr谩fico a trav茅s de Puntos de conexi贸n de VPC. Esto no activar谩 la alerta de GuardDuty`.

La herramienta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) fue creada para automatizar este proceso. Este proyecto **crea un entorno para atacar a trav茅s de Terraform**. Crear谩 una instancia EC2 en una subred privada sin acceso a Internet y crear谩 varios puntos de conexi贸n de VPC para que los use.

**Otra forma de evitar esta alerta** es simplemente usar las credenciales robadas en la misma m谩quina donde se robaron **o en una de la misma cuenta.**

## Referencias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>