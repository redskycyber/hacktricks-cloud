# AWS - GuardDuty Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GuardDuty

Zgodnie z [**dokumentacj**](https://aws.amazon.com/guardduty/features/): GuardDuty czy w sobie **uczenie maszynowe, wykrywanie anomalii, monitorowanie sieci i odkrywanie zoliwych plik贸w**, korzystajc zar贸wno z usug AWS, jak i z wiodcych 藕r贸de zewntrznych, aby pom贸c w ochronie obci偶e i danych w AWS. GuardDuty jest zdolny do analizowania dziesitek miliard贸w zdarze z r贸偶nych 藕r贸de danych AWS, takich jak dzienniki zdarze AWS CloudTrail, dzienniki przepywu Amazon Virtual Private Cloud (VPC) Flow Logs, audyt i dzienniki systemowe Amazon Elastic Kubernetes Service (EKS) oraz dzienniki zapyta DNS.

Amazon GuardDuty **identyfikuje nietypow aktywno w Twoich kontach**, analizuje **istotno z punktu widzenia bezpieczestwa** tej aktywnoci i podaje **kontekst**, w jakim zostaa wywoana. Pozwala to osobie reagujcej okreli, czy powinna powici czas na dalsze dochodzenie.

Alerty **pojawiaj si w konsoli GuardDuty (90 dni)** i w CloudWatch Events.

{% hint style="warning" %}
Kiedy u偶ytkownik **wycza GuardDuty**, przestaje on monitorowa rodowisko AWS i nie generuje 偶adnych nowych wynik贸w, a **istniejce wyniki zostan utracone**.\
Jeli go tylko zatrzymasz, istniejce wyniki pozostan.
{% endhint %}

### Przykad wynik贸w

* **Rekonesans**: Aktywno sugerujca rekonesans przez atakujcego, takie jak **nietypowa aktywno API**, podejrzane pr贸by **logowania** do bazy danych, **skanowanie port贸w** wewntrz VPC, nietypowe wzorce nieudanych pr贸b logowania lub sondowanie port贸w z zablokowanego znanego zego IP.
* **Kompromitacja instancji**: Aktywno wskazujca na kompromitacj instancji, tak jak **kopanie kryptowalut, dziaanie backdoor贸w i kontrola (C\&C)**, zoliwe oprogramowanie korzystajce z algorytm贸w generowania domen (DGA), dziaanie odmowy usugi na zewntrz, niezwykle **wysoki ruch sieciowy**, nietypowe protokoy sieciowe, komunikacja instancji z znanym zoliwym IP, tymczasowe powiadczenia Amazon EC2 u偶ywane przez zewntrzny adres IP oraz wyciek danych za pomoc DNS.
* **Kompromitacja konta**: Powszechne wzorce wskazujce na kompromitacj konta obejmuj wywoania API z nietypowej lokalizacji lub z anonimizujcego serwera proxy, pr贸by wyczenia logowania AWS CloudTrail, zmiany osabiajce polityk hasa konta, nietypowe uruchomienia instancji lub infrastruktury, wdro偶enia infrastruktury w nietypowym regionie, kradzie偶 powiadcze, podejrzana aktywno logowania do bazy danych oraz wywoania API z znanych zoliwych adres贸w IP.
* **Kompromitacja kubeka**: Aktywno wskazujca na kompromitacj kubeka, tak jak podejrzane wzorce dostpu do danych wskazujce na nadu偶ycie powiadcze, nietypowa aktywno API Amazon S3 z zdalnego hosta, nieautoryzowany dostp do S3 z znanych zoliwych adres贸w IP oraz wywoania API w celu pobrania danych z kubek贸w S3 przez u偶ytkownika, kt贸ry wczeniej nie mia historii dostpu do kubeka lub wywoane z nietypowej lokalizacji. Amazon GuardDuty cigle monitoruje i analizuje zdarzenia danych AWS CloudTrail S3 (np. GetObject, ListObjects, DeleteObject), aby wykrywa podejrzan aktywno we wszystkich kubekach Amazon S3.

<details>

<summary>Informacje o wynikach</summary>

Podsumowanie wyniku:

* Typ wyniku
* Powaga: 7-8.9 Wysoka, 4-6.9 rednia, 01-3.9 Niska
* Region
* ID konta
* ID zasobu
* Czas wykrycia
* Kt贸ra lista zagro偶e zostaa u偶yta

W treci znajduj si nastpujce informacje:

* Dotknity zas贸b
* Akcja
* Aktor: Adres IP, port i domena
* Dodatkowe informacje

</details>

### Wszystkie wyniki

Dostp do listy wszystkich wynik贸w GuardDuty mo偶na uzyska pod adresem: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Wielokrotne konta

#### Przez zaproszenie

Mo偶esz **zaprosi inne konta** do innego konta AWS GuardDuty, aby **ka偶de konto byo monitorowane z tego samego GuardDuty**. Konto g贸wne musi zaprosi konta czonkowskie, a nastpnie przedstawiciel konta czonkowskiego musi zaakceptowa zaproszenie.

#### Przez organizacj

Mo偶esz wyznaczy dowolne konto w organizacji jako **delegowany administrator GuardDuty**. Tylko konto zarzdzajce organizacj mo偶e wyznaczy delegowanego administratora.

Konto, kt贸re zostanie wyznaczone jako delegowany administrator, staje si kontem administratora GuardDuty, automatycznie wcza GuardDuty w wyznaczonym regionie AWS i ma r贸wnie偶 **uprawnienia do wczania i zarzdzania GuardDuty dla wszystkich kont w organizacji w tym regionie**. Inne konta w organizacji mog by wywietlane i dodawane jako konta czonkowskie GuardDuty powizane z tym kontem delegowanego administratora.

## Wyliczanie

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass GuardDuty

### Og贸lne wskaz贸wki

Spr贸buj dowiedzie si jak najwicej o zachowaniu u偶ywanych przez Ciebie powiadcze:

* Czstotliwo ich u偶ycia
* Lokalizacje
* Agenty u偶ytkownika / Usugi (Mo偶e by u偶ywane z awscli, webconsole, lambda...)
* Regularnie u偶ywane uprawnienia

Na podstawie tych informacji, odtw贸rz jak najwicej scenariuszy, aby uzyska dostp:

* Jeli jest to **u偶ytkownik lub rola dostpna przez u偶ytkownika**, spr贸buj u偶y jej o tej samej godzinie, z tej samej lokalizacji (nawet tego samego dostawcy usug internetowych i adresu IP, jeli to mo偶liwe)
* Jeli jest to **rola u偶ywana przez usug**, utw贸rz t sam usug w tej samej regionie i u偶yj jej w tym samym przedziale czasowym
* Zawsze spr贸buj u偶y **tych samych uprawnie**, kt贸re u偶ywa ten podmiot
* Jeli musisz **u偶y innych uprawnie lub nadu偶y uprawnienia** (na przykad pobierz 1 000 000 plik贸w dziennika cloudtrail), zr贸b to **powoli** i z **minimaln iloci interakcji** z AWS (czasami awscli wywouje kilka operacji odczytu przed operacj zapisu)

### Omijanie GuardDuty

#### `guardduty:UpdateDetector`

Z tym uprawnieniem mo偶esz wyczy GuardDuty, aby unikn wywoywania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

Atakujcy posiadajcy to uprawnienie maj mo偶liwo **u偶ywania filtr贸w do automatycznego** archiwizowania wynik贸w: 

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Atakujcy posiadajcy wczeniej wymienione uprawnienia mog modyfikowa [**list zaufanych adres贸w IP**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) w GuardDuty, dodajc do niej sw贸j adres IP i unikajc generowania alert贸w.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

Atakujcy mog usun cel, aby zapobiec generowaniu alert贸w:

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Usunicie tego miejsca publikacji **nie wpynie na generowanie ani widoczno wynik贸w w konsoli GuardDuty**. GuardDuty bdzie nadal analizowa zdarzenia w Twoim rodowisku AWS, identyfikowa podejrzane lub nieoczekiwane zachowanie i generowa wyniki.
{% endhint %}

### Konkretne Przykady Unikania Wykrycia

Nale偶y zauwa偶y, 偶e istnieje wiele wynik贸w GuardDuty, jednak **jako Red Teamer nie wszystkie z nich bd miay na Ciebie wpyw**, a co lepsze, masz **pen dokumentacj ka偶dego z nich** na stronie [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html), wic zerknij na ni przed podjciem jakiejkolwiek akcji, aby nie zosta wykrytym.

Oto kilka przykad贸w unikania wykrycia konkretnych wynik贸w GuardDuty:

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty wykrywa 偶dania interfejsu API AWS z popularnych narzdzi do testowania penetracyjnego i wywouje wynik [PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Jest to wykrywane przez **nazw agenta u偶ytkownika**, kt贸ra jest przekazywana w 偶daniu interfejsu API.\
W zwizku z tym, **zmieniajc agenta u偶ytkownika**, mo偶na zapobiec wykryciu ataku przez GuardDuty.

Aby temu zapobiec, mo偶na wyszuka skrypt `session.py` w pakiecie `botocore` i zmodyfikowa agenta u偶ytkownika, lub ustawi Burp Suite jako proxy AWS CLI i zmieni agenta u偶ytkownika za pomoc MitM, lub po prostu u偶y systemu operacyjnego takiego jak Ubuntu, Mac lub Windows, aby unikn wywoania tego alertu.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Wyodrbnianie powiadcze EC2 z usugi metadanych i **u偶ywanie ich poza** rodowiskiem AWS aktywuje alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). Natomiast u偶ycie tych powiadcze z instancji EC2 wywouje alert [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Jednak **u偶ycie powiadcze na innej skompromitowanej instancji EC2 w ramach tego samego konta pozostaje niewykryte**, nie wywoujc 偶adnego alertu.

{% hint style="success" %}
Dlatego **u偶ywaj wydobytych powiadcze wewntrz maszyny**, w kt贸rej je znalaze, aby nie wywoywa tego alertu.
{% endhint %}

## Odwoania

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Uzyskaj [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
