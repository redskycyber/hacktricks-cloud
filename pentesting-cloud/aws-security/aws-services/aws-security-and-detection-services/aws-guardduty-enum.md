# AWS - Enumeraci칩n de GuardDuty

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## GuardDuty

Seg칰n la [**documentaci칩n**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **aprendizaje autom치tico, detecci칩n de anomal칤as, monitoreo de red y descubrimiento de archivos maliciosos**, utilizando tanto fuentes de AWS como de terceros l칤deres en la industria para ayudar a proteger cargas de trabajo y datos en AWS. GuardDuty es capaz de analizar decenas de miles de millones de eventos en m칰ltiples fuentes de datos de AWS, como registros de eventos de AWS CloudTrail, registros de flujo de Amazon Virtual Private Cloud (VPC), auditor칤a de Amazon Elastic Kubernetes Service (EKS) y registros de nivel de sistema, y registros de consultas DNS.

Amazon GuardDuty **identifica actividades inusuales dentro de tus cuentas**, analiza la **relevancia de seguridad** de la actividad y proporciona el **contexto** en el que se invoc칩. Esto permite a un investigador determinar si debe dedicar tiempo a una investigaci칩n adicional.

Las alertas **aparecen en la consola de GuardDuty (90 d칤as)** y en CloudWatch Events.

{% hint style="warning" %}
Cuando un usuario **desactiva GuardDuty**, dejar치 de monitorear tu entorno de AWS y no generar치 nuevos hallazgos en absoluto, y los **hallazgos existentes se perder치n**.\
Si simplemente lo detienes, los hallazgos existentes permanecer치n.
{% endhint %}

### Ejemplo de Hallazgos

* **Reconocimiento**: Actividad que sugiere reconocimiento por parte de un atacante, como actividad de API **inusual**, intentos de inicio de sesi칩n sospechosos en la base de datos, **escaneo de puertos** intra-VPC, patrones inusuales de solicitudes de inicio de sesi칩n fallidas o sondeo de puertos no bloqueados desde una IP conocida como maliciosa.
* **Compromiso de instancia**: Actividad que indica un compromiso de instancia, como miner칤a de criptomonedas, actividad de **comando y control (C&C)** de puerta trasera, malware que utiliza algoritmos de generaci칩n de dominios (DGA), actividad de denegaci칩n de servicio saliente, volumen de tr치fico de red inusualmente **alto**, protocolos de red inusuales, comunicaci칩n de instancia saliente con una IP maliciosa conocida, credenciales temporales de Amazon EC2 utilizadas por una direcci칩n IP externa y exfiltraci칩n de datos utilizando DNS.
* **Compromiso de cuenta**: Patrones comunes que indican un compromiso de cuenta incluyen llamadas de API desde una geolocalizaci칩n inusual o un proxy de anonimizaci칩n, intentos de desactivar el registro de AWS CloudTrail, cambios que debilitan la pol칤tica de contrase침as de la cuenta, lanzamientos de instancia o infraestructura inusuales, implementaciones de infraestructura en una regi칩n inusual, robo de credenciales, actividad de inicio de sesi칩n sospechosa en la base de datos y llamadas de API desde direcciones IP maliciosas conocidas.
* **Compromiso de bucket**: Actividad que indica un compromiso de bucket, como patrones de acceso a datos sospechosos que indican un uso indebido de credenciales, actividad inusual de la API de Amazon S3 desde un host remoto, acceso no autorizado a S3 desde direcciones IP maliciosas conocidas y llamadas de API para recuperar datos en buckets de S3 de un usuario sin historial previo de acceso al bucket o invocadas desde una ubicaci칩n inusual. Amazon GuardDuty monitorea y analiza continuamente los eventos de datos de AWS CloudTrail S3 (por ejemplo, GetObject, ListObjects, DeleteObject) para detectar actividad sospechosa en todos tus buckets de Amazon S3.

<details>

<summary>Informaci칩n del Hallazgo</summary>

Resumen del hallazgo:

* Tipo de hallazgo
* Gravedad: 7-8.9 Alta, 4-6.9 Media, 01-3.9 Baja
* Regi칩n
* ID de cuenta
* ID de recurso
* Hora de detecci칩n
* Lista de amenazas utilizada

El cuerpo contiene esta informaci칩n:

* Recurso afectado
* Acci칩n
* Actor: direcci칩n IP, puerto y dominio
* Informaci칩n adicional

</details>

### Todos los Hallazgos

Accede a una lista de todos los hallazgos de GuardDuty en: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### M칰ltiples Cuentas

#### Por Invitaci칩n

Puedes **invitar a otras cuentas** a una cuenta de AWS GuardDuty diferente para que **todas las cuentas sean monitoreadas desde el mismo GuardDuty**. La cuenta principal debe invitar a las cuentas miembro y luego el representante de la cuenta miembro debe aceptar la invitaci칩n.

#### A trav칠s de la Organizaci칩n

Puedes designar cualquier cuenta dentro de la organizaci칩n como el **administrador delegado de GuardDuty**. Solo la cuenta de administraci칩n de la organizaci칩n puede designar un administrador delegado.

Una cuenta que se designa como administrador delegado se convierte en una cuenta de administrador de GuardDuty, tiene GuardDuty habilitado autom치ticamente en la regi칩n de AWS designada y tambi칠n tiene el **permiso para habilitar y administrar GuardDuty para todas las cuentas de la organizaci칩n dentro de esa regi칩n**. Las dem치s cuentas de la organizaci칩n pueden ser vistas y agregadas como cuentas miembro de GuardDuty asociadas con esta cuenta de administrador delegado.

## Enumeraci칩n

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass de GuardDuty

### Orientaci칩n general

Trate de averiguar todo lo posible sobre el comportamiento de las credenciales que va a utilizar:

* Veces que se utiliza
* Ubicaciones
* Agentes de usuario / Servicios (puede ser utilizado desde awscli, webconsole, lambda...)
* Permisos utilizados regularmente

Con esta informaci칩n, intente recrear tanto como sea posible el mismo escenario para utilizar el acceso:

* Si es un **usuario o un rol al que accede un usuario**, intente usarlo en las mismas horas, desde la misma geolocalizaci칩n (incluso el mismo ISP y IP si es posible)
* Si es un **rol utilizado por un servicio**, cree el mismo servicio en la misma regi칩n y 칰selo desde all칤 en los mismos rangos de tiempo
* Siempre intente usar los **mismos permisos** que ha utilizado este principal&#x20;
* Si necesita **utilizar otros permisos o abusar de un permiso** (por ejemplo, descargar 1.000.000 de archivos de registro de CloudTrail), h치galo **lentamente** y con la **cantidad m칤nima de interacciones** con AWS (awscli a veces llama a varias API de lectura antes de la de escritura)

### Modificar GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Con esos permisos, podr칤a desactivar GuardDuty para evitar activar las alertas.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Un atacante podr칤a crear o actualizar la [lista de IP confiables](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) de GuardDuty, incluyendo **su propia IP en la lista**. Cualquier IP en una lista de IP confiables **no generar치 alertas de Cloudtrail o VPC flow log**.

{% hint style="info" %}
Los hallazgos de DNS est치n exentos de la lista de IP confiables.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Dependiendo del nivel de sigilo requerido, el archivo puede ser cargado en un bucket s3 en la cuenta objetivo, o en una cuenta controlada por el atacante.
{% endhint %}

#### `guardduty:CreateFilter`

Los hallazgos reci칠n creados de GuardDuty pueden ser autom치ticamente archivados a trav칠s de [Reglas de Supresi칩n](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). Un adversario podr칤a **utilizar** [**filtros**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) **para archivar autom치ticamente los hallazgos** que es probable que generen.

Los filtros pueden ser creados utilizando la API [CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Un adversario podr칤a desactivar la alerta simplemente eliminando el destino de las alertas. [Aqu칤](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) puedes encontrar m치s informaci칩n sobre c칩mo eliminar el destino de las alertas.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
Eliminar este destino de publicaci칩n **no afectar치 la generaci칩n o visibilidad de los hallazgos dentro de la consola de GuardDuty**. GuardDuty continuar치 analizando eventos en su entorno de AWS, identificando comportamientos sospechosos o inesperados y generando hallazgos.
{% endhint %}

### Bypass de Hallazgos Espec칤ficos

#### Hallazgos de Pentest

GuardDuty de OS detecta solicitudes de API de AWS de herramientas comunes de pruebas de penetraci칩n y activa un [Hallazgo de Pentest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Se detecta por el **nombre del agente de usuario** que se pasa en la solicitud de API.\
Por lo tanto, **modificando el agente de usuario** es posible evitar que GuardDuty detecte el ataque.

Usar OS como Ubuntu, Mac o Windows evitar치 que se active esta alerta.

Para evitar esto, puedes buscar en el script `session.py` en el paquete `botocore`. En Kali Linux se encuentra en `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Alrededor de la l칤nea [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) deber칤as ver `platform.system()` y `platform.release()`. Reemplaza este **c칩digo con cadenas de agente de usuario leg칤timas como las que se encuentran en** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### Hallazgos de Cliente Tor

{% hint style="success" %}
La forma m치s f치cil de evitar esto es simplemente **no usar Tor para conectarse a AWS** (쯣or qu칠 usar칤as Tor si quieres permanecer oculto y simular el escenario de las credenciales comprometidas?)
{% endhint %}

Si realizas una conexi칩n desde **Tor**, **Guarduty** establecer치 la alerta [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty detecta esto gracias a una [lista p칰blica de nodos Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Si necesitas conectarte a trav칠s de Tor, puedes **evitar esto utilizando** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). Pero obviamente ser칤a mejor si simplemente no usas Tor en absoluto para conectarte.

Para usar un puente, puedes usar [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) y obtener una direcci칩n de puente de [bridges.torproject.org](https://bridges.torproject.org/options).

A partir de aqu칤, `crea un archivo torrc` con algo similar a:
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Ejecuta `tor -f torrc` y podr치s conectarte al proxy socks5 regular en el puerto 9050.

#### Detecci칩n de Exfiltraci칩n de Credenciales

Si **robas credenciales de EC2** del servicio de metadatos y las utilizas **fuera de la infraestructura de AWS**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws).

Adem치s, si **utilizas tu propia instancia de EC2** para usar las **credenciales robadas**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws).

Sin embargo, actualmente hay un bypass funcional para esto: [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). El uso de **VPC Endpoints** no activar치 la alerta de GuardDuty. Esto significa que, como atacante, `si robas credenciales IAM de una instancia EC2, puedes usar esas credenciales desde tu propia instancia EC2 mientras enrutas el tr치fico a trav칠s de VPC Endpoints. Esto no activar치 el hallazgo de GuardDuty`.

La herramienta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) fue creada para automatizar este proceso. Este proyecto **crea un entorno para atacar a trav칠s de Terraform**. Crear치 una instancia EC2 en una subred privada sin acceso a Internet y crear치 varios VPC Endpoints para que los uses.

**Otra forma de evitar esta alerta** es simplemente usar las credenciales robadas en la misma m치quina donde se robaron **o en una de la misma cuenta**.

## Referencias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, 춰consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
