# AWS - GuardDutyæšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## GuardDuty

Amazon GuardDutyæ˜¯ä¸€ç§åŸºäºåŒºåŸŸçš„æ™ºèƒ½**å¨èƒæ£€æµ‹æœåŠ¡**ï¼Œæ˜¯AWSæä¾›çš„é¦–ä¸ªæ­¤ç±»æœåŠ¡ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡åˆ†æVPCæµæ—¥å¿—ã€AWS CloudTrailç®¡ç†äº‹ä»¶æ—¥å¿—ã€CloudTrail S3æ•°æ®äº‹ä»¶æ—¥å¿—å’ŒDNSæ—¥å¿—æ¥**ç›‘æ§**å…¶**AWSè´¦æˆ·**ä»¥å¯»æ‰¾**å¼‚å¸¸å’Œæ„å¤–è¡Œä¸º**ã€‚å®ƒä½¿ç”¨**å¨èƒæƒ…æŠ¥æº**ï¼Œå¦‚æ¶æ„IPåœ°å€å’ŒåŸŸååˆ—è¡¨ï¼Œä»¥åŠ**æœºå™¨å­¦ä¹ **æ¥è¯†åˆ«AWSç¯å¢ƒä¸­çš„**æ„å¤–å’Œæ½œåœ¨çš„æœªç»æˆæƒå’Œæ¶æ„æ´»åŠ¨**ã€‚è¿™å¯èƒ½åŒ…æ‹¬ç‰¹æƒå‡çº§ã€ä½¿ç”¨æš´éœ²çš„å‡­æ®æˆ–ä¸æ¶æ„IPåœ°å€æˆ–åŸŸåçš„é€šä¿¡ç­‰é—®é¢˜ã€‚

è­¦æŠ¥ä¼š**åœ¨GuardDutyæ§åˆ¶å°ï¼ˆ90å¤©ï¼‰**å’ŒCloudWatchäº‹ä»¶ä¸­æ˜¾ç¤ºã€‚

ä¾‹å¦‚ï¼ŒGuardDutyå¯ä»¥æ£€æµ‹åˆ°è¢«å…¥ä¾µçš„**EC2å®ä¾‹æä¾›æ¶æ„è½¯ä»¶æˆ–è¿›è¡ŒæŒ–çŸ¿**ã€‚å®ƒè¿˜ç›‘æ§AWSè´¦æˆ·çš„**è®¿é—®è¡Œä¸ºä»¥å¯»æ‰¾è¢«å…¥ä¾µçš„è¿¹è±¡**ï¼Œä¾‹å¦‚æœªç»æˆæƒçš„åŸºç¡€è®¾æ–½éƒ¨ç½²ï¼Œæ¯”å¦‚åœ¨ä»æœªä½¿ç”¨è¿‡çš„**åŒºåŸŸéƒ¨ç½²å®ä¾‹**ï¼Œæˆ–è€…**å¼‚å¸¸çš„APIè°ƒç”¨**ï¼Œæ¯”å¦‚æ›´æ”¹å¯†ç ç­–ç•¥ä»¥é™ä½å¯†ç å¼ºåº¦ã€‚\
æ‚¨å¯ä»¥**ä¸Šä¼ ç™½åå•å’Œé»‘åå•IPåœ°å€åˆ—è¡¨**ï¼Œä»¥ä¾¿GuardDutyè€ƒè™‘è¿™äº›ä¿¡æ¯ã€‚

å‘ç°æ‘˜è¦ï¼š

* å‘ç°ç±»å‹
* ä¸¥é‡ç¨‹åº¦ï¼š7-8.9é«˜ï¼Œ4-6.9ä¸­ï¼Œ01-3.9ä½
* åŒºåŸŸ
* è´¦æˆ·ID
* èµ„æºID
* æ£€æµ‹æ—¶é—´
* ä½¿ç”¨çš„å¨èƒåˆ—è¡¨

æ­£æ–‡åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

* å—å½±å“çš„èµ„æº
* æ“ä½œ
* æ‰§è¡Œè€…ï¼šIPåœ°å€ã€ç«¯å£å’ŒåŸŸå
* é™„åŠ ä¿¡æ¯

æ‚¨å¯ä»¥å°†å…¶ä»–è´¦æˆ·é‚€è¯·åˆ°ä¸åŒçš„AWS GuardDutyè´¦æˆ·ä¸­ï¼Œä»¥ä¾¿ä»åŒä¸€ä¸ªGuardDutyç›‘æ§æ¯ä¸ªè´¦æˆ·ã€‚ä¸»è´¦æˆ·å¿…é¡»é‚€è¯·æˆå‘˜è´¦æˆ·ï¼Œç„¶åæˆå‘˜è´¦æˆ·çš„ä»£è¡¨å¿…é¡»æ¥å—é‚€è¯·ã€‚\
æœ‰ä¸åŒçš„IAMè§’è‰²æƒé™ï¼Œå…è®¸GuardDutyè·å–ä¿¡æ¯å¹¶å…è®¸ç”¨æˆ·**ä¸Šä¼ ç™½åå•å’Œé»‘åå•çš„IPåœ°å€**ã€‚\
GuardDutyä½¿ç”¨åä¸º"AWSServiceRoleForAmazonGuardDuty"çš„æœåŠ¡å…³è”è§’è‰²ï¼Œå…è®¸å…¶ä»å—å½±å“çš„ç«¯ç‚¹æ£€ç´¢å…ƒæ•°æ®ã€‚

æ‚¨éœ€è¦æ”¯ä»˜æ—¥å¿—æ–‡ä»¶å¤„ç†è´¹ç”¨ï¼Œæ¯æœˆæ¯1ç™¾ä¸‡ä¸ªäº‹ä»¶çš„CloudTrailè´¹ç”¨ä»¥åŠåˆ†ææ—¥å¿—çš„VPCæµé‡çš„æ¯GBè´¹ç”¨ã€‚

å½“ç”¨æˆ·**ç¦ç”¨GuardDuty**æ—¶ï¼Œå®ƒå°†åœæ­¢ç›‘æ§æ‚¨çš„AWSç¯å¢ƒï¼Œå¹¶ä¸”ä¸ä¼šç”Ÿæˆä»»ä½•æ–°çš„å‘ç°ï¼Œ**ç°æœ‰çš„å‘ç°å°†ä¸¢å¤±**ã€‚\
å¦‚æœåªæ˜¯åœæ­¢å®ƒï¼Œç°æœ‰çš„å‘ç°å°†ä¿ç•™ã€‚

## æ“ä½œ

### æšä¸¾
```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
## é¿å…è¢«æ£€æµ‹

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

é€šè¿‡è¿™äº›æƒé™ï¼Œæ‚¨å¯ä»¥ç¦ç”¨GuardDutyä»¥é¿å…è§¦å‘è­¦æŠ¥ã€‚
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

æ”»å‡»è€…å¯ä»¥åˆ›å»ºæˆ–æ›´æ–°GuardDutyçš„[å—ä¿¡ä»»IPåˆ—è¡¨](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)ï¼ŒåŒ…æ‹¬å°†**è‡ªå·±çš„IPæ·»åŠ åˆ°åˆ—è¡¨ä¸­**ã€‚åœ¨å—ä¿¡ä»»IPåˆ—è¡¨ä¸­çš„ä»»ä½•IPéƒ½**ä¸ä¼šè§¦å‘ä»»ä½•Cloudtrailæˆ–VPCæµæ—¥å¿—è­¦æŠ¥**ã€‚

{% hint style="info" %}
DNSå‘ç°ä¸å—å—ä¿¡ä»»IPåˆ—è¡¨çš„å½±å“ã€‚
{% endhint %}
```
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
æ ¹æ®æ‰€éœ€çš„éšè”½ç¨‹åº¦ï¼Œæ–‡ä»¶å¯ä»¥ä¸Šä¼ åˆ°ç›®æ ‡è´¦æˆ·çš„s3å­˜å‚¨æ¡¶ä¸­ï¼Œæˆ–è€…ä¸Šä¼ åˆ°æ”»å‡»è€…æ§åˆ¶çš„è´¦æˆ·ä¸­ã€‚
{% endhint %}

### `guardduty:CreateFilter`

æ–°åˆ›å»ºçš„GuardDutyå‘ç°å¯ä»¥é€šè¿‡[æŠ‘åˆ¶è§„åˆ™](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)è‡ªåŠ¨å½’æ¡£ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨[è¿‡æ»¤å™¨](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)æ¥è‡ªåŠ¨å½’æ¡£ä»–ä»¬å¯èƒ½ç”Ÿæˆçš„å‘ç°ã€‚

å¯ä»¥ä½¿ç”¨[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)æ¥åˆ›å»ºè¿‡æ»¤å™¨ã€‚
```
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
### `guardduty:DeletePublishingDestination`

æ”»å‡»è€…å¯ä»¥é€šè¿‡[åˆ é™¤è­¦æŠ¥çš„ç›®æ ‡](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)æ¥ç¦ç”¨è­¦æŠ¥ã€‚
```
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
### æ¸—é€æµ‹è¯•å‘ç°

GuardDutyå¯ä»¥æ£€æµ‹åˆ°å¸¸è§æ¸—é€æµ‹è¯•çš„AWS APIè¯·æ±‚ï¼Œå¹¶è§¦å‘[æ¸—é€æµ‹è¯•å‘ç°](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux)ã€‚\
å®ƒæ˜¯é€šè¿‡APIè¯·æ±‚ä¸­ä¼ é€’çš„**ç”¨æˆ·ä»£ç†åç§°**æ¥æ£€æµ‹çš„ã€‚\
å› æ­¤ï¼Œ**ä¿®æ”¹ç”¨æˆ·ä»£ç†**å¯ä»¥é˜²æ­¢GuardDutyæ£€æµ‹åˆ°æ”»å‡»ã€‚

ä½¿ç”¨Ubuntuã€Macæˆ–Windowsæ“ä½œç³»ç»Ÿå¯ä»¥é˜²æ­¢è§¦å‘æ­¤è­¦æŠ¥ã€‚

è¦é˜²æ­¢æ­¤é—®é¢˜ï¼Œæ‚¨å¯ä»¥åœ¨`botocore`åŒ…ä¸­çš„`session.py`è„šæœ¬ä¸­è¿›è¡Œæœç´¢ã€‚åœ¨Kali Linuxä¸­ï¼Œå®ƒä½äº`/usr/local/lib/python3.7/dist-packages/botocore/session.py`ã€‚

åœ¨[456è¡Œé™„è¿‘](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°`platform.system()`å’Œ`platform.release()`ã€‚å°†æ­¤**ä»£ç æ›¿æ¢ä¸ºåˆæ³•çš„ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚**[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt)**ä¸­çš„å­—ç¬¦ä¸²**ã€‚

### Torå®¢æˆ·ç«¯å‘ç°

å¦‚æœæ‚¨ä½¿ç”¨**Tor**è¿›è¡Œè¿æ¥ï¼Œ**GuardDuty**å°†è®¾ç½®è­¦æŠ¥[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**ã€‚**

GuardDutyé€šè¿‡[å…¬å…±çš„TorèŠ‚ç‚¹åˆ—è¡¨](https://metrics.torproject.org/exonerator.html)æ¥æ£€æµ‹æ­¤é—®é¢˜ã€‚&#x20;

å¦‚æœæ‚¨éœ€è¦é€šè¿‡Torè¿›è¡Œè¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)æ¥**ç»•è¿‡æ­¤é—®é¢˜**ã€‚ä½†æ˜¾ç„¶æœ€å¥½çš„è§£å†³æ–¹æ³•æ˜¯æ ¹æœ¬ä¸ä½¿ç”¨Torè¿›è¡Œè¿æ¥ã€‚

è¦ä½¿ç”¨æ¡¥æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[Obfs4](https://gitlab.com/yawning/obfs4)ï¼ˆ`apt install tor obfs4proxy`ï¼‰å¹¶ä»[bridges.torproject.org](https://bridges.torproject.org/options)è·å–æ¡¥æ¥åœ°å€ã€‚

ä»è¿™é‡Œï¼Œåˆ›å»ºä¸€ä¸ªç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„torrcæ–‡ä»¶ï¼š
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
æœ‰è¶£çš„æ˜¯ï¼Œä½¿ç”¨ `tor -f torrc` å‘½ä»¤å¯ä»¥è¿æ¥åˆ°ç«¯å£ 9050 ä¸Šçš„å¸¸è§„ socks5 ä»£ç†ã€‚

### å‡­è¯æ³„éœ²æ£€æµ‹

å¦‚æœä»å…ƒæ•°æ®æœåŠ¡ä¸­çªƒå–äº† EC2 å‡­è¯å¹¶åœ¨ AWS åŸºç¡€è®¾æ–½ä¹‹å¤–ä½¿ç”¨å®ƒä»¬ï¼Œåˆ™ä¼šè§¦å‘è­¦æŠ¥ [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½¿ç”¨è‡ªå·±çš„ EC2 å®ä¾‹æ¥ä½¿ç”¨è¢«çªƒå–çš„å‡­è¯ï¼Œåˆ™ä¼šè§¦å‘è­¦æŠ¥ [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)ã€‚

ç„¶è€Œï¼Œç›®å‰å­˜åœ¨ä¸€ç§ç»•è¿‡æ­¤è­¦æŠ¥çš„æ–¹æ³• - [VPC ç«¯ç‚¹](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)ã€‚ä½¿ç”¨ **VPC ç«¯ç‚¹** å°†ä¸ä¼šè§¦å‘ GuardDuty è­¦æŠ¥ã€‚è¿™æ„å‘³ç€ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œ`å¦‚æœä½ ä»ä¸€ä¸ª EC2 å®ä¾‹çªƒå–äº† IAM å‡­è¯ï¼Œä½ å¯ä»¥åœ¨é€šè¿‡ VPC ç«¯ç‚¹è·¯ç”±æµé‡çš„åŒæ—¶ï¼Œä½¿ç”¨è¿™äº›å‡­è¯ä»ä½ è‡ªå·±çš„ EC2 å®ä¾‹ä¸­ä½¿ç”¨ã€‚è¿™ä¸ä¼šè§¦å‘ GuardDuty å‘ç°`ã€‚

å·¥å…· [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) æ—¨åœ¨è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚è¯¥é¡¹ç›®é€šè¿‡ Terraform åœ¨ç§æœ‰å­ç½‘ä¸­åˆ›å»ºä¸€ä¸ªæ²¡æœ‰äº’è”ç½‘è®¿é—®æƒé™çš„ EC2 å®ä¾‹ï¼Œå¹¶ä¸ºæ‚¨åˆ›å»ºå¤šä¸ª VPC ç«¯ç‚¹ä¾›æ‚¨ä½¿ç”¨ã€‚

**ç»•è¿‡æ­¤è­¦æŠ¥çš„å¦ä¸€ç§æ–¹æ³•**æ˜¯åœ¨è¢«çªƒå–å‡­è¯çš„åŒä¸€å°æœºå™¨ä¸Šä½¿ç”¨è¿™äº›å‡­è¯**æˆ–è€…åœ¨åŒä¸€è´¦æˆ·ä¸­çš„å¦ä¸€å°æœºå™¨ä¸Šä½¿ç”¨**ã€‚

## å‚è€ƒèµ„æ–™

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricksï¼Œè¯·æŸ¥çœ‹ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
