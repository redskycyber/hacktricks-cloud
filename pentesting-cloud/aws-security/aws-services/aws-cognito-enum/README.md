# AWS - Enumeraci贸n de Cognito

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Cognito

Cognito proporciona **autenticaci贸n, autorizaci贸n y gesti贸n de usuarios** para tus aplicaciones web y m贸viles. Tus usuarios pueden iniciar sesi贸n directamente con un **nombre de usuario y contrase帽a**, o a trav茅s de un **tercero** como Facebook, Amazon, Google o Apple.

Los dos componentes principales de Amazon Cognito son los **grupos de usuarios** y los **grupos de identidades**. Los **grupos de usuarios** son directorios de usuarios que proporcionan **opciones de registro e inicio de sesi贸n para los usuarios de tu aplicaci贸n**. Los **grupos de identidades** te permiten **conceder a tus usuarios acceso a otros servicios de AWS**.

### **Grupos de usuarios**

Para aprender qu茅 es un **Grupo de usuarios de Cognito**, consulta:

{% content-ref url="cognito-user-pools.md" %}
[cognito-user-pools.md](cognito-user-pools.md)
{% endcontent-ref %}

### **Grupos de identidades**

Para aprender qu茅 es un **Grupo de identidades de Cognito**, consulta:

{% content-ref url="cognito-identity-pools.md" %}
[cognito-identity-pools.md](cognito-identity-pools.md)
{% endcontent-ref %}

### M贸dulos de Pacu para pentesting y enumeraci贸n

[Pacu](https://github.com/RhinoSecurityLabs/pacu), el framework de explotaci贸n de AWS, ahora incluye los m贸dulos "cognito__enum" y "cognito__attack" que automatizan la enumeraci贸n de todos los activos de Cognito en una cuenta y detectan configuraciones d茅biles, atributos de usuario utilizados para el control de acceso, etc., y tambi茅n automatizan la creaci贸n de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de grupo de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripci贸n de las funciones de los m贸dulos, consulta la parte 2 de la [publicaci贸n del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para obtener instrucciones de instalaci贸n, consulta la p谩gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

### Uso

Uso de muestra de cognito__attack para intentar la creaci贸n de usuarios y todos los vectores de escalada de privilegios contra un grupo de identidades y un cliente de grupo de usuarios espec铆ficos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de muestra de cognito__enum para recopilar todas las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad, usuarios, etc. visibles en la cuenta actual de AWS:

```bash
$ python3 cognito__enum.py --access-key <AWS_ACCESS_KEY> --secret-key <AWS_SECRET_KEY> --region <AWS_REGION>
```

Este script utiliza las credenciales de acceso y clave secreta de AWS proporcionadas para enumerar y recopilar informaci贸n sobre las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad y usuarios asociados a la cuenta de AWS especificada. Aseg煤rese de reemplazar `<AWS_ACCESS_KEY>`, `<AWS_SECRET_KEY>` y `<AWS_REGION>` con los valores correspondientes.

Una vez que se ejecute el script, se mostrar谩 una lista detallada de las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad y usuarios encontrados en la cuenta de AWS especificada. Esta informaci贸n puede ser 煤til para evaluar la seguridad y configuraci贸n de los servicios de Cognito en la cuenta de AWS.
```bash
Pacu (new:test) > run cognito__enum
```
## Herramienta para pentesting

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta de l铆nea de comandos en Python que implementa diferentes ataques en Cognito, incluyendo enumeraci贸n de cuentas y escalada de privilegios.

### Instalaci贸n
```bash
$ pip install cognito-scanner
```
### Uso

```bash
python3 aws_cognito_enum.py --usernames usernames.txt --pool-id <pool_id> --client-id <client_id> --region <region>
```

### Descripci贸n

Esta herramienta enumera los nombres de usuario v谩lidos en un grupo de usuarios de Amazon Cognito. Utiliza la API de Amazon Cognito para realizar la enumeraci贸n.

### Argumentos

- `--usernames`: Archivo que contiene una lista de nombres de usuario para probar.
- `--pool-id`: ID del grupo de usuarios de Amazon Cognito.
- `--client-id`: ID del cliente de Amazon Cognito.
- `--region`: Regi贸n de Amazon Cognito.

### Ejemplo

```bash
python3 aws_cognito_enum.py --usernames usernames.txt --pool-id us-west-2_ABC123 --client-id 1234567890abcdef1234567890abcdef --region us-west-2
```

### Notas

- Aseg煤rese de tener las credenciales adecuadas para acceder a la API de Amazon Cognito.
- Esta herramienta solo enumera los nombres de usuario v谩lidos en un grupo de usuarios de Amazon Cognito. No realiza ninguna acci贸n adicional.
```bash
$ cognito-scanner --help
```
Para obtener m谩s informaci贸n, visita https://github.com/padok-team/cognito-scanner

## Enumeraci贸n

{% code overflow="wrap" %}
```bash
# List Identity Pools
aws cognito-identity list-identity-pools --max-results 60
aws cognito-identity describe-identity-pool --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
aws cognito-identity list-identities --identity-pool-id <ident-pool-id> --max-results 60
aws cognito-identity get-identity-pool-roles --identity-pool-id <ident-pool-id>

# Identities Datasets
## Get dataset of identity id (inside identity pool)
aws cognito-sync list-datasets --identity-pool-id <ident-pool-id> --identity-id <ident-id>
## Get info of the dataset
aws cognito-sync describe-dataset --identity-pool-id <value> --identity-id <value> --dataset-name <value>
## Get dataset records
aws cognito-sync list-records --identity-pool-id <value> --identity-id <value> --dataset-name <value>

# User Pools
## Get pools
aws cognito-idp list-user-pools --max-results 60

## Get users
aws cognito-idp list-users --user-pool-id <user-pool-id>

## Get groups
aws cognito-idp list-groups --user-pool-id <user-pool-id>

## Get users in a group
aws cognito-idp list-users-in-group --user-pool-id <user-pool-id> --group-name <group-name>

## List App IDs of a user pool
aws cognito-idp list-user-pool-clients --user-pool-id <user-pool-id>

## List configured identity providers for a user pool
aws cognito-idp list-identity-providers --user-pool-id <user-poo

## List user import jobs
aws cognito-idp list-user-import-jobs --user-pool-id <user-pool-id> --max-results 60

## Get MFA config of a user pool
aws cognito-idp get-user-pool-mfa-config --user-pool-id <user-pool-id>

## Get risk configuration
aws cognito-idp describe-risk-configuration --user-pool-id <user-pool-id>
```
{% endcode %}

### Enumeraci贸n de Identity Pools sin autenticaci贸n

Simplemente **conocer el ID del Identity Pool**, podr铆as ser capaz de **obtener las credenciales del rol asociado a los usuarios sin autenticaci贸n** (si existe alguno). [**Mira c贸mo aqu铆**](cognito-identity-pools.md#accessing-iam-roles).

### Enumeraci贸n de User Pools sin autenticaci贸n

Incluso si **no conoces un nombre de usuario v谩lido** dentro de Cognito, podr铆as ser capaz de **enumerar** nombres de usuario v谩lidos, **probar** las **contrase帽as** o incluso **registrar un nuevo usuario** simplemente **conociendo el ID del cliente de la aplicaci贸n** (que generalmente se encuentra en el c贸digo fuente). [**Mira c贸mo aqu铆**](cognito-user-pools.md#registration)**.**

## Escalada de privilegios

{% content-ref url="../../aws-privilege-escalation/aws-cognito-privesc.md" %}
[aws-cognito-privesc.md](../../aws-privilege-escalation/aws-cognito-privesc.md)
{% endcontent-ref %}

## Acceso sin autenticaci贸n

{% content-ref url="../../aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum.md" %}
[aws-cognito-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum.md)
{% endcontent-ref %}

## Persistencia

{% content-ref url="../../../aws-pentesting/aws-persistence/aws-cognito-persistence.md" %}
[aws-cognito-persistence.md](../../../aws-pentesting/aws-persistence/aws-cognito-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
