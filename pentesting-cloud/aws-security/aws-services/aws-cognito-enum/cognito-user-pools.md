# Cognito User Pools

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>

## Grundlegende Informationen

Ein Benutzerpool ist ein Benutzerverzeichnis in Amazon Cognito. Mit einem Benutzerpool k√∂nnen sich Ihre Benutzer **√ºber Amazon Cognito in Ihre Web- oder Mobil-App einloggen** oder **√ºber einen Drittanbieter** identifizieren. Unabh√§ngig davon, ob sich Ihre Benutzer direkt oder √ºber einen Drittanbieter anmelden, verf√ºgen alle Mitglieder des Benutzerpools √ºber ein Verzeichnisprofil, auf das Sie √ºber ein SDK zugreifen k√∂nnen.

Benutzerpools bieten:

* Anmelde- und Anmeldedienste.
* Eine integrierte, anpassbare Web-Benutzeroberfl√§che zur Anmeldung von Benutzern.
* Soziale Anmeldung mit Facebook, Google, Anmeldung bei Amazon und Anmeldung bei Apple sowie √ºber SAML- und OIDC-Identit√§tsanbieter aus Ihrem Benutzerpool.
* Benutzerverzeichnisverwaltung und Benutzerprofile.
* Sicherheitsfunktionen wie Multi-Faktor-Authentifizierung (MFA), √úberpr√ºfung auf kompromittierte Anmeldeinformationen, Schutz vor Account√ºbernahmen sowie Telefon- und E-Mail-Verifizierung.
* Angepasste Workflows und Benutzermigration √ºber AWS Lambda-Triggers.

Der **Quellcode** von Anwendungen enth√§lt in der Regel auch die **Benutzerpool-ID** und die **Client-Anwendungs-ID** (und manchmal das **Anwendungspasswort**?), die f√ºr einen \*\*Benutzer erforderlich sind, um sich bei einem Cognito-Benutzerpool anzumelden.

### M√∂gliche Angriffe

* **Registrierung**: Standardm√§√üig kann sich ein Benutzer selbst registrieren und somit einen Benutzer f√ºr sich erstellen.
* **Benutzerenumeration**: Die Registrierungsfunktionalit√§t kann verwendet werden, um Benutzernamen zu finden, die bereits existieren. Diese Informationen k√∂nnen f√ºr den Brute-Force-Angriff n√ºtzlich sein.
* **Login-Brute-Force**: Im Abschnitt [**Authentifizierung**](cognito-user-pools.md#authentication) finden Sie alle **Methoden**, die ein Benutzer zum **Einloggen** haben muss. Sie k√∂nnten versuchen, sie per Brute-Force anzugreifen, um **g√ºltige Anmeldeinformationen zu finden**.

### Tools f√ºr Pentests

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), das AWS-Exploitation-Framework, enth√§lt jetzt die Module "cognito\_\_enum" und "cognito\_\_attack", die die Enumeration aller Cognito-Ressourcen in einem Konto automatisieren und schwache Konfigurationen, f√ºr den Zugriffskontrolle verwendete Benutzerattribute usw. kennzeichnen, sowie die automatisierte Benutzererstellung (einschlie√ülich MFA-Unterst√ºtzung) und Privilegieneskalation basierend auf √§nderbaren benutzerdefinierten Attributen, verwendbaren Identit√§tspool-Anmeldeinformationen, √ºbernehmbaren Rollen in ID-Token usw.

F√ºr eine Beschreibung der Funktionsweise der Module siehe Teil 2 des [Blog-Beitrags](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). F√ºr Installationsanweisungen siehe die Hauptseite von [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Verwendung

Beispielhafte Verwendung von cognito\_\_attack, um die Benutzererstellung zu versuchen und alle Privilegieneskalationsvektoren gegen einen bestimmten Identit√§tspool und Benutzerpool-Client zu testen:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Beispiel f√ºr die Verwendung von cognito\_\_enum, um alle Benutzerpools, Benutzerpool-Clients, Identit√§tspools, Benutzer usw. zu sammeln, die im aktuellen AWS-Konto sichtbar sind:

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ist ein CLI-Tool in Python, das verschiedene Angriffe auf Cognito implementiert, einschlie√ülich unerw√ºnschter Kontenerstellung und Konten-Orakel.

#### Installation

```bash
$ pip install cognito-scanner
```

#### Verwendung

```bash
$ cognito-scanner --help
```

F√ºr weitere Informationen siehe https://github.com/padok-team/cognito-scanner

## Registrierung

Benutzerpools erm√∂glichen es standardm√§√üig, **neue Benutzer zu registrieren**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Wenn sich jeder registrieren kann

Es k√∂nnte ein Fehler auftreten, der besagt, dass Sie **mehr Details** √ºber den Benutzer angeben m√ºssen:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Sie k√∂nnen die erforderlichen Details mit einem JSON wie folgt bereitstellen:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Du k√∂nntest diese Funktionalit√§t auch verwenden, um vorhandene Benutzer aufzulisten. Dies ist die Fehlermeldung, wenn bereits ein Benutzer mit diesem Namen existiert:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Beachten Sie im vorherigen Befehl, wie die **benutzerdefinierten Attribute mit "custom:" beginnen**.\
Beachten Sie auch, dass Sie beim Registrieren **keine neuen benutzerdefinierten Attribute f√ºr den Benutzer erstellen k√∂nnen**. Sie k√∂nnen nur Werte f√ºr **Standardattribute** (auch wenn sie nicht erforderlich sind) und **spezifizierte benutzerdefinierte Attribute** angeben.
{% endhint %}

Oder einfach um zu testen, ob eine Client-ID existiert. Dies ist der Fehler, wenn die Client-ID nicht existiert:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Wenn nur der Administrator Benutzer registrieren kann

Sie werden diesen Fehler finden und Sie werden nicht in der Lage sein, Benutzer zu registrieren oder aufzulisten:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### √úberpr√ºfung der Registrierung

Cognito erm√∂glicht es, **einen neuen Benutzer zu √ºberpr√ºfen, indem seine E-Mail oder Telefonnummer √ºberpr√ºft wird**. Daher werden bei der Erstellung eines Benutzers in der Regel mindestens der Benutzername und das Passwort sowie die **E-Mail- und/oder Telefonnummer** ben√∂tigt. Legen Sie einfach eine fest, **die Sie kontrollieren**, damit Sie den Code zur √úberpr√ºfung Ihres **neu erstellten** Benutzerkontos erhalten, wie folgt:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Auch wenn es so aussieht, als ob Sie dieselbe E-Mail-Adresse und Telefonnummer verwenden k√∂nnen, wird Cognito sich beschweren, wenn Sie versuchen, den erstellten Benutzer zu verifizieren, da Sie dieselben Informationen verwenden, und wird Ihnen nicht gestatten, das Konto zu verifizieren.
{% endhint %}

### Privilege Escalation / Aktualisierung von Attributen

Standardm√§√üig kann ein Benutzer den Wert seiner Attribute mit etwas wie folgt √§ndern:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Benutzerdefinierte Attribut-Privilegien-Eskalation

{% hint style="danger" %}
Es k√∂nnte sein, dass **benutzerdefinierte Attribute** verwendet werden (wie z.B. `isAdmin`). Da Sie standardm√§√üig die Werte Ihrer eigenen Attribute √§ndern k√∂nnen, k√∂nnten Sie in der Lage sein, die Berechtigungen zu **eskaliere**, indem Sie den Wert selbst √§ndern!
{% endhint %}

#### E-Mail/Benutzername-Modifikations-Privilegien-Eskalation

Sie k√∂nnen dies verwenden, um die **E-Mail-Adresse und Telefonnummer** eines Benutzers zu **√§ndern**, aber selbst wenn das Konto als verifiziert bleibt, werden diese Attribute als **nicht verifiziert** festgelegt (Sie m√ºssen sie erneut verifizieren).

{% hint style="warning" %}
Sie **k√∂nnen sich nicht mit der E-Mail-Adresse oder Telefonnummer anmelden**, bis Sie sie verifiziert haben, aber Sie werden sich **mit dem Benutzernamen anmelden k√∂nnen**.\
Beachten Sie, dass selbst wenn die E-Mail-Adresse ge√§ndert, aber nicht verifiziert wurde, sie im ID-Token im **`email`**-Feld erscheinen wird und das Feld **`email_verified`** auf **false** gesetzt wird, aber wenn die App **das nicht √ºberpr√ºft, k√∂nnten Sie andere Benutzer imitieren**.

Au√üerdem k√∂nnen Sie beliebige Inhalte im **`name`**-Feld platzieren, indem Sie einfach das **Namensattribut** √§ndern. Wenn eine App aus irgendeinem Grund **dieses Feld √ºberpr√ºft** anstelle der `E-Mail-Adresse` (oder eines anderen Attributs), k√∂nnten Sie in der Lage sein, **andere Benutzer zu imitieren**.
{% endhint %}

Wie auch immer, wenn Sie aus irgendeinem Grund Ihre E-Mail-Adresse beispielsweise in eine neue ge√§ndert haben, k√∂nnen Sie auf diese zugreifen, indem Sie die E-Mail mit dem Code best√§tigen, den Sie an diese E-Mail-Adresse erhalten haben:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Verwenden Sie **`phone_number`** anstelle von **`email`**, um eine **neue Telefonnummer** zu √§ndern/zu √ºberpr√ºfen.

{% hint style="info" %}
Der Administrator kann auch die Option aktivieren, sich mit einem vom Benutzer bevorzugten Benutzernamen anzumelden. Beachten Sie, dass Sie diesen Wert nicht in **einen Benutzernamen oder preferred\_username √§ndern k√∂nnen, der bereits verwendet wird**, um sich als anderer Benutzer auszugeben.
{% endhint %}

### Passwort wiederherstellen/√§ndern

Es ist m√∂glich, ein Passwort wiederherzustellen, indem Sie nur **den Benutzernamen kennen** (oder E-Mail oder Telefon akzeptiert wird) und Zugriff darauf haben, da ein Code dorthin gesendet wird:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
Die Antwort des Servers wird immer positiv sein, als ob der Benutzername existieren w√ºrde. Sie k√∂nnen diese Methode nicht verwenden, um Benutzer zu enumerieren.
{% endhint %}

Mit dem Code k√∂nnen Sie das Passwort √§ndern:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Um das Passwort zu √§ndern, musst du das **vorherige Passwort kennen**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Authentifizierung

Ein Benutzerpool unterst√ºtzt **verschiedene M√∂glichkeiten zur Authentifizierung**. Wenn Sie einen **Benutzernamen und ein Passwort** haben, gibt es auch **verschiedene unterst√ºtzte Methoden** zum Einloggen.\
Dar√ºber hinaus werden dem Benutzer, der im Pool authentifiziert ist, **3 Arten von Tokens** gegeben: Das **ID-Token**, das **Zugriffstoken** und das **Auffrischungstoken**.

* [**ID-Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Es enth√§lt Anspr√ºche √ºber die **Identit√§t des authentifizierten Benutzers**, wie `name`, `email` und `phone_number`. Das ID-Token kann auch verwendet werden, um Benutzer f√ºr Ihre Ressourcenserver oder Serveranwendungen zu **authentifizieren**. Sie m√ºssen die **Signatur** des ID-Tokens **√ºberpr√ºfen**, bevor Sie irgendwelche Anspr√ºche im ID-Token vertrauen k√∂nnen, wenn Sie es in externen Anwendungen verwenden.
* Das ID-Token ist das Token, das die Attributwerte des Benutzers enth√§lt, auch die benutzerdefinierten.
* [**Zugriffstoken**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Es enth√§lt Anspr√ºche √ºber den authentifizierten Benutzer, eine Liste der **Benutzergruppen** und eine Liste von Berechtigungen. Der Zweck des Zugriffstokens besteht darin, **API-Operationen zu autorisieren** im Kontext des Benutzers im Benutzerpool. Sie k√∂nnen beispielsweise das Zugriffstoken verwenden, um Ihrem Benutzer Zugriff zu gew√§hren, um Benutzerattribute hinzuzuf√ºgen, zu √§ndern oder zu l√∂schen.
* [**Auffrischungstoken**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Mit Auffrischungstoken k√∂nnen Sie **neue ID-Tokens und Zugriffstoken** f√ºr den Benutzer erhalten, bis das **Auffrischungstoken ung√ºltig ist**. Standardm√§√üig l√§uft das Auffrischungstoken **30 Tage nach** der Anmeldung Ihres Anwendungsbenutzers in Ihrem Benutzerpool ab. Wenn Sie eine Anwendung f√ºr Ihren Benutzerpool erstellen, k√∂nnen Sie das Ablaufdatum des Auffrischungstokens der Anwendung auf **einen Wert zwischen 60 Minuten und 10 Jahren** festlegen.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Dies ist der Authentifizierungsfluss auf der Serverseite:

* Die Server-App ruft die **`AdminInitiateAuth` API-Operation** (anstelle von `InitiateAuth`) auf. Diese Operation erfordert AWS-Anmeldeinformationen mit Berechtigungen, die **`cognito-idp:AdminInitiateAuth`** und **`cognito-idp:AdminRespondToAuthChallenge`** enthalten. Die Operation gibt die erforderlichen Authentifizierungsparameter zur√ºck.
* Nachdem die Server-App die **Authentifizierungsparameter** erhalten hat, ruft sie die **`AdminRespondToAuthChallenge` API-Operation** auf. Die `AdminRespondToAuthChallenge` API-Operation ist nur erfolgreich, wenn Sie AWS-Anmeldeinformationen bereitstellen.

Diese Methode ist **standardm√§√üig NICHT aktiviert**.

Um sich **anzumelden**, m√ºssen Sie wissen:

* Benutzerpool-ID
* Client-ID
* Benutzername
* Passwort
* Client-Geheimnis (nur wenn die App so konfiguriert ist, dass sie ein Geheimnis verwendet)

{% hint style="info" %}
Um sich **mit dieser Methode anmelden zu k√∂nnen**, muss die Anwendung das Anmelden mit `ALLOW_ADMIN_USER_PASSWORD_AUTH` erlauben.\
Dar√ºber hinaus ben√∂tigen Sie Berechtigungen mit den Berechtigungen **`cognito-idp:AdminInitiateAuth`** und **`cognito-idp:AdminRespondToAuthChallenge`**, um diese Aktion auszuf√ºhren.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Code zum Einloggen</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

Diese Methode ist ein weiterer einfacher und **traditioneller Benutzer- und Passwort-Authentifizierungs**-Ablauf. Es wird empfohlen, eine traditionelle Authentifizierungsmethode **zu Cognito zu migrieren** und dann **zu deaktivieren** und stattdessen die Methode **ALLOW\_USER\_SRP\_AUTH** zu verwenden (da diese das Passwort niemals √ºber das Netzwerk sendet).\
Diese Methode ist **standardm√§√üig NICHT aktiviert**.

Der Hauptunterschied zur **vorherigen Authentifizierungsmethode** im Code besteht darin, dass Sie **die Benutzerpool-ID nicht kennen m√ºssen** und dass Sie **keine zus√§tzlichen Berechtigungen** im Cognito-Benutzerpool ben√∂tigen.

Um sich **anzumelden**, m√ºssen Sie folgendes wissen:

* Client-ID
* Benutzername
* Passwort
* Client-Geheimnis (nur wenn die App so konfiguriert ist, dass sie ein Geheimnis verwendet)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Um sich **mit dieser Methode anmelden zu k√∂nnen**, muss die Anwendung die Anmeldung mit ALLOW\_USER\_PASSWORD\_AUTH zulassen.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Diese Methode ist immer g√ºltig (kann nicht deaktiviert werden), aber Sie ben√∂tigen einen g√ºltigen Refresh-Token.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
