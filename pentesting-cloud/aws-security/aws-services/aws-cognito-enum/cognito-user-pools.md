# Cognito User Pools

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Un pool d'utilisateurs est un r√©pertoire d'utilisateurs dans Amazon Cognito. Avec un pool d'utilisateurs, vos utilisateurs peuvent **se connecter √† votre application web ou mobile** via Amazon Cognito, **ou f√©d√©rer** via un **fournisseur d'identit√© tiers** (IdP). Que vos utilisateurs se connectent directement ou via un tiers, tous les membres du pool d'utilisateurs ont un profil de r√©pertoire auquel vous pouvez acc√©der via un SDK.

Les pools d'utilisateurs offrent :

* Services d'inscription et de connexion.
* Une interface utilisateur web int√©gr√©e et personnalisable pour connecter les utilisateurs.
* Connexion sociale avec Facebook, Google, Connexion avec Amazon et Connexion avec Apple, et via des fournisseurs d'identit√© SAML et OIDC de votre pool d'utilisateurs.
* Gestion du r√©pertoire des utilisateurs et profils d'utilisateurs.
* Fonctionnalit√©s de s√©curit√© telles que l'authentification multi-facteurs (MFA), v√©rifications des identifiants compromis, protection contre la prise de contr√¥le de compte, et v√©rification par t√©l√©phone et par e-mail.
* Workflows personnalis√©s et migration des utilisateurs via des d√©clencheurs AWS Lambda.

Le **code source** des applications contiendra g√©n√©ralement √©galement l'**ID du pool d'utilisateurs** et l'**ID de l'application cliente**, (et parfois le **secret de l'application** ?) qui sont n√©cessaires pour qu'un **utilisateur se connecte** √† un Pool d'utilisateurs Cognito.

### Attaques potentielles

* **Inscription** : Par d√©faut, un utilisateur peut s'inscrire lui-m√™me, il pourrait donc cr√©er un utilisateur pour lui-m√™me.
* **√ânum√©ration des utilisateurs** : La fonctionnalit√© d'inscription peut √™tre utilis√©e pour trouver des noms d'utilisateur d√©j√† existants. Ces informations peuvent √™tre utiles pour l'attaque par force brute.
* **Attaque par force brute de connexion** : Dans la section [**Authentification**](cognito-user-pools.md#authentication), vous avez tous les **m√©thodes** qu'un utilisateur doit utiliser pour **se connecter**, vous pourriez essayer de les attaquer par force brute pour **trouver des identifiants valides**.

### Outils pour les tests d'intrusion

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), le framework d'exploitation AWS, inclut d√©sormais les modules "cognito\_\_enum" et "cognito\_\_attack" qui automatisent l'√©num√©ration de tous les actifs Cognito dans un compte et signalent les configurations faibles, les attributs d'utilisateur utilis√©s pour le contr√¥le d'acc√®s, etc., et automatisent √©galement la cr√©ation d'utilisateurs (y compris la prise en charge de MFA) et l'√©l√©vation de privil√®ges bas√©e sur des attributs personnalisables modifiables, des informations d'identification de pool d'identit√© utilisables, des r√¥les assumables dans les jetons d'identit√©, etc.

Pour une description des fonctions des modules, consultez la partie 2 du [billet de blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Pour les instructions d'installation, consultez la page principale de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Utilisation

Exemple d'utilisation de l'attaque cognito\_\_attack pour tenter la cr√©ation d'utilisateur et tous les vecteurs de privil√®ge contre un pool d'identit√© donn√© et un client de pool d'utilisateurs :

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Exemple d'utilisation de cognito\_\_enum pour rassembler tous les pools d'utilisateurs, les clients de pool d'utilisateurs, les pools d'identit√©s, les utilisateurs, etc. visibles dans le compte AWS actuel :

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) est un outil CLI en python qui impl√©mente diff√©rentes attaques sur Cognito, y compris la cr√©ation de compte non d√©sir√©e et l'oracle de compte.

#### Installation

```bash
$ pip install cognito-scanner
```

#### Utilisation

```bash
$ cognito-scanner --help
```

Pour plus d'informations, consultez https://github.com/padok-team/cognito-scanner

## Inscription

Les pools d'utilisateurs permettent par **d√©faut** de **s'inscrire de nouveaux utilisateurs**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Si n'importe qui peut s'inscrire

Vous pourriez rencontrer une erreur vous indiquant que vous devez **fournir plus de d√©tails** sur l'utilisateur:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Vous pouvez fournir les d√©tails n√©cessaires avec un JSON tel que :

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Vous pourriez √©galement utiliser cette fonctionnalit√© pour **√©num√©rer les utilisateurs existants.** Voici le message d'erreur lorsqu'un utilisateur existe d√©j√† avec ce nom :

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Notez dans la commande pr√©c√©dente comment les **attributs personnalis√©s commencent par "custom:"**.\
Sachez √©galement que lors de l'inscription, vous **ne pouvez pas cr√©er de nouveaux attributs personnalis√©s pour l'utilisateur**. Vous ne pouvez donner une valeur qu'aux **attributs par d√©faut** (m√™me s'ils ne sont pas requis) et aux **attributs personnalis√©s sp√©cifi√©s**.
{% endhint %}

Ou simplement pour tester si un ID client existe. Voici l'erreur si l'ID client n'existe pas :

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Si seul l'administrateur peut inscrire des utilisateurs

Vous rencontrerez cette erreur et vous ne pourrez pas vous inscrire ou √©num√©rer les utilisateurs:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### V√©rification de l'inscription

Cognito permet de **v√©rifier un nouvel utilisateur en v√©rifiant son adresse e-mail ou son num√©ro de t√©l√©phone**. Par cons√©quent, lors de la cr√©ation d'un utilisateur, vous devrez g√©n√©ralement fournir au moins le nom d'utilisateur et le mot de passe ainsi que l'**adresse e-mail et/ou le num√©ro de t√©l√©phone**. D√©finissez-en un **que vous contr√¥lez** afin de recevoir le code pour **v√©rifier votre** compte utilisateur **r√©cemment cr√©√©** de cette mani√®re :

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
M√™me si **il semble que vous puissiez utiliser le m√™me e-mail** et num√©ro de t√©l√©phone, lorsque vous devez v√©rifier l'utilisateur cr√©√©, Cognito se plaindra de l'utilisation des m√™mes informations et **ne vous permettra pas de v√©rifier le compte**.
{% endhint %}

### √âl√©vation de privil√®ges / Mise √† jour des attributs

Par d√©faut, un utilisateur peut **modifier la valeur de ses attributs** avec quelque chose comme :

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### √âl√©vation de privil√®ges d'attribut personnalis√©

{% hint style="danger" %}
Vous pourriez trouver des **attributs personnalis√©s** en cours d'utilisation (comme `isAdmin`), car par d√©faut vous pouvez **modifier les valeurs de vos propres attributs**, vous pourriez √™tre en mesure d'**√©lever vos privil√®ges** en modifiant la valeur vous-m√™me !
{% endhint %}

#### √âl√©vation de privil√®ges par modification de l'e-mail/nom d'utilisateur

Vous pouvez utiliser ceci pour **modifier l'e-mail et le num√©ro de t√©l√©phone** d'un utilisateur, mais ensuite, m√™me si le compte reste v√©rifi√©, ces attributs sont **d√©finis comme non v√©rifi√©s** (vous devez les v√©rifier √† nouveau).

{% hint style="warning" %}
Vous **ne pourrez pas vous connecter avec l'e-mail ou le num√©ro de t√©l√©phone** tant que vous ne les aurez pas v√©rifi√©s, mais vous serez **en mesure de vous connecter avec le nom d'utilisateur**.\
Notez que m√™me si l'e-mail a √©t√© modifi√© et n'est pas v√©rifi√©, il appara√Ætra dans le jeton d'identification √† l'int√©rieur du champ **`email`** et le champ **`email_verified`** sera **faux**, mais si l'application **ne v√©rifie pas cela, vous pourriez vous faire passer pour d'autres utilisateurs**.

De plus, notez que vous pouvez mettre n'importe quoi √† l'int√©rieur du champ **`name`** en modifiant simplement l'**attribut de nom**. Si une application **v√©rifie** ce champ pour une raison quelconque **au lieu de l'`email`** (ou tout autre attribut), vous pourriez √™tre en mesure de **vous faire passer pour d'autres utilisateurs**.
{% endhint %}

Quoi qu'il en soit, si pour une raison quelconque vous avez chang√© votre e-mail par exemple pour un nouveau, vous pouvez y acc√©der et **confirmer l'e-mail avec le code que vous avez re√ßu √† cette adresse e-mail** :

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Utilisez **`phone_number`** au lieu de **`email`** pour changer/v√©rifier un **nouveau num√©ro de t√©l√©phone**.

{% hint style="info" %}
L'administrateur pourrait √©galement activer l'option de **connexion avec un nom d'utilisateur pr√©f√©r√© par l'utilisateur**. Notez que vous ne pourrez pas changer cette valeur en **un nom d'utilisateur ou un preferred\_username d√©j√† utilis√©** pour se faire passer pour un utilisateur diff√©rent.
{% endhint %}

### R√©cup√©rer/Changer le mot de passe

Il est possible de r√©cup√©rer un mot de passe en **connaissant le nom d'utilisateur** (ou l'email ou le t√©l√©phone est accept√©) et en y ayant acc√®s, un code y sera envoy√© :

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
La r√©ponse du serveur sera toujours positive, comme si le nom d'utilisateur existait. Vous ne pouvez pas utiliser cette m√©thode pour √©num√©rer les utilisateurs.
{% endhint %}

Avec le code, vous pouvez changer le mot de passe avec :

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Pour changer le mot de passe, vous devez **conna√Ætre le mot de passe pr√©c√©dent** :

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Authentification

Un pool d'utilisateurs prend en charge **diff√©rentes fa√ßons de s'authentifier**. Si vous avez un **nom d'utilisateur et un mot de passe**, il existe √©galement **diff√©rentes m√©thodes** prises en charge pour se connecter.\
De plus, lorsqu'un utilisateur est authentifi√© dans le Pool, **3 types de jetons sont donn√©s** : Le **jeton ID**, le **jeton d'acc√®s** et le **jeton de rafra√Æchissement**.

* [**Jeton ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html) : Il contient des revendications sur **l'identit√© de l'utilisateur authentifi√©**, telles que `nom`, `email` et `num√©ro de t√©l√©phone`. Le jeton ID peut √©galement √™tre utilis√© pour **authentifier les utilisateurs aupr√®s de vos serveurs de ressources ou applications serveur**. Vous devez **v√©rifier** la **signature** du jeton ID avant de pouvoir faire confiance √† toutes les revendications √† l'int√©rieur du jeton ID si vous l'utilisez dans des applications externes.
* Le jeton ID est le jeton qui **contient les valeurs des attributs de l'utilisateur**, m√™me les personnalis√©s.
* [**Jeton d'acc√®s**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html) : Il contient des revendications sur l'utilisateur authentifi√©, une liste des **groupes de l'utilisateur et une liste de port√©es**. Le but du jeton d'acc√®s est d'**autoriser les op√©rations API** dans le contexte de l'utilisateur dans le pool d'utilisateurs. Par exemple, vous pouvez utiliser le jeton d'acc√®s pour **accorder √† votre utilisateur l'acc√®s** pour ajouter, modifier ou supprimer des attributs utilisateur.
* [**Jeton de rafra√Æchissement**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html) : Avec les jetons de rafra√Æchissement, vous pouvez **obtenir de nouveaux jetons ID et d'acc√®s** pour l'utilisateur jusqu'√† ce que le **jeton de rafra√Æchissement soit invalide**. Par **d√©faut**, le jeton de rafra√Æchissement **expire 30 jours apr√®s** que votre utilisateur d'application se connecte √† votre pool d'utilisateurs. Lorsque vous cr√©ez une application pour votre pool d'utilisateurs, vous pouvez d√©finir l'expiration du jeton de rafra√Æchissement de l'application √† **n'importe quelle valeur entre 60 minutes et 10 ans**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Il s'agit du flux d'authentification c√¥t√© serveur :

* L'application c√¥t√© serveur appelle l'op√©ration API **`AdminInitiateAuth`** (au lieu de `InitiateAuth`). Cette op√©ration n√©cessite des informations d'identification AWS avec des autorisations incluant **`cognito-idp:AdminInitiateAuth`** et **`cognito-idp:AdminRespondToAuthChallenge`**. L'op√©ration renvoie les param√®tres d'authentification requis.
* Apr√®s que l'application c√¥t√© serveur ait les **param√®tres d'authentification**, elle appelle l'op√©ration API **`AdminRespondToAuthChallenge`**. L'op√©ration `AdminRespondToAuthChallenge` r√©ussit uniquement lorsque vous fournissez des informations d'identification AWS.

Cette **m√©thode n'est PAS activ√©e** par d√©faut.

Pour **se connecter**, vous **devez** conna√Ætre :

* l'ID du pool d'utilisateurs
* l'ID du client
* le nom d'utilisateur
* le mot de passe
* le secret du client (uniquement si l'application est configur√©e pour utiliser un secret)

{% hint style="info" %}
Afin de **pouvoir vous connecter avec cette m√©thode**, l'application doit autoriser la connexion avec `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
De plus, pour effectuer cette action, vous avez besoin d'informations d'identification avec les autorisations **`cognito-idp:AdminInitiateAuth`** et **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Code pour se connecter</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### AUTHENTIFICATION_PAR_MOT_DE_PASSE_UTILISATEUR

Cette m√©thode est un autre flux d'authentification simple et **traditionnel utilisateur & mot de passe**. Il est recommand√© de **migrer une m√©thode d'authentification traditionnelle** vers Cognito et **recommand√©** de **la d√©sactiver** puis d'utiliser la m√©thode **ALLOW\_USER\_SRP\_AUTH** √† la place (car celle-ci ne transmet jamais le mot de passe sur le r√©seau).\
Cette **m√©thode n'est PAS activ√©e** par d√©faut.

La principale **diff√©rence** avec la **m√©thode d'authentification pr√©c√©dente** dans le code est que vous **n'avez pas besoin de conna√Ætre l'ID du pool d'utilisateurs** et que vous **n'avez pas besoin de permissions suppl√©mentaires** dans le pool d'utilisateurs Cognito.

Pour **vous connecter**, vous **devez** conna√Ætre :

* l'identifiant du client
* le nom d'utilisateur
* le mot de passe
* le secret du client (uniquement si l'application est configur√©e pour utiliser un secret)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Pour **pouvoir vous connecter avec cette m√©thode**, l'application doit autoriser la connexion avec ALLOW\_USER\_PASSWORD\_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### AUTHENTIFICATION PAR JETON DE RAFRA√éCHISSEMENT & JETON DE RAFRA√éCHISSEMENT

Cette **m√©thode sera toujours valide** (elle ne peut pas √™tre d√©sactiv√©e) mais vous devez disposer d'un jeton de rafra√Æchissement valide.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
