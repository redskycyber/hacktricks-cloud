# Cognito korisniÄki bazeni

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

KorisniÄki bazen je direktorijum korisnika u Amazon Cognitu. Sa korisniÄkim bazenom, vaÅ¡i korisnici mogu **da se prijave na vaÅ¡u veb ili mobilnu aplikaciju** putem Amazon Cognita, **ili da se federiÅ¡u** putem **treÄ‡eg lica** koje pruÅ¾a identitet (IdP). Bez obzira da li se vaÅ¡i korisnici prijavljuju direktno ili putem treÄ‡eg lica, svi Älanovi korisniÄkog bazena imaju profil direktorijuma koji moÅ¾ete pristupiti putem SDK-a.

KorisniÄki bazeni pruÅ¾aju:

* Usluge registracije i prijave.
* UgraÄ‘eni, prilagodljivi veb korisniÄki interfejs za prijavu korisnika.
* Socijalnu prijavu putem Facebook-a, Google-a, Prijave putem Amazon-a i Prijave putem Apple-a, kao i putem SAML i OIDC provajdera identiteta iz vaÅ¡eg korisniÄkog bazena.
* Upravljanje korisniÄkim direktorijumom i korisniÄkim profilima.
* Bezbednosne funkcije kao Å¡to su viÅ¡efaktorska autentifikacija (MFA), provera kompromitovanih akreditiva, zaÅ¡tita od preuzimanja naloga, provera telefonom i e-poÅ¡tom.
* PrilagoÄ‘ene radne tokove i migraciju korisnika putem AWS Lambda okidaÄa.

**Izvorni kod** aplikacija obiÄno takoÄ‘e sadrÅ¾i **ID korisniÄkog bazena** i **ID klijentske aplikacije**, (a ponekad i **tajnu aplikacije**?) koje su potrebne za **prijavu korisnika** na Cognito korisniÄki bazen.

### Potencijalni napadi

* **Registracija**: Podrazumevano, korisnik moÅ¾e sam sebe registrovati, tako da moÅ¾e kreirati korisnika za sebe.
* **Enumeracija korisnika**: Funkcionalnost registracije moÅ¾e se koristiti za pronalaÅ¾enje korisniÄkih imena koja veÄ‡ postoje. Ove informacije mogu biti korisne za napad metodom iscrpljivanja resursa.
* **Brute-force prijava**: U odeljku [**Autentifikacija**](cognito-user-pools.md#authentication) imate sve **metode** koje korisnik mora da koristi za **prijavu**, moÅ¾ete pokuÅ¡ati da ih iscrpljujete kako biste **pronaÅ¡li validne akreditive**.

### Alati za pentestiranje

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), okvir za iskoriÅ¡Ä‡avanje AWS-a, sada ukljuÄuje module "cognito\_\_enum" i "cognito\_\_attack" koji automatizuju enumeraciju svih Cognito resursa u nalogu i oznaÄavaju slabe konfiguracije, korisniÄke atribute koji se koriste za kontrolu pristupa, itd., a takoÄ‘e automatizuju kreiranje korisnika (ukljuÄujuÄ‡i podrÅ¡ku za MFA) i eskalaciju privilegija na osnovu promenljivih prilagodljivih atributa, korisnih akreditiva za identifikacioni bazen, uloga koje se mogu pretpostaviti u ID tokenima, itd.

Za opis funkcija modula pogledajte deo 2 [blog posta](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Za uputstva za instalaciju pogledajte glavnu [Pacu](https://github.com/RhinoSecurityLabs/pacu) stranicu.

#### Upotreba

Primer upotrebe cognito\_\_attack za pokuÅ¡aj kreiranja korisnika i svih vektora eskalacije privilegija protiv datog identifikacionog bazena i klijentske aplikacije korisniÄkog bazena:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Primer upotrebe cognito\_\_enum alata za prikupljanje svih bazena korisnika, klijenata bazena korisnika, bazena identiteta, korisnika, itd. vidljivih u trenutnom AWS nalogu:

```plaintext
cognito__enum --all
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) je CLI alatka napisana u Pythonu koja implementira razliÄite napade na Cognito, ukljuÄujuÄ‡i neÅ¾eljeno kreiranje naloga i napad na orakl raÄuna.

#### Instalacija
```bash
$ pip install cognito-scanner
```
#### Upotreba
```bash
$ cognito-scanner --help
```
Za viÅ¡e informacija posetite https://github.com/padok-team/cognito-scanner

## Registracija

User Pools podrazumevano omoguÄ‡ava **registraciju novih korisnika**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Ako se svako moÅ¾e registrovati

MoÅ¾da Ä‡ete naiÄ‡i na greÅ¡ku koja ukazuje da trebate **pruÅ¾iti viÅ¡e detalja** o korisniku:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
MoÅ¾ete pruÅ¾iti potrebne detalje putem JSON-a, kao Å¡to je:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
MoÅ¾ete koristiti ovu funkcionalnost i za **nabrojavanje postojeÄ‡ih korisnika**. Ovo je poruka o greÅ¡ci kada korisnik veÄ‡ postoji sa tim imenom:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Primetite u prethodnoj komandi kako **prilagoÄ‘eni atributi poÄinju sa "custom:"**.\
TakoÄ‘e, znajte da prilikom registracije **ne moÅ¾ete kreirati nove prilagoÄ‘ene atribute** za korisnika. MoÅ¾ete samo dati vrednost **podrazumevanim atributima** (Äak i ako nisu obavezni) i **navedenim prilagoÄ‘enim atributima**.
{% endhint %}

Ili samo testirajte da li postoji klijentski ID. Ovo je greÅ¡ka ako klijentski ID ne postoji:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Ako samo admin moÅ¾e registrovati korisnike

NaiÄ‡i Ä‡ete na ovu greÅ¡ku i neÄ‡ete moÄ‡i registrovati ili nabrojati korisnike:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verifikacija registracije

Cognito omoguÄ‡ava **verifikaciju novog korisnika putem verifikacije njegove e-poÅ¡te ili telefonskog broja**. Stoga, prilikom kreiranja korisnika obiÄno Ä‡e vam biti potrebno barem korisniÄko ime i lozinka, kao i **e-poÅ¡ta i/ili telefonski broj**. Samo postavite jedan **kojim upravljate**, tako da Ä‡ete primiti kod za **verifikaciju vaÅ¡eg** novo kreiranog korisniÄkog **raÄuna** na ovaj naÄin:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
ÄŒak i ako **izgleda da moÅ¾ete koristiti isti email** i broj telefona, kada trebate verifikovati kreiranog korisnika, Cognito Ä‡e se Å¾aliti na koriÅ¡Ä‡enje istih informacija i **neÄ‡e vam dozvoliti verifikaciju naloga**.
{% endhint %}

### Eskalacija privilegija / AÅ¾uriranje atributa

Podrazumevano, korisnik moÅ¾e **izmeniti vrednost svojih atributa** koristeÄ‡i neÅ¡to poput:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Privesc putem prilagoÄ‘enih atributa

{% hint style="danger" %}
MoÅ¾ete pronaÄ‡i **prilagoÄ‘ene atribute** koji se koriste (kao Å¡to je `isAdmin`), jer prema zadanim postavkama moÅ¾ete **promeniti vrednosti sopstvenih atributa** i moÅ¾da Ä‡ete moÄ‡i **poveÄ‡ati privilegije** promenom vrednosti sami!
{% endhint %}

#### Privesc putem izmena e-poÅ¡te/korisniÄkog imena

MoÅ¾ete koristiti ovo da **izmenite e-poÅ¡tu i broj telefona** korisnika, ali Äak i ako nalog ostane verifikovan, ti atributi su **postavljeni u neproverenom statusu** (moraju se ponovo verifikovati).

{% hint style="warning" %}
NeÄ‡ete moÄ‡i da se prijavite putem e-poÅ¡te ili broja telefona dok ih ne verifikujete, ali Ä‡ete moÄ‡i da se prijavite sa korisniÄkim imenom.\
Imajte na umu da Ä‡e Äak i ako je e-poÅ¡ta izmenjena i nije verifikovana, ona Ä‡e se pojaviti u ID token-u unutar polja **`email`**, a polje **`email_verified`** Ä‡e biti **false**, ali ako aplikacija **ne proverava to**, moÅ¾ete se predstavljati kao drugi korisnici.

TakoÄ‘e, imajte na umu da moÅ¾ete staviti bilo Å¡ta unutar polja **`name`** jednostavnom izmenom atributa **name**. Ako aplikacija **proverava** to polje iz nekog razloga **umesto `email`** (ili bilo koji drugi atribut), moÅ¾ete se predstavljati kao drugi korisnici.
{% endhint %}

U svakom sluÄaju, ako iz nekog razloga promenite svoju e-poÅ¡tu na primer na novu, moÅ¾ete **potvrditi e-poÅ¡tu sa kodom koji ste dobili na toj adresi e-poÅ¡te**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Koristite **`phone_number`** umesto **`email`** da biste promenili/verifikovali **novi broj telefona**.

{% hint style="info" %}
Administrator takoÄ‘e moÅ¾e omoguÄ‡iti opciju **prijave sa korisniÄkim imenom koje korisnik preferira**. Imajte na umu da neÄ‡ete moÄ‡i promeniti ovu vrednost u **bilo koje korisniÄko ime ili preferirano_korisniÄko_ime koje veÄ‡ koristi** kako biste se predstavili kao drugi korisnik.
{% endhint %}

### VraÄ‡anje/Promena lozinke

MoguÄ‡e je vratiti lozinku samo **znajuÄ‡i korisniÄko ime** (ili email ili broj telefona) i imajuÄ‡i pristup tome jer Ä‡e tamo biti poslat kod:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Odgovor servera Ä‡e uvek biti pozitivan, kao da korisniÄko ime postoji. Ne moÅ¾ete koristiti ovu metodu za enumeraciju korisnika.
{% endhint %}

Sa kodom moÅ¾ete promeniti lozinku korisnika:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Da biste promenili lozinku, potrebno je **znati prethodnu lozinku**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autentifikacija

KorisniÄki bazen podrÅ¾ava **razliÄite naÄine autentifikacije**. Ako imate **korisniÄko ime i lozinku**, takoÄ‘e postoje **razliÄite metode** podrÅ¾ane za prijavljivanje.\
Osim toga, kada je korisnik autentifikovan u bazenu, dodeljuju se **3 vrste tokena**: **ID token**, **Pristupni token** i **Token za osveÅ¾avanje**.

* [**ID token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): SadrÅ¾i tvrdnje o **identitetu autentifikovanog korisnika**, kao Å¡to su `ime`, `email` i `broj telefona`. ID token se takoÄ‘e moÅ¾e koristiti za **autentifikaciju korisnika na vaÅ¡im serverskim aplikacijama**. Morate **proveriti** **potpis** ID tokena pre nego Å¡to moÅ¾ete verovati bilo kojim tvrdnjama unutar ID tokena ako ga koristite u eksternim aplikacijama.
* ID token je token koji **sadrÅ¾i vrednosti atributa korisnika**, Äak i prilagoÄ‘ene.
* [**Pristupni token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): SadrÅ¾i tvrdnje o autentifikovanom korisniku, listu **grupa korisnika i listu opsega**. Svrha pristupnog tokena je **autorizacija API operacija** u kontekstu korisnika u korisniÄkom bazenu. Na primer, moÅ¾ete koristiti pristupni token da **omoguÄ‡ite korisniku pristup** za dodavanje, promenu ili brisanje atributa korisnika.
* [**Token za osveÅ¾avanje**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): PomoÄ‡u tokena za osveÅ¾avanje moÅ¾ete **dobiti nove ID tokene i pristupne tokene** za korisnika sve dok je **token za osveÅ¾avanje vaÅ¾eÄ‡i**. Podrazumevano, token za osveÅ¾avanje **istiÄe 30 dana nakon** Å¡to se korisnik vaÅ¡e aplikacije prijavi u korisniÄki bazen. Prilikom kreiranja aplikacije za korisniÄki bazen, moÅ¾ete postaviti istek tokena za osveÅ¾avanje aplikacije na **bilo koju vrednost izmeÄ‘u 60 minuta i 10 godina**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Ovo je autentifikacija na serverskoj strani:

* Aplikacija na serverskoj strani poziva operaciju **`AdminInitiateAuth`** API-ja (umesto `InitiateAuth`). Ova operacija zahteva AWS akreditive sa dozvolama koje ukljuÄuju **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacija vraÄ‡a potrebne parametre za autentifikaciju.
* Nakon Å¡to aplikacija na serverskoj strani dobije **parametre za autentifikaciju**, poziva operaciju **`AdminRespondToAuthChallenge`** API-ja. Operacija `AdminRespondToAuthChallenge` API-ja uspeva samo kada pruÅ¾ite AWS akreditive.

Ova **metoda NIJE omoguÄ‡ena** podrazumevano.

Da biste se **prijavili**, morate znati:

* ID korisniÄkog bazena
* ID klijenta
* KorisniÄko ime
* Lozinku
* Klijentsku tajnu (samo ako je aplikacija konfigurisana da koristi tajnu)

{% hint style="info" %}
Da biste mogli **da se prijavite ovom metodom**, aplikacija mora dozvoliti prijavljivanje sa `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Osim toga, da biste izvrÅ¡ili ovu radnju, potrebne su vam akreditacije sa dozvolama **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Kod za prijavu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Ova metoda je joÅ¡ jednostavnija i **tradicionalna metoda autentifikacije korisnika i lozinke**. PreporuÄuje se **migracija tradicionalne** metode autentifikacije **na Cognito** i zatim **onemoguÄ‡avanje** te metode i umesto nje koriÅ¡Ä‡enje metode **ALLOW\_USER\_SRP\_AUTH** (jer ova metoda nikada ne Å¡alje lozinku preko mreÅ¾e).\
Ova metoda **nije omoguÄ‡ena** podrazumevano.

Glavna **razlika** u odnosu na **prethodnu metodu autentifikacije** u kodu je da ne morate znati ID bazena korisnika i da ne trebate dodatne dozvole u Cognito bazenu korisnika.

Da biste se **prijavili**, morate znati:

* ID klijenta
* korisniÄko ime
* lozinku
* tajnu klijenta (samo ako je aplikacija konfigurisana da koristi tajnu)

{% hint style="info" %}
Da biste mogli **da se prijavite ovom metodom**, aplikacija mora dozvoliti prijavu sa ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<detalji>

<summary>Python kod za prijavu</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Ovaj scenario je sliÄan prethodnom, ali umesto slanja lozinke preko mreÅ¾e za prijavu se vrÅ¡i izazovna autentifikacija (tako da lozinka ne prolazi Äak ni enkriptovana kroz mreÅ¾u).\
Ova metoda je podrazumevano omoguÄ‡ena.

Da biste se prijavili, potrebno je znati:

* ID bazena korisnika
* ID klijenta
* korisniÄko ime
* lozinku
* tajni klijent (samo ako je aplikacija konfigurisana da koristi tajnu)

<details>

<summary>Kod za prijavu</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ova **metoda Ä‡e uvek biti validna** (ne moÅ¾e biti onemoguÄ‡ena), ali morate imati validan refresh token.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Kod za osveÅ¾avanje</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

U ovom sluÄaju Ä‡e se **autentifikacija** izvrÅ¡iti putem **izvrÅ¡avanja lambda funkcije**.

## Dodatna sigurnost

### Napredna sigurnost

Po defaultu je onemoguÄ‡ena, ali ako je omoguÄ‡ena, Cognito bi mogao **pronaÄ‡i preuzimanje naloga**. Da biste smanjili verovatnoÄ‡u, trebali biste se prijaviti sa **mreÅ¾e unutar istog grada, koristeÄ‡i isti korisniÄki agent** (i IP adresu ako je moguÄ‡e).

### **MFA Zapamti ureÄ‘aj**

Ako se korisnik prijavi sa istog ureÄ‘aja, MFA moÅ¾e biti zaobiÄ‘en, stoga pokuÅ¡ajte se prijaviti sa istim pregledaÄem i istim metapodacima (IP?) kako biste pokuÅ¡ali zaobiÄ‡i MFA zaÅ¡titu.

## IAM uloge grupa korisniÄkih bazena

MoguÄ‡e je dodati **korisnike u grupe korisniÄkih bazena** koje su povezane sa jednom **IAM ulogom**.\
Osim toga, **korisnici** mogu biti dodijeljeni **viÅ¡e od 1 grupe sa razliÄitim IAM ulogama**.

Imajte na umu da Äak i ako je grupa unutar grupe sa pridruÅ¾enom IAM ulogom, da biste mogli pristupiti IAM akreditivima te grupe, potrebno je da je **korisniÄki bazen pouzdan od strane bazena identiteta** (i da zna detalje tog bazena identiteta).

JoÅ¡ jedan uslov da se dobije **IAM uloga navedena u IdToken-u** kada se korisnik autentifikuje u korisniÄkom bazenu (`aws cognito-idp initiate-auth...`) je da **provajder za autentifikaciju identiteta** treba da naznaÄi da **uloga mora biti izabrana iz tokena**.

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2).png" alt=""><figcaption></figcaption></figure>

**Uloge** kojima korisnik ima pristup su **unutar `IdToken`-a**, i korisnik moÅ¾e **izabrati za koju ulogu Å¾eli akreditive** koristeÄ‡i **`--custom-role-arn`** iz `aws cognito-identity get-credentials-for-identity`.\
MeÄ‘utim, ako je **podrazumevana opcija** ona koja je **konfigurisana** (`use default role`), i pokuÅ¡ate pristupiti ulozi iz IdToken-a, dobiÄ‡ete **greÅ¡ku** (zato je potrebna prethodna konfiguracija):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Napomena da uloga dodeljena **User Pool Group**-u mora biti **pristupaÄna od strane Identity Provider-a** koji **veruje User Pool-u** (jer Ä‡e se **sesijski akreditivi IAM uloge dobiti od njega**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
