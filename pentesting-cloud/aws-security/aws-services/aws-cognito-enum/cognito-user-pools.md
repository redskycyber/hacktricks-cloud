# Cognitoç”¨æˆ·æ± 

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

ç”¨æˆ·æ± æ˜¯Amazon Cognitoä¸­çš„ç”¨æˆ·ç›®å½•ã€‚ä½¿ç”¨ç”¨æˆ·æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡Amazon Cognito**ç™»å½•åˆ°æ‚¨çš„Webæˆ–ç§»åŠ¨åº”ç”¨ç¨‹åº**ï¼Œæˆ–é€šè¿‡**ç¬¬ä¸‰æ–¹**èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰**è”åˆç™»å½•**ã€‚æ— è®ºç”¨æˆ·æ˜¯ç›´æ¥ç™»å½•è¿˜æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œç”¨æˆ·æ± çš„æ‰€æœ‰æˆå‘˜éƒ½æœ‰ä¸€ä¸ªç›®å½•é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡SDKè®¿é—®ã€‚

ç”¨æˆ·æ± æä¾›ï¼š

* æ³¨å†Œå’Œç™»å½•æœåŠ¡ã€‚
* ä¸€ä¸ªå†…ç½®çš„ã€å¯è‡ªå®šä¹‰çš„Web UIç”¨äºç”¨æˆ·ç™»å½•ã€‚
* ä¸Facebookã€Googleã€ä½¿ç”¨Amazonç™»å½•å’Œä½¿ç”¨Appleç™»å½•ä»¥åŠé€šè¿‡SAMLå’ŒOIDCèº«ä»½æä¾›å•†ä»æ‚¨çš„ç”¨æˆ·æ± ç™»å½•çš„ç¤¾äº¤ç™»å½•ã€‚
* ç”¨æˆ·ç›®å½•ç®¡ç†å’Œç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
* å®‰å…¨åŠŸèƒ½ï¼Œå¦‚å¤šå› ç´ èº«ä»½éªŒè¯ï¼ˆMFAï¼‰ã€æ£€æŸ¥å—æŸå‡­æ®ã€é˜²æ­¢è´¦æˆ·è¢«æ¥ç®¡ä»¥åŠç”µè¯å’Œç”µå­é‚®ä»¶éªŒè¯ã€‚
* é€šè¿‡AWS Lambdaè§¦å‘å™¨è¿›è¡Œè‡ªå®šä¹‰å·¥ä½œæµå’Œç”¨æˆ·è¿ç§»ã€‚

åº”ç”¨ç¨‹åºçš„**æºä»£ç **é€šå¸¸è¿˜ä¼šåŒ…å«**ç”¨æˆ·æ± ID**å’Œ**å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºID**ï¼ˆæœ‰æ—¶è¿˜åŒ…æ‹¬**åº”ç”¨ç¨‹åºå¯†é’¥**ï¼Ÿï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äº**ç”¨æˆ·ç™»å½•åˆ°Cognitoç”¨æˆ·æ± **æ˜¯å¿…éœ€çš„ã€‚

### æ½œåœ¨æ”»å‡»

* **æ³¨å†Œ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œæ³¨å†Œï¼Œå› æ­¤ä»–å¯ä»¥ä¸ºè‡ªå·±åˆ›å»ºç”¨æˆ·ã€‚
* **ç”¨æˆ·æšä¸¾**ï¼šæ³¨å†ŒåŠŸèƒ½å¯ç”¨äºæŸ¥æ‰¾å·²å­˜åœ¨çš„ç”¨æˆ·åã€‚è¿™äº›ä¿¡æ¯å¯¹äºæš´åŠ›ç ´è§£æ”»å‡»å¯èƒ½å¾ˆæœ‰ç”¨ã€‚
* **ç™»å½•æš´åŠ›ç ´è§£**ï¼šåœ¨[**èº«ä»½éªŒè¯**](cognito-user-pools.md#authentication)éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ·ç™»å½•æ‰€éœ€çš„æ‰€æœ‰**æ–¹æ³•**ï¼Œæ‚¨å¯ä»¥å°è¯•å¯¹å®ƒä»¬è¿›è¡Œæš´åŠ›ç ´è§£ä»¥**æ‰¾åˆ°æœ‰æ•ˆå‡­æ®**ã€‚

### æ¸—é€æµ‹è¯•å·¥å…·

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼ŒAWSåˆ©ç”¨æ¡†æ¶ï¼Œç°åœ¨åŒ…æ‹¬â€œcognito\_\_enumâ€å’Œâ€œcognito\_\_attackâ€æ¨¡å—ï¼Œè‡ªåŠ¨æšä¸¾è´¦æˆ·ä¸­æ‰€æœ‰Cognitoèµ„äº§ï¼Œå¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆåŒ…æ‹¬MFAæ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹çš„è‡ªå®šä¹‰å±æ€§ã€å¯ç”¨çš„èº«ä»½æ± å‡­æ®ã€idä»¤ç‰Œä¸­å¯å‡å®šçš„è§’è‰²ç­‰è¿›è¡Œç‰¹æƒå‡çº§ã€‚

æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚é˜…[åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)çš„ç¬¬2éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚é˜…ä¸»è¦[Pacu](https://github.com/RhinoSecurityLabs/pacu)é¡µé¢ã€‚

#### ç”¨æ³•

ç¤ºä¾‹cognito\_\_attackç”¨æ³•ï¼Œå°è¯•å¯¹ç»™å®šçš„èº«ä»½æ± å’Œç”¨æˆ·æ± å®¢æˆ·ç«¯è¿›è¡Œç”¨æˆ·åˆ›å»ºå’Œæ‰€æœ‰ç‰¹æƒå‡çº§å‘é‡çš„æ”»å‡»ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
ä»¥ä¸‹æ˜¯ä½¿ç”¨cognito\_\_enumçš„ç¤ºä¾‹ï¼Œç”¨äºæ”¶é›†å½“å‰AWSè´¦æˆ·ä¸­å¯è§çš„æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± ã€ç”¨æˆ·ç­‰ä¿¡æ¯ï¼š
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªç”¨ Python ç¼–å†™çš„ CLI å·¥å…·ï¼Œå®ç°å¯¹ Cognito çš„ä¸åŒæ”»å‡»ï¼ŒåŒ…æ‹¬æœªç»æˆæƒçš„è´¦æˆ·åˆ›å»ºå’Œè´¦æˆ·é¢„æµ‹ã€‚

#### å®‰è£…
```bash
$ pip install cognito-scanner
```
#### ç”¨æ³•
```bash
$ cognito-scanner --help
```
æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ https://github.com/padok-team/cognito-scanner

## æ³¨å†Œ

ç”¨æˆ·æ± é»˜è®¤å…è®¸æ³¨å†Œæ–°ç”¨æˆ·ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### å¦‚æœä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œ

æ‚¨å¯èƒ½ä¼šé‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼ŒæŒ‡ç¤ºæ‚¨éœ€è¦æä¾›æœ‰å…³ç”¨æˆ·çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ JSON æä¾›æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯ï¼š
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æ¥**æšä¸¾ç°æœ‰ç”¨æˆ·**ã€‚å½“ä½¿ç”¨å·²å­˜åœ¨çš„ç”¨æˆ·åæ—¶ï¼Œä¼šæ˜¾ç¤ºä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
è¯·æ³¨æ„å‰ä¸€ä¸ªå‘½ä»¤ä¸­**è‡ªå®šä¹‰å±æ€§ä»¥"custom:"å¼€å¤´**ã€‚\
è¿˜è¦çŸ¥é“ï¼Œåœ¨æ³¨å†Œæ—¶**æ— æ³•ä¸ºç”¨æˆ·åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å±æ€§**ã€‚æ‚¨åªèƒ½ä¸º**é»˜è®¤å±æ€§**ï¼ˆå³ä½¿å®ƒä»¬ä¸æ˜¯å¿…éœ€çš„ï¼‰å’Œ**æŒ‡å®šçš„è‡ªå®šä¹‰å±æ€§**èµ‹å€¼ã€‚
{% endhint %}

æˆ–è€…åªæ˜¯æµ‹è¯•å®¢æˆ·ç«¯IDæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå®¢æˆ·ç«¯IDä¸å­˜åœ¨ï¼Œåˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### å¦‚æœåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ³¨å†Œç”¨æˆ·

æ‚¨å°†ä¼šé‡åˆ°æ­¤é”™è¯¯ï¼Œæ— æ³•æ³¨å†Œæˆ–æšä¸¾ç”¨æˆ·ï¼š
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### éªŒè¯æ³¨å†Œ

Cognitoå…è®¸é€šè¿‡éªŒè¯ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç æ¥éªŒè¯æ–°ç”¨æˆ·ã€‚å› æ­¤ï¼Œå½“åˆ›å»ºç”¨æˆ·æ—¶ï¼Œé€šå¸¸è‡³å°‘éœ€è¦ç”¨æˆ·åå’Œå¯†ç ä»¥åŠç”µå­é‚®ä»¶å’Œ/æˆ–ç”µè¯å·ç ã€‚åªéœ€è®¾ç½®ä¸€ä¸ªæ‚¨æ§åˆ¶çš„ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ï¼Œè¿™æ ·æ‚¨å°†æ”¶åˆ°ç”¨äºéªŒè¯æ–°åˆ›å»ºçš„ç”¨æˆ·å¸æˆ·çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
å³ä½¿**çœ‹èµ·æ¥ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç”µå­é‚®ä»¶**å’Œç”µè¯å·ç ï¼Œä½†å½“æ‚¨éœ€è¦éªŒè¯åˆ›å»ºçš„ç”¨æˆ·æ—¶ï¼ŒCognitoä¼šæŠ±æ€¨ä½¿ç”¨ç›¸åŒçš„ä¿¡æ¯ï¼Œå¹¶ä¸”**ä¸ä¼šè®©æ‚¨éªŒè¯è¯¥å¸æˆ·**ã€‚
{% endhint %}

### ææƒ / æ›´æ–°å±æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼**ä¿®æ”¹å…¶å±æ€§çš„å€¼**ï¼š
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### è‡ªå®šä¹‰å±æ€§æƒé™æå‡

{% hint style="danger" %}
æ‚¨å¯èƒ½ä¼šå‘ç°æ­£åœ¨ä½¿ç”¨**è‡ªå®šä¹‰å±æ€§**ï¼ˆä¾‹å¦‚`isAdmin`ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥**æ›´æ”¹è‡ªå·±å±æ€§çš„å€¼**ï¼Œå› æ­¤æ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡æ›´æ”¹å€¼æ¥**æå‡æƒé™**ï¼
{% endhint %}

#### ç”µå­é‚®ä»¶/ç”¨æˆ·åä¿®æ”¹æƒé™æå‡

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ¥**ä¿®æ”¹ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œç”µè¯å·ç **ï¼Œä½†å³ä½¿å¸æˆ·ä¿æŒä¸ºå·²éªŒè¯çŠ¶æ€ï¼Œè¿™äº›å±æ€§ä¹Ÿä¼š**è®¾ç½®ä¸ºæœªéªŒè¯çŠ¶æ€**ï¼ˆæ‚¨éœ€è¦é‡æ–°éªŒè¯å®ƒä»¬ï¼‰ã€‚

{% hint style="warning" %}
æ‚¨**å°†æ— æ³•ä½¿ç”¨ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ç™»å½•**ï¼Œç›´åˆ°æ‚¨éªŒè¯å®ƒä»¬ï¼Œä½†æ‚¨å°†**èƒ½å¤Ÿä½¿ç”¨ç”¨æˆ·åç™»å½•**ã€‚\
è¯·æ³¨æ„ï¼Œå³ä½¿ç”µå­é‚®ä»¶å·²è¢«ä¿®æ”¹ä½†æœªç»éªŒè¯ï¼Œå®ƒä¹Ÿå°†å‡ºç°åœ¨IDä»¤ç‰Œä¸­çš„**`email`** **å­—æ®µ**ä¸­ï¼Œå­—æ®µ**`email_verified`**å°†ä¸º**false**ï¼Œä½†å¦‚æœåº”ç”¨ç¨‹åº**æœªæ£€æŸ¥**ï¼Œæ‚¨å¯èƒ½ä¼šå†’å……å…¶ä»–ç”¨æˆ·ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¿®æ”¹**åç§°å±æ€§**åœ¨**`name`**å­—æ®µä¸­æ”¾å…¥ä»»ä½•å†…å®¹ã€‚å¦‚æœåº”ç”¨ç¨‹åºå‡ºäºæŸç§åŸå› **æ£€æŸ¥**è¯¥å­—æ®µè€Œä¸æ˜¯`email`ï¼ˆæˆ–ä»»ä½•å…¶ä»–å±æ€§ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**å†’å……å…¶ä»–ç”¨æˆ·**ã€‚
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œå¦‚æœç”±äºæŸç§åŸå› æ‚¨å°†æ‚¨çš„ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºæ–°çš„ç”µå­é‚®ä»¶åœ°å€ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨åœ¨è¯¥ç”µå­é‚®ä»¶åœ°å€ä¸­æ”¶åˆ°çš„ä»£ç **ç¡®è®¤ç”µå­é‚®ä»¶**ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
ä½¿ç”¨**`phone_number`**è€Œä¸æ˜¯**`email`**æ¥æ›´æ”¹/éªŒè¯**æ–°çš„ç”µè¯å·ç **ã€‚

{% hint style="info" %}
ç®¡ç†å‘˜è¿˜å¯ä»¥å¯ç”¨é€‰é¡¹ï¼Œä½¿ç”¨ç”¨æˆ·é¦–é€‰çš„ç”¨æˆ·åè¿›è¡Œç™»å½•ã€‚è¯·æ³¨æ„ï¼Œæ‚¨æ— æ³•å°†æ­¤å€¼æ›´æ”¹ä¸ºå·²è¢«ä½¿ç”¨çš„**ä»»ä½•ç”¨æˆ·åæˆ–preferred\_username**ä»¥å†’å……ä¸åŒçš„ç”¨æˆ·ã€‚
{% endhint %}

### æ¢å¤/æ›´æ”¹å¯†ç 

åªéœ€**çŸ¥é“ç”¨æˆ·å**ï¼ˆæˆ–æ¥å—ç”µå­é‚®ä»¶æˆ–ç”µè¯ï¼‰å¹¶è®¿é—®è¯¥ç”¨æˆ·åï¼Œå³å¯æ¢å¤å¯†ç ï¼Œä»£ç å°†å‘é€åˆ°è¯¥ä½ç½®ï¼š
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
æœåŠ¡å™¨çš„å“åº”å§‹ç»ˆæ˜¯ç§¯æçš„ï¼Œå°±åƒç”¨æˆ·åå­˜åœ¨ä¸€æ ·ã€‚æ‚¨æ— æ³•ä½¿ç”¨æ­¤æ–¹æ³•æšä¸¾ç”¨æˆ·ã€‚
{% endhint %}

ä½¿ç”¨ä»¥ä¸‹ä»£ç å¯ä»¥æ›´æ”¹å¯†ç ï¼š
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
è¦æ›´æ”¹å¯†ç ï¼Œæ‚¨éœ€è¦**çŸ¥é“å…ˆå‰çš„å¯†ç **ï¼š
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## è®¤è¯

ç”¨æˆ·æ± æ”¯æŒ**ä¸åŒçš„èº«ä»½éªŒè¯æ–¹å¼**ã€‚å¦‚æœæ‚¨æœ‰**ç”¨æˆ·åå’Œå¯†ç **ï¼Œè¿˜æ”¯æŒ**ä¸åŒçš„ç™»å½•æ–¹æ³•**ã€‚æ­¤å¤–ï¼Œå½“ç”¨æˆ·åœ¨æ± ä¸­è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œä¼šæä¾›**3ç§ç±»å‹çš„ä»¤ç‰Œ**ï¼š**ID ä»¤ç‰Œ**ã€**è®¿é—®ä»¤ç‰Œ**å’Œ**åˆ·æ–°ä»¤ç‰Œ**ã€‚

* [**ID ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html)ï¼šå®ƒåŒ…å«æœ‰å…³**ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„èº«ä»½**çš„å£°æ˜ï¼Œå¦‚`name`ã€`email`å’Œ`phone_number`ã€‚ID ä»¤ç‰Œè¿˜å¯ç”¨äº**å°†ç”¨æˆ·èº«ä»½éªŒè¯åˆ°æ‚¨çš„èµ„æºæœåŠ¡å™¨æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åº**ã€‚åœ¨æ‚¨å°†å…¶ç”¨äºå¤–éƒ¨åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œå¿…é¡»**éªŒè¯**ID ä»¤ç‰Œçš„**ç­¾å**ï¼Œä»¥ä¾¿ä¿¡ä»»ID ä»¤ç‰Œä¸­çš„ä»»ä½•å£°æ˜ã€‚
* ID ä»¤ç‰Œæ˜¯**åŒ…å«ç”¨æˆ·å±æ€§å€¼çš„ä»¤ç‰Œ**ï¼Œç”šè‡³åŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚
* [**è®¿é—®ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html)ï¼šå®ƒåŒ…å«æœ‰å…³ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€ç”¨æˆ·ç»„åˆ—è¡¨å’Œä½œç”¨åŸŸåˆ—è¡¨çš„å£°æ˜ã€‚è®¿é—®ä»¤ç‰Œçš„ç›®çš„æ˜¯**æˆæƒç”¨æˆ·æ± ä¸­ç”¨æˆ·çš„ API æ“ä½œ**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**æˆäºˆç”¨æˆ·è®¿é—®æƒé™**ä»¥æ·»åŠ ã€æ›´æ”¹æˆ–åˆ é™¤ç”¨æˆ·å±æ€§ã€‚
* [**åˆ·æ–°ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html)ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä¸ºç”¨æˆ·è·å–æ–°çš„ ID ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œï¼Œç›´åˆ°**åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**ã€‚**é»˜è®¤æƒ…å†µä¸‹**ï¼Œåˆ·æ–°ä»¤ç‰Œ**åœ¨ç”¨æˆ·ç™»å½•åˆ°ç”¨æˆ·æ± åçš„ 30 å¤©åè¿‡æœŸ**ã€‚åˆ›å»ºç”¨æˆ·æ± çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**60åˆ†é’Ÿè‡³10å¹´ä¹‹é—´çš„ä»»ä½•å€¼**ã€‚

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

è¿™æ˜¯æœåŠ¡å™¨ç«¯çš„èº«ä»½éªŒè¯æµç¨‹ï¼š

* æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè°ƒç”¨**`AdminInitiateAuth` API æ“ä½œ**ï¼ˆè€Œä¸æ˜¯`InitiateAuth`ï¼‰ã€‚æ­¤æ“ä½œéœ€è¦å…·æœ‰åŒ…æ‹¬**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„ AWS å‡­æ®ã€‚è¯¥æ“ä½œè¿”å›æ‰€éœ€çš„èº«ä»½éªŒè¯å‚æ•°ã€‚
* åœ¨æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºè·å¾—**èº«ä»½éªŒè¯å‚æ•°**åï¼Œè°ƒç”¨**`AdminRespondToAuthChallenge` API æ“ä½œ**ã€‚åªæœ‰åœ¨æä¾› AWS å‡­æ®æ—¶ï¼Œ`AdminRespondToAuthChallenge` API æ“ä½œæ‰ä¼šæˆåŠŸã€‚

æ­¤æ–¹æ³•**é»˜è®¤æƒ…å†µä¸‹æœªå¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

* ç”¨æˆ·æ±  ID
* å®¢æˆ·ç«¯ ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•**ï¼Œè¯¥åº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨`ALLOW_ADMIN_USER_PASSWORD_AUTH`ç™»å½•ã€‚\
æ­¤å¤–ï¼Œè¦æ‰§è¡Œæ­¤æ“ä½œï¼Œæ‚¨éœ€è¦å…·æœ‰**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„å‡­æ®ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ç™»å½•ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

è¿™ç§æ–¹æ³•æ˜¯å¦ä¸€ç§ç®€å•ä¸”ä¼ ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç è®¤è¯æµç¨‹ã€‚å»ºè®®å°†ä¼ ç»Ÿçš„è®¤è¯æ–¹æ³•è¿ç§»åˆ° Cognitoï¼Œå¹¶å»ºè®®éšåç¦ç”¨å®ƒï¼Œç„¶åæ”¹ç”¨ ALLOW\_USER\_SRP\_AUTH æ–¹æ³•ï¼ˆå› ä¸ºè¯¥æ–¹æ³•æ°¸è¿œä¸ä¼šé€šè¿‡ç½‘ç»œå‘é€å¯†ç ï¼‰ã€‚\
æ­¤æ–¹æ³•é»˜è®¤**æœªå¯ç”¨**ã€‚

ä¸ä»£ç ä¸­çš„å…ˆå‰è®¤è¯æ–¹æ³•çš„ä¸»è¦**åŒºåˆ«**åœ¨äºï¼Œæ‚¨**æ— éœ€çŸ¥é“ç”¨æˆ·æ±  ID**ï¼Œä¹Ÿ**æ— éœ€åœ¨ Cognito ç”¨æˆ·æ± ä¸­è·å¾—é¢å¤–æƒé™**ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

- å®¢æˆ·ç«¯ ID
- ç”¨æˆ·å
- å¯†ç 
- å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†**èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•**ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨ ALLOW\_USER\_PASSWORD\_AUTH è¿›è¡Œç™»å½•ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Pythonä»£ç ç™»å½•</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### ç”¨æˆ·\_SRP\_AUTH

è¿™ç§æƒ…å†µä¸ä¹‹å‰çš„æƒ…å†µç±»ä¼¼ï¼Œä½†æ˜¯**ä¸æ˜¯é€šè¿‡ç½‘ç»œå‘é€å¯†ç **æ¥ç™»å½•ï¼Œè€Œæ˜¯æ‰§è¡Œ**æŒ‘æˆ˜è®¤è¯**ï¼ˆå› æ­¤å¯†ç ç”šè‡³ä¸ä¼šåŠ å¯†é€šè¿‡ç½‘ç»œä¼ è¾“ï¼‰ã€‚\
è¿™ç§**æ–¹æ³•é»˜è®¤å¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

- ç”¨æˆ·æ±  ID
- å®¢æˆ·ç«¯ ID
- ç”¨æˆ·å
- å¯†ç 
- å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

æ­¤æ–¹æ³•**å§‹ç»ˆæœ‰æ•ˆ**ï¼ˆæ— æ³•ç¦ç”¨ï¼‰ï¼Œä½†æ‚¨éœ€è¦æ‹¥æœ‰æœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>ä»£ç åˆ·æ–°</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM_AUTH

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**èº«ä»½éªŒè¯** å°†é€šè¿‡**æ‰§è¡Œ lambda å‡½æ•°**æ¥æ‰§è¡Œã€‚

## é¢å¤–å®‰å…¨æ€§

### é«˜çº§å®‰å…¨æ€§

é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼Œä½†å¦‚æœå¯ç”¨ï¼ŒCognito å¯èƒ½èƒ½å¤Ÿ**å‘ç°è´¦æˆ·åŠ«æŒ**ã€‚ä¸ºäº†æœ€å°åŒ–æ¦‚ç‡ï¼Œæ‚¨åº”è¯¥ä»**ä½äºåŒä¸€åŸå¸‚å†…çš„ç½‘ç»œ**ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ä»£ç†ç™»å½•ï¼ˆå¦‚æœå¯èƒ½çš„è¯ä½¿ç”¨ç›¸åŒçš„ IPï¼‰ã€‚

### **MFA è®°ä½è®¾å¤‡**

å¦‚æœç”¨æˆ·ä»åŒä¸€è®¾å¤‡ç™»å½•ï¼Œåˆ™ MFA å¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œå› æ­¤å°è¯•ä½¿ç”¨ç›¸åŒçš„æµè§ˆå™¨å’Œç›¸åŒçš„å…ƒæ•°æ®ï¼ˆIPï¼Ÿï¼‰å°è¯•ç»•è¿‡ MFA ä¿æŠ¤ã€‚

## ç”¨æˆ·æ± ç»„ IAM è§’è‰²

å¯ä»¥å°†**ç”¨æˆ·æ·»åŠ åˆ°ä¸ä¸€ä¸ª IAM è§’è‰²ç›¸å…³çš„ç”¨æˆ·æ± **ç»„ä¸­ã€‚\
æ­¤å¤–ï¼Œ**ç”¨æˆ·**å¯ä»¥åˆ†é…ç»™**å¤šä¸ªå…·æœ‰ä¸åŒ IAM è§’è‰²çš„ç»„**ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ä¸€ä¸ªç»„ä½äºå…·æœ‰ IAM è§’è‰²çš„ç»„ä¸­ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®è¯¥ç»„çš„ IAM å‡­æ®ï¼Œéœ€è¦**ç”¨æˆ·æ± å—åˆ°èº«ä»½æ± çš„ä¿¡ä»»**ï¼ˆå¹¶äº†è§£è¯¥èº«ä»½æ± çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

åœ¨ç”¨æˆ·æ± ä¸­å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰ï¼Œè·å¾—**IdToken ä¸­æŒ‡ç¤ºçš„ IAM è§’è‰²**çš„å¦ä¸€ä¸ªè¦æ±‚æ˜¯**èº«ä»½æä¾›è€…èº«ä»½éªŒè¯æä¾›è€…**éœ€è¦æŒ‡ç¤º**å¿…é¡»ä»ä»¤ç‰Œä¸­é€‰æ‹©è§’è‰²**ã€‚

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥è®¿é—®çš„**è§’è‰²**ä½äº**`IdToken`**ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨**`--custom-role-arn`**ä»`aws cognito-identity get-credentials-for-identity`ä¸­**é€‰æ‹©è¦è·å–å‡­æ®çš„è§’è‰²**ã€‚\
ä½†æ˜¯ï¼Œå¦‚æœ**é»˜è®¤é€‰é¡¹**æ˜¯**å·²é…ç½®çš„é€‰é¡¹**ï¼ˆ`use default role`ï¼‰ï¼Œå¹¶ä¸”æ‚¨å°è¯•ä» IdToken è®¿é—®è§’è‰²ï¼Œåˆ™ä¼šæ”¶åˆ°**é”™è¯¯**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å…ˆå‰çš„é…ç½®ï¼‰ï¼š

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåˆ†é…ç»™**ç”¨æˆ·æ± ç»„**çš„è§’è‰²éœ€è¦**å¯è¢«èº«ä»½æä¾›è€…è®¿é—®**ï¼Œè¯¥èº«ä»½æä¾›è€…**ä¿¡ä»»ç”¨æˆ·æ± **ï¼ˆå› ä¸ºIAMè§’è‰²**ä¼šä»ä¸­è·å–ä¼šè¯å‡­æ®**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
