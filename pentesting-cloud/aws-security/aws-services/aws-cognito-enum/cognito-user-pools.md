# Cognito User Pools

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Un user pool es un directorio de usuarios en Amazon Cognito. Con un user pool, tus usuarios pueden **iniciar sesi贸n en tu aplicaci贸n web o m贸vil** a trav茅s de Amazon Cognito, **o federarse** a trav茅s de un proveedor de identidad **tercero** (IdP). Ya sea que tus usuarios inicien sesi贸n directamente o a trav茅s de un tercero, todos los miembros del user pool tienen un perfil en el directorio al que puedes acceder a trav茅s de un SDK.

Los user pools proporcionan:

* Servicios de registro e inicio de sesi贸n.
* Una interfaz web incorporada y personalizable para iniciar sesi贸n de usuarios.
* Inicio de sesi贸n social con Facebook, Google, Login with Amazon y Sign in with Apple, y a trav茅s de proveedores de identidad SAML y OIDC de tu user pool.
* Gesti贸n de directorios de usuarios y perfiles de usuarios.
* Funciones de seguridad como autenticaci贸n de m煤ltiples factores (MFA), verificaciones de credenciales comprometidas, protecci贸n contra la toma de cuentas y verificaci贸n de tel茅fono y correo electr贸nico.
* Flujos de trabajo personalizados y migraci贸n de usuarios a trav茅s de disparadores de AWS Lambda.

El **c贸digo fuente** de las aplicaciones generalmente tambi茅n contiene el **ID del user pool** y el **ID de la aplicaci贸n cliente**, (驴y a veces el **secreto de la aplicaci贸n**?) que son necesarios para que un **usuario inicie sesi贸n** en un Cognito User Pool.

### Ataques potenciales

* **Registro**: Por defecto, un usuario puede registrarse 茅l mismo, por lo que podr铆a crear un usuario para s铆 mismo.
* **Enumeraci贸n de usuarios**: La funcionalidad de registro se puede utilizar para encontrar nombres de usuario que ya existen. Esta informaci贸n puede ser 煤til para el ataque de fuerza bruta.
* **Fuerza bruta de inicio de sesi贸n**: En la secci贸n [**Autenticaci贸n**](cognito-user-pools.md#authentication) tienes todos los **m茅todos** que un usuario tiene para **iniciar sesi贸n**, podr铆as intentar forzarlos para **encontrar credenciales v谩lidas**.

### Herramientas para pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotaci贸n de AWS, ahora incluye los m贸dulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeraci贸n de todos los activos de Cognito en una cuenta y marcan configuraciones d茅biles, atributos de usuario utilizados para el control de acceso, etc., y tambi茅n automatizan la creaci贸n de usuarios (incluyendo soporte para MFA) y la escalada de privilegios basada en atributos personalizables modificables, credenciales de identity pool utilizables, roles asumibles en tokens de identidad, etc.

Para una descripci贸n de las funciones de los m贸dulos, consulta la parte 2 del [art铆culo del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalaci贸n, consulta la p谩gina principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Ejemplo de uso de cognito\_\_attack para intentar la creaci贸n de usuarios y todos los vectores de privesc contra un identity pool y cliente de user pool dado:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de muestra de cognito\_\_enum para recopilar todos los user pools, user pool clients, identity pools, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito incluyendo la creaci贸n de cuentas no deseadas y or谩culo de cuentas.

#### Instalaci贸n
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
Para obtener m谩s informaci贸n, consulta https://github.com/padok-team/cognito-scanner

## Registro

User Pools permite por **defecto** **registrar nuevos usuarios**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Si cualquiera puede registrarse

Podr铆as encontrar un error indic谩ndote que necesitas **proporcionar m谩s detalles** sobre el usuario:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Puede proporcionar los detalles necesarios con un JSON como:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Puedes utilizar esta funcionalidad tambi茅n para **enumerar usuarios existentes.** Este es el mensaje de error cuando ya existe un usuario con ese nombre:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Nota en el comando anterior c贸mo los **atributos personalizados comienzan con "custom:"**.\
Tambi茅n ten en cuenta que al registrar **no puedes crear nuevos atributos personalizados para el usuario**. Solo puedes dar valor a los **atributos predeterminados** (incluso si no son obligatorios) y a los **atributos personalizados especificados**.
{% endhint %}

O simplemente para probar si un client id existe. Este es el error si el client-id no existe:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Si solo el administrador puede registrar usuarios

Encontrar谩s este error y no podr谩s registrar o enumerar usuarios:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Verificaci贸n de Registro

Cognito permite **verificar un nuevo usuario verificando su correo electr贸nico o n煤mero de tel茅fono**. Por lo tanto, al crear un usuario generalmente se requerir谩 al menos el nombre de usuario y la contrase帽a y el **correo electr贸nico y/o n煤mero de tel茅fono**. Solo establece uno **que controles** para que recibas el c贸digo y **verifiques tu** cuenta de usuario reci茅n creada de la siguiente manera:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Aunque **parezca que puedes usar el mismo correo electr贸nico** y n煤mero de tel茅fono, cuando necesitas verificar el usuario creado, Cognito se quejar谩 de usar la misma informaci贸n y **no te permitir谩 verificar la cuenta**.
{% endhint %}

### Escalada de Privilegios / Actualizaci贸n de Atributos

Por defecto, un usuario puede **modificar el valor de sus atributos** con algo como:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Escalada de privilegios con atributo personalizado

{% hint style="danger" %}
Puede que encuentres **atributos personalizados** en uso (como `isAdmin`), ya que por defecto puedes **cambiar los valores de tus propios atributos**, podr铆as ser capaz de **escalar privilegios** cambiando el valor t煤 mismo.
{% endhint %}

#### Escalada de privilegios por modificaci贸n de email/usuario

Puedes usar esto para **modificar el email y n煤mero de tel茅fono** de un usuario, pero entonces, incluso si la cuenta permanece verificada, esos atributos se **establecen en estado no verificado** (necesitas verificarlos de nuevo).

{% hint style="warning" %}
**No podr谩s iniciar sesi贸n con el email o n煤mero de tel茅fono** hasta que los verifiques, pero ser谩s **capaz de iniciar sesi贸n con el nombre de usuario**.\
Ten en cuenta que incluso si el email fue modificado y no verificado, aparecer谩 en el Token de Identificaci贸n en el campo **`email`** y el campo **`email_verified`** ser谩 **falso**, pero si la aplicaci贸n **no est谩 comprobando eso, podr铆as suplantar a otros usuarios**.

Adem谩s, ten en cuenta que puedes poner cualquier cosa dentro del campo **`name`** simplemente modificando el **atributo de nombre**. Si una aplicaci贸n est谩 **comprobando** ese campo por alguna raz贸n **en lugar del `email`** (u otro atributo), podr铆as ser capaz de **suplantar a otros usuarios**.
{% endhint %}

De todos modos, si por alguna raz贸n cambiaste tu email por ejemplo a uno nuevo al que puedes acceder, puedes **confirmar el email con el c贸digo que recibiste en esa direcci贸n de email**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Utiliza **`phone_number`** en lugar de **`email`** para cambiar/verificar un **n煤mero de tel茅fono nuevo**.

{% hint style="info" %}
El administrador tambi茅n puede habilitar la opci贸n de **iniciar sesi贸n con un nombre de usuario preferido por el usuario**. Ten en cuenta que no podr谩s cambiar este valor a **cualquier nombre de usuario o preferred_username que ya est茅 en uso** para suplantar a otro usuario.
{% endhint %}

### Recuperar/Cambiar Contrase帽a

Es posible recuperar una contrase帽a simplemente **conociendo el nombre de usuario** (o se acepta el email o tel茅fono) y teniendo acceso a 茅l, ya que se enviar谩 un c贸digo all铆:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
La respuesta del servidor siempre va a ser positiva, como si el nombre de usuario existiera. No puedes utilizar este m茅todo para enumerar usuarios.
{% endhint %}

Con el c贸digo puedes cambiar la contrase帽a con:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Para cambiar la contrase帽a necesitas **conocer la contrase帽a anterior**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Autenticaci贸n

Un user pool soporta **diferentes maneras de autenticarse** en 茅l. Si tienes un **nombre de usuario y contrase帽a**, tambi茅n hay **diferentes m茅todos** soportados para iniciar sesi贸n.\
Adem谩s, cuando un usuario est谩 autenticado en el Pool se entregan **3 tipos de tokens**: El **ID Token**, el **Access token** y el **Refresh token**.

* [**ID Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Contiene afirmaciones sobre la **identidad del usuario autenticado,** como `name`, `email` y `phone_number`. El ID token tambi茅n se puede usar para **autenticar usuarios en tus servidores de recursos o aplicaciones servidoras**. Debes **verificar** la **firma** del ID token antes de que puedas confiar en cualquier afirmaci贸n dentro del ID token si lo usas en aplicaciones externas.
* El ID Token es el token que **contiene los valores de los atributos del usuario**, incluso los personalizados.
* [**Access Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Contiene afirmaciones sobre el usuario autenticado, una lista de los **grupos del usuario y una lista de alcances**. El prop贸sito del access token es **autorizar operaciones de API** en el contexto del usuario en el user pool. Por ejemplo, puedes usar el access token para **conceder acceso a tu usuario** para agregar, cambiar o eliminar atributos de usuario.
* [**Refresh Token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Con los refresh tokens puedes **obtener nuevos ID Tokens y Access Tokens** para el usuario hasta que el **refresh token sea inv谩lido**. Por **defecto**, el refresh token **expira 30 d铆as despu茅s** de que el usuario de tu aplicaci贸n inicia sesi贸n en tu user pool. Cuando creas una aplicaci贸n para tu user pool, puedes establecer la expiraci贸n del refresh token de la aplicaci贸n a **cualquier valor entre 60 minutos y 10 a帽os**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Este es el flujo de autenticaci贸n del lado del servidor:

* La aplicaci贸n del lado del servidor llama a la operaci贸n **`AdminInitiateAuth` API** (en lugar de `InitiateAuth`). Esta operaci贸n requiere credenciales de AWS con permisos que incluyen **`cognito-idp:AdminInitiateAuth`** y **`cognito-idp:AdminRespondToAuthChallenge`**. La operaci贸n devuelve los par谩metros de autenticaci贸n requeridos.
* Despu茅s de que la aplicaci贸n del lado del servidor tiene los **par谩metros de autenticaci贸n**, llama a la operaci贸n **`AdminRespondToAuthChallenge` API**. La operaci贸n `AdminRespondToAuthChallenge` API solo tiene 茅xito cuando proporcionas credenciales de AWS.

Este **m茅todo NO est谩 habilitado** por defecto.

Para **iniciar sesi贸n** necesitas saber:

* id del user pool
* id del cliente
* nombre de usuario
* contrase帽a
* secreto del cliente (solo si la aplicaci贸n est谩 configurada para usar un secreto)

{% hint style="info" %}
Para ser **capaz de iniciar sesi贸n con este m茅todo** esa aplicaci贸n debe permitir iniciar sesi贸n con `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Adem谩s, para realizar esta acci贸n necesitas credenciales con los permisos **`cognito-idp:AdminInitiateAuth`** y **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>C贸digo para Iniciar Sesi贸n</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Este m茅todo es otro flujo de autenticaci贸n **tradicional de usuario y contrase帽a** simple. Se recomienda **migrar un m茅todo de autenticaci贸n tradicional a Cognito** y luego se recomienda **deshabilitarlo** y **usar** el m茅todo **ALLOW\_USER\_SRP\_AUTH** en su lugar (ya que ese nunca env铆a la contrase帽a a trav茅s de la red).\
Este **m茅todo NO est谩 habilitado** por defecto.

La principal **diferencia** con el **m茅todo de autenticaci贸n anterior** dentro del c贸digo es que **no necesitas conocer el ID del grupo de usuarios** y que **no necesitas permisos adicionales** en el Cognito User Pool.

Para **iniciar sesi贸n** necesitas saber:

* client id
* username
* password
* client secret (solo si la aplicaci贸n est谩 configurada para usar un secreto)

{% hint style="info" %}
Para poder **iniciar sesi贸n con este m茅todo**, la aplicaci贸n debe permitir el inicio de sesi贸n con ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>C贸digo Python para iniciar sesi贸n</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Este escenario es similar al anterior pero **en lugar de enviar la contrase帽a** a trav茅s de la red para iniciar sesi贸n, se realiza una **autenticaci贸n por desaf铆o** (as铆 que no hay contrase帽a circulando, incluso cifrada, por la red).\
Este **m茅todo est谩 habilitado** por defecto.

Para **iniciar sesi贸n** necesitas conocer:

* id del pool de usuarios
* id del cliente
* nombre de usuario
* contrase帽a
* secreto del cliente (solo si la aplicaci贸n est谩 configurada para usar un secreto)

<details>

<summary>C贸digo para iniciar sesi贸n</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Este **m茅todo siempre va a ser v谩lido** (no se puede deshabilitar) pero necesitas tener un token de actualizaci贸n v谩lido.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>C贸digo para refrescar</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

En este caso la **autenticaci贸n** se realizar谩 a trav茅s de la **ejecuci贸n de una funci贸n lambda**.

## Seguridad Extra

### Seguridad Avanzada

Por defecto est谩 desactivada, pero si se activa, Cognito podr铆a ser capaz de **detectar tomas de control de cuentas**. Para minimizar la probabilidad, deber铆as iniciar sesi贸n desde una **red dentro de la misma ciudad, utilizando el mismo agente de usuario** (y IP si es posible)**.**

### **MFA Recordar dispositivo**

Si el usuario inicia sesi贸n desde el mismo dispositivo, el MFA podr铆a ser omitido, por lo tanto, intenta iniciar sesi贸n desde el mismo navegador con los mismos metadatos (驴IP?) para intentar eludir la protecci贸n MFA.

## Grupos de User Pool Roles IAM

Es posible agregar **usuarios a grupos de User Pool** que est谩n relacionados con uno **roles IAM**.\
Adem谩s, los **usuarios** pueden ser asignados a **m谩s de 1 grupo con diferentes roles IAM** adjuntos.

Ten en cuenta que incluso si un grupo est谩 dentro de un grupo con un rol IAM adjunto, para poder acceder a las credenciales IAM de ese grupo es necesario que el **User Pool sea confiado por un Identity Pool** (y conocer los detalles de ese Identity Pool).

Otro requisito para obtener el **rol IAM indicado en el IdToken** cuando un usuario est谩 autenticado en el User Pool (`aws cognito-idp initiate-auth...`) es que el **proveedor de autenticaci贸n del proveedor de identidad** necesita indicar que el **rol debe ser seleccionado del token.**

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2).png" alt=""><figcaption></figcaption></figure>

Los **roles** a los que un usuario tiene acceso est谩n **dentro del `IdToken`**, y un usuario puede **seleccionar qu茅 rol le gustar铆a credenciales para** con el **`--custom-role-arn`** de `aws cognito-identity get-credentials-for-identity`.\
Sin embargo, si la **opci贸n por defecto** es la que est谩 **configurada** (`use default role`), y tratas de acceder a un rol desde el IdToken, obtendr谩s un **error** (por eso se necesita la configuraci贸n previa):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Tenga en cuenta que el rol asignado a un **Grupo de Usuarios** necesita ser **accesible por el Proveedor de Identidad** que **conf铆a en el Grupo de Usuarios** (ya que las **credenciales de sesi贸n del rol IAM se van a obtener de 茅l**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
