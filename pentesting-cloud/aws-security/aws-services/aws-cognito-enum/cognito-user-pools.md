# Cognito ç”¨æˆ·æ± 

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

ç”¨æˆ·æ± æ˜¯Amazon Cognitoä¸­çš„ç”¨æˆ·ç›®å½•ã€‚é€šè¿‡ç”¨æˆ·æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡Amazon Cognito**ç™»å½•åˆ°æ‚¨çš„ç½‘é¡µæˆ–ç§»åŠ¨åº”ç”¨**ï¼Œæˆ–è€…é€šè¿‡**ç¬¬ä¸‰æ–¹**èº«ä»½æä¾›å•†(IdP)è¿›è¡Œ**è”åˆèº«ä»½éªŒè¯**ã€‚æ— è®ºç”¨æˆ·æ˜¯ç›´æ¥ç™»å½•è¿˜æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹ï¼Œç”¨æˆ·æ± ä¸­çš„æ‰€æœ‰æˆå‘˜éƒ½æœ‰ä¸€ä¸ªæ‚¨å¯ä»¥é€šè¿‡SDKè®¿é—®çš„ç›®å½•é…ç½®æ–‡ä»¶ã€‚

ç”¨æˆ·æ± æä¾›ï¼š

* æ³¨å†Œå’Œç™»å½•æœåŠ¡ã€‚
* å†…ç½®çš„ã€å¯å®šåˆ¶çš„ç”¨äºç”¨æˆ·ç™»å½•çš„ç½‘é¡µUIã€‚
* é€šè¿‡Facebookã€Googleã€Login with Amazonå’ŒSign in with Appleè¿›è¡Œç¤¾äº¤ç™»å½•ï¼Œä»¥åŠé€šè¿‡æ‚¨ç”¨æˆ·æ± ä¸­çš„SAMLå’ŒOIDCèº«ä»½æä¾›å•†è¿›è¡Œç¤¾äº¤ç™»å½•ã€‚
* ç”¨æˆ·ç›®å½•ç®¡ç†å’Œç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
* å®‰å…¨åŠŸèƒ½ï¼Œå¦‚å¤šå› ç´ è®¤è¯(MFA)ã€æ£€æŸ¥å—æŸå‡­è¯ã€è´¦æˆ·æ¥ç®¡ä¿æŠ¤ä»¥åŠç”µè¯å’Œç”µå­é‚®ä»¶éªŒè¯ã€‚
* é€šè¿‡AWS Lambdaè§¦å‘å™¨å®šåˆ¶å·¥ä½œæµç¨‹å’Œç”¨æˆ·è¿ç§»ã€‚

**æºä»£ç **é€šå¸¸ä¹Ÿä¼šåŒ…å«**ç”¨æˆ·æ± ID**å’Œ**å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºID**ï¼ˆæœ‰æ—¶è¿˜æœ‰**åº”ç”¨ç¨‹åºå¯†é’¥**ï¼Ÿï¼‰ï¼Œè¿™äº›æ˜¯ç”¨æˆ·ç™»å½•Cognitoç”¨æˆ·æ± æ‰€éœ€çš„ã€‚

### æ½œåœ¨æ”»å‡»

* **æ³¨å†Œ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œæ³¨å†Œï¼Œå› æ­¤ä»–å¯ä»¥ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
* **ç”¨æˆ·æšä¸¾**ï¼šæ³¨å†ŒåŠŸèƒ½å¯ç”¨äºæŸ¥æ‰¾å·²ç»å­˜åœ¨çš„ç”¨æˆ·åã€‚è¿™äº›ä¿¡æ¯å¯¹äºæš´åŠ›ç ´è§£æ”»å‡»å¾ˆæœ‰ç”¨ã€‚
* **ç™»å½•æš´åŠ›ç ´è§£**ï¼šåœ¨[**è®¤è¯**](cognito-user-pools.md#authentication)éƒ¨åˆ†ï¼Œæ‚¨æœ‰æ‰€æœ‰ç”¨æˆ·**ç™»å½•**çš„**æ–¹æ³•**ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£å®ƒä»¬**æ‰¾åˆ°æœ‰æ•ˆå‡­è¯**ã€‚

### ç”¨äºæ¸—é€æµ‹è¯•çš„å·¥å…·

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)ï¼ŒAWSåˆ©ç”¨æ¡†æ¶ï¼Œç°åœ¨åŒ…æ‹¬"cognito\_\_enum"å’Œ"cognito\_\_attack"æ¨¡å—ï¼Œè¿™äº›æ¨¡å—è‡ªåŠ¨æšä¸¾è´¦æˆ·ä¸­çš„æ‰€æœ‰Cognitoèµ„äº§å¹¶æ ‡è®°å¼±é…ç½®ã€ç”¨äºè®¿é—®æ§åˆ¶çš„ç”¨æˆ·å±æ€§ç­‰ï¼Œå¹¶è‡ªåŠ¨åŒ–ç”¨æˆ·åˆ›å»ºï¼ˆåŒ…æ‹¬MFAæ”¯æŒï¼‰å’ŒåŸºäºå¯ä¿®æ”¹çš„è‡ªå®šä¹‰å±æ€§ã€å¯ç”¨çš„èº«ä»½æ± å‡­è¯ã€idä»¤ç‰Œä¸­çš„å¯å‡è®¾è§’è‰²ç­‰è¿›è¡Œæƒé™æå‡ã€‚

æœ‰å…³æ¨¡å—åŠŸèƒ½çš„æè¿°ï¼Œè¯·å‚é˜…[åšå®¢æ–‡ç« ](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)çš„ç¬¬2éƒ¨åˆ†ã€‚æœ‰å…³å®‰è£…è¯´æ˜ï¼Œè¯·å‚é˜…ä¸»è¦çš„[Pacu](https://github.com/RhinoSecurityLabs/pacu)é¡µé¢ã€‚

#### ä½¿ç”¨æ–¹æ³•

å°è¯•é’ˆå¯¹ç»™å®šèº«ä»½æ± å’Œç”¨æˆ·æ± å®¢æˆ·ç«¯åˆ›å»ºç”¨æˆ·å’Œæ‰€æœ‰æƒé™æå‡å‘é‡çš„ç¤ºä¾‹cognito\_\_attackä½¿ç”¨æ–¹æ³•ï¼š
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```markdown
ç¤ºä¾‹ cognito__enum çš„ç”¨æ³•ï¼Œç”¨äºæ”¶é›†å½“å‰ AWS è´¦æˆ·ä¸­å¯è§çš„æ‰€æœ‰ç”¨æˆ·æ± ã€ç”¨æˆ·æ± å®¢æˆ·ç«¯ã€èº«ä»½æ± ã€ç”¨æˆ·ç­‰ï¼š
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) æ˜¯ä¸€ä¸ªç”¨Pythonç¼–å†™çš„CLIå·¥å…·ï¼Œå®ç°äº†å¯¹Cognitoçš„ä¸åŒæ”»å‡»ï¼ŒåŒ…æ‹¬ä¸å¿…è¦çš„è´¦æˆ·åˆ›å»ºå’Œè´¦æˆ·é¢„è¨€æœºã€‚

#### å®‰è£…
```bash
$ pip install cognito-scanner
```
#### ä½¿ç”¨æ–¹æ³•
```bash
$ cognito-scanner --help
```
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ https://github.com/padok-team/cognito-scanner

## æ³¨å†Œ

User Pools **é»˜è®¤**å…è®¸**æ³¨å†Œæ–°ç”¨æˆ·**ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### å¦‚æœä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œ

ä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯ï¼Œæç¤ºä½ éœ€è¦**æä¾›æ›´å¤šå…³äºç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯**ï¼š
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
æ‚¨å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„JSONæ¥æä¾›æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯ï¼š
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æ¥**æšä¸¾ç°æœ‰ç”¨æˆ·ã€‚**å½“ç”¨æˆ·åå·²å­˜åœ¨æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨ä¸Šä¸€ä¸ªå‘½ä»¤ä¸­ï¼Œ**è‡ªå®šä¹‰å±æ€§ä»¥â€œcustom:â€å¼€å¤´**ã€‚\
è¿˜è¦çŸ¥é“ï¼Œåœ¨æ³¨å†Œæ—¶ï¼Œæ‚¨**ä¸èƒ½ä¸ºç”¨æˆ·åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å±æ€§**ã€‚æ‚¨åªèƒ½ä¸º**é»˜è®¤å±æ€§**ï¼ˆå³ä½¿å®ƒä»¬ä¸æ˜¯å¿…éœ€çš„ï¼‰å’Œ**æŒ‡å®šçš„è‡ªå®šä¹‰å±æ€§**èµ‹å€¼ã€‚
{% endhint %}

æˆ–è€…åªæ˜¯ä¸ºäº†æµ‹è¯•å®¢æˆ·ç«¯ ID æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå®¢æˆ·ç«¯ ID ä¸å­˜åœ¨ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### å¦‚æœåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ³¨å†Œç”¨æˆ·

æ‚¨ä¼šå‘ç°æ­¤é”™è¯¯ï¼Œå¹¶ä¸”æ— æ³•æ³¨å†Œæˆ–æšä¸¾ç”¨æˆ·ï¼š
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### éªŒè¯æ³¨å†Œ

Cognito å…è®¸é€šè¿‡**éªŒè¯å…¶ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç **æ¥**éªŒè¯æ–°ç”¨æˆ·**ã€‚å› æ­¤ï¼Œåœ¨åˆ›å»ºç”¨æˆ·æ—¶ï¼Œé€šå¸¸è‡³å°‘éœ€è¦ç”¨æˆ·åå’Œå¯†ç ä»¥åŠ**ç”µå­é‚®ä»¶å’Œ/æˆ–ç”µè¯å·ç **ã€‚åªéœ€è®¾ç½®ä¸€ä¸ª**ä½ æ§åˆ¶çš„**ï¼Œè¿™æ ·ä½ å°±ä¼šæ”¶åˆ°ä»£ç æ¥**éªŒè¯ä½ çš„**æ–°åˆ›å»ºçš„ç”¨æˆ·**è´¦æˆ·**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
å³ä½¿**çœ‹èµ·æ¥ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç”µå­é‚®ä»¶**å’Œç”µè¯å·ç ï¼Œå½“ä½ éœ€è¦éªŒè¯åˆ›å»ºçš„ç”¨æˆ·æ—¶ï¼ŒCognitoä¼šå› ä¸ºä½¿ç”¨ç›¸åŒçš„ä¿¡æ¯è€ŒæŠ±æ€¨ï¼Œå¹¶ä¸”**ä¸ä¼šå…è®¸ä½ éªŒè¯è´¦æˆ·**ã€‚
{% endhint %}

### æƒé™æå‡ / æ›´æ–°å±æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥**ä¿®æ”¹ä»–çš„å±æ€§å€¼**ï¼Œç±»ä¼¼äºï¼š
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### è‡ªå®šä¹‰å±æ€§æƒé™æå‡

{% hint style="danger" %}
ä½ å¯èƒ½ä¼šå‘ç°ä½¿ç”¨äº†**è‡ªå®šä¹‰å±æ€§**ï¼ˆä¾‹å¦‚`isAdmin`ï¼‰ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ä½ å¯ä»¥**æ›´æ”¹è‡ªå·±å±æ€§çš„å€¼**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡è‡ªè¡Œæ›´æ”¹å€¼æ¥**æå‡æƒé™**ï¼
{% endhint %}

#### ç”µå­é‚®ä»¶/ç”¨æˆ·åä¿®æ”¹æƒé™æå‡

ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥**ä¿®æ”¹ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œç”µè¯å·ç **ï¼Œä½†å³ä½¿è´¦æˆ·ä¿æŒéªŒè¯çŠ¶æ€ï¼Œè¿™äº›å±æ€§éƒ½ä¼šè¢«**è®¾ç½®ä¸ºæœªéªŒè¯çŠ¶æ€**ï¼ˆä½ éœ€è¦å†æ¬¡éªŒè¯å®ƒä»¬ï¼‰ã€‚

{% hint style="warning" %}
åœ¨ä½ éªŒè¯å®ƒä»¬ä¹‹å‰ï¼Œä½ **æ— æ³•ä½¿ç”¨ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ç™»å½•**ï¼Œä½†ä½ å°†èƒ½å¤Ÿ**ä½¿ç”¨ç”¨æˆ·åç™»å½•**ã€‚\
æ³¨æ„ï¼Œå³ä½¿ç”µå­é‚®ä»¶è¢«ä¿®æ”¹ä¸”æœªç»éªŒè¯ï¼Œå®ƒä¹Ÿä¼šå‡ºç°åœ¨ ID ä»¤ç‰Œçš„**`email`** **å­—æ®µ**ä¸­ï¼Œå­—æ®µ**`email_verified`**å°†æ˜¯**false**ï¼Œä½†å¦‚æœåº”ç”¨ç¨‹åº**æ²¡æœ‰æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œä½ å¯èƒ½ä¼šå†’å……å…¶ä»–ç”¨æˆ·**ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œä½ å¯ä»¥é€šè¿‡ä¿®æ”¹**nameå±æ€§**åœ¨**`name`**å­—æ®µä¸­æ”¾å…¥ä»»ä½•å†…å®¹ã€‚å¦‚æœåº”ç”¨ç¨‹åºå‡ºäºæŸç§åŸå› **æ£€æŸ¥**è¯¥å­—æ®µ**è€Œä¸æ˜¯`email`**ï¼ˆæˆ–ä»»ä½•å…¶ä»–å±æ€§ï¼‰ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**å†’å……å…¶ä»–ç”¨æˆ·**ã€‚
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œå¦‚æœç”±äºæŸç§åŸå› ä½ ä¾‹å¦‚å°†ä½ çš„ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºä¸€ä¸ªæ–°çš„ä½ å¯ä»¥è®¿é—®çš„ç”µå­é‚®ä»¶ï¼Œä½ å¯ä»¥**ä½¿ç”¨ä½ åœ¨è¯¥ç”µå­é‚®ä»¶åœ°å€æ”¶åˆ°çš„ä»£ç æ¥ç¡®è®¤ç”µå­é‚®ä»¶**ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
ä½¿ç”¨ **`phone_number`** æ›¿ä»£ **`email`** æ¥æ›´æ”¹/éªŒè¯**æ–°çš„ç”µè¯å·ç **ã€‚

{% hint style="info" %}
ç®¡ç†å‘˜è¿˜å¯ä»¥å¯ç”¨**ä½¿ç”¨ç”¨æˆ·é¦–é€‰ç”¨æˆ·åç™»å½•**çš„é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å°†æ— æ³•å°†æ­¤å€¼æ›´æ”¹ä¸º**ä»»ä½•å·²è¢«ä½¿ç”¨çš„ç”¨æˆ·åæˆ– preferred_username**ï¼Œä»¥å…å†’å……å…¶ä»–ç”¨æˆ·ã€‚
{% endhint %}

### æ¢å¤/æ›´æ”¹å¯†ç 

åªéœ€**çŸ¥é“ç”¨æˆ·å**ï¼ˆæˆ–æ¥å—ç”µå­é‚®ä»¶æˆ–ç”µè¯ï¼‰ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å®ƒï¼Œå› ä¸ºä¼šæœ‰ä¸€ä¸ªä»£ç å‘é€åˆ°é‚£é‡Œï¼Œå°±å¯ä»¥æ¢å¤å¯†ç ï¼š
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
æœåŠ¡å™¨çš„å“åº”æ€»æ˜¯ä¼šæ˜¯ç§¯æçš„ï¼Œå°±å¥½åƒç”¨æˆ·åå­˜åœ¨ä¸€æ ·ã€‚æ‚¨ä¸èƒ½ä½¿ç”¨æ­¤æ–¹æ³•æ¥æšä¸¾ç”¨æˆ·
{% endhint %}

ä½¿ç”¨ä»¥ä¸‹ä»£ç å¯ä»¥æ›´æ”¹å¯†ç ï¼š
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
è¦æ›´æ”¹å¯†ç ï¼Œæ‚¨éœ€è¦**çŸ¥é“ä¹‹å‰çš„å¯†ç **ï¼š
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## è®¤è¯

ç”¨æˆ·æ± æ”¯æŒ**ä¸åŒçš„è®¤è¯æ–¹å¼**ã€‚å¦‚æœæ‚¨æœ‰**ç”¨æˆ·åå’Œå¯†ç **ï¼Œä¹Ÿæ”¯æŒ**ä¸åŒçš„æ–¹æ³•**è¿›è¡Œç™»å½•ã€‚\
æ­¤å¤–ï¼Œå½“ç”¨æˆ·åœ¨æ± ä¸­è®¤è¯åï¼Œä¼šç»™å‡º**3ç§ç±»å‹çš„ä»¤ç‰Œ**ï¼š**ID ä»¤ç‰Œ**ã€**è®¿é—®ä»¤ç‰Œ**å’Œ**åˆ·æ–°ä»¤ç‰Œ**ã€‚

* [**ID ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html)ï¼šå®ƒåŒ…å«å…³äº**å·²è®¤è¯ç”¨æˆ·èº«ä»½çš„å£°æ˜**ï¼Œå¦‚ `name`ã€`email` å’Œ `phone_number`ã€‚ID ä»¤ç‰Œè¿˜å¯ä»¥ç”¨æ¥**å‘æ‚¨çš„èµ„æºæœåŠ¡å™¨æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åºè®¤è¯ç”¨æˆ·**ã€‚å¦‚æœæ‚¨åœ¨å¤–éƒ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼Œå¿…é¡»**éªŒè¯**ID ä»¤ç‰Œçš„**ç­¾å**ï¼Œæ‰èƒ½ä¿¡ä»»å…¶ä¸­çš„ä»»ä½•å£°æ˜ã€‚
* ID ä»¤ç‰Œæ˜¯åŒ…å«ç”¨æˆ·**å±æ€§å€¼çš„ä»¤ç‰Œ**ï¼Œç”šè‡³åŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚
* [**è®¿é—®ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html)ï¼šå®ƒåŒ…å«å…³äºå·²è®¤è¯ç”¨æˆ·çš„å£°æ˜ã€**ç”¨æˆ·ç»„åˆ—è¡¨å’Œä½œç”¨åŸŸåˆ—è¡¨**ã€‚è®¿é—®ä»¤ç‰Œçš„ç›®çš„æ˜¯åœ¨ç”¨æˆ·æ± ä¸­çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ä¸­**æˆæƒ API æ“ä½œ**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**æˆæƒç”¨æˆ·è®¿é—®**ä»¥æ·»åŠ ã€æ›´æ”¹æˆ–åˆ é™¤ç”¨æˆ·å±æ€§ã€‚
* [**åˆ·æ–°ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html)ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä¸ºç”¨æˆ·**è·å–æ–°çš„ ID ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œ**ï¼Œç›´åˆ°**åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**ã€‚**é»˜è®¤æƒ…å†µä¸‹**ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨æ‚¨çš„åº”ç”¨ç¨‹åºç”¨æˆ·ç™»å½•åˆ°ç”¨æˆ·æ± å**30å¤©åè¿‡æœŸ**ã€‚å½“æ‚¨ä¸ºç”¨æˆ·æ± åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**60åˆ†é’Ÿè‡³10å¹´ä¹‹é—´çš„ä»»ä½•å€¼**ã€‚

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

è¿™æ˜¯æœåŠ¡å™¨ç«¯è®¤è¯æµç¨‹ï¼š

* æœåŠ¡å™¨ç«¯åº”ç”¨è°ƒç”¨ **`AdminInitiateAuth` API æ“ä½œ**ï¼ˆè€Œä¸æ˜¯ `InitiateAuth`ï¼‰ã€‚æ­¤æ“ä½œéœ€è¦å…·æœ‰åŒ…æ‹¬**`cognito-idp:AdminInitiateAuth`** å’Œ **`cognito-idp:AdminRespondToAuthChallenge`** æƒé™çš„ AWS å‡­è¯ã€‚æ“ä½œè¿”å›æ‰€éœ€çš„è®¤è¯å‚æ•°ã€‚
* åœ¨æœåŠ¡å™¨ç«¯åº”ç”¨è·å–äº†**è®¤è¯å‚æ•°**åï¼Œå®ƒè°ƒç”¨ **`AdminRespondToAuthChallenge` API æ“ä½œ**ã€‚`AdminRespondToAuthChallenge` API æ“ä½œåªæœ‰åœ¨æ‚¨æä¾› AWS å‡­è¯æ—¶æ‰ä¼šæˆåŠŸã€‚

æ­¤**æ–¹æ³•é»˜è®¤ä¸å¯ç”¨**ã€‚

è¦**ç™»å½•**æ‚¨**éœ€è¦çŸ¥é“**ï¼š

* ç”¨æˆ·æ±  id
* å®¢æˆ·ç«¯ id
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨é…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•**ç™»å½•**ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»å…è®¸é€šè¿‡ `ALLOW_ADMIN_USER_PASSWORD_AUTH` ç™»å½•ã€‚\
æ­¤å¤–ï¼Œè¦æ‰§è¡Œæ­¤æ“ä½œï¼Œæ‚¨éœ€è¦å…·æœ‰æƒé™**`cognito-idp:AdminInitiateAuth`** å’Œ **`cognito-idp:AdminRespondToAuthChallenge`** çš„å‡­è¯ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ç™»å½•ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

æ­¤æ–¹æ³•æ˜¯å¦ä¸€ç§ç®€å•ä¸”**ä¼ ç»Ÿçš„ç”¨æˆ·ä¸å¯†ç è®¤è¯**æµç¨‹ã€‚å»ºè®®å°†ä¼ ç»Ÿè®¤è¯æ–¹æ³•**è¿ç§»åˆ° Cognito**ï¼Œç„¶åå»ºè®®**ç¦ç”¨**å®ƒï¼Œå¹¶æ”¹ç”¨**ALLOW\_USER\_SRP\_AUTH**æ–¹æ³•ï¼ˆå› ä¸ºè¯¥æ–¹æ³•ä»ä¸é€šè¿‡ç½‘ç»œå‘é€å¯†ç ï¼‰ã€‚\
æ­¤**æ–¹æ³•é»˜è®¤ä¸å¯ç”¨**ã€‚

ä¸**å…ˆå‰è®¤è¯æ–¹æ³•**çš„ä¸»è¦**åŒºåˆ«**åœ¨äºä»£ç ä¸­**ä¸éœ€è¦çŸ¥é“ç”¨æˆ·æ±  ID**ï¼Œä¸”åœ¨ Cognito ç”¨æˆ·æ± ä¸­**ä¸éœ€è¦é¢å¤–æƒé™**ã€‚

è¦**ç™»å½•**ï¼Œä½ éœ€è¦çŸ¥é“ï¼š

* å®¢æˆ·ç«¯ id
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨é…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•**ç™»å½•**ï¼Œåº”ç”¨å¿…é¡»å…è®¸é€šè¿‡ ALLOW\_USER\_PASSWORD\_AUTH ç™»å½•ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Pythonä»£ç ç™»å½•</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

è¿™ç§æƒ…å†µä¸å‰ä¸€ç§ç±»ä¼¼ï¼Œä½†**ä¸æ˜¯é€šè¿‡ç½‘ç»œå‘é€å¯†ç **æ¥ç™»å½•ï¼Œè€Œæ˜¯æ‰§è¡Œ**æŒ‘æˆ˜è®¤è¯**ï¼ˆå› æ­¤æ²¡æœ‰å¯†ç ï¼Œå³ä½¿æ˜¯åŠ å¯†çš„ï¼Œä¹Ÿä¸ä¼šé€šè¿‡ç½‘ç»œä¼ è¾“ï¼‰ã€‚\
è¿™ç§**æ–¹æ³•é»˜è®¤å¯ç”¨**ã€‚

è¦**ç™»å½•**ï¼Œä½ **éœ€è¦**çŸ¥é“ï¼š

* ç”¨æˆ·æ±  ID
* å®¢æˆ·ç«¯ ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨é…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

<details>

<summary>ç™»å½•ä»£ç </summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

æ­¤**æ–¹æ³•å§‹ç»ˆæœ‰æ•ˆ**ï¼ˆæ— æ³•ç¦ç”¨ï¼‰ï¼Œä½†æ‚¨éœ€è¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>åˆ·æ–°ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**è®¤è¯**å°†é€šè¿‡**æ‰§è¡Œä¸€ä¸ªlambdaå‡½æ•°**æ¥è¿›è¡Œã€‚

## é¢å¤–å®‰å…¨æ€§

### é«˜çº§å®‰å…¨

é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼Œä½†å¦‚æœå¯ç”¨ï¼ŒCognitoå¯èƒ½èƒ½å¤Ÿ**å‘ç°è´¦æˆ·æ¥ç®¡**ã€‚ä¸ºäº†æœ€å°åŒ–å¯èƒ½æ€§ï¼Œæ‚¨åº”è¯¥ä»**åŒä¸€åŸå¸‚å†…çš„ç½‘ç»œç™»å½•ï¼Œä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ä»£ç†**ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼Œè¿˜æœ‰IPï¼‰ã€‚

### **MFA è®°ä½è®¾å¤‡**

å¦‚æœç”¨æˆ·ä»åŒä¸€è®¾å¤‡ç™»å½•ï¼ŒMFAå¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œå› æ­¤å°è¯•ä»å¸¦æœ‰ç›¸åŒå…ƒæ•°æ®ï¼ˆIPï¼Ÿï¼‰çš„åŒä¸€æµè§ˆå™¨ç™»å½•ï¼Œä»¥å°è¯•ç»•è¿‡MFAä¿æŠ¤ã€‚

## ç”¨æˆ·æ± ç»„ IAM è§’è‰²

å¯ä»¥å°†**ç”¨æˆ·æ·»åŠ åˆ°ä¸æŸä¸ª**IAMè§’è‰²**ç›¸å…³è”çš„ç”¨æˆ·æ± **ç»„ä¸­ã€‚
æ­¤å¤–ï¼Œ**ç”¨æˆ·**å¯ä»¥è¢«åˆ†é…åˆ°**å¤šä¸ªä¸åŒIAMè§’è‰²**çš„ç»„ä¸­ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ä¸€ä¸ªç»„åœ¨ä¸€ä¸ªé™„æœ‰IAMè§’è‰²çš„ç»„å†…ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®è¯¥ç»„çš„IAMå‡­è¯ï¼Œéœ€è¦**ç”¨æˆ·æ± è¢«ä¸€ä¸ªèº«ä»½æ± ä¿¡ä»»**ï¼ˆå¹¶ä¸”çŸ¥é“è¯¥èº«ä»½æ± çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

å½“ç”¨æˆ·åœ¨ç”¨æˆ·æ± ä¸­è®¤è¯æ—¶ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰ï¼Œè·å–**IdTokenä¸­æŒ‡ç¤ºçš„IAMè§’è‰²**çš„å¦ä¸€ä¸ªè¦æ±‚æ˜¯**èº«ä»½æä¾›å•†è®¤è¯æä¾›å•†**éœ€è¦æŒ‡å‡º**è§’è‰²å¿…é¡»ä»ä»¤ç‰Œä¸­é€‰æ‹©**ã€‚

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥è®¿é—®çš„**è§’è‰²**åœ¨`IdToken`**å†…**ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨`aws cognito-identity get-credentials-for-identity`çš„**`--custom-role-arn`**é€‰æ‹©ä»–å¸Œæœ›è·å–å‡­è¯çš„è§’è‰²ã€‚
ç„¶è€Œï¼Œå¦‚æœ**é»˜è®¤é€‰é¡¹**æ˜¯é…ç½®çš„ï¼ˆ`use default role`ï¼‰ï¼Œå¹¶ä¸”ä½ å°è¯•ä»IdTokenè®¿é—®ä¸€ä¸ªè§’è‰²ï¼Œä½ å°†å¾—åˆ°**é”™è¯¯**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å‰é¢çš„é…ç½®ï¼‰ï¼š

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåˆ†é…ç»™**ç”¨æˆ·æ± ç»„**çš„è§’è‰²éœ€è¦èƒ½å¤Ÿè¢«**ä¿¡ä»»ç”¨æˆ·æ± çš„èº«ä»½æä¾›è€…**è®¿é—®ï¼ˆå› ä¸º IAM è§’è‰²**ä¼šè¯å‡­è¯å°†ä»ä¸­è·å–**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
