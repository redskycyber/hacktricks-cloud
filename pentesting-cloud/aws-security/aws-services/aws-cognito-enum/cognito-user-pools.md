# Pule u偶ytkownik贸w Cognito

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Podstawowe informacje

Pula u偶ytkownik贸w to katalog u偶ytkownik贸w w Amazon Cognito. Dziki puli u偶ytkownik贸w Twoi u偶ytkownicy mog **zalogowa si do Twojej aplikacji internetowej lub mobilnej** za porednictwem Amazon Cognito, **lub federowa** za porednictwem **dostawcy to偶samoci zewntrznej** (IdP). Bez wzgldu na to, czy u偶ytkownicy loguj si bezporednio czy za porednictwem strony trzeciej, wszyscy czonkowie puli u偶ytkownik贸w maj profil katalogowy, do kt贸rego mo偶na uzyska dostp za pomoc SDK.

Pule u偶ytkownik贸w zapewniaj:

* Usugi rejestracji i logowania.
* Wbudowany, dostosowywalny interfejs u偶ytkownika do logowania u偶ytkownik贸w.
* Logowanie za pomoc medi贸w spoecznociowych takich jak Facebook, Google, Logowanie za pomoc Amazona i Logowanie za pomoc Apple, oraz za pomoc dostawc贸w to偶samoci SAML i OIDC z Twojej puli u偶ytkownik贸w.
* Zarzdzanie katalogiem u偶ytkownik贸w i profilami u偶ytkownik贸w.
* Funkcje zabezpiecze takie jak uwierzytelnianie wieloskadnikowe (MFA), sprawdzanie skompromitowanych powiadcze, ochrona przed przejciem konta oraz weryfikacja telefonu i e-maila.
* Dostosowane przepywy pracy i migracja u偶ytkownik贸w za pomoc wyzwalaczy AWS Lambda.

**Kod 藕r贸dowy** aplikacji zazwyczaj zawiera r贸wnie偶 **identyfikator puli u偶ytkownik贸w** i **identyfikator aplikacji klienckiej**, (a czasami **sekret aplikacji**?) kt贸re s potrzebne do **zalogowania si** do puli u偶ytkownik贸w Cognito.

### Potencjalne ataki

* **Rejestracja**: Domylnie u偶ytkownik mo偶e si zarejestrowa, wic m贸gby utworzy u偶ytkownika dla siebie.
* **Wyliczanie u偶ytkownik贸w**: Funkcjonalno rejestracji mo偶e by wykorzystana do znalezienia nazw u偶ytkownik贸w, kt贸re ju偶 istniej. Te informacje mog by przydatne do ataku metod brutalnej siy.
* **Atak brutalnej siy logowania**: W sekcji [**Uwierzytelnianie**](cognito-user-pools.md#authentication) znajdziesz wszystkie **metody**, kt贸rych u偶ytkownik musi u偶y do **zalogowania si**, mo偶esz spr贸bowa je atakowa metod brutalnej siy, aby **znale藕 poprawne powiadczenia**.

### Narzdzia do testowania penetracyjnego

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj wyliczanie wszystkich zasob贸w Cognito w koncie i flaguj sabe konfiguracje, atrybuty u偶ytkownika u偶ywane do kontroli dostpu, itp., oraz automatyzuj tworzenie u偶ytkownika (w tym obsug MFA) i eskalacj uprawnie na podstawie modyfikowalnych niestandardowych atrybut贸w, u偶ytecznych powiadcze puli to偶samoci, r贸l do przyjcia w tokenach id, itp.

Aby uzyska opis funkcji modu贸w, zobacz cz 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Aby uzyska instrukcje instalacji, zobacz g贸wn stron [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykadowe u偶ycie ataku cognito\_\_attack w celu pr贸by utworzenia u偶ytkownika i wszystkich wektor贸w eskalacji uprawnie przeciwko okrelonej puli to偶samoci i klientowi puli u偶ytkownik贸w:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykadowe u偶ycie cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp. widocznych w bie偶cym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie CLI napisane w jzyku Python, kt贸re implementuje r贸偶ne ataki na Cognito, w tym niechciane tworzenie kont i konto oracle.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### U偶ycie
```bash
$ cognito-scanner --help
```
Dla dalszych informacji sprawd藕 https://github.com/padok-team/cognito-scanner

## Rejestracja

Pule u偶ytkownik贸w domylnie umo偶liwia **rejestracj nowych u偶ytkownik贸w**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Jeli ka偶dy mo偶e si zarejestrowa

Mo偶esz napotka bd wskazujcy, 偶e musisz **podac wicej szczeg贸贸w** dotyczcych u偶ytkownika:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Mo偶esz poda potrzebne szczeg贸y za pomoc JSON, na przykad:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Mo偶esz r贸wnie偶 u偶y tej funkcji do **wyliczenia istniejcych u偶ytkownik贸w.** To jest komunikat bdu, gdy u偶ytkownik o takiej nazwie ju偶 istnieje:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Zauwa偶 w poprzedniej komendzie, jak **niestandardowe atrybuty zaczynaj si od "custom:"**.\
Pamitaj r贸wnie偶, 偶e podczas rejestracji **nie mo偶esz tworzy nowych niestandardowych atrybut贸w dla u偶ytkownika**. Mo偶esz jedynie przypisa warto do **domylnych atrybut贸w** (nawet jeli nie s one wymagane) oraz **okrelonych atrybut贸w niestandardowych**.
{% endhint %}

Lub po prostu, aby sprawdzi, czy identyfikator klienta istnieje. To jest bd, jeli identyfikator klienta nie istnieje:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Jeli tylko administrator mo偶e rejestrowa u偶ytkownik贸w

Bd ten spowoduje, 偶e nie bdziesz m贸g zarejestrowa ani wyliczy u偶ytkownik贸w:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Weryfikacja rejestracji

Cognito umo偶liwia **weryfikacj nowego u偶ytkownika poprzez zweryfikowanie jego adresu e-mail lub numeru telefonu**. Dlatego podczas tworzenia u偶ytkownika zazwyczaj bdziesz musia poda co najmniej nazw u偶ytkownika i haso oraz **adres e-mail i/lub numer telefonu**. Ustaw jedno **kt贸re kontrolujesz**, aby otrzyma kod do **weryfikacji twojego** nowo utworzonego **konta u偶ytkownika** w ten spos贸b:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Nawet jeli **wyglda na to, 偶e mo偶esz u偶y tego samego adresu e-mail** i numeru telefonu, gdy musisz zweryfikowa utworzonego u偶ytkownika, Cognito zgosi problem z u偶yciem tych samych informacji i **nie pozwoli na weryfikacj konta**.
{% endhint %}

### Eskalacja uprawnie / Aktualizacja atrybut贸w

Domylnie u偶ytkownik mo偶e **zmienia warto swoich atrybut贸w** za pomoc:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Przywileje podnoszenia atrybut贸w niestandardowych

{% hint style="danger" %}
Mo偶esz znale藕 **u偶ywane atrybuty niestandardowe** (takie jak `isAdmin`), poniewa偶 domylnie mo偶esz **zmienia wartoci swoich wasnych atrybut贸w**, mo偶esz **podnie uprawnienia** zmieniajc warto samodzielnie!
{% endhint %}

#### Przywileje modyfikacji e-maila/nazwy u偶ytkownika

Mo偶esz u偶y tego do **modyfikacji adresu e-mail i numeru telefonu** u偶ytkownika, ale nawet jeli konto pozostaje zweryfikowane, te atrybuty s **ustawione w stanie niezweryfikowanym** (musisz je zweryfikowa ponownie).

{% hint style="warning" %}
**Nie bdziesz w stanie zalogowa si za pomoc adresu e-mail lub numeru telefonu** dop贸ki ich nie zweryfikujesz, ale bdziesz **m贸g zalogowa si za pomoc nazwy u偶ytkownika**.\
Zauwa偶, 偶e nawet jeli adres e-mail zosta zmodyfikowany i nie zosta zweryfikowany, pojawi si on w Tokenie ID wewntrz pola **`email`** i pole **`email_verified`** bdzie **false**, ale jeli aplikacja **nie sprawdza tego, mo偶esz podawa si za innych u偶ytkownik贸w**.

Ponadto, zauwa偶, 偶e mo偶esz umieci cokolwiek w polu **`name`** po prostu modyfikujc **atrybut nazwy**. Jeli aplikacja **sprawdza** **to pole z jakiego powodu zamiast `email`** (lub jakiegokolwiek innego atrybutu), mo偶esz **podawa si za innych u偶ytkownik贸w**.
{% endhint %}

W ka偶dym razie, jeli z jakiego powodu zmienie sw贸j adres e-mail na przykad na nowy, mo偶esz uzyska dostp, **potwierdzajc e-mail za pomoc otrzymanego w nim kodu**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
U偶yj **`phone_number`** zamiast **`email`** do zmiany/weryfikacji **nowego numeru telefonu**.

{% hint style="info" %}
Administrator mo偶e r贸wnie偶 wczy opcj **logowania za pomoc preferowanego nazwy u偶ytkownika**. Zauwa偶, 偶e nie bdziesz m贸g zmieni tej wartoci na **偶aden nazwa u偶ytkownika lub preferred\_username, kt贸ry jest ju偶 u偶ywany** do podszywania si pod innego u偶ytkownika.
{% endhint %}

### Odzyskiwanie/Zmiana Hasa

Mo偶liwe jest odzyskanie hasa, znajc jedynie **nazw u偶ytkownika** (lub akceptowany jest email lub telefon) i majc do niego dostp, kod zostanie tam wysany:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Odpowied藕 serwera zawsze bdzie pozytywna, jakby nazwa u偶ytkownika istniaa. Nie mo偶na u偶y tej metody do wyliczenia u偶ytkownik贸w.
{% endhint %}

Z kodem mo偶na zmieni haso na:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Aby zmieni haso, musisz **zna poprzednie haso**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Uwierzytelnianie

Pula u偶ytkownik贸w obsuguje **r贸偶ne sposoby uwierzytelniania**. Jeli masz **nazw u偶ytkownika i haso**, istniej r贸wnie偶 **r贸偶ne obsugiwane metody logowania**.\
Ponadto, gdy u偶ytkownik jest uwierzytelniony w puli, s udostpniane **3 rodzaje token贸w**: **Token ID**, **Token dostpu** i **Token odwie偶ania**.

* [**Token ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Zawiera twierdzenia dotyczce **to偶samoci uwierzytelnionego u偶ytkownika**, takie jak `imi`, `e-mail` i `numer telefonu`. Token ID mo偶na r贸wnie偶 u偶y do **uwierzytelniania u偶ytkownik贸w w serwerach zasob贸w lub aplikacjach serwerowych**. Musisz **zweryfikowa** **podpis** tokena ID, zanim bdziesz m贸g ufa jakimkolwiek twierdzeniom wewntrz tokena ID, jeli u偶ywasz go w aplikacjach zewntrznych.
* Token ID to token, kt贸ry **zawiera wartoci atrybut贸w u偶ytkownika**, nawet te niestandardowe.
* [**Token dostpu**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Zawiera twierdzenia dotyczce uwierzytelnionego u偶ytkownika, list **grup u偶ytkownika i list zakres贸w**. Celem tokena dostpu jest **autoryzacja operacji API** w kontekcie u偶ytkownika w puli u偶ytkownik贸w. Na przykad, mo偶esz u偶y tokenu dostpu do **udzielenia u偶ytkownikowi dostpu** do dodawania, zmiany lub usuwania atrybut贸w u偶ytkownika.
* [**Token odwie偶ania**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Dziki tokenom odwie偶ania mo偶esz **uzyska nowe tokeny ID i dostpu** dla u偶ytkownika, dop贸ki **token odwie偶ania jest niewa偶ny**. Domylnie token odwie偶ania **wygasa 30 dni po** zalogowaniu si u偶ytkownika do puli u偶ytkownik贸w. Podczas tworzenia aplikacji dla puli u偶ytkownik贸w mo偶esz ustawi wyganicie tokena odwie偶ania aplikacji na **dowoln warto midzy 60 minutami a 10 latami**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

To jest przepyw uwierzytelniania po stronie serwera:

* Aplikacja po stronie serwera wywouje operacj API **`AdminInitiateAuth`** (zamiast `InitiateAuth`). Ta operacja wymaga powiadcze AWS z uprawnieniami, kt贸re obejmuj **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacja zwraca wymagane parametry uwierzytelniania.
* Po uzyskaniu aplikacja po stronie serwera **parametr贸w uwierzytelniania**, wywouje operacj API **`AdminRespondToAuthChallenge`**. Operacja API `AdminRespondToAuthChallenge` udaje si tylko wtedy, gdy podasz powiadczenia AWS.

Ta **metoda NIE jest wczona** domylnie.

Aby **zalogowa si**, musisz zna:

* identyfikator puli u偶ytkownik贸w
* identyfikator klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ycia sekretu)

{% hint style="info" %}
Aby **m贸c zalogowa si t metod**, aplikacja musi zezwala na logowanie za pomoc `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Ponadto, aby wykona t czynno, potrzebujesz powiadcze z uprawnieniami **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Kod do logowania</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Ta metoda to kolejny prosty i **tradycyjny przepyw uwierzytelniania u偶ytkownika i hasa**. Zaleca si **migracj tradycyjnej** metody uwierzytelniania **do Cognito** i **zaleca si** nastpnie **wyczenie** jej i **u偶ycie** metody **ALLOW\_USER\_SRP\_AUTH** (poniewa偶 ta nigdy nie wysya hasa przez sie).\
Ta **metoda NIE jest wczona** domylnie.

G贸wn **r贸偶nic** w **por贸wnaniu z poprzedni metod uwierzytelniania** w kodzie jest to, 偶e **nie musisz zna identyfikatora puli u偶ytkownik贸w** i **nie potrzebujesz dodatkowych uprawnie** w puli u偶ytkownik贸w Cognito.

Aby **zalogowa si**, musisz zna:

* identyfikator klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ycia sekretu)

{% hint style="info" %}
Aby **mo偶liwe byo zalogowanie si t metod**, aplikacja musi zezwala na logowanie za pomoc ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Kod Python do logowania</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### UWIERZYTELNIANIE\_U呕YTKOWNIKA\_SRP

To **scenariusz** jest podobny do poprzedniego, ale **zamiast przesya haso** przez sie w celu zalogowania, **wykonywane jest wyzwanie uwierzytelnienia** (wic haso nie jest przesyane nawet zaszyfrowane przez sie).\
Ta **metoda jest wczona** domylnie.

Aby si **zalogowa**, musisz zna:

* identyfikator puli u偶ytkownik贸w
* identyfikator klienta
* nazw u偶ytkownika
* haso
* sekret klienta (tylko jeli aplikacja jest skonfigurowana do u偶ycia sekretu)

<details>

<summary>Kod do logowania</summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### AUTORYZACJA_ZA_POMOC_TOKENA_ODWIE呕ANIA I TOKEN_ODWIE呕ANIA

Ta **metoda zawsze bdzie wa偶na** (nie mo偶na jej wyczy), ale musisz mie wa偶ny token odwie偶ania.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Kod do odwie偶enia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

W tym przypadku **uwierzytelnienie** bdzie wykonywane poprzez **wywoanie funkcji lambda**.

## Dodatkowe zabezpieczenia

### Zaawansowane zabezpieczenia

Domylnie jest wyczone, ale jeli jest wczone, Cognito mo偶e **wykry przejcia kont**. Aby zminimalizowa prawdopodobiestwo, powiniene logowa si z **sieci w tej samej miejscowoci, korzystajc z tego samego agenta u偶ytkownika** (i adresu IP, jeli to mo偶liwe).

### **MFA Zapamitaj urzdzenie**

Jeli u偶ytkownik loguje si z tego samego urzdzenia, MFA mo偶e zosta zignorowane, dlatego spr贸buj zalogowa si z tego samego przegldarki z tymi samymi metadanymi (IP?) w celu obejcia ochrony MFA.

## Grupy basen贸w u偶ytkownik贸w IAM Roles

Mo偶liwe jest dodanie **u偶ytkownik贸w do grup basen贸w u偶ytkownik贸w**, kt贸re s powizane z jedn **rol IAM**.\
Co wicej, **u偶ytkownicy** mog by przypisani do **wicej ni偶 1 grupy z r贸偶nymi rolami IAM**.

Nale偶y zauwa偶y, 偶e nawet jeli grupa znajduje si w grupie z przypisan rol IAM, aby m贸c uzyska dostp do powiadcze IAM tej grupy, konieczne jest, aby **Basen u偶ytkownik贸w by zaufany przez Basen to偶samoci** (i zna szczeg贸y tego Basenu to偶samoci).

Innym wymogiem, aby uzyska **rol IAM wskazan w IdToken** podczas uwierzytelniania u偶ytkownika w Basenie u偶ytkownik贸w (`aws cognito-idp initiate-auth...`), jest to, 偶e **dostawca uwierzytelniania dostawcy to偶samoci** musi wskaza, 偶e **rola musi zosta wybrana z tokena**.

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Role**, do kt贸rych u偶ytkownik ma dostp, znajduj si **w `IdToken`**, a u偶ytkownik mo偶e **wybra, dla kt贸rej roli chciaby uzyska powiadczenia** za pomoc **`--custom-role-arn`** z `aws cognito-identity get-credentials-for-identity`.\
Jednak偶e, jeli **opcja domylna** jest **skonfigurowana** (`u偶yj domylnej roli`), a pr贸bujesz uzyska dostp do roli z IdToken, otrzymasz **bd** (dlatego konieczna jest wczeniejsza konfiguracja):
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Nale偶y pamita, 偶e rola przypisana do **Grupy basenowej u偶ytkownik贸w** musi by **dostpna dla dostawcy to偶samoci**, kt贸ry **ufa Grupie u偶ytkownik贸w** (poniewa偶 powiadczenia sesji roli IAM **bd pobierane z niej**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
