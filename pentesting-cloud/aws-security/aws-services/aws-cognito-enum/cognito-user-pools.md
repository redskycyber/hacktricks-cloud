# Cognito User Pools

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Pula u偶ytkownik贸w to katalog u偶ytkownik贸w w Amazon Cognito. Dziki puli u偶ytkownik贸w, Twoi u偶ytkownicy mog **logowa si do Twojej aplikacji internetowej lub mobilnej** za porednictwem Amazon Cognito, **lub federowa** za porednictwem **zewntrznego** dostawcy to偶samoci (IdP). Bez wzgldu na to, czy Twoi u偶ytkownicy loguj si bezporednio czy za porednictwem strony trzeciej, wszyscy czonkowie puli u偶ytkownik贸w maj profil katalogowy, do kt贸rego mo偶na uzyska dostp za pomoc SDK.

Pule u偶ytkownik贸w zapewniaj:

* Usugi rejestracji i logowania.
* Wbudowany, dostosowywalny interfejs u偶ytkownika do logowania u偶ytkownik贸w.
* Logowanie za pomoc Facebooka, Google, Logowania z Amazon, Logowania z Apple, a tak偶e za pomoc dostawc贸w to偶samoci SAML i OIDC z Twojej puli u偶ytkownik贸w.
* Zarzdzanie katalogiem u偶ytkownik贸w i profilami u偶ytkownik贸w.
* Funkcje zabezpiecze, takie jak uwierzytelnianie wieloskadnikowe (MFA), sprawdzanie skompromitowanych powiadcze, ochrona przed przejciem konta oraz weryfikacja telefonu i e-maila.
* Dostosowane procesy i migracja u偶ytkownik贸w za pomoc wyzwalaczy AWS Lambda.

**Kod 藕r贸dowy** aplikacji zwykle zawiera r贸wnie偶 **identyfikator puli u偶ytkownik贸w** i **identyfikator aplikacji klienckiej**, (a czasami **tajemnic aplikacji**?), kt贸re s potrzebne do **zalogowania si u偶ytkownika** do puli u偶ytkownik贸w Cognito.

### Potencjalne ataki

* **Rejestracja**: Domylnie u偶ytkownik mo偶e si zarejestrowa, wic mo偶e utworzy u偶ytkownika dla siebie.
* **Wyliczanie u偶ytkownik贸w**: Funkcjonalno rejestracji mo偶e by wykorzystana do znalezienia nazw u偶ytkownik贸w, kt贸re ju偶 istniej. Te informacje mog by przydatne do ataku brute-force.
* **Atak brute-force na logowanie**: W sekcji [**Uwierzytelnianie**](cognito-user-pools.md#authentication) znajduj si wszystkie **metody**, kt贸re u偶ytkownik musi **u偶y do logowania**, mo偶na spr贸bowa przeprowadzi atak brute-force, aby **znale藕 prawidowe powiadczenia**.

### Narzdzia do pentestowania

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduy "cognito\_\_enum" i "cognito\_\_attack", kt贸re automatyzuj wyliczanie wszystkich zasob贸w Cognito w koncie, wykrywanie sabych konfiguracji, atrybut贸w u偶ytkownika u偶ywanych do kontroli dostpu itp., a tak偶e automatyzuj tworzenie u偶ytkownik贸w (w tym obsug MFA) i eskalacj uprawnie na podstawie modyfikowalnych niestandardowych atrybut贸w, u偶ytecznych powiadcze puli to偶samoci, roli do przyjcia w tokenach identyfikacyjnych itp.

Opis funkcji modu贸w znajduje si w czci 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajduj si na g贸wnej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### U偶ycie

Przykadowe u偶ycie cognito\_\_attack do pr贸by utworzenia u偶ytkownika i wszystkich wektor贸w eskalacji uprawnie w stosunku do okrelonej puli to偶samoci i klienta puli u偶ytkownik贸w:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Poni偶ej przedstawiono przykad u偶ycia cognito\_\_enum do zebrania wszystkich pul u偶ytkownik贸w, klient贸w pul u偶ytkownik贸w, pul to偶samoci, u偶ytkownik贸w itp., widocznych w bie偶cym koncie AWS:

```plaintext
cognito__enum
```

Ten polecenie wywietli wszystkie dostpne informacje o pulach u偶ytkownik贸w, klientach pul u偶ytkownik贸w, pulach to偶samoci i u偶ytkownikach w bie偶cym koncie AWS.

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzdzie wiersza polece napisane w jzyku Python, kt贸re implementuje r贸偶ne ataki na Cognito, w tym niechciane tworzenie kont i atak typu oracle na konta.

#### Instalacja

```bash
$ pip install cognito-scanner
```

#### U偶ycie

```plaintext
cognito-user-pools.py [-h] [--region REGION] [--userpool USERPOOL]
                      [--username USERNAME] [--email EMAIL]
                      [--phone PHONE] [--output OUTPUT]

Opcje:
  -h, --help           Wywietl t wiadomo pomocy i wyjd藕
  --region REGION      Region usugi AWS Cognito (domylnie: us-east-1)
  --userpool USERPOOL  Identyfikator puli u偶ytkownik贸w Cognito
  --username USERNAME  Nazwa u偶ytkownika do sprawdzenia
  --email EMAIL        Adres e-mail do sprawdzenia
  --phone PHONE        Numer telefonu do sprawdzenia
  --output OUTPUT      Plik wyjciowy, w kt贸rym zostan zapisane wyniki
```

#### Przykady u偶ycia:

```plaintext
# Sprawd藕, czy istnieje u偶ytkownik o nazwie "admin" w puli u偶ytkownik贸w Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --username admin

# Sprawd藕, czy istnieje u偶ytkownik o adresie e-mail "test@example.com" w puli u偶ytkownik贸w Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --email test@example.com

# Sprawd藕, czy istnieje u偶ytkownik o numerze telefonu "+1234567890" w puli u偶ytkownik贸w Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --phone +1234567890

# Zapisz wyniki do pliku "wyniki.txt"
cognito-user-pools.py --userpool us-east-1_abcd1234 --username admin --output wyniki.txt
```

#### Opis

Ten skrypt umo偶liwia sprawdzenie istnienia u偶ytkownika w puli u偶ytkownik贸w Cognito usugi AWS Cognito. Mo偶na sprawdzi istnienie u偶ytkownika na podstawie nazwy u偶ytkownika, adresu e-mail lub numeru telefonu. Skrypt zwraca informacj, czy u偶ytkownik istnieje w puli u偶ytkownik贸w Cognito. Opcjonalnie mo偶na zapisywa wyniki do pliku wyjciowego.

```bash
$ cognito-scanner --help
```

Aby uzyska wicej informacji, sprawd藕 https://github.com/padok-team/cognito-scanner

## Rejestracja

Pule u偶ytkownik贸w domylnie umo偶liwiaj **rejestracj nowych u偶ytkownik贸w**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Jeli ka偶dy mo偶e si zarejestrowa

Mo偶esz napotka bd wskazujcy, 偶e musisz **poda wicej szczeg贸贸w** dotyczcych u偶ytkownika:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Mo偶esz dostarczy potrzebne szczeg贸y za pomoc JSON, na przykad:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Mo偶esz r贸wnie偶 u偶y tej funkcji do **wyliczenia istniejcych u偶ytkownik贸w**. Oto komunikat o bdzie, kt贸ry pojawia si, gdy u偶ytkownik o takiej nazwie ju偶 istnieje:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Zauwa偶, 偶e w poprzedniej komendzie **atrybuty niestandardowe zaczynaj si od "custom:"**.\
Warto r贸wnie偶 wiedzie, 偶e podczas rejestracji **nie mo偶na tworzy nowych atrybut贸w niestandardowych** dla u偶ytkownika. Mo偶na jedynie przypisa warto do **atrybut贸w domylnych** (nawet jeli nie s one wymagane) oraz **okrelonych atrybut贸w niestandardowych**.
{% endhint %}

Lub po prostu przetestuj, czy istnieje identyfikator klienta. Oto bd, kt贸ry zostanie wywietlony, jeli identyfikator klienta nie istnieje:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Jeli tylko administrator mo偶e rejestrowa u偶ytkownik贸w

Napotkasz ten bd i nie bdziesz w stanie zarejestrowa ani wyliczy u偶ytkownik贸w:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Weryfikacja rejestracji

Cognito umo偶liwia **weryfikacj nowego u偶ytkownika poprzez weryfikacj jego adresu e-mail lub numeru telefonu**. Dlatego, tworzc u偶ytkownika, zazwyczaj bdziesz musia poda co najmniej nazw u偶ytkownika, haso oraz **adres e-mail i/lub numer telefonu**. Ustaw jedno **pod swoj kontrol**, aby otrzyma kod do **weryfikacji** nowo utworzonego **konta u偶ytkownika** w ten spos贸b:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Nawet jeli wydaje si, 偶e mo偶esz u偶y tego samego adresu e-mail i numeru telefonu, kiedy musisz zweryfikowa utworzonego u偶ytkownika, Cognito zgosi problem z u偶ywaniem tych samych informacji i nie pozwoli na zweryfikowanie konta.
{% endhint %}

### Eskalacja uprawnie / Aktualizowanie atrybut贸w

Domylnie u偶ytkownik mo偶e **zmienia warto swoich atrybut贸w** za pomoc czego takiego jak:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Przywileje podwy偶szania uprawnie dla niestandardowych atrybut贸w

{% hint style="danger" %}
Mo偶esz znale藕 u偶ywane **niestandardowe atrybuty** (takie jak `isAdmin`). Domylnie mo偶esz **zmienia wartoci swoich wasnych atrybut贸w**, co mo偶e umo偶liwi ci **podwy偶szenie uprawnie**, zmieniajc warto samodzielnie!
{% endhint %}

#### Przywileje modyfikacji adresu e-mail/nazwy u偶ytkownika

Mo偶esz u偶y tego do **modyfikacji adresu e-mail i numeru telefonu** u偶ytkownika, ale nawet jeli konto pozostaje zweryfikowane, te atrybuty s **ustawione w stanie niezweryfikowanym** (musisz je zweryfikowa ponownie).

{% hint style="warning" %}
Nie bdziesz **m贸g si zalogowa za pomoc adresu e-mail lub numeru telefonu**, dop贸ki ich nie zweryfikujesz, ale bdziesz **m贸g si zalogowa za pomoc nazwy u偶ytkownika**.\
Zauwa偶, 偶e nawet jeli adres e-mail zosta zmieniony i nie zosta zweryfikowany, pojawi si on w Tokenie ID w polu **`email`**, a pole **`email_verified`** bdzie **false**, ale jeli aplikacja **nie sprawdza tego**, mo偶esz podszywa si pod innych u偶ytkownik贸w.

Ponadto, zauwa偶, 偶e mo偶esz umieci cokolwiek w polu **`name`**, po prostu modyfikujc **atrybut nazwy**. Jeli aplikacja **sprawdza** to pole z jakiego powodu **zamiast `email`** (lub jakiegokolwiek innego atrybutu), mo偶esz podszywa si pod innych u偶ytkownik贸w.
{% endhint %}

W ka偶dym razie, jeli z jakiego powodu zmienie sw贸j adres e-mail na przykad na nowy, mo偶esz **potwierdzi adres e-mail za pomoc otrzymanego w nim kodu**:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

U偶yj **`phone_number`** zamiast **`email`** do zmiany/weryfikacji **nowego numeru telefonu**.

{% hint style="info" %}
Administrator mo偶e r贸wnie偶 wczy opcj **logowania za pomoc preferowanego przez u偶ytkownika nazwy u偶ytkownika**. Nale偶y pamita, 偶e nie bdzie mo偶na zmieni tej wartoci na **偶adn nazw u偶ytkownika lub preferowan nazw u偶ytkownika, kt贸ra jest ju偶 u偶ywana**, aby podszywa si pod innego u偶ytkownika.
{% endhint %}

### Odzyskiwanie/Zmiana hasa

Mo偶liwe jest odzyskanie hasa, znajc tylko **nazw u偶ytkownika** (lub akceptowany jest r贸wnie偶 email lub numer telefonu) i majc do niego dostp, poniewa偶 zostanie tam wysany kod:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
Odpowied藕 serwera zawsze bdzie pozytywna, tak jakby nazwa u偶ytkownika istniaa. Nie mo偶na u偶y tej metody do wyliczania u偶ytkownik贸w.
{% endhint %}

Za pomoc kodu mo偶esz zmieni haso na:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Aby zmieni haso, musisz **zna poprzednie haso**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Uwierzytelnianie

Pula u偶ytkownik贸w obsuguje **r贸偶ne sposoby uwierzytelniania**. Jeli masz **nazw u偶ytkownika i haso**, istniej r贸wnie偶 **r贸偶ne metody** obsugiwane do logowania.\
Ponadto, gdy u偶ytkownik jest uwierzytelniony w puli, **przyznawane s 3 rodzaje token贸w**: **Token ID**, **Token dostpu** i **Token odwie偶ania**.

* [**Token ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Zawiera informacje o **to偶samoci uwierzytelnionego u偶ytkownika**, takie jak `imi`, `adres e-mail` i `numer telefonu`. Token ID mo偶na r贸wnie偶 u偶y do **uwierzytelniania u偶ytkownik贸w w serwerach zasob贸w lub aplikacjach serwerowych**. Musisz **zweryfikowa** **podpis** Tokenu ID, zanim bdziesz m贸g ufa jakimkolwiek informacjom wewntrz Tokenu ID, jeli u偶ywasz go w zewntrznych aplikacjach.
* Token ID to token, kt贸ry **zawiera wartoci atrybut贸w u偶ytkownika**, nawet niestandardowe.
* [**Token dostpu**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Zawiera informacje o uwierzytelnionym u偶ytkowniku, list **grup u偶ytkownika** i list **zakres贸w**. Celem tokenu dostpu jest **autoryzacja operacji API** w kontekcie u偶ytkownika w puli u偶ytkownik贸w. Na przykad, mo偶esz u偶y tokenu dostpu do **udzielenia u偶ytkownikowi dostpu** do dodawania, zmiany lub usuwania atrybut贸w u偶ytkownika.
* [**Token odwie偶ania**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Dziki tokenom odwie偶ania mo偶esz **uzyska nowe Tokeny ID i Tokeny dostpu** dla u偶ytkownika, dop贸ki **token odwie偶ania jest wa偶ny**. Domylnie token odwie偶ania **wygasa 30 dni po** zalogowaniu si u偶ytkownika aplikacji do puli u偶ytkownik贸w. Podczas tworzenia aplikacji dla puli u偶ytkownik贸w mo偶na ustawi wyganicie tokenu odwie偶ania aplikacji na **dowoln warto midzy 60 minutami a 10 latami**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Jest to strumie uwierzytelniania po stronie serwera:

* Aplikacja po stronie serwera wywouje operacj API **`AdminInitiateAuth`** (zamiast `InitiateAuth`). Ta operacja wymaga powiadcze AWS z uprawnieniami, kt贸re obejmuj **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacja zwraca wymagane parametry uwierzytelniania.
* Po uzyskaniu aplikacja po stronie serwera **parametr贸w uwierzytelniania**, wywouje operacj API **`AdminRespondToAuthChallenge`**. Operacja API `AdminRespondToAuthChallenge` jest udana tylko wtedy, gdy dostarczysz powiadczenia AWS.

Ta **metoda NIE jest domylnie wczona**.

Aby **zalogowa si**, musisz zna:

* identyfikator puli u偶ytkownik贸w
* identyfikator klienta
* nazw u偶ytkownika
* haso
* tajny klucz klienta (tylko jeli aplikacja jest skonfigurowana do u偶ycia klucza tajnego)

{% hint style="info" %}
Aby **m贸c zalogowa si t metod**, aplikacja musi umo偶liwia logowanie za pomoc `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Ponadto, do wykonania tej akcji potrzebujesz powiadcze z uprawnieniami **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Kod do logowania</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

Ta metoda to kolejny prosty i **tradycyjny spos贸b uwierzytelniania u偶ytkownika i hasa**. Zaleca si **migracj tradycyjnej** metody uwierzytelniania **do Cognito** i **zaleca si** nastpnie jej **wyczenie** i **zamiast tego** korzystanie z metody **ALLOW\_USER\_SRP\_AUTH** (poniewa偶 ta nigdy nie wysya hasa przez sie).\
Ta metoda **nie jest domylnie wczona**.

G贸wna **r贸偶nica** w kodzie w por贸wnaniu do **poprzedniej metody uwierzytelniania** polega na tym, 偶e **nie musisz zna identyfikatora puli u偶ytkownik贸w** i **nie potrzebujesz dodatkowych uprawnie** w puli u偶ytkownik贸w Cognito.

Aby si **zalogowa**, musisz zna:

* identyfikator klienta
* nazw u偶ytkownika
* haso
* tajny klucz klienta (tylko jeli aplikacja jest skonfigurowana do korzystania z klucza tajnego)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Aby **m贸c zalogowa si t metod**, aplikacja musi umo偶liwia logowanie za pomoc ALLOW\_USER\_PASSWORD\_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ta **metoda zawsze bdzie wa偶na** (nie mo偶na jej wyczy), ale musisz mie wa偶ny token odwie偶ania.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
