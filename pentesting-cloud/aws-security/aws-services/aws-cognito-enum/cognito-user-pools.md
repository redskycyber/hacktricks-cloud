# Cognitoç”¨æˆ·æ± 

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

ç”¨æˆ·æ± æ˜¯Amazon Cognitoä¸­çš„ç”¨æˆ·ç›®å½•ã€‚é€šè¿‡ç”¨æˆ·æ± ï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡Amazon Cognitoç›´æ¥ç™»å½•åˆ°æ‚¨çš„Webæˆ–ç§»åŠ¨åº”ç”¨ç¨‹åºï¼Œæˆ–é€šè¿‡ç¬¬ä¸‰æ–¹èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰è¿›è¡Œè”åˆç™»å½•ã€‚æ— è®ºç”¨æˆ·æ˜¯ç›´æ¥ç™»å½•è¿˜æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œç”¨æˆ·æ± çš„æ‰€æœ‰æˆå‘˜éƒ½æœ‰ä¸€ä¸ªç›®å½•é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡SDKè®¿é—®è¯¥é…ç½®æ–‡ä»¶ã€‚

ç”¨æˆ·æ± æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

* æ³¨å†Œå’Œç™»å½•æœåŠ¡ã€‚
* å†…ç½®çš„å¯è‡ªå®šä¹‰çš„Webç”¨æˆ·ç•Œé¢ï¼Œç”¨äºç”¨æˆ·ç™»å½•ã€‚
* é€šè¿‡Facebookã€Googleã€Login with Amazonå’ŒSign in with Appleä»¥åŠé€šè¿‡SAMLå’ŒOIDCèº«ä»½æä¾›å•†ä»ç”¨æˆ·æ± ä¸­è¿›è¡Œç¤¾äº¤ç™»å½•ã€‚
* ç”¨æˆ·ç›®å½•ç®¡ç†å’Œç”¨æˆ·é…ç½®æ–‡ä»¶ã€‚
* å®‰å…¨åŠŸèƒ½ï¼Œå¦‚å¤šå› ç´ èº«ä»½éªŒè¯ï¼ˆMFAï¼‰ã€æ£€æŸ¥å—æŸå‡­æ®ã€é˜²æ­¢è´¦æˆ·åŠ«æŒä»¥åŠç”µè¯å’Œç”µå­é‚®ä»¶éªŒè¯ã€‚
* é€šè¿‡AWS Lambdaè§¦å‘å™¨è¿›è¡Œè‡ªå®šä¹‰å·¥ä½œæµå’Œç”¨æˆ·è¿ç§»ã€‚

åº”ç”¨ç¨‹åºçš„**æºä»£ç **é€šå¸¸è¿˜åŒ…å«ç”¨æˆ·æ± IDå’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºIDï¼ˆä»¥åŠæœ‰æ—¶çš„åº”ç”¨ç¨‹åºå¯†é’¥ï¼Ÿï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºç”¨æˆ·ç™»å½•åˆ°Cognitoç”¨æˆ·æ± æ˜¯å¿…éœ€çš„ã€‚

### æ½œåœ¨æ”»å‡»

* **æ³¨å†Œ**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œæ³¨å†Œï¼Œå› æ­¤ä»–å¯ä»¥ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
* **ç”¨æˆ·æšä¸¾**ï¼šæ³¨å†ŒåŠŸèƒ½å¯ç”¨äºæŸ¥æ‰¾å·²å­˜åœ¨çš„ç”¨æˆ·åã€‚è¿™äº›ä¿¡æ¯å¯¹äºæš´åŠ›ç ´è§£æ”»å‡»å¯èƒ½å¾ˆæœ‰ç”¨ã€‚
* **ç™»å½•æš´åŠ›ç ´è§£**ï¼šåœ¨[**èº«ä»½éªŒè¯**](cognito-user-pools.md#authentication)éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç”¨æˆ·ç™»å½•æ‰€éœ€çš„æ‰€æœ‰**æ–¹æ³•**ï¼Œæ‚¨å¯ä»¥å°è¯•å¯¹å®ƒä»¬è¿›è¡Œæš´åŠ›ç ´è§£ä»¥æ‰¾åˆ°æœ‰æ•ˆçš„å‡­æ®ã€‚

## æ³¨å†Œ

ç”¨æˆ·æ± é»˜è®¤å…è®¸**æ³¨å†Œæ–°ç”¨æˆ·**ã€‚
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### å¦‚æœä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œ

ä½ å¯èƒ½ä¼šé‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œæç¤ºä½ éœ€è¦æä¾›æœ‰å…³ç”¨æˆ·çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
æ‚¨å¯ä»¥ä½¿ç”¨JSONæä¾›æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ¥**æšä¸¾ç°æœ‰ç”¨æˆ·**ã€‚å½“ä½¿ç”¨è¯¥åç§°çš„ç”¨æˆ·å·²å­˜åœ¨æ—¶ï¼Œå°†æ˜¾ç¤ºä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
è¯·æ³¨æ„å‰é¢çš„å‘½ä»¤ä¸­ï¼Œ**è‡ªå®šä¹‰å±æ€§ä»¥"custom:"å¼€å¤´**ã€‚\
è¿˜è¦çŸ¥é“ï¼Œåœ¨æ³¨å†Œæ—¶ï¼Œ**ä¸èƒ½ä¸ºç”¨æˆ·åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å±æ€§**ã€‚æ‚¨åªèƒ½ä¸º**é»˜è®¤å±æ€§ï¼ˆå³ä½¿å®ƒä»¬ä¸æ˜¯å¿…éœ€çš„ï¼‰**å’Œ**æŒ‡å®šçš„è‡ªå®šä¹‰å±æ€§**èµ‹å€¼ã€‚
{% endhint %}

æˆ–è€…åªæ˜¯æµ‹è¯•å®¢æˆ·ç«¯IDæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå®¢æˆ·ç«¯IDä¸å­˜åœ¨ï¼Œåˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### å¦‚æœåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ³¨å†Œç”¨æˆ·

ä½ ä¼šé‡åˆ°è¿™ä¸ªé”™è¯¯ï¼Œæ— æ³•æ³¨å†Œæˆ–æšä¸¾ç”¨æˆ·ï¼š
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### éªŒè¯æ³¨å†Œ

Cognitoå…è®¸é€šè¿‡éªŒè¯ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç æ¥éªŒè¯æ–°ç”¨æˆ·ã€‚å› æ­¤ï¼Œå½“åˆ›å»ºç”¨æˆ·æ—¶ï¼Œé€šå¸¸éœ€è¦æä¾›è‡³å°‘ç”¨æˆ·åå’Œå¯†ç ä»¥åŠç”µå­é‚®ä»¶å’Œ/æˆ–ç”µè¯å·ç ã€‚åªéœ€è®¾ç½®ä¸€ä¸ªæ‚¨æ§åˆ¶çš„ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æ”¶åˆ°ç”¨äºéªŒè¯æ–°åˆ›å»ºçš„ç”¨æˆ·å¸æˆ·çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
å³ä½¿**çœ‹èµ·æ¥ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç”µå­é‚®ä»¶**å’Œç”µè¯å·ç ï¼Œä½†å½“ä½ éœ€è¦éªŒè¯åˆ›å»ºçš„ç”¨æˆ·æ—¶ï¼ŒCognitoä¼šæŠ±æ€¨ä½¿ç”¨ç›¸åŒçš„ä¿¡æ¯ï¼Œå¹¶ä¸”**ä¸ä¼šè®©ä½ éªŒè¯è¯¥å¸æˆ·**ã€‚
{% endhint %}

### ç‰¹æƒå‡çº§/æ›´æ–°å±æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼**ä¿®æ”¹å…¶å±æ€§çš„å€¼**ï¼š
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### è‡ªå®šä¹‰å±æ€§æƒé™æå‡

{% hint style="danger" %}
ä½ å¯èƒ½ä¼šå‘ç°ä½¿ç”¨äº†**è‡ªå®šä¹‰å±æ€§**ï¼ˆä¾‹å¦‚`isAdmin`ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½ å¯ä»¥**æ›´æ”¹è‡ªå·±å±æ€§çš„å€¼**ï¼Œå› æ­¤ä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡æ›´æ”¹å€¼æ¥**æå‡æƒé™**ï¼
{% endhint %}

#### ç”µå­é‚®ä»¶/ç”¨æˆ·åä¿®æ”¹æƒé™æå‡

ä½ å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥**ä¿®æ”¹ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œç”µè¯å·ç **ï¼Œä½†å³ä½¿å¸æˆ·ä¿æŒä¸ºå·²éªŒè¯çŠ¶æ€ï¼Œè¿™äº›å±æ€§ä¹Ÿä¼š**è®¾ç½®ä¸ºæœªéªŒè¯çŠ¶æ€**ï¼ˆä½ éœ€è¦é‡æ–°éªŒè¯å®ƒä»¬ï¼‰ã€‚

{% hint style="warning" %}
åœ¨ä½ éªŒè¯è¿™äº›å±æ€§ä¹‹å‰ï¼Œä½ **æ— æ³•ä½¿ç”¨ç”µå­é‚®ä»¶æˆ–ç”µè¯å·ç ç™»å½•**ï¼Œä½†ä½ å°†**èƒ½å¤Ÿä½¿ç”¨ç”¨æˆ·åç™»å½•**ã€‚\
è¯·æ³¨æ„ï¼Œå³ä½¿ç”µå­é‚®ä»¶è¢«ä¿®æ”¹ä½†æœªéªŒè¯ï¼Œå®ƒå°†å‡ºç°åœ¨IDä»¤ç‰Œçš„**`email`å­—æ®µ**ä¸­ï¼Œè€Œå­—æ®µ**`email_verified`**å°†ä¸º**false**ï¼Œä½†å¦‚æœåº”ç”¨ç¨‹åº**æ²¡æœ‰æ£€æŸ¥**è¿™ä¸€ç‚¹ï¼Œä½ å¯èƒ½ä¼šå†’å……å…¶ä»–ç”¨æˆ·ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹**åç§°å±æ€§**åœ¨**`name`å­—æ®µ**ä¸­æ”¾å…¥ä»»ä½•å†…å®¹ã€‚å¦‚æœåº”ç”¨ç¨‹åºå‡ºäºæŸç§åŸå› **æ£€æŸ¥**è¯¥å­—æ®µè€Œä¸æ˜¯**`email`**ï¼ˆæˆ–ä»»ä½•å…¶ä»–å±æ€§ï¼‰ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**å†’å……å…¶ä»–ç”¨æˆ·**ã€‚
{% endhint %}

æ— è®ºå¦‚ä½•ï¼Œå¦‚æœç”±äºæŸç§åŸå› ä½ å°†ä½ çš„ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºæ–°çš„ç”µå­é‚®ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä½ åœ¨è¯¥ç”µå­é‚®ä»¶åœ°å€ä¸­æ”¶åˆ°çš„ä»£ç **ç¡®è®¤ç”µå­é‚®ä»¶**ï¼š
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
ä½¿ç”¨**`phone_number`**è€Œä¸æ˜¯**`email`**æ¥æ›´æ”¹/éªŒè¯**æ–°çš„ç”µè¯å·ç **ã€‚

{% hint style="info" %}
ç®¡ç†å‘˜è¿˜å¯ä»¥å¯ç”¨ä½¿ç”¨ç”¨æˆ·é¦–é€‰ç”¨æˆ·åç™»å½•çš„é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å°†æ— æ³•å°†æ­¤å€¼æ›´æ”¹ä¸ºå·²ç»è¢«ä½¿ç”¨çš„**ä»»ä½•ç”¨æˆ·åæˆ–preferred\_username**ï¼Œä»¥å†’å……ä¸åŒçš„ç”¨æˆ·ã€‚
{% endhint %}

### æ¢å¤/æ›´æ”¹å¯†ç 

åªéœ€çŸ¥é“ç”¨æˆ·åï¼ˆæˆ–æ¥å—ç”µå­é‚®ä»¶æˆ–ç”µè¯ï¼‰å¹¶ä¸”èƒ½å¤Ÿè®¿é—®å®ƒï¼Œå°±å¯ä»¥æ¢å¤å¯†ç ï¼Œå› ä¸ºä»£ç å°†å‘é€åˆ°è¯¥ä½ç½®ï¼š
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
æœåŠ¡å™¨çš„å“åº”æ€»æ˜¯ç§¯æçš„ï¼Œå°±åƒç”¨æˆ·åå­˜åœ¨ä¸€æ ·ã€‚æ‚¨ä¸èƒ½ä½¿ç”¨æ­¤æ–¹æ³•æšä¸¾ç”¨æˆ·ã€‚
{% endhint %}

ä½¿ç”¨ä»¥ä¸‹ä»£ç å¯ä»¥æ›´æ”¹å¯†ç ï¼š
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
è¦æ›´æ”¹å¯†ç ï¼Œæ‚¨éœ€è¦**çŸ¥é“å…ˆå‰çš„å¯†ç **ï¼š
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## è®¤è¯

ç”¨æˆ·æ± æ”¯æŒ**ä¸åŒçš„èº«ä»½éªŒè¯æ–¹å¼**ã€‚å¦‚æœæ‚¨æœ‰**ç”¨æˆ·åå’Œå¯†ç **ï¼Œè¿˜æœ‰**ä¸åŒçš„ç™»å½•æ–¹æ³•**å¯ä¾›é€‰æ‹©ã€‚æ­¤å¤–ï¼Œå½“ç”¨æˆ·åœ¨æ± ä¸­è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œä¼šæä¾›**3ç§ç±»å‹çš„ä»¤ç‰Œ**ï¼š**ID ä»¤ç‰Œ**ã€**è®¿é—®ä»¤ç‰Œ**å’Œ**åˆ·æ–°ä»¤ç‰Œ**ã€‚

* [**ID ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html)ï¼šå®ƒåŒ…å«æœ‰å…³**å·²éªŒè¯ç”¨æˆ·çš„èº«ä»½**çš„å£°æ˜ï¼Œä¾‹å¦‚`name`ã€`email`å’Œ`phone_number`ã€‚ID ä»¤ç‰Œè¿˜å¯ç”¨äº**å°†ç”¨æˆ·èº«ä»½éªŒè¯åˆ°èµ„æºæœåŠ¡å™¨æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åº**ã€‚å¦‚æœæ‚¨åœ¨å¤–éƒ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ ID ä»¤ç‰Œï¼Œæ‚¨å¿…é¡»**éªŒè¯**ID ä»¤ç‰Œçš„**ç­¾å**ï¼Œç„¶åæ‰èƒ½ä¿¡ä»» ID ä»¤ç‰Œä¸­çš„ä»»ä½•å£°æ˜ã€‚
* ID ä»¤ç‰Œæ˜¯**åŒ…å«ç”¨æˆ·å±æ€§å€¼çš„ä»¤ç‰Œ**ï¼Œç”šè‡³åŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚
* [**è®¿é—®ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html)ï¼šå®ƒåŒ…å«æœ‰å…³å·²éªŒè¯ç”¨æˆ·ã€ç”¨æˆ·ç»„åˆ—è¡¨å’Œä½œç”¨åŸŸåˆ—è¡¨çš„å£°æ˜ã€‚è®¿é—®ä»¤ç‰Œçš„ç›®çš„æ˜¯**åœ¨ç”¨æˆ·æ± çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ä¸­æˆæƒ API æ“ä½œ**ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**æˆäºˆç”¨æˆ·è®¿é—®æƒé™**ä»¥æ·»åŠ ã€æ›´æ”¹æˆ–åˆ é™¤ç”¨æˆ·å±æ€§ã€‚
* [**åˆ·æ–°ä»¤ç‰Œ**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html)ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥ä¸ºç”¨æˆ·è·å–æ–°çš„ ID ä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œï¼Œç›´åˆ°**åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆ**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ·æ–°ä»¤ç‰Œåœ¨åº”ç”¨ç¨‹åºç”¨æˆ·ç™»å½•åˆ°ç”¨æˆ·æ± å**30å¤©åè¿‡æœŸ**ã€‚å½“æ‚¨ä¸ºç”¨æˆ·æ± åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**60åˆ†é’Ÿè‡³10å¹´ä¹‹é—´çš„ä»»ä½•å€¼**ã€‚

### ADMIN\_NO\_SRP\_AUTH å’Œ ADMIN\_USER\_PASSWORD\_AUTH

è¿™æ˜¯æœåŠ¡å™¨ç«¯çš„èº«ä»½éªŒè¯æµç¨‹ï¼š

* æœåŠ¡å™¨ç«¯åº”ç”¨è°ƒç”¨**`AdminInitiateAuth` API æ“ä½œ**ï¼ˆè€Œä¸æ˜¯ `InitiateAuth`ï¼‰ã€‚æ­¤æ“ä½œéœ€è¦å…·æœ‰åŒ…æ‹¬**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„ AWS å‡­è¯ã€‚è¯¥æ“ä½œè¿”å›æ‰€éœ€çš„èº«ä»½éªŒè¯å‚æ•°ã€‚
* åœ¨æœåŠ¡å™¨ç«¯åº”ç”¨è·å–åˆ°**èº«ä»½éªŒè¯å‚æ•°**åï¼Œè°ƒç”¨**`AdminRespondToAuthChallenge` API æ“ä½œ**ã€‚åªæœ‰åœ¨æä¾› AWS å‡­è¯æ—¶ï¼Œ`AdminRespondToAuthChallenge` API æ“ä½œæ‰ä¼šæˆåŠŸã€‚

æ­¤æ–¹æ³•**é»˜è®¤æƒ…å†µä¸‹æœªå¯ç”¨**ã€‚

è¦è¿›è¡Œ**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

* ç”¨æˆ·æ±  ID
* å®¢æˆ·ç«¯ ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…åœ¨åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶éœ€è¦ï¼‰

{% hint style="info" %}
ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œ**ç™»å½•**ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨`ALLOW_ADMIN_USER_PASSWORD_AUTH`è¿›è¡Œç™»å½•ã€‚æ­¤å¤–ï¼Œæ‰§è¡Œæ­¤æ“ä½œéœ€è¦å…·æœ‰**`cognito-idp:AdminInitiateAuth`**å’Œ**`cognito-idp:AdminRespondToAuthChallenge`**æƒé™çš„å‡­è¯ã€‚
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>ç™»å½•ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

è¿™ç§æ–¹æ³•æ˜¯å¦ä¸€ç§ç®€å•ä¸”ä¼ ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç è®¤è¯æµç¨‹ã€‚å»ºè®®å°†ä¼ ç»Ÿçš„èº«ä»½éªŒè¯æ–¹æ³•è¿ç§»åˆ°Cognitoï¼Œå¹¶å»ºè®®ç¦ç”¨å®ƒï¼Œç„¶åæ”¹ç”¨ALLOW\_USER\_SRP\_AUTHæ–¹æ³•ï¼ˆå› ä¸ºè¯¥æ–¹æ³•æ°¸è¿œä¸ä¼šå°†å¯†ç å‘é€åˆ°ç½‘ç»œä¸Šï¼‰ã€‚\
é»˜è®¤æƒ…å†µä¸‹ï¼Œ**æ­¤æ–¹æ³•æœªå¯ç”¨**ã€‚

ä¸ä»£ç ä¸­çš„å…ˆå‰èº«ä»½éªŒè¯æ–¹æ³•ç›¸æ¯”ï¼Œä¸»è¦çš„**åŒºåˆ«**æ˜¯æ‚¨**ä¸éœ€è¦çŸ¥é“ç”¨æˆ·æ± ID**ï¼Œä¹Ÿ**ä¸éœ€è¦é¢å¤–çš„æƒé™**åœ¨Cognitoç”¨æˆ·æ± ä¸­ã€‚

è¦è¿›è¡Œ**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

* å®¢æˆ·ç«¯ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

{% hint style="info" %}
ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ­¤æ–¹æ³•ç™»å½•ï¼Œè¯¥åº”ç”¨ç¨‹åºå¿…é¡»å…è®¸ä½¿ç”¨ALLOW\_USER\_PASSWORD\_AUTHç™»å½•ã€‚
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Pythonä»£ç ç™»å½•</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

è¿™ç§æƒ…å†µä¸ä¹‹å‰çš„æƒ…å†µç±»ä¼¼ï¼Œä½†æ˜¯**ä¸ä¼šé€šè¿‡ç½‘ç»œå‘é€å¯†ç **æ¥ç™»å½•ï¼Œè€Œæ˜¯æ‰§è¡Œ**æŒ‘æˆ˜è®¤è¯**ï¼ˆå› æ­¤å¯†ç ç”šè‡³ä¸ä¼šé€šè¿‡ç½‘ç»œåŠ å¯†ä¼ è¾“ï¼‰ã€‚\
æ­¤**æ–¹æ³•é»˜è®¤å¯ç”¨**ã€‚

è¦è¿›è¡Œ**ç™»å½•**ï¼Œæ‚¨éœ€è¦çŸ¥é“ï¼š

* ç”¨æˆ·æ± ID
* å®¢æˆ·ç«¯ID
* ç”¨æˆ·å
* å¯†ç 
* å®¢æˆ·ç«¯å¯†é’¥ï¼ˆä»…å½“åº”ç”¨ç¨‹åºé…ç½®ä¸ºä½¿ç”¨å¯†é’¥æ—¶ï¼‰

<details>

<summary>ç™»å½•ä»£ç </summary>
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

è¿™ä¸ªæ–¹æ³•**å§‹ç»ˆæœ‰æ•ˆ**ï¼ˆæ— æ³•ç¦ç”¨ï¼‰ï¼Œä½†æ‚¨éœ€è¦æ‹¥æœ‰æœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œã€‚
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>åˆ·æ–°ä»£ç </summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**èº«ä»½éªŒè¯**å°†é€šè¿‡**æ‰§è¡Œä¸€ä¸ªlambdaå‡½æ•°**æ¥å®Œæˆã€‚

## é¢å¤–çš„å®‰å…¨æ€§

### é«˜çº§å®‰å…¨æ€§

é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼Œä½†å¦‚æœå¯ç”¨ï¼ŒCognitoå¯ä»¥**å‘ç°è´¦æˆ·åŠ«æŒ**ã€‚ä¸ºäº†æœ€å°åŒ–æ¦‚ç‡ï¼Œæ‚¨åº”è¯¥ä»**åŒä¸€åŸå¸‚å†…çš„ç½‘ç»œ**ä½¿ç”¨**ç›¸åŒçš„ç”¨æˆ·ä»£ç†**ï¼ˆå¦‚æœå¯èƒ½çš„è¯ä½¿ç”¨ç›¸åŒçš„IPï¼‰è¿›è¡Œç™»å½•ã€‚

### MFAè®°ä½è®¾å¤‡

å¦‚æœç”¨æˆ·ä»åŒä¸€è®¾å¤‡ç™»å½•ï¼ŒMFAå¯èƒ½ä¼šè¢«ç»•è¿‡ï¼Œå› æ­¤å°è¯•ä½¿ç”¨ç›¸åŒçš„æµè§ˆå™¨å’Œç›¸åŒçš„å…ƒæ•°æ®ï¼ˆIPï¼Ÿï¼‰è¿›è¡Œç™»å½•ï¼Œä»¥å°è¯•ç»•è¿‡MFAä¿æŠ¤ã€‚

## ç”¨æˆ·æ± ç»„IAMè§’è‰²

å¯ä»¥å°†**ç”¨æˆ·æ·»åŠ åˆ°ç”¨æˆ·æ± **ç»„ï¼Œè¿™äº›ç»„ä¸ä¸€ä¸ª**IAMè§’è‰²**ç›¸å…³è”ã€‚æ­¤å¤–ï¼Œ**ç”¨æˆ·**å¯ä»¥è¢«åˆ†é…åˆ°**å¤šä¸ªå…·æœ‰ä¸åŒIAMè§’è‰²çš„ç»„**ä¸­ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ä¸€ä¸ªç»„ä½äºå…·æœ‰IAMè§’è‰²çš„ç»„ä¸­ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®è¯¥ç»„çš„IAMå‡­è¯ï¼Œéœ€è¦**ç”¨æˆ·æ± å—åˆ°èº«ä»½æ± çš„ä¿¡ä»»**ï¼ˆå¹¶äº†è§£è¯¥èº«ä»½æ± çš„è¯¦ç»†ä¿¡æ¯ï¼‰ã€‚

å½“ç”¨æˆ·åœ¨ç”¨æˆ·æ± ä¸­è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆ`aws cognito-idp initiate-auth...`ï¼‰æ—¶ï¼Œè¦è·å¾—**IdTokenä¸­æŒ‡å®šçš„IAMè§’è‰²**ï¼Œè¿˜éœ€è¦**èº«ä»½æä¾›è€…èº«ä»½éªŒè¯æä¾›è€…**æŒ‡ç¤º**å¿…é¡»ä»ä»¤ç‰Œä¸­é€‰æ‹©è§’è‰²**ã€‚

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

ç”¨æˆ·å¯ä»¥è®¿é—®çš„**è§’è‰²**ä½äº**`IdToken`**ä¸­ï¼Œå¹¶ä¸”ç”¨æˆ·å¯ä»¥ä½¿ç”¨**`--custom-role-arn`**ä»`aws cognito-identity get-credentials-for-identity`é€‰æ‹©ä»–æƒ³è¦å‡­è¯çš„è§’è‰²ã€‚\
ç„¶è€Œï¼Œå¦‚æœ**é»˜è®¤é€‰é¡¹**æ˜¯**å·²é…ç½®çš„é€‰é¡¹**ï¼ˆä½¿ç”¨é»˜è®¤è§’è‰²ï¼‰ï¼Œå¹¶ä¸”æ‚¨å°è¯•ä»IdTokenè®¿é—®è§’è‰²ï¼Œæ‚¨å°†æ”¶åˆ°**é”™è¯¯**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å…ˆå‰çš„é…ç½®ï¼‰ï¼š

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåˆ†é…ç»™**ç”¨æˆ·æ± ç»„**çš„è§’è‰²éœ€è¦è¢«**ä¿¡ä»»ç”¨æˆ·æ± çš„èº«ä»½æä¾›è€…**æ‰€**è®¿é—®**ï¼ˆå› ä¸ºIAMè§’è‰²çš„**ä¼šè¯å‡­è¯å°†ä»å…¶ä¸­è·å–**ï¼‰ã€‚
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ–è€… **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
