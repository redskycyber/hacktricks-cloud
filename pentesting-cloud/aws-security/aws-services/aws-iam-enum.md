# AWS - IAM, Kitambulisho Center & SSO Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## IAM

Unaweza kupata **maelezo ya IAM** katika:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Uorodheshaji

Ruhusa kuu zinazohitajika:

* `iam:ListPolicies`, `iam:GetPolicy` na `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` na `iam:GetUserPolicy`
* `iam:ListGroupPolicies` na `iam:GetGroupPolicy`
* `iam:ListRolePolicies` na `iam:GetRolePolicy`
```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role
## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
## attached policies
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```
### Uvamizi wa Kibali Kwa Nguvu

Ikiwa una nia ya vibali vyako mwenyewe lakini huna ufikiaji wa kuuliza IAM unaweza daima kuvamia kwa nguvu.

#### bf-aws-permissions

Zana [**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) ni skripti ya bash ambayo itaendeshwa kwa kutumia wasifu ulioonyeshwa wote **`list*`, `describe*`, `get*`** hatua inayoweza kupatikana kutumia ujumbe wa msaada wa `aws` cli na **kurudisha utekelezaji mafanikio**.

{% code overflow="wrap" %}
```bash
# Bruteforce permissions
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
{% endcode %}

#### bf-aws-perms-simulate

Chombo [**bf-aws-perms-simulate**](https://github.com/carlospolop/bf-aws-perms-simulate) kinaweza kupata ruhusa yako ya sasa (au ile ya mawakala wengine) ikiwa una ruhusa ya **`iam:SimulatePrincipalPolicy`**
```bash
# Ask for permissions
python3 aws_permissions_checker.py --profile <AWS_PROFILE> [--arn <USER_ARN>]
```
#### Perms2ManagedPolicies

Ikiwa umepata **baadhi ya ruhusa ambazo mtumiaji wako ana**, na unadhani zinatolewa na **jukumu la AWS lililosimamiwa** (na sio moja ya desturi). Unaweza kutumia zana [**aws-Perms2ManagedRoles**](https://github.com/carlospolop/aws-Perms2ManagedPolicies) kuchunguza **majukumu yote ya AWS yaliyosimamiwa yanayotoa ruhusa ulizoona unazo**.

{% code overflow="wrap" %}
```bash
# Run example with my profile
python3 aws-Perms2ManagedPolicies.py --profile myadmin --permissions-file example-permissions.txt
```
{% endcode %}

{% hint style="warning" %}
Inawezekana "kujua" kama ruhusa unazomiliki zimetolewa na jukumu lililosimamiwa na AWS ikiwa unaona kwamba **una ruhusa juu ya huduma ambazo hazitumiki** kwa mfano.
{% endhint %}

#### Cloudtrail2IAM

[**CloudTrail2IAM**](https://github.com/carlospolop/Cloudtrail2IAM) ni chombo cha Python kinachochambua **kumbukumbu za AWS CloudTrail ili kutoa na kufupisha hatua** zilizofanywa na kila mtu au tu mtumiaji au jukumu fulani. Chombo hicho kitak **chambua kila kumbukumbu ya cloudtrail kutoka kwenye kisanduku kilichotajwa**.

{% code overflow="wrap" %}
```bash
git clone https://github.com/carlospolop/Cloudtrail2IAM
cd Cloudtrail2IAM
pip install -r requirements.txt
python3 cloudtrail2IAM.py --prefix PREFIX --bucket_name BUCKET_NAME --profile PROFILE [--filter-name FILTER_NAME] [--threads THREADS]
```
{% endcode %}

{% hint style="warning" %}
Ikiwa unapata .tfstate (faili za hali ya Terraform) au faili za CloudFormation (hizi kawaida ni faili za yaml zilizoko ndani ya ndoo yenye kipimo cha cf-templates), unaweza pia kusoma ili kupata usanidi wa aws na kujua ni ruhusa zipi zimewekwa kwa nani.
{% endhint %}

#### enumera-iam

Ili kutumia zana [**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam) kwanza unahitaji kupakua vituo vyote vya API vya AWS, kutoka kwenye hivyo script **`generate_bruteforce_tests.py`** itapata vituo vyote vya **"list\_", "describe\_", na "get\_"**. Na mwishowe, itajaribu **kupata ufikiaji** kwao kwa kutumia sifa zilizotolewa na **kuonyesha ikiwa ilifanya kazi**.

(Kulingana na uzoefu wangu **zana inakwama wakati fulani**, [**angalia marekebisho haya**](https://github.com/andresriancho/enumerate-iam/pull/15/commits/77ad5b41216e3b5f1511d0c385da8cd5984c2d3c) kujaribu kusahihisha hilo).

{% hint style="warning" %}
Kulingana na uzoefu wangu zana hii ni kama ile ya awali lakini inafanya kazi vibaya zaidi na kuangalia ruhusa chache zaidi.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Install tool
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt

# Download API endpoints
cd enumerate_iam/
git clone https://github.com/aws/aws-sdk-js.git
python3 generate_bruteforce_tests.py
rm -rf aws-sdk-js
cd ..

# Enumerate permissions
python3 enumerate-iam.py --access-key ACCESS_KEY --secret-key SECRET_KEY [--session-token SESSION_TOKEN] [--region REGION]
```
{% endcode %}

#### weirdAAL

Unaweza pia kutumia zana [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki). Zana hii itachunguza **operesheni kadhaa za kawaida kwenye huduma kadhaa za kawaida** (itachunguza idhini za uorodheshaji na pia idhini za privesc). Lakini itachunguza tu uchunguzi uliopangwa (njia pekee ya kuchunguza vitu zaidi ni kwa kuandika vipimo zaidi).
```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Setup DB
python3 create_dbs.py

# Invoke it
python3 weirdAAL.py -m ec2_describe_instances -t ec2test # Just some ec2 tests
python3 weirdAAL.py -m recon_all -t MyTarget # Check all permissions
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
#### Vifaa vya Kuboresha kufuatilia ruhusa

{% tabs %}
{% tab title="CloudSploit" %}
{% code overflow="wrap" %}
```bash
# Export env variables
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filter results removing unknown
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Get services by regions
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json
```
{% endcode %}
{% endtab %}

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# In this case you cannot output to JSON, so heck it in the dashboard
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<YourTool>

Hakuna zana yoyote kati ya zile zilizotajwa inayoweza kuchunguza karibu ruhusa zote, hivyo kama unajua zana bora tuma PR!

### Upatikanaji usiothibitishwa

{% content-ref url="../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### Kupandisha Hadhi

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia ruhusa za IAM kupandisha hadhi**:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### Baada ya Uchimbaji wa IAM

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### Uthabiti wa IAM

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## Kituo cha Utambulisho cha IAM

Unaweza kupata **maelezo ya Kituo cha Utambulisho cha IAM** katika:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Unganisha kupitia SSO na CLI
```bash
# Connect with sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```
### Uchambuzi

Vipengele kuu vya Kituo cha Utambulisho ni:

* Watumiaji na vikundi
* Seti za Ruhusa: Zina sera zilizowekwa
* Akaunti za AWS

Kisha, mahusiano huanzishwa ili watumiaji/vikundi wawe na Seti za Ruhusa juu ya Akaunti za AWS.

{% hint style="info" %}
Tafadhali kumbuka kuwa kuna njia 3 za kuambatanisha sera kwa Seti ya Ruhusa. Kuambatanisha sera zilizosimamiwa na AWS, Sera zilizosimamiwa na Mteja (sera hizi zinahitaji kuundwa katika akaunti zote ambazo Seti ya Ruhusa inaathiri), na sera za ndani (zilizoelezwa hapo).
{% endhint %}
```bash
# Check if IAM Identity Center is used
aws sso-admin list-instances

# Get Permissions sets. These are the policies that can be assigned
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Get managed policies of a permission set
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get inline policies of a permission set
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get customer managed policies of a permission set
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get boundaries of a permission set
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## List accounts a permission set is affecting
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## List principals given a permission set in an account
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Get permissions sets affecting an account
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# List users & groups from the identity store
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Get members of groups
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Get memberships or a user or a group
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```
### Uchambuzi wa Kienyeji

Inawezekana kuunda ndani ya folda `$HOME/.aws` faili ya config ili kusanidi maelezo yanayopatikana kupitia SSO, kwa mfano:
```ini
[default]
region = us-west-2
output = json

[profile my-sso-profile]
sso_start_url = https://my-sso-portal.awsapps.com/start
sso_region = us-west-2
sso_account_id = 123456789012
sso_role_name = MySSORole
region = us-west-2
output = json

[profile dependent-profile]
role_arn = arn:aws:iam::<acc-id>:role/ReadOnlyRole
source_profile = Hacktricks-Admin
```
Hii mazingira inaweza kutumika na amri zifuatazo:
```bash
# Login in ms-sso-profile
aws sso login --profile my-sso-profile
# Use dependent-profile
aws s3 ls --profile dependent-profile
```
Wakati **wasifu kutoka SSO unapotumiwa** kupata baadhi ya habari, sifa hizo zinahifadhiwa kwenye faili ndani ya folda **`$HOME/.aws/sso/cache`**. Hivyo basi zinaweza **kusomwa na kutumiwa kutoka hapo**.

Zaidi ya hayo, **sifa zaidi** zinaweza kuhifadhiwa kwenye folda **`$HOME/.aws/cli/cache`**. Folda hii ya cache hutumiwa hasa unapokuwa **ukifanya kazi na wasifu wa AWS CLI** ambao hutumia sifa za mtumiaji wa IAM au **kudai** majukumu kupitia IAM (bila SSO). Mfano wa mipangilio:
```ini
[profile crossaccountrole]
role_arn = arn:aws:iam::234567890123:role/SomeRole
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/saanvi
external_id = 123456
```
### Upatikanaji usiothibitishwa

{% content-ref url="../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md" %}
[aws-identity-center-and-sso-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-identity-center-and-sso-unauthenticated-enum.md)
{% endcontent-ref %}

### Kupanda cheo

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### Baada ya Uvamizi

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### Uthabiti

#### Unda mtumiaji na umpe idhini za kufanya kazi

{% code overflow="wrap" %}
```bash
# Create user identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## After creating it try to login in the console using the selected username, you will receive an email with the code and then you will be able to select a password
```
{% endcode %}

* Unda kikundi na umpatie ruhusa na umweke mtumiaji aliye chini ya udhibiti
* Toa ruhusa za ziada kwa mtumiaji au kikundi kilichodhibitiwa
* Kwa chaguo-msingi, watumiaji pekee wenye ruhusa kutoka kwenye Akaunti ya Usimamizi ndio wataweza kupata na kudhibiti Kituo cha Kitambulisho cha IAM.

Hata hivyo, niwezekanavyo kupitia Msimamizi wa Uteuzi kuruhusu watumiaji kutoka kwenye akaunti tofauti kuisimamia. Hawatapata ruhusa sawa kabisa, lakini wataweza kutekeleza [**shughuli za usimamizi**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html).
