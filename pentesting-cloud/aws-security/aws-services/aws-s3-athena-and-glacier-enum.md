# AWS - S3, Athena & Glacier Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>μ—μ„ AWS ν•΄ν‚Ήμ„ μ²μλ¶€ν„° μ „λ¬Έκ°€κΉμ§€ λ°°μ›λ³΄μ„Έμ”<strong>!</strong></summary>

HackTricksλ¥Ό μ§€μ›ν•λ” λ‹¤λ¥Έ λ°©λ²•:

* **νμ‚¬λ¥Ό HackTricksμ—μ„ κ΄‘κ³ ν•κ±°λ‚ HackTricksλ¥Ό PDFλ΅ λ‹¤μ΄λ΅λ“**ν•λ ¤λ©΄ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)λ¥Ό ν™•μΈν•μ„Έμ”!
* [**κ³µμ‹ PEASS & HackTricks μ¤μ›¨κ·Έ**](https://peass.creator-spring.com)λ¥Ό μ–»μΌμ„Έμ”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)λ¥Ό λ°κ²¬ν•μ„Έμ”. λ…μ μ μΈ [**NFTs**](https://opensea.io/collection/the-peass-family) μ»¬λ ‰μ…μ…λ‹λ‹¤.
* π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— **μ°Έμ—¬**ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**λ¥Ό** **ν”λ΅μ°**ν•μ„Έμ”.
* **HackTricks**μ™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github μ €μ¥μ†μ— PRμ„ μ μ¶ν•μ—¬ **ν•΄ν‚Ή νΈλ¦­μ„ κ³µμ **ν•μ„Έμ”.

</details>

## S3

Amazon S3λ” **λ€λ‰μ λ°μ΄ν„°λ¥Ό μ €μ¥**ν•  μ μλ” μ„λΉ„μ¤μ…λ‹λ‹¤.

Amazon S3λ” λ°μ΄ν„°μ **λ³΄νΈ**λ¥Ό μ„ν• μ—¬λ¬ μµμ…μ„ μ κ³µν•©λ‹λ‹¤. μµμ…μ—λ” **κ¶ν•**(μ •μ±…), **μ•”νΈν™”**(ν΄λΌμ΄μ–ΈνΈ λ° μ„λ²„ μΈ΅), **λ²„ν‚· λ²„μ „ κ΄€λ¦¬** λ° **MFA(Multi-Factor Authentication)** **κΈ°λ° μ‚­μ **κ°€ ν¬ν•¨λ©λ‹λ‹¤. μ‚¬μ©μλ” μ΄λ¬ν• μµμ… μ¤‘ ν•λ‚ μ΄μƒμ„ ν™μ„±ν™”ν•μ—¬ λ°μ΄ν„° λ³΄νΈλ¥Ό λ‹¬μ„±ν•  μ μμµλ‹λ‹¤. **λ°μ΄ν„° λ³µμ **λ” AWSμ λ‚΄λ¶€ μ‹μ„¤λ΅, **S3λ” μλ™μΌλ΅ λ¨λ“  κ°€μ© μμ—­μ— κ°μ²΄λ¥Ό λ³µμ **ν•λ©° μ΅°μ§μ€ μ΄λ¥Ό ν™μ„±ν™”ν•  ν•„μ”κ°€ μ—†μµλ‹λ‹¤.

λ¦¬μ†μ¤ κΈ°λ° κ¶ν•μ„ μ‚¬μ©ν•λ©΄ λ²„ν‚·μ ν•μ„ λ””λ ‰ν„°λ¦¬μ— λ€ν• κ¶ν•μ„ λ³„λ„λ΅ μ •μν•  μ μμµλ‹λ‹¤.

### λ²„ν‚· λ²„μ „ κ΄€λ¦¬ λ° MFA κΈ°λ° μ‚­μ 

λ²„ν‚· λ²„μ „ κ΄€λ¦¬κ°€ ν™μ„±ν™”λλ©΄ νμΌ λ‚΄μ νμΌμ„ λ³€κ²½ν•λ ¤λ” λ¨λ“  μ‘μ—…μ€ ν•΄λ‹Ή νμΌμ μƒ λ²„μ „μ„ μƒμ„±ν•λ©°, μ΄μ „ λ‚΄μ©λ„ μ μ§€ν•©λ‹λ‹¤. λ”°λΌμ„ λ‚΄μ©μ„ λ®μ–΄μ“°μ§€ μ•μµλ‹λ‹¤.

λν•, MFA κΈ°λ° μ‚­μ λ” S3 λ²„ν‚·μ νμΌ λ²„μ „μ΄ μ‚­μ λλ” κ²ƒκ³Ό λ²„ν‚· λ²„μ „ κ΄€λ¦¬κ°€ λΉ„ν™μ„±ν™”λλ” κ²ƒμ„ λ°©μ§€ν•λ―€λ΅, κ³µκ²©μλ” μ΄λ¬ν• νμΌμ„ λ³€κ²½ν•  μ μ—†μµλ‹λ‹¤.

### S3 μ•΅μ„Έμ¤ λ΅κ·Έ

S3 μ•΅μ„Έμ¤ λ΅κ·Έλ¥Ό **ν™μ„±ν™”**ν•  μ μμΌλ©°(κΈ°λ³Έμ μΌλ΅ λΉ„ν™μ„±ν™”λ¨), λ΅κ·Έλ¥Ό λ‹¤λ¥Έ λ²„ν‚·μ— μ €μ¥ν•μ—¬ λ„κ°€ λ²„ν‚·μ— μ ‘κ·Όν•λ”μ§€ μ• μ μμµλ‹λ‹¤(λ‘ λ²„ν‚·μ€ λ™μΌν• λ¦¬μ „μ— μμ–΄μ•Ό ν•¨).

### S3 μ‚¬μ „ μ„λ…λ URL

μ‚¬μ „ μ„λ…λ URLμ„ μƒμ„±ν•μ—¬ μΌλ°μ μΌλ΅ λ²„ν‚·μ **μ§€μ •λ νμΌμ— μ•΅μ„Έμ¤**ν•  μ μμµλ‹λ‹¤. **μ‚¬μ „ μ„λ…λ URLμ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
μ‚¬μ „ μ„λ…λ URLμ€ κ°μ²΄μ— μ•΅μ„Έμ¤ κ¶ν•μ΄ μλ” μ£Όμ²΄μ μκ²© μ¦λ…μ„ μ‚¬μ©ν•μ—¬ cliμ—μ„ μƒμ„±ν•  μ μμµλ‹λ‹¤ (μ‚¬μ©ν•λ” κ³„μ •μ— μ•΅μ„Έμ¤ κ¶ν•μ΄ μ—†λ” κ²½μ° λ” μ§§μ€ μ‚¬μ „ μ„λ…λ URLμ΄ μƒμ„±λμ§€λ§ μ“Έλ¨ μ—†μ„ κ²ƒμ…λ‹λ‹¤)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
μ‚¬μ „ μ„λ…λ URLμ„ μƒμ„±ν•κΈ° μ„ν•΄ ν•„μ”ν• μ μΌν• κ¶ν•μ€ μ£Όμ–΄μ§„ κ¶ν•μ΄λ―€λ΅ μ΄μ „ λ…λ Ήμ— λ€ν•΄ μ£Όμ²΄κ°€ ν•„μ”λ΅ ν•λ” μ μΌν• κ¶ν•μ€ `s3:GetObject`μ…λ‹λ‹¤.
{% endhint %}

**λ‹¤λ¥Έ κ¶ν•**μΌλ΅ μ‚¬μ „ μ„λ…λ URLμ„ μƒμ„±ν•λ” κ²ƒλ„ κ°€λ¥ν•©λ‹λ‹¤:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 μ•”νΈν™” λ©”μ»¤λ‹μ¦

**DEKλ” λ°μ΄ν„° μ•”νΈν™” ν‚¤(Data Encryption Key)λ¥Ό μλ―Έ**ν•λ©°, ν•­μƒ μƒμ„±λκ³  λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤.

<details>

<summary><strong>S3 κ΄€λ¦¬ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-S3</strong></summary>

μ΄ μµμ…μ€ μµμ†ν•μ κµ¬μ„±μ„ ν•„μ”λ΅ν•λ©°, μ‚¬μ©λλ” μ•”νΈν™” ν‚¤μ λ¨λ“  κ΄€λ¦¬λ” AWSμ—μ„ κ΄€λ¦¬ν•©λ‹λ‹¤. λ‹¨μ§€ λ°μ΄ν„°λ¥Ό μ—…λ΅λ“ν•κ³  S3κ°€ λ¨λ“  λ‹¤λ¥Έ μΈ΅λ©΄μ„ μ²λ¦¬ν•λ„λ΅ν•λ©΄λ©λ‹λ‹¤. S3 κ³„μ •μ κ° λ²„ν‚·μ—λ” λ²„ν‚· ν‚¤κ°€ ν• λ‹Ήλ©λ‹λ‹¤.

* μ•”νΈν™”:
* κ°μ²΄ λ°μ΄ν„° + μƒμ„±λ ν‰λ¬Έ DEK --> μ•”νΈν™” λ λ°μ΄ν„° (S3 λ‚΄λ¶€μ— μ €μ¥)
* μƒμ„±λ ν‰λ¬Έ DEK + S3 λ§μ¤ν„° ν‚¤ --> μ•”νΈν™” λ DEK (S3 λ‚΄λ¶€μ— μ €μ¥) λ° ν‰λ¬Έμ€ λ©”λ¨λ¦¬μ—μ„ μ‚­μ λ¨
* λ³µνΈν™”:
* μ•”νΈν™” λ DEK + S3 λ§μ¤ν„° ν‚¤ --> ν‰λ¬Έ DEK
* ν‰λ¬Έ DEK + μ•”νΈν™” λ λ°μ΄ν„° --> κ°μ²΄ λ°μ΄ν„°

μ΄ κ²½μ° **ν‚¤λ” AWSμ—μ„ κ΄€λ¦¬**λ©λ‹λ‹¤ (3λ…„λ§λ‹¤ λ΅ν…μ΄μ…). μμ²΄ ν‚¤λ¥Ό μ‚¬μ©ν•λ©΄ λ΅ν…μ΄μ…, λΉ„ν™μ„±ν™” λ° μ•΅μ„Έμ¤ μ μ–΄λ¥Ό μ μ©ν•  μ μμµλ‹λ‹¤.

</details>

<details>

<summary><strong>KMS κ΄€λ¦¬ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-KMS</strong></summary>

μ΄ λ°©λ²•μ„ μ‚¬μ©ν•λ©΄ S3κ°€ ν‚¤ κ΄€λ¦¬ μ„λΉ„μ¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„° μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•  μ μμµλ‹λ‹¤. KMSλ¥Ό μ‚¬μ©ν•λ©΄ ν‚¤ κ΄€λ¦¬μ— λ€ν• ν›¨μ”¬ λ” ν° μ μ—°μ„±μ„ μ κ³µν•©λ‹λ‹¤. μλ¥Ό λ“¤μ–΄, CMKμ— λ€ν• μ‚¬μ© λΉ„ν™μ„±ν™”, λ΅ν…μ΄μ… λ° μ•΅μ„Έμ¤ μ μ–΄λ¥Ό μ μ©ν•  μ μμΌλ©°, AWS Cloud Trailμ„ μ‚¬μ©ν•μ—¬ μ‚¬μ©μ— λ€ν• λ…λ Ήμ„ λ‚΄λ¦΄ μ μμµλ‹λ‹¤.

* μ•”νΈν™”:
* S3κ°€ KMS CMKλ΅λ¶€ν„° λ°μ΄ν„° ν‚¤λ¥Ό μ”μ²­
* KMSλ” CMKλ¥Ό μ‚¬μ©ν•μ—¬ DEK ν‰λ¬Έκ³Ό DEK μ•”νΈν™”λ¥Ό μƒμ„±ν•κ³  S3μ— μ „μ†΅
* S3λ” ν‰λ¬Έ ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³ , μ•”νΈν™” λ λ°μ΄ν„°μ™€ μ•”νΈν™” λ ν‚¤λ¥Ό μ €μ¥ν•κ³ , ν‰λ¬Έ ν‚¤λ¥Ό λ©”λ¨λ¦¬μ—μ„ μ‚­μ ν•©λ‹λ‹¤.
* λ³µνΈν™”:
* S3κ°€ κ°μ²΄μ μ•”νΈν™” λ λ°μ΄ν„° ν‚¤λ¥Ό λ³µνΈν™”ν•κΈ° μ„ν•΄ KMSμ— μ”μ²­
* KMSλ” CMKλ΅ λ°μ΄ν„° ν‚¤λ¥Ό λ³µνΈν™”ν•κ³  S3μ— λ‹¤μ‹ μ „μ†΅
* S3κ°€ κ°μ²΄ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤.

</details>

<details>

<summary><strong>κ³ κ° μ κ³µ ν‚¤λ¥Ό μ‚¬μ©ν• μ„λ²„ μΈ΅ μ•”νΈν™”, SSE-C</strong></summary>

μ΄ μµμ…μ„ μ‚¬μ©ν•λ©΄ μ΄λ―Έ AWS μ™Έλ¶€μ—μ„ μ‚¬μ© μ¤‘μΈ κ³ μ ν• λ§μ¤ν„° ν‚¤λ¥Ό μ κ³µν•  μ μμµλ‹λ‹¤. κ·Έλ° λ‹¤μ S3λ΅ λ°μ΄ν„°λ¥Ό λ³΄λ‚Ό λ• S3κ°€ μ•”νΈν™”λ¥Ό μν–‰ν•©λ‹λ‹¤.

* μ•”νΈν™”:
* μ‚¬μ©μκ°€ κ°μ²΄ λ°μ΄ν„° + κ³ κ° ν‚¤λ¥Ό S3λ΅ μ „μ†΅
* κ³ κ° ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³  μ•”νΈν™” λ λ°μ΄ν„°λ¥Ό μ €μ¥
* ν–¥ν›„ ν‚¤ μ ν¨μ„± κ²€μ‚¬λ¥Ό μ„ν•΄ κ³ κ° ν‚¤μ μ†”νΈ HMAC κ°’λ„ μ €μ¥
* κ³ κ° ν‚¤λ” λ©”λ¨λ¦¬μ—μ„ μ‚­μ λ¨
* λ³µνΈν™”:
* μ‚¬μ©μκ°€ κ³ κ° ν‚¤λ¥Ό μ „μ†΅
* μ €μ¥λ HMAC κ°’κ³Ό κ³ κ° ν‚¤λ¥Ό μ ν¨μ„± κ²€μ‚¬
* μ κ³µλ κ³ κ° ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤.

</details>

<details>

<summary><strong>KMSλ¥Ό μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μΈ΅ μ•”νΈν™”, CSE-KMS</strong></summary>

SSE-KMSμ™€ λ§μ°¬κ°€μ§€λ΅ μ΄ λ°©λ²•μ€ ν‚¤ κ΄€λ¦¬ μ„λΉ„μ¤λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„° μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤. κ·Έλ¬λ‚ μ΄λ²μ—λ” KMSκ°€ S3κ°€ μ•„λ‹ ν΄λΌμ΄μ–ΈνΈλ¥Ό ν†µν•΄ νΈμ¶λ©λ‹λ‹¤. κ·Έλ° λ‹¤μ μ•”νΈν™”κ°€ ν΄λΌμ΄μ–ΈνΈ μΈ΅μ—μ„ μν–‰λκ³  μ•”νΈν™” λ λ°μ΄ν„°κ°€ S3λ΅ μ „μ†΅λμ–΄ μ €μ¥λ©λ‹λ‹¤.

* μ•”νΈν™”:
* ν΄λΌμ΄μ–ΈνΈκ°€ KMSμ— λ°μ΄ν„° ν‚¤λ¥Ό μ”μ²­
* KMSλ” ν‰λ¬Έ DEKμ™€ CMKλ΅ μ•”νΈν™” λ DEKλ¥Ό λ°ν™
* λ‘ ν‚¤κ°€ λ‹¤μ‹ μ „μ†΅λ¨
* ν΄λΌμ΄μ–ΈνΈλ” ν‰λ¬Έ DEKλ΅ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³  μ•”νΈν™” λ λ°μ΄ν„° + μ•”νΈν™” λ DEK (S3 λ‚΄λ¶€μ μ•”νΈν™” λ λ°μ΄ν„°μ λ©”νƒ€λ°μ΄ν„°λ΅ μ €μ¥λ¨)λ¥Ό S3λ΅ μ „μ†΅
* λ³µνΈν™”:
* μ•”νΈν™” λ DEKμ™€ ν•¨κ» μ•”νΈν™” λ λ°μ΄ν„°κ°€ ν΄λΌμ΄μ–ΈνΈλ΅ μ „μ†΅λ¨
* ν΄λΌμ΄μ–ΈνΈκ°€ KMSμ— μ•”νΈν™” λ ν‚¤λ¥Ό λ³µνΈν™”ν•λ„λ΅ μ”μ²­ν•κ³  KMSλ” ν‰λ¬Έ DEKλ¥Ό λ‹¤μ‹ μ „μ†΅
* ν΄λΌμ΄μ–ΈνΈλ” μ΄μ  μ•”νΈν™” λ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤.

</details>

<details>

<summary><strong>κ³ κ° μ κ³µ ν‚¤λ¥Ό μ‚¬μ©ν• ν΄λΌμ΄μ–ΈνΈ μΈ΅ μ•”νΈν™”, CSE-C</strong></summary>

μ΄ λ©”μ»¤λ‹μ¦μ„ μ‚¬μ©ν•λ©΄ μ κ³µλ ν‚¤λ¥Ό μ‚¬μ©ν•κ³  AWS-SDK ν΄λΌμ΄μ–ΈνΈλ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό S3μ— λ³΄λ‚΄κΈ° μ „μ— λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•  μ μμµλ‹λ‹¤.

* μ•”νΈν™”:
* ν΄λΌμ΄μ–ΈνΈκ°€ DEKλ¥Ό μƒμ„±ν•κ³  ν‰λ¬Έ λ°μ΄ν„°λ¥Ό μ•”νΈν™”
* κ·Έλ° λ‹¤μ μ‚¬μ©μ μ§€μ • CMKλ¥Ό μ‚¬μ©ν•μ—¬ DEKλ¥Ό μ•”νΈν™”
* μ•”νΈν™” λ λ°μ΄ν„° + μ•”νΈν™” λ DEKλ¥Ό S3μ— μ μ¶ν•μ—¬ μ €μ¥
* λ³µνΈν™”:
* S3κ°€ μ•”νΈν™” λ λ°μ΄ν„°μ™€ DEKλ¥Ό μ „μ†΅
* ν΄λΌμ΄μ–ΈνΈλ” μ΄λ―Έ DEKλ¥Ό μ•”νΈν™”ν•λ” λ° μ‚¬μ©ν• CMKλ¥Ό κ°€μ§€κ³  μμΌλ―€λ΅ DEKλ¥Ό λ³µνΈν™”ν•κ³  ν‰λ¬Έ DEKλ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤.

</details>

### **μ—΄κ±°**

AWS μ΅°μ§μ„ μΉ¨ν•΄ν•λ” μ „ν†µμ μΈ μ£Όμ” λ°©λ²• μ¤‘ ν•λ‚λ” κ³µκ°λ΅ μ•΅μ„Έμ¤ κ°€λ¥ν• λ²„ν‚·μ„ μΉ¨ν•΄ν•λ” κ²ƒμ…λ‹λ‹¤. **[μ΄ νμ΄μ§€μ—μ„ κ³µκ° λ²„ν‚· μ—΄κ±°μλ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name β€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerβ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### λ“€μ–Ό μ¤νƒ <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

κ°€μƒ νΈμ¤ν… μ¤νƒ€μΌ λλ” κ²½λ΅ μ¤νƒ€μΌ μ—”λ“ν¬μΈνΈ μ΄λ¦„μ„ μ‚¬μ©ν•μ—¬ λ“€μ–Ό μ¤νƒ μ—”λ“ν¬μΈνΈλ¥Ό ν†µν•΄ S3 λ²„ν‚·μ— μ•΅μ„Έμ¤ν•  μ μμµλ‹λ‹¤. μ΄λ” IPv6λ¥Ό ν†µν•΄ S3μ— μ•΅μ„Έμ¤ν•λ” λ° μ μ©ν•©λ‹λ‹¤.

λ“€μ–Ό μ¤νƒ μ—”λ“ν¬μΈνΈλ” λ‹¤μ κµ¬λ¬Έμ„ μ‚¬μ©ν•©λ‹λ‹¤:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### κ¶ν• μƒμΉ

λ‹¤μ νμ΄μ§€μ—μ„λ” **S3 κ¶ν•μ„ λ‚¨μ©ν•μ—¬ κ¶ν•μ„ μƒμΉ**ν•λ” λ°©λ²•μ„ ν™•μΈν•  μ μμµλ‹λ‹¤:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### μΈμ¦λμ§€ μ•μ€ μ•΅μ„Έμ¤

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 ν›„λ° μ‘μ—…

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### μ§€μ†μ„±

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## κΈ°νƒ€ S3 μ·¨μ•½μ 

### S3 HTTP μΊμ‹ λ…κ° λ¬Έμ  <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**μ΄ μ—°κµ¬μ— λ”°λ¥΄λ©΄**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue), μ„μμ λ²„ν‚·μ μ‘λ‹µμ„ λ‹¤λ¥Έ λ²„ν‚·μ κ²ƒμ²λΌ μΊμ‹ν•  μ μμ—μµλ‹λ‹¤. μ΄λ¥Ό μ•…μ©ν•μ—¬ S3λ¥Ό μ‚¬μ©ν•μ—¬ μ •μ  μ½”λ“λ¥Ό μ €μ¥ν•λ” μ„μμ νμ΄μ§€λ¥Ό λ³€κ²½ν•κ³  μΉ¨ν•΄ν•  μ μμ—μµλ‹λ‹¤.

## Amazon Athena

Amazon Athenaλ” Amazon Simple Storage Service (Amazon **S3**)μ—μ„ μ§μ ‘ λ°μ΄ν„°λ¥Ό **λ¶„μ„**ν•κΈ° μ‰½κ² ν•΄μ£Όλ” λ€ν™”ν• μΏΌλ¦¬ μ„λΉ„μ¤μ…λ‹λ‹¤. μ΄λ¥Ό μ„ν•΄ λ¨λ‹ν„°λ§λλ” S3 λ²„ν‚·μ— ν‘μ‹λ  λ‚΄μ©μ ν•μ‹μΌλ΅ κ΄€κ³„ν• DB ν…μ΄λΈ”μ„ **μ¤€λΉ„**ν•΄μ•Ό ν•©λ‹λ‹¤. κ·Έλ° λ‹¤μ Amazon Athenaλ” λ΅κ·Έμ—μ„ DBλ¥Ό μ±„μΈ μ μμΌλ―€λ΅ μΏΌλ¦¬ν•  μ μμµλ‹λ‹¤.

Amazon Athenaλ” μ΄λ―Έ μ•”νΈν™”λ S3 λ°μ΄ν„°λ¥Ό μΏΌλ¦¬ν•  μ μλ” κΈ°λ¥μ„ μ§€μ›ν•λ©°, κµ¬μ„±λμ–΄ μλ‹¤λ©΄ μΏΌλ¦¬ κ²°κ³Όλ„ μ•”νΈν™”ν•μ—¬ S3μ— μ €μ¥ν•  μ μμµλ‹λ‹¤.

**μ΄ κ²°κ³Όμ μ•”νΈν™”λ” μΏΌλ¦¬λ S3 λ°μ΄ν„°μ κΈ°λ°μ΄ λλ” μ•”νΈν™”μ™€λ” λ…λ¦½μ **μ…λ‹λ‹¤. μ¦‰, S3 λ°μ΄ν„°κ°€ μ•”νΈν™”λμ§€ μ•μ•λ”λΌλ„ μΏΌλ¦¬λ κ²°κ³Όλ” μ•”νΈν™”λ  μ μμµλ‹λ‹¤. μ•μ•„λ‘μ–΄μ•Ό ν•  λ‡ κ°€μ§€ μ‚¬ν•­μ€ Amazon Athenaκ°€ **λ‹¤μ S3 μ•”νΈν™” λ°©λ²•**(**SSE-S3, SSE-KMS λ° CSE-KMS**)μΌλ΅ μ•”νΈν™”λ λ°μ΄ν„°λ§ μ§€μ›ν•λ‹¤λ” κ²ƒμ…λ‹λ‹¤.

SSE-C λ° CSE-Eλ” μ§€μ›λμ§€ μ•μµλ‹λ‹¤. μ΄ μ™Έμ—λ„ μ¤‘μ”ν• μ μ€ Amazon Athenaκ°€ μΏΌλ¦¬ μμ²΄μ™€ λ™μΌν• λ¦¬μ „μ— μλ” **μ•”νΈν™”λ κ°μ²΄μ— λ€ν•΄μ„λ§ μΏΌλ¦¬λ¥Ό μ‹¤ν–‰**ν•λ‹¤λ” κ²ƒμ…λ‹λ‹¤. KMSλ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ S3 λ°μ΄ν„°λ¥Ό μΏΌλ¦¬ν•΄μ•Ό ν•λ” κ²½μ° Athena μ‚¬μ©μμ—κ²λ” μΏΌλ¦¬λ¥Ό μν–‰ν•  μ μλ„λ΅ νΉμ • κ¶ν•μ΄ ν•„μ”ν•©λ‹λ‹¤.

### μ—΄κ±°
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## μ°Έκ³  μλ£

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>λ¥Ό ν†µν•΄ AWS ν•΄ν‚Ήμ„ μ²μλ¶€ν„° μ „λ¬Έκ°€κΉμ§€ λ°°μ›λ³΄μ„Έμ”<strong>!</strong></summary>

HackTricksλ¥Ό μ§€μ›ν•λ” λ‹¤λ¥Έ λ°©λ²•:

* **νμ‚¬λ¥Ό HackTricksμ—μ„ κ΄‘κ³ ν•κ±°λ‚ HackTricksλ¥Ό PDFλ΅ λ‹¤μ΄λ΅λ“**ν•λ ¤λ©΄ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)λ¥Ό ν™•μΈν•μ„Έμ”!
* [**κ³µμ‹ PEASS & HackTricks μ¤μ›¨κ·Έ**](https://peass.creator-spring.com)λ¥Ό μ–»μΌμ„Έμ”.
* λ…μ μ μΈ [**NFT**](https://opensea.io/collection/the-peass-family) μ»¬λ ‰μ…μΈ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)λ¥Ό λ°κ²¬ν•μ„Έμ”.
* π’¬ [**Discord κ·Έλ£Ή**](https://discord.gg/hRep4RUj7f) λλ” [**ν…”λ κ·Έλ¨ κ·Έλ£Ή**](https://t.me/peass)μ— **μ°Έμ—¬**ν•κ±°λ‚ **Twitter** π¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)λ¥Ό **ν”λ΅μ°**ν•μ„Έμ”.
* **HackTricks**μ™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github μ €μ¥μ†μ— PRμ„ μ μ¶ν•μ—¬ μ—¬λ¬λ¶„μ ν•΄ν‚Ή κΈ°λ²•μ„ κ³µμ ν•μ„Έμ”.

</details>
