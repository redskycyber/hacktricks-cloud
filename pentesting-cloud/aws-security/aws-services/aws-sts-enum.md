# AWS - STS Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## STS

**AWS Security Token Service (STS)** ist haupts√§chlich darauf ausgelegt, **tempor√§re, eingeschr√§nkte Berechtigungen** auszustellen. Diese Berechtigungen k√∂nnen f√ºr **AWS Identity and Access Management (IAM)**-Benutzer oder f√ºr authentifizierte Benutzer (f√∂derierte Benutzer) angefordert werden.

Da STS dazu dient, **Berechtigungen f√ºr Identit√§tsimitation auszustellen**, ist der Dienst √§u√üerst wertvoll f√ºr **die Eskalation von Berechtigungen und die Aufrechterhaltung der Persistenz**, auch wenn er m√∂glicherweise nicht √ºber eine Vielzahl von Optionen verf√ºgt.

### Annahme von Rollenimitation

Die von AWS STS bereitgestellte Aktion [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) ist entscheidend, da sie einem Prinzipal erm√∂glicht, Anmeldeinformationen f√ºr einen anderen Prinzipal zu erhalten und sie im Wesentlichen zu imitieren. Bei Aufruf antwortet sie mit einer Zugriffsschl√ºssel-ID, einem geheimen Schl√ºssel und einem Sitzungstoken, das der angegebenen ARN entspricht.

F√ºr Penetrationstester oder Mitglieder des Red Teams ist diese Technik entscheidend f√ºr die Privilegieneskalation (wie hier ausf√ºhrlich erl√§utert [**hier**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)). Es ist jedoch erw√§hnenswert, dass diese Technik ziemlich offensichtlich ist und einen Angreifer m√∂glicherweise nicht √ºberrascht.

#### Annahme von Rollenlogik

Um eine Rolle im selben Konto anzunehmen, wenn die **zu √ºbernehmende Rolle speziell eine Rollen-ARN zul√§sst** wie in:

```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```

Die Rolle **`priv-role`** muss in diesem Fall **nicht explizit zugelassen** werden, um diese Rolle anzunehmen (die Erlaubnis reicht aus).

Wenn jedoch eine Rolle einem Konto das √úbernehmen gestattet, wie in:

```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```

Die Rolle, die versucht anzunehmen, wird eine **spezifische `sts:AssumeRole`-Berechtigung** √ºber diese Rolle **ben√∂tigen, um sie anzunehmen**.

Wenn Sie versuchen, eine **Rolle aus einem anderen Konto anzunehmen**, muss die **angenommene Rolle dies zulassen** (indem die Rollen-ARN oder das externe Konto angegeben werden), und die **Rolle, die versucht, sie anzunehmen**, **MUSS** die Berechtigungen haben, um dies zu tun (in diesem Fall ist dies nicht optional, auch wenn die angenommene Rolle eine ARN angibt).

### Enumeration

```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```

### Privesc

Auf der folgenden Seite k√∂nnen Sie nachschauen, wie Sie **STS-Berechtigungen missbrauchen, um Privilegien zu eskalieren**:

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
