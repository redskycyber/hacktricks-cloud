# AWS - Espelho Malicioso de VPC

<details>

<summary><strong>Apoie o HackTricks e obtenha benef칤cios!</strong></summary>

* Se voc칡 deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **칰ltima vers칚o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole칞칚o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** 游눫 [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t칠cnicas de hacking enviando PRs para os reposit칩rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

O espelhamento de tr치fego VPC **duplica o tr치fego de entrada e sa칤da para inst칙ncias EC2 dentro de uma VPC** sem a necessidade de instalar nada nas pr칩prias inst칙ncias. Esse tr치fego duplicado seria comumente enviado para algo como um sistema de detec칞칚o de intrus칚o de rede (IDS) para an치lise e monitoramento.

Com a dificuldade de inspe칞칚o geral de rede na nuvem, os pentesters recorreram a outros meios mais simples, como revisar os logs de acesso do Elastic Load Balancer. Esses logs fornecem _algo_, mas s칚o muito limitados quando comparados  inspe칞칚o completa do tr치fego de rede.

### Implanta칞칚o de um Espelho Malicioso com Credenciais AWS Comprometidas

칄 importante observar que o **Espelhamento de Tr치fego VPC** 칠 suportado apenas por tipos de inst칙ncia **EC2** que s칚o alimentados pelo [**sistema AWS Nitro**](https://aws.amazon.com/ec2/nitro/) e que o **alvo do espelho VPC deve estar na mesma VPC** que qualquer host que esteja sendo espelhado.

Nas pr칩ximas se칞칫es, abordaremos como o malmirror funciona, o que ele faz e como analisar os dados exfiltrados. O script em si pode ser [encontrado em nosso GitHub aqui](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### Como o malmirror funciona

O malmirror implanta os seguintes recursos em uma conta:

* Uma inst칙ncia EC2 para espelhar o tr치fego
* Um grupo de seguran칞a EC2 para essa inst칙ncia EC2
* Um alvo de espelho VPC, apontando para a inst칙ncia EC2 criada
* Um filtro de espelho VPC que est치 configurado para espelhar todo o tr치fego
* Uma sess칚o de espelho VPC para cada inst칙ncia EC2 suportada na conta

![](<../../../../.gitbook/assets/image (72).png>)

Depois que tudo 칠 implantado, **o tr치fego come칞ar치 a ser espelhado para a inst칙ncia EC2 que foi criada**. A inst칙ncia EC2 come칞ar치 a ouvir e registrar todo o tr치fego de rede espelhado que recebe no formato PCAP. Ap칩s cerca de **100 MB de dados armazenados localmente na inst칙ncia**, ele automaticamente **exfiltrar치 esses dados para um bucket S3** de sua escolha (provavelmente em sua **pr칩pria conta AWS**) e **excluir치 o arquivo local** do sistema. Isso impede que a inst칙ncia fique sem espa칞o e nos permite exfiltrar o tr치fego espelhado de forma automatizada. Observe que o limite de 100 MB 칠 arbitr치rio e pode ser muito pequeno para algumas redes onde h치 uma maior quantidade de tr치fego fluindo por ela. O tr치fego 칠 exfiltrado dessa maneira porque n칚o parecia haver uma maneira f치cil de espelhar o tr치fego entre contas e isso parecia uma maneira confi치vel de garantir que os dados saiam do ambiente.

 medida que o tr치fego est치 sendo exfiltrado para o seu bucket S3, voc칡 pode baix치-lo localmente para an치lise. Uma maneira simples de fazer isso seria com o [comando S3 "Sync" oferecido pelo AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) para que voc칡 baixe apenas os dados que est치 faltando desde a 칰ltima vez que sincronizou com o bucket. 

<details>

<summary><strong>Apoie o HackTricks e obtenha benef칤cios!</strong></summary>

* Se voc칡 deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **칰ltima vers칚o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole칞칚o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** 游눫 [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t칠cnicas de hacking enviando PRs para os reposit칩rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>