# AWS - Post-Explotaci贸n de SSM

<details>

<summary><strong>Aprende hacking de AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## MitM SSM

### Interceptar Mensajes de SSM Enviados a una Instancia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Con **acceso a las credenciales IAM de una instancia EC2**, puedes interceptar mensajes de EC2 y sesiones de SSM debido al manejo de autenticaci贸n de SSM.

El [**Agente de SSM**](https://github.com/aws/amazon-ssm-agent) llama continuamente a **`ec2messages:GetMessages`**, manteniendo la **conexi贸n abierta** durante **20 segundos**. Si se env铆a un mensaje, como a trav茅s de [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), se recibe a trav茅s de esta conexi贸n abierta.

Un **atacante** puede interceptar mensajes de EC2 llamando a **`ec2messages:GetMessages`** con m谩s frecuencia. Este [**prueba de concepto**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) demuestra esto escuchando mensajes de send-command. El atacante tambi茅n puede **enviar cualquier respuesta** que desee a los mensajes.

El atacante tambi茅n podr铆a **enviar cualquier respuesta** que desee a los mensajes.

### Interceptar Mensajes de Sesi贸n de SSM

Esto es m谩s complejo, involucra m煤ltiples conexiones WebSocket y un protocolo binario 煤nico. Cuando el **Agente de SSM se inicia**, **crea** una conexi贸n **WebSocket** con AWS. Cuando un usuario inicia una sesi贸n de SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), el **canal de control inicia un canal de datos** para la comunicaci贸n entre el usuario y la instancia EC2.

El c贸digo fuente del Agente de SSM, disponible [aqu铆](https://github.com/aws/amazon-ssm-agent), puede usarse para crear los mensajes en el formato binario, como [esto](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar Sesiones de SSM es m谩s fiable que los mensajes de EC2** ya que los **canales de control son de larga duraci贸n** y AWS solo se comunica con el **m谩s reciente**. Esta [prueba de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) muestra c贸mo crear un canal de control e interactuar con la sesi贸n.

Desde una perspectiva de abuso, **interceptar Sesiones de SSM es m谩s fiable que los mensajes de EC2**. La raz贸n de esto es que los **canales de control son de larga duraci贸n**, y al igual que con los mensajes de EC2, AWS solo se comunicar谩 con el **m谩s reciente**. Como resultado, podemos crear nuestro propio canal de control y escuchar las sesiones entrantes. Usando el c贸digo fuente del Agente de SSM, podemos crear los mensajes en el formato binario (si miras la [prueba de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), notar谩s que he traducido literalmente el Go a Python), e interactuar con la sesi贸n.

Tambi茅n es posible robar comandos (**informaci贸n sensible**) y suministrar la salida del atacante.

## Referencias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Aprende hacking de AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
