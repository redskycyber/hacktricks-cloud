# AWS - Post-Explotaci贸n de SSM

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## MitM SSM

### MitM Mensajes SSM enviados a una instancia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Con **acceso a las credenciales IAM de una instancia EC2**, se pueden interceptar los mensajes de EC2 y las sesiones de SSM debido al manejo de autenticaci贸n de SSM.

El [**Agente SSM**](https://github.com/aws/amazon-ssm-agent) llama continuamente a **`ec2messages:GetMessages`**, manteniendo la **conexi贸n abierta** durante **20 segundos**. Si se env铆a un mensaje, como a trav茅s de [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), se recibe a trav茅s de esta conexi贸n abierta.

Un **atacante** puede interceptar los mensajes de EC2 llamando a **`ec2messages:GetMessages`** con m谩s frecuencia. Este [**ejemplo de concepto**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) lo demuestra escuchando los mensajes de env铆o de comandos. El atacante tambi茅n puede **enviar cualquier respuesta** que desee a los mensajes.

El atacante tambi茅n podr铆a **enviar cualquier respuesta** que desee a los mensajes.

### MitM Mensajes de Sesi贸n SSM

Esto es m谩s complejo, involucrando m煤ltiples conexiones WebSocket y un protocolo binario 煤nico. Cuando el **Agente SSM se inicia**, crea una **conexi贸n WebSocket** a AWS. Cuando un usuario inicia una sesi贸n de SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), el **canal de control inicia un canal de datos** para la comunicaci贸n entre el usuario y la instancia EC2.

El c贸digo fuente del Agente SSM, disponible [aqu铆](https://github.com/aws/amazon-ssm-agent), se puede utilizar para crear los mensajes en el formato binario, como [este](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar las sesiones de SSM es m谩s confiable que los mensajes de EC2** ya que los **canales de control son de larga duraci贸n** y AWS solo se comunica con el **m谩s nuevo**. Este [ejemplo de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) muestra c贸mo crear un canal de control e interactuar con la sesi贸n.

Desde una perspectiva de abuso, **interceptar las sesiones de SSM es m谩s confiable que los mensajes de EC2**. La raz贸n de esto es que los **canales de control son de larga duraci贸n**, y al igual que con los mensajes de EC2, AWS solo se comunica con el **m谩s nuevo**. Como resultado, podemos crear nuestro propio canal de control y escuchar las sesiones entrantes. Usando el c贸digo fuente del Agente SSM, podemos crear los mensajes en el formato binario (si miras el [ejemplo de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), notar谩s que literalmente he traducido el c贸digo de Go a Python) e interactuar con la sesi贸n.

Tambi茅n es posible robar comandos (**informaci贸n sensible**) y proporcionar la salida de los atacantes.

## Referencias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>