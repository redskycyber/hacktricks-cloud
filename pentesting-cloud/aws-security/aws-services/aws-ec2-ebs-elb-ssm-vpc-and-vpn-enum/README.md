# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## VPC y Networking

Aprende qu칠 es una VPC y acerca de sus componentes en:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Puedes usar Amazon EC2 para lanzar **servidores virtuales**, configurar **seguridad** y **redes**, y gestionar **almacenamiento**. Amazon EC2 te permite escalar hacia arriba o hacia abajo para manejar cambios en los requisitos o picos de popularidad, reduciendo la necesidad de prever el tr치fico.

Cosas interesantes para enumerar en EC2:

* M치quinas virtuales
* Claves SSH
* Datos de usuario
* EC2s/AMIs/Snapshots existentes
* Redes
* Subredes
* IPs p칰blicas
* Puertos abiertos
* Conexiones integradas con otras redes fuera de AWS

### Perfiles de instancia

El uso de **roles** para otorgar permisos a las aplicaciones que se ejecutan en las **instancias EC2** requiere una configuraci칩n adicional. Una aplicaci칩n que se ejecuta en una instancia EC2 est치 abstracta de AWS por el sistema operativo virtualizado. Debido a esta separaci칩n adicional, necesitas un paso adicional para asignar un rol de AWS y sus permisos asociados a una instancia EC2 y hacerlos disponibles para sus aplicaciones.

Este paso adicional es la **creaci칩n de un** [_**perfil de instancia**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) adjunto a la instancia. El **perfil de instancia contiene el rol y** puede proporcionar las credenciales temporales del rol a una aplicaci칩n que se ejecuta en la instancia. Estas credenciales temporales luego se pueden utilizar en las llamadas de API de la aplicaci칩n para acceder a recursos y limitar el acceso solo a aquellos recursos que el rol especifica. Ten en cuenta que **solo se puede asignar un rol a una instancia EC2** a la vez, y todas las aplicaciones en la instancia comparten el mismo rol y permisos.

### Punto de conexi칩n de metadatos

Los metadatos de AWS EC2 son informaci칩n sobre una instancia de Amazon Elastic Compute Cloud (EC2) que est치 disponible para la instancia en tiempo de ejecuci칩n. Estos metadatos se utilizan para proporcionar informaci칩n sobre la instancia, como su ID de instancia, la zona de disponibilidad en la que se est치 ejecutando, el rol IAM asociado a la instancia y el nombre de host de la instancia.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeraci칩n
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acceso no autenticado

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Escalada de privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de EC2 para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Explotaci칩n

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Las **instant치neas de Amazon EBS** (Elastic Block Store) son b치sicamente **copias de seguridad est치ticas** de los vol칰menes de AWS EBS. En otras palabras, son **copias** de los **discos** adjuntos a una **instancia EC2** en un momento espec칤fico. Las instant치neas de EBS se pueden copiar entre regiones y cuentas, o incluso descargar y ejecutar localmente.

Las instant치neas pueden contener **informaci칩n sensible** como **c칩digo fuente o claves de API**, por lo tanto, si tienes la oportunidad, se recomienda verificarlas.

### Diferencia entre AMI y EBS

Una **AMI** se utiliza para **lanzar una instancia EC2**, mientras que una **instant치nea EC2** se utiliza para **hacer copias de seguridad y recuperar datos almacenados en un volumen EBS**. Si bien una instant치nea EC2 se puede utilizar para crear una nueva AMI, no es lo mismo que una AMI y no incluye informaci칩n sobre el sistema operativo, el servidor de aplicaciones u otro software necesario para ejecutar una aplicaci칩n.

### Escalada de privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de EBS para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permite administrar de forma remota flotas de instancias EC2 para facilitar su administraci칩n. Cada una de estas instancias debe tener en ejecuci칩n el servicio **SSM Agent**, ya que ser치 el encargado de recibir las acciones y ejecutarlas desde la API de AWS.

El **SSM Agent** permite que Systems Manager actualice, administre y configure estos recursos. El agente **procesa las solicitudes del servicio Systems Manager en la nube de AWS** y luego las ejecuta seg칰n lo especificado en la solicitud.

El **SSM Agent viene** [**preinstalado en algunas AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) o debes [**instalarlo manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) en las instancias. Adem치s, el rol IAM utilizado dentro de la instancia debe tener la pol칤tica **AmazonEC2RoleforSSM** adjunta para poder comunicarse.

### Enumeraci칩n
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Puedes verificar si Systems Manager est치 en ejecuci칩n en una instancia EC2 simplemente ejecutando:
```bash
ps aux | grep amazon-ssm
```
### Privesc

En la siguiente p치gina puedes verificar c칩mo **abusar los permisos de SSM para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Explotaci칩n

T칠cnicas como la interceptaci칩n de mensajes de SSM se pueden encontrar en la p치gina de post-explotaci칩n de SSM:

{% content-ref url="aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](aws-ssm-post-exploitation.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) es un servicio de **balanceo de carga para implementaciones de Amazon Web Services** (AWS). ELB distribuye autom치ticamente el **tr치fico de aplicaciones entrante** y escala los recursos para satisfacer las demandas de tr치fico.

### Enumeraci칩n
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Plantillas de lanzamiento y grupos de escalado autom치tico

### Enumeraci칩n

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
