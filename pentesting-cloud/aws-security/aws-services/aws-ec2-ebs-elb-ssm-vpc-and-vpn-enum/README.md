# AWS - Enumeraci贸n de EC2, EBS, ELB, SSM, VPC y VPN

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## VPC y Networking

Aprende qu茅 es una VPC y sobre sus componentes en:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Puedes usar Amazon EC2 para lanzar **servidores virtuales**, configurar **seguridad** y **redes**, y administrar **almacenamiento**. Amazon EC2 te permite escalar hacia arriba o hacia abajo para manejar cambios en los requisitos o picos de popularidad, reduciendo tu necesidad de prever el tr谩fico.

Cosas interesantes para enumerar en EC2:

* M谩quinas virtuales
  * Claves SSH
  * Datos de usuario
  * EC2s/AMIs/Snapshots existentes
* Redes
  * Redes
  * Subredes
  * IPs p煤blicas
  * Puertos abiertos
* Conexiones integradas con otras redes fuera de AWS

### Perfiles de instancia

El uso de **roles** para otorgar permisos a las aplicaciones que se ejecutan en las **instancias EC2** requiere un poco de configuraci贸n adicional. Una aplicaci贸n que se ejecuta en una instancia EC2 est谩 abstracta de AWS por el sistema operativo virtualizado. Debido a esta separaci贸n adicional, necesitas un paso adicional para asignar un rol de AWS y sus permisos asociados a una instancia EC2 y hacerlos disponibles para sus aplicaciones.

Este paso adicional es la **creaci贸n de un** [_**perfil de instancia**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) adjunto a la instancia. El **perfil de instancia contiene el rol y** puede proporcionar las credenciales temporales del rol a una aplicaci贸n que se ejecuta en la instancia. Esas credenciales temporales pueden ser utilizadas en las llamadas de API de la aplicaci贸n para acceder a recursos y para limitar el acceso s贸lo a aquellos recursos que el rol especifica. Ten en cuenta que **s贸lo se puede asignar un rol a una instancia EC2** a la vez, y todas las aplicaciones en la instancia comparten el mismo rol y permisos.

### Punto de conexi贸n de metadatos

Los metadatos de AWS EC2 son informaci贸n sobre una instancia de Amazon Elastic Compute Cloud (EC2) que est谩 disponible para la instancia en tiempo de ejecuci贸n. Estos metadatos se utilizan para proporcionar informaci贸n sobre la instancia, como su ID de instancia, la zona de disponibilidad en la que se est谩 ejecutando, el rol IAM asociado a la instancia y el nombre de host de la instancia.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeraci贸n

```bash
# Obtener instancias EC2
aws ec2 describe-instances
aws ec2 describe-instance-status #Obtener estado de las instancias en ejecuci贸n

# Obtener datos de usuario de cada instancia EC2
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
  echo "ID de instancia: $instanceid"
  aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
  echo ""
  echo "-------------------"
done

# Perfiles de instancia
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Obtener etiquetas
aws ec2 describe-tags

# Obtener vol煤menes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Obtener snapshots
aws ec2 describe-snapshots --owner-ids self

# Instancias programadas
aws ec2 describe-scheduled-instances

# Obtener im谩genes personalizadas
aws ec2 describe-images --owners self 

# Obtener IPs el谩sticas
aws ec2 describe-addresses

# Obtener salida actual
aws ec2 get-console-output --instance-id [id]

# Obtener gateways de clientes VPN
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections 

# Listar tareas de conversi贸n para subir/descargar VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Obtener tareas de paquete
aws ec2 describe-bundle-tasks

# Obtener instancias cl谩sicas
aws ec2 describe-classic-link-instances

# Obtener hosts dedicados
aws ec2 describe-hosts

# Obtener pares de claves SSH
aws ec2 describe-key-pairs

# Obtener gateways de Internet
aws ec2 describe-internet-gateways

# Obtener gateways NAT
aws ec2 describe-nat-gateways 

# Obtener subredes
aws ec2 describe-subnets

# Obtener reglas de FW
aws ec2 describe-network-acls

# Obtener grupos de seguridad
aws ec2 describe-security-groups

# Obtener interfaces
aws ec2 describe-network-interfaces

# Obtener tablas de rutas
aws ec2 describe-route-tables

# Obtener VPCs
aws ec2 describe-vpcs 
aws ec2 describe-vpc-peering-connections
```

### Privesc

En la siguiente p谩gina puedes comprobar c贸mo **abuso de los permisos de EC2 para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Acceso no autenticado

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-Explotaci贸n

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pent
### Enumeraci贸n

```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```

Puede verificar en una instancia EC2 si Systems Manager se est谩 ejecutando simplemente ejecutando:

```bash
ps aux | grep amazon-ssm
```

### Privesc

En la siguiente p谩gina puede verificar c贸mo **abuso de permisos de SSM para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Explotaci贸n

T茅cnicas como la interceptaci贸n de mensajes SSM se pueden encontrar en la p谩gina de post-explotaci贸n de SSM:

{% content-ref url="aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](aws-ssm-post-exploitation.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) es un servicio de **balanceo de carga para implementaciones de Amazon Web Services** (AWS). ELB distribuye autom谩ticamente el **tr谩fico de la aplicaci贸n entrante** y escala los recursos para satisfacer las demandas de tr谩fico.

<figure><img src="https://lh6.googleusercontent.com/cRBL0xfhe4VRn6PU0Bs_NPx937HqgdYxYNkRAh0WmQFfVZfyYg6X1rhpJwmVIQXIEeepQcUoJipsdH-qmacm8Dw49H539e2ygb2A5hQWGjMh_SAEHOfhygtTLINR2h5l6p4NiiMMO7g0LTZiFpdBB9IeEA=s2048" alt=""><figcaption></figcaption></figure>

### Enumeraci贸n

```bash
# Listar ELBs que dan acceso a internet
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# NO OLVIDE VERIFICAR LA VERSIN 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```

## Plantillas de lanzamiento y grupos de escalado autom谩tico

### Enumeraci贸n

{% code overflow="wrap" %}
```bash
# Plantillas de lanzamiento
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Obtener detalles, como datos de usuario
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Escalado autom谩tico
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>