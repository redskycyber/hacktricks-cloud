# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## VPC & Sieciowanie

Dowiedz si, czym jest VPC i o jego skadnikach w:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 jest wykorzystywany do uruchamiania **serwer贸w wirtualnych**. Umo偶liwia konfiguracj **bezpieczestwa** i **sieci** oraz zarzdzanie **przechowywaniem danych**. Elastyczno Amazon EC2 objawia si w mo偶liwoci skalowania zasob贸w zar贸wno w g贸r, jak i w d贸, dostosowujc si skutecznie do zmian wymaga lub wzrostu popularnoci. Ta funkcja zmniejsza konieczno precyzyjnych prognoz dotyczcych ruchu.

Interesujce rzeczy do wyliczenia w EC2:

* Maszyny wirtualne
* Klucze SSH
* Dane u偶ytkownika
* Istniejce EC2/AMI/Snapshots
* Sieciowanie
* Sieci
* Podsieci
* Publiczne adresy IP
* Otwarte porty
* Zintegrowane poczenia z innymi sieciami poza AWS

### Profile instancji

U偶ycie **r贸l** do nadawania uprawnie aplikacjom uruchamianym na **instancjach EC2** wymaga nieco dodatkowej konfiguracji. Aplikacja uruchamiana na instancji EC2 jest abstrahowana od AWS przez zvirtualizowany system operacyjny. Ze wzgldu na to dodatkowe oddzielenie, konieczny jest dodatkowy krok polegajcy na przypisaniu roli AWS i jej powizanych uprawnie do instancji EC2 oraz udostpnieniu ich aplikacjom.

Ten dodatkowy krok to **utworzenie** [_**profilu instancji**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) przypisanego do instancji. **Profil instancji zawiera rol** i mo偶e dostarczy tymczasowe powiadczenia roli do aplikacji uruchamianej na instancji. Te tymczasowe powiadczenia mog by nastpnie u偶ywane w wywoaniach interfejsu API aplikacji do dostpu do zasob贸w i ograniczenia dostpu tylko do tych zasob贸w, kt贸re okrela rola. Zauwa偶, 偶e **tylko jedna rola mo偶e by przypisana do instancji EC2** w danym czasie, a wszystkie aplikacje na instancji dziel t sam rol i uprawnienia.

### Punkt kocowy metadanych

Metadane AWS EC2 to informacje o instancji Amazon Elastic Compute Cloud (EC2), kt贸re s dostpne dla instancji w czasie wykonywania. Metadane te su偶 do dostarczania informacji o instancji, takich jak jej identyfikator instancji, strefa dostpnoci, w kt贸rej dziaa, rola IAM przypisana do instancji i nazwa hosta instancji.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Wyliczanie
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Nieuwierzytelniony dostp

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnie EC2 do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** to po prostu statyczne **kopie zapasowe** wolumin贸w AWS EBS. Innymi sowy, s to **kopie** **dysk贸w** podczonych do instancji **EC2** w okrelonym momencie. Snapshots EBS mo偶na kopiowa midzy regionami i kontami, a nawet pobra i uruchomi lokalnie.

Snapshots mog zawiera **czue informacje**, takie jak **kod 藕r贸dowy lub klucze API**, dlatego jeli masz okazj, zaleca si ich sprawdzenie.

### R贸偶nica midzy AMI a EBS

**AMI** su偶y do **uruchamiania instancji EC2**, podczas gdy **Snapshot EC2** su偶y do **tworzenia kopii zapasowych i odzyskiwania danych przechowywanych na woluminie EBS**. Chocia偶 Snapshot EC2 mo偶na u偶y do utworzenia nowego AMI, nie jest to to samo co AMI i nie zawiera informacji o systemie operacyjnym, serwerze aplikacyjnym ani innych niezbdnych oprogramowaniach do uruchomienia aplikacji.

### Eskalacja uprawnie

Na nastpnej stronie mo偶esz sprawdzi, jak **nadu偶y uprawnie EBS do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** pozwala na zdalne zarzdzanie grupami instancji EC2, co uatwia ich administracj. Ka偶da z tych instancji musi dziaa z usug **SSM Agent, poniewa偶 to ona otrzymuje dziaania i wykonuje je** z API AWS.

**SSM Agent** umo偶liwia Systems Manager aktualizowanie, zarzdzanie i konfigurowanie tych zasob贸w. Agent **przetwarza 偶dania z usugi Systems Manager w chmurze AWS**, a nastpnie wykonuje je zgodnie z 偶daniem.

**SSM Agent jest** [**zainstalowany domylnie w niekt贸rych AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) lub musisz [**zainstalowa go rcznie**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancjach. Ponadto rola IAM u偶ywana wewntrz instancji musi mie przypisan polis **AmazonEC2RoleforSSM**, aby m贸c si komunikowa.

### Wyliczanie
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Mo偶esz sprawdzi na instancji EC2, czy Systems Manager dziaa, wykonujc:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Na nastpnej stronie mo偶esz sprawdzi, jak **wykorzysta uprawnienia SSM do eskalacji uprawnie**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Persistence



## ELB

**Elastic Load Balancing** (ELB) to **usuga balansowania obci偶enia dla wdro偶e Amazon Web Services** (AWS). ELB automatycznie **rozdziela przychodzcy ruch aplikacji** i skaluje zasoby, aby sprosta wymaganiom ruchu.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Szablony uruchamiania i grupy automatycznego skalowania

### Wyliczanie

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN pozwala na poczenie twojej **sieci lokalnej (VPN typu site-to-site)** lub **laptop贸w pracownik贸w (VPN klienta)** z **AWS VPC**, dziki czemu usugi mog by dostpne bez koniecznoci ich wystawiania w internecie.

#### Podstawowe skadniki AWS VPN

1. **Bramka klienta**:
* Bramka klienta to zas贸b, kt贸ry tworzysz w AWS, aby reprezentowa twoj stron poczenia VPN.
* Jest to w zasadzie fizyczne urzdzenie lub aplikacja oprogramowania po twojej stronie poczenia VPN typu site-to-site.
* Udostpniasz informacje o trasowaniu i publiczny adres IP urzdzenia sieciowego (takiego jak router lub zapora ogniowa) AWS, aby utworzy bramk klienta.
* Su偶y jako punkt odniesienia do konfiguracji poczenia VPN i nie generuje dodatkowych opat.
2. **Wirtualna bramka prywatna**:
* Wirtualna bramka prywatna (VPG) to koncentrator VPN po stronie Amazona w poczeniu VPN typu site-to-site.
* Jest doczona do twojego VPC i su偶y jako cel twojego poczenia VPN.
* VPG to punkt kocowy po stronie AWS dla poczenia VPN.
* Obsuguje bezpieczn komunikacj midzy twoim VPC a twoj sieci lokaln.
3. **Poczenie VPN typu site-to-site**:
* Poczenie VPN typu site-to-site czy twoj sie lokaln z VPC poprzez bezpieczny tunel VPN IPsec.
* Ten rodzaj poczenia wymaga bramki klienta i wirtualnej bramki prywatnej.
* Jest u偶ywane do bezpiecznej, stabilnej i sp贸jnej komunikacji midzy twoim centrum danych lub sieci a rodowiskiem AWS.
* Zazwyczaj stosowane do regularnych, dugoterminowych pocze i rozliczane na podstawie iloci przesyanych danych przez poczenie.
4. **Punkt kocowy VPN klienta**:
* Punkt kocowy VPN klienta to zas贸b, kt贸ry tworzysz w AWS, aby umo偶liwi i zarzdza sesjami VPN klienta.
* Su偶y do umo偶liwienia indywidualnym urzdzeniom (takim jak laptopy, smartfony itp.) bezpiecznego poczenia z zasobami AWS lub twoj sieci lokaln.
* R贸偶ni si od VPN typu site-to-site tym, 偶e jest przeznaczony dla indywidualnych klient贸w, a nie do czenia caych sieci.
* W przypadku VPN klienta ka偶de urzdzenie klienta u偶ywa oprogramowania klienta VPN do nawizania bezpiecznego poczenia.

Mo偶esz [**znale藕 wicej informacji na temat korzyci i skadnik贸w VPN AWS tutaj**](aws-vpc-and-networking-basic-information.md#vpn).

### Wyliczanie
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalne wyliczenie

**Tymczasowe powiadczenia lokalne**

Kiedy klient VPN AWS jest u偶ywany do poczenia z VPN, u偶ytkownik zazwyczaj **loguje si do AWS**, aby uzyska dostp do VPN. Nastpnie lokalnie tworzone s i przechowywane **powiadczenia AWS** do nawizania poczenia VPN. Te powiadczenia s **przechowywane w** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i zawieraj **klucz dostpu**, **klucz prywatny** i **token**.

Powiadczenia nale偶 do u偶ytkownika `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: zbadaj wicej na temat uprawnie tych powiadcze).

**Pliki konfiguracyjne opvn**

Jeli **poczenie VPN zostao nawizane**, nale偶y wyszuka pliki konfiguracyjne **`.opvn`** w systemie. Ponadto, jednym miejscem, gdzie mo偶na znale藕 **konfiguracje**, jest **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Eksploatacja po**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Odnoniki

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
