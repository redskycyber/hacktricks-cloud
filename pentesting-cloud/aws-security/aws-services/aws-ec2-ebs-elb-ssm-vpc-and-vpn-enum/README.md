# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## VPC & MreÅ¾a

Saznajte Å¡ta je VPC i o njegovim komponentama u:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 se koristi za pokretanje **virtuelnih servera**. OmoguÄ‡ava konfiguraciju **bezbednosti** i **mreÅ¾e** i upravljanje **skladiÅ¡tenjem**. Fleksibilnost Amazon EC2 je oÄigledna u njegovoj sposobnosti skaliranja resursa kako na gore, tako i na dole, efikasno se prilagoÄ‘avajuÄ‡i promenama zahteva ili porastu popularnosti. Ova funkcija smanjuje potrebu za preciznim predviÄ‘anjima saobraÄ‡aja.

Interesantne stvari za enumeraciju u EC2:

* Virtuelne maÅ¡ine
* SSH kljuÄevi
* KorisniÄki podaci
* PostojeÄ‡i EC2/AMI/Snimci
* MreÅ¾a
* MreÅ¾e
* PodmreÅ¾e
* Javne IP adrese
* Otvoreni portovi
* Integrisane veze sa drugim mreÅ¾ama van AWS-a

### Profili Instanci

KoriÅ¡Ä‡enje **uloga** za dodeljivanje dozvola aplikacijama koje se izvrÅ¡avaju na **EC2 instancama** zahteva malo dodatne konfiguracije. Aplikacija koja se izvrÅ¡ava na EC2 instanci je apstrahovana od AWS-a od strane virtualizovanog operativnog sistema. Zbog ove dodatne separacije, potreban je dodatni korak za dodelu AWS uloge i pripadajuÄ‡ih dozvola EC2 instanci i omoguÄ‡avanje njihovim aplikacijama.

Ovaj dodatni korak je **kreiranje** [_**profila instance**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) koji je priloÅ¾en instanci. **Profil instance sadrÅ¾i ulogu i** moÅ¾e obezbediti privremene akreditive uloge aplikaciji koja se izvrÅ¡ava na instanci. Ti privremeni akreditivi mogu se zatim koristiti u API pozivima aplikacije za pristup resursima i ograniÄavanje pristupa samo onim resursima koje uloga specificira. Imajte na umu da se **samo jedna uloga moÅ¾e dodeliti EC2 instanci** u isto vreme, i sve aplikacije na instanci dele istu ulogu i dozvole.

### Krajnja taÄka metapodataka

AWS EC2 metapodaci su informacije o instanci Amazon Elastic Compute Cloud (EC2) koje su dostupne instanci tokom izvrÅ¡avanja. Ovi metapodaci se koriste za pruÅ¾anje informacija o instanci, kao Å¡to su ID instance, zona dostupnosti u kojoj se izvrÅ¡ava, IAM uloga povezana sa instancom i ime hosta instance.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeracija
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Neautentifikovan pristup

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Na sledeÄ‡oj stranici moÅ¾ete proveriti kako **zloupotrebiti EC2 dozvole radi eskalacije privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** su u osnovi statiÄke **rezerve** AWS EBS zapisa. Drugim reÄima, to su **kopije** **diskova** prikaÄenih na **EC2** instancu u odreÄ‘enom trenutku. EBS snimci mogu biti kopirani izmeÄ‘u regiona i naloga, ili Äak preuzeti i pokrenuti lokalno.

Snimci mogu sadrÅ¾ati **osetljive informacije** kao Å¡to su **izvorni kod ili API kljuÄevi**, stoga, ako imate priliku, preporuÄuje se da ih proverite.

### Razlika izmeÄ‘u AMI i EBS

**AMI** se koristi za **pokretanje EC2 instance**, dok se EC2 **Snapshot** koristi za **rezervno kopiranje i vraÄ‡anje podataka saÄuvanih na EBS zapisi**. Iako se EC2 Snapshot moÅ¾e koristiti za kreiranje nove AMI, to nije isto kao AMI, i ne ukljuÄuje informacije o operativnom sistemu, serverskom aplikacijom ili drugom softveru potrebnom za pokretanje aplikacije.

### Privesc

Na sledeÄ‡oj stranici moÅ¾ete proveriti kako **zloupotrebiti EBS dozvole radi eskalacije privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** omoguÄ‡ava daljinsko upravljanje grupama EC2 instanci kako bi njihova administracija bila mnogo lakÅ¡a. Svaka od ovih instanci mora imati pokrenutu **SSM Agent uslugu jer Ä‡e ta usluga primati radnje i izvrÅ¡avati ih** putem AWS API.

**SSM Agent** omoguÄ‡ava Systems Manager-u da aÅ¾urira, upravlja i konfiguriÅ¡e ove resurse. Agent **obrÄ‘uje zahteve od Systems Manager servisa u AWS oblaku**, a zatim ih pokreÄ‡e kako je navedeno u zahtevu.

**SSM Agent dolazi**[ **predinstaliran u nekim AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ili ga trebate [**ruÄno instalirati**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancama. TakoÄ‘e, IAM uloga koriÅ¡Ä‡ena unutar instance mora imati politiku **AmazonEC2RoleforSSM** priloÅ¾enu kako bi mogla komunicirati.

### Enumeracija
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
MoÅ¾ete proveriti da li je Systems Manager pokrenut na EC2 instanci jednostavno izvrÅ¡avanjem:
```bash
ps aux | grep amazon-ssm
```
### PoveÄ‡anje privilegija

Na sledeÄ‡oj stranici moÅ¾ete proveriti kako **zloupotrebiti dozvole SSM-a za poveÄ‡anje privilegija**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Upornost



## ELB

**Elastic Load Balancing** (ELB) je **usluga balansiranja optereÄ‡enja za Amazon Web Services** (AWS) implementacije. ELB automatski **distribuira dolazni saobraÄ‡aj aplikacija** i skalira resurse kako bi zadovoljio zahteve saobraÄ‡aja.

### Enumeracija
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Å abloni za pokretanje & Grupi automatskog skaliranja

### Nabrojavanje

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN omoguÄ‡ava povezivanje vaÅ¡e **on-premise mreÅ¾e (site-to-site VPN)** ili **laptopova radnika (Client VPN)** sa **AWS VPC**-om tako da usluge mogu biti pristupljene bez potrebe da se izlaÅ¾u internetu.

#### Osnovni AWS VPN Komponente

1. **Customer Gateway**:
* Customer Gateway je resurs koji kreirate u AWS-u da predstavlja vaÅ¡u stranu VPN veze.
* To je suÅ¡tinski fiziÄki ureÄ‘aj ili softverska aplikacija na vaÅ¡oj strani Site-to-Site VPN veze.
* PrilaÅ¾ete rutinske informacije i javnu IP adresu vaÅ¡eg mreÅ¾nog ureÄ‘aja (kao Å¡to je ruter ili firewall) AWS-u da biste kreirali Customer Gateway.
* SluÅ¾i kao referentna taÄka za postavljanje VPN veze i ne generiÅ¡e dodatne troÅ¡kove.
2. **Virtual Private Gateway**:
* Virtual Private Gateway (VPG) je VPN koncentrator na Amazon strani Site-to-Site VPN veze.
* Povezan je sa vaÅ¡im VPC-om i sluÅ¾i kao cilj za vaÅ¡u VPN vezu.
* VPG je AWS strana krajnja taÄka za VPN vezu.
* Obradjuje sigurnu komunikaciju izmeÄ‘u vaÅ¡eg VPC-a i vaÅ¡e on-premise mreÅ¾e.
3. **Site-to-Site VPN Connection**:
* Site-to-Site VPN veza povezuje vaÅ¡u on-premise mreÅ¾u sa VPC-om putem sigurnog, IPsec VPN tunela.
* Ovaj tip veze zahteva Customer Gateway i Virtual Private Gateway.
* Koristi se za sigurnu, stabilnu i konzistentnu komunikaciju izmeÄ‘u vaÅ¡eg data centra ili mreÅ¾e i vaÅ¡eg AWS okruÅ¾enja.
* ObiÄno se koristi za redovne, dugoroÄne veze i naplaÄ‡uje se na osnovu koliÄine prenetih podataka preko veze.
4. **Client VPN Endpoint**:
* Client VPN endpoint je resurs koji kreirate u AWS-u da omoguÄ‡ite i upravljate sesijama klijentskog VPN-a.
* Koristi se za omoguÄ‡avanje pojedinaÄnim ureÄ‘ajima (kao Å¡to su laptopovi, pametni telefoni, itd.) sigurno povezivanje sa AWS resursima ili vaÅ¡om on-premise mreÅ¾om.
* Razlikuje se od Site-to-Site VPN-a po tome Å¡to je dizajniran za pojedinaÄne klijente umesto za povezivanje celih mreÅ¾a.
* Sa Client VPN-om, svaki klijentski ureÄ‘aj koristi VPN klijentski softver za uspostavljanje sigurne veze.

MoÅ¾ete [**pronaÄ‡i viÅ¡e informacija o prednostima i komponentama AWS VPN-ova ovde**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeracija
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalna enumeracija

**Privremene lokalne akreditacije**

Kada se koristi AWS VPN klijent za povezivanje na VPN, korisnik obiÄno **se prijavljuje u AWS** da bi dobio pristup VPN-u. Zatim se neke **AWS akreditacije kreiraju i Äuvaju** lokalno kako bi se uspostavila VPN veza. Ove akreditacije se **Äuvaju u** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i sadrÅ¾e **Pristupni kljuÄ**, **Tajni kljuÄ** i **Token**.

Akreditacije pripadaju korisniku `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: istraÅ¾iti viÅ¡e o dozvolama ovih akreditacija).

**opvn konfiguracione datoteke**

Ako je **VPN veza uspostavljena**, trebalo bi da potraÅ¾ite **`.opvn`** konfiguracione datoteke u sistemu. TakoÄ‘e, jedno mesto gde biste mogli pronaÄ‡i **konfiguracije** je u **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post eksploatacija**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>NauÄite hakovanje AWS-a od poÄetnika do struÄnjaka sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
