# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## VPC & Sieciowanie

Dowiedz siÄ™, czym jest VPC i o jego skÅ‚adnikach w:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 jest wykorzystywany do uruchamiania **serwerÃ³w wirtualnych**. UmoÅ¼liwia konfiguracjÄ™ **bezpieczeÅ„stwa** i **sieci** oraz zarzÄ…dzanie **przechowywaniem danych**. ElastycznoÅ›Ä‡ Amazon EC2 objawia siÄ™ w moÅ¼liwoÅ›ci skalowania zasobÃ³w zarÃ³wno w gÃ³rÄ™, jak i w dÃ³Å‚, dostosowujÄ…c siÄ™ skutecznie do zmian wymagaÅ„ lub wzrostu popularnoÅ›ci. Ta funkcja zmniejsza koniecznoÅ›Ä‡ precyzyjnych prognoz dotyczÄ…cych ruchu.

InteresujÄ…ce rzeczy do wyliczenia w EC2:

* Maszyny wirtualne
* Klucze SSH
* Dane uÅ¼ytkownika
* IstniejÄ…ce EC2/AMI/Snapshots
* Sieciowanie
* Sieci
* Podsieci
* Publiczne adresy IP
* Otwarte porty
* Zintegrowane poÅ‚Ä…czenia z innymi sieciami poza AWS

### Profile instancji

UÅ¼ycie **rÃ³l** do nadawania uprawnieÅ„ aplikacjom uruchamianym na **instancjach EC2** wymaga nieco dodatkowej konfiguracji. Aplikacja uruchamiana na instancji EC2 jest abstrahowana od AWS przez zvirtualizowany system operacyjny. Ze wzglÄ™du na to dodatkowe oddzielenie, konieczny jest dodatkowy krok polegajÄ…cy na przypisaniu roli AWS i jej powiÄ…zanych uprawnieÅ„ do instancji EC2 oraz udostÄ™pnieniu ich aplikacjom.

Ten dodatkowy krok to **utworzenie** [_**profilu instancji**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) doÅ‚Ä…czonego do instancji. **Profil instancji zawiera rolÄ™** i moÅ¼e dostarczyÄ‡ tymczasowe poÅ›wiadczenia roli do aplikacji uruchamianej na instancji. Te tymczasowe poÅ›wiadczenia mogÄ… nastÄ™pnie byÄ‡ uÅ¼ywane w wywoÅ‚aniach interfejsu API aplikacji do dostÄ™pu do zasobÃ³w i ograniczenia dostÄ™pu tylko do tych zasobÃ³w, ktÃ³re okreÅ›la rola. ZauwaÅ¼, Å¼e **tylko jedna rola moÅ¼e byÄ‡ przypisana do instancji EC2** w danym czasie, a wszystkie aplikacje na instancji dzielÄ… tÄ™ samÄ… rolÄ™ i uprawnienia.

### Punkt koÅ„cowy metadanych

Metadane AWS EC2 to informacje o instancji Amazon Elastic Compute Cloud (EC2), ktÃ³re sÄ… dostÄ™pne dla instancji w czasie wykonywania. Metadane te sÅ‚uÅ¼Ä… do dostarczania informacji o instancji, takich jak jej identyfikator instancji, strefa dostÄ™pnoÅ›ci, w ktÃ³rej dziaÅ‚a, rola IAM przypisana do instancji i nazwa hosta instancji.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Wyliczanie
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Nieuwierzytelniony dostÄ™p

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Eskalacja uprawnieÅ„

Na nastÄ™pnej stronie moÅ¼esz sprawdziÄ‡, jak **naduÅ¼yÄ‡ uprawnieÅ„ EC2 do eskalacji uprawnieÅ„**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** to po prostu statyczne **kopie zapasowe** woluminÃ³w AWS EBS. Innymi sÅ‚owy, sÄ… to **kopie** **dyskÃ³w** podÅ‚Ä…czonych do instancji **EC2** w okreÅ›lonym momencie. Snapshots EBS moÅ¼na kopiowaÄ‡ miÄ™dzy regionami i kontami, a nawet pobraÄ‡ i uruchomiÄ‡ lokalnie.

Snapshots mogÄ… zawieraÄ‡ **czuÅ‚e informacje** takie jak **kod ÅºrÃ³dÅ‚owy lub klucze API**, dlatego jeÅ›li masz okazjÄ™, zaleca siÄ™ ich sprawdzenie.

### RÃ³Å¼nica miÄ™dzy AMI a EBS

**AMI** sÅ‚uÅ¼y do **uruchamiania instancji EC2**, podczas gdy **Snapshot EC2** sÅ‚uÅ¼y do **tworzenia kopii zapasowej i odzyskiwania danych przechowywanych na woluminie EBS**. ChociaÅ¼ Snapshot EC2 moÅ¼na uÅ¼yÄ‡ do utworzenia nowego AMI, nie jest to to samo co AMI i nie zawiera informacji o systemie operacyjnym, serwerze aplikacji ani innych niezbÄ™dnych oprogramowaniu do uruchomienia aplikacji.

### Eskalacja uprawnieÅ„

Na nastÄ™pnej stronie moÅ¼esz sprawdziÄ‡, jak **naduÅ¼yÄ‡ uprawnieÅ„ EBS do eskalacji uprawnieÅ„**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** pozwala na zdalne zarzÄ…dzanie grupami instancji EC2, co uÅ‚atwia ich administracjÄ™. KaÅ¼da z tych instancji musi dziaÅ‚aÄ‡ z usÅ‚ugÄ… **SSM Agent, poniewaÅ¼ to ona otrzymuje dziaÅ‚ania i wykonuje je** z API AWS.

**SSM Agent** umoÅ¼liwia Systems Manager aktualizowanie, zarzÄ…dzanie i konfigurowanie tych zasobÃ³w. Agent **przetwarza Å¼Ä…dania z usÅ‚ugi Systems Manager w chmurze AWS**, a nastÄ™pnie wykonuje je zgodnie z Å¼Ä…daniem.

**SSM Agent jest** [**zainstalowany domyÅ›lnie w niektÃ³rych AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) lub musisz [**zainstalowaÄ‡ go rÄ™cznie**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancjach. Ponadto rola IAM uÅ¼ywana wewnÄ…trz instancji musi mieÄ‡ przypisanÄ… politykÄ™ **AmazonEC2RoleforSSM**, aby mÃ³c komunikowaÄ‡ siÄ™. 

### Wyliczanie
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
MoÅ¼esz sprawdziÄ‡ na instancji EC2, czy Systems Manager dziaÅ‚a, wykonujÄ…c:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Na nastÄ™pnej stronie moÅ¼esz sprawdziÄ‡, jak **wykorzystaÄ‡ uprawnienia SSM do eskalacji uprawnieÅ„**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

Techniki takie jak przechwytywanie wiadomoÅ›ci SSM moÅ¼na znaleÅºÄ‡ na stronie post-eksploatacji SSM:

{% content-ref url="broken-reference/" %}
[broken-reference](broken-reference/)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) to **usÅ‚uga balansowania obciÄ…Å¼enia dla wdroÅ¼eÅ„ Amazon Web Services** (AWS). ELB automatycznie **rozdziela przychodzÄ…cy ruch aplikacji** i skaluje zasoby, aby sprostaÄ‡ wymaganiom ruchu.

### Enumeracja
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Szablony uruchamiania i grupy automatycznego skalowania

### Wyliczanie

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN umoÅ¼liwia poÅ‚Ä…czenie twojej **sieci lokalnej (VPN typu site-to-site)** lub **laptopÃ³w pracownikÃ³w (VPN klienta)** z **AWS VPC**, dziÄ™ki czemu usÅ‚ugi mogÄ… byÄ‡ dostÄ™pne bez koniecznoÅ›ci ich wystawiania w internecie.

#### Podstawowe skÅ‚adniki AWS VPN

1. **Bramka klienta**:
* Bramka klienta to zasÃ³b, ktÃ³ry tworzysz w AWS, aby reprezentowaÄ‡ twojÄ… stronÄ™ poÅ‚Ä…czenia VPN.
* Jest to w zasadzie fizyczne urzÄ…dzenie lub aplikacja oprogramowania po twojej stronie poÅ‚Ä…czenia VPN typu site-to-site.
* Podajesz informacje o trasowaniu i publiczny adres IP urzÄ…dzenia sieciowego (takiego jak router lub zapora ogniowa) do AWS, aby utworzyÄ‡ bramkÄ™ klienta.
* SÅ‚uÅ¼y jako punkt odniesienia do konfiguracji poÅ‚Ä…czenia VPN i nie generuje dodatkowych opÅ‚at.
2. **Wirtualna bramka prywatna**:
* Wirtualna bramka prywatna (VPG) to koncentrator VPN po stronie Amazona w poÅ‚Ä…czeniu VPN typu site-to-site.
* Jest doÅ‚Ä…czona do twojego VPC i sÅ‚uÅ¼y jako cel twojego poÅ‚Ä…czenia VPN.
* VPG to punkt koÅ„cowy po stronie AWS dla poÅ‚Ä…czenia VPN.
* ObsÅ‚uguje bezpiecznÄ… komunikacjÄ™ miÄ™dzy twoim VPC a twojÄ… sieciÄ… lokalnÄ….
3. **PoÅ‚Ä…czenie VPN typu site-to-site**:
* PoÅ‚Ä…czenie VPN typu site-to-site Å‚Ä…czy twojÄ… sieÄ‡ lokalnÄ… z VPC poprzez bezpieczny tunel VPN IPsec.
* Ten rodzaj poÅ‚Ä…czenia wymaga bramki klienta i wirtualnej bramki prywatnej.
* Jest uÅ¼ywane do bezpiecznej, stabilnej i spÃ³jnej komunikacji miÄ™dzy twoim centrum danych lub sieciÄ… a Å›rodowiskiem AWS.
* Zazwyczaj stosowane do regularnych, dÅ‚ugoterminowych poÅ‚Ä…czeÅ„ i rozliczane na podstawie iloÅ›ci przesyÅ‚anych danych przez poÅ‚Ä…czenie.
4. **Punkt koÅ„cowy VPN klienta**:
* Punkt koÅ„cowy VPN klienta to zasÃ³b, ktÃ³ry tworzysz w AWS, aby umoÅ¼liwiÄ‡ i zarzÄ…dzaÄ‡ sesjami VPN klienta.
* SÅ‚uÅ¼y do umoÅ¼liwienia indywidualnym urzÄ…dzeniom (takim jak laptopy, smartfony itp.) bezpiecznego poÅ‚Ä…czenia z zasobami AWS lub twojÄ… sieciÄ… lokalnÄ….
* RÃ³Å¼ni siÄ™ od VPN typu site-to-site tym, Å¼e jest przeznaczony dla indywidualnych klientÃ³w, a nie do Å‚Ä…czenia caÅ‚ych sieci.
* W przypadku VPN klienta kaÅ¼de urzÄ…dzenie klienta uÅ¼ywa oprogramowania klienta VPN do nawiÄ…zania bezpiecznego poÅ‚Ä…czenia.

MoÅ¼esz [**znaleÅºÄ‡ wiÄ™cej informacji na temat korzyÅ›ci i skÅ‚adnikÃ³w VPN AWS tutaj**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).

### Wyliczanie
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalne wyliczenia

**Tymczasowe poÅ›wiadczenia lokalne**

Kiedy klient VPN AWS jest uÅ¼ywany do poÅ‚Ä…czenia z VPN, uÅ¼ytkownik zazwyczaj **loguje siÄ™ do AWS**, aby uzyskaÄ‡ dostÄ™p do VPN. NastÄ™pnie lokalnie tworzone sÄ… i przechowywane **pewne poÅ›wiadczenia AWS** w celu nawiÄ…zania poÅ‚Ä…czenia VPN. Te poÅ›wiadczenia sÄ… **przechowywane w** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i zawierajÄ… **klucz dostÄ™pu**, **klucz sekretny** oraz **token**.

PoÅ›wiadczenia naleÅ¼Ä… do uÅ¼ytkownika `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: zbadaj wiÄ™cej na temat uprawnieÅ„ tych poÅ›wiadczeÅ„).

**Pliki konfiguracyjne opvn**

JeÅ›li **poÅ‚Ä…czenie VPN zostaÅ‚o nawiÄ…zane**, naleÅ¼y wyszukaÄ‡ pliki konfiguracyjne **`.opvn`** w systemie. Ponadto, jednym miejscem, gdzie moÅ¼na znaleÅºÄ‡ **konfiguracje**, jest **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Eksploatacja po**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## OdnoÅ›niki

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
