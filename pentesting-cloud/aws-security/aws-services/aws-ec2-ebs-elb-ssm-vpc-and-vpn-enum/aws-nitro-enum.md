# AWS - Nitro Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

AWS Nitro to zestaw **innowacyjnych technologii**, kt贸re stanowi podstawow platform dla instancji AWS EC2. Wprowadzony przez Amazon w celu **poprawy bezpieczestwa, wydajnoci i niezawodnoci**, Nitro wykorzystuje dedykowane **komponenty sprztowe i lekki hipernadzorca**. Abstrahuje wiele tradycyjnych funkcji wirtualizacji do dedykowanego sprztu i oprogramowania, **minimalizujc powierzchni ataku** i poprawiajc efektywno zasob贸w. Poprzez przeniesienie funkcji wirtualizacji, Nitro pozwala instancjom EC2 osiga **wydajno zbli偶on do metalu**, co jest szczeg贸lnie korzystne dla aplikacji wymagajcych du偶ych zasob贸w. Dodatkowo, specjalny ukad zabezpiecze Nitro zapewnia **bezpieczestwo sprztu i oprogramowania**, dodatkowo umacniajc jego solidn architektur.

### Komory Nitro

**AWS Nitro Enclaves** zapewniaj bezpieczne, **izolowane rodowisko obliczeniowe w instancjach Amazon EC2**, specjalnie zaprojektowane do przetwarzania bardzo wra偶liwych danych. Wykorzystujc System AWS Nitro, te komory zapewniaj solidn **izolacj i bezpieczestwo**, idealne do **obsugi poufnych informacji** takich jak PII czy dane finansowe. Charakteryzuj si minimalistycznym rodowiskiem, znaczco zmniejszajc ryzyko ujawnienia danych. Dodatkowo, komory Nitro obsuguj atestacj kryptograficzn, pozwalajc u偶ytkownikom zweryfikowa, 偶e uruchamiany jest tylko autoryzowany kod, co jest kluczowe dla zachowania surowych standard贸w zgodnoci i ochrony danych.

{% hint style="danger" %}
Obrazy kom贸r Nitro s **uruchamiane wewntrz instancji EC2** i nie mo偶na ich zobaczy w konsoli internetowej AWS, czy instancja EC2 uruchamia obrazy w komorze Nitro, czy nie.
{% endhint %}

## Instalacja interfejsu wiersza polece komory Nitro

Postpuj zgodnie ze wszystkimi instrukcjami [**z dokumentacji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Jednak偶e, oto najwa偶niejsze:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Obrazy Enklawy Nitro

Obrazy, kt贸re mo偶na uruchamia w Enklawie Nitro, s oparte na obrazach dockerowych, wic mo偶esz tworzy swoje obrazy Enklawy Nitro z obraz贸w dockerowych, takich jak:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Jak wida obrazy Nitro Enclave u偶ywaj rozszerzenia **`eif`** (Enclave Image File).

Wyjcie bdzie wyglda podobnie jak:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Uruchom obraz

Zgodnie z [**dokumentacj**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), aby uruchomi obraz enklawy, musisz przypisa mu pami **co najmniej 4 razy wiksz ni偶 rozmiar pliku `eif`**. Mo偶liwe jest skonfigurowanie domylnych zasob贸w do przypisania w pliku.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Zawsze pamitaj, 偶e musisz **zarezerwowa pewne zasoby dla nadrzdnego EC2** instancji!
{% endhint %}

Po poznaniu zasob贸w do przypisania obrazowi i nawet po zmodyfikowaniu pliku konfiguracyjnego mo偶na uruchomi obraz enklawy za pomoc:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Wyliczanie Enklaw

Jeli przejmiesz hosta EC2, mo偶esz uzyska list uruchomionych obraz贸w enklaw za pomoc:
```bash
nitro-cli describe-enclaves
```
Nie jest mo偶liwe uzyskanie powoki wewntrz dziaajcego obrazu enklawy, poniewa偶 to g贸wne przeznaczenie enklawy, jednak偶e, jeli u偶yto parametru `--debug-mode`, mo偶liwe jest uzyskanie jego **stdout** za pomoc:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Zakocz enklawy

Jeli atakujcy przejmie instancj EC2, domylnie nie bdzie m贸g uzyska do nich dostpu za pomoc powoki, ale bdzie m贸g je **zakoczy** przy u偶yciu:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

Jedynym sposobem komunikacji z uruchomionym obrazem **enklawy** jest u偶ycie **vsocks**.

**Wirtualny gniazdek (vsock)** to rodzina gniazdek w systemie Linux, specjalnie zaprojektowana do uatwiania **komunikacji** midzy maszynami wirtualnymi (**VM**) a ich **hipernadzorcami**, lub midzy samymi VM **sob**. Vsock umo偶liwia efektywn, **dwukierunkow komunikacj** bez polegania na stosie sieciowym hosta. Dziki temu maszyny wirtualne mog komunikowa si nawet bez konfiguracji sieciowej, **korzystajc z 32-bitowego identyfikatora kontekstu (CID) i numer贸w port贸w** do identyfikacji i zarzdzania poczeniami. Interfejs API vsock obsuguje zar贸wno gniazdka strumieniowe, jak i datagramowe, podobnie jak TCP i UDP, zapewniajc wszechstronne narzdzie dla aplikacji na poziomie u偶ytkownika w rodowiskach wirtualnych.

{% hint style="success" %}
Dlatego adres vsock wyglda tak: `<CID>:<Port>`
{% endhint %}

Aby znale藕 **CIDs** uruchomionych obraz贸w enklawy, wystarczy wykona nastpujce polecenie i uzyska **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Zauwa偶, 偶e z hosta nie ma sposobu, aby dowiedzie si, czy CID ujawnia jakikolwiek port! Chyba 偶e u偶yjesz jakiego **skanera port贸w vsock, takiego jak** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Serwer/odbiornik Vsock

Oto kilka przykad贸w:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Prosty Suchacz w Pythonie</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</szczeg贸y>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Klient Vsock

Przykady:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Prosty klient w jzyku Python</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</szczeg贸y>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Narzdzie vsock-proxy pozwala na proxy vsock z innym adresem, na przykad:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
To przekieruje **lokalny port 8001 w vsock** do `ip-ranges.amazonaws.com:443`, a plik **`your-vsock-proxy.yaml`** mo偶e zawiera ten kod umo偶liwiajcy dostp do `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Mo偶liwe jest zobaczenie adres贸w vsock (**`<CID>:<Port>`**) u偶ywanych przez hosta EC2 za pomoc (zauwa偶 `3:8001`, gdzie 3 to CID, a 8001 to port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Atestacja Nitro Enclave i KMS

SDK Nitro Enclaves umo偶liwia enklawie 偶danie **kryptograficznie podpisanego dokumentu atestacji** od **Hypervisora** Nitro, kt贸ry zawiera **unikalne pomiaru** specyficzne dla tej enklawy. Te pomiary, kt贸re obejmuj **skr贸ty i rejestry konfiguracji platformy (PCRs)**, s wykorzystywane podczas procesu atestacji do **udowodnienia to偶samoci enklawy** i **budowania zaufania z zewntrznymi usugami**. Dokument atestacji zazwyczaj zawiera wartoci takie jak PCR0, PCR1 i PCR2, z kt贸rymi ju偶 si spotkae tworzc i zapisujc plik EIF enklawy.

Z [**dokumentacji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), oto wartoci PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Skr贸t z ...</th><th>Opis</th></tr></thead><tbody><tr><td>PCR0</td><td>Plik obrazu enklawy</td><td>Cigy pomiar zawartoci pliku obrazu, bez danych sekcji.</td></tr><tr><td>PCR1</td><td>Jdro Linuxa i bootstrap</td><td>Cigy pomiar jdra i danych boot ramfs.</td></tr><tr><td>PCR2</td><td>Aplikacja</td><td>Cigy, uporzdkowany pomiar aplikacji u偶ytkownika, bez boot ramfs.</td></tr><tr><td>PCR3</td><td>Rola IAM przypisana do instancji nadrzdnej</td><td>Cigy pomiar roli IAM przypisanej do instancji nadrzdnej. Zapewnia, 偶e proces atestacji powiedzie si tylko wtedy, gdy instancja nadrzdna ma waciw rol IAM.</td></tr><tr><td>PCR4</td><td>ID instancji instancji nadrzdnej</td><td>Cigy pomiar ID instancji nadrzdnej. Zapewnia, 偶e proces atestacji powiedzie si tylko wtedy, gdy instancja nadrzdna ma okrelone ID instancji.</td></tr><tr><td>PCR8</td><td>Certyfikat podpisujcy plik obrazu enklawy</td><td>Pomiar certyfikatu podpisujcego okrelony dla pliku obrazu enklawy. Zapewnia, 偶e proces atestacji powiedzie si tylko wtedy, gdy enklawa zostaa uruchomiona z pliku obrazu enklawy podpisanego okrelonym certyfikatem.</td></tr></tbody></table>

Mo偶esz zintegrowa **kryptograficzn atestacj** do swoich aplikacji i wykorzysta gotowe integracje z usugami takimi jak **AWS KMS**. AWS KMS mo偶e **zweryfikowa atestacje enklawy** i oferuje klucze warunkowe oparte na atestacji (`kms:RecipientAttestation:ImageSha384` i `kms:RecipientAttestation:PCR`) w swoich politykach klucza. Te polityki zapewniaj, 偶e AWS KMS zezwala na operacje przy u偶yciu klucza KMS **tylko jeli dokument atestacji enklawy jest wa偶ny** i spenia **okrelone warunki**.

{% hint style="success" %}
Zauwa偶, 偶e Enklawy w trybie debugowania (--debug) generuj dokumenty atestacji z PCRs, kt贸re skadaj si z zer (`000000000000000000000000000000000000000000000000`). Dlatego polityki KMS sprawdzajce te wartoci zawiod.
{% endhint %}

### Ominicie PCR

Z perspektywy atakujcego, zauwa偶, 偶e niekt贸re PCRs pozwoliyby na modyfikacj niekt贸rych czci lub caego obrazu enklawy i wci偶 byyby wa偶ne (na przykad PCR4 sprawdza tylko ID instancji nadrzdnej, wic uruchomienie dowolnego obrazu enklawy w tej EC2 pozwolioby speni to potencjalne wymaganie PCR).

Dlatego atakujcy, kt贸ry skompromituje instancj EC2, mo偶e by w stanie uruchomi inne obrazy enklaw w celu ominicia tych zabezpiecze.

Badania nad tym, jak modyfikowa/tworzy nowe obrazy w celu ominicia ka偶dego zabezpieczenia (szczeg贸lnie tych mniej oczywistych) s wci偶 do zrobienia.

## Odnoniki

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Wszystkie czci samouczka Nitro od AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
