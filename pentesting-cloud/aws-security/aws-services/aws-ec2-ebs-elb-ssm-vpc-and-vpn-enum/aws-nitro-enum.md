# AWS - Nitro Enum

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

O AWS Nitro √© um conjunto de **tecnologias inovadoras** que formam a plataforma subjacente para as inst√¢ncias AWS EC2. Introduzido pela Amazon para **aumentar a seguran√ßa, desempenho e confiabilidade**, o Nitro aproveita componentes de **hardware personalizados e um hipervisor leve**. Ele abstrai grande parte da funcionalidade de virtualiza√ß√£o tradicional para hardware e software dedicados, **minimizando a superf√≠cie de ataque** e melhorando a efici√™ncia de recursos. Ao descarregar fun√ß√µes de virtualiza√ß√£o, o Nitro permite que as inst√¢ncias EC2 ofere√ßam **desempenho quase bare-metal**, tornando-o particularmente ben√©fico para aplicativos intensivos em recursos. Al√©m disso, o Chip de Seguran√ßa Nitro garante especificamente a **seguran√ßa do hardware e firmware**, solidificando ainda mais sua arquitetura robusta.

### Nitro Enclaves

**AWS Nitro Enclaves** fornece um ambiente de computa√ß√£o seguro e **isolado dentro das inst√¢ncias Amazon EC2**, projetado especificamente para processar dados altamente sens√≠veis. Aproveitando o Sistema AWS Nitro, esses enclaves garantem **isolamento e seguran√ßa robustos**, ideais para **lidar com informa√ß√µes confidenciais** como PII ou registros financeiros. Eles apresentam um ambiente minimalista, reduzindo significativamente o risco de exposi√ß√£o de dados. Al√©m disso, os Nitro Enclaves suportam atesta√ß√£o criptogr√°fica, permitindo que os usu√°rios verifiquem que apenas o c√≥digo autorizado est√° em execu√ß√£o, crucial para manter padr√µes rigorosos de conformidade e prote√ß√£o de dados.

{% hint style="danger" %}
As imagens do Nitro Enclave s√£o **executadas de dentro das inst√¢ncias EC2** e voc√™ n√£o pode ver no console da web da AWS se uma inst√¢ncia EC2 est√° executando imagens em Nitro Enclave ou n√£o.
{% endhint %}

## Instala√ß√£o do CLI do Nitro Enclave

Siga todas as instru√ß√µes [**da documenta√ß√£o**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). No entanto, estas s√£o as mais importantes:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Imagens do Nitro Enclave

As imagens que voc√™ pode executar no Nitro Enclave s√£o baseadas em imagens docker, ent√£o voc√™ pode criar suas imagens do Nitro Enclave a partir de imagens docker como:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Como voc√™ pode ver, as imagens do Nitro Enclave usam a extens√£o **`eif`** (Enclave Image File).

A sa√≠da ser√° semelhante a:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Executar uma Imagem

Conforme [**a documenta√ß√£o**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), para executar uma imagem de enclave, voc√™ precisa atribuir a ela uma mem√≥ria de **pelo menos 4 vezes o tamanho do arquivo `eif`**. √â poss√≠vel configurar os recursos padr√£o a serem fornecidos no arquivo.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Lembre-se sempre de que voc√™ precisa **reservar alguns recursos para a inst√¢ncia EC2 pai** tamb√©m!
{% endhint %}

Depois de saber os recursos a serem fornecidos para uma imagem e at√© mesmo ter modificado o arquivo de configura√ß√£o, √© poss√≠vel executar uma imagem de enclave com:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerar Enclaves

Se voc√™ comprometer um host EC2, √© poss√≠vel obter uma lista de imagens de enclaves em execu√ß√£o com:
```bash
nitro-cli describe-enclaves
```
N√£o √© poss√≠vel obter um shell dentro de uma imagem de enclave em execu√ß√£o porque esse √© o principal objetivo do enclave, no entanto, se voc√™ usar o par√¢metro `--debug-mode`, √© poss√≠vel obter o stdout com:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminar Enclaves

Se um atacante comprometer uma inst√¢ncia EC2, por padr√£o ele n√£o poder√° obter um shell dentro delas, mas ele poder√° **termin√°-las** com:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

A √∫nica maneira de comunicar com uma **enclave** em execu√ß√£o √© usando **vsocks**.

**Virtual Socket (vsock)** √© uma fam√≠lia de sockets no Linux projetada especificamente para facilitar a **comunica√ß√£o** entre m√°quinas virtuais (**VMs**) e seus **hipervisores**, ou entre as pr√≥prias VMs. Vsock permite uma **comunica√ß√£o bidirecional** eficiente, sem depender do stack de rede do host. Isso torna poss√≠vel para as VMs se comunicarem mesmo sem configura√ß√µes de rede, **usando um ID de Contexto (CID) de 32 bits e n√∫meros de porta** para identificar e gerenciar conex√µes. A API vsock suporta tanto tipos de sockets de fluxo quanto de datagrama, semelhante ao TCP e UDP, fornecendo uma ferramenta vers√°til para aplica√ß√µes de n√≠vel de usu√°rio em ambientes virtuais.

{% hint style="success" %}
Portanto, um endere√ßo vsock se parece com isso: `<CID>:<Port>`
{% endhint %}

Para encontrar os **CIDs** das enclaves em execu√ß√£o, voc√™ pode simplesmente executar o seguinte comando e obter o **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Observe que a partir do host n√£o h√° como saber se um CID est√° expondo alguma porta! A menos que esteja usando algum **scanner de porta vsock como** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Servidor/Listener Vsock

Aqui est√£o alguns exemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Listener Python Simples</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Cliente Vsock

Exemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Cliente Python Simples</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Proxy Vsock

A ferramenta vsock-proxy permite fazer a proxy de um proxy vsock com outro endere√ßo, por exemplo:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Isso encaminhar√° a **porta local 8001 no vsock** para `ip-ranges.amazonaws.com:443` e o arquivo **`seu-vsock-proxy.yaml`** pode ter esse conte√∫do permitindo acessar `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
√â poss√≠vel ver os endere√ßos vsock (**`<CID>:<Port>`**) usados pelo host EC2 com (observe o `3:8001`, 3 √© o CID e 8001 a porta):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Atesta√ß√£o e KMS do Nitro Enclave

O SDK do Nitro Enclaves permite que um enclave solicite um **documento de atesta√ß√£o criptograficamente assinado** do **Hipervisor** Nitro, que inclui **medi√ß√µes √∫nicas** espec√≠ficas daquele enclave. Essas medi√ß√µes, que incluem **hashes e registros de configura√ß√£o de plataforma (PCRs)**, s√£o usadas durante o processo de atesta√ß√£o para **provar a identidade do enclave** e **construir confian√ßa com servi√ßos externos**. O documento de atesta√ß√£o geralmente cont√©m valores como PCR0, PCR1 e PCR2, que voc√™ j√° encontrou ao construir e salvar um EIF de enclave.

A partir da [**documenta√ß√£o**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), estes s√£o os valores de PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash de ...</th><th>Descri√ß√£o</th></tr></thead><tbody><tr><td>PCR0</td><td>Arquivo de imagem do enclave</td><td>Uma medida cont√≠gua do conte√∫do do arquivo de imagem, sem os dados da se√ß√£o.</td></tr><tr><td>PCR1</td><td>Kernel Linux e bootstrap</td><td>Uma medi√ß√£o cont√≠gua do kernel e dos dados do boot ramfs.</td></tr><tr><td>PCR2</td><td>Aplica√ß√£o</td><td>Uma medi√ß√£o cont√≠gua e em ordem das aplica√ß√µes do usu√°rio, sem o boot ramfs.</td></tr><tr><td>PCR3</td><td>Fun√ß√£o IAM atribu√≠da √† inst√¢ncia pai</td><td>Uma medi√ß√£o cont√≠gua da fun√ß√£o IAM atribu√≠da √† inst√¢ncia pai. Garante que o processo de atesta√ß√£o tenha sucesso apenas quando a inst√¢ncia pai possui a fun√ß√£o IAM correta.</td></tr><tr><td>PCR4</td><td>ID da inst√¢ncia pai</td><td>Uma medi√ß√£o cont√≠gua do ID da inst√¢ncia pai. Garante que o processo de atesta√ß√£o tenha sucesso apenas quando a inst√¢ncia pai possui um ID de inst√¢ncia espec√≠fico.</td></tr><tr><td>PCR8</td><td>Certificado de assinatura do arquivo de imagem do enclave</td><td>Uma medida do certificado de assinatura especificado para o arquivo de imagem do enclave. Garante que o processo de atesta√ß√£o tenha sucesso apenas quando o enclave foi inicializado a partir de um arquivo de imagem do enclave assinado por um certificado espec√≠fico.</td></tr></tbody></table>

Voc√™ pode integrar a **atesta√ß√£o criptogr√°fica** em suas aplica√ß√µes e aproveitar integra√ß√µes pr√©-constru√≠das com servi√ßos como **AWS KMS**. O AWS KMS pode **validar as atesta√ß√µes de enclave** e oferece chaves de condi√ß√£o baseadas em atesta√ß√£o (`kms:RecipientAttestation:ImageSha384` e `kms:RecipientAttestation:PCR`) em suas pol√≠ticas de chave. Essas pol√≠ticas garantem que o AWS KMS permita opera√ß√µes usando a chave KMS **apenas se o documento de atesta√ß√£o do enclave for v√°lido** e atender √†s **condi√ß√µes especificadas**.

{% hint style="success" %}
Observe que Enclaves no modo de depura√ß√£o (--debug) geram documentos de atesta√ß√£o com PCRs compostos por zeros (`000000000000000000000000000000000000000000000000`). Portanto, pol√≠ticas do KMS que verificam esses valores falhar√£o.
{% endhint %}

### Bypass de PCR

Do ponto de vista de um atacante, observe que alguns PCRs permitiriam modificar algumas partes ou toda a imagem do enclave e ainda seriam v√°lidos (por exemplo, o PCR4 verifica apenas o ID da inst√¢ncia pai, ent√£o executar qualquer imagem de enclave nessa EC2 permitir√° atender a esse requisito potencial de PCR).

Portanto, um atacante que comprometer a inst√¢ncia EC2 pode ser capaz de executar outras imagens de enclave para contornar essas prote√ß√µes.

A pesquisa sobre como modificar/criar novas imagens para contornar cada prote√ß√£o (especialmente as n√£o t√£o √≥bvias) ainda est√° POR FAZER.

## Refer√™ncias

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Todas as partes do tutorial do Nitro da AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
