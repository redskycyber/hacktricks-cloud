# AWS - Nitro Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)ë¡œë¶€í„° AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”!</strong></summary>

ë‹¤ë¥¸ HackTricks ì§€ì› ë°©ë²•:

- **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

AWS NitroëŠ” AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ë³¸ í”Œë«í¼ì„ í˜•ì„±í•˜ëŠ” **í˜ì‹ ì ì¸ ê¸°ìˆ  ëª¨ìŒ**ì…ë‹ˆë‹¤. Amazonì— ì˜í•´ ì†Œê°œëœ NitroëŠ” **ë³´ì•ˆ, ì„±ëŠ¥ ë° ì‹ ë¢°ì„±ì„ í–¥ìƒ**ì‹œí‚¤ê¸° ìœ„í•´ ì‚¬ìš©ì ì •ì˜ **í•˜ë“œì›¨ì–´ êµ¬ì„± ìš”ì†Œ ë° ê°€ë²¼ìš´ í•˜ì´í¼ë°”ì´ì €**ë¥¼ í™œìš©í•©ë‹ˆë‹¤. NitroëŠ” ì „í†µì ì¸ ê°€ìƒí™” ê¸°ëŠ¥ì˜ ë§ì€ ë¶€ë¶„ì„ ì „ìš© í•˜ë“œì›¨ì–´ ë° ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ì¶”ìƒí™”í•˜ì—¬ **ê³µê²© í‘œë©´ì„ ìµœì†Œí™”**í•˜ê³  ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ê°€ìƒí™” ê¸°ëŠ¥ì„ ì˜¤í”„ë¡œë“œí•¨ìœ¼ë¡œì¨ NitroëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ **ê±°ì˜ ë² ì–´ ë©”íƒˆ ì„±ëŠ¥**ì„ ì œê³µí•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ì§‘ì•½ì ì¸ ì‘ìš© í”„ë¡œê·¸ë¨ì— íŠ¹íˆ ìœ ìš©í•©ë‹ˆë‹¤. ë˜í•œ Nitro ë³´ì•ˆ ì¹©ì€ íŠ¹íˆ **í•˜ë“œì›¨ì–´ ë° íŒì›¨ì–´ì˜ ë³´ì•ˆ**ì„ ë³´ì¥í•˜ì—¬ ê²¬ê³ í•œ ì•„í‚¤í…ì²˜ë¥¼ ë”ìš± í™•ê³ íˆ í•©ë‹ˆë‹¤.

### Nitro Enclaves

**AWS Nitro Enclaves**ëŠ” Amazon EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ **ì•ˆì „í•œ ê²©ë¦¬ëœ ì»´í“¨íŒ… í™˜ê²½**ì„ ì œê³µí•˜ë©°, ê³ ë„ë¡œ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ íŠ¹ë³„íˆ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. AWS Nitro ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ ì´ëŸ¬í•œ EnclavesëŠ” ê²¬ê³ í•œ **ê²©ë¦¬ ë° ë³´ì•ˆ**ì„ ë³´ì¥í•˜ì—¬ PII ë˜ëŠ” ê¸ˆìœµ ê¸°ë¡ê³¼ ê°™ì€ **ê¸°ë°€ ì •ë³´ë¥¼ ì²˜ë¦¬**í•˜ëŠ” ë° ì´ìƒì ì…ë‹ˆë‹¤. ì´ë“¤ì€ ë°ì´í„° ë…¸ì¶œ ìœ„í—˜ì„ í¬ê²Œ ì¤„ì´ëŠ” ìµœì†Œí•œì˜ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤. ë˜í•œ Nitro EnclavesëŠ” ì•”í˜¸í™” ì¸ì¦ì„ ì§€ì›í•˜ì—¬ ì‚¬ìš©ìê°€ ì‹¤í–‰ ì¤‘ì¸ ì½”ë“œê°€ ì¸ì¦ëœ ì½”ë“œì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ì—„ê²©í•œ ê·œì • ì¤€ìˆ˜ ë° ë°ì´í„° ë³´í˜¸ í‘œì¤€ì„ ìœ ì§€í•˜ëŠ” ë° ì¤‘ìš”í•©ë‹ˆë‹¤.

{% hint style="danger" %}
Nitro Enclave ì´ë¯¸ì§€ëŠ” **EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì—ì„œ ì‹¤í–‰**ë˜ë©° AWS ì›¹ ì½˜ì†”ì—ì„œ EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ Nitro Enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
{% endhint %}

## Nitro Enclave CLI ì„¤ì¹˜

ëª¨ë“  ì§€ì¹¨ì„ [**ë¬¸ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ì—ì„œ ë”°ë¥´ì„¸ìš”. ê·¸ëŸ¬ë‚˜ ì´ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave ì´ë¯¸ì§€

Nitro Enclaveì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ë“¤ì€ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ë„ì»¤ ì´ë¯¸ì§€ë¡œë¶€í„° Nitro Enclave ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclave ì´ë¯¸ì§€ëŠ” **`eif`** (Enclave Image File) í™•ì¥ìë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì¶œë ¥ì€ ë‹¤ìŒê³¼ ìœ ì‚¬í•  ê²ƒì…ë‹ˆë‹¤:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### ì´ë¯¸ì§€ ì‹¤í–‰

[**ë¬¸ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)ì— ë”°ë¥´ë©´, ì—”í´ë ˆì´ë¸Œ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ í•´ë‹¹ ì´ë¯¸ì§€ì— **`eif` íŒŒì¼ í¬ê¸°ì˜ ìµœì†Œ 4ë°° ì´ìƒì˜ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹**í•´ì•¼ í•©ë‹ˆë‹¤. íŒŒì¼ ë‚´ì—ì„œ í• ë‹¹í•  ê¸°ë³¸ ë¦¬ì†ŒìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
ì–¸ì œë‚˜ ë¶€ëª¨ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì¼ë¶€ **ë¦¬ì†ŒìŠ¤ë¥¼ ì˜ˆì•½í•´ì•¼** í•œë‹¤ëŠ” ê²ƒì„ ê¸°ì–µí•˜ì„¸ìš”!
{% endhint %}

ì´ë¯¸ì§€ì— í• ë‹¹í•  ë¦¬ì†ŒìŠ¤ë¥¼ ì•Œê³  êµ¬ì„± íŒŒì¼ì„ ìˆ˜ì •í•œ í›„ì—ë„ ë‹¤ìŒê³¼ ê°™ì´ ì—”í´ë ˆì´ë¸Œ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enclaves ì—´ê±°

EC2 í˜¸ìŠ¤íŠ¸ë¥¼ ì¹¨ì…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰ ì¤‘ì¸ ì—”í´ë ˆì´ë¸Œ ì´ë¯¸ì§€ ëª©ë¡ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
nitro-cli describe-enclaves
```
ê·¸ ì‹¤í–‰ ì¤‘ì¸ ì—”í´ë ˆì´ë¸Œ ì´ë¯¸ì§€ ë‚´ë¶€ì— ì‰˜ì„ ì–»ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ê·¸ê²ƒì´ ì—”í´ë ˆì´ë¸Œì˜ ì£¼ìš” ëª©ì ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ **`--debug-mode`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ì´ë¯¸ì§€ì˜ **stdout**ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Enclaves ì¢…ë£Œ

ê³µê²©ìê°€ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¹¨íˆ¬í•˜ë”ë¼ë„ ê¸°ë³¸ì ìœ¼ë¡œ ê·¸ë“¤ ì•ˆì— ì‰˜ì„ ì–»ì„ ìˆ˜ëŠ” ì—†ì§€ë§Œ, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ **ì¢…ë£Œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

**ì•ˆí´ë ˆì´ë¸Œ** ì‹¤í–‰ ì´ë¯¸ì§€ì™€ í†µì‹ í•˜ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ **vsocks**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**ê°€ìƒ ì†Œì¼“ (vsock)**ì€ ë¦¬ëˆ…ìŠ¤ì˜ ì†Œì¼“ íŒ¨ë°€ë¦¬ë¡œ, ê°€ìƒ ë¨¸ì‹ (**VMs**)ê³¼ ê·¸ë“¤ì˜ **í•˜ì´í¼ë°”ì´ì €** ë˜ëŠ” VMs **ê°„**ì˜ **í†µì‹ **ì„ ìš©ì´í•˜ê²Œ í•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ íŠ¹ë³„íˆ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. Vsockì€ í˜¸ìŠ¤íŠ¸ì˜ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤íƒì— ì˜ì¡´í•˜ì§€ ì•Šê³  íš¨ìœ¨ì ì¸ **ì–‘ë°©í–¥ í†µì‹ **ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ VMsëŠ” ë„¤íŠ¸ì›Œí¬ êµ¬ì„± ì—†ì´ë„ í†µì‹ í•  ìˆ˜ ìˆìœ¼ë©°, **32ë¹„íŠ¸ Context ID (CID)ì™€ í¬íŠ¸ ë²ˆí˜¸**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²°ì„ ì‹ë³„í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. vsock APIëŠ” TCPì™€ UDPì™€ ìœ ì‚¬í•œ ìŠ¤íŠ¸ë¦¼ ë° ë°ì´í„°ê·¸ë¨ ì†Œì¼“ ìœ í˜•ì„ ì§€ì›í•˜ë©°, ê°€ìƒ í™˜ê²½ì—ì„œ ì‚¬ìš©ì ìˆ˜ì¤€ ì‘ìš© í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ë‹¤ì¬ë‹¤ëŠ¥í•œ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

{% hint style="success" %}
ë”°ë¼ì„œ, vsock ì£¼ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤: `<CID>:<Port>`
{% endhint %}

**ì•ˆí´ë ˆì´ë¸Œ** ì‹¤í–‰ ì´ë¯¸ì§€ì˜ **CIDs**ë¥¼ ì°¾ìœ¼ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  **`EnclaveCID`**ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
í˜¸ìŠ¤íŠ¸ì—ì„œ CIDê°€ í¬íŠ¸ë¥¼ ë…¸ì¶œí•˜ê³  ìˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ìŠµë‹ˆë‹¤! **[https://github.com/carlospolop/Vsock-scanner](https://github.com/carlospolop/Vsock-scanner)**ì™€ ê°™ì€ **vsock í¬íŠ¸ ìŠ¤ìºë„ˆ**ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í•œ.
{% endhint %}

### Vsock ì„œë²„/ë¦¬ìŠ¤ë„ˆ

ì—¬ê¸°ì— ëª‡ ê°€ì§€ ì˜ˆì œê°€ ìˆìŠµë‹ˆë‹¤:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>ê°„ë‹¨í•œ Python ë¦¬ìŠ¤ë„ˆ</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock í´ë¼ì´ì–¸íŠ¸

ì˜ˆì‹œ:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>ê°„ë‹¨í•œ Python í´ë¼ì´ì–¸íŠ¸</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>  

<details>  
<summary>ë²ˆì—­</summary>  

ë‹¤ìŒì€ AWS Nitro ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë°œê²¬í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ìœ ìš©í•œ ì •ë³´ì…ë‹ˆë‹¤.  

- Nitro ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•  
- Nitro ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœ  
- Nitro ì¸ìŠ¤í„´ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤  
- Nitro ì¸ìŠ¤í„´ìŠ¤ì˜ ë¸”ë¡ ì¥ì¹˜  
- Nitro ì¸ìŠ¤í„´ìŠ¤ì˜ SR-IOV ì§€ì› ì—¬ë¶€  

ì´ëŸ¬í•œ ì •ë³´ëŠ” AWS í™˜ê²½ì—ì„œ íœí…ŒìŠ¤íŒ…ì„ ìˆ˜í–‰í•  ë•Œ ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock í”„ë¡ì‹œ

ë„êµ¬ vsock-proxyë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ë¥¸ ì£¼ì†Œë¡œ vsock í”„ë¡ì‹œë¥¼ í”„ë¡ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆì‹œ:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
ì´ê²ƒì€ **vsock**ì˜ **ë¡œì»¬ í¬íŠ¸ 8001**ì„ `ip-ranges.amazonaws.com:443`ë¡œ ì „ë‹¬í•˜ë©° íŒŒì¼ **`your-vsock-proxy.yaml`**ì—ëŠ” `ip-ranges.amazonaws.com:443`ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë‚´ìš©ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
ë‹¤ìŒì€ EC2 í˜¸ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” vsock ì£¼ì†Œ(**`<CID>:<Port>`**)ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (`3:8001`, 3ì€ CIDì´ê³  8001ì€ í¬íŠ¸ì„ì„ ì°¸ê³ í•˜ì„¸ìš”):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Attestation & KMS

Nitro Enclaves SDKë¥¼ ì‚¬ìš©í•˜ë©´ enclaveê°€ Nitro Hypervisorë¡œë¶€í„° **ì•”í˜¸í™”ëœ ì„œëª…ëœ ì¸ì¦ ë¬¸ì„œ**ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì„œì—ëŠ” í•´ë‹¹ enclaveì— íŠ¹ì •í•œ **ê³ ìœ  ì¸¡ì •ê°’**ì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¸¡ì •ê°’ì—ëŠ” **í•´ì‹œ ë° í”Œë«í¼ êµ¬ì„± ë ˆì§€ìŠ¤í„° (PCRs)**ê°€ í¬í•¨ë˜ë©°, ì´ëŸ¬í•œ ê°’ë“¤ì€ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì¤‘ì— ì‚¬ìš©ë˜ì–´ **enclaveì˜ ì‹ ì›ì„ ì¦ëª…**í•˜ê³  **ì™¸ë¶€ ì„œë¹„ìŠ¤ì™€ì˜ ì‹ ë¢°ë¥¼ êµ¬ì¶•**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì¸ì¦ ë¬¸ì„œì—ëŠ” ì¼ë°˜ì ìœ¼ë¡œ PCR0, PCR1 ë° PCR2ì™€ ê°™ì€ ê°’ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, ì´ ê°’ë“¤ì€ enclave EIFë¥¼ ë¹Œë“œí•˜ê³  ì €ì¥í•  ë•Œ ì´ì „ì— ë§Œë‚œ ê°’ë“¤ì…ë‹ˆë‹¤.

[**ë¬¸ì„œ**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)ì—ì„œ ë‹¤ìŒì€ PCR ê°’ë“¤ì…ë‹ˆë‹¤:

<table><thead><tr><th width="97">PCR</th><th width="221">í•´ì‹œ ê°’</th><th>ì„¤ëª…</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave ì´ë¯¸ì§€ íŒŒì¼</td><td>ì„¹ì…˜ ë°ì´í„° ì—†ì´ ì´ë¯¸ì§€ íŒŒì¼ì˜ ë‚´ìš©ì˜ ì—°ì†ëœ ì¸¡ì •ê°’ì…ë‹ˆë‹¤.</td></tr><tr><td>PCR1</td><td>Linux ì»¤ë„ ë° ë¶€íŠ¸ìŠ¤íŠ¸ë©</td><td>ì»¤ë„ ë° ë¶€íŠ¸ ramfs ë°ì´í„°ì˜ ì—°ì†ëœ ì¸¡ì •ê°’ì…ë‹ˆë‹¤.</td></tr><tr><td>PCR2</td><td>ì• í”Œë¦¬ì¼€ì´ì…˜</td><td>ë¶€íŠ¸ ramfs ì—†ì´ ì‚¬ìš©ì ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì—°ì†ëœ ìˆœì„œëŒ€ë¡œ ì¸¡ì •ê°’ì…ë‹ˆë‹¤.</td></tr><tr><td>PCR3</td><td>ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ IAM ì—­í• </td><td>ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ IAM ì—­í• ì˜ ì—°ì†ëœ ì¸¡ì •ê°’ì…ë‹ˆë‹¤. ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì˜¬ë°”ë¥¸ IAM ì—­í• ì„ ê°€ì§„ ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì¼ ë•Œì—ë§Œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µí•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.</td></tr><tr><td>PCR4</td><td>ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ ID</td><td>ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì˜ IDì˜ ì—°ì†ëœ ì¸¡ì •ê°’ì…ë‹ˆë‹¤. ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ IDë¥¼ ê°€ì§„ ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì¼ ë•Œì—ë§Œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µí•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.</td></tr><tr><td>PCR8</td><td>Enclave ì´ë¯¸ì§€ íŒŒì¼ ì„œëª… ì¸ì¦ì„œ</td><td>enclave ì´ë¯¸ì§€ íŒŒì¼ì— ì§€ì •ëœ ì„œëª… ì¸ì¦ì„œì˜ ì¸¡ì •ê°’ì…ë‹ˆë‹¤. íŠ¹ì • ì¸ì¦ì„œë¡œ ì„œëª…ëœ enclave ì´ë¯¸ì§€ íŒŒì¼ì—ì„œë§Œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µí•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.</td></tr></tbody></table>

**ì•”í˜¸í™”ëœ ì¸ì¦**ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ì— í†µí•©í•˜ê³  **AWS KMS**ì™€ ê°™ì€ ì„œë¹„ìŠ¤ì™€ì˜ ì‚¬ì „ êµ¬ì¶•ëœ í†µí•©ì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. AWS KMSëŠ” **enclave ì¸ì¦ì„ í™•ì¸**í•˜ê³  í‚¤ ì •ì±…ì—ì„œ ì¸ì¦ ê¸°ë°˜ ì¡°ê±´ í‚¤ (`kms:RecipientAttestation:ImageSha384` ë° `kms:RecipientAttestation:PCR`)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ AWS KMSê°€ **enclaveì˜ ì¸ì¦ ë¬¸ì„œê°€ ìœ íš¨í•˜ê³  ì§€ì •ëœ ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ” ê²½ìš°ì—ë§Œ** KMS í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—…ì„ í—ˆìš©í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

{% hint style="success" %}
ë””ë²„ê·¸ (--debug) ëª¨ë“œì˜ EnclavesëŠ” PCRì´ ëª¨ë‘ 0ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ì¸ì¦ ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (`000000000000000000000000000000000000000000000000`). ë”°ë¼ì„œ, ì´ëŸ¬í•œ ê°’ë“¤ì„ í™•ì¸í•˜ëŠ” KMS ì •ì±…ì€ ì‹¤íŒ¨í•  ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

### PCR ìš°íšŒ

ê³µê²©ìì˜ ê´€ì ì—ì„œ, ì¼ë¶€ PCRì€ enclave ì´ë¯¸ì§€ì˜ ì¼ë¶€ ë˜ëŠ” ì „ì²´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ë©° ì—¬ì „íˆ ìœ íš¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: PCR4ëŠ” ë¶€ëª¨ ì¸ìŠ¤í„´ìŠ¤ì˜ IDë§Œ í™•ì¸í•˜ë¯€ë¡œ í•´ë‹¹ EC2ì—ì„œ ì–´ë–¤ enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ë”ë¼ë„ ì´ ì ì¬ì ì¸ PCR ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

ë”°ë¼ì„œ EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¹¨í•´í•œ ê³µê²©ìëŠ” ì´ëŸ¬í•œ ë³´í˜¸ ê¸°ëŠ¥ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ enclave ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê° ë³´í˜¸ ê¸°ëŠ¥ì„ ìš°íšŒí•˜ë„ë¡ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì •/ìƒì„±í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì—°êµ¬ (íŠ¹íˆ ëª…ë°±í•˜ì§€ ì•Šì€ ê²ƒë“¤)ì€ ì•„ì§ TODO ìƒíƒœì…ë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWSì˜ Nitro íŠœí† ë¦¬ì–¼ì˜ ëª¨ë“  ë¶€ë¶„: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PDFë¡œ HackTricks ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ì…í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
