# AWS - Podstawowe informacje o VPC i sieciach

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub.**

</details>

## Sieciowanie w AWS w skr贸cie

**VPC** zawiera **CIDR sieci** takie jak 10.0.0.0/16 (z jej **tabel routingu** i **ACL sieciowym**).

Ta sie VPC jest podzielona na **podsieci**, wic **podsie** jest bezporednio **powizana** z **VPC**, **tabel routingu** i **ACL sieciowym**.

Nastpnie, **Interfejsy sieciowe** podczone do usug (takich jak instancje EC2) s **poczone** z **podsieciami** za pomoc **grup zabezpiecze**.

Dlatego **grupa zabezpiecze** ogranicza wystawione porty interfejs贸w sieciowych **korzystajcych z niej**, **niezale偶nie od podsieci**. Natomiast **ACL sieciowy** ogranicza wystawione porty dla **caej sieci**.

Ponadto, aby **uzyska dostp do Internetu**, istniej pewne interesujce konfiguracje do sprawdzenia:

* **Podsie** mo偶e **automatycznie przypisywa publiczne adresy IPv4**
* **Instancja** utworzona w sieci, kt贸ra **automatycznie przypisuje adresy IPv4, mo偶e otrzyma jeden**
* Do **VPC** musi by **doczony brama internetowa**
* Mo偶na r贸wnie偶 u偶ywa **bram wycznie do wychodzcego ruchu do Internetu**
* Mo偶na r贸wnie偶 mie **bram NAT** w **prywatnej podsieci**, dziki czemu mo偶liwe jest **poczenie z zewntrznymi usugami** z tej prywatnej podsieci, ale **nie mo偶na ich osign z zewntrz**.
* Brama NAT mo偶e by **publiczna** (dostp do Internetu) lub **prywatna** (dostp do innych VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) umo偶liwia **uruchamianie zasob贸w AWS w wirtualnej sieci**, kt贸r zdefiniowae. Ta wirtualna sie bdzie miaa kilka podsieci, Bramy internetowe do dostpu do Internetu, ACL, Grupy zabezpiecze, adresy IP...

### Podsieci

Podsieci pomagaj w wikszym zabezpieczeniu. **Logiczne grupowanie podobnych zasob贸w** pomaga r贸wnie偶 w **atwiejszym zarzdzaniu** infrastruktur.

* Poprawne CIDR to od maski sieci /16 do maski sieci /28.
* Podsie nie mo偶e znajdowa si jednoczenie w r贸偶nych strefach dostpnoci.
* **AWS zastrzega trzy pierwsze adresy IP hosta** ka偶dej podsieci **dla wewntrznego u偶ytku AWS**: pierwszy u偶ywany adres hosta jest dla routera VPC. Drugi adres jest zarezerwowany dla DNS AWS, a trzeci adres jest zarezerwowany na przysze u偶ycie.
* Nazywa si je **publicznymi podsieciami**, kt贸re maj **bezporedni dostp do Internetu, podczas gdy prywatne podsieci nie maj.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabele routingu

Tabele routingu okrelaj trasowanie ruchu dla podsieci w ramach VPC. Okrelaj, kt贸ry ruch sieciowy jest przekazywany do Internetu lub do poczenia VPN. Zazwyczaj znajdziesz dostp do:

* Lokalnej VPC
* NAT
* Bram internetowych / Bram internetowych wycznie do wychodzcego ruchu (potrzebne do zapewnienia VPC dostpu do Internetu).
* Aby uczyni podsie publiczn, musisz **utworzy** i **doczy** **bram internetow** do swojej VPC.
* Punkty kocowe VPC (do dostpu do S3 z prywatnych sieci)

Na poni偶szych obrazach mo偶esz sprawdzi r贸偶nice midzy domyln sieci publiczn a prywatn:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL sieciowy

**Kontrola dostpu do sieci (ACL)**: ACL sieciowe to reguy zapory sieciowej, kt贸re kontroluj przychodzcy i wychodzcy ruch sieciowy do podsieci. Mog by u偶ywane do zezwalania lub blokowania ruchu do okrelonych adres贸w IP lub zakres贸w.

* Najczciej zezwala si/blokuje dostp za pomoc grup zabezpiecze, ale jest to jedyny spos贸b, aby cakowicie zatrzyma ju偶 ustanowione odwr贸cone powoki. Zmodyfikowana regua w grupie zabezpiecze nie zatrzymuje ju偶 ustanowionych pocze
* Jednak dotyczy to caej podsieci, wic bd藕 ostro偶ny, gdy zakazujesz czego, poniewa偶 potrzebna funkcjonalno mo偶e zosta zak贸cona
### Grupy zabezpiecze

Grupy zabezpiecze s wirtualnym **firewallem**, kt贸ry kontroluje ruch sieciowy **przychodzcy i wychodzcy do instancji** w VPC. Relacja 1 SG do M instancji (zazwyczaj 1 do 1).\
Zazwyczaj jest to u偶ywane do otwierania niebezpiecznych port贸w w instancjach, takich jak na przykad port 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastyczne adresy IP

Elastyczny adres IP to **statyczny adres IPv4** zaprojektowany do dynamicznego oblicze w chmurze. Elastyczny adres IP jest przydzielany do twojego konta AWS i pozostaje twoj wasnoci, dop贸ki go nie zwolnisz. Korzystajc z elastycznego adresu IP, mo偶esz ukry awari instancji lub oprogramowania, szybko przypisujc adres do innej instancji w twoim koncie.

### Poczenie midzy podsieci

Domylnie wszystkie podsieci maj **automatyczne przypisywanie publicznych adres贸w IP wyczone**, ale mo偶na je wczy.

**Lokalna trasa w tablicy tras umo偶liwia komunikacj midzy podsieci VPC.**

Jeli **czysz podsie z inn podsieci, nie mo偶esz uzyska dostpu do podsieci poczonych** z inn podsieci, musisz bezporednio utworzy poczenie z nimi. **Dotyczy to r贸wnie偶 bram internetowych**. Nie mo偶esz przechodzi przez poczenie podsieci, aby uzyska dostp do internetu, musisz przypisa bram internetow do swojej podsieci.

### VPC Peering

VPC Peering umo偶liwia **poczenie dw贸ch lub wicej VPC** za pomoc IPV4 lub IPV6, tak jakby byy czci tej samej sieci.

Po ustanowieniu poczenia peer, **zasoby w jednym VPC mog uzyska dostp do zasob贸w w drugim**. Poczenie midzy VPC jest realizowane za pomoc istniejcej infrastruktury sieciowej AWS, dlatego jest wysoce dostpne bez wskiego garda przepustowoci. Poniewa偶 **poczenia peer dziaaj tak, jakby byy czci tej samej sieci**, istniej ograniczenia dotyczce zakres贸w blok贸w CIDR, kt贸re mo偶na u偶ywa.\
Jeli masz **nakadajce si lub zduplikowane zakresy CIDR** dla swojego VPC, **nie bdziesz w stanie poczy VPC**.\
Ka偶de VPC AWS **komunikuje si tylko ze swoim peerem**. Na przykad, jeli masz poczenie peer midzy VPC 1 i VPC 2, a innym poczeniem midzy VPC 2 i VPC 3, jak pokazano na rysunku, VPC 1 i 2 mog komunikowa si bezporednio, tak samo jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mog. **Nie mo偶na przekierowa ruchu przez jedno VPC, aby dotrze do innego.**

### **Rejestry przepywu VPC**

W ramach VPC mo偶esz mie potencjalnie setki lub nawet tysice zasob贸w, kt贸re komunikuj si midzy r贸偶nymi podsieciami, zar贸wno publicznymi, jak i prywatnymi, a tak偶e midzy r贸偶nymi VPC za porednictwem pocze peer. **Rejestry przepywu VPC pozwalaj rejestrowa informacje o ruchu IP, kt贸ry przepywa midzy interfejsami sieciowymi twoich zasob贸w w ramach VPC**.

W przeciwiestwie do rejestr贸w dostpu S3 i rejestr贸w dostpu CloudFront, **dane log贸w generowane przez rejestry przepywu VPC nie s przechowywane w S3. Zamiast tego, przechwytywane dane log贸w s wysyane do log贸w CloudWatch**.

Ograniczenia:

* Jeli korzystasz z poczenia peer VPC, bdziesz m贸g zobaczy tylko logi przepywu z poczonych VPC, kt贸re znajduj si w tym samym koncie.
* Jeli nadal korzystasz z zasob贸w w rodowisku EC2-Classic, niestety nie mo偶esz pobiera informacji z ich interfejs贸w.
* Po utworzeniu rejestru przepywu VPC nie mo偶na go zmieni. Aby zmieni konfiguracj rejestru przepywu VPC, musisz go usun, a nastpnie utworzy nowy.
* Nastpujcy ruch nie jest monitorowany i przechwytywany przez logi: ruch DHCP w ramach VPC, ruch z instancji do serwera DNS Amazona.
* Ruch kierowany na adres IP routera domylnego VPC i ruch do i od nastpujcych adres贸w: 169.254.169.254, kt贸ry jest u偶ywany do zbierania metadanych instancji, i 169.254.169.123, kt贸ry jest u偶ywany do usugi synchronizacji czasu Amazona.
* Ruch dotyczcy licencji aktywacji systemu Windows Amazona z instancji systemu Windows.
* Ruch midzy interfejsem r贸wnowa偶enia obci偶enia sieci a interfejsem sieci punktu kocowego.

Dla ka偶dego interfejsu sieciowego, kt贸ry publikuje dane do grupy log贸w CloudWatch, zostanie u偶yty inny strumie log贸w. W ka偶dym z tych strumieni znajduj si dane zdarze rejestru przepywu, kt贸re pokazuj zawarto wpis贸w log贸w. Ka偶dy z tych **log贸w rejestruje dane przez okoo 10 do 15 minut**.

## VPN

### Podstawowe komponenty AWS VPN

1. **Brama klienta**:
* Brama klienta to zas贸b, kt贸ry tworzysz w AWS, aby reprezentowa twoj stron poczenia VPN.
* Jest to w zasadzie fizyczne urzdzenie lub aplikacja oprogramowania po twojej stronie poczenia VPN typu site-to-site.
* Przekazujesz informacje o routingu i publicznym adresie IP urzdzenia sieciowego (takiego jak router lub zapora ogniowa) do AWS, aby utworzy bram klienta.
* Su偶y jako punkt odniesienia do konfiguracji poczenia VPN i nie generuje dodatkowych opat.
2. **Wirtualna prywatna brama**:
* Wirtualna prywatna brama (VPG) to koncentrator VPN po stronie Amazona w poczeniu VPN typu site-to-site.
* Jest ona doczona do twojego VPC i su偶y jako cel dla twojego poczenia VPN.
* VPG jest punktem kocowym po stronie AWS dla poczenia VPN.
* Obsuguje bezpieczn komunikacj midzy twoim VPC a sieci lokaln.
3. **Poczenie VPN typu site-to-site**:
* Poczenie VPN typu site-to-site czy twoj sie lokaln z VPC za porednictwem bezpiecznego tunelu VPN IPsec.
* Ten rodzaj poczenia wymaga bramy klienta i wirtualnej prywatnej bramy.
* Su偶y do bezpiecznej, stabilnej i sp贸jnej komunikacji midzy twoim centrum danych lub sieci a rodowiskiem AWS.
* Zazwyczaj u偶ywane do regularnych, dugoterminowych pocze i rozliczane na podstawie iloci przesyanych danych w ramach poczenia.
4. **Punkt kocowy klienta VPN**:
* Punkt kocowy klienta VPN to zas贸b, kt贸ry tworzysz w AWS, aby umo偶liwi i zarzdza sesjami klienta VPN.
* Su偶y do umo偶liwienia indywidualnym urzdzeniom (takim jak laptopy, smartfony itp.) bezpiecznego poczenia z zasobami AWS lub sieci lokaln.
* R贸偶ni si od poczenia VPN typu site-to
#### Ograniczenia

* Ruch IPv6 nie jest obsugiwany dla pocze VPN na wirtualnej bramie prywatnej.
* Poczenie VPN AWS nie obsuguje odkrywania MTU cie偶ki.

Ponadto, nale偶y wzi pod uwag nastpujce kwestie podczas korzystania z VPN typu Site-to-Site.

* Podczas czenia VPC z wsp贸ln sieci lokaln zalecamy korzystanie z niezachodzcych na siebie blok贸w CIDR dla sieci.

### VPN klienta <a href="#what-is-components" id="what-is-components"></a>

**Pocz si z Twojego urzdzenia do Twojej VPC**

#### Pojcia

* **Punkt kocowy VPN klienta:** Zas贸b, kt贸ry tworzysz i konfigurujesz, aby umo偶liwi i zarzdza sesjami VPN klienta. Jest to zas贸b, w kt贸rym kocz si wszystkie sesje VPN klienta.
* **Sie docelowa:** Sie docelowa to sie, kt贸r powizujesz z punktem kocowym VPN klienta. **Podsie z VPC jest sieci docelow**. Powizanie podsieci z punktem kocowym VPN klienta umo偶liwia nawizanie sesji VPN. Mo偶esz powiza wiele podsieci z punktem kocowym VPN klienta w celu zapewnienia wysokiej dostpnoci. Wszystkie podsieci musz pochodzi z tej samej VPC. Ka偶da podsie musi nale偶e do innej strefy dostpnoci.
* **Trasa**: Ka偶dy punkt kocowy VPN klienta ma tablic tras, kt贸ra opisuje dostpne trasy sieci docelowych. Ka偶da trasa w tabeli tras okrela cie偶k dla ruchu do okrelonych zasob贸w lub sieci.
* **Zasady autoryzacji:** Zasada autoryzacji **ogranicza u偶ytkownik贸w, kt贸rzy mog uzyska dostp do sieci**. Dla okrelonej sieci konfigurujesz grup Active Directory lub dostawc to偶samoci (IdP), kt贸ry ma dostp. Tylko u偶ytkownicy nale偶cy do tej grupy mog uzyska dostp do okrelonej sieci. **Domylnie nie ma zasad autoryzacji** i musisz skonfigurowa zasady autoryzacji, aby umo偶liwi u偶ytkownikom dostp do zasob贸w i sieci.
* **Klient:** U偶ytkownik kocowy czcy si z punktem kocowym VPN klienta w celu nawizania sesji VPN. U偶ytkownicy kocowi musz pobra klienta OpenVPN i u偶y pliku konfiguracyjnego punktu kocowego VPN klienta, kt贸ry utworzye, aby nawiza sesj VPN.
* **Zakres CIDR klienta:** Zakres adres贸w IP, z kt贸rego przypisywane s adresy IP klient贸w. Ka偶de poczenie z punktem kocowym VPN klienta otrzymuje unikalny adres IP z zakresu CIDR klienta. Wybierasz zakres CIDR klienta, na przykad `10.2.0.0/16`.
* **Porty VPN klienta:** AWS Client VPN obsuguje porty 443 i 1194 zar贸wno dla protokou TCP, jak i UDP. Domylnie u偶ywany jest port 443.
* **Interfejsy sieci VPN klienta:** Po powizaniu podsieci z punktem kocowym VPN klienta, tworzymy interfejsy sieci VPN klienta w tej podsieci. **Ruch wysyany do VPC z punktu kocowego VPN klienta jest przesyany przez interfejs sieci VPN klienta**. Nastpnie stosowane jest tumaczenie adres贸w 藕r贸dowych sieci (SNAT), gdzie adres IP 藕r贸dowy z zakresu CIDR klienta jest tumaczony na adres IP interfejsu sieci VPN klienta.
* **Rejestrowanie pocze:** Mo偶esz wczy rejestrowanie pocze dla punktu kocowego VPN klienta, aby rejestrowa zdarzenia poczenia. Mo偶esz u偶y tych informacji do przeprowadzania analizy forensycznej, analizowania sposobu korzystania z punktu kocowego VPN klienta lub rozwizywania problem贸w z poczeniem.
* **Portal samoobsugowy:** Mo偶esz wczy portal samoobsugowy dla punktu kocowego VPN klienta. Klienci mog zalogowa si do portalu internetowego za pomoc swoich danych uwierzytelniajcych i pobra najnowsz wersj pliku konfiguracyjnego punktu kocowego VPN klienta lub najnowsz wersj klienta dostarczonego przez AWS.

#### Ograniczenia

* **Zakresy CIDR klienta nie mog si pokrywa z lokalnym CIDR** VPC, w kt贸rym znajduje si powizana podsie, ani z 偶adnymi rcznie dodanymi trasami do tabeli tras punktu kocowego VPN klienta.
* Zakresy CIDR klienta musz mie rozmiar bloku **co najmniej /22** i nie mog by wiksze ni偶 /12.
* **Cz adres贸w** w zakresie CIDR klienta jest u偶ywana do **obsugi modelu dostpnoci** punktu kocowego VPN klienta i nie mo偶e by przypisana klientom. Dlatego zalecamy, aby **przypisa blok CIDR zawierajcy dwa razy wicej adres贸w IP, ni偶 jest wymagane**, aby umo偶liwi maksymaln liczb jednoczesnych pocze, kt贸re planujesz obsu偶y na punkcie kocowym VPN klienta.
* **Zakres CIDR klienta nie mo偶e by zmieniony** po utworzeniu punktu kocowego VPN klienta.
* **Podsieci** powizane z punktem kocowym VPN klienta **musz znajdowa si w tej samej VPC**.
* **Nie mo偶na powiza wielu podsieci z tej samej strefy dostpnoci z punktem kocowym VPN klienta**.
* Punkt kocowy VPN klienta **nie obsuguje powiza podsieci w VPC o dedykowanej dzier偶awie**.
* VPN klienta obsuguje tylko ruch **IPv4**.
* VPN klienta **nie jest zgodny** z Federalnymi Standardami Przetwarzania Informacji (**FIPS**).
* Jeli wieloczynnikowe uwierzytelnianie (MFA) jest wyczone dla Twojego Active Directory, haso u偶ytkownika nie mo偶e mie nastpujcego formatu.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Portal samoobsugowy **nie jest dostpny dla klient贸w uwierzytelniajcych si za pomoc uwierzytelniania wzajemnego**.

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
