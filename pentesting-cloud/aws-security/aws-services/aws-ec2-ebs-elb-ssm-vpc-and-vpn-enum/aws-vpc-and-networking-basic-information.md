# AWS - Podstawowe informacje o VPC i sieciach

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Sieciowanie w AWS w piguce

**VPC** zawiera **CIDR sieci** np. 10.0.0.0/16 (z jego **tabel routingu** i **list ACL sieci**).

Ta sie VPC jest podzielona na **podsieci**, wic **podsie** jest bezporednio **powizana** z **VPC**, **tabel routingu** i **list ACL sieci**.

Nastpnie **Interfejsy sieciowe** podczone do usug (np. instancje EC2) s **poczone** z **podsieciami** za pomoc **grup zabezpiecze**.

Dlatego **grupa zabezpiecze** ograniczy wystawione porty **interfejs贸w sieciowych u偶ywajcych jej**, **niezale偶nie od podsieci**. A **lista ACL sieci** bdzie **ogranicza** wystawione porty dla **caej sieci**.

Ponadto, aby **uzyska dostp do Internetu**, istniej pewne interesujce konfiguracje do sprawdzenia:

* **Podsie** mo偶e **automatycznie przypisywa publiczne adresy IPv4**
* **Instancja** utworzona w sieci, kt贸ra **automatycznie przypisuje adresy IPv4, mo偶e otrzyma jeden**
* Do **VPC** musi by **doczony brama internetowa**
* Mo偶esz r贸wnie偶 u偶y **bram internetowych tylko do egress**
* Mo偶esz r贸wnie偶 mie **bram NAT** w **prywatnej podsieci**, dziki czemu mo偶liwe jest **poczenie z usugami zewntrznymi** z tej prywatnej podsieci, ale **nie mo偶na ich osign z zewntrz**.
* Brama NAT mo偶e by **publiczna** (dostp do Internetu) lub **prywatna** (dostp do innych VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) umo偶liwia **uruchamianie zasob贸w AWS w wirtualnej sieci**, kt贸r zdefiniowae. Ta wirtualna sie bdzie miaa kilka podsieci, Bramy Internetowe do dostpu do Internetu, ACL, Grupy zabezpiecze, IP...

### Podsieci

Podsieci pomagaj w egzekwowaniu wikszego poziomu bezpieczestwa. **Logiczne grupowanie podobnych zasob贸w** pomaga r贸wnie偶 w utrzymaniu **atwoci zarzdzania** w caej infrastrukturze.

* Poprawne CIDR to od maski sieci /16 do maski sieci /28.
* Podsie nie mo偶e znajdowa si jednoczenie w r贸偶nych strefach dostpnoci.
* **AWS zastrzega pierwsze trzy adresy IP hosta** ka偶dej podsieci **dla wewntrznego u偶ytku AWS**: pierwszy u偶ywany adres hosta jest dla routera VPC. Drugi adres jest zarezerwowany dla DNS AWS, a trzeci adres jest zarezerwowany na przysze u偶ycie.
* Nazywa si je **publicznymi podsieciami**, kt贸re maj **bezporedni dostp do Internetu, podczas gdy prywatne podsieci nie maj.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabele routingu

Tabele routingu okrelaj trasowanie ruchu dla podsieci w ramach VPC. Okrelaj, kt贸ry ruch sieciowy jest przekazywany do Internetu lub do poczenia VPN. Zazwyczaj znajdziesz dostp do:

* Lokalnego VPC
* NAT
* Bram Internetowych / Bram internetowych tylko do egress (potrzebne do zapewnienia VPC dostpu do Internetu).
* Aby uczyni podsie publiczn, musisz **utworzy** i **doczy** **bram internetow** do swojego VPC.
* Punkty kocowe VPC (do dostpu do S3 z prywatnych sieci)

Na poni偶szych obrazach mo偶esz sprawdzi r贸偶nice midzy domyln sieci publiczn a prywatn:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL

**Listy kontrolne dostpu do sieci (ACL)**: Listy ACL sieciowych to reguy zapory sieciowej kontrolujce ruch sieciowy przychodzcy i wychodzcy do podsieci. Mog by u偶ywane do zezwalania lub blokowania ruchu do okrelonych adres贸w IP lub zakres贸w.

* Najczciej zezwala si/blokuje dostp za pomoc grup zabezpiecze, ale jest to jedyny spos贸b na cakowite przerwanie ustanowionych powrotnych powok. Zmodyfikowana regua w grupach zabezpiecze nie zatrzymuje ju偶 ustanowionych pocze
* Jednak dotyczy to caej podsieci, wic bd藕 ostro偶ny, gdy zakazujesz czego, poniewa偶 potrzebna funkcjonalno mo偶e zosta zak贸cona
### Grupy zabezpiecze

Grupy zabezpiecze s wirtualnym **firewallem**, kt贸ry kontroluje ruch sieciowy **do i z instancji** w VPC. Zwizek 1 SG do M instancji (zazwyczaj 1 do 1).\
Zazwyczaj jest to u偶ywane do otwierania niebezpiecznych port贸w w instancjach, takich jak port 22 na przykad:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastyczne adresy IP

Adres _Elastic IP_ to **statyczny adres IPv4** zaprojektowany do dynamicznego oblicze w chmurze. Adres Elastic IP jest przydzielany do twojego konta AWS i pozostaje twoim do momentu jego zwolnienia. Korzystajc z adresu Elastic IP, mo偶esz ukry awari instancji lub oprogramowania, szybko przypisujc adres do innej instancji w twoim koncie.

### Poczenie midzy podsieciami

Domylnie wszystkie podsieci maj **automatyczne przypisywanie publicznych adres贸w IP wyczone**, ale mo偶na je wczy.

**Trasa lokalna w tabeli tras umo偶liwia komunikacj midzy podsieciami VPC**.

Jeli **czysz podsie z inn podsieci, nie mo偶esz uzyska dostpu do poczonych podsieci** z innej podsieci, musisz nawiza z nimi bezporednie poczenie. **Dotyczy to r贸wnie偶 bram internetowych**. Nie mo偶esz przej przez poczenie podsieci, aby uzyska dostp do internetu, musisz przypisa bram internetow do swojej podsieci.

### Peering VPC

Peering VPC pozwala na **poczenie dw贸ch lub wicej VPC** za pomoc IPV4 lub IPV6, jak gdyby byy czci tej samej sieci.

Po ustanowieniu poczenia midzy r贸wienikami, **zasoby w jednym VPC mog uzyska dostp do zasob贸w w drugim**. Poczenie midzy VPC jest realizowane za pomoc istniejcej infrastruktury sieciowej AWS, dlatego jest wysoce dostpne bez wskich garde w przepustowoci. Poniewa偶 **poczenia r贸wienicze dziaaj jakby byy czci tej samej sieci**, istniej ograniczenia dotyczce zakres贸w blok贸w CIDR, kt贸re mo偶na u偶y.\
Jeli masz **nakadajce si lub zduplikowane zakresy CIDR** dla swojego VPC, to **nie bdziesz m贸g zestawi poczenia midzy VPC**.\
Ka偶de VPC AWS **bdzie komunikowa si tylko ze swoim r贸wienikiem**. Na przykad, jeli masz poczenie r贸wienicze midzy VPC 1 i VPC 2, oraz inne poczenie midzy VPC 2 i VPC 3, jak pokazano, to VPC 1 i 2 mog komunikowa si ze sob bezporednio, podobnie jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mog. **Nie mo偶na kierowa ruchu przez jedno VPC, aby dosta si do innego.**

### **Logi przepywu VPC**

W ramach twojego VPC mo偶esz mie potencjalnie setki lub nawet tysice zasob贸w komunikujcych si midzy r贸偶nymi podsieciami, zar贸wno publicznymi, jak i prywatnymi, a tak偶e midzy r贸偶nymi VPC poprzez poczenia r贸wienicze VPC. **Logi przepywu VPC pozwalaj rejestrowa informacje o ruchu IP, kt贸ry przepywa midzy interfejsami sieciowymi twoich zasob贸w w ramach twojego VPC**.

W przeciwiestwie do log贸w dostpu S3 i log贸w dostpu CloudFront, **dane log贸w generowane przez logi przepywu VPC nie s przechowywane w S3. Zamiast tego przechwytywane dane log贸w s wysyane do log贸w CloudWatch**.

Ograniczenia:

* Jeli korzystasz z poczenia r贸wieniczego VPC, bdziesz m贸g zobaczy logi przepywu tylko z r贸wieniczych VPC znajdujcych si w tym samym koncie.
* Jeli nadal korzystasz z zasob贸w w rodowisku EC2-Classic, niestety nie bdziesz m贸g pobra informacji z ich interfejs贸w.
* Po utworzeniu logu przepywu VPC nie mo偶na go zmieni. Aby zmieni konfiguracj logu przepywu VPC, nale偶y go usun, a nastpnie utworzy nowy.
* Nastpujcy ruch nie jest monitorowany i przechwytywany przez logi. Ruch DHCP w ramach VPC, ruch z instancji przeznaczony do serwera DNS Amazona.
* Ruch kierowany do adresu IP domylnego routera VPC oraz ruch do i od nastpujcych adres贸w, 169.254.169.254, kt贸ry jest u偶ywany do zbierania metadanych instancji, oraz 169.254.169.123, kt贸ry jest u偶ywany do usugi synchronizacji czasu Amazona.
* Ruch zwizany z licencj aktywacji Windowsa od instancji systemu Windows.
* Ruch midzy interfejsem r贸wnowa偶enia obci偶enia sieci a interfejsem sieci kocowej

Dla ka偶dego interfejsu sieciowego publikujcego dane do grupy log贸w CloudWatch, zostanie u偶yty inny strumie log贸w. W ka偶dym z tych strumieni bdzie zawiera dane zdarze log贸w przepywu, kt贸re pokazuj zawarto wpis贸w log贸w. Ka偶dy z tych **log贸w rejestruje dane podczas okna czasowego trwajcego okoo 10 do 15 minut**.

## VPN

### Podstawowe skadniki AWS VPN

1. **Bramka klienta**:
* Bramka klienta to zas贸b, kt贸ry tworzysz w AWS, aby reprezentowa twoj stron poczenia VPN.
* Jest to w zasadzie fizyczne urzdzenie lub aplikacja oprogramowania po twojej stronie poczenia VPN typu miejsce-miejsce.
* Udostpniasz informacje o trasowaniu i publicznym adresie IP urzdzenia sieciowego (takiego jak router lub zapora ogniowa) AWS, aby utworzy bramk klienta.
* Su偶y jako punkt odniesienia do konfiguracji poczenia VPN i nie generuje dodatkowych opat.
2. **Wirtualna bramka prywatna**:
* Wirtualna bramka prywatna (VPG) to koncentrator VPN po stronie Amazonu w poczeniu VPN typu miejsce-miejsce.
* Jest doczona do twojego VPC i su偶y jako cel twojego poczenia VPN.
* VPG jest punktem kocowym AWS po stronie VPN.
* Obsuguje bezpieczn komunikacj midzy twoim VPC a twoj sieci lokaln.
3. **Poczenie VPN miejsce-miejsce**:
* Poczenie VPN miejsce-miejsce czy twoj sie lokaln z VPC poprzez bezpieczny tunel VPN IPsec.
* Ten rodzaj poczenia wymaga bramki klienta i wirtualnej bramki prywatnej.
* Su偶y do zapewnienia bezpiecznej, stabilnej i sp贸jnej komunikacji midzy twoim centrum danych lub sieci a rodowiskiem AWS.
* Zazwyczaj u偶ywane do regularnych, dugoterminowych pocze i rozliczane na podstawie iloci przesyanych danych w ramach poczenia.
4. **Punkt kocowy VPN klienta**:
* Punkt kocowy VPN klienta to zas贸b, kt贸ry tworzysz w AWS, aby umo偶liwi i zarzdza sesjami VPN klient贸w.
* Su偶y do umo偶liwienia indywidualnym urzdzeniom (takim jak laptopy, smartfony itp.) bezpiecznego poczenia z zasobami AWS lub twoj sieci lokaln.
* R贸偶ni si od poczenia VPN miejsce-miejsce tym, 偶e jest przeznaczony dla indywidualnych klient贸w, a nie do czenia caych sieci.
* W przypadku VPN klienta ka偶de urzdzenie klienta u偶ywa oprogramowania klienta VPN do nawizania bezpiecznego poczenia.

### Poczenie VPN miejsce-miejsce

**Pocz swoj sie lokaln z twoim VPC.**

* **Poczenie VPN**: Bezpieczne poczenie midzy twoim sprztem lokalnym a twoimi VPC.
* **Tunel VPN**: Zaszyfrowane poczenie, przez kt贸re dane mog przechodzi z sieci klienta do lub z AWS.

Ka偶de poczenie VPN zawiera dwa tunele VPN, kt贸re mo偶na jednoczenie wykorzystywa dla wysokiej dostpnoci.
* **Bramka klienta**: Zas贸b AWS, kt贸ry dostarcza informacje AWS o urzdzeniu bramki klienta.
* **Urzdzenie bramki klienta**: Fizyczne urzdzenie lub aplikacja oprogramowania po twojej stronie poczenia VPN miejsce-miejsce.
* **Wirtualna bramka prywatna**: Koncentrator VPN po stronie Amazonu w poczeniu VPN miejsce-miejsce. U偶ywasz wirtualnej bramki prywatnej lub bramki tranzytowej jako bramy po stronie Amazonu w poczeniu VPN miejsce-miejsce.
* **Bramka tranzytowa**: Centrum tranzytowe, kt贸re mo偶na u偶y do czenia twoich VPC i sieci lokalnych. U偶ywasz bramki tranzytowej lub wirtualnej bramki prywatnej jako bramy po stronie Amazonu w poczeniu VPN miejsce-miejsce.
#### Ograniczenia

* Ruch IPv6 nie jest obsugiwany dla pocze VPN na bramie prywatnej wirtualnej.
* Poczenie VPN AWS nie obsuguje odkrywania cie偶ki MTU.

Ponadto, we藕 pod uwag nastpujce kwestie podczas korzystania z VPN typu Site-to-Site.

### VPN klienta <a href="#what-is-components" id="what-is-components"></a>

**Pocz si ze swojego urzdzenia z VPC**

#### Pojcia

* **Punkt kocowy VPN klienta:** Zas贸b, kt贸ry tworzysz i konfigurujesz, aby umo偶liwi i zarzdza sesjami VPN klienta. Jest to zas贸b, w kt贸rym wszystkie sesje VPN klienta s zakoczone.
* **Sie docelowa:** Sie docelowa to sie, kt贸r czysz z punktem kocowym VPN klienta. **Podsie z VPC jest sieci docelow**. Powizanie podsieci z punktem kocowym VPN klienta umo偶liwia nawizanie sesji VPN. Mo偶esz powiza wiele podsieci z punktem kocowym VPN klienta dla wysokiej dostpnoci. Wszystkie podsieci musz pochodzi z tego samego VPC. Ka偶da podsie musi nale偶e do innej Strefy Dostpnoci.
* **Trasa**: Ka偶dy punkt kocowy VPN klienta ma tablic tras opisujc dostpne trasy sieci docelowych. Ka偶da trasa w tablicy tras okrela cie偶k dla ruchu do okrelonych zasob贸w lub sieci.
* **Reguy autoryzacji:** Regua autoryzacji **ogranicza u偶ytkownik贸w, kt贸rzy mog uzyska dostp do sieci**. Dla okrelonej sieci konfigurujesz grup Active Directory lub dostawc to偶samoci (IdP), kt贸ra ma prawo dostpu. Tylko u偶ytkownicy nale偶cy do tej grupy mog uzyska dostp do okrelonej sieci. **Domylnie nie ma regu autoryzacji** i musisz skonfigurowa reguy autoryzacji, aby umo偶liwi u偶ytkownikom dostp do zasob贸w i sieci.
* **Klient:** U偶ytkownik kocowy czcy si z punktem kocowym VPN klienta w celu nawizania sesji VPN. U偶ytkownicy kocowi musz pobra klienta OpenVPN i u偶y pliku konfiguracyjnego punktu kocowego VPN klienta, kt贸ry utworzye, aby nawiza sesj VPN.
* **Zakres CIDR klienta:** Zakres adres贸w IP, z kt贸rego przypisywane s adresy IP klient贸w. Ka偶de poczenie z punktem kocowym VPN klienta otrzymuje unikalny adres IP z zakresu CIDR klienta. Wybierasz zakres CIDR klienta, na przykad `10.2.0.0/16`.
* **Porty VPN klienta:** AWS Client VPN obsuguje porty 443 i 1194 zar贸wno dla protoko贸w TCP, jak i UDP. Domylnie jest to port 443.
* **Interfejsy sieci VPN klienta:** Gdy powi偶esz podsie z punktem kocowym VPN klienta, tworzymy interfejsy sieci VPN klienta w tej podsieci. **Ruch wysyany do VPC z punktu kocowego VPN klienta jest przesyany przez interfejs sieci VPN klienta**. Nastpnie stosowane jest tumaczenie adres贸w 藕r贸dowych sieci (SNAT), gdzie adres IP 藕r贸dowy z zakresu CIDR klienta jest tumaczony na adres IP interfejsu sieci VPN klienta.
* **Logowanie pocze:** Mo偶esz wczy logowanie pocze dla punktu kocowego VPN klienta, aby rejestrowa zdarzenia pocze. Mo偶esz u偶y tych informacji do przeprowadzania analizy ledczej, analizowania sposobu korzystania z punktu kocowego VPN klienta lub rozwizywania problem贸w z poczeniem.
* **Portal samoobsugowy:** Mo偶esz wczy portal samoobsugowy dla punktu kocowego VPN klienta. Klienci mog zalogowa si do portalu internetowego za pomoc swoich danych uwierzytelniajcych i pobra najnowsz wersj pliku konfiguracyjnego punktu kocowego VPN klienta lub najnowsz wersj klienta dostarczonego przez AWS.

#### Ograniczenia

* **Zakresy CIDR klienta nie mog si pokrywa z lokalnym CIDR** VPC, w kt贸rym znajduje si powizana podsie, ani z 偶adnymi trasami dodanymi rcznie do tablicy tras punktu kocowego VPN klienta.
* Zakresy CIDR klienta musz mie rozmiar bloku co najmniej **/22** i nie mog by wiksze ni偶 **/12**.
* **Cz adres贸w** w zakresie CIDR klienta jest u偶ywana do **wsparcia modelu dostpnoci** punktu kocowego VPN klienta i nie mog by przypisane klientom. Dlatego zalecamy, aby **przypisa blok CIDR zawierajcy dwukrotno liczby adres贸w IP wymaganych** do umo偶liwienia maksymalnej liczby r贸wnoczesnych pocze, kt贸re planujesz obsu偶y na punkcie kocowym VPN klienta.
* **Zakresu CIDR klienta nie mo偶na zmieni** po utworzeniu punktu kocowego VPN klienta.
* **Podsieci** powizane z punktem kocowym VPN klienta **musz znajdowa si w tym samym VPC**.
* **Nie mo偶na powiza wielu podsieci z tej samej Strefy Dostpnoci z punktem kocowym VPN klienta**.
* Punkt kocowy VPN klienta **nie obsuguje powiza podsieci w VPC o dedykowanej dzier偶awie**.
* VPN klienta obsuguje tylko ruch **IPv4**.
* VPN klienta **nie jest zgodny z Federalnymi Standardami Przetwarzania Informacji (FIPS)**.
*   Jeli wieloczynnikowa autoryzacja (MFA) jest wyczona dla Twojej usugi Active Directory, haso u偶ytkownika nie mo偶e mie nastpujcego formatu.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Portal samoobsugowy **nie jest dostpny dla klient贸w, kt贸rzy uwierzytelniaj si za pomoc uwierzytelniania wzajemnego**.
