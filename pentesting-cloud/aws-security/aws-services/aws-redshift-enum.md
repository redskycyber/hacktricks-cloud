# AWS - Redshift Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Amazon Redshift

Redshift to w peni zarzdzana usuga, kt贸ra mo偶e skalowa si do ponad petabajta i jest u偶ywana jako **magazyn danych dla rozwiza big data**. Korzystajc z klastr贸w Redshift, mo偶na wykonywa analizy na zbiorach danych za pomoc szybkich narzdzi zapyta opartych na SQL i aplikacji do inteligencji biznesowej, aby uzyska wiksze zrozumienie wizji dla swojego biznesu.

**Redshift oferuje szyfrowanie w spoczynku za pomoc czteropoziomowej hierarchii kluczy szyfrowania, korzystajc z KMS lub CloudHSM do zarzdzania najwy偶szym poziomem kluczy**. **Po wczeniu szyfrowania dla klastra nie mo偶na go wyczy, a vice versa**. Kiedy masz niezaszyfrowany klaster, nie mo偶na go zaszyfrowa.

Szyfrowanie dla klastra mo偶e odbywa si tylko podczas jego tworzenia, a po zaszyfrowaniu dane, metadane i wszelkie migawki s r贸wnie偶 szyfrowane. Poziomy hierarchii kluczy szyfrowania s nastpujce: **poziom pierwszy to klucz g贸wny, poziom drugi to klucz szyfrowania klastra (CEK), poziom trzeci to klucz szyfrowania bazy danych (DEK), a na koniec poziom czwarty to same klucze szyfrowania danych**.

### KMS

Podczas tworzenia klastra mo偶na wybra albo **domylny klucz KMS** dla Redshift, albo wybra **wasny CMK**, co daje wiksz elastyczno w kontroli klucza, zwaszcza z perspektywy audytu.

Domylny klucz KMS dla Redshift jest automatycznie tworzony przez Redshift przy pierwszym wybraniu opcji klucza i jest w peni zarzdzany przez AWS.

Ten klucz KMS jest nastpnie zaszyfrowany kluczem g贸wnym CMK, poziom pierwszy. Ten zaszyfrowany klucz danych KMS jest nastpnie u偶ywany jako klucz szyfrowania klastra, CEK, poziom drugi. Ten CEK jest nastpnie wysyany przez KMS do Redshift, gdzie jest przechowywany oddzielnie od klastra. Redshift nastpnie wysya ten zaszyfrowany CEK do klastra przez bezpieczny kana, gdzie jest przechowywany w pamici.

Redshift nastpnie 偶da od KMS odszyfrowania CEK, poziom drugi. Ten odszyfrowany CEK jest r贸wnie偶 przechowywany w pamici. Redshift nastpnie tworzy losowy klucz szyfrowania bazy danych, DEK, poziom trzeci, i wczytuje go do pamici klastra. Odszyfrowany CEK w pamici nastpnie szyfruje DEK, kt贸ry r贸wnie偶 jest przechowywany w pamici.

Ten zaszyfrowany DEK jest nastpnie wysyany przez bezpieczny kana i przechowywany w Redshift oddzielnie od klastra. Zar贸wno CEK, jak i DEK s teraz przechowywane w pamici klastra zar贸wno w zaszyfrowanej, jak i odszyfrowanej formie. Odszyfrowany DEK jest nastpnie u偶ywany do szyfrowania kluczy danych, poziom czwarty, kt贸re s losowo generowane przez Redshift dla ka偶dego bloku danych w bazie danych.

Mo偶esz u偶y AWS Trusted Advisor do monitorowania konfiguracji swoich kubek贸w Amazon S3 i upewnienia si, 偶e logowanie kubeka jest wczone, co mo偶e by przydatne do przeprowadzania audyt贸w bezpieczestwa i ledzenia wzorc贸w u偶ytkowania w S3.

### CloudHSM

<details>

<summary>Korzystanie z Redshift z CloudHSM</summary>

Pracujc z CloudHSM w celu wykonania szyfrowania, najpierw musisz skonfigurowa zaufane poczenie midzy klientem HSM a Redshift, korzystajc z certyfikat贸w klienta i serwera.

To poczenie jest wymagane do zapewnienia bezpiecznej komunikacji, umo偶liwiajcej wysyanie kluczy szyfrowania midzy klientem HSM a klastrami Redshift. Korzystajc z losowo generowanej pary kluczy prywatnego i publicznego, Redshift tworzy publiczny certyfikat klienta, kt贸ry jest szyfrowany i przechowywany przez Redshift. Musi by on pobrany i zarejestrowany w kliencie HSM, a nastpnie przypisany do odpowiedniej partycji HSM.

Nastpnie musisz skonfigurowa Redshift z nastpujcymi danymi dotyczcymi klienta HSM: adres IP HSM, nazw partycji HSM, haso partycji HSM i publiczny certyfikat serwera HSM, kt贸ry jest szyfrowany przez CloudHSM za pomoc wewntrznego klucza g贸wnego. Po dostarczeniu tych informacji Redshift potwierdzi i zweryfikuje, czy mo偶e nawiza poczenie i uzyska dostp do partycji deweloperskiej.

Jeli twoje wewntrzne polityki bezpieczestwa lub kontrole zarzdzania wymagaj rotacji kluczy, jest to mo偶liwe w Redshift, umo偶liwiajc rotacj kluczy szyfrowania dla zaszyfrowanych klastr贸w. Nale偶y jednak pamita, 偶e podczas procesu rotacji kluczy, klaster staje si niedostpny przez bardzo kr贸tki okres czasu, dlatego najlepiej rotowa klucze tylko wtedy, gdy jest to konieczne, lub jeli podejrzewasz, 偶e mogy zosta skompromitowane.

Podczas rotacji Redshift bdzie rotowa CEK dla klastra i dla wszystkich kopii zapasowych tego klastra. Rotuje DEK dla klastra, ale niemo偶liwe jest rotowanie DEK dla migawek przechowywanych w S3, kt贸re zostay zaszyfrowane za pomoc DEK. Klastr zostanie ustawiony w stanie "rotating keys" do momentu zakoczenia procesu, a nastpnie status wr贸ci do "available".

</details>

### Wyliczanie

```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Trwao

Nastpujce dziaania umo偶liwiaj udzielenie dostpu do klastra innym kontom AWS:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
