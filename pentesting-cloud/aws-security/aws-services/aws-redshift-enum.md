# AWS - Enum√©ration Redshift

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Amazon Redshift

Redshift est un service enti√®rement g√©r√© pouvant atteindre plus d'un p√©taoctet de taille, utilis√© comme **entrep√¥t de donn√©es pour les solutions de big data**. En utilisant des clusters Redshift, vous pouvez ex√©cuter des analyses sur vos ensembles de donn√©es √† l'aide d'outils de requ√™te rapides bas√©s sur SQL et d'applications d'intelligence d'affaires pour obtenir une meilleure compr√©hension de la vision de votre entreprise.

**Redshift offre un chiffrement au repos en utilisant une hi√©rarchie de quatre niveaux de cl√©s de chiffrement en utilisant soit KMS soit CloudHSM pour g√©rer le niveau sup√©rieur des cl√©s**. **Lorsque le chiffrement est activ√© pour votre cluster, il ne peut pas √™tre d√©sactiv√© et vice versa**. Lorsque vous avez un cluster non chiffr√©, il ne peut pas √™tre chiffr√©.

Le chiffrement de votre cluster ne peut se faire que lors de sa cr√©ation, et une fois chiffr√©, les donn√©es, les m√©tadonn√©es et toutes les instantan√©s sont √©galement chiffr√©s. Les niveaux de hi√©rarchie des cl√©s de chiffrement sont les suivants, **le premier niveau est la cl√© principale, le deuxi√®me niveau est la cl√© de chiffrement du cluster, le CEK, le troisi√®me niveau, la cl√© de chiffrement de la base de donn√©es, le DEK, et enfin le quatri√®me niveau, les cl√©s de chiffrement des donn√©es elles-m√™mes**.

### KMS

Lors de la cr√©ation de votre cluster, vous pouvez s√©lectionner soit la **cl√© KMS par d√©faut** pour Redshift, soit s√©lectionner votre **propre CMK**, ce qui vous donne plus de flexibilit√© sur le contr√¥le de la cl√©, notamment d'un point de vue auditable.

La cl√© KMS par d√©faut pour Redshift est automatiquement cr√©√©e par Redshift la premi√®re fois que l'option de cl√© est s√©lectionn√©e et utilis√©e, et elle est enti√®rement g√©r√©e par AWS.

Cette cl√© KMS est ensuite chiffr√©e avec la cl√© principale CMK, niveau un. Cette cl√© de donn√©es KMS chiffr√©e est ensuite utilis√©e comme cl√© de chiffrement du cluster, le CEK, niveau deux. Ce CEK est ensuite envoy√© par KMS √† Redshift o√π il est stock√© s√©par√©ment du cluster. Redshift envoie ensuite ce CEK chiffr√© au cluster via un canal s√©curis√© o√π il est stock√© en m√©moire.

Redshift demande ensuite √† KMS de d√©chiffrer le CEK, niveau deux. Ce CEK d√©chiffr√© est ensuite √©galement stock√© en m√©moire. Redshift cr√©e ensuite une cl√© de chiffrement de base de donn√©es al√©atoire, le DEK, niveau trois, et la charge dans la m√©moire du cluster. Le CEK d√©chiffr√© en m√©moire chiffre ensuite le DEK, qui est √©galement stock√© en m√©moire.

Ce DEK chiffr√© est ensuite envoy√© via un canal s√©curis√© et stock√© dans Redshift s√©par√©ment du cluster. Le CEK et le DEK sont maintenant stock√©s en m√©moire du cluster √† la fois sous forme chiffr√©e et d√©chiffr√©e. Le DEK d√©chiffr√© est ensuite utilis√© pour chiffrer les cl√©s de donn√©es, niveau quatre, qui sont g√©n√©r√©es de mani√®re al√©atoire par Redshift pour chaque bloc de donn√©es dans la base de donn√©es.

Vous pouvez utiliser AWS Trusted Advisor pour surveiller la configuration de vos compartiments Amazon S3 et vous assurer que le journalisation des compartiments est activ√©e, ce qui peut √™tre utile pour effectuer des audits de s√©curit√© et suivre les mod√®les d'utilisation dans S3.

### CloudHSM

<details>

<summary>Utilisation de Redshift avec CloudHSM</summary>

Lorsque vous travaillez avec CloudHSM pour effectuer votre chiffrement, vous devez d'abord √©tablir une connexion de confiance entre votre client HSM et Redshift en utilisant des certificats client et serveur.

Cette connexion est n√©cessaire pour fournir des communications s√©curis√©es, permettant l'envoi de cl√©s de chiffrement entre votre client HSM et vos clusters Redshift. En utilisant une paire de cl√©s priv√©e et publique g√©n√©r√©e de mani√®re al√©atoire, Redshift cr√©e un certificat client public, qui est chiffr√© et stock√© par Redshift. Celui-ci doit √™tre t√©l√©charg√© et enregistr√© sur votre client HSM, et attribu√© √† la partition HSM correcte.

Vous devez ensuite configurer Redshift avec les d√©tails suivants de votre client HSM : l'adresse IP du HSM, le nom de la partition HSM, le mot de passe de la partition HSM, et le certificat serveur HSM public, qui est chiffr√© par CloudHSM en utilisant une cl√© ma√Ætre interne. Une fois ces informations fournies, Redshift confirmera et v√©rifiera qu'il peut se connecter et acc√©der √† la partition de d√©veloppement.

Si vos politiques de s√©curit√© internes ou vos contr√¥les de gouvernance dictent que vous devez appliquer une rotation des cl√©s, cela est possible avec Redshift vous permettant de faire tourner les cl√©s de chiffrement pour les clusters chiffr√©s, cependant, vous devez √™tre conscient qu'au cours du processus de rotation des cl√©s, le cluster sera temporairement indisponible pendant une tr√®s courte p√©riode, il est donc pr√©f√©rable de ne faire tourner les cl√©s que lorsque vous en avez besoin, ou si vous pensez qu'elles ont pu √™tre compromises.

Pendant la rotation, Redshift fera tourner le CEK pour votre cluster et pour toutes les sauvegardes de ce cluster. Il fera tourner un DEK pour le cluster mais il n'est pas possible de faire tourner un DEK pour les instantan√©s stock√©s dans S3 qui ont √©t√© chiffr√©s √† l'aide du DEK. Il mettra le cluster dans un √©tat de 'rotation des cl√©s' jusqu'√† ce que le processus soit termin√©, moment o√π le statut reviendra √† 'disponible'.

</details>

### √ânum√©ration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## √âl√©vation de privil√®ges

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistance

Les actions suivantes permettent de donner acc√®s √† d'autres comptes AWS au cluster :

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
