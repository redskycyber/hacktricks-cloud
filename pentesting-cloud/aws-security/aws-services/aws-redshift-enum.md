# AWS - Redshift Enum

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Amazon Redshift

Redshift to w peÅ‚ni zarzÄ…dzana usÅ‚uga, ktÃ³ra moÅ¼e skalowaÄ‡ siÄ™ do ponad petabajta, ktÃ³ra jest uÅ¼ywana jako **magazyn danych dla rozwiÄ…zaÅ„ big data**. KorzystajÄ…c z klastrÃ³w Redshift, moÅ¼esz przeprowadzaÄ‡ analizy na swoich zbiorach danych za pomocÄ… szybkich narzÄ™dzi zapytaÅ„ opartych na SQL i aplikacji do inteligencji biznesowej, aby zdobyÄ‡ wiÄ™ksze zrozumienie wizji dla swojego biznesu.

**Redshift oferuje szyfrowanie w spoczynku za pomocÄ… czterostopniowej hierarchii kluczy szyfrowania, uÅ¼ywajÄ…c do zarzÄ…dzania najwyÅ¼szym poziomem kluczy KMS lub CloudHSM**. **Gdy szyfrowanie jest wÅ‚Ä…czone dla klastra, nie moÅ¼na go wyÅ‚Ä…czyÄ‡, i odwrotnie**. Gdy masz niezaszyfrowany klaster, nie moÅ¼na go zaszyfrowaÄ‡.

Szyfrowanie klastra moÅ¼e nastÄ…piÄ‡ tylko podczas jego tworzenia, a po zaszyfrowaniu dane, metadane i wszelkie migawki sÄ… rÃ³wnieÅ¼ szyfrowane. Poziomy hierarchii kluczy szyfrowania sÄ… nastÄ™pujÄ…ce: **poziom jeden to klucz gÅ‚Ã³wny, poziom dwa to klucz szyfrowania klastra, CEK, poziom trzy to klucz szyfrowania bazy danych, DEK, a na koÅ„cu poziom cztery to same klucze szyfrowania danych**.

### KMS

Podczas tworzenia klastra moÅ¼esz wybraÄ‡ albo **domyÅ›lny klucz KMS** dla Redshift, albo wybraÄ‡ **wÅ‚asny CMK**, co daje wiÄ™kszÄ… elastycznoÅ›Ä‡ w kontroli klucza, szczegÃ³lnie z perspektywy audytowej.

DomyÅ›lny klucz KMS dla Redshift jest automatycznie tworzony przez Redshift za pierwszym razem, gdy opcja klucza jest wybierana i uÅ¼ywana, i jest w peÅ‚ni zarzÄ…dzany przez AWS.

Ten klucz KMS jest nastÄ™pnie szyfrowany kluczem gÅ‚Ã³wnym CMK, poziom jeden. Ten zaszyfrowany klucz danych KMS jest nastÄ™pnie uÅ¼ywany jako klucz szyfrowania klastra, CEK, poziom dwa. Ten CEK jest nastÄ™pnie wysyÅ‚any przez KMS do Redshift, gdzie jest przechowywany oddzielnie od klastra. Redshift nastÄ™pnie wysyÅ‚a ten zaszyfrowany CEK do klastra przez bezpieczny kanaÅ‚, gdzie jest przechowywany w pamiÄ™ci.

Redshift nastÄ™pnie prosi KMS o odszyfrowanie CEK, poziom dwa. Ten odszyfrowany CEK jest rÃ³wnieÅ¼ przechowywany w pamiÄ™ci. Redshift nastÄ™pnie tworzy losowy klucz szyfrowania bazy danych, DEK, poziom trzy, i wczytuje go do pamiÄ™ci klastra. Odszyfrowany CEK w pamiÄ™ci szyfruje DEK, ktÃ³ry rÃ³wnieÅ¼ jest przechowywany w pamiÄ™ci.

Ten zaszyfrowany DEK jest nastÄ™pnie wysyÅ‚any przez bezpieczny kanaÅ‚ i przechowywany w Redshift oddzielnie od klastra. ZarÃ³wno CEK, jak i DEK sÄ… teraz przechowywane w pamiÄ™ci klastra zarÃ³wno w formie zaszyfrowanej, jak i odszyfrowanej. Odszyfrowany DEK jest nastÄ™pnie uÅ¼ywany do szyfrowania kluczy danych, poziom cztery, ktÃ³re sÄ… losowo generowane przez Redshift dla kaÅ¼dego bloku danych w bazie danych.

MoÅ¼esz uÅ¼yÄ‡ AWS Trusted Advisor do monitorowania konfiguracji swoich kubeÅ‚kÃ³w Amazon S3 i upewnienia siÄ™, Å¼e logowanie kubeÅ‚ka jest wÅ‚Ä…czone, co moÅ¼e byÄ‡ przydatne do przeprowadzania audytÃ³w bezpieczeÅ„stwa i Å›ledzenia wzorcÃ³w uÅ¼ycia w S3.

### CloudHSM

<details>

<summary>Korzystanie z Redshift z CloudHSM</summary>

PracujÄ…c z CloudHSM w celu przeprowadzenia szyfrowania, najpierw musisz ustanowiÄ‡ zaufane poÅ‚Ä…czenie miÄ™dzy klientem HSM a Redshift, korzystajÄ…c z certyfikatÃ³w klienta i serwera.

To poÅ‚Ä…czenie jest wymagane do zapewnienia bezpiecznej komunikacji, umoÅ¼liwiajÄ…c przesyÅ‚anie kluczy szyfrowania miÄ™dzy klientem HSM a klastrami Redshift. KorzystajÄ…c z losowo generowanej pary kluczy prywatnego i publicznego, Redshift tworzy publiczny certyfikat klienta, ktÃ³ry jest szyfrowany i przechowywany przez Redshift. NaleÅ¼y go pobraÄ‡ i zarejestrowaÄ‡ w kliencie HSM oraz przypisaÄ‡ do odpowiedniej partycji HSM.

NastÄ™pnie musisz skonfigurowaÄ‡ Redshift z nastÄ™pujÄ…cymi szczegÃ³Å‚ami twojego klienta HSM: adres IP HSM, nazwÄ™ partycji HSM, hasÅ‚o partycji HSM oraz publiczny certyfikat serwera HSM, ktÃ³ry jest szyfrowany przez CloudHSM za pomocÄ… wewnÄ™trznego klucza gÅ‚Ã³wnego. Po dostarczeniu tych informacji Redshift potwierdzi i zweryfikuje, czy moÅ¼e nawiÄ…zaÄ‡ poÅ‚Ä…czenie i uzyskaÄ‡ dostÄ™p do partycji deweloperskiej.

JeÅ›li twoje wewnÄ™trzne polityki bezpieczeÅ„stwa lub kontrole zarzÄ…dzania wymagajÄ…, abyÅ› stosowaÅ‚ rotacjÄ™ kluczy, jest to moÅ¼liwe z Redshift, umoÅ¼liwiajÄ…c obracanie kluczami szyfrowania dla zaszyfrowanych klastrÃ³w, jednak musisz byÄ‡ Å›wiadomy, Å¼e podczas procesu rotacji kluczy, klaster stanie siÄ™ niedostÄ™pny przez bardzo krÃ³tki okres czasu, dlatego najlepiej obracaÄ‡ klucze tylko wtedy, gdy jest to konieczne, lub jeÅ›li uwaÅ¼asz, Å¼e mogÅ‚y zostaÄ‡ skompromitowane.

Podczas rotacji Redshift obraca CEK dla twojego klastra i dla wszelkich kopii zapasowych tego klastra. Obraca DEK dla klastra, ale nie jest moÅ¼liwe obrÃ³cenie DEK dla migawek przechowywanych w S3, ktÃ³re zostaÅ‚y zaszyfrowane za pomocÄ… DEK. Klastra zostanie umieszczony w stanie â€rotacji kluczyâ€ do momentu zakoÅ„czenia procesu, po czym status powrÃ³ci do â€dostÄ™pnyâ€.

</details>

### Wyliczanie
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Eskalacja uprawnieÅ„

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## TrwaÅ‚oÅ›Ä‡

NastÄ™pujÄ…ce dziaÅ‚ania pozwalajÄ… na udzielenie dostÄ™pu do innego konta AWS do klastra:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Zacznij od zera i zostaÅ„ ekspertem AWS Red Team z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
