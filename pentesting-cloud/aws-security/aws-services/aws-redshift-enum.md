# AWS - Redshift Enum

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Amazon Redshift

Redshift je potpuno upravljana usluga koja mo쬰 da se skalira do preko petabajta, koja se koristi kao **data warehouse za re코enja velikih podataka**. Kori코캖enjem Redshift klastera, mo쬰te izvr코avati analitiku nad va코im skupovima podataka koriste캖i brze, SQL bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste stekli ve캖e razumevanje vizije za va코 posao.

**Redshift nudi 코ifrovanje u mirovanju koriste캖i 캜etvorostepenu hijerarhiju 코ifarskih klju캜eva koriste캖i ili KMS ili CloudHSM za upravljanje najvi코im nivoom klju캜eva**. **Kada je 코ifrovanje omogu캖eno za va코 klaster, ne mo쬰 se onemogu캖iti i obrnuto**. Kada imate ne코ifrovan klaster, ne mo쬰 se 코ifrovati.

말frovanje za va코 klaster mo쬰 se desiti samo tokom njegovog kreiranja, i jednom kada je 코ifrovan, podaci, metapodaci i bilo kakvi snimci su tako캠e 코ifrovani. Nivoi hijerarhije 코ifarskih klju캜eva su slede캖i, **nivo jedan je glavni klju캜, nivo dva je klju캜 za 코ifrovanje klastera, CEK, nivo tri, klju캜 za 코ifrovanje baze podataka, DEK, i na kraju nivo 캜etiri, sami klju캜evi za 코ifrovanje podataka**.

### KMS

Tokom kreiranja va코eg klastera, mo쬰te odabrati ili **podrazumevani KMS klju캜** za Redshift ili odabrati **sopstveni CMK**, 코to vam pru쬬 ve캖u fleksibilnost nad kontrolom klju캜a, posebno sa auditorske ta캜ke gledi코ta.

Podrazumevani KMS klju캜 za Redshift automatski se kreira od strane Redshift-a prvi put kada je opcija klju캜a odabrana i kori코캖ena, i potpuno je upravljan od strane AWS-a.

Ovaj KMS klju캜 se zatim 코ifruje sa CMK glavnim klju캜em, nivo jedan. Ovaj 코ifrovani KMS podatkovni klju캜 se zatim koristi kao klju캜 za 코ifrovanje klastera, CEK, nivo dva. Ovaj CEK se zatim 코alje od strane KMS-a Redshift-u gde se 캜uva odvojeno od klastera. Redshift zatim 코alje ovaj 코ifrovani CEK klasteru preko sigurnog kanala gde se 캜uva u memoriji.

Redshift zatim zahteva od KMS-a da de코ifruje CEK, nivo dva. Ovaj de코ifrovani CEK se zatim tako캠e 캜uva u memoriji. Redshift zatim kreira nasumi캜ni klju캜 za 코ifrovanje baze podataka, DEK, nivo tri, i u캜itava ga u memoriju klastera. De코ifrovani CEK u memoriji zatim 코ifruje DEK, koji se tako캠e 캜uva u memoriji.

Ovaj 코ifrovani DEK se zatim 코alje preko sigurnog kanala i 캜uva se u Redshift-u odvojeno od klastera. I CEK i DEK sada se 캜uvaju u memoriji klastera kako u 코ifrovanom tako i u de코ifrovanom obliku. De코ifrovani DEK se zatim koristi za 코ifrovanje klju캜eva podataka, nivo 캜etiri, koji su nasumi캜no generisani od strane Redshift-a za svaki blok podataka u bazi podataka.

Mo쬰te koristiti AWS Trusted Advisor za pra캖enje konfiguracije va코ih Amazon S3 kanti i osigurati da je vo캠enje evidencije kanti omogu캖eno, 코to mo쬰 biti korisno za obavljanje sigurnosnih revizija i pra캖enje obrazaca kori코캖enja u S3.

### CloudHSM

<details>

<summary>Kori코캖enje Redshift-a sa CloudHSM-om</summary>

Kada radite sa CloudHSM-om za obavljanje va코eg 코ifrovanja, prvo morate uspostaviti poverljivu vezu izme캠u va코eg HSM klijenta i Redshift-a koriste캖i klijentske i serverske sertifikate.

Ova veza je potrebna kako bi se obezbedile sigurne komunikacije, omogu캖avaju캖i slanje klju캜eva za 코ifrovanje izme캠u va코eg HSM klijenta i va코ih Redshift klastera. Koriste캖i nasumi캜no generisan par privatnog i javnog klju캜a, Redshift kreira javni klijentski sertifikat, koji je 코ifrovan i 캜uvan od strane Redshift-a. Ovaj sertifikat mora biti preuzet i registrovan na va코em HSM klijentu, i dodeljen odgovaraju캖oj HSM particiji.

Zatim morate konfigurisati Redshift sa slede캖im detaljima va코eg HSM klijenta: IP adresu HSM-a, ime particije HSM-a, lozinku particije HSM-a, i javni serverski sertifikat HSM-a, koji je 코ifrovan od strane CloudHSM-a koriste캖i interni glavni klju캜. Kada su ove informacije obezbe캠ene, Redshift 캖e potvrditi i verifikovati da mo쬰 da se pove쬰 i pristupi razvojnoj particiji.

Ako va코e interne sigurnosne politike ili upravlja캜ke kontrole diktiraju da morate primeniti rotaciju klju캜eva, onda je to mogu캖e sa Redshift-om omogu캖avaju캖i vam rotaciju 코ifarskih klju캜eva za 코ifrovane klastera, me캠utim, morate biti svesni da tokom procesa rotacije klju캜eva, klaster 캖e biti nedostupan vrlo kratko vreme, pa je najbolje rotirati klju캜eve samo kada je to potrebno, ili ako ose캖ate da su mo쬯a kompromitovani.

Tokom rotacije, Redshift 캖e rotirati CEK za va코 klaster i za sve rezervne kopije tog klastera. Rotira캖e DEK za klaster ali nije mogu캖e rotirati DEK za snimke sme코tene u S3 koji su 코ifrovani kori코캖enjem DEK-a. Stavi캖e klaster u stanje 'rotiranje klju캜eva' dok se proces ne zavr코i, kada 캖e status ponovo postati 'dostupan'.

</details>

### Enumeracija
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Eskalacija privilegija

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Upornost

Slede캖e radnje omogu캖avaju dodeljivanje pristupa drugim AWS nalozima klasteru:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
