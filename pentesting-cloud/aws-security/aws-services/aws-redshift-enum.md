# AWS - Redshift Enum

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Amazon Redshift

Redshift es un servicio completamente gestionado que puede escalar hasta m√°s de un petabyte de tama√±o, que se utiliza como un **almac√©n de datos para soluciones de big data**. Utilizando cl√∫steres de Redshift, puedes ejecutar an√°lisis contra tus conjuntos de datos utilizando herramientas de consulta r√°pidas basadas en SQL y aplicaciones de inteligencia empresarial para obtener una mayor comprensi√≥n y visi√≥n para tu negocio.

**Redshift ofrece cifrado en reposo utilizando una jerarqu√≠a de cuatro niveles de claves de cifrado utilizando KMS o CloudHSM para gestionar el nivel superior de claves**. **Cuando se habilita el cifrado para tu cl√∫ster, no se puede deshabilitar y viceversa**. Cuando tienes un cl√∫ster no cifrado, no se puede cifrar.

El cifrado para tu cl√∫ster solo puede ocurrir durante su creaci√≥n, y una vez cifrado, los datos, metadatos y cualquier instant√°nea tambi√©n est√°n cifrados. Los niveles de jerarqu√≠a de las claves de cifrado son los siguientes, **el nivel uno es la clave maestra, el nivel dos es la clave de cifrado del cl√∫ster, el CEK, el nivel tres, la clave de cifrado de la base de datos, el DEK, y finalmente el nivel cuatro, las claves de cifrado de datos en s√≠**.

### KMS

Durante la creaci√≥n de tu cl√∫ster, puedes seleccionar la **clave KMS predeterminada** para Redshift o seleccionar tu **propio CMK**, lo que te brinda m√°s flexibilidad sobre el control de la clave, espec√≠ficamente desde una perspectiva auditiva.

La clave KMS predeterminada para Redshift se crea autom√°ticamente por Redshift la primera vez que se selecciona y se utiliza la opci√≥n de clave, y es completamente gestionada por AWS.

Esta clave KMS luego se cifra con la clave maestra CMK, nivel uno. Esta clave de datos KMS cifrada se utiliza como la clave de cifrado del cl√∫ster, el CEK, nivel dos. Este CEK se env√≠a luego por KMS a Redshift donde se almacena por separado del cl√∫ster. Redshift luego env√≠a este CEK cifrado al cl√∫ster a trav√©s de un canal seguro donde se almacena en memoria.

Redshift luego solicita a KMS descifrar el CEK, nivel dos. Este CEK descifrado tambi√©n se almacena en memoria. Luego, Redshift crea una clave de cifrado de base de datos aleatoria, el DEK, nivel tres, y carga eso en la memoria del cl√∫ster. El CEK descifrado en memoria luego cifra el DEK, que tambi√©n se almacena en memoria.

Este DEK cifrado se env√≠a luego por un canal seguro y se almacena en Redshift por separado del cl√∫ster. Tanto el CEK como el DEK ahora se almacenan en la memoria del cl√∫ster tanto en forma cifrada como descifrada. El DEK descifrado se utiliza luego para cifrar las claves de datos, nivel cuatro, que son generadas aleatoriamente por Redshift para cada bloque de datos en la base de datos.

Puedes utilizar AWS Trusted Advisor para monitorear la configuraci√≥n de tus buckets de Amazon S3 y asegurarte de que el registro de buckets est√© habilitado, lo que puede ser √∫til para realizar auditor√≠as de seguridad y rastrear patrones de uso en S3.

### CloudHSM

<details>

<summary>Usando Redshift con CloudHSM</summary>

Al trabajar con CloudHSM para realizar tu cifrado, primero debes configurar una conexi√≥n de confianza entre tu cliente HSM y Redshift mientras usas certificados de cliente y servidor.

Esta conexi√≥n es necesaria para proporcionar comunicaciones seguras, permitiendo que las claves de cifrado se env√≠en entre tu cliente HSM y tus cl√∫steres de Redshift. Utilizando un par de claves privadas y p√∫blicas generadas aleatoriamente, Redshift crea un certificado de cliente p√∫blico, que se cifra y se almacena por Redshift. Este debe ser descargado y registrado en tu cliente HSM, y asignado a la partici√≥n HSM correcta.

Luego debes configurar Redshift con los siguientes detalles de tu cliente HSM: la direcci√≥n IP del HSM, el nombre de la partici√≥n HSM, la contrase√±a de la partici√≥n HSM y el certificado p√∫blico del servidor HSM, que est√° cifrado por CloudHSM utilizando una clave maestra interna. Una vez que se haya proporcionado esta informaci√≥n, Redshift confirmar√° y verificar√° que puede conectar y acceder a la partici√≥n de desarrollo.

Si tus pol√≠ticas de seguridad internas o controles de gobierno dictan que debes aplicar rotaci√≥n de claves, entonces esto es posible con Redshift permiti√©ndote rotar claves de cifrado para cl√∫steres cifrados, sin embargo, debes tener en cuenta que durante el proceso de rotaci√≥n de claves, har√° que un cl√∫ster no est√© disponible por un per√≠odo muy corto de tiempo, por lo que es mejor rotar las claves solo cuando sea necesario, o si sientes que pueden haber sido comprometidas.

Durante la rotaci√≥n, Redshift rotar√° el CEK para tu cl√∫ster y para cualquier respaldo de ese cl√∫ster. Rotar√° un DEK para el cl√∫ster pero no es posible rotar un DEK para las instant√°neas almacenadas en S3 que han sido cifradas usando el DEK. Pondr√° el cl√∫ster en un estado de 'rotaci√≥n de claves' hasta que se complete el proceso, momento en el que el estado volver√° a 'disponible'.

</details>

### Enumeraci√≥n

```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Elevaci√≥n de privilegios

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencia

Las siguientes acciones permiten otorgar acceso a otros cuentas de AWS al cl√∫ster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
