# AWS - KMS Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) es un servicio gestionado que facilita la **creaci√≥n y control de las claves maestras de clientes** (CMKs), las claves de cifrado utilizadas para cifrar tus datos. Las CMKs de AWS KMS est√°n **protegidas por m√≥dulos de seguridad de hardware** (HSMs).

KMS utiliza **criptograf√≠a sim√©trica**. Se utiliza para **cifrar informaci√≥n en reposo** (por ejemplo, dentro de un S3). Si necesitas **cifrar informaci√≥n en tr√°nsito**, debes usar algo como **TLS**.\
KMS es un **servicio espec√≠fico de la regi√≥n**.

**Los administradores de Amazon no tienen acceso a tus claves**. No pueden recuperar tus claves y no te ayudan con el cifrado de tus claves. AWS simplemente administra el sistema operativo y la aplicaci√≥n subyacente, depende de nosotros administrar nuestras claves de cifrado y c√≥mo se utilizan estas claves.

**Claves Maestras de Clientes** (CMK): Pueden cifrar datos de hasta 4KB de tama√±o. Se utilizan t√≠picamente para crear, cifrar y descifrar las DEKs (Claves de Cifrado de Datos). Luego, las DEKs se utilizan para cifrar los datos.

Una clave maestra de cliente (CMK) es una representaci√≥n l√≥gica de una clave maestra en AWS KMS. Adem√°s de los identificadores de la clave maestra y otros metadatos, incluyendo su fecha de creaci√≥n, descripci√≥n y estado de la clave, una **CMK contiene el material de la clave que se utiliza para cifrar y descifrar datos**. Cuando creas una CMK, por defecto, AWS KMS genera el material de la clave para esa CMK. Sin embargo, puedes optar por crear una CMK sin material de clave y luego importar tu propio material de clave en esa CMK.

Hay 2 tipos de claves maestras:

* **CMKs gestionadas por AWS: Utilizadas por otros servicios para cifrar datos**. Es utilizada por el servicio que la cre√≥ en una regi√≥n. Se rota cada 3 a√±os y no es posible cambiarla.
* **CMKs gestionadas por el cliente**: Flexibilidad, rotaci√≥n, acceso configurable y pol√≠tica de clave. Habilitar y deshabilitar claves.

**Cifrado de Sobre** en el contexto del Key Management Service (KMS): Sistema jer√°rquico de dos niveles para **cifrar datos con una clave de datos y luego cifrar la clave de datos con una clave maestra**.

### Pol√≠ticas de Claves

Estas definen **qui√©n puede usar y acceder a una clave en KMS**.

Por **defecto:**

*   Otorga al **cuenta de AWS que posee la clave KMS acceso completo** a la clave KMS.

A diferencia de otras pol√≠ticas de recursos de AWS, una **pol√≠tica de clave KMS no otorga autom√°ticamente permiso a la cuenta o a cualquiera de sus usuarios**. Para dar permiso a los administradores de la cuenta, la **pol√≠tica de clave debe incluir una declaraci√≥n expl√≠cita** que proporcione este permiso, como esta.

* Sin permitir a la cuenta (`"AWS": "arn:aws:iam::111122223333:root"`) los permisos de IAM no funcionar√°n.
*   Permite a la cuenta usar pol√≠ticas de IAM **para permitir el acceso a la clave KMS**, adem√°s de la pol√≠tica de clave.

**Sin este permiso, las pol√≠ticas de IAM que permiten el acceso a la clave son ineficaces**, aunque las pol√≠ticas de IAM que niegan el acceso a la clave siguen siendo efectivas.
* Reduce el riesgo de que la clave se vuelva ingobernable **otorgando permiso de control de acceso a los administradores de la cuenta**, incluido el usuario ra√≠z de la cuenta, que no se puede eliminar.

**Ejemplo de pol√≠tica por defecto:**
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si la **cuenta est√° permitida** (`"arn:aws:iam::111122223333:root"`), un **principal** de la cuenta **a√∫n necesitar√° permisos IAM** para usar la clave KMS. Sin embargo, si el **ARN** de un rol, por ejemplo, est√° **espec√≠ficamente permitido** en la **Pol√≠tica de Clave**, ese rol **no necesita permisos IAM**.
{% endhint %}

<details>

<summary>Detalles de la Pol√≠tica</summary>

Propiedades de una pol√≠tica:

* Documento basado en JSON
* Recurso --> Recursos afectados (puede ser "\*")
* Acci√≥n --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permisos)
* Efecto --> Permitir/Negar
* Principal --> arn afectado
* Condiciones (opcional) --> Condici√≥n para otorgar los permisos

Concesiones:

* Permiten delegar tus permisos a otro principal de AWS dentro de tu cuenta de AWS. Necesitas crearlas usando las APIs de AWS KMS. Se puede indicar el identificador de CMK, el principal beneficiario y el nivel requerido de operaci√≥n (Decrypt, Encrypt, GenerateDataKey...)
* Despu√©s de que se crea la concesi√≥n se emiten un GrantToken y un GrantID

**Acceso**:

* A trav√©s de la **pol√≠tica de clave** -- Si esta existe, tiene **precedencia** sobre la pol√≠tica IAM
* A trav√©s de la **pol√≠tica IAM**
* A trav√©s de **concesiones**

</details>

### Administradores de Claves

Administrador de claves por defecto:

* Tienen acceso para gestionar KMS pero no para cifrar o descifrar datos
* Solo usuarios y roles IAM pueden ser a√±adidos a la lista de Administradores de Claves (no grupos)
* Si se usa un CMK externo, los Administradores de Claves tienen permiso para importar material de clave

### Rotaci√≥n de CMKs

* Cuanto m√°s tiempo se deja la misma clave en su lugar, m√°s datos se cifran con esa clave, y si esa clave se ve comprometida, entonces mayor es el √°rea de impacto de los datos en riesgo. Adem√°s, cuanto m√°s tiempo est√© activa la clave, mayor es la probabilidad de que se vea comprometida.
* **KMS rota las claves de clientes cada 365 d√≠as** (o puedes realizar el proceso manualmente cuando quieras) y **las claves gestionadas por AWS cada 3 a√±os** y este tiempo no se puede cambiar.
* **Se retienen las claves antiguas** para descifrar datos que fueron cifrados antes de la rotaci√≥n
* En una violaci√≥n, rotar la clave no eliminar√° la amenaza ya que ser√° posible descifrar todos los datos cifrados con la clave comprometida. Sin embargo, **los nuevos datos se cifrar√°n con la nueva clave**.
* Si el **CMK** est√° en estado de **deshabilitado** o **pendiente de eliminaci√≥n**, KMS **no realizar√° una rotaci√≥n de clave** hasta que el CMK est√© habilitado nuevamente o se cancele la eliminaci√≥n.

#### Rotaci√≥n manual

* Se necesita **crear un nuevo CMK**, luego, se crea un nuevo CMK-ID, por lo que necesitar√°s **actualizar** cualquier **aplicaci√≥n** para **referenciar** el nuevo CMK-ID.
* Para hacer este proceso m√°s f√°cil puedes **usar alias para referirte a un key-id** y luego solo actualizar la clave a la que se refiere el alias.
* Necesitas **mantener las claves antiguas para descifrar archivos viejos** cifrados con ellas.

Puedes importar claves de tu infraestructura de claves local.

### Otra informaci√≥n relevante de KMS

KMS tiene un precio por n√∫mero de solicitudes de cifrado/descifrado recibidas de todos los servicios por mes.

KMS tiene completa **integraci√≥n de auditor√≠a y cumplimiento con CloudTrail**; aqu√≠ es donde puedes auditar todos los cambios realizados en KMS.

Con la pol√≠tica de KMS puedes hacer lo siguiente:

* Limitar qui√©n puede crear claves de datos y qu√© servicios tienen acceso para usar estas claves
* Limitar el acceso de sistemas solo para cifrar, solo para descifrar o ambos
* Definir para permitir que los sistemas accedan a claves a trav√©s de regiones (aunque no se recomienda ya que un fallo en la regi√≥n que aloja KMS afectar√° la disponibilidad de sistemas en otras regiones).

No puedes sincronizar o mover/copiar claves a trav√©s de regiones; solo puedes definir reglas para permitir acceso a trav√©s de regiones.

### Enumeraci√≥n
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Escalaci√≥n de Privilegios

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Explotaci√≥n

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
