# AWS - KMS Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizin **HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## KMS - Anahtar YÃ¶netimi Servisi

AWS Anahtar YÃ¶netimi Servisi (AWS KMS), kullanÄ±cÄ±larÄ±n **mÃ¼ÅŸteri anahtarlarÄ±nÄ± oluÅŸturup yÃ¶netmelerini** kolaylaÅŸtÄ±ran bir yÃ¶netilen hizmet olarak sunulur. Bu mÃ¼ÅŸteri anahtarlarÄ±, kullanÄ±cÄ± verilerinin ÅŸifrelenmesinde Ã¶nemli bir rol oynar. AWS KMS'nin dikkate deÄŸer bir Ã¶zelliÄŸi, mÃ¼ÅŸteri anahtarlarÄ±nÄ±n Ã§oÄŸunlukla **donanÄ±m gÃ¼venlik modÃ¼lleriyle** (HSM'ler) korunmasÄ±dÄ±r, bu da ÅŸifreleme anahtarlarÄ±nÄ±n korunmasÄ±nÄ± artÄ±rÄ±r.

KMS, **simetrik ÅŸifreleme** kullanÄ±r. Bu, bilgileri **dinlenme sÄ±rasÄ±nda** (Ã¶rneÄŸin, bir S3 iÃ§inde) ÅŸifrelemek iÃ§in kullanÄ±lÄ±r. Bilgileri **aktarÄ±m sÄ±rasÄ±nda ÅŸifrelemek** iÃ§in **TLS** gibi bir ÅŸey kullanmanÄ±z gerekmektedir.

KMS, **bÃ¶lgeye Ã¶zgÃ¼ bir hizmettir**.

**Amazon yÃ¶neticileri anahtarlarÄ±nÄ±za eriÅŸemez**. AnahtarlarÄ±nÄ±zÄ± kurtaramazlar ve anahtarlarÄ±nÄ±zÄ±n ÅŸifrelenmesine yardÄ±mcÄ± olmazlar. AWS sadece iÅŸletim sistemini ve altta yatan uygulamayÄ± yÃ¶netir, anahtarlarÄ±mÄ±zÄ±n ÅŸifrelemesini ve bu anahtarlarÄ±n nasÄ±l kullanÄ±ldÄ±ÄŸÄ±nÄ± yÃ¶netmek bizim sorumluluÄŸumuzdadÄ±r.

**MÃ¼ÅŸteri AnahtarlarÄ±** (CMK): 4KB boyutunda verileri ÅŸifreleyebilir. Genellikle DEK'leri (Veri Åifreleme AnahtarlarÄ±) oluÅŸturmak, ÅŸifrelemek ve ÅŸifrelemeyi Ã§Ã¶zmek iÃ§in kullanÄ±lÄ±rlar. ArdÄ±ndan DEK'ler veriyi ÅŸifrelemek iÃ§in kullanÄ±lÄ±r.

Bir mÃ¼ÅŸteri anahtarÄ± (CMK), AWS KMS'deki bir anahtarÄ±n mantÄ±ksal temsilidir. AnahtarÄ±n tanÄ±mlayÄ±cÄ±larÄ± ve diÄŸer meta verilerinin yanÄ± sÄ±ra oluÅŸturma tarihi, aÃ§Ä±klama ve anahtar durumu gibi bilgilerin yanÄ± sÄ±ra, bir **CMK, verileri ÅŸifrelemek ve ÅŸifrelemek iÃ§in kullanÄ±lan anahtar materyalini iÃ§erir**. Bir CMK oluÅŸturduÄŸunuzda, varsayÄ±lan olarak AWS KMS, o CMK iÃ§in anahtar materyali oluÅŸturur. Bununla birlikte, kendi anahtar materyalinizi iÃ§e aktarabileceÄŸiniz bir CMK oluÅŸturmayÄ± seÃ§ebilirsiniz.

Ä°ki tÃ¼r anahtar vardÄ±r:

* **AWS tarafÄ±ndan yÃ¶netilen CMK'lar: Verileri ÅŸifrelemek iÃ§in diÄŸer hizmetler tarafÄ±ndan kullanÄ±lÄ±r**. Ä°lk kez ÅŸifrelemeyi uyguladÄ±ÄŸÄ±nÄ±z hizmet tarafÄ±ndan kullanÄ±lÄ±r. Her 3 yÄ±lda bir dÃ¶ner ve deÄŸiÅŸtirilemez.
* **MÃ¼ÅŸteri tarafÄ±ndan yÃ¶netilen CMK'lar**: Esneklik, dÃ¶ndÃ¼rme, yapÄ±landÄ±rÄ±labilir eriÅŸim ve anahtar politikasÄ±. AnahtarlarÄ± etkinleÅŸtirme ve devre dÄ±ÅŸÄ± bÄ±rakma.

Anahtar YÃ¶netimi Servisi (KMS) baÄŸlamÄ±nda **Zarf Åifreleme**: Verileri **veri anahtarÄ± ile ÅŸifreleyip ardÄ±ndan veri anahtarÄ±nÄ± anahtar anahtarÄ± ile ÅŸifrelemek** iÃ§in iki katmanlÄ± hiyerarÅŸi sistemi.

### Anahtar PolitikalarÄ±

Bu, KMS'deki bir anahtarÄ± **kimin kullanabileceÄŸini ve eriÅŸebileceÄŸini tanÄ±mlar**.

**VarsayÄ±lan olarak:**

* KMS anahtarÄ±na sahip olan **AWS hesabÄ±na tam eriÅŸim** verir.

DiÄŸer AWS kaynak politikalarÄ±nÄ±n aksine, bir AWS **KMS anahtar politikasÄ± otomatik olarak hesaba veya kullanÄ±cÄ±larÄ±ndan herhangi birine izin vermez**. Hesap yÃ¶neticilerine izin vermek iÃ§in, bu izni saÄŸlayan **aÃ§Ä±k bir ifade iÃ§eren** bir anahtar politikasÄ± olmalÄ±dÄ±r, Ã¶rneÄŸin ÅŸu ÅŸekilde.

* Hesaba izin vermeden (`"AWS": "arn:aws:iam::111122223333:root"`) IAM izinleri Ã§alÄ±ÅŸmaz.
* KMS anahtarÄ±na eriÅŸimi saÄŸlamak iÃ§in IAM politikalarÄ±nÄ± kullanmasÄ±na izin verir, anahtar politikasÄ±na ek olarak.

**Bu izin olmadan, anahtara eriÅŸimi saÄŸlayan IAM politikalarÄ± etkisiz olur**, ancak anahtara eriÅŸimi reddeden IAM politikalarÄ± hala etkilidir.

* AnahtarÄ±n yÃ¶netilemez hale gelme riskini **azaltÄ±r**, hesap yÃ¶neticilerine, hesap kÃ¶k kullanÄ±cÄ±sÄ± dahil olmak Ã¼zere eriÅŸim kontrol izni vererek, bu kullanÄ±cÄ± silinemez.

**VarsayÄ±lan politika** Ã¶rneÄŸi:

```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```

{% hint style="warning" %}
EÄŸer hesap izin veriliyorsa (`"arn:aws:iam::111122223333:root"`), hesaptan bir **baÄŸlÄ±** bir **Ã¶zne**nin KMS anahtarÄ±nÄ± kullanabilmesi iÃ§in hala IAM izinlerine ihtiyacÄ± olacaktÄ±r. Ancak, bir rolÃ¼n ARN'si Ã¶rneÄŸin **Anahtar PolitikasÄ±'nda Ã¶zel olarak izin verilmiÅŸse**, bu rolÃ¼n IAM izinlerine ihtiyacÄ± olmayacaktÄ±r.
{% endhint %}

<details>

<summary>Politika DetaylarÄ±</summary>

PolitikanÄ±n Ã¶zellikleri:

* JSON tabanlÄ± belge
* Kaynak --> Etkilenen kaynaklar ("\*" olabilir)
* Eylem --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (izinler)
* Etki --> Ä°zin verme/Reddetme
* Ã–zne --> etkilenen arn
* KoÅŸullar (isteÄŸe baÄŸlÄ±) --> Ä°zinleri vermek iÃ§in koÅŸul

Ä°zinler:

* Ä°zinlerinizi AWS hesabÄ±nÄ±zdaki baÅŸka bir AWS Ã¶znesine devretmenize izin verir. BunlarÄ± AWS KMS API'lerini kullanarak oluÅŸturmanÄ±z gerekmektedir. CMK tanÄ±mlayÄ±cÄ±sÄ±, alÄ±cÄ± Ã¶zne ve gereken iÅŸlem dÃ¼zeyi (Decrypt, Encrypt, GenerateDataKey...) belirtilebilir.
* Ä°zin oluÅŸturulduktan sonra bir GrantToken ve bir GrantID verilir.

**EriÅŸim**:

* **Anahtar politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla -- EÄŸer varsa, bu IAM politikasÄ±nÄ±n Ã¼zerine **geÃ§erlidir**
* **IAM politikasÄ±** aracÄ±lÄ±ÄŸÄ±yla
* **Ä°zinler** aracÄ±lÄ±ÄŸÄ±yla

</details>

### Anahtar YÃ¶neticileri

VarsayÄ±lan olarak anahtar yÃ¶neticisi:

* KMS'yi yÃ¶netme eriÅŸimine sahip olur, ancak verileri ÅŸifrelemek veya ÅŸifresini Ã§Ã¶zmek iÃ§in eriÅŸimi yoktur
* YalnÄ±zca IAM kullanÄ±cÄ±larÄ± ve rolleri Anahtar YÃ¶neticileri listesine ekleyebilir (gruplar deÄŸil)
* Harici CMK kullanÄ±lÄ±yorsa, Anahtar YÃ¶neticileri anahtar materyali ithal etme iznine sahiptir

### CMK'larÄ±n DÃ¶ndÃ¼rÃ¼lmesi

* AynÄ± anahtar yerinde bÄ±rakÄ±ldÄ±kÃ§a, o anahtarla ÅŸifrelenen veri miktarÄ± artar ve o anahtar ihlal edilirse, verinin risk altÄ±nda olduÄŸu alan da geniÅŸler. Bunun yanÄ± sÄ±ra, anahtar ne kadar uzun sÃ¼re aktif kalÄ±rsa, ihlal edilme olasÄ±lÄ±ÄŸÄ± da artar.
* **KMS, mÃ¼ÅŸteri anahtarlarÄ±nÄ± her 365 gÃ¼nde bir dÃ¶ndÃ¼rÃ¼r** (veya istediÄŸiniz zaman manuel olarak gerÃ§ekleÅŸtirebilirsiniz) ve **AWS tarafÄ±ndan yÃ¶netilen anahtarlarÄ± her 3 yÄ±lda bir** dÃ¶ndÃ¼rÃ¼r ve bu sÃ¼re deÄŸiÅŸtirilemez.
* **Eski anahtarlar**, dÃ¶nÃ¼ÅŸÃ¼mden Ã¶nce ÅŸifrelenen verileri Ã§Ã¶zmek iÃ§in saklanÄ±r.
* Bir kÄ±rÄ±lma durumunda, anahtarÄ± dÃ¶ndÃ¼rmek tehdidi kaldÄ±rmaz Ã§Ã¼nkÃ¼ kompromize edilen anahtarla ÅŸifrelenen tÃ¼m verileri Ã§Ã¶zmek mÃ¼mkÃ¼n olacaktÄ±r. Bununla birlikte, **yeni veriler yeni anahtarla ÅŸifrelenir**.
* **CMK** devre dÄ±ÅŸÄ± veya silme bekleyen durumdaysa, KMS, CMK yeniden etkinleÅŸtirilene veya silme iptal edilene kadar **anahtar dÃ¶ndÃ¼rme iÅŸlemi gerÃ§ekleÅŸtirmez**.

#### Manuel dÃ¶ndÃ¼rme

* Yeni bir CMK oluÅŸturmanÄ±z gerekmektedir, ardÄ±ndan yeni bir CMK tanÄ±mlayÄ±cÄ±sÄ± oluÅŸturulur, bu nedenle herhangi bir **uygulamayÄ± gÃ¼ncellemek** iÃ§in **yeni CMK tanÄ±mlayÄ±cÄ±sÄ±na baÅŸvurmanÄ±z gerekir**.
* Bu iÅŸlemi kolaylaÅŸtÄ±rmak iÃ§in bir anahtar kimliÄŸine baÅŸvurmak iÃ§in **takma adlarÄ± kullanabilirsiniz** ve ardÄ±ndan takma adÄ±n baÅŸvurduÄŸu anahtarÄ± gÃ¼ncelleyebilirsiniz.
* Eski dosyalarla ÅŸifrelenmiÅŸ eski dosyalarÄ± Ã§Ã¶zmek iÃ§in **eski anahtarlarÄ± saklamanÄ±z gerekmektedir**.

Kendi yerinde anahtar altyapÄ±nÄ±zdan anahtarlarÄ± iÃ§e aktarabilirsiniz.

### DiÄŸer ilgili KMS bilgileri

KMS, tÃ¼m hizmetlerden alÄ±nan ÅŸifreleme/ÅŸifre Ã§Ã¶zme isteklerinin sayÄ±sÄ±na gÃ¶re fiyatlandÄ±rÄ±lÄ±r.

KMS, CloudTrail ile tam denetim ve uyum **entegrasyonuna sahiptir**; burada KMS Ã¼zerinde gerÃ§ekleÅŸtirilen tÃ¼m deÄŸiÅŸiklikleri denetleyebilirsiniz.

KMS politikasÄ± ile aÅŸaÄŸÄ±dakileri yapabilirsiniz:

* Kimlerin veri anahtarlarÄ± oluÅŸturabileceÄŸini ve bu anahtarlarÄ± kullanma eriÅŸimine sahip olan hizmetleri sÄ±nÄ±rlayabilirsiniz
* Sistemlerin sadece ÅŸifreleme, sadece ÅŸifre Ã§Ã¶zme veya her ikisine eriÅŸimini sÄ±nÄ±rlayabilirsiniz
* Sistemlerin anahtarlara bÃ¶lgesel olarak eriÅŸmesine izin vermek iÃ§in tanÄ±mlayabilirsiniz (ancak KMS'i barÄ±ndÄ±ran bÃ¶lgede bir arÄ±za, diÄŸer bÃ¶lgelerdeki sistemlerin kullanÄ±labilirliÄŸini etkileyeceÄŸi iÃ§in Ã¶nerilmez).

AnahtarlarÄ± senkronize edemez veya bÃ¶lgeler arasÄ±nda taÅŸÄ±yamaz/kopyalayamazsÄ±nÄ±z; yalnÄ±zca bÃ¶lgeye eriÅŸime izin vermek iÃ§in kurallar belirleyebilirsiniz.

### NumaralandÄ±rma

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```

### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### KalÄ±cÄ±lÄ±k

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
