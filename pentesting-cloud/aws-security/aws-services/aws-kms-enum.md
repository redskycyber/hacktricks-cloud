# AWS - KMS Enum

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) jest prezentowany jako usuga zarzdzana, upraszczajca proces **tworzenia i zarzdzania kluczami g贸wnymi klienta** (CMK). Te CMK s integralne w szyfrowaniu danych u偶ytkownika. Istotn cech AWS KMS jest to, 偶e CMK s g贸wnie **zabezpieczane przez moduy sprztowe do zabezpieczania** (HSM), co zwiksza ochron kluczy szyfrowania.

KMS u偶ywa **szyfrowania symetrycznego**. Jest to u偶ywane do **szyfrowania informacji w spoczynku** (na przykad wewntrz S3). Jeli chcesz **szyfrowa informacje w transporcie**, musisz u偶y czego takiego jak **TLS**.

KMS to **usuga specyficzna dla regionu**.

**Administratorzy w Amazonie nie maj dostpu do Twoich kluczy**. Nie mog odzyska Twoich kluczy i nie pomagaj Ci w szyfrowaniu Twoich kluczy. AWS po prostu administruje systemem operacyjnym i podstawow aplikacj, to my sami administrujemy naszymi kluczami szyfrowania i administrujemy tym, jak te klucze s u偶ywane.

**Klucze g贸wne klienta** (CMK): Mog szyfrowa dane o wielkoci do 4 KB. Zazwyczaj s u偶ywane do tworzenia, szyfrowania i deszyfrowania DEK (Data Encryption Keys). Nastpnie DEK s u偶ywane do szyfrowania danych.

Klucz g贸wny klienta (CMK) to logiczne przedstawienie klucza g贸wnego w AWS KMS. Opr贸cz identyfikator贸w klucza g贸wnego i innych metadanych, takich jak data utworzenia, opis i stan klucza, **CMK zawiera materia klucza, kt贸ry jest u偶ywany do szyfrowania i deszyfrowania danych**. Tworzc CMK, domylnie AWS KMS generuje materia klucza dla tego CMK. Jednak mo偶esz wybra utworzenie CMK bez materiau klucza, a nastpnie zaimportowa wasny materia klucza do tego CMK.

Istniej 2 rodzaje kluczy g贸wnych:

* **Zarzdzane przez AWS CMK: U偶ywane przez inne usugi do szyfrowania danych**. Jest u偶ywany przez usug, kt贸ra go utworzya w regionie. S one tworzone przy pierwszym wdro偶eniu szyfrowania w tej usudze. Rotuj co 3 lata i nie mo偶na ich zmieni.
* **Klucze g贸wne klienta**: Elastyczno, rotacja, konfigurowalny dostp i polityka klucza. Wczanie i wyczanie kluczy.

**Szyfrowanie kopertowe** w kontekcie Key Management Service (KMS): Dwupoziomowy system hierarchii do **szyfrowania danych kluczem danych, a nastpnie szyfrowania klucza danych kluczem g贸wnym**.

### Polityki kluczy

Okrelaj, **kto mo偶e u偶ywa i uzyskiwa dostp do klucza w KMS**.

Domylnie:

*   Daje **kontu AWS, kt贸re jest wacicielem klucza KMS, peny dostp** do klucza KMS.

W przeciwiestwie do innych polityk zasob贸w AWS, polityka klucza AWS **KMS nie daje automatycznie uprawnie do konta ani 偶adnego z jego u偶ytkownik贸w**. Aby da uprawnienia administratorom konta, **polityka klucza musi zawiera jawn deklaracj**, kt贸ra zapewnia te uprawnienia, tak jak ta.

* Bez zezwolenia konta (`"AWS": "arn:aws:iam::111122223333:root"`) uprawnienia IAM nie bd dziaa.
*   Pozwala kontu na korzystanie z polityk IAM, aby umo偶liwi dostp do klucza KMS, opr贸cz polityki klucza.

**Bez tego uprawnienia, polityki IAM, kt贸re pozwalaj na dostp do klucza, s nieskuteczne**, chocia偶 polityki IAM, kt贸re odmawiaj dostpu do klucza, nadal s skuteczne.
* Zmniejsza ryzyko, 偶e klucz stanie si niezarzdzalny, udzielajc uprawnie do kontroli dostpu administratorom konta, w tym u偶ytkownikowi g贸wnemu konta, kt贸ry nie mo偶e zosta usunity.

Przykad **domylnej polityki**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Jeli **konto jest dozwolone** (`"arn:aws:iam::111122223333:root"`), **podmiot** z konta **nadal bdzie potrzebowa uprawnie IAM** do u偶ycia klucza KMS. Jednak, jeli **ARN** roli na przykad jest **specjalnie dozwolony** w **Polityce Klucza**, ta rola **nie bdzie potrzebowa uprawnie IAM**.
{% endhint %}

<details>

<summary>Szczeg贸y polityki</summary>

Waciwoci polityki:

* Dokument oparty na JSON
* Zas贸b --> Dotknite zasoby (mo偶e by "\*")
* Akcja --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (uprawnienia)
* Efekt --> Allow/Deny
* Podmiot --> dotknity arn
* Warunki (opcjonalne) --> Warunek, aby nada uprawnienia

Uprawnienia:

* Pozwala na delegowanie uprawnie do innego podmiotu AWS w ramach Twojego konta AWS. Musisz je tworzy za pomoc interfejs贸w API AWS KMS. Mo偶na wskaza identyfikator CMK, podmiot uprawniony i wymagany poziom operacji (Decrypt, Encrypt, GenerateDataKey...)
* Po utworzeniu upowa偶nienia wydawane s GrantToken i GratID

**Dostp**:

* Za pomoc **polityki klucza** -- Jeli istnieje, to ma **prymat** nad polityk IAM
* Za pomoc **polityki IAM**
* Za pomoc **uprawnie**

</details>

### Administratorzy kluczy

Domylnie administratorzy kluczy:

* Maj dostp do zarzdzania KMS, ale nie do szyfrowania ani deszyfrowania danych
* Do listy Administrator贸w kluczy mo偶na doda tylko u偶ytkownik贸w i role IAM (nie grupy)
* Jeli u偶ywany jest zewntrzny CMK, Administratorzy kluczy maj uprawnienie do importowania materiau klucza

### Rotacja CMKs

* Im du偶ej ten sam klucz pozostaje na swoim miejscu, tym wicej danych jest szyfrowanych tym kluczem, a jeli ten klucz zostanie naruszony, to szerszy obszar danych jest zagro偶ony. Opr贸cz tego, im du偶ej klucz jest aktywny, tym wiksze jest prawdopodobiestwo jego naruszenia.
* **KMS obraca klucze klienta co 365 dni** (lub mo偶na wykona proces rcznie, kiedykolwiek chcesz) i **klucze zarzdzane przez AWS co 3 lata** i tego czasu nie mo偶na zmieni.
* **Starsze klucze s przechowywane**, aby odszyfrowa dane, kt贸re byy szyfrowane przed rotacj
* W przypadku naruszenia, obr贸t klucza nie usunie zagro偶enia, poniewa偶 bdzie mo偶liwe odszyfrowanie wszystkich danych zaszyfrowanych kluczem, kt贸ry zosta naruszony. Jednak **nowe dane bd szyfrowane nowym kluczem**.
* Jeli **CMK** jest w stanie **wyczonym** lub **oczekujcym** **usunicia**, KMS **nie bdzie wykonywa rotacji klucza**, dop贸ki CMK nie zostanie ponownie wczony lub usunicie nie zostanie anulowane.

#### Rczna rotacja

* Nale偶y utworzy **nowy CMK**, a nastpnie utworzy nowy identyfikator CMK, wic trzeba **zaktualizowa** dowoln **aplikacj**, aby **odwoywaa si** do nowego identyfikatora CMK.
* Aby uatwi ten proces, mo偶na **u偶y alias贸w do odwoywania si do identyfikatora klucza** i nastpnie zaktualizowa klucz, do kt贸rego odwouje si alias.
* Nale偶y **zachowa stare klucze, aby odszyfrowa stare pliki**, kt贸re zostay zaszyfrowane za ich pomoc.

Mo偶na importowa klucze z infrastruktury kluczy lokalnych.

### Inne istotne informacje o KMS

KMS jest wyceniany na podstawie liczby 偶da szyfrowania/deszyfrowania otrzymanych od wszystkich usug miesicznie.

KMS ma pen integracj z audytem i zgodnoci **CloudTrail**; tutaj mo偶na przeglda wszystkie zmiany wykonane w KMS.

Z polityk KMS mo偶na zrobi nastpujce rzeczy:

* Ograniczy, kto mo偶e tworzy klucze danych i kt贸re usugi maj dostp do tych kluczy
* Ograniczy dostp system贸w do tylko szyfrowania, tylko deszyfrowania lub obu
* Zdefiniowa, aby umo偶liwi systemom dostp do kluczy w r贸偶nych regionach (cho nie jest to zalecane, poniewa偶 awaria w regionie hostujcym KMS wpynie na dostpno system贸w w innych regionach).

Nie mo偶na synchronizowa ani przenosi/kopiowa kluczy midzy regionami; mo偶na tylko zdefiniowa zasady, kt贸re umo偶liwiaj dostp midzy regionami.

### Wyliczenie
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
