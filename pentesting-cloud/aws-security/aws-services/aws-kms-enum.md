# AWS - KMS Enum

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## KMS - Upravljanje klju캜evima

AWS Key Management Service (AWS KMS) je predstavljen kao upravljana usluga, pojednostavljuju캖i proces korisnicima da **kreiraju i upravljaju glavnim klju캜evima korisnika** (CMKs). Ovi CMK-ovi su klju캜ni za enkripciju korisni캜kih podataka. Zna캜ajna karakteristika AWS KMS-a je da su CMK-ovi uglavnom **za코ti캖eni hardverskim sigurnosnim modulima** (HSM), pobolj코avaju캖i za코titu enkripcijskih klju캜eva.

KMS koristi **simetri캜nu kriptografiju**. Ovo se koristi za **enkripciju informacija u stanju mirovanja** (na primer, unutar S3). Ako treba da **enkriptujete informacije u tranzitu** morate koristiti ne코to poput **TLS**.

KMS je **usluga specifi캜na za region**.

**Administratori u Amazonu nemaju pristup va코im klju캜evima**. Oni ne mogu povratiti va코e klju캜eve i ne poma쬿 vam pri enkripciji va코ih klju캜eva. AWS jednostavno upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo na코im enkripcijskim klju캜evima i na캜inom na koji se ti klju캜evi koriste.

**Glavni klju캜evi korisnika** (CMK): Mogu enkriptovati podatke do veli캜ine od 4KB. Obi캜no se koriste za kreiranje, enkripciju i dekripciju DEK-ova (Data Encryption Keys). Zatim se DEK-ovi koriste za enkripciju podataka.

Glavni klju캜 korisnika (CMK) je logi캜ka reprezentacija glavnog klju캜a u AWS KMS-u. Pored identifikatora glavnog klju캜a i drugih metapodataka, uklju캜uju캖i datum kreiranja, opis i stanje klju캜a, **CMK sadr쬴 klju캜ni materijal koji se koristi za enkripciju i dekripciju podataka**. Kada kreirate CMK, prema podrazumevanim pode코avanjima, AWS KMS generi코e klju캜ni materijal za taj CMK. Me캠utim, mo쬰te izabrati da kreirate CMK bez klju캜nog materijala i zatim uvezete svoj vlastiti klju캜ni materijal u taj CMK.

Postoje 2 vrste glavnih klju캜eva:

* **AWS upravljani CMK-ovi: Kori코캖eni od strane drugih usluga za enkripciju podataka**. Koristi ih usluga koja ga je kreirala u regionu. Kreiraju se prvi put kada implementirate enkripciju u toj usluzi. Rotiraju se svake 3 godine i nije mogu캖e ih promeniti.
* **Korisni캜ki upravljani CMK-ovi**: Fleksibilnost, rotacija, konfigurabilan pristup i politika klju캜eva. Omogu캖avaju uklju캜ivanje i isklju캜ivanje klju캜eva.

**Envelopna enkripcija** u kontekstu Key Management Service (KMS): Dvoslojni hijerarhijski sistem za **enkripciju podataka sa klju캜em podataka, a zatim enkripciju klju캜a podataka sa glavnim klju캜em**.

### Politike klju캜eva

Ove defini코u **ko mo쬰 koristiti i pristupiti klju캜u u KMS-u**.

Po **podrazumevanim pode코avanjima:**

*   Daje **AWS nalogu koji je vlasnik KMS klju캜a pun pristup** klju캜u KMS.

Za razliku od drugih AWS politika resursa, AWS **KMS klju캜na politika ne daje automatski dozvolu nalogu ili bilo kojem od njegovih korisnika**. Da bi se dozvola dala administratorima naloga, **klju캜na politika mora uklju캜ivati eksplicitnu izjavu** koja pru쬬 ovu dozvolu, kao 코to je ova.

* Bez dozvole naloga (`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole ne캖e raditi.
*   To **omogu캖ava nalogu da koristi IAM politike** kako bi omogu캖io pristup KMS klju캜u, pored klju캜ne politike.

**Bez ove dozvole, IAM politike koje omogu캖avaju pristup klju캜u su neefikasne**, iako IAM politike koje zabranjuju pristup klju캜u i dalje su efikasne.
* To **smanjuje rizik da klju캜 postane neupravljivim** davanjem dozvole za kontrolu pristupa administratorima naloga, uklju캜uju캖i korisnika glavnog naloga, koji ne mo쬰 biti obrisan.

**Primer podrazumevane politike**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`) **principal** iz naloga 캖e i dalje trebati IAM dozvole da koristi KMS klju캜. Me캠utim, ako je **ARN** uloge na primer **specifi캜no dozvoljen** u **Key Policy**, ta uloga **ne캖e trebati IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji politike</summary>

Svojstva politike:

* Dokument zasnovan na JSON-u
* Resurs --> Pogo캠eni resursi (mo쬰 biti "\*")
* Akcija --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Efekat --> Dozvoli/Odbij
* Principal --> arn pogo캠en
* Uslovi (opciono) --> Uslovi za davanje dozvola

Dodele:

* Dozvoljavaju delegiranje va코ih dozvola drugom AWS principalu unutar va코eg AWS naloga. Morate ih kreirati koriste캖i AWS KMS API-je. Mo쬰 se nazna캜iti identifikator CMK-a, princip koji prima dozvolu i potrebni nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon 코to je dodela kreirana, izdaju se GrantToken i GrantID

**Pristup**:

* Putem **key policy** -- Ako postoji, ova politika ima **prednost** nad IAM politikom
* Putem **IAM politike**
* Putem **dodela**

</details>

### Administratori klju캜eva

Administrator klju캜eva po podrazumevanju:

* Imaju pristup upravljanju KMS-om ali ne i 코ifrovanju ili de코ifrovanju podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu Administratora klju캜eva (ne grupe)
* Ako se koristi spoljni CMK, Administratori klju캜eva imaju dozvolu za uvoz klju캜nog materijala

### Rotacija CMK-ova

* 맚o se du쬰 isti klju캜 zadr쬴 na mestu, vi코e podataka je 코ifrovano tim klju캜em, i ako taj klju캜 bude kompromitovan, ve캖a je povr코ina podataka u riziku. Pored toga, 코to je klju캜 du쬰 aktivan, pove캖ava se verovatno캖a da bude kompromitovan.
* **KMS rotira korisni캜ke klju캜eve svakih 365 dana** (ili mo쬰te ru캜no izvr코iti proces kada god 쬰lite) i **klju캜eve koje upravlja AWS svake 3 godine** i ovaj period se ne mo쬰 promeniti.
* **Stari klju캜evi se zadr쬬vaju** da bi de코ifrovali podatke koji su bili 코ifrovani pre rotacije
* U slu캜aju kompromitovanja, rotiranje klju캜a ne캖e ukloniti pretnju jer 캖e biti mogu캖e de코ifrovati sve podatke 코ifrovane kompromitovanim klju캜em. Me캠utim, **novi podaci 캖e biti 코ifrovani novim klju캜em**.
* Ako je **CMK** u stanju **onemogu캖en** ili **캜eka** **brisanje**, KMS **ne캖e izvr코iti rotaciju klju캜a** dok se CMK ponovo ne omogu캖i ili se brisanje ne otka쬰.

#### Ru캜na rotacija

* Potrebno je **kreirati novi CMK**, zatim se kreira novi CMK-ID, tako da 캖e biti potrebno **a쬿rirati** svaku **aplikaciju** da **referencira** novi CMK-ID.
* Da biste olak코ali ovaj proces, mo쬰te **koristiti alijase za referenciranje klju캜a** i zatim samo a쬿rirati klju캜 na koji se alijas odnosi.
* Morate **zadr쬬ti stare klju캜eve da biste de코ifrovali stare datoteke** 코ifrovane tim klju캜em.

Mo쬰te uvesti klju캜eve iz va코e infrastrukture klju캜eva na lokaciji.

### Ostale relevantne informacije o KMS-u

KMS se napla캖uje po broju zahteva za 코ifrovanje/de코ifrovanje primljenih od svih usluga mese캜no.

KMS ima potpunu integraciju sa CloudTrail-om za reviziju i uskla캠enost; ovde mo쬰te pregledati sve promene izvr코ene na KMS-u.

Pomo캖u KMS politike mo쬰te uraditi slede캖e:

* Ograni캜iti ko mo쬰 kreirati klju캜eve podataka i koje usluge imaju pristup kori코캖enju tih klju캜eva
* Ograni캜iti pristup sistemima samo za 코ifrovanje, samo za de코ifrovanje ili za oba
* Definisati da omogu캖ite sistemima pristup klju캜evima preko regiona (iako se ne preporu캜uje jer kvar u regionu koji hostuje KMS 캖e uticati na dostupnost sistema u drugim regionima).

Ne mo쬰te sinhronizovati ili premestiti/kopirati klju캜eve preko regiona; mo쬰te samo definisati pravila da dozvolite pristup preko regiona.

### Enumeracija
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Povi코enje privilegija

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post eksploatacija

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
