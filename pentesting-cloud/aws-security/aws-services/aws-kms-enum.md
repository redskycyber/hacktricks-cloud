# AWS - KMS Enum

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Usuga zarzdzania kluczami

AWS Key Management Service (AWS KMS) jest prezentowany jako usuga zarzdzana, upraszczajca proces tworzenia i zarzdzania **kluczami g贸wnymi klienta** (CMK). Te CMK s integralne w szyfrowaniu danych u偶ytkownika. Istotn cech AWS KMS jest to, 偶e CMK s g贸wnie **zabezpieczone przez moduy bezpieczestwa sprztowego** (HSM), zwikszajc ochron kluczy szyfrowania.

KMS u偶ywa **kryptografii symetrycznej**. Jest to u偶ywane do **szyfrowania informacji w spoczynku** (na przykad wewntrz S3). Jeli potrzebujesz **szyfrowa informacje w transporcie**, musisz u偶y czego takiego jak **TLS**.

KMS to **usuga specyficzna dla regionu**.

**Administratorzy w Amazonie nie maj dostpu do Twoich kluczy**. Nie mog odzyska Twoich kluczy i nie pomagaj Ci w szyfrowaniu Twoich kluczy. AWS po prostu administruje systemem operacyjnym i aplikacj bazow, to od nas zale偶y administrowanie naszymi kluczami szyfrowania i administrowanie tym, jak te klucze s u偶ywane.

**Klucze g贸wne klienta** (CMK): Mog szyfrowa dane o wielkoci do 4 KB. Zazwyczaj s u偶ywane do tworzenia, szyfrowania i deszyfrowania DEK贸w (Kluczy Szyfrowania Danych). Nastpnie DEK s u偶ywane do szyfrowania danych.

Klucz g贸wny klienta (CMK) to logiczna reprezentacja klucza g贸wnego w AWS KMS. Opr贸cz identyfikator贸w klucza g贸wnego i innych metadanych, w tym daty utworzenia, opisu i stanu klucza, **CMK zawiera materia klucza, kt贸ry jest u偶ywany do szyfrowania i deszyfrowania danych**. Podczas tworzenia CMK, domylnie AWS KMS generuje materia klucza dla tego CMK. Mo偶esz jednak wybra utworzenie CMK bez materiau klucza, a nastpnie zaimportowa sw贸j wasny materia klucza do tego CMK.

Istniej 2 rodzaje kluczy g贸wnych:

* **Zarzdzane przez AWS CMK: U偶ywane przez inne usugi do szyfrowania danych**. Jest u偶ywany przez usug, kt贸ra go utworzya w regionie. S tworzone za pierwszym razem, gdy implementujesz szyfrowanie w tej usudze. Rotuj co 3 lata i nie mo偶na ich zmieni.
* **Klucze g贸wne klienta**: Elastyczno, rotacja, konfigurowalny dostp i polityka klucza. Wczanie i wyczanie kluczy.

**Szyfrowanie kopertowe** w kontekcie Usugi Zarzdzania Kluczami (KMS): Dwupoziomowy system hierarchii do **szyfrowania danych kluczem danych, a nastpnie szyfrowania klucza danych kluczem g贸wnym**.

### Polityki kluczy

Okrelaj one **kto mo偶e u偶ywa i uzyskiwa dostp do klucza w KMS**.

Domylnie:

*   Daje **kontowi AWS, kt贸re jest wacicielem klucza KMS, peny dostp** do klucza KMS.

W przeciwiestwie do innych polityk zasob贸w AWS, polityka klucza AWS **KMS nie daje automatycznie uprawnie do konta ani jego u偶ytkownik贸w**. Aby nada uprawnienia administratorom konta, **polityka klucza musi zawiera wyra藕ne owiadczenie**, kt贸re zapewnia te uprawnienia, takie jak to.

* Bez zezwolenia na konto (`"AWS": "arn:aws:iam::111122223333:root"`) uprawnienia IAM nie bd dziaa.
*   **Zezwala kontu na korzystanie z polityk IAM** do umo偶liwienia dostpu do klucza KMS, opr贸cz polityki klucza.

**Bez tego uprawnienia, polityki IAM, kt贸re pozwalaj na dostp do klucza, s nieskuteczne**, chocia偶 polityki IAM, kt贸re odmawiaj dostpu do klucza, nadal s skuteczne.
*   **Zmniejsza ryzyko, 偶e klucz stanie si niezarzdzalny**, nadajc uprawnienia kontroli dostpu administratorom konta, w tym u偶ytkownikowi g贸wnemu konta, kt贸ry nie mo偶e zosta usunity.

Przykad **domylnej polityki**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Jeli **konto jest dozwolone** (`"arn:aws:iam::111122223333:root"`) **podmiot z konta wci偶 bdzie potrzebowa uprawnie IAM** do u偶ycia klucza KMS. Jednak偶e, jeli **ARN** roli na przykad jest **specjalnie dozwolony** w **Polityce Klucza**, ta rola **nie bdzie potrzebowa uprawnie IAM**.
{% endhint %}

<details>

<summary>Szczeg贸y Polityki</summary>

Waciwoci polityki:

* Dokument oparty na JSON
* Zas贸b --> Dotknite zasoby (mo偶e by "\*")
* Akcja --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (uprawnienia)
* Efekt --> Allow/Deny
* Podmiot --> dotknity arn
* Warunki (opcjonalne) --> Warunek do udzielenia uprawnie

Uprawnienia:

* Pozwala na delegowanie uprawnie do innego podmiotu AWS w ramach konta AWS. Musisz je tworzy za pomoc interfejs贸w API AWS KMS. Mo偶na wskaza identyfikator CMK, podmiot beneficjenta i wymagany poziom operacji (Decrypt, Encrypt, GenerateDataKey...)
* Po utworzeniu upowa偶nienia wydawane s GrantToken i GratID

**Dostp**:

* Poprzez **polityk klucza** -- Jeli istnieje, to ma **najwy偶szy priorytet** nad polityk IAM
* Poprzez **polityk IAM**
* Poprzez **uprawnienia**

</details>

### Administratorzy Klucza

Domylnie administratorzy klucza:

* Maj dostp do zarzdzania KMS, ale nie do szyfrowania ani deszyfrowania danych
* Tylko u偶ytkownicy IAM i role mog by dodane do listy Administrator贸w Klucza (nie grupy)
* Jeli u偶ywany jest zewntrzny CMK, Administratorzy Klucza maj uprawnienie do importowania materiau klucza

### Rotacja CMKs

* Im du偶ej ten sam klucz pozostaje na swoim miejscu, tym wicej danych jest szyfrowanych tym kluczem, a jeli ten klucz zostanie naruszony, to obszar ryzyka danych jest szerszy. Ponadto, im du偶ej klucz jest aktywny, tym wiksze jest prawdopodobiestwo jego naruszenia.
* **KMS obraca klucze klienta co 365 dni** (lub mo偶na wykona proces rcznie w dowolnym momencie) i **klucze zarzdzane przez AWS co 3 lata** i tego czasu nie mo偶na zmieni.
* **Starsze klucze s zachowywane** do deszyfrowania danych, kt贸re zostay zaszyfrowane przed rotacj
* W przypadku naruszenia, obr贸t klucza nie usunie zagro偶enia, poniewa偶 bdzie mo偶liwe deszyfrowanie wszystkich danych zaszyfrowanych skompromitowanym kluczem. Jednak偶e, **nowe dane bd szyfrowane nowym kluczem**.
* Jeli **CMK** jest w stanie **wyczonym** lub **oczekujcym na usunicie**, KMS **nie bdzie wykonywa rotacji klucza** dop贸ki CMK nie zostanie ponownie wczony lub usunicie nie zostanie anulowane.

#### Rczna rotacja

* Musi zosta utworzony **nowy CMK**, nastpnie, tworzy si nowe ID CMK, wic trzeba **zaktualizowa** ka偶d **aplikacj**, aby **odnosia si** do nowego ID CMK.
* Aby uatwi ten proces, mo偶na **u偶y alias贸w do odwoywania si do identyfikatora klucza** i nastpnie zaktualizowa klucz, do kt贸rego odwouje si alias.
* Nale偶y **zachowa stare klucze do deszyfrowania starych plik贸w** zaszyfrowanych nimi.

Mo偶na importowa klucze z infrastruktury kluczy na miejscu.

### Inne istotne informacje o KMS

KMS jest wyceniany za liczb 偶da szyfrowania/deszyfrowania otrzymanych od wszystkich usug miesicznie.

KMS ma pen integracj z audytem i zgodnoci **z CloudTrail**; tutaj mo偶na audytowa wszystkie zmiany dokonane w KMS.

Z polityk KMS mo偶na zrobi nastpujce rzeczy:

* Ograniczy, kto mo偶e tworzy klucze danych i kt贸re usugi maj dostp do u偶ywania tych kluczy
* Ograniczy dostp system贸w do szyfrowania tylko, deszyfrowania tylko lub obu
* Zdefiniowa, aby umo偶liwi systemom dostp do kluczy midzy regionami (cho nie jest to zalecane, poniewa偶 awaria w regionie hostujcym KMS wpynie na dostpno system贸w w innych regionach).

Nie mo偶na synchronizowa ani przenosi/kopiowa kluczy midzy regionami; mo偶na jedynie zdefiniowa zasady umo偶liwiajce dostp midzy regionami.

### Wyliczenie
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Eskalacja uprawnie

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Trwao

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Odnoniki

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Zdobd藕 wiedz na temat hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
