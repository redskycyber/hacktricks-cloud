# AWS - MSKæšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Amazon MSK

Amazon **Managed Streaming for Apache Kafka**ï¼ˆAmazon MSKï¼‰æ˜¯ä¸€é¡¹å®Œå…¨æ‰˜ç®¡çš„æœåŠ¡ï¼Œä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå’Œè¿è¡Œä½¿ç”¨**Apache Kafkaå¤„ç†æµæ•°æ®**çš„åº”ç”¨ç¨‹åºã€‚Amazon MSKæä¾›äº†æ§åˆ¶å¹³é¢æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤**é›†ç¾¤**ã€‚\
å®ƒå…è®¸æ‚¨ä½¿ç”¨Apache **Kafkaæ•°æ®å¹³é¢æ“ä½œ**ï¼Œä¾‹å¦‚ç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®ã€‚å®ƒè¿è¡Œ**Apache Kafkaçš„å¼€æºç‰ˆæœ¬**ã€‚è¿™æ„å‘³ç€ç°æœ‰çš„åº”ç”¨ç¨‹åºã€å·¥å…·å’Œæ¥è‡ªåˆä½œä¼™ä¼´å’Œ**Apache Kafkaç¤¾åŒºçš„æ’ä»¶**éƒ½å¾—åˆ°æ”¯æŒï¼Œè€Œæ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚

Amazon MSKå¯ä»¥**æ£€æµ‹å¹¶è‡ªåŠ¨ä»æœ€å¸¸è§çš„æ•…éšœåœºæ™¯ä¸­æ¢å¤**ï¼Œä»¥ä¾¿æ‚¨çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åº”ç”¨ç¨‹åºå¯ä»¥ç»§ç»­è¿›è¡Œå†™å…¥å’Œè¯»å–æ“ä½œï¼Œå¯¹ä¸šåŠ¡å½±å“æœ€å°ã€‚æ­¤å¤–ï¼Œå°½å¯èƒ½åœ°ï¼Œå®ƒä¼š**é‡ç”¨æ—§çš„** **broker** çš„å­˜å‚¨ï¼Œä»¥**å‡å°‘Apache Kafkaéœ€è¦å¤åˆ¶çš„æ•°æ®é‡**ã€‚

### **ç±»å‹**

AWSå…è®¸åˆ›å»ºä¸¤ç§ç±»å‹çš„Kafkaé›†ç¾¤ï¼šProvisionedï¼ˆé¢„é…ç½®ï¼‰å’ŒServerlessï¼ˆæ— æœåŠ¡å™¨ï¼‰ã€‚

ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨éœ€è¦çŸ¥é“ä»¥ä¸‹å†…å®¹ï¼š

* **Serverlessæ— æ³•ç›´æ¥å…¬å¼€**ï¼ˆåªèƒ½åœ¨æ²¡æœ‰å…¬å¼€IPçš„VPNä¸­è¿è¡Œï¼‰ã€‚ç„¶è€Œï¼Œ**Provisioned**å¯ä»¥é…ç½®ä¸ºè·å–**å…¬å…±IP**ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šï¼‰ï¼Œå¹¶é…ç½®**å®‰å…¨ç»„**ä»¥**å…¬å¼€**ç›¸å…³ç«¯å£ã€‚
* **Serverlessä»…æ”¯æŒIAM**ä½œä¸ºèº«ä»½éªŒè¯æ–¹æ³•ã€‚**Provisioned**æ”¯æŒSASL/SCRAMï¼ˆ**å¯†ç **ï¼‰èº«ä»½éªŒè¯ã€IAMèº«ä»½éªŒè¯ã€AWS **Certificate** Managerï¼ˆACMï¼‰èº«ä»½éªŒè¯å’Œ**æœªç»èº«ä»½éªŒè¯**çš„è®¿é—®ã€‚
* è¯·æ³¨æ„ï¼Œå¦‚æœå¯ç”¨äº†æœªç»èº«ä»½éªŒè¯çš„è®¿é—®ï¼Œæ— æ³•å…¬å¼€æš´éœ²Provisioned Kafka

### æšä¸¾
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Kafka IAMè®¿é—®ï¼ˆåœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸­ï¼‰

AWS Managed Streaming for Apache Kafka (MSK) is a fully managed service that makes it easy to build and run applications that use Apache Kafka to process streaming data. When using MSK in a serverless environment, it is important to properly configure IAM access to ensure the security of your Kafka cluster.

#### IAM Roles for MSK

To grant IAM access to MSK, you can create IAM roles with the necessary permissions. These roles can be attached to AWS Lambda functions or other AWS resources that need to interact with the Kafka cluster.

#### Permissions for MSK IAM Roles

The IAM roles for MSK should have the following permissions:

- `kafka:DescribeCluster` - Allows the role to describe the Kafka cluster.
- `kafka:ListClusters` - Allows the role to list all available Kafka clusters.
- `kafka:GetBootstrapBrokers` - Allows the role to get the bootstrap brokers for the Kafka cluster.
- `kafka:Connect` - Allows the role to connect to the Kafka cluster.
- `kafka:Describe*` - Allows the role to describe various Kafka resources, such as topics, configurations, and consumer groups.
- `kafka:Create*` - Allows the role to create various Kafka resources, such as topics and configurations.
- `kafka:Delete*` - Allows the role to delete various Kafka resources, such as topics and configurations.
- `kafka:Alter*` - Allows the role to alter various Kafka resources, such as topics and configurations.
- `kafka:DescribeAcls` - Allows the role to describe the access control lists (ACLs) for the Kafka cluster.
- `kafka:CreateAcls` - Allows the role to create ACLs for the Kafka cluster.
- `kafka:DeleteAcls` - Allows the role to delete ACLs for the Kafka cluster.

#### Example IAM Policy

Here is an example IAM policy that grants the necessary permissions for MSK IAM roles:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kafka:DescribeCluster",
        "kafka:ListClusters",
        "kafka:GetBootstrapBrokers",
        "kafka:Connect",
        "kafka:Describe*",
        "kafka:Create*",
        "kafka:Delete*",
        "kafka:Alter*",
        "kafka:DescribeAcls",
        "kafka:CreateAcls",
        "kafka:DeleteAcls"
      ],
      "Resource": "*"
    }
  ]
}
```

#### Conclusion

Properly configuring IAM access for MSK in a serverless environment is crucial for maintaining the security of your Kafka cluster. By creating IAM roles with the necessary permissions, you can ensure that only authorized resources can interact with your Kafka cluster.
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### ææƒ

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„è®¿é—®

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### æŒä¹…æ€§

å¦‚æœæ‚¨å°†**è®¿é—® Provisioned Kafka æ‰€åœ¨çš„ VPC**ï¼Œæ‚¨å¯ä»¥**å¯ç”¨æœªç»æˆæƒçš„è®¿é—®**ï¼Œå¦‚æœä½¿ç”¨äº†**SASL/SCRAM è®¤è¯**ï¼Œå¯ä»¥ä»å¯†é’¥ä¸­**è¯»å–**å¯†ç ï¼Œç»™ä¸€äº›**å…¶ä»–å—æ§ç”¨æˆ· IAM æƒé™**ï¼ˆå¦‚æœä½¿ç”¨äº† IAM æˆ–æ— æœåŠ¡å™¨ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨**è¯ä¹¦**è¿›è¡ŒæŒä¹…åŒ–ã€‚

## å‚è€ƒèµ„æ–™

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨ **Twitter** ä¸Š **å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
