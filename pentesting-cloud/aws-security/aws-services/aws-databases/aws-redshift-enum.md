# AWS - Redshiftæšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘**[**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Amazon Redshift

Redshiftæ˜¯ä¸€ä¸ªå®Œå…¨æ‰˜ç®¡çš„æœåŠ¡ï¼Œå¯ä»¥æ‰©å±•åˆ°è¶…è¿‡ä¸€PBçš„å¤§å°ï¼Œç”¨ä½œ**å¤§æ•°æ®è§£å†³æ–¹æ¡ˆçš„æ•°æ®ä»“åº“**ã€‚ä½¿ç”¨Redshifté›†ç¾¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¿«é€Ÿçš„åŸºäºSQLçš„æŸ¥è¯¢å·¥å…·å’Œå•†ä¸šæ™ºèƒ½åº”ç”¨ç¨‹åºå¯¹æ•°æ®é›†è¿›è¡Œåˆ†æï¼Œä»¥æ›´å¥½åœ°äº†è§£æ‚¨çš„ä¸šåŠ¡æ„¿æ™¯ã€‚

**Redshiftæä¾›äº†ä½¿ç”¨å››å±‚åŠ å¯†å¯†é’¥å±‚æ¬¡ç»“æ„è¿›è¡Œçš„é™æ€åŠ å¯†ï¼Œä½¿ç”¨KMSæˆ–CloudHSMæ¥ç®¡ç†é¡¶å±‚å¯†é’¥**ã€‚**å¯ç”¨é›†ç¾¤çš„åŠ å¯†åï¼Œæ— æ³•ç¦ç”¨åŠ å¯†ï¼Œåä¹‹äº¦ç„¶**ã€‚å½“æ‚¨æ‹¥æœ‰ä¸€ä¸ªæœªåŠ å¯†çš„é›†ç¾¤æ—¶ï¼Œæ— æ³•å¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚

é›†ç¾¤çš„åŠ å¯†åªèƒ½åœ¨åˆ›å»ºæœŸé—´è¿›è¡Œï¼Œä¸€æ—¦åŠ å¯†ï¼Œæ•°æ®ã€å…ƒæ•°æ®å’Œä»»ä½•å¿«ç…§ä¹Ÿå°†è¢«åŠ å¯†ã€‚åŠ å¯†å¯†é’¥çš„åˆ†å±‚çº§åˆ«å¦‚ä¸‹ï¼Œ**ç¬¬ä¸€å±‚æ˜¯ä¸»å¯†é’¥ï¼Œç¬¬äºŒå±‚æ˜¯é›†ç¾¤åŠ å¯†å¯†é’¥ï¼ˆCEKï¼‰ï¼Œç¬¬ä¸‰å±‚æ˜¯æ•°æ®åº“åŠ å¯†å¯†é’¥ï¼ˆDEKï¼‰ï¼Œæœ€åä¸€å±‚æ˜¯æ•°æ®åŠ å¯†å¯†é’¥æœ¬èº«**ã€‚

### KMS

åœ¨åˆ›å»ºé›†ç¾¤æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä¸ºRedshiftä½¿ç”¨**é»˜è®¤çš„KMSå¯†é’¥**æˆ–é€‰æ‹©æ‚¨è‡ªå·±çš„**CMK**ï¼Œè¿™ä½¿æ‚¨åœ¨å®¡è®¡è§’åº¦ä¸Šå¯¹å¯†é’¥çš„æ§åˆ¶æ›´åŠ çµæ´»ã€‚

Redshiftçš„é»˜è®¤KMSå¯†é’¥æ˜¯ç”±Redshiftåœ¨é¦–æ¬¡é€‰æ‹©å¹¶ä½¿ç”¨å¯†é’¥é€‰é¡¹æ—¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¹¶ç”±AWSå®Œå…¨ç®¡ç†ã€‚

ç„¶åï¼Œå°†æ­¤KMSå¯†é’¥ä½¿ç”¨CMKä¸»å¯†é’¥ï¼ˆç¬¬ä¸€å±‚ï¼‰è¿›è¡ŒåŠ å¯†ã€‚ç„¶åï¼Œå°†åŠ å¯†çš„KMSæ•°æ®å¯†é’¥ç”¨ä½œé›†ç¾¤åŠ å¯†å¯†é’¥ï¼ˆCEKï¼Œç¬¬äºŒå±‚ï¼‰ã€‚ç„¶åï¼ŒKMSå°†æ­¤CEKå‘é€ç»™Redshiftï¼Œåœ¨é‚£é‡Œå®ƒä¸é›†ç¾¤åˆ†å¼€å­˜å‚¨ã€‚ç„¶åï¼ŒRedshifté€šè¿‡å®‰å…¨é€šé“å°†æ­¤åŠ å¯†çš„CEKå‘é€åˆ°é›†ç¾¤ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

ç„¶åï¼ŒRedshiftè¯·æ±‚KMSè§£å¯†CEKï¼ˆç¬¬äºŒå±‚ï¼‰ã€‚ç„¶åï¼Œè§£å¯†çš„CEKä¹Ÿå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ç„¶åï¼ŒRedshiftåˆ›å»ºä¸€ä¸ªéšæœºçš„æ•°æ®åº“åŠ å¯†å¯†é’¥ï¼ˆDEKï¼Œç¬¬ä¸‰å±‚ï¼‰ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°é›†ç¾¤çš„å†…å­˜ä¸­ã€‚å†…å­˜ä¸­çš„è§£å¯†CEKç„¶ååŠ å¯†DEKï¼ŒDEKä¹Ÿå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

ç„¶åï¼Œå°†æ­¤åŠ å¯†çš„DEKé€šè¿‡å®‰å…¨é€šé“å‘é€å¹¶ä¸é›†ç¾¤åˆ†å¼€å­˜å‚¨ã€‚CEKå’ŒDEKç°åœ¨éƒ½ä»¥åŠ å¯†å’Œè§£å¯†çš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤çš„å†…å­˜ä¸­ã€‚è§£å¯†çš„DEKç„¶åç”¨äºåŠ å¯†æ•°æ®å—ä¸­æ¯ä¸ªæ•°æ®å—çš„éšæœºç”Ÿæˆçš„æ•°æ®å¯†é’¥ï¼ˆç¬¬å››å±‚ï¼‰ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨AWS Trusted Advisorç›‘è§†Amazon S3å­˜å‚¨æ¡¶çš„é…ç½®ï¼Œå¹¶ç¡®ä¿å¯ç”¨äº†å­˜å‚¨æ¡¶æ—¥å¿—è®°å½•ï¼Œè¿™å¯¹äºæ‰§è¡Œå®‰å…¨å®¡è®¡å’Œè·Ÿè¸ªS3ä¸­çš„ä½¿ç”¨æ¨¡å¼éå¸¸æœ‰ç”¨ã€‚

### CloudHSM

<details>

<summary>ä½¿ç”¨CloudHSMçš„Redshift</summary>

åœ¨ä½¿ç”¨CloudHSMæ‰§è¡ŒåŠ å¯†æ—¶ï¼Œé¦–å…ˆå¿…é¡»åœ¨ä½¿ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¯ä¹¦çš„æƒ…å†µä¸‹ï¼Œåœ¨HSMå®¢æˆ·ç«¯å’ŒRedshiftä¹‹é—´å»ºç«‹ä¸€ä¸ªå—ä¿¡ä»»çš„è¿æ¥ã€‚

æ­¤è¿æ¥éœ€è¦æä¾›å®‰å…¨é€šä¿¡ï¼Œå…è®¸åŠ å¯†å¯†é’¥åœ¨HSMå®¢æˆ·ç«¯å’ŒRedshifté›†ç¾¤ä¹‹é—´å‘é€ã€‚ä½¿ç”¨éšæœºç”Ÿæˆçš„ç§é’¥å’Œå…¬é’¥å¯¹ï¼ŒRedshiftåˆ›å»ºä¸€ä¸ªå…¬å…±å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¯¥è¯ä¹¦ç”±RedshiftåŠ å¯†å¹¶å­˜å‚¨ã€‚å¿…é¡»ä¸‹è½½å¹¶æ³¨å†Œæ­¤è¯ä¹¦åˆ°æ‚¨çš„HSMå®¢æˆ·ç«¯ï¼Œå¹¶åˆ†é…ç»™æ­£ç¡®çš„HSMåˆ†åŒºã€‚

ç„¶åï¼Œæ‚¨å¿…é¡»é…ç½®Redshiftä»¥æä¾›HSMå®¢æˆ·ç«¯çš„ä»¥ä¸‹è¯¦ç»†ä¿¡æ¯ï¼šHSM IPåœ°å€ã€HSMåˆ†åŒºåç§°ã€HSMåˆ†åŒºå¯†ç å’Œå…¬å…±HSMæœåŠ¡å™¨è¯ä¹¦ï¼Œè¯¥è¯ä¹¦ç”±CloudHSMä½¿ç”¨å†…éƒ¨ä¸»å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚æä¾›äº†è¿™äº›ä¿¡æ¯åï¼ŒRedshiftå°†ç¡®è®¤å¹¶éªŒè¯å…¶æ˜¯å¦å¯ä»¥è¿æ¥å¹¶è®¿é—®å¼€å‘åˆ†åŒºã€‚

å¦‚æœæ‚¨çš„å†…éƒ¨å®‰å…¨ç­–ç•¥æˆ–æ²»ç†æ§åˆ¶è¦æ±‚æ‚¨å¿…é¡»åº”ç”¨å¯†é’¥è½®æ¢ï¼Œåˆ™å¯ä»¥ä½¿ç”¨Redshiftæ¥è½®æ¢åŠ å¯†å¯†é’¥ä»¥ç”¨äºåŠ å¯†çš„é›†ç¾¤ï¼Œä½†æ˜¯ï¼Œæ‚¨éœ€è¦æ³¨æ„ï¼Œåœ¨å¯†é’¥è½®æ¢è¿‡ç¨‹ä¸­ï¼Œé›†ç¾¤å°†åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…ä¸å¯ç”¨ï¼Œå› æ­¤æœ€å¥½åªåœ¨éœ€è¦æ—¶æˆ–è€…å¦‚æœæ‚¨è§‰å¾—å¯†é’¥å¯èƒ½å·²è¢«æ³„éœ²æ—¶æ‰è½®æ¢å¯†é’¥ã€‚

åœ¨è½®æ¢è¿‡ç¨‹ä¸­ï¼ŒRedshiftå°†è½®æ¢é›†ç¾¤çš„CEKå’Œè¯¥é›†ç¾¤çš„ä»»ä½•å¤‡ä»½çš„CEKã€‚å®ƒå°†ä¸ºé›†ç¾¤è½®æ¢DEKï¼Œä½†æ— æ³•è½®æ¢ä½¿ç”¨DEKåŠ å¯†çš„å­˜å‚¨åœ¨S3ä¸­çš„å¿«ç…§çš„DEKã€‚å®ƒå°†å°†é›†ç¾¤ç½®äºâ€œè½®æ¢å¯†é’¥â€çŠ¶æ€ï¼Œç›´åˆ°å®Œæˆè¯¥è¿‡ç¨‹ï¼Œç„¶åçŠ¶æ€å°†è¿”å›â€œå¯ç”¨â€ã€‚

</details>

### æšä¸¾
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## ææƒ

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## æŒä¹…æ€§

ä»¥ä¸‹æ“ä½œå…è®¸å°†å¯¹é›†ç¾¤çš„è®¿é—®æƒé™æˆäºˆå…¶ä»–AWSè´¦æˆ·ï¼š

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**The PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
