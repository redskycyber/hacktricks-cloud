# AWS - Redshift Enum

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Amazon Redshift

Redshift je potpuno upravljana usluga koja mo쬰 da se skalira do preko petabajta, a koristi se kao **skladi코te podataka za re코enja velikih podataka**. Kori코캖enjem Redshift klastera, mo쬰te izvr코avati analitiku nad svojim skupovima podataka koriste캖i brze, SQL bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste stekli ve캖e razumevanje vizije za svoje poslovanje.

**Redshift nudi 코ifrovanje u mirovanju koriste캖i hijerarhiju od 캜etiri nivoa 코ifarskih klju캜eva koji koriste KMS ili CloudHSM za upravljanje najvi코im nivoom klju캜eva**. **Kada je 코ifrovanje omogu캖eno za va코 klaster, ne mo쬰 se onemogu캖iti i obrnuto**. Kada imate ne코ifrovan klaster, ne mo쬰 se 코ifrovati.

말frovanje za va코 klaster mo쬰 se desiti samo prilikom njegovog kreiranja, a jednom kada je 코ifrovan, podaci, metapodaci i svi snimci tako캠e su 코ifrovani. Nivoi hijerarhije 코ifarskih klju캜eva su slede캖i, **prvi nivo je glavni klju캜, drugi nivo je klju캜 za 코ifrovanje klastera (CEK), tre캖i nivo je klju캜 za 코ifrovanje baze podataka (DEK), a 캜etvrti nivo su sami klju캜evi za 코ifrovanje podataka**.

### KMS

Prilikom kreiranja va코eg klastera, mo쬰te odabrati **podrazumevani KMS klju캜** za Redshift ili odabrati **sopstveni CMK**, 코to vam pru쬬 ve캖u fleksibilnost u kontroli klju캜a, posebno sa auditorske perspektive.

Podrazumevani KMS klju캜 za Redshift automatski se kreira od strane Redshift-a prvi put kada se opcija klju캜a odabere i koristi, i potpuno je upravljan od strane AWS-a.

Ovaj KMS klju캜 zatim se 코ifruje glavnim CMK klju캜em, prvog nivoa. Ovaj 코ifrovani KMS klju캜 se zatim koristi kao klju캜 za 코ifrovanje klastera (CEK), drugog nivoa. Ovaj CEK se zatim 코alje od strane KMS-a Redshift-u gde se 캜uva odvojeno od klastera. Redshift zatim 코alje ovaj 코ifrovani CEK klasteru preko sigurnog kanala gde se 캜uva u memoriji.

Redshift zatim zahteva od KMS-a da de코ifruje CEK, drugog nivoa. Ovaj de코ifrovani CEK se zatim tako캠e 캜uva u memoriji. Redshift zatim kreira nasumi캜ni klju캜 za 코ifrovanje baze podataka (DEK), tre캖eg nivoa, i u캜itava ga u memoriju klastera. De코ifrovani CEK u memoriji zatim 코ifruje DEK, koji se tako캠e 캜uva u memoriji.

Ovaj 코ifrovani DEK se zatim 코alje preko sigurnog kanala i 캜uva se u Redshift-u odvojeno od klastera. Sada su i CEK i DEK sme코teni u memoriji klastera i u 코ifrovanom i de코ifrovanom obliku. De코ifrovani DEK se zatim koristi za 코ifrovanje klju캜eva za podatke (캜etvrti nivo) koji se nasumi캜no generi코u od strane Redshift-a za svaki podatkovni blok u bazi podataka.

Mo쬰te koristiti AWS Trusted Advisor da pratite konfiguraciju va코ih Amazon S3 kanti i obezbedite da je logovanje kanti omogu캖eno, 코to mo쬰 biti korisno za izvo캠enje sigurnosnih revizija i pra캖enje obrazaca kori코캖enja u S3.

### CloudHSM

<details>

<summary>Kori코캖enje Redshift-a sa CloudHSM-om</summary>

Kada radite sa CloudHSM-om radi 코ifrovanja, prvo morate uspostaviti pouzdanu vezu izme캠u va코eg HSM klijenta i Redshift-a koriste캖i klijentske i serverske sertifikate.

Ova veza je neophodna kako bi se obezbedila sigurna komunikacija, omogu캖avaju캖i slanje 코ifarskih klju캜eva izme캠u va코eg HSM klijenta i va코ih Redshift klastera. Koriste캖i nasumi캜no generisan par privatnog i javnog klju캜a, Redshift kreira javni klijentski sertifikat, koji se 코ifruje i 캜uva od strane Redshift-a. Ovaj sertifikat mora biti preuzet i registrovan na va코em HSM klijentu, i dodeljen odgovaraju캖oj HSM particiji.

Zatim morate konfigurisati Redshift sa slede캖im detaljima va코eg HSM klijenta: IP adresa HSM-a, ime HSM particije, lozinka HSM particije i javni HSM serverski sertifikat, koji je 코ifrovan od strane CloudHSM-a koriste캖i interni glavni klju캜. Nakon 코to su ove informacije dostavljene, Redshift 캖e potvrditi i proveriti da mo쬰 da se pove쬰 i pristupi razvojnoj particiji.

Ako va코e interne bezbednosne politike ili upravlja캜ke kontrole nala쬿 da morate primeniti rotaciju klju캜eva, to je mogu캖e sa Redshift-om, 코to vam omogu캖ava rotaciju 코ifarskih klju캜eva za 코ifrovane klastere, me캠utim, morate biti svesni da tokom procesa rotacije klju캜eva, klaster 캖e biti nedostupan vrlo kratko vreme, pa je najbolje rotirati klju캜eve samo kada je to potrebno ili ako sumnjate da su kompromitovani.

Tokom rotacije, Redshift 캖e rotirati CEK za va코 klaster i za sve rezervne kopije tog klastera. Rotira캖e DEK za klaster, ali nije mogu캖e rotirati DEK za snimke koji su sme코teni u S3 i koji su 코ifrovani pomo캖u DEK. Klaster 캖e biti postavljen u stanje 'rotiranje klju캜eva' sve dok proces ne bude zavr코en, kada 캖e status biti vra캖en na 'dostupan'.

</details>

### Enumeracija
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Upornost

Slede캖e radnje omogu캖avaju dodeljivanje pristupa drugim AWS nalozima klasteru:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
