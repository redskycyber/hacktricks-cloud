# AWS - STS Persistence

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚’é€šã˜ã¦ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬** [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯**[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)**ã«å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* **HackTricks**ãŠã‚ˆã³**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>

## STS

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-services/aws-sts-enum.md" %}
[aws-sts-enum.md](../aws-services/aws-sts-enum.md)
{% endcontent-ref %}

### Assume role token

ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒªã‚¹ãƒˆã§ããªã„ãŸã‚ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã¯æŒç¶šæ€§ã‚’ç¶­æŒã™ã‚‹æ–¹æ³•ã§ã™ã€‚

<pre class="language-bash"><code class="lang-bash">aws sts get-session-token --duration-seconds 129600

# MFAã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
aws sts get-session-token \
--serial-number &#x3C;mfa-device-name> \
--token-code &#x3C;code-from-token>

# ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒ‡ãƒã‚¤ã‚¹åã¯é€šå¸¸ã€ãƒ‡ãƒã‚¤ã‚¹ã®èƒŒé¢ã«ã‚ã‚‹ç•ªå·ã§ã™ã€‚ä¾‹ï¼šGAHT12345678
<strong># SMSãƒ‡ãƒã‚¤ã‚¹åã¯AWSã®ARNã§ã‚ã‚Šã€ä¾‹ãˆã°arn:aws:iam::123456789012:sms-mfa/username
</strong># ä»®æƒ³ãƒ‡ãƒã‚¤ã‚¹åã¯AWSã®ARNã§ã‚ã‚Šã€ä¾‹ãˆã°arn:aws:iam::123456789012:mfa/username
</code></pre>

### Role Chain Juggling

[**ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã¯èªã‚ã‚‰ã‚ŒãŸAWSã®æ©Ÿèƒ½**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_terms-and-concepts.html#Role%20chaining)ã§ã‚ã‚Šã€ã—ã°ã—ã°ã‚¹ãƒ†ãƒ«ã‚¹æŒç¶šæ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€**1ã¤ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»®å®šã—ã€ãã®å¾Œåˆ¥ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»®å®šã™ã‚‹**èƒ½åŠ›ã‚’å«ã¿ã€**ã‚µã‚¤ã‚¯ãƒªã‚«ãƒ«ãªæ–¹æ³•**ã§åˆæœŸãƒ­ãƒ¼ãƒ«ã«æˆ»ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ãƒ«ãŒä»®å®šã•ã‚Œã‚‹ãŸã³ã«ã€è³‡æ ¼æƒ…å ±ã®æœ‰åŠ¹æœŸé™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€2ã¤ã®ãƒ­ãƒ¼ãƒ«ãŒäº’ã„ã«ä»®å®šã™ã‚‹ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚ˆã‚Šè³‡æ ¼æƒ…å ±ã‚’æ°¸ç¶šçš„ã«æ›´æ–°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

ã“ã®[**ãƒ„ãƒ¼ãƒ«**](https://github.com/hotnops/AWSRoleJuggler/)ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ç¶­æŒã§ãã¾ã™ã€‚

```bash
./aws_role_juggler.py -h
usage: aws_role_juggler.py [-h] [-r ROLE_LIST [ROLE_LIST ...]]

optional arguments:
-h, --help            show this help message and exit
-r ROLE_LIST [ROLE_LIST ...], --role-list ROLE_LIST [ROLE_LIST ...]
```

<details>

<summary>PowerShellã‹ã‚‰ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰</summary>

\`\`\`powershell # PowerShell script to check for role juggling possibilities using AWS CLI

## Check for AWS CLI installation

if (-not (Get-Command "aws" -ErrorAction SilentlyContinue)) { Write-Error "AWS CLI is not installed. Please install it and configure it with 'aws configure'." exit }

## Function to list IAM roles

function List-IAMRoles { aws iam list-roles --query "Roles\[\*].{RoleName:RoleName, Arn:Arn}" --output json }

## Initialize error count

$errorCount = 0

## List all roles

$roles = List-IAMRoles | ConvertFrom-Json

## Attempt to assume each role

foreach ($role in $roles) { $sessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $credentials = aws sts assume-role --role-arn $role.Arn --role-session-name $sessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($credentials) { Write-Host "Successfully assumed role: $($role.RoleName)" Write-Host "Access Key: $($credentials.AccessKeyId)" Write-Host "Secret Access Key: $($credentials.SecretAccessKey)" Write-Host "Session Token: $($credentials.SessionToken)" Write-Host "Expiration: $($credentials.Expiration)"

## Set temporary credentials to assume the next role

$env:AWS\_ACCESS\_KEY\_ID = $credentials.AccessKeyId $env:AWS\_SECRET\_ACCESS\_KEY = $credentials.SecretAccessKey $env:AWS\_SESSION\_TOKEN = $credentials.SessionToken

## Try to assume another role using the temporary credentials

foreach ($nextRole in $roles) { if ($nextRole.Arn -ne $role.Arn) { $nextSessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $nextCredentials = aws sts assume-role --role-arn $nextRole.Arn --role-session-name $nextSessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($nextCredentials) { Write-Host "Also successfully assumed role: $($nextRole.RoleName) from $($role.RoleName)" Write-Host "Access Key: $($nextCredentials.AccessKeyId)" Write-Host "Secret Access Key: $($nextCredentials.SecretAccessKey)" Write-Host "Session Token: $($nextCredentials.SessionToken)" Write-Host "Expiration: $($nextCredentials.Expiration)" } } catch { $errorCount++ } } }

## Reset environment variables

Remove-Item Env:\AWS\_ACCESS\_KEY\_ID Remove-Item Env:\AWS\_SECRET\_ACCESS\_KEY Remove-Item Env:\AWS\_SESSION\_TOKEN } else { $errorCount++ } } catch { $errorCount++ } }

## Output the number of errors if any

if ($errorCount -gt 0) { Write-Host "$errorCount error(s) occurred during role assumption attempts." } else { Write-Host "No errors occurred. All roles checked successfully." }

Write-Host "Role juggling check complete."

```
</details>

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
```

</details>
