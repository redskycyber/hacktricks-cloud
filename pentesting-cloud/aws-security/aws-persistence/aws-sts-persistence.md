# AWS - STS Persistence

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## STS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../aws-services/aws-sts-enum.md" %}
[aws-sts-enum.md](../aws-services/aws-sts-enum.md)
{% endcontent-ref %}

### å‡å®šè§’è‰²ä»¤ç‰Œ

ä¸´æ—¶ä»¤ç‰Œæ— æ³•åˆ—å‡ºï¼Œå› æ­¤ä¿æŒæ´»åŠ¨ä¸´æ—¶ä»¤ç‰Œæ˜¯ä¿æŒæŒä¹…æ€§çš„ä¸€ç§æ–¹å¼ã€‚

<pre class="language-bash"><code class="lang-bash">aws sts get-session-token --duration-seconds 129600

# ä½¿ç”¨MFA
aws sts get-session-token \
--serial-number &#x3C;mfa-device-name> \
--token-code &#x3C;code-from-token>

# ç¡¬ä»¶è®¾å¤‡åç§°é€šå¸¸æ˜¯è®¾å¤‡èƒŒé¢çš„æ•°å­—ï¼Œä¾‹å¦‚GAHT12345678
<strong># çŸ­ä¿¡è®¾å¤‡åç§°æ˜¯AWSä¸­çš„ARNï¼Œä¾‹å¦‚arn:aws:iam::123456789012:sms-mfa/username
</strong># è™šæ‹Ÿè®¾å¤‡åç§°æ˜¯AWSä¸­çš„ARNï¼Œä¾‹å¦‚arn:aws:iam::123456789012:mfa/username
</code></pre>

### è§’è‰²é“¾æ··åˆ

[**è§’è‰²é“¾æ˜¯ä¸€ä¸ªå…¬è®¤çš„AWSåŠŸèƒ½**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_terms-and-concepts.html#Role%20chaining)ï¼Œç»å¸¸ç”¨äºä¿æŒéšè”½æŒä¹…æ€§ã€‚å®ƒæ¶‰åŠ**å‡å®šä¸€ä¸ªè§’è‰²ï¼Œç„¶åå‡å®šå¦ä¸€ä¸ªè§’è‰²**ï¼Œå¯èƒ½ä»¥**å¾ªç¯æ–¹å¼**è¿”å›åˆ°åˆå§‹è§’è‰²ã€‚æ¯æ¬¡å‡å®šä¸€ä¸ªè§’è‰²æ—¶ï¼Œå‡­è¯çš„è¿‡æœŸå­—æ®µéƒ½ä¼šåˆ·æ–°ã€‚å› æ­¤ï¼Œå¦‚æœé…ç½®äº†ä¸¤ä¸ªè§’è‰²ç›¸äº’å‡å®šå½¼æ­¤ï¼Œæ­¤è®¾ç½®å…è®¸å‡­è¯çš„æ°¸ä¹…æ›´æ–°ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤[**å·¥å…·**](https://github.com/hotnops/AWSRoleJuggler/)æ¥ä¿æŒè§’è‰²é“¾çš„æŒç»­è¿›è¡Œï¼š

```bash
./aws_role_juggler.py -h
usage: aws_role_juggler.py [-h] [-r ROLE_LIST [ROLE_LIST ...]]

optional arguments:
-h, --help            show this help message and exit
-r ROLE_LIST [ROLE_LIST ...], --role-list ROLE_LIST [ROLE_LIST ...]
```

<details>

<summary>ç”¨PowerShellæ‰§è¡Œè§’è‰²åˆ‡æ¢çš„ä»£ç </summary>

\`\`\`powershell # PowerShell script to check for role juggling possibilities using AWS CLI

## Check for AWS CLI installation

if (-not (Get-Command "aws" -ErrorAction SilentlyContinue)) { Write-Error "AWS CLI is not installed. Please install it and configure it with 'aws configure'." exit }

## Function to list IAM roles

function List-IAMRoles { aws iam list-roles --query "Roles\[\*].{RoleName:RoleName, Arn:Arn}" --output json }

## Initialize error count

$errorCount = 0

## List all roles

$roles = List-IAMRoles | ConvertFrom-Json

## Attempt to assume each role

foreach ($role in $roles) { $sessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $credentials = aws sts assume-role --role-arn $role.Arn --role-session-name $sessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($credentials) { Write-Host "Successfully assumed role: $($role.RoleName)" Write-Host "Access Key: $($credentials.AccessKeyId)" Write-Host "Secret Access Key: $($credentials.SecretAccessKey)" Write-Host "Session Token: $($credentials.SessionToken)" Write-Host "Expiration: $($credentials.Expiration)"

## Set temporary credentials to assume the next role

$env:AWS\_ACCESS\_KEY\_ID = $credentials.AccessKeyId $env:AWS\_SECRET\_ACCESS\_KEY = $credentials.SecretAccessKey $env:AWS\_SESSION\_TOKEN = $credentials.SessionToken

## Try to assume another role using the temporary credentials

foreach ($nextRole in $roles) { if ($nextRole.Arn -ne $role.Arn) { $nextSessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $nextCredentials = aws sts assume-role --role-arn $nextRole.Arn --role-session-name $nextSessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($nextCredentials) { Write-Host "Also successfully assumed role: $($nextRole.RoleName) from $($role.RoleName)" Write-Host "Access Key: $($nextCredentials.AccessKeyId)" Write-Host "Secret Access Key: $($nextCredentials.SecretAccessKey)" Write-Host "Session Token: $($nextCredentials.SessionToken)" Write-Host "Expiration: $($nextCredentials.Expiration)" } } catch { $errorCount++ } } }

## Reset environment variables

Remove-Item Env:\AWS\_ACCESS\_KEY\_ID Remove-Item Env:\AWS\_SECRET\_ACCESS\_KEY Remove-Item Env:\AWS\_SESSION\_TOKEN } else { $errorCount++ } } catch { $errorCount++ } }

## Output the number of errors if any

if ($errorCount -gt 0) { Write-Host "$errorCount error(s) occurred during role assumption attempts." } else { Write-Host "No errors occurred. All roles checked successfully." }

Write-Host "Role juggling check complete."

```
</details>

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
```

</details>
