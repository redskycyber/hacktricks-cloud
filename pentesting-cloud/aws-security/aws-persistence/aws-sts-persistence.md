# AWS - STS Persistence

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olana kadar AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** \[**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬** [**Discord grubuna**](https://discord.gg/hRep4RUj7f) **veya** [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n veya bizi Twitter ğŸ¦** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin\*\*.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## STS

Daha fazla bilgi iÃ§in:

{% content-ref url="../aws-services/aws-sts-enum.md" %}
[aws-sts-enum.md](../aws-services/aws-sts-enum.md)
{% endcontent-ref %}

### RolÃ¼ varsay

GeÃ§ici belgeler listelenemez, bu nedenle aktif bir geÃ§ici belgeyi korumak kalÄ±cÄ±lÄ±ÄŸÄ± sÃ¼rdÃ¼rmenin bir yoludur.

<pre class="language-bash"><code class="lang-bash">aws sts get-session-token --duration-seconds 129600

# MFA ile
aws sts get-session-token \
--serial-number &#x3C;mfa-cihaz-adÄ±> \
--token-code &#x3C;token'dan-kod>

# DonanÄ±m cihaz adÄ± genellikle cihazÄ±n arkasÄ±ndaki numaradÄ±r, Ã¶rneÄŸin GAHT12345678
<strong># SMS cihaz adÄ± AWS'de ARN'dir, Ã¶rneÄŸin arn:aws:iam::123456789012:sms-mfa/kullanÄ±cÄ±adÄ±
</strong># Sanal cihaz adÄ± AWS'de ARN'dir, Ã¶rneÄŸin arn:aws:iam::123456789012:mfa/kullanÄ±cÄ±adÄ±
</code></pre>

### Rol Zinciri Oyunu

[**Rol zincirleme, genellikle gizli kalÄ±cÄ±lÄ±ÄŸÄ± sÃ¼rdÃ¼rmek iÃ§in kullanÄ±lan bir AWS Ã¶zelliÄŸidir**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_terms-and-concepts.html#Role%20chaining). Bu, **bir rolÃ¼ varsayma ve ardÄ±ndan baÅŸka bir rolÃ¼ varsayma** yeteneÄŸini iÃ§erir, potansiyel olarak baÅŸlangÄ±Ã§taki role **dÃ¶ngÃ¼sel bir ÅŸekilde** geri dÃ¶nebilir. Bir rol varsayÄ±ldÄ±ÄŸÄ±nda, kimlik bilgilerinin sona erme alanÄ± yenilenir. DolayÄ±sÄ±yla, iki rolÃ¼n birbirini varsayacak ÅŸekilde yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ± durumda, bu kurulum kimlik bilgilerinin sÃ¼rekli olarak yenilenmesine olanak tanÄ±r.

Rol zincirini sÃ¼rdÃ¼rmek iÃ§in bu [**araÃ§Ä±**](https://github.com/hotnops/AWSRoleJuggler/) kullanabilirsiniz:

```bash
./aws_role_juggler.py -h
usage: aws_role_juggler.py [-h] [-r ROLE_LIST [ROLE_LIST ...]]

optional arguments:
-h, --help            show this help message and exit
-r ROLE_LIST [ROLE_LIST ...], --role-list ROLE_LIST [ROLE_LIST ...]
```

<details>

<summary>PowerShell ile Rol DeÄŸiÅŸtirme iÅŸlemi yapmak iÃ§in kod</summary>

\`\`\`powershell # PowerShell script to check for role juggling possibilities using AWS CLI

## Check for AWS CLI installation

if (-not (Get-Command "aws" -ErrorAction SilentlyContinue)) { Write-Error "AWS CLI is not installed. Please install it and configure it with 'aws configure'." exit }

## Function to list IAM roles

function List-IAMRoles { aws iam list-roles --query "Roles\[\*].{RoleName:RoleName, Arn:Arn}" --output json }

## Initialize error count

$errorCount = 0

## List all roles

$roles = List-IAMRoles | ConvertFrom-Json

## Attempt to assume each role

foreach ($role in $roles) { $sessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $credentials = aws sts assume-role --role-arn $role.Arn --role-session-name $sessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($credentials) { Write-Host "Successfully assumed role: $($role.RoleName)" Write-Host "Access Key: $($credentials.AccessKeyId)" Write-Host "Secret Access Key: $($credentials.SecretAccessKey)" Write-Host "Session Token: $($credentials.SessionToken)" Write-Host "Expiration: $($credentials.Expiration)"

## Set temporary credentials to assume the next role

$env:AWS\_ACCESS\_KEY\_ID = $credentials.AccessKeyId $env:AWS\_SECRET\_ACCESS\_KEY = $credentials.SecretAccessKey $env:AWS\_SESSION\_TOKEN = $credentials.SessionToken

## Try to assume another role using the temporary credentials

foreach ($nextRole in $roles) { if ($nextRole.Arn -ne $role.Arn) { $nextSessionName = "RoleJugglingTest-" + (Get-Date -Format FileDateTime) try { $nextCredentials = aws sts assume-role --role-arn $nextRole.Arn --role-session-name $nextSessionName --query "Credentials" --output json 2>$null | ConvertFrom-Json if ($nextCredentials) { Write-Host "Also successfully assumed role: $($nextRole.RoleName) from $($role.RoleName)" Write-Host "Access Key: $($nextCredentials.AccessKeyId)" Write-Host "Secret Access Key: $($nextCredentials.SecretAccessKey)" Write-Host "Session Token: $($nextCredentials.SessionToken)" Write-Host "Expiration: $($nextCredentials.Expiration)" } } catch { $errorCount++ } } }

## Reset environment variables

Remove-Item Env:\AWS\_ACCESS\_KEY\_ID Remove-Item Env:\AWS\_SECRET\_ACCESS\_KEY Remove-Item Env:\AWS\_SESSION\_TOKEN } else { $errorCount++ } } catch { $errorCount++ } }

## Output the number of errors if any

if ($errorCount -gt 0) { Write-Host "$errorCount error(s) occurred during role assumption attempts." } else { Write-Host "No errors occurred. All roles checked successfully." }

Write-Host "Role juggling check complete."

```
</detaylar>

<detaylar>

<Ã¶zet>

<strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!

DiÄŸer HackTricks'i destekleme yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi**]'ni (https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'ler**]'imiz (https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</detaylar>
```

</details>
