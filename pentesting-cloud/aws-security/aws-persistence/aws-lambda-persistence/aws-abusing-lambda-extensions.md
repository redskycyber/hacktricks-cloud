# AWS - Abus des Extensions Lambda

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Extensions Lambda

Les extensions Lambda am√©liorent les fonctions en s'int√©grant √† divers **outils de surveillance, d'observabilit√©, de s√©curit√© et de gouvernance**. Ces extensions, ajout√©es via des [.archives zip en utilisant des couches Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ou incluses dans des [d√©ploiements d'images de conteneurs](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), fonctionnent en deux modes : **interne** et **externe**.

* Les **extensions internes** fusionnent avec le processus d'ex√©cution, manipulant son d√©marrage √† l'aide de **variables d'environnement sp√©cifiques au langage** et de **scripts d'enrobage**. Cette personnalisation s'applique √† une gamme de runtimes, y compris **Java Correto 8 et 11, Node.js 10 et 12, et .NET Core 3.1**.
* Les **extensions externes** s'ex√©cutent en tant que processus distincts, maintenant l'alignement des op√©rations avec le cycle de vie de la fonction Lambda. Elles sont compatibles avec divers runtimes tels que **Node.js 10 et 12, Python 3.7 et 3.8, Ruby 2.5 et 2.7, Java Corretto 8 et 11, .NET Core 3.1**, et **runtimes personnalis√©s**.

Pour plus d'informations sur [**le fonctionnement des extensions Lambda, consultez la documentation**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extension Externe pour la Persistance, le Vol de Requ√™tes & la Modification de Requ√™tes

Il s'agit d'un r√©sum√© de la technique propos√©e dans ce post : [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Il a √©t√© d√©couvert que le noyau Linux par d√©faut dans l'environnement d'ex√©cution Lambda est compil√© avec les appels syst√®me "**process\_vm\_readv**" et "**process\_vm\_writev**". Et tous les processus s'ex√©cutent avec le m√™me ID utilisateur, m√™me le nouveau processus cr√©√© pour l'extension externe. **Cela signifie qu'une extension externe a un acc√®s complet en lecture et en √©criture √† la m√©moire heap de Rapid, par conception.**

De plus, bien que les extensions Lambda aient la capacit√© de **s'abonner aux √©v√©nements d'invocation**, AWS ne r√©v√®le pas les donn√©es brutes √† ces extensions. Cela garantit que les **extensions ne peuvent pas acc√©der aux informations sensibles** transmises via la requ√™te HTTP.

Le processus Init (Rapid) surveille toutes les requ√™tes API √† [http://127.0.0.1:9001](http://127.0.0.1:9001/) tandis que les extensions Lambda sont initialis√©es et ex√©cut√©es avant l'ex√©cution de tout code d'ex√©cution, mais apr√®s Rapid.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

La variable **`AWS_LAMBDA_RUNTIME_API`** indique l'**adresse IP** et le **num√©ro de port** de l'API Rapid aux **processus d'ex√©cution enfants** et aux extensions suppl√©mentaires.

{% hint style="warning" %}
En modifiant la variable d'environnement **`AWS_LAMBDA_RUNTIME_API`** pour un **`port`** auquel nous avons acc√®s, il est possible d'intercepter toutes les actions dans l'environnement d'ex√©cution Lambda (**homme du milieu**). Cela est possible car l'extension s'ex√©cute avec les m√™mes privil√®ges que Rapid Init, et le noyau du syst√®me permet la **modification de la m√©moire du processus**, permettant la modification du num√©ro de port.
{% endhint %}

Parce que les **extensions s'ex√©cutent avant tout code d'ex√©cution**, la modification de la variable d'environnement influencera le processus d'ex√©cution (par exemple, Python, Java, Node, Ruby) au d√©marrage. De plus, les **extensions charg√©es apr√®s** la n√¥tre, qui d√©pendent de cette variable, passeront √©galement par notre extension. Cette configuration pourrait permettre √† un logiciel malveillant de contourner compl√®tement les mesures de s√©curit√© ou les extensions de journalisation directement dans l'environnement d'ex√©cution.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

L'outil [**lambda-spy**](https://github.com/clearvector/lambda-spy) a √©t√© cr√©√© pour effectuer cette **√©criture en m√©moire** et **voler des informations sensibles** des requ√™tes lambda, d'autres **requ√™tes d'extensions** et m√™me les **modifier**.

## R√©f√©rences

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
