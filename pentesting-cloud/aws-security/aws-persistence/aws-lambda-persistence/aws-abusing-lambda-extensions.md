# AWS - Abusando de las Extensiones de Lambda

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Extensiones de Lambda

Las extensiones de Lambda mejoran las funciones integr谩ndose con diversas **herramientas de monitoreo, observabilidad, seguridad y gobernanza**. Estas extensiones, a帽adidas a trav茅s de [.archivos zip utilizando capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) o incluidas en [implementaciones de im谩genes de contenedores](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operan en dos modos: **internos** y **externos**.

* Las **extensiones internas** se fusionan con el proceso de tiempo de ejecuci贸n, manipulando su inicio mediante **variables de entorno espec铆ficas del lenguaje** y **scripts envolventes**. Esta personalizaci贸n se aplica a una variedad de tiempos de ejecuci贸n, incluidos **Java Correto 8 y 11, Node.js 10 y 12, y .NET Core 3.1**.
* Las **extensiones externas** se ejecutan como procesos separados, manteniendo la alineaci贸n de operaci贸n con el ciclo de vida de la funci贸n Lambda. Son compatibles con varios tiempos de ejecuci贸n como **Node.js 10 y 12, Python 3.7 y 3.8, Ruby 2.5 y 2.7, Java Corretto 8 y 11, .NET Core 3.1**, y **tiempos de ejecuci贸n personalizados**.

Para obtener m谩s informaci贸n sobre [**c贸mo funcionan las extensiones de Lambda, consulta la documentaci贸n**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extensi贸n Externa para Persistencia, Robo de Solicitudes y Modificaci贸n de Solicitudes

Este es un resumen de la t茅cnica propuesta en este post: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Se descubri贸 que el kernel de Linux predeterminado en el entorno de tiempo de ejecuci贸n de Lambda est谩 compilado con las llamadas al sistema "**process\_vm\_readv**" y "**process\_vm\_writev**". Y todos los procesos se ejecutan con el mismo ID de usuario, incluso el nuevo proceso creado para la extensi贸n externa. **Esto significa que una extensi贸n externa tiene acceso completo de lectura y escritura a la memoria heap de Rapid, por dise帽o.**

Adem谩s, si bien las extensiones de Lambda tienen la capacidad de **suscribirse a eventos de invocaci贸n**, AWS no revela los datos crudos a estas extensiones. Esto asegura que las **extensiones no pueden acceder a informaci贸n sensible** transmitida a trav茅s de la solicitud HTTP.

El proceso Init (Rapid) monitorea todas las solicitudes de API en [http://127.0.0.1:9001](http://127.0.0.1:9001/) mientras las extensiones de Lambda se inicializan y se ejecutan antes de la ejecuci贸n de cualquier c贸digo de tiempo de ejecuci贸n, pero despu茅s de Rapid.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

La variable **`AWS_LAMBDA_RUNTIME_API`** indica la **direcci贸n IP** y el **n煤mero de puerto** de la API de Rapid a los **procesos secundarios de tiempo de ejecuci贸n** y extensiones adicionales.

{% hint style="warning" %}
Al cambiar la variable de entorno **`AWS_LAMBDA_RUNTIME_API`** a un **`puerto`** al que tengamos acceso, es posible interceptar todas las acciones dentro del tiempo de ejecuci贸n de Lambda (**hombre en el medio**). Esto es posible porque la extensi贸n se ejecuta con los mismos privilegios que Rapid Init, y el kernel del sistema permite la **modificaci贸n de la memoria del proceso**, lo que permite la alteraci贸n del n煤mero de puerto.
{% endhint %}

Debido a que las **extensiones se ejecutan antes de cualquier c贸digo de tiempo de ejecuci贸n**, modificar la variable de entorno influir谩 en el proceso de tiempo de ejecuci贸n (por ejemplo, Python, Java, Node, Ruby) al iniciarse. Adem谩s, las **extensiones cargadas despu茅s** de la nuestra, que dependen de esta variable, tambi茅n pasar谩n por nuestra extensi贸n. Esta configuraci贸n podr铆a permitir que el malware evite por completo las medidas de seguridad o las extensiones de registro directamente dentro del entorno de tiempo de ejecuci贸n.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

La herramienta [**lambda-spy**](https://github.com/clearvector/lambda-spy) fue creada para realizar esa **escritura en memoria** y **robar informaci贸n sensible** de las solicitudes de lambda, otras **solicitudes de extensiones** e incluso **modificarlas**.

## Referencias

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
