# AWS - ECSåæ¸—é€

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ECS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ä¸»æœºIAMè§’è‰²

åœ¨ECSä¸­ï¼Œ**IAMè§’è‰²å¯ä»¥åˆ†é…ç»™å®¹å™¨å†…è¿è¡Œçš„ä»»åŠ¡**ã€‚**å¦‚æœ**ä»»åŠ¡åœ¨**EC2**å®ä¾‹å†…è¿è¡Œï¼Œåˆ™**EC2å®ä¾‹**å°†é™„åŠ **å¦ä¸€ä¸ªIAM**è§’è‰²ã€‚\
è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨è®¾æ³•**å…¥ä¾µ**ECSå®ä¾‹ï¼Œæ‚¨å¯èƒ½ä¼š**è·å–ä¸ECRå’ŒEC2å®ä¾‹ç›¸å…³è”çš„IAMè§’è‰²**ã€‚æœ‰å…³å¦‚ä½•è·å–è¿™äº›å‡­æ®çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœEC2å®ä¾‹å¼ºåˆ¶æ‰§è¡ŒIMDSv2ï¼Œ[**æ ¹æ®æ–‡æ¡£**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)ï¼Œ**PUTè¯·æ±‚çš„å“åº”**å°†å…·æœ‰**1ä¸ªè·³æ•°é™åˆ¶**ï¼Œå› æ­¤æ— æ³•ä»EC2å®ä¾‹å†…çš„å®¹å™¨è®¿é—®EC2å…ƒæ•°æ®ã€‚
{% endhint %}

### ææƒåˆ°èŠ‚ç‚¹ä»¥çªƒå–å…¶ä»–å®¹å™¨çš„å‡­æ®å’Œæœºå¯†ä¿¡æ¯

è€Œä¸”ï¼ŒEC2ä½¿ç”¨dockeræ¥è¿è¡ŒECSä»»åŠ¡ï¼Œå› æ­¤å¦‚æœæ‚¨å¯ä»¥é€ƒé€¸åˆ°èŠ‚ç‚¹æˆ–**è®¿é—®dockerå¥—æ¥å­—**ï¼Œæ‚¨å¯ä»¥**æ£€æŸ¥**æ­£åœ¨è¿è¡Œçš„**å…¶ä»–å®¹å™¨**ï¼Œç”šè‡³**è¿›å…¥å…¶ä¸­**å¹¶**çªƒå–å®ƒä»¬çš„IAMè§’è‰²**ã€‚

#### è®©å®¹å™¨åœ¨å½“å‰ä¸»æœºä¸Šè¿è¡Œ

æ­¤å¤–ï¼Œ**EC2å®ä¾‹è§’è‰²**é€šå¸¸å…·æœ‰è¶³å¤Ÿçš„**æƒé™**æ¥**æ›´æ–°ä½œä¸ºé›†ç¾¤å†…èŠ‚ç‚¹ä½¿ç”¨çš„EC2å®ä¾‹çš„å®¹å™¨å®ä¾‹çŠ¶æ€**ã€‚æ”»å‡»è€…å¯ä»¥ä¿®æ”¹å®ä¾‹çš„çŠ¶æ€ä¸ºDRAININGï¼Œç„¶åECSå°†**ä»ä¸­åˆ é™¤æ‰€æœ‰ä»»åŠ¡**ï¼Œè€Œä½œä¸º**REPLICA**è¿è¡Œçš„ä»»åŠ¡å°†åœ¨ä¸åŒçš„å®ä¾‹ä¸­è¿è¡Œï¼Œæ½œåœ¨åœ°åœ¨**æ”»å‡»è€…çš„å®ä¾‹**ä¸­ï¼Œå› æ­¤ä»–å¯ä»¥ä»å®¹å™¨å†…çªƒå–å®ƒä»¬çš„IAMè§’è‰²å’Œæ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯ã€‚
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
å¯ä»¥é€šè¿‡**ä»é›†ç¾¤ä¸­æ³¨é”€EC2å®ä¾‹**æ¥æ‰§è¡Œç›¸åŒçš„æŠ€æœ¯ã€‚è¿™å¯èƒ½ä¸å¤ªéšè”½ï¼Œä½†å®ƒå°†**å¼ºåˆ¶ä»»åŠ¡åœ¨å…¶ä»–å®ä¾‹ä¸Šè¿è¡Œ**ï¼š
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
ä¸€ç§æœ€åçš„æŠ€æœ¯æ˜¯é€šè¿‡æŒ‡ç¤ºECSä»»åŠ¡æˆ–å®¹å™¨å·²åœæ­¢æ¥å¼ºåˆ¶é‡æ–°æ‰§è¡Œä»»åŠ¡ã€‚æœ‰ä¸‰ä¸ªæ½œåœ¨çš„APIå¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼š
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ä» ECR å®¹å™¨ä¸­çªƒå–æ•æ„Ÿä¿¡æ¯

EC2 å®ä¾‹å¯èƒ½è¿˜å…·æœ‰ `ecr:GetAuthorizationToken` æƒé™ï¼Œå…è®¸å…¶**ä¸‹è½½é•œåƒ**ï¼ˆæ‚¨å¯ä»¥åœ¨å…¶ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
