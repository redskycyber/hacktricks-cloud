# AWS - ECS Post Exploitation

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ECS

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ä¸»æœºIAMè§’è‰²

åœ¨ECSä¸­ï¼Œ**IAMè§’è‰²å¯ä»¥åˆ†é…ç»™å®¹å™¨å†…è¿è¡Œçš„ä»»åŠ¡**ã€‚**å¦‚æœ**ä»»åŠ¡åœ¨**EC2**å®ä¾‹å†…è¿è¡Œï¼Œ**EC2å®ä¾‹**å°†æœ‰**å¦ä¸€ä¸ªIAM**è§’è‰²é™„åŠ åˆ°å®ƒã€‚\
è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨è®¾æ³•**æ”»ç ´**ECSå®ä¾‹ï¼Œæ‚¨å¯ä»¥æ½œåœ¨åœ°**è·å–ä¸ECRå’ŒEC2å®ä¾‹ç›¸å…³è”çš„IAMè§’è‰²**ã€‚æœ‰å…³å¦‚ä½•è·å–è¿™äº›å‡­è¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå¦‚æœEC2å®ä¾‹æ­£åœ¨æ‰§è¡ŒIMDSv2ï¼Œ[**æ ¹æ®æ–‡æ¡£**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)ï¼Œ**PUTè¯·æ±‚çš„å“åº”**å°†å…·æœ‰**è·³æ•°é™åˆ¶ä¸º1**ï¼Œä½¿å¾—æ— æ³•ä»EC2å®ä¾‹å†…çš„å®¹å™¨è®¿é—®EC2å…ƒæ•°æ®ã€‚
{% endhint %}

### æå‡æƒé™åˆ°èŠ‚ç‚¹ä»¥çªƒå–å…¶ä»–å®¹å™¨çš„å‡­è¯å’Œç§˜å¯†

è€Œä¸”ï¼ŒEC2ä½¿ç”¨dockeræ¥è¿è¡ŒECsä»»åŠ¡ï¼Œæ‰€ä»¥å¦‚æœæ‚¨èƒ½å¤Ÿé€ƒé€¸åˆ°èŠ‚ç‚¹æˆ–**è®¿é—®dockerå¥—æ¥å­—**ï¼Œæ‚¨å¯ä»¥**æ£€æŸ¥**å“ªäº›**å…¶ä»–å®¹å™¨**æ­£åœ¨è¿è¡Œï¼Œå¹¶ç”šè‡³**è¿›å…¥å®ƒä»¬**å¹¶**çªƒå–å®ƒä»¬é™„åŠ çš„IAMè§’è‰²**ã€‚

#### ä½¿å®¹å™¨åœ¨å½“å‰ä¸»æœºä¸Šè¿è¡Œ

æ­¤å¤–ï¼Œ**EC2å®ä¾‹è§’è‰²**é€šå¸¸ä¼šæœ‰è¶³å¤Ÿçš„**æƒé™**æ¥**æ›´æ–°EC2å®ä¾‹ä½œä¸ºèŠ‚ç‚¹åœ¨é›†ç¾¤å†…ä½¿ç”¨æ—¶çš„å®¹å™¨å®ä¾‹çŠ¶æ€**ã€‚æ”»å‡»è€…å¯ä»¥ä¿®æ”¹**å®ä¾‹çš„çŠ¶æ€ä¸ºDRAINING**ï¼Œç„¶åECSå°†**ä»ä¸­ç§»é™¤æ‰€æœ‰ä»»åŠ¡**ï¼Œå¹¶ä¸”ä½œä¸º**REPLICA**è¿è¡Œçš„ä»»åŠ¡å°†ä¼š**åœ¨ä¸åŒçš„å®ä¾‹ä¸Šè¿è¡Œ**ï¼Œæ½œåœ¨åœ°åœ¨**æ”»å‡»è€…çš„å®ä¾‹å†…**ï¼Œè¿™æ ·ä»–å°±å¯ä»¥**çªƒå–å®ƒä»¬çš„IAMè§’è‰²**å’Œå®¹å™¨å†…çš„æ½œåœ¨æ•æ„Ÿä¿¡æ¯ã€‚
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
åŒæ ·çš„æŠ€æœ¯å¯ä»¥é€šè¿‡**ä»é›†ç¾¤ä¸­æ³¨é”€EC2å®ä¾‹**æ¥å®Œæˆã€‚è¿™å¯èƒ½ä¸å¤ªéšè”½ï¼Œä½†å®ƒå°†**å¼ºåˆ¶ä»»åŠ¡åœ¨å…¶ä»–å®ä¾‹ä¸Šè¿è¡Œï¼š**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
æœ€åä¸€ç§å¼ºåˆ¶é‡æ–°æ‰§è¡Œä»»åŠ¡çš„æŠ€æœ¯æ˜¯é€šè¿‡æŒ‡ç¤ºECS **ä»»åŠ¡æˆ–å®¹å™¨å·²åœæ­¢**ã€‚æœ‰3ä¸ªæ½œåœ¨çš„APIå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ä» ECR å®¹å™¨ä¸­çªƒå–æ•æ„Ÿä¿¡æ¯

EC2 å®ä¾‹å¯èƒ½è¿˜å…·æœ‰æƒé™ `ecr:GetAuthorizationToken`ï¼Œå…è®¸å…¶**ä¸‹è½½é•œåƒ**ï¼ˆæ‚¨å¯ä»¥åœ¨å…¶ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼Œè¯·æŸ¥çœ‹</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒ HackTricks çš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family) æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
