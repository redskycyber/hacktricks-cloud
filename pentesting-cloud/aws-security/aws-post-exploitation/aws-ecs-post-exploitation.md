# AWS - Post Explotaci√≥n de ECS

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ECS

Para obtener m√°s informaci√≥n, consulta:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Roles IAM del host

En ECS, se puede asignar un **rol IAM a la tarea** que se ejecuta dentro del contenedor. **Si** la tarea se ejecuta dentro de una **instancia EC2**, la **instancia EC2** tendr√° **otro IAM** rol adjunto.\
Lo que significa que si logras **comprometer** una instancia ECS, potencialmente puedes **obtener el rol IAM asociado al ECR y a la instancia EC2**. Para obtener m√°s informaci√≥n sobre c√≥mo obtener esas credenciales, consulta:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Privesc al nodo para robar credenciales y secretos de otros contenedores

Pero adem√°s, EC2 utiliza Docker para ejecutar tareas de ECS, por lo que si puedes escapar al nodo o **acceder al socket de Docker**, puedes **verificar** qu√© **otros contenedores** se est√°n ejecutando e incluso **entrar en ellos** y **robar sus roles IAM** adjuntos.

#### Haciendo que los contenedores se ejecuten en el host actual

Adem√°s, el **rol de la instancia EC2** generalmente tendr√° suficientes **permisos** para **actualizar el estado de la instancia del contenedor** de las instancias EC2 que se utilizan como nodos dentro del cl√∫ster. Un atacante podr√≠a modificar el **estado de una instancia a DRAINING**, entonces ECS **eliminar√° todas las tareas de ella** y las que se ejecutan como **REPLICA** se ejecutar√°n en una instancia diferente, potencialmente dentro de la **instancia del atacante** para que pueda **robar sus roles IAM** e informaci√≥n potencialmente sensible desde dentro del contenedor.

```bash
aws ecs update-container-instances-state \
    --cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```

La misma t√©cnica se puede hacer **deregistrando la instancia EC2 del cl√∫ster**. Esto es potencialmente menos sigiloso, pero **obligar√° a que las tareas se ejecuten en otras instancias:**

```bash
aws ecs deregister-container-instance \
    --cluster <cluster> --container-instance <container-instance-id> --force
```

Una t√©cnica final para forzar la reejecuci√≥n de tareas es indicando a ECS que la **tarea o el contenedor se detuvo**. Hay 3 posibles APIs para hacer esto:

```bash
# Necesita: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
    --status STOPPED --reason "anything" --containers [...]

# Necesita: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Necesita: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```

### Robar informaci√≥n sensible de los contenedores de ECR

La instancia EC2 probablemente tambi√©n tendr√° el permiso `ecr:GetAuthorizationToken` que le permitir√° **descargar im√°genes** (podr√≠as buscar informaci√≥n sensible en ellas).