# AWS - EKS äº‹åæ¸—é€

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## EKS

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### ä»AWSæ§åˆ¶å°æšä¸¾é›†ç¾¤

å¦‚æœä½ æœ‰æƒé™ **`eks:AccessKubernetesApi`**ï¼Œä½ å¯ä»¥é€šè¿‡AWS EKSæ§åˆ¶å°**æŸ¥çœ‹Kuberneteså¯¹è±¡**ï¼ˆ[äº†è§£æ›´å¤š](https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html)ï¼‰ã€‚

### è¿æ¥åˆ°AWS Kubernetesé›†ç¾¤

* ç®€å•æ–¹å¼ï¼š
```bash
# Generate kubeconfig
aws eks update-kubeconfig --name aws-eks-dev
```
* ä¸æ˜¯é‚£ä¹ˆç®€å•çš„æ–¹æ³•ï¼š

å¦‚æœä½ èƒ½å¤Ÿä½¿ç”¨ **`aws eks get-token --name <cluster_name>`** **è·å–ä¸€ä¸ªä»¤ç‰Œ**ï¼Œä½†ä½ æ²¡æœ‰æƒé™è·å–é›†ç¾¤ä¿¡æ¯ï¼ˆdescribeClusterï¼‰ï¼Œä½ å¯ä»¥**å‡†å¤‡ä½ è‡ªå·±çš„ `~/.kube/config`**ã€‚ç„¶è€Œï¼Œæ‹¥æœ‰ä»¤ç‰Œï¼Œä½ ä»ç„¶éœ€è¦**è¿æ¥çš„ url ç«¯ç‚¹**å’Œ**é›†ç¾¤çš„åç§°**ã€‚

åœ¨æˆ‘çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘æ²¡æœ‰åœ¨ CloudWatch æ—¥å¿—ä¸­æ‰¾åˆ°ä¿¡æ¯ï¼Œä½†æˆ‘**åœ¨ LaunchTemplates çš„ userData ä¸­æ‰¾åˆ°äº†**ï¼Œä¹Ÿåœ¨ **EC2 æœºå™¨çš„ userData ä¸­æ‰¾åˆ°äº†**ã€‚ä½ å¯ä»¥åœ¨ **userData** ä¸­è½»æ¾çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼ˆé›†ç¾¤åç§°æ˜¯ cluster-nameï¼‰ï¼š

{% code overflow="wrap" %}
```bash
API_SERVER_URL=https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-east-1.eks.amazonaws.com

/etc/eks/bootstrap.sh cluster-name --kubelet-extra-args '--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=cluster-name,alpha.eksctl.io/nodegroup-name=prd-ondemand-us-west-2b,role=worker,eks.amazonaws.com/nodegroup-image=ami-002539dd2c532d0a5,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=prd-ondemand-us-west-2b,type=ondemand,eks.amazonaws.com/sourceLaunchTemplateId=lt-0f0f0ba62bef782e5 --max-pods=58' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP --use-max-pods false
```
<details>

<summary>kubeé…ç½®</summary>
```yaml
describe-cache-parametersapiVersion: v1
clusters:
- cluster:
certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1USXlPREUyTWpjek1Wb1hEVE15TVRJeU5URTJNamN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDlXCk9OS0ZqeXZoRUxDZGhMNnFwWkMwa1d0UURSRVF1UzVpRDcwK2pjbjFKWXZ4a3FsV1ZpbmtwOUt5N2x2ME5mUW8KYkNqREFLQWZmMEtlNlFUWVVvOC9jQXJ4K0RzWVlKV3dzcEZGbWlsY1lFWFZHMG5RV1VoMVQ3VWhOanc0MllMRQpkcVpzTGg4OTlzTXRLT1JtVE5sN1V6a05pTlUzSytueTZSRysvVzZmbFNYYnRiT2kwcXJSeFVpcDhMdWl4WGRVCnk4QTg3VjRjbllsMXo2MUt3NllIV3hhSm11eWI5enRtbCtBRHQ5RVhOUXhDMExrdWcxSDBqdTl1MDlkU09YYlkKMHJxY2lINjYvSTh0MjlPZ3JwNkY0dit5eUNJUjZFQURRaktHTFVEWUlVSkZ4WXA0Y1pGcVA1aVJteGJ5Nkh3UwpDSE52TWNJZFZRRUNQMlg5R2c4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZQVXFsekhWZmlDd0xqalhPRmJJUUc3L0VxZ1hNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1o4c0l4aXpsemx0aXRPcGcySgpYV0VUSThoeWxYNWx6cW1mV0dpZkdFVVduUDU3UEVtWW55eWJHbnZ5RlVDbnczTldMRTNrbEVMQVE4d0tLSG8rCnBZdXAzQlNYamdiWFovdWVJc2RhWlNucmVqNU1USlJ3SVFod250ZUtpU0J4MWFRVU01ZGdZc2c4SlpJY3I2WC8KRG5POGlHOGxmMXVxend1dUdHSHM2R1lNR0Mvd1V0czVvcm1GS291SmtSUWhBZElMVkNuaStYNCtmcHUzT21UNwprS3VmR0tyRVlKT09VL1c2YTB3OTRycU9iSS9Mem1GSWxJQnVNcXZWVDBwOGtlcTc1eklpdGNzaUJmYVVidng3Ci9sMGhvS1RqM0IrOGlwbktIWW4wNGZ1R2F2YVJRbEhWcldDVlZ4c3ZyYWpxOUdJNWJUUlJ6TnpTbzFlcTVZNisKRzVBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
server: https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-west-2.eks.amazonaws.com
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
contexts:
- context:
cluster: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
current-context: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
kind: Config
preferences: {}
users:
- name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user:
exec:
apiVersion: client.authentication.k8s.io/v1beta1
args:
- --region
- us-west-2
- --profile
- <profile>
- eks
- get-token
- --cluster-name
- <cluster-name>
command: aws
env: null
interactiveMode: IfAvailable
provideClusterInfo: false
```
</details>

### ä» AWS åˆ° Kubernetes

**EKS é›†ç¾¤çš„åˆ›å»ºè€…**å°†**å§‹ç»ˆ**èƒ½å¤Ÿè¿›å…¥å±äº**`system:masters`**ç»„çš„kubernetesé›†ç¾¤éƒ¨åˆ†ï¼ˆk8sç®¡ç†å‘˜ï¼‰ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œ**æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•**æ¥æ‰¾å‡º**è°åˆ›å»ºäº†**é›†ç¾¤ï¼ˆæ‚¨å¯ä»¥æ£€æŸ¥CloudTrailï¼‰ã€‚å¹¶ä¸”**æ²¡æœ‰åŠæ³•****ç§»é™¤**é‚£ä¸ª**æƒé™**ã€‚

æˆäºˆ**æ›´å¤šAWS IAMç”¨æˆ·æˆ–è§’è‰²è®¿é—®K8sçš„æ–¹å¼**æ˜¯ä½¿ç”¨**configmap** **`aws-auth`**ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œä»»ä½•å¯¹config map **`aws-auth`** æœ‰**å†™å…¥æƒé™**çš„äººéƒ½èƒ½å¤Ÿ**å±åŠæ•´ä¸ªé›†ç¾¤**ã€‚&#x20;
{% endhint %}

æœ‰å…³å¦‚ä½•**æˆäºˆIAMè§’è‰²å’Œç”¨æˆ·é¢å¤–æƒé™**ï¼Œæ— è®ºæ˜¯åœ¨**ç›¸åŒæˆ–ä¸åŒè´¦æˆ·**ä¸­ï¼Œä»¥åŠå¦‚ä½•**æ»¥ç”¨**è¿™ä¸€ç‚¹ä»¥[**æå‡æƒé™ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢**](../../kubernetes-security/abusing-roles-clusterroles-in-kubernetes/#aws-eks-aws-auth-configmaps)ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹[**è¿™ç¯‡ç²¾å½©çš„**](https://blog.lightspin.io/exploiting-eks-authentication-vulnerability-in-aws-iam-authenticator) **æ–‡ç« ï¼Œäº†è§£IAM -> Kubernetesèº«ä»½éªŒè¯çš„å·¥ä½œåŸç†**ã€‚

### ä» Kubernetes åˆ° AWS

å¯ä»¥å…è®¸**kubernetesæœåŠ¡è´¦æˆ·çš„OpenIDè®¤è¯**ï¼Œä»¥ä¾¿å®ƒä»¬åœ¨AWSä¸­æ‰®æ¼”è§’è‰²ã€‚äº†è§£[**è¿™åœ¨æ­¤é¡µé¢ä¸­çš„å·¥ä½œåŸç†**](../../kubernetes-security/kubernetes-pivoting-to-clouds.md#workflow-of-iam-role-for-service-accounts-1)ã€‚

### ç»•è¿‡ CloudTrail

å¦‚æœæ”»å‡»è€…è·å–äº†å…·æœ‰**æƒé™çš„AWS EKS**çš„å‡­æ®ã€‚å¦‚æœæ”»å‡»è€…é…ç½®è‡ªå·±çš„**`kubeconfig`**ï¼ˆä¸è°ƒç”¨**`update-kubeconfig`**ï¼‰ï¼Œå¦‚å‰æ‰€è¿°ï¼Œ**`get-token`**ä¸ä¼šåœ¨Cloudtrailä¸­ç”Ÿæˆæ—¥å¿—ï¼Œå› ä¸ºå®ƒä¸ä¸AWS APIäº¤äº’ï¼ˆå®ƒåªæ˜¯åœ¨æœ¬åœ°åˆ›å»ºä»¤ç‰Œï¼‰ã€‚

å› æ­¤ï¼Œå½“æ”»å‡»è€…ä¸EKSé›†ç¾¤é€šä¿¡æ—¶ï¼Œ**cloudtrailä¸ä¼šè®°å½•ä¸è¢«ç›—ç”¨æˆ·ç›¸å…³çš„ä»»ä½•å†…å®¹ä»¥åŠè®¿é—®å®ƒ**ã€‚

è¯·æ³¨æ„ï¼Œ**EKSé›†ç¾¤å¯èƒ½å¯ç”¨äº†æ—¥å¿—è®°å½•**ï¼Œè¿™å°†è®°å½•æ­¤è®¿é—®ï¼ˆå°½ç®¡é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬æ˜¯ç¦ç”¨çš„ï¼‰ã€‚

### EKS å‹’ç´¢ï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»º**é›†ç¾¤çš„**ç”¨æˆ·æˆ–è§’è‰²å§‹ç»ˆå°†æ‹¥æœ‰**é›†ç¾¤çš„ç®¡ç†å‘˜æƒé™ã€‚è€Œä¸”é‚£æ˜¯AWSå¯¹Kubernetesé›†ç¾¤çš„å”¯ä¸€â€œå®‰å…¨â€è®¿é—®æ–¹å¼ã€‚

å› æ­¤ï¼Œå¦‚æœ**æ”»å‡»è€…é€šè¿‡fargateå±åŠé›†ç¾¤**ï¼Œå¹¶**ç§»é™¤æ‰€æœ‰å…¶ä»–ç®¡ç†å‘˜**ï¼Œå¹¶**åˆ é™¤åˆ›å»º**é›†ç¾¤çš„AWSç”¨æˆ·/è§’è‰²ï¼Œ~~æ”»å‡»è€…å¯èƒ½å·²ç»**å‹’ç´¢äº†é›†ç¾¤**~~**ã€‚**

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨çš„æ˜¯**EC2 VMs**ï¼Œåˆ™å¯èƒ½ä»**èŠ‚ç‚¹**è·å¾—ç®¡ç†å‘˜æƒé™å¹¶æ¢å¤é›†ç¾¤ã€‚

å®é™…ä¸Šï¼Œå¦‚æœé›†ç¾¤ä½¿ç”¨Fargateï¼Œæ‚¨å¯ä»¥å°†EC2èŠ‚ç‚¹æˆ–å°†æ‰€æœ‰å†…å®¹ç§»è‡³EC2é›†ç¾¤ï¼Œå¹¶é€šè¿‡è®¿é—®èŠ‚ç‚¹ä¸­çš„ä»¤ç‰Œæ¥æ¢å¤å®ƒã€‚
{% endhint %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
