# AWS - EKSåæ¸—é€

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ–è€… **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## EKS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### ä»AWSæ§åˆ¶å°æšä¸¾é›†ç¾¤

å¦‚æœæ‚¨æ‹¥æœ‰**`eks:AccessKubernetesApi`**æƒé™ï¼Œæ‚¨å¯ä»¥é€šè¿‡AWS EKSæ§åˆ¶å°æŸ¥çœ‹Kuberneteså¯¹è±¡ï¼ˆ[äº†è§£æ›´å¤š](https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html)ï¼‰ã€‚

### è¿æ¥åˆ°AWS Kubernetesé›†ç¾¤

* ç®€å•æ–¹æ³•ï¼š
```bash
# Generate kubeconfig
aws eks update-kubeconfig --name aws-eks-dev
```
* ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“çš„æ–¹æ³•ï¼š

å¦‚æœä½ å¯ä»¥ä½¿ç”¨ **`aws eks get-token --name <cluster_name>`** è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œä½†æ˜¯ä½ æ²¡æœ‰æƒé™è·å–é›†ç¾¤ä¿¡æ¯ï¼ˆdescribeClusterï¼‰ï¼Œä½ å¯ä»¥ **å‡†å¤‡è‡ªå·±çš„ `~/.kube/config`**ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰äº†ä»¤ç‰Œï¼Œä½ ä»ç„¶éœ€è¦è¿æ¥åˆ°çš„ **URL ç»ˆç«¯ç‚¹**å’Œ **é›†ç¾¤çš„åç§°**ã€‚

åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ²¡æœ‰åœ¨ CloudWatch æ—¥å¿—ä¸­æ‰¾åˆ°è¿™äº›ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘åœ¨ **LaunchTemplates userData** å’Œ **EC2 machines userData** ä¸­æ‰¾åˆ°äº†å®ƒä»¬ã€‚ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ **userData** ä¸­çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ˆé›†ç¾¤åç§°ä¸º cluster-nameï¼‰ï¼š

{% code overflow="wrap" %}
```bash
API_SERVER_URL=https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-east-1.eks.amazonaws.com

/etc/eks/bootstrap.sh cluster-name --kubelet-extra-args '--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=cluster-name,alpha.eksctl.io/nodegroup-name=prd-ondemand-us-west-2b,role=worker,eks.amazonaws.com/nodegroup-image=ami-002539dd2c532d0a5,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=prd-ondemand-us-west-2b,type=ondemand,eks.amazonaws.com/sourceLaunchTemplateId=lt-0f0f0ba62bef782e5 --max-pods=58' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP --use-max-pods false
```
<details>

<summary>kubeé…ç½®</summary>
```yaml
describe-cache-parametersapiVersion: v1
clusters:
- cluster:
certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1USXlPREUyTWpjek1Wb1hEVE15TVRJeU5URTJNamN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDlXCk9OS0ZqeXZoRUxDZGhMNnFwWkMwa1d0UURSRVF1UzVpRDcwK2pjbjFKWXZ4a3FsV1ZpbmtwOUt5N2x2ME5mUW8KYkNqREFLQWZmMEtlNlFUWVVvOC9jQXJ4K0RzWVlKV3dzcEZGbWlsY1lFWFZHMG5RV1VoMVQ3VWhOanc0MllMRQpkcVpzTGg4OTlzTXRLT1JtVE5sN1V6a05pTlUzSytueTZSRysvVzZmbFNYYnRiT2kwcXJSeFVpcDhMdWl4WGRVCnk4QTg3VjRjbllsMXo2MUt3NllIV3hhSm11eWI5enRtbCtBRHQ5RVhOUXhDMExrdWcxSDBqdTl1MDlkU09YYlkKMHJxY2lINjYvSTh0MjlPZ3JwNkY0dit5eUNJUjZFQURRaktHTFVEWUlVSkZ4WXA0Y1pGcVA1aVJteGJ5Nkh3UwpDSE52TWNJZFZRRUNQMlg5R2c4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZQVXFsekhWZmlDd0xqalhPRmJJUUc3L0VxZ1hNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1o4c0l4aXpsemx0aXRPcGcySgpYV0VUSThoeWxYNWx6cW1mV0dpZkdFVVduUDU3UEVtWW55eWJHbnZ5RlVDbnczTldMRTNrbEVMQVE4d0tLSG8rCnBZdXAzQlNYamdiWFovdWVJc2RhWlNucmVqNU1USlJ3SVFod250ZUtpU0J4MWFRVU01ZGdZc2c4SlpJY3I2WC8KRG5POGlHOGxmMXVxend1dUdHSHM2R1lNR0Mvd1V0czVvcm1GS291SmtSUWhBZElMVkNuaStYNCtmcHUzT21UNwprS3VmR0tyRVlKT09VL1c2YTB3OTRycU9iSS9Mem1GSWxJQnVNcXZWVDBwOGtlcTc1eklpdGNzaUJmYVVidng3Ci9sMGhvS1RqM0IrOGlwbktIWW4wNGZ1R2F2YVJRbEhWcldDVlZ4c3ZyYWpxOUdJNWJUUlJ6TnpTbzFlcTVZNisKRzVBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
server: https://6253F6CA47F81264D8E16FAA7A103A0D.gr7.us-west-2.eks.amazonaws.com
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
contexts:
- context:
cluster: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
current-context: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
kind: Config
preferences: {}
users:
- name: arn:aws:eks:us-east-1:<acc-id>:cluster/<cluster-name>
user:
exec:
apiVersion: client.authentication.k8s.io/v1beta1
args:
- --region
- us-west-2
- --profile
- <profile>
- eks
- get-token
- --cluster-name
- <cluster-name>
command: aws
env: null
interactiveMode: IfAvailable
provideClusterInfo: false
```
</details>

### ä»AWSåˆ°Kubernetes

**EKSé›†ç¾¤çš„åˆ›å»ºè€…**å§‹ç»ˆå¯ä»¥è¿›å…¥kubernetesé›†ç¾¤çš„`system:masters`ç»„ï¼ˆk8sç®¡ç†å‘˜ï¼‰ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œ**æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•**å¯ä»¥æ‰¾åˆ°**åˆ›å»ºé›†ç¾¤çš„äºº**ï¼ˆå¯ä»¥æ£€æŸ¥CloudTrailï¼‰ã€‚ä¹Ÿ**æ²¡æœ‰åŠæ³•**å»**ç§»é™¤**è¿™ä¸ª**ç‰¹æƒ**ã€‚

æˆäºˆ**æ›´å¤šAWS IAMç”¨æˆ·æˆ–è§’è‰²å¯¹K8sçš„è®¿é—®æƒé™**çš„æ–¹æ³•æ˜¯ä½¿ç”¨**configmap**`aws-auth`ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œä»»ä½•å…·æœ‰å¯¹config map `aws-auth`çš„**å†™è®¿é—®æƒé™**çš„äººéƒ½å¯ä»¥**å±å®³æ•´ä¸ªé›†ç¾¤**ã€‚&#x20;
{% endhint %}

æœ‰å…³å¦‚ä½•åœ¨**ç›¸åŒæˆ–ä¸åŒçš„å¸æˆ·ä¸­æˆäºˆIAMè§’è‰²å’Œç”¨æˆ·é¢å¤–æƒé™**ä»¥åŠå¦‚ä½•**æ»¥ç”¨**æ­¤åŠŸèƒ½ï¼Œè¯·å‚é˜…[**æ­¤é¡µé¢**](../../kubernetes-security/abusing-roles-clusterroles-in-kubernetes/#aws-eks-aws-auth-configmaps)ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹[**è¿™ç¯‡ç²¾å½©çš„æ–‡ç« **](https://blog.lightspin.io/exploiting-eks-authentication-vulnerability-in-aws-iam-authenticator)ä»¥äº†è§£IAM-> Kubernetesèº«ä»½éªŒè¯çš„å·¥ä½œåŸç†ã€‚

### ä»Kubernetesåˆ°AWS

å¯ä»¥å…è®¸**KubernetesæœåŠ¡è´¦æˆ·ä½¿ç”¨OpenIDèº«ä»½éªŒè¯**ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨AWSä¸­æ‰®æ¼”è§’è‰²ã€‚äº†è§£[**æ­¤é¡µé¢ä¸Šçš„å·¥ä½œåŸç†**](../../kubernetes-security/kubernetes-pivoting-to-clouds.md#workflow-of-iam-role-for-service-accounts-1)ã€‚

### ç»•è¿‡CloudTrail

å¦‚æœæ”»å‡»è€…è·å¾—äº†å…·æœ‰**å¯¹EKSæƒé™çš„AWSå‡­æ®**ï¼Œå¹¶ä¸”æ”»å‡»è€…é…ç½®äº†è‡ªå·±çš„**`kubeconfig`**ï¼ˆè€Œä¸è°ƒç”¨**`update-kubeconfig`**ï¼‰ï¼Œå¦‚å‰æ‰€è¿°ï¼Œ**`get-token`**ä¸ä¼šåœ¨CloudTrailä¸­ç”Ÿæˆæ—¥å¿—ï¼Œå› ä¸ºå®ƒä¸ä¸AWS APIäº¤äº’ï¼ˆå®ƒåªæ˜¯åœ¨æœ¬åœ°åˆ›å»ºä»¤ç‰Œï¼‰ã€‚

å› æ­¤ï¼Œå½“æ”»å‡»è€…ä¸EKSé›†ç¾¤é€šä¿¡æ—¶ï¼Œ**cloudtrailä¸ä¼šè®°å½•ä»»ä½•ä¸è¢«ç›—ç”¨æˆ·ç›¸å…³çš„è®¿é—®**ã€‚

è¯·æ³¨æ„ï¼Œ**EKSé›†ç¾¤å¯èƒ½å·²å¯ç”¨æ—¥å¿—è®°å½•**ï¼Œå°†è®°å½•æ­¤è®¿é—®ï¼ˆå°½ç®¡é»˜è®¤æƒ…å†µä¸‹å·²ç¦ç”¨ï¼‰ã€‚

### EKSå‹’ç´¢

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»ºé›†ç¾¤çš„ç”¨æˆ·æˆ–è§’è‰²**å§‹ç»ˆå…·æœ‰å¯¹é›†ç¾¤çš„ç®¡ç†å‘˜ç‰¹æƒã€‚è¿™æ˜¯AWSå¯¹Kubernetesé›†ç¾¤çš„å”¯ä¸€â€œå®‰å…¨â€è®¿é—®ã€‚

å› æ­¤ï¼Œå¦‚æœ**æ”»å‡»è€…å…¥ä¾µäº†é›†ç¾¤**ï¼Œ**åˆ é™¤äº†æ‰€æœ‰å…¶ä»–ç®¡ç†å‘˜**å¹¶**åˆ é™¤äº†åˆ›å»ºé›†ç¾¤çš„AWSç”¨æˆ·/è§’è‰²**ï¼Œæ”»å‡»è€…å°†**æœ‰æ•ˆåœ°å‹’ç´¢äº†é›†ç¾¤**ã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨å¸Œæœ›åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬**æˆ–ä¸‹è½½**PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
