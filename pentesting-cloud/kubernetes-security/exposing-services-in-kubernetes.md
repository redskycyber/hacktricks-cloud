# åœ¨Kubernetesä¸­æš´éœ²æœåŠ¡

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

åœ¨Kubernetesä¸­ï¼Œæœ‰**ä¸åŒçš„æ–¹æ³•æ¥æš´éœ²æœåŠ¡**ï¼Œä»¥ä¾¿**å†…éƒ¨**å’Œ**å¤–éƒ¨**ç«¯ç‚¹éƒ½å¯ä»¥è®¿é—®å®ƒä»¬ã€‚è¿™ä¸ªKubernetesçš„é…ç½®éå¸¸å…³é”®ï¼Œå› ä¸ºç®¡ç†å‘˜å¯èƒ½ä¼šç»™**æ”»å‡»è€…è®¿é—®ä»–ä»¬ä¸åº”è¯¥è®¿é—®çš„æœåŠ¡çš„æƒé™**ã€‚

### è‡ªåŠ¨æšä¸¾

åœ¨å¼€å§‹æšä¸¾K8sæä¾›çš„å°†æœåŠ¡æš´éœ²ç»™å…¬ä¼—çš„æ–¹å¼ä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºå‘½åç©ºé—´ã€æœåŠ¡å’Œå…¥å£ç‚¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°æ‰€æœ‰å¯¹å…¬ä¼—å¼€æ”¾çš„å†…å®¹ï¼š
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP**æœåŠ¡æ˜¯Kubernetesçš„**é»˜è®¤**æœåŠ¡ã€‚å®ƒä¸ºæ‚¨çš„é›†ç¾¤æä¾›äº†ä¸€ä¸ªå…¶ä»–åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®çš„**é›†ç¾¤å†…éƒ¨æœåŠ¡**ã€‚æ²¡æœ‰**å¤–éƒ¨è®¿é—®**ã€‚

ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨Kubernetesä»£ç†è®¿é—®æ­¤æœåŠ¡ï¼š
```
kubectl proxy --port=8080
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµè§ˆKubernetes APIä»¥è®¿é—®æœåŠ¡ï¼š

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹URLï¼š

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

æ¥è®¿é—®æ­¤æœåŠ¡ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_è¿™ç§æ–¹æ³•è¦æ±‚æ‚¨ä»¥**å·²è®¤è¯çš„ç”¨æˆ·**èº«ä»½è¿è¡Œ`kubectl`ã€‚_

### NodePort

**NodePortåœ¨æ‰€æœ‰èŠ‚ç‚¹**ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸Šæ‰“å¼€ä¸€ä¸ªç‰¹å®šçš„ç«¯å£ï¼Œä»»ä½•å‘é€åˆ°è¯¥ç«¯å£çš„**æµé‡**éƒ½ä¼šè¢«**è½¬å‘åˆ°æœåŠ¡**ã€‚é€šå¸¸è¿™æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„é€‰é¡¹ã€‚

NodePortè§„èŒƒçš„ç¤ºä¾‹ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
å¦‚æœæ‚¨åœ¨yamlä¸­**ä¸æŒ‡å®š**nodePortï¼ˆå®ƒæ˜¯å°†è¦æ‰“å¼€çš„ç«¯å£ï¼‰ï¼Œåˆ™å°†ä½¿ç”¨**30000-32767èŒƒå›´å†…çš„ç«¯å£**ã€‚

### LoadBalancer <a href="#0d96" id="0d96"></a>

ä½¿ç”¨**äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨**å°†æœåŠ¡å…¬å¼€ç»™å¤–éƒ¨ã€‚åœ¨GKEä¸Šï¼Œè¿™å°†å¯åŠ¨ä¸€ä¸ª[ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/network/)ï¼Œè¯¥è´Ÿè½½å‡è¡¡å™¨å°†ä¸ºæ‚¨æä¾›ä¸€ä¸ªå•ä¸€çš„IPåœ°å€ï¼Œå°†æ‰€æœ‰æµé‡è½¬å‘åˆ°æ‚¨çš„æœåŠ¡ã€‚

æ‚¨éœ€è¦ä¸ºæ¯ä¸ªå…¬å¼€çš„æœåŠ¡æ”¯ä»˜è´Ÿè½½å‡è¡¡å™¨è´¹ç”¨ï¼Œè¿™å¯èƒ½ä¼šå¾ˆæ˜‚è´µã€‚

### ExternalName

ExternalNameç±»å‹çš„æœåŠ¡å°†**å°†æœåŠ¡æ˜ å°„åˆ°DNSåç§°**ï¼Œè€Œä¸æ˜¯å…¸å‹çš„é€‰æ‹©å™¨ï¼Œå¦‚`my-service`æˆ–`cassandra`ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`spec.externalName`å‚æ•°æŒ‡å®šè¿™äº›æœåŠ¡ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹æœåŠ¡å®šä¹‰å°†`prod`å‘½åç©ºé—´ä¸­çš„`my-service`æœåŠ¡æ˜ å°„åˆ°`my.database.example.com`ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
å½“æŸ¥æ‰¾ä¸»æœº`my-service.prod.svc.cluster.local`æ—¶ï¼Œé›†ç¾¤DNSæœåŠ¡è¿”å›ä¸€ä¸ªå€¼ä¸º`my.database.example.com`çš„`CNAME`è®°å½•ã€‚è®¿é—®`my-service`çš„æ–¹å¼ä¸å…¶ä»–æœåŠ¡ç›¸åŒï¼Œä½†å…³é”®åŒºåˆ«åœ¨äº**é‡å®šå‘å‘ç”Ÿåœ¨DNSå±‚é¢**ï¼Œè€Œä¸æ˜¯é€šè¿‡ä»£ç†æˆ–è½¬å‘ã€‚

### å¤–éƒ¨IP <a href="#external-ips" id="external-ips"></a>

ä»¥**å¤–éƒ¨IP**ï¼ˆä½œä¸º**ç›®æ ‡IP**ï¼‰è¿›å…¥é›†ç¾¤çš„æµé‡ï¼Œå°†è¢«**è·¯ç”±åˆ°å…¶ä¸­ä¸€ä¸ªæœåŠ¡ç«¯ç‚¹**ã€‚`externalIPs`ä¸ç”±Kubernetesç®¡ç†ï¼Œè€Œæ˜¯ç”±é›†ç¾¤ç®¡ç†å‘˜è´Ÿè´£ã€‚

åœ¨æœåŠ¡è§„èŒƒä¸­ï¼Œå¯ä»¥ä¸ä»»ä½•`ServiceTypes`ä¸€èµ·æŒ‡å®š`externalIPs`ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ"`my-service`"å¯ä»¥é€šè¿‡"`80.11.12.10:80`"ï¼ˆ`externalIP:port`ï¼‰è®¿é—®ã€‚
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress

ä¸ä¸Šè¿°æ‰€æœ‰ç¤ºä¾‹ä¸åŒï¼Œ**Ingressä¸æ˜¯ä¸€ç§æœåŠ¡ç±»å‹**ã€‚ç›¸åï¼Œå®ƒä½äºå¤šä¸ªæœåŠ¡ä¹‹å‰ï¼Œå……å½“â€œæ™ºèƒ½è·¯ç”±å™¨â€æˆ–é›†ç¾¤çš„å…¥å£ç‚¹ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨Ingressæ‰§è¡Œè®¸å¤šä¸åŒçš„æ“ä½œï¼Œå¹¶ä¸”æœ‰**è®¸å¤šä¸åŒåŠŸèƒ½çš„Ingressæ§åˆ¶å™¨**ã€‚

é»˜è®¤çš„GKE Ingressæ§åˆ¶å™¨å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ª[HTTP(S)è´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/)ã€‚è¿™å°†ä½¿æ‚¨èƒ½å¤Ÿå¯¹åç«¯æœåŠ¡è¿›è¡ŒåŸºäºè·¯å¾„å’Œå­åŸŸçš„è·¯ç”±ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†foo.yourdomain.comçš„æ‰€æœ‰å†…å®¹å‘é€åˆ°fooæœåŠ¡ï¼Œå°†yourdomain.com/bar/è·¯å¾„ä¸‹çš„æ‰€æœ‰å†…å®¹å‘é€åˆ°baræœåŠ¡ã€‚

åœ¨GKEä¸Šä½¿ç”¨[L7 HTTPè´Ÿè½½å‡è¡¡å™¨](https://cloud.google.com/compute/docs/load-balancing/http/)çš„Ingresså¯¹è±¡çš„YAMLå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### å‚è€ƒèµ„æ–™

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**The PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
