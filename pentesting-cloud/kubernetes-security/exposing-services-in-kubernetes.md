# Ujawnianie usug w Kubernetes

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Istnieje **kilka sposob贸w ujawniania usug** w Kubernetes, dziki czemu zar贸wno **wewntrzne** punkty kocowe, jak i **zewntrzne** punkty kocowe mog do nich uzyska dostp. Konfiguracja Kubernetes jest do krytyczna, poniewa偶 administrator mo偶e udostpni **atakujcym usugi, do kt贸rych nie powinni mie dostpu**.

### Automatyczne wyliczanie

Przed rozpoczciem wyliczania sposob贸w, jakie K8s oferuje do ujawniania usug publicznie, warto wiedzie, 偶e jeli mo偶na wywietli przestrzenie nazw, usugi i wprowadzenia, mo偶na znale藕 wszystko, co jest ujawnione publicznie za pomoc:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

Usuga **ClusterIP** jest **domyln** usug Kubernetes. Daje ci **usug wewntrz** twojego klastra, do kt贸rej inne aplikacje wewntrz klastra mog uzyska dostp. Nie ma **dostpu zewntrznego**.

Jednak mo偶na uzyska do niej dostp za pomoc Kubernetes Proxy:
```
kubectl proxy --port=8080
```
Teraz mo偶esz nawigowa przez interfejs API Kubernetes, aby uzyska dostp do usug, korzystajc z tego schematu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Na przykad, mo偶esz u偶y nastpujcego adresu URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

aby uzyska dostp do tej usugi:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Ta metoda wymaga uruchomienia `kubectl` jako **uwierzytelniony u偶ytkownik**._

### NodePort

Kiedy jest wykorzystywany **NodePort**, okrelony port jest udostpniany na wszystkich wzach (reprezentujcych wirtualne maszyny). **Ruch** skierowany do tego konkretnego portu jest nastpnie systematycznie **kierowany do usugi**. Zwykle ta metoda nie jest zalecana ze wzgldu na jej wady.

Przykad specyfikacji NodePort:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Jeli **nie okrelisz** **nodePort** w pliku yaml (jest to port, kt贸ry zostanie otwarty), zostanie u偶yty port w **zakresie 30000-32767**.

### LoadBalancer <a href="#0d96" id="0d96"></a>

Wystawia usug na zewntrz, **korzystajc z load balancera dostawcy chmury**. W przypadku GKE, zostanie uruchomiony [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/), kt贸ry zapewni pojedynczy adres IP, przekierowujcy cay ruch do Twojej usugi.

Musisz paci za LoadBalancer dla ka偶dej wystawionej usugi, co mo偶e by kosztowne.

### ExternalName

**[Z dokumentacji:](https://kubernetes.io/docs/concepts/services-networking/service/#externalname)**
Usugi typu ExternalName **mapuj usug na nazw DNS**, a nie na typowy selektor, tak jak `my-service` lub `cassandra`. Okrelasz te usugi za pomoc parametru `spec.externalName`.

Na przykad, poni偶sza definicja usugi mapuje usug `my-service` w przestrzeni nazw `prod` na `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Podczas wyszukiwania hosta `my-service.prod.svc.cluster.local`, usuga DNS klastra zwraca rekord `CNAME` o wartoci `my.database.example.com`. Dostp do `my-service` dziaa tak samo jak w przypadku innych usug, ale z istotn r贸偶nic, 偶e **przekierowanie nastpuje na poziomie DNS**, a nie za porednictwem proxy lub przekazywania.

### Zewntrzne adresy IP <a href="#external-ips" id="external-ips"></a>

Ruch, kt贸ry wchodzi do klastra z **zewntrznym adresem IP** (jako **adres docelowy IP**) na porcie usugi, zostanie **przekierowany do jednego z punkt贸w kocowych usugi**. `externalIPs` nie s zarzdzane przez Kubernetes i s odpowiedzialnoci administratora klastra.

W specyfikacji usugi mo偶na okreli `externalIPs` wraz z dowolnym z `ServiceTypes`. W poni偶szym przykadzie "`my-service`" mo偶na uzyska dostp przez klient贸w na "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress

W przeciwiestwie do wszystkich powy偶szych przykad贸w, **Ingress NIE jest rodzajem usugi**. Zamiast tego, dziaa on **przed wieloma usugami i peni rol "inteligentnego routera"** lub punktu wejcia do klastra.

Mo偶esz wykonywa wiele r贸偶nych czynnoci za pomoc Ingress, a istnieje **wiele rodzaj贸w kontroler贸w Ingress o r贸偶nych mo偶liwociach**.

Domylny kontroler Ingress w GKE uruchomi dla Ciebie [Load Balancer HTTP(S)](https://cloud.google.com/compute/docs/load-balancing/http/). Dziki temu bdziesz m贸g wykonywa zar贸wno routowanie oparte na cie偶ce, jak i oparte na subdomenie do usug backendowych. Na przykad, mo偶esz przekierowa wszystko na foo.yourdomain.com do usugi foo, a wszystko pod cie偶k yourdomain.com/bar/ do usugi bar.

Poni偶ej znajduje si przykad YAML dla obiektu Ingress w GKE z [Load Balancerem HTTP L7](https://cloud.google.com/compute/docs/load-balancing/http/):
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### Odnoniki

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
