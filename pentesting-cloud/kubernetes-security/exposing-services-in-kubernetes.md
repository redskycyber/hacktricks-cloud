# Izlaganje usluga u Kubernetesu

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Postoje **razli캜iti na캜ini izlaganja usluga** u Kubernetesu tako da ih mogu pristupiti kako **interni** tako i **eksterni** endpointi. Ova konfiguracija Kubernetesa je prili캜no kriti캜na jer administrator mo쬰 omogu캖iti pristup **napada캜ima uslugama do kojih ne bi trebali imati pristup**.

### Automatsko nabrojavanje

Pre nego 코to po캜nete nabrojavati na캜ine na koje K8s omogu캖ava izlaganje usluga javnosti, znajte da ako mo쬰te izlistati namespace-ove, usluge i ingress-e, mo쬰te prona캖i sve 코to je izlo쬰no javnosti pomo캖u:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP** servis je **podrazumevani** Kubernetes **servis**. Pru쬬 vam **servis unutar** va코eg klastera kojem drugi programi unutar klastera mogu pristupiti. Nema **spoljnog pristupa**.

Me캠utim, ovome se mo쬰 pristupiti kori코캖enjem Kubernetes Proxy-ja:
```
kubectl proxy --port=8080
```
Sada mo쬰te navigirati kroz Kubernetes API kako biste pristupili uslugama koriste캖i ovu 코emu:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Na primer, mo쬰te koristiti slede캖i URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

da pristupite ovoj usluzi:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_Ova metoda zahteva da pokrenete `kubectl` kao **autentifikovanog korisnika**._

### NodePort

Kada se koristi **NodePort**, odre캠eni port je dostupan na svim 캜vorovima (koji predstavljaju virtuelne ma코ine). **Saobra캖aj** usmeren ka ovom specifi캜nom portu se zatim sistematski **preusmerava na servis**. Ova metoda se obi캜no ne preporu캜uje zbog svojih nedostataka.

Primer specifikacije NodePort-a:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
Ako **ne navedete** **nodePort** u yaml (to je port koji 캖e biti otvoren), koristi캖e se port u **opsegu 30000-32767**.

### LoadBalancer <a href="#0d96" id="0d96"></a>

Izla쬰 Servis spolja **koriste캖i load balancer cloud provajdera**. Na GKE, ovo 캖e pokrenuti [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) koji 캖e vam dati jednu IP adresu koja 캖e preusmeravati sav saobra캖aj ka va코em servisu.

Morate platiti za LoadBalancer po izlo쬰nom servisu, 코to mo쬰 biti skupo.

### ExternalName

**[Iz dokumentacije:](https://kubernetes.io/docs/concepts/services-networking/service/#externalname)**
Servisi tipa ExternalName **mapiraju Servis na DNS ime**, a ne na tipi캜ni selektor kao 코to su `my-service` ili `cassandra`. Ove Servise defini코ete sa parametrom `spec.externalName`.

Na primer, ovaj definisani Servis mapira `my-service` Servis u `prod` namespace-u na `my.database.example.com`:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
Kada se pretra쬿je host `my-service.prod.svc.cluster.local`, DNS usluga klastera vra캖a `CNAME` zapis sa vredno코캖u `my.database.example.com`. Pristupanje `my-service` radi na isti na캜in kao i ostale usluge, ali sa klju캜nom razlikom da **preusmeravanje se de코ava na nivou DNS-a**, umesto putem proksiranja ili prosle캠ivanja.

### Spoljni IP-ovi <a href="#external-ips" id="external-ips"></a>

Saobra캖aj koji ulazi u klaster sa **spoljnim IP-om** (kao **odredi코ni IP**), na portu usluge, 캖e biti **usmeren ka jednom od krajnjih ta캜aka usluge**. `externalIPs` nisu upravljani od strane Kubernetes-a i odgovornost je administratora klastera.

U specifikaciji usluge, `externalIPs` mogu biti navedeni zajedno sa bilo kojim od `ServiceTypes`. U primeru ispod, "`my-service`" mo쬰 biti pristupljen od strane klijenata na "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress

Za razliku od svih prethodnih primera, **Ingress NIJE vrsta servisa**. Umesto toga, on se nalazi **ispred vi코e servisa i deluje kao "pametni ruter"** ili ulaz u va코 klaster.

Mo쬰te uraditi mnogo razli캜itih stvari sa Ingress-om, i postoje **mnoge vrste kontrolera Ingress-a koji imaju razli캜ite mogu캖nosti**.

Podrazumevani GKE kontroler Ingress-a 캖e pokrenuti [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) za vas. To 캖e vam omogu캖iti rutiranje na osnovu putanje i poddomena ka pozadinskim servisima. Na primer, mo쬰te poslati sve sa foo.yourdomain.com na servis foo, a sve ispod putanje yourdomain.com/bar/ na servis bar.

YAML za Ingress objekat na GKE sa [L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) mo쬰 izgledati ovako:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### Reference

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
