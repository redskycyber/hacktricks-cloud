# Exposition de services dans Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

Il existe **diff√©rentes fa√ßons d'exposer des services** dans Kubernetes afin que les points de terminaison **internes** et **externes** puissent y acc√©der. Cette configuration Kubernetes est assez critique car l'administrateur pourrait donner acc√®s √† des **attaquants √† des services auxquels ils ne devraient pas avoir acc√®s**.

### √ânum√©ration automatique

Avant de commencer √† √©num√©rer les fa√ßons dont K8s offre pour exposer des services au public, sachez que si vous pouvez lister les espaces de noms, les services et les entr√©es, vous pouvez trouver tout ce qui est expos√© au public avec :

```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
    echo "Namespace: $ns"
    kubectl get service -n "$ns"
    kubectl get ingress -n "$ns"
    echo "=============================================="
    echo ""
    echo ""
done | grep -v "ClusterIP"
# Supprimez le dernier '| grep -v "ClusterIP"' pour voir √©galement le type ClusterIP
```

### ClusterIP

Un service **ClusterIP** est le **service Kubernetes par d√©faut**. Il vous donne un **service √† l'int√©rieur** de votre cluster que d'autres applications √† l'int√©rieur de votre cluster peuvent acc√©der. Il n'y a **pas d'acc√®s externe**.

Cependant, cela peut √™tre accessible en utilisant le proxy Kubernetes :

```
kubectl proxy --port=8080
```

Maintenant, vous pouvez naviguer dans l'API Kubernetes pour acc√©der aux services en utilisant ce sch√©ma :

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Par exemple, vous pourriez utiliser l'URL suivante :

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

pour acc√©der √† ce service :

```yaml
apiVersion: v1
kind: Service
metadata:  
  name: my-internal-service
spec:
  selector:    
    app: my-app
  type: ClusterIP
  ports:  
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
```

_Cette m√©thode n√©cessite que vous ex√©cutiez `kubectl` en tant qu'utilisateur **authentifi√©**._

### NodePort

**NodePort ouvre un port sp√©cifique sur tous les n≈ìuds** (les VM), et tout **trafic** envoy√© √† ce port est **redirig√© vers le service**. C'est une option vraiment mauvaise en g√©n√©ral.

Un exemple de sp√©cification NodePort :

```yaml
apiVersion: v1
kind: Service
metadata:  
  name: my-nodeport-service
spec:
  selector:    
    app: my-app
  type: NodePort
  ports:  
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30036
    protocol: TCP
```

Si vous ne **sp√©cifiez pas** le **nodePort** dans le yaml (c'est le port qui sera ouvert), un port dans la **plage 30000-32767 sera utilis√©**.

### LoadBalancer <a href="#0d96" id="0d96"></a>

Expose le service de mani√®re externe en utilisant le **load balancer du fournisseur de cloud**. Sur GKE, cela fera tourner un [Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/) qui vous donnera une seule adresse IP qui redirigera tout le trafic vers votre service.

Vous devez payer pour un LoadBalancer par service expos√©, ce qui peut devenir cher.

### ExternalName

Les services de type ExternalName **cartographient un service sur un nom DNS**, et non sur un s√©lecteur typique tel que `my-service` ou `cassandra`. Vous sp√©cifiez ces services avec le param√®tre `spec.externalName`.

Cette d√©finition de service, par exemple, cartographie le service `my-service` dans l'espace de noms `prod` sur `my.database.example.com` :

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: prod
spec:
  type: ExternalName
  externalName: my.database.example.com
```

Lorsque vous recherchez l'h√¥te `my-service.prod.svc.cluster.local`, le service DNS de cluster renvoie un enregistrement `CNAME` avec la valeur `my.database.example.com`. L'acc√®s √† `my-service` fonctionne de la m√™me mani√®re que pour les autres services, mais avec la diff√©rence cruciale que **la redirection se produit au niveau DNS** plut√¥t que par proxy ou transfert.

### Adresses IP externes <a href="#external-ips" id="external-ips"></a>

Le trafic qui entre dans le cluster avec l'**adresse IP externe** (en tant qu'**adresse IP de destination**), sur le port du service, sera **rout√© vers l'un des points de terminaison du service**. Les `externalIPs` ne sont pas g√©r√©s par Kubernetes et rel√®vent de la responsabilit√© de l'administrateur de cluster.

Dans la sp√©cification du service, `externalIPs` peuvent √™tre sp√©cifi√©s avec n'importe quel des `ServiceTypes`. Dans l'exemple ci-dessous, "`my-service`" peut √™tre accessible par les clients sur "`80.11.12.10:80`" (`externalIP:port`)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: MyApp
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 9376
  externalIPs:
    - 80.11.12.10
```

### Ingress

Contrairement √† tous les exemples ci-dessus, **Ingress n'est PAS un type de service**. Au lieu de cela, il se trouve devant plusieurs services et agit comme un "routeur intelligent" ou un point d'entr√©e dans votre cluster.

Vous pouvez faire beaucoup de choses diff√©rentes avec un Ingress, et il existe **de nombreux types de contr√¥leurs Ingress qui ont des capacit√©s diff√©rentes**.

Le contr√¥leur d'entr√©e par d√©faut de GKE fera tourner un [HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/) pour vous. Cela vous permet