# Pentesting Servicios de Kubernetes

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utiliza varios **servicios de red espec铆ficos** que podr铆an estar **expuestos a Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podr铆a ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podr铆a ser buscar `"k8s.%.com"` en github y buscar **archivos YAML** que contengan la cadena.

## C贸mo Kubernetes expone servicios

Podr铆a ser 煤til para ti entender c贸mo Kubernetes puede **exponer servicios p煤blicamente** para encontrarlos:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podr铆an estar abiertos en un cl煤ster de Kubernetes:

| Puerto          | Proceso         | Descripci贸n                                                            |
| --------------- | --------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver  | Puerto de la API de Kubernetes                                         |
| 2379/TCP        | etcd            |                                                                        |
| 6666/TCP        | etcd            | etcd                                                                   |
| 4194/TCP        | cAdvisor        | M茅tricas de contenedores                                                |
| 6443/TCP        | kube-apiserver  | Puerto de la API de Kubernetes                                         |
| 8443/TCP        | kube-apiserver  | Puerto de la API de Minikube                                           |
| 8080/TCP        | kube-apiserver  | Puerto de API no seguro                                                |
| 10250/TCP       | kubelet         | API HTTPS que permite acceso en modo completo                          |
| 10255/TCP       | kubelet         | Puerto HTTP de solo lectura sin autenticaci贸n: pods, pods en ejecuci贸n y estado del nodo |
| 10256/TCP       | kube-proxy      | Servidor de verificaci贸n de estado de Kube Proxy                      |
| 9099/TCP        | calico-felix    | Servidor de verificaci贸n de estado para Calico                        |
| 6782-4/TCP      | weave           | M茅tricas y puntos finales                                              |
| 30000-32767/TCP | NodePort        | Proxy a los servicios                                                  |
| 44134/TCP       | Tiller          | Servicio de Helm escuchando                                            |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Este es el **servicio API de Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero tambi茅n 8443 en minikube y 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consulte la siguiente p谩gina para aprender c贸mo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio **se ejecuta en cada nodo del cl煤ster**. Es el servicio que **controlar谩** las pods dentro del **nodo**. Se comunica con el **kube-apiserver**.

Si encuentra este servicio expuesto, es posible que haya encontrado un **RCE sin autenticaci贸n**.

#### API de Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la respuesta es `Unauthorized`, entonces requiere autenticaci贸n.

Si puedes listar nodos, puedes obtener una lista de puntos finales de kubelets con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Solo lectura)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API de etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller es un componente de Kubernetes que gestiona los despliegues de Helm en el cl煤ster.
```
helm --host tiller-deploy.kube-system:44134 version
```
Puedes abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio 煤til para recopilar m茅tricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Cuando un puerto se expone en todos los nodos a trav茅s de un **NodePort**, el mismo puerto se abre en todos los nodos para redirigir el tr谩fico al **Servicio** declarado. Por defecto, este puerto estar谩 en el **rango 30000-32767**. Por lo tanto, nuevos servicios no verificados podr铆an ser accesibles a trav茅s de esos puertos.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configuraciones Vulnerables

### Acceso An贸nimo al Kube-apiserver

El acceso an贸nimo a los **puntos finales de la API de kube-apiserver no est谩 permitido**. Sin embargo, podr铆as verificar algunos puntos finales:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificaci贸n de Acceso An贸nimo a ETCD**

ETCD almacena secretos del cl煤ster, archivos de configuraci贸n y otros **datos sensibles**. Por **defecto**, el ETCD **no puede** ser accedido **an贸nimamente**, pero siempre es bueno verificar.

Si se puede acceder al ETCD de forma an贸nima, es posible que necesites **utilizar la** [**herramienta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). El siguiente comando obtendr谩 todas las claves almacenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

La [**documentaci贸n de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **defecto se permite el acceso an贸nimo** al servicio:

> Habilita las solicitudes an贸nimas al servidor Kubelet. Las solicitudes que no son rechazadas por otro m茅todo de autenticaci贸n se tratan como solicitudes an贸nimas. Las solicitudes an贸nimas tienen un nombre de usuario `system:anonymous` y un nombre de grupo `system:unauthenticated`.

Para comprender mejor c贸mo funciona la **autenticaci贸n y autorizaci贸n de la API de Kuebelet**, consulte esta p谩gina:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

El **servicio Kubelet** **API no est谩 documentado**, pero el c贸digo fuente se puede encontrar aqu铆 y encontrar los puntos finales expuestos es tan f谩cil como **ejecutar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con los Kubelets y sus puntos finales.

#### /pods

Este punto final lista los pods y sus contenedores:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite ejecutar c贸digo dentro de cualquier contenedor de forma muy sencilla:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Comprobaci贸n de la Exposici贸n de Informaci贸n del Puerto de Solo Lectura de Kubelet**

Cuando se expone un **puerto de solo lectura de kubelet**, se vuelve posible que se recupere informaci贸n de la API por parte de partes no autorizadas. La exposici贸n de este puerto puede llevar a la divulgaci贸n de varios **elementos de configuraci贸n del cl煤ster**. Aunque la informaci贸n, incluidos **nombres de pods, ubicaciones de archivos internos y otras configuraciones**, puede que no sea cr铆tica, su exposici贸n a煤n representa un riesgo de seguridad y se debe evitar.

Un ejemplo de c贸mo esta vulnerabilidad puede ser explotada implica que un atacante remoto acceda a una URL espec铆fica. Al navegar a `http://<external-IP>:10255/pods`, el atacante potencialmente puede recuperar informaci贸n sensible del kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
