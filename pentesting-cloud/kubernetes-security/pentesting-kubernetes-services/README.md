# Pentesting Kubernetes Services

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

Kubernetes ä½¿ç”¨å¤šä¸ª**ç‰¹å®šçš„ç½‘ç»œæœåŠ¡**ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°å®ƒä»¬**æš´éœ²åœ¨äº’è”ç½‘ä¸Š**ï¼Œæˆ–è€…åœ¨æ‚¨**æ”»ç ´ä¸€ä¸ª pod å**åœ¨**å†…éƒ¨ç½‘ç»œä¸­**ã€‚

## ä½¿ç”¨ OSINT æŸ¥æ‰¾æš´éœ²çš„ pods

ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯åœ¨ [crt.sh](https://crt.sh) ä¸­æœç´¢ `Identity LIKE "k8s.%.com"` æ¥æ‰¾åˆ°ä¸ kubernetes ç›¸å…³çš„å­åŸŸåã€‚å¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯åœ¨ github ä¸Šæœç´¢ `"k8s.%.com"` å¹¶æœç´¢åŒ…å«è¯¥å­—ç¬¦ä¸²çš„**YAML æ–‡ä»¶**ã€‚

## Kubernetes å¦‚ä½•æš´éœ²æœåŠ¡

äº†è§£ Kubernetes å¦‚ä½•**å…¬å¼€æš´éœ²æœåŠ¡**å¯èƒ½å¯¹æ‚¨å¯»æ‰¾å®ƒä»¬å¾ˆæœ‰ç”¨ï¼š

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## é€šè¿‡ç«¯å£æ‰«ææŸ¥æ‰¾æš´éœ²çš„ pods

Kubernetes é›†ç¾¤ä¸­å¯èƒ½å¼€æ”¾ä»¥ä¸‹ç«¯å£ï¼š

| ç«¯å£              | è¿›ç¨‹             | æè¿°                                    |
| --------------- | -------------- | ------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API ç«¯å£                     |
| 2379/TCP        | etcd           |                                       |
| 6666/TCP        | etcd           | etcd                                  |
| 4194/TCP        | cAdvisor       | å®¹å™¨æŒ‡æ ‡                                  |
| 6443/TCP        | kube-apiserver | Kubernetes API ç«¯å£                     |
| 8443/TCP        | kube-apiserver | Minikube API ç«¯å£                       |
| 8080/TCP        | kube-apiserver | ä¸å®‰å…¨çš„ API ç«¯å£                           |
| 10250/TCP       | kubelet        | å…è®¸å®Œå…¨æ¨¡å¼è®¿é—®çš„ HTTPS API                   |
| 10255/TCP       | kubelet        | æœªç»è®¤è¯çš„åªè¯» HTTP ç«¯å£ï¼špodsã€æ­£åœ¨è¿è¡Œçš„ pods å’ŒèŠ‚ç‚¹çŠ¶æ€ |
| 10256/TCP       | kube-proxy     | Kube Proxy å¥åº·æ£€æŸ¥æœåŠ¡å™¨                    |
| 9099/TCP        | calico-felix   | Calico çš„å¥åº·æ£€æŸ¥æœåŠ¡å™¨                       |
| 6782-4/TCP      | weave          | æŒ‡æ ‡å’Œç«¯ç‚¹                                 |
| 30000-32767/TCP | NodePort       | æœåŠ¡çš„ä»£ç†                                 |
| 44134/TCP       | Tiller         | Helm æœåŠ¡ç›‘å¬                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

è¿™æ˜¯**API Kubernetes æœåŠ¡**ï¼Œç®¡ç†å‘˜é€šå¸¸ä½¿ç”¨å·¥å…·\*\*`kubectl`\*\*ä¸ä¹‹äº¤äº’ã€‚

**å¸¸è§ç«¯å£ï¼š6443 å’Œ 443**ï¼Œä½†åœ¨ minikube ä¸­ä¹Ÿæœ‰ 8443ï¼Œä»¥åŠä¸å®‰å…¨çš„ 8080ã€‚

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•é€šè¿‡ä¸æ­¤æœåŠ¡é€šä¿¡æ¥è·å–æ•æ„Ÿæ•°æ®å’Œæ‰§è¡Œæ•æ„Ÿæ“ä½œï¼š**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

æ­¤æœåŠ¡**åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚å®ƒæ˜¯å°†**æ§åˆ¶**èŠ‚ç‚¹å†…éƒ¨çš„ pods çš„æœåŠ¡ã€‚å®ƒä¸**kube-apiserver**é€šä¿¡ã€‚

å¦‚æœä½ å‘ç°æ­¤æœåŠ¡æš´éœ²äº†ï¼Œä½ å¯èƒ½æ‰¾åˆ°äº†ä¸€ä¸ª**æœªç»è®¤è¯çš„ RCE**ã€‚

#### Kubelet API

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

å¦‚æœå“åº”æ˜¯`Unauthorized`ï¼Œåˆ™è¡¨ç¤ºå®ƒéœ€è¦è®¤è¯ã€‚

å¦‚æœæ‚¨å¯ä»¥åˆ—å‡ºèŠ‚ç‚¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–kubeletç«¯ç‚¹çš„åˆ—è¡¨ï¼š

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubeletï¼ˆåªè¯»ï¼‰

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### etcd API

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

### cAdvisor

ç”¨äºæ”¶é›†æŒ‡æ ‡çš„æœåŠ¡ã€‚

```
curl -k https://<IP Address>:4194
```

### NodePort

å½“ç«¯å£é€šè¿‡ **NodePort** åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæš´éœ²æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½ä¼šæ‰“å¼€ç›¸åŒçš„ç«¯å£ï¼Œå¹¶å°†æµé‡ä»£ç†åˆ°å£°æ˜çš„ **Service**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤ç«¯å£å°†ä½äº **èŒƒå›´ 30000-32767** å†…ã€‚å› æ­¤ï¼Œæ–°çš„æœªç»æ£€æŸ¥çš„æœåŠ¡å¯èƒ½é€šè¿‡è¿™äº›ç«¯å£è®¿é—®ã€‚

```
sudo nmap -sS -p 30000-32767 <IP>
```

## æ˜“å—æ”»å‡»çš„é”™è¯¯é…ç½®

### Kube-apiserver åŒ¿åè®¿é—®

**kube-apiserver API ç«¯ç‚¹ä¸å…è®¸**åŒ¿åè®¿é—®ã€‚ä½†æ˜¯ä½ å¯ä»¥æ£€æŸ¥ä¸€äº›ç«¯ç‚¹ï¼š

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **æ£€æŸ¥ ETCD åŒ¿åè®¿é—®**

ETCD å­˜å‚¨é›†ç¾¤å¯†é’¥ã€é…ç½®æ–‡ä»¶å’Œæ›´å¤š**æ•æ„Ÿæ•°æ®**ã€‚**é»˜è®¤æƒ…å†µä¸‹**ï¼ŒETCD **ä¸èƒ½**è¢«**åŒ¿å**è®¿é—®ï¼Œä½†å§‹ç»ˆæ£€æŸ¥æ˜¯å¥½çš„ã€‚

å¦‚æœå¯ä»¥åŒ¿åè®¿é—® ETCDï¼Œä½ å¯èƒ½éœ€è¦**ä½¿ç”¨** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **å·¥å…·**ã€‚ä»¥ä¸‹å‘½ä»¤å°†è·å–å­˜å‚¨çš„æ‰€æœ‰é”®ï¼š

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

[Kubelet æ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)è§£é‡Šè¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯**å…è®¸åŒ¿åè®¿é—®**æœåŠ¡çš„ï¼š

> å…è®¸å¯¹ Kubelet æœåŠ¡å™¨è¿›è¡ŒåŒ¿åè¯·æ±‚ã€‚æœªè¢«å…¶ä»–è®¤è¯æ–¹æ³•æ‹’ç»çš„è¯·æ±‚å°†è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ã€‚åŒ¿åè¯·æ±‚çš„ç”¨æˆ·åä¸º `system:anonymous`ï¼Œç»„åä¸º `system:unauthenticated`

è¦æ›´å¥½åœ°ç†è§£**Kubelet API çš„è®¤è¯å’Œæˆæƒæ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** æœåŠ¡**API æ²¡æœ‰æ–‡æ¡£è®°å½•**ï¼Œä½†æºä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼Œæ‰¾åˆ°æš´éœ²çš„ç«¯ç‚¹å°±åƒ**è¿è¡Œ**ä¸€æ ·ç®€å•ï¼š

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

æ‰€æœ‰è¿™äº›å¬èµ·æ¥éƒ½å¾ˆæœ‰è¶£ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ [**Kubeletctl**](https://github.com/cyberark/kubeletctl) å·¥å…·ä¸ Kubelets åŠå…¶ç«¯ç‚¹è¿›è¡Œäº¤äº’ã€‚

#### /pods

æ­¤ç«¯ç‚¹åˆ—å‡º pods åŠå…¶å®¹å™¨ï¼š

```bash
kubeletctl pods
```

#### /exec

æ­¤ç«¯ç‚¹å…è®¸åœ¨ä»»ä½•å®¹å™¨å†…éå¸¸å®¹æ˜“åœ°æ‰§è¡Œä»£ç ï¼š

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
ä¸ºäº†é¿å…è¿™ç§æ”»å‡»ï¼Œåº”è¯¥ä½¿ç”¨ `--anonymous-auth false` è¿è¡Œ _**kubelet**_ æœåŠ¡ï¼Œå¹¶ä¸”åº”è¯¥åœ¨ç½‘ç»œå±‚é¢ä¸Šå¯¹æœåŠ¡è¿›è¡Œéš”ç¦»ã€‚
{% endhint %}

### **æ£€æŸ¥ Kubeletï¼ˆåªè¯»ç«¯å£ï¼‰ä¿¡æ¯æ³„éœ²**

å½“**kubelet åªè¯»ç«¯å£**æš´éœ²æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥ä» API æ£€ç´¢ä¿¡æ¯ã€‚è¿™ä¼šæš´éœ²**é›†ç¾¤é…ç½®å…ƒç´ ï¼Œä¾‹å¦‚ pods åç§°ã€å†…éƒ¨æ–‡ä»¶ä½ç½®å’Œå…¶ä»–é…ç½®**ã€‚è¿™ä¸æ˜¯å…³é”®ä¿¡æ¯ï¼Œä½†ä»ç„¶ä¸åº”è¯¥æš´éœ²ç»™äº’è”ç½‘ã€‚

ä¾‹å¦‚ï¼Œè¿œç¨‹æ”»å‡»è€…å¯ä»¥é€šè¿‡è®¿é—®ä»¥ä¸‹ URL æ¥æ»¥ç”¨æ­¤æ¼æ´ï¼š`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## å‚è€ƒèµ„æ–™

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
