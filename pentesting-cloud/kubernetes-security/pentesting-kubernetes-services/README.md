# Testowanie penetracyjne usug Kubernetes

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kubernetes u偶ywa kilku **konkretnych usug sieciowych**, kt贸re mog by **odsonite w Internecie** lub w **sieci wewntrznej po skompromitowaniu jednego z pod贸w**.

## Znajdowanie odsonitych pod贸w za pomoc OSINT

Jednym ze sposob贸w mo偶e by wyszukiwanie `Identity LIKE "k8s.%.com"` w [crt.sh](https://crt.sh), aby znale藕 subdomeny zwizane z kubernetes. Innym sposobem mo偶e by wyszukiwanie `"k8s.%.com"` w github i szukanie plik贸w **YAML** zawierajcych ten cig.

## Jak Kubernetes Odsania Usugi

Mo偶e by przydatne zrozumienie, w jaki spos贸b Kubernetes mo偶e **odsania usugi publicznie**, aby je znale藕:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Znajdowanie odsonitych pod贸w poprzez skanowanie port贸w

Nastpujce porty mog by otwarte w klastrze Kubernetes:

| Port            | Proces         | Opis                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port API Kubernetes                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metryki kontener贸w                                                     |
| 6443/TCP        | kube-apiserver | Port API Kubernetes                                                    |
| 8443/TCP        | kube-apiserver | Port API Minikube                                                      |
| 8080/TCP        | kube-apiserver | Niezabezpieczony port API                                              |
| 10250/TCP       | kubelet        | API HTTPS umo偶liwiajce peny dostp                                    |
| 10255/TCP       | kubelet        | Nieuwierzytelniony port HTTP tylko do odczytu: pod贸w, dziaajcych pod贸w i stanu wza |
| 10256/TCP       | kube-proxy     | Serwer sprawdzania stanu Kube Proxy                                    |
| 9099/TCP        | calico-felix   | Serwer sprawdzania stanu dla Calico                                    |
| 6782-4/TCP      | weave          | Metryki i punkty kocowe                                                |
| 30000-32767/TCP | NodePort       | Proxy do usug                                                         |
| 44134/TCP       | Tiller         | Usuga Helm nasuchujca                                                |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

To jest **usuga API Kubernetes**, z kt贸r zazwyczaj rozmawiaj administratorzy za pomoc narzdzia **`kubectl`**.

**Typowe porty: 6443 i 443**, ale tak偶e 8443 w minikube oraz 8080 jako niezabezpieczony.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Sprawd藕 nastpujc stron, aby dowiedzie si, jak uzyska poufne dane i wykona czynnoci wymagajce uprawnie w komunikacji z tym usug:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ta usuga **dziaa na ka偶dym w藕le klastra**. Jest to usuga, kt贸ra bdzie **kontrolowa** pody wewntrz **wza**. Komunikuje si z **kube-apiserver**.

Jeli znajdziesz t usug wystawion, mo偶esz natrafi na **nieuwierzytelniony RCE**.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Jeli odpowied藕 brzmi `Unauthorized`, oznacza to konieczno uwierzytelnienia.

Jeli mo偶esz wywietli list wz贸w, mo偶esz uzyska list punkt贸w kocowych kubelet贸w za pomoc:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Tylko do odczytu)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### Interfejs API etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Mo偶esz wykorzysta ten serwis do eskalacji uprawnie wewntrz Kubernetes:

### cAdvisor

Usuga przydatna do zbierania metryk.
```
curl -k https://<IP Address>:4194
```
### NodePort

Gdy port jest wystawiony we wszystkich wzach za pomoc **NodePort**, ten sam port jest otwarty we wszystkich wzach, przekierowujc ruch do zadeklarowanego **Service**. Domylnie ten port bdzie w zakresie **30000-32767**. Dlatego nowe niezweryfikowane usugi mog by dostpne za pomoc tych port贸w.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Wra偶liwe bdy konfiguracyjne

### Dostp anonimowy do kube-apiserver

Dostp anonimowy do punkt贸w kocowych **API kube-apiservera nie jest dozwolony**. Jednak mo偶na sprawdzi niekt贸re punkty kocowe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Sprawdzanie dostpu anonimowego do ETCD**

ETCD przechowuje tajne klucze klastra, pliki konfiguracyjne i inne **dane wra偶liwe**. Domylnie **nie** mo偶na uzyska **anonimowego dostpu** do ETCD, ale zawsze warto to sprawdzi.

Jeli ETCD mo偶na uzyska anonimowo, mo偶e by konieczne **u偶ycie** [**narzdzia etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Poni偶sze polecenie pobierze wszystkie przechowywane klucze:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Dokumentacja **Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) wyjania, 偶e domylnie **dostp anonimowy do usugi jest dozwolony:**

> Umo偶liwia anonimowe 偶dania do serwera **Kubelet**. 呕dania, kt贸re nie s odrzucane przez inny spos贸b uwierzytelniania, s traktowane jako 偶dania anonimowe. 呕dania anonimowe maj nazw u偶ytkownika `system:anonymous` i nazw grupy `system:unauthenticated`.

Aby lepiej zrozumie, jak dziaa **uwierzytelnianie i autoryzacja interfejsu API Kuebelet**, sprawd藕 t stron:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**API usugi Kubelet** nie jest udokumentowane, ale kod 藕r贸dowy mo偶na znale藕 tutaj, a znalezienie wystawionych punkt贸w kocowych jest tak proste jak **uruchomienie**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Mo偶esz u偶y narzdzia [**Kubeletctl**](https://github.com/cyberark/kubeletctl), aby komunikowa si z Kubeletami i ich punktami kocowymi.

#### /pods

Ten punkt kocowy wywietla list pod贸w i ich kontener贸w:
```bash
kubeletctl pods
```
#### /exec

Ten punkt kocowy pozwala atwo wykonywa kod wewntrz dowolnego kontenera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Aby unikn tego ataku, usuga _**kubelet**_ powinna by uruchomiona z flag `--anonymous-auth false`, a usuga powinna by odseparowana na poziomie sieci.
{% endhint %}

### **Sprawdzanie Wystawienia Informacji Portu Tylko do Odczytu Kubelet**

Gdy **port tylko do odczytu kubelet** jest wystawiony, istnieje mo偶liwo pobierania informacji z interfejsu API przez nieautoryzowane strony. Wystawienie tego portu mo偶e prowadzi do ujawnienia r贸偶nych **element贸w konfiguracji klastra**. Chocia偶 informacje, takie jak **nazwy pod贸w, lokalizacje wewntrznych plik贸w i inne konfiguracje**, mog nie by krytyczne, ich ujawnienie wci偶 stanowi ryzyko dla bezpieczestwa i powinno by unikane.

Przykadem wykorzystania tej podatnoci jest sytuacja, w kt贸rej zdalny atakujcy uzyskuje dostp do okrelonego adresu URL. Przechodzc pod `http://<zewntrzny-IP>:10255/pods`, atakujcy mo偶e potencjalnie pozyska wra偶liwe informacje z kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
