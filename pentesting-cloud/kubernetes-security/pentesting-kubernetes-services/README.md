# Pentesting Kubernetes Services

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kubernetes korzysta z kilku **konkretnych usug sieciowych**, kt贸re mog by **odsonite w Internecie** lub w **sieci wewntrznej po skompromitowaniu jednego poda**.

## Wyszukiwanie odsonitych pod贸w za pomoc OSINT

Jednym ze sposob贸w mo偶e by wyszukiwanie `Identity LIKE "k8s.%.com"` w [crt.sh](https://crt.sh), aby znale藕 subdomeny zwizane z Kubernetes. Innym sposobem mo偶e by wyszukiwanie `"k8s.%.com"` w githubie i szukanie plik贸w **YAML** zawierajcych ten cig.

## Spos贸b, w jaki Kubernetes odsania usugi

Mo偶e by przydatne, aby zrozumie, w jaki spos贸b Kubernetes mo偶e **publicznie odsania usugi**, aby je znale藕:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Wyszukiwanie odsonitych pod贸w za pomoc skanowania port贸w

Nastpujce porty mog by otwarte w klastrze Kubernetes:

| Port            | Proces         | Opis                                                                            |
| --------------- | -------------- | ------------------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port API Kubernetes                                                             |
| 2379/TCP        | etcd           |                                                                                 |
| 6666/TCP        | etcd           | etcd                                                                            |
| 4194/TCP        | cAdvisor       | Metryki kontener贸w                                                              |
| 6443/TCP        | kube-apiserver | Port API Kubernetes                                                             |
| 8443/TCP        | kube-apiserver | Port API Minikube                                                               |
| 8080/TCP        | kube-apiserver | Port API bez zabezpiecze                                                       |
| 10250/TCP       | kubelet        | Port HTTPS, kt贸ry umo偶liwia peny dostp w trybie penego dostpu               |
| 10255/TCP       | kubelet        | Nieuwierzytelniony port HTTP tylko do odczytu: pod, dziaajce pod i stan wza |
| 10256/TCP       | kube-proxy     | Serwer sprawdzania stanu Kube Proxy                                             |
| 9099/TCP        | calico-felix   | Serwer sprawdzania stanu dla Calico                                             |
| 6782-4/TCP      | weave          | Metryki i punkty kocowe                                                        |
| 30000-32767/TCP | NodePort       | Proxy do usug                                                                  |
| 44134/TCP       | Tiller         | Usuga Helm nasuchujca                                                        |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

To jest usuga **API Kubernetes**, z kt贸r administratorzy zazwyczaj rozmawiaj za pomoc narzdzia **`kubectl`**.

**Wsp贸lne porty: 6443 i 443**, ale tak偶e 8443 w minikube i 8080 jako niezabezpieczony.

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**Sprawd藕 nastpujc stron, aby dowiedzie si, jak uzyska poufne dane i wykonywa czynnoci zwizane z tym usug:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ta usuga **dziaa na ka偶dym w藕le klastra**. Jest to usuga, kt贸ra **kontroluje** pojemniki wewntrz **wza**. Komunikuje si z **kube-apiserver**.

Jeli znajdziesz t usug wystawion, mo偶esz natrafi na **nieuwierzytelnion RCE**.

#### Kubelet API

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

Jeli odpowied藕 to `Unauthorized`, oznacza to, 偶e wymagane jest uwierzytelnienie.

Jeli mo偶esz wywietli list wz贸w, mo偶esz uzyska list punkt贸w kocowych kubelet贸w za pomoc:

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet (Tylko do odczytu)

Kubelet jest komponentem Kubelet API, kt贸ry dziaa na ka偶dym w藕le klastra Kubernetes. Udostpnia on interfejs REST, kt贸ry umo偶liwia odczyt informacji o w藕le, takich jak metadane, statystyki i dzienniki. Mo偶na go wykorzysta do zdobywania informacji o w藕le, takich jak wersja Kubelet, adres IP, status zdrowia i wiele innych.

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### etcd API

API etcd jest kluczowym elementem w klastrze Kubernetes, poniewa偶 przechowuje i zarzdza konfiguracj klastra. Jest to rozproszona baza danych, kt贸ra przechowuje dane w postaci klucz-warto. API etcd udostpnia zestaw operacji, kt贸re umo偶liwiaj zarzdzanie danymi przechowywanymi w etcd.

#### Podstawowe operacje API etcd

* `PUT`: Su偶y do dodawania lub aktualizowania wartoci pod okrelonym kluczem.
* `GET`: Su偶y do pobierania wartoci pod okrelonym kluczem.
* `DELETE`: Su偶y do usuwania wartoci pod okrelonym kluczem.
* `WATCH`: Su偶y do monitorowania zmian w danym kluczu.

#### Wykorzystanie API etcd w celach pentestowych

Podczas testowania penetracyjnego klastra Kubernetes, warto zwr贸ci uwag na API etcd, poniewa偶 mo偶e ono by podatne na r贸偶ne ataki. Poni偶ej przedstawiamy kilka przykad贸w potencjalnych zagro偶e:

1. **Przechwytywanie danych**: Jeli atakujcy uzyska dostp do API etcd, mo偶e przechwyci dane przechowywane w klastrze, w tym poufne informacje, takie jak hasa czy klucze prywatne.
2. **Modyfikacja danych**: Atakujcy mo偶e zmienia wartoci przechowywane w etcd, co mo偶e prowadzi do dezinformacji lub zak贸ce w dziaaniu klastra.
3. **Usunicie danych**: Atakujcy mo偶e usun dane przechowywane w etcd, co mo偶e prowadzi do utraty wa偶nych informacji lub zak贸ce w dziaaniu klastra.

W celu zabezpieczenia klastra Kubernetes przed atakami na API etcd, nale偶y podj odpowiednie rodki ostro偶noci, takie jak:

* Skonfigurowanie uwierzytelniania i autoryzacji dla API etcd.
* Ustalenie zasad kontroli dostpu do API etcd.
* Monitorowanie i rejestrowanie dziaa w API etcd w celu wykrywania podejrzanych aktywnoci.

Pamitaj, 偶e testowanie penetracyjne klastra Kubernetes powinno by przeprowadzane tylko na wasnym rodowisku lub z odpowiedni zgod.

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

Tiller jest komponentem serwera, kt贸ry dziaa na klastrze Kubernetes i jest odpowiedzialny za zarzdzanie instalacj i konfiguracj aplikacji w Helm. Tiller jest podatny na ataki, poniewa偶 domylnie jest skonfigurowany do dziaania z uprawnieniami klastra. To oznacza, 偶e Tiller ma peny dostp do zasob贸w klastra i mo偶e wykonywa operacje na poziomie administratora.

Ataki na Tiller mog prowadzi do naruszenia bezpieczestwa klastra Kubernetes. Przykadowe ataki obejmuj zdalne wykonanie kodu, eskalacj uprawnie i wykradanie poufnych informacji.

Aby zabezpieczy Tiller, zaleca si:

* Wyczenie Tiller w klastrze produkcyjnym i korzystanie z alternatywnych metod instalacji i zarzdzania aplikacjami w Helm.
* Ograniczenie uprawnie Tillera do minimalnego niezbdnego poziomu, aby unikn nadmiernych uprawnie.
* U偶ywanie uwierzytelniania i autoryzacji na poziomie klastra, aby kontrolowa dostp do Tillera.
* Regularne aktualizowanie Tillera i innych komponent贸w klastra Kubernetes, aby unikn wykorzystania znanych podatnoci.

Pamitaj, 偶e Tiller jest tylko jednym z wielu potencjalnych wektor贸w ataku w klastrze Kubernetes. Wa偶ne jest, aby przeprowadzi kompleksowe testy penetracyjne i monitorowa bezpieczestwo klastra, aby zapobiec ewentualnym naruszeniom.

```
helm --host tiller-deploy.kube-system:44134 version
```

Mo偶na wykorzysta ten serwis do eskalacji uprawnie wewntrz Kubernetes:

### cAdvisor

Usuga przydatna do zbierania metryk.

```
curl -k https://<IP Address>:4194
```

### NodePort

Kiedy port jest wystawiony na wszystkich wzach za pomoc **NodePort**, ten sam port jest otwarty na wszystkich wzach, przekierowujc ruch do zadeklarowanej **Usugi**. Domylnie ten port bdzie w zakresie **30000-32767**. Dlatego nowe niezweryfikowane usugi mog by dostpne za pomoc tych port贸w.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Podatne bdy konfiguracji

### Dostp anonimowy do kube-apiserver

Dostp anonimowy do punkt贸w kocowych API **kube-apiserver nie jest dozwolony**. Jednak mo偶na sprawdzi niekt贸re punkty kocowe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Sprawdzanie dostpu anonimowego do ETCD

ETCD przechowuje tajne dane klastra, pliki konfiguracyjne i inne **wra偶liwe dane**. Domylnie ETCD **nie mo偶e** by dostpny **anonimowo**, ale zawsze warto sprawdzi.

Jeli ETCD mo偶e by dostpny anonimowo, mo偶e by konieczne **u偶ycie narzdzia** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Poni偶sze polecenie pobierze wszystkie przechowywane klucze:

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

[Dokumentacja **Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) wyjania, 偶e domylnie dostp do usugi jest **dozwolony dla anonimowych u偶ytkownik贸w**:

> Umo偶liwia anonimowe 偶dania do serwera Kubelet. 呕dania, kt贸re nie zostan odrzucone przez inny spos贸b uwierzytelniania, s traktowane jako anonimowe 偶dania. Anonimowe 偶dania maj nazw u偶ytkownika `system:anonymous` i nazw grupy `system:unauthenticated`.

Aby lepiej zrozumie, jak dziaa **uwierzytelnianie i autoryzacja API Kubelet**, sprawd藕 t stron:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Usuga **Kubelet** nie jest **udokumentowana**, ale kod 藕r贸dowy mo偶na znale藕 tutaj, a znalezienie wystawionych punkt贸w kocowych jest tak proste jak **uruchomienie**:

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

Wszystkie one brzmi interesujco.

Mo偶esz u偶y narzdzia [**Kubeletctl**](https://github.com/cyberark/kubeletctl), aby komunikowa si z Kubeletami i ich punktami kocowymi.

#### /pods

Ten punkt kocowy wywietla list pod贸w i ich kontener贸w:

```bash
kubeletctl pods
```

#### /exec

Ten punkt kocowy umo偶liwia atwe wykonywanie kodu wewntrz dowolnego kontenera:

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
Aby unikn tego ataku, usuga _**kubelet**_ powinna by uruchamiana z opcj `--anonymous-auth false`, a usuga powinna by segregowana na poziomie sieciowym.
{% endhint %}

### **Sprawdzanie wycieku informacji z portu tylko do odczytu Kubelet**

Gdy port tylko do odczytu **kubelet** jest wystawiony, mo偶liwe jest pobranie informacji z interfejsu API przez nieuprawnione osoby. Wystawienie tego portu mo偶e prowadzi do ujawnienia r贸偶nych element贸w **konfiguracji klastra**. Chocia偶 informacje, takie jak **nazwy pod贸w, lokalizacje wewntrznych plik贸w i inne konfiguracje**, mog nie by krytyczne, ich ujawnienie wci偶 stanowi ryzyko dla bezpieczestwa i powinno by unikane.

Przykadem wykorzystania tej podatnoci jest zdalny atakujcy, kt贸ry uzyskuje dostp do okrelonego adresu URL. Przechodzc pod `http://<external-IP>:10255/pods`, atakujcy mo偶e potencjalnie pozyska wra偶liwe informacje z kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w na GitHubie.**

</details>
