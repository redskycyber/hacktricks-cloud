# Pentesting Kubernetes Usluge

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Kubernetes koristi nekoliko **specifiÄnih mreÅ¾nih servisa** koje moÅ¾da pronaÄ‘ete **izloÅ¾ene Internetu** ili u **internoj mreÅ¾i nakon Å¡to ste kompromitovali jedan pod**.

## PronalaÅ¾enje izloÅ¾enih podova pomoÄ‡u OSINT-a

Jedan naÄin moÅ¾e biti pretraga `Identity LIKE "k8s.%.com"` na [crt.sh](https://crt.sh) kako biste pronaÅ¡li poddomene povezane sa Kubernetes-om. Drugi naÄin moÅ¾e biti pretraga `"k8s.%.com"` na github-u i traÅ¾enje **YAML fajlova** koji sadrÅ¾e taj string.

## Kako Kubernetes IzlaÅ¾e Usluge

MoÅ¾e biti korisno da razumete kako Kubernetes moÅ¾e **javno izloÅ¾iti usluge** kako biste ih pronaÅ¡li:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## PronalaÅ¾enje IzloÅ¾enih podova putem skeniranja portova

SledeÄ‡i portovi mogu biti otvoreni u Kubernetes klasteru:

| Port            | Proces         | Opis                                                                   |
| --------------- | -------------- | ----------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port Kubernetes API-a                                                  |
| 2379/TCP        | etcd           |                                                                         |
| 6666/TCP        | etcd           | etcd                                                                    |
| 4194/TCP        | cAdvisor       | Metrike kontejnera                                                     |
| 6443/TCP        | kube-apiserver | Port Kubernetes API-a                                                  |
| 8443/TCP        | kube-apiserver | Minikube API port                                                       |
| 8080/TCP        | kube-apiserver | Nesiguran API port                                                     |
| 10250/TCP       | kubelet        | HTTPS API koji omoguÄ‡ava pun pristup                                    |
| 10255/TCP       | kubelet        | Neautentifikovani samo-ÄitajuÄ‡i HTTP port: podovi, pokrenuti podovi i stanje Ävora |
| 10256/TCP       | kube-proxy     | Kube Proxy server za proveru zdravlja                                   |
| 9099/TCP        | calico-felix   | Server za proveru zdravlja za Calico                                    |
| 6782-4/TCP      | weave          | Metrike i endpointi                                                    |
| 30000-32767/TCP | NodePort       | Proxy ka uslugama                                                      |
| 44134/TCP       | Tiller         | Helm servis koji osluÅ¡kuje                                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Ovo je **API Kubernetes servis** sa kojim administratori obiÄno komuniciraju koristeÄ‡i alat **`kubectl`**.

**UobiÄajeni portovi: 6443 i 443**, ali i 8443 u minikube-u i 8080 kao nesiguran.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Proverite sledeÄ‡u stranicu da biste saznali kako da dobijete osetljive podatke i izvrÅ¡ite osetljive radnje komunicirajuÄ‡i sa ovom uslugom:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ova usluga **radi na svakom Ävoru klastera**. To je usluga koja Ä‡e **kontrolisati** podove unutar **Ävora**. Komunicira sa **kube-apiserverom**.

Ako pronaÄ‘ete ovu uslugu izloÅ¾enu, moÅ¾da ste pronaÅ¡li **neovlaÅ¡Ä‡eni RCE**.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ako je odgovor `Unauthorized`, onda je potrebna autentikacija.

Ako moÅ¾ete da nabrojite Ävorove, moÅ¾ete dobiti listu kubelet endpointa sa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Samo Äitanje)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiler
```
helm --host tiller-deploy.kube-system:44134 version
```
MoÅ¾ete zloupotrebiti ovu uslugu da biste eskalirali privilegije unutar Kubernetes-a:

### cAdvisor

Usluga korisna za prikupljanje metrika.
```
curl -k https://<IP Address>:4194
```
### NodePort

Kada je port izloÅ¾en na svim Ävorovima putem **NodePort**, isti port je otvoren na svim Ävorovima koji prosleÄ‘uju saobraÄ‡aj u deklarisani **Service**. Podrazumevano, ovaj port Ä‡e biti u **opsegu 30000-32767**. Dakle, novi neprovereni servisi mogu biti dostupni preko tih portova.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Ranjive nesigurnosti

### Pristup anonimnom pristupu kube-apiserver API endpointima

Anoniman pristup **kube-apiserver API endpointima nije dozvoljen**. MeÄ‘utim, moÅ¾ete proveriti neke endpointe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Provera anonimnog pristupa ETCD-u**

ETCD Äuva tajne klastera, konfiguracione datoteke i viÅ¡e **osetljivih podataka**. Podrazumevano, ETCD **ne moÅ¾e** biti pristupljen **anonimno**, ali uvek je dobro proveriti.

Ako se ETCD moÅ¾e pristupiti anonimno, moÅ¾da Ä‡e vam biti potrebno **koristiti** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **alat**. SledeÄ‡a komanda Ä‡e dohvatiti sve saÄuvane kljuÄeve:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Dokumentacija za Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) objaÅ¡njava da je **podrazumevano dozvoljen anoniman pristup** servisu:

> OmoguÄ‡ava anonimne zahteve ka Kubelet serveru. Zahtevi koji nisu odbijeni drugim metodama autentifikacije tretiraju se kao anonimni zahtevi. Anonimni zahtevi imaju korisniÄko ime `system:anonymous`, i ime grupe `system:unauthenticated`.

Za bolje razumevanje kako **autentifikacija i autorizacija Kubelet API-ja funkcioniÅ¡u**, pogledajte ovu stranicu:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**API servisa Kubelet** nije dokumentovan, ali izvorni kod moÅ¾e se pronaÄ‡i ovde, a pronalaÅ¾enje izloÅ¾enih taÄaka je jednostavno kao **pokretanje**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
MoÅ¾ete koristiti alat [**Kubeletctl**](https://github.com/cyberark/kubeletctl) da biste komunicirali sa Kubeletima i njihovim endpointima.

#### /pods

Ovaj endpoint prikazuje podove i njihove kontejnere:
```bash
kubeletctl pods
```
#### /exec

Ovaj endpoint omoguÄ‡ava izvrÅ¡avanje koda unutar bilo kog kontejnera vrlo jednostavno:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Da biste izbegli ovaj napad, servis _**kubelet**_ treba pokrenuti sa `--anonymous-auth false` i servis treba izolovati na nivou mreÅ¾e.
{% endhint %}

### **Provera IzloÅ¾enih Informacija o Kubeletu (Samo za Äitanje)**

Kada je **kubelet read-only port** izloÅ¾en, postaje moguÄ‡e da neovlaÅ¡Ä‡ene strane povuku informacije sa API-ja. IzloÅ¾enost ovog porta moÅ¾e dovesti do otkrivanja razliÄitih **elemenata konfiguracije klastera**. Iako informacije, ukljuÄujuÄ‡i **imena podova, lokacije internih fajlova i druge konfiguracije**, moÅ¾da nisu kritiÄne, njihova izloÅ¾enost ipak predstavlja sigurnosni rizik i treba je izbeÄ‡i.

Primer kako ova ranjivost moÅ¾e biti iskoriÅ¡Ä‡ena ukljuÄuje udaljenog napadaÄa koji pristupa odreÄ‘enom URL-u. Navigiranjem na `http://<external-IP>:10255/pods`, napadaÄ potencijalno moÅ¾e povuÄ‡i osetljive informacije sa kubeleta:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Reference

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od poÄetnika do struÄnjaka sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
