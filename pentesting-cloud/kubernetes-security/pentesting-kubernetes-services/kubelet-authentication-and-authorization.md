# Kubeletèº«ä»½éªŒè¯ä¸æˆæƒ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Kubeletèº«ä»½éªŒè¯ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[æ¥è‡ªæ–‡æ¡£ï¼š](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

é»˜è®¤æƒ…å†µä¸‹ï¼Œæœªè¢«å…¶ä»–é…ç½®çš„èº«ä»½éªŒè¯æ–¹æ³•æ‹’ç»çš„å¯¹kubeletçš„HTTPSç«¯ç‚¹çš„è¯·æ±‚å°†è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ï¼Œå¹¶èµ‹äºˆ**ç”¨æˆ·å`system:anonymous`**å’Œ**ç»„`system:unauthenticated`**ã€‚

æœ‰**3**ç§èº«ä»½éªŒè¯**æ–¹æ³•**ï¼š

* **åŒ¿å**ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨è®¾ç½®å‚æ•°**`--anonymous-auth=true`æˆ–é…ç½®ï¼š**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: è¿™å°†å¯ç”¨ kubectl API ä»¤ç‰Œä½œä¸ºæˆæƒï¼ˆä»»ä½•æœ‰æ•ˆä»¤ç‰Œéƒ½å°†æœ‰æ•ˆï¼‰ã€‚å…è®¸å®ƒä½¿ç”¨ï¼š
* ç¡®ä¿åœ¨ API æœåŠ¡å™¨ä¸­å¯ç”¨äº† `authentication.k8s.io/v1beta1` API ç»„
* ä½¿ç”¨ `--authentication-token-webhook` å’Œ `--kubeconfig` æ ‡å¿—å¯åŠ¨ kubeletï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletè°ƒç”¨é…ç½®çš„APIæœåŠ¡å™¨ä¸Šçš„**`TokenReview` API**æ¥ä»ä»¤ç‰Œä¸­ç¡®å®šç”¨æˆ·ä¿¡æ¯
{% endhint %}

* **X509å®¢æˆ·ç«¯è¯ä¹¦:** å…è®¸é€šè¿‡X509å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯
* æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[apiserverèº«ä»½éªŒè¯æ–‡æ¡£](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)
* ä½¿ç”¨`--client-ca-file`æ ‡å¿—å¯åŠ¨kubeletï¼Œæä¾›ä¸€ä¸ªCAæ†ç»‘åŒ…æ¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚æˆ–è€…ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubeletæˆæƒ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

ä»»ä½•æˆåŠŸè®¤è¯çš„è¯·æ±‚ï¼ˆåŒ…æ‹¬åŒ¿åè¯·æ±‚ï¼‰**éšåä¼šè¢«æˆæƒ**ã€‚**é»˜è®¤**çš„æˆæƒæ¨¡å¼æ˜¯**`AlwaysAllow`**ï¼Œå®ƒ**å…è®¸æ‰€æœ‰è¯·æ±‚**ã€‚

ç„¶è€Œï¼Œå¦ä¸€ä¸ªå¯èƒ½çš„å€¼æ˜¯**`webhook`**ï¼ˆè¿™æ˜¯ä½ **å¤§éƒ¨åˆ†æ—¶é—´ä¼šå‘ç°çš„**ï¼‰ã€‚è¿™ç§æ¨¡å¼å°†**æ£€æŸ¥å·²è®¤è¯ç”¨æˆ·çš„æƒé™**ä»¥å…è®¸æˆ–æ‹’ç»ä¸€ä¸ªæ“ä½œã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿**å¯ç”¨äº†åŒ¿åè®¤è¯**ï¼Œ**åŒ¿åè®¿é—®**å¯èƒ½**æ²¡æœ‰ä»»ä½•æƒé™**æ‰§è¡Œä»»ä½•æ“ä½œã€‚
{% endhint %}

é€šè¿‡webhookè¿›è¡Œæˆæƒå¯ä»¥ä½¿ç”¨**å‚æ•° `--authorization-mode=Webhook`**è¿›è¡Œé…ç½®ï¼Œæˆ–è€…é€šè¿‡é…ç½®æ–‡ä»¶ï¼š
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubeletè°ƒç”¨é…ç½®çš„APIæœåŠ¡å™¨ä¸Šçš„**`SubjectAccessReview`** APIæ¥**ç¡®å®š**æ¯ä¸ªè¯·æ±‚æ˜¯å¦**ç»è¿‡æˆæƒ**ã€‚

kubeletä½¿ç”¨ä¸apiserverç›¸åŒçš„[è¯·æ±‚å±æ€§](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)æ–¹æ³•æ¥æˆæƒAPIè¯·æ±‚ï¼š

* **æ“ä½œ**

| HTTPåŠ¨è¯ | è¯·æ±‚åŠ¨è¯                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (ç”¨äºå•ä¸ªèµ„æº), list (ç”¨äºé›†åˆï¼ŒåŒ…æ‹¬å®Œæ•´å¯¹è±¡å†…å®¹), watch (ç”¨äºç›‘è§†å•ä¸ªèµ„æºæˆ–èµ„æºé›†åˆ) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (ç”¨äºå•ä¸ªèµ„æº), deletecollection (ç”¨äºé›†åˆ)                                                                                         |

* ä¸Kubelet APIé€šä¿¡çš„**èµ„æº**å§‹ç»ˆä¸º**nodes**ï¼Œ**å­èµ„æº**æ ¹æ®ä¼ å…¥è¯·æ±‚çš„è·¯å¾„**ç¡®å®š**ï¼š

| Kubelet API  | èµ„æº | å­èµ„æº |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _æ‰€æœ‰å…¶ä»–_ | nodes    | proxy       |

ä¾‹å¦‚ï¼Œä»¥ä¸‹è¯·æ±‚å°è¯•æœªç»è®¸å¯è®¿é—®kubeletçš„podä¿¡æ¯ï¼š
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* æˆ‘ä»¬æ”¶åˆ°äº†**Forbidden**ï¼Œæ‰€ä»¥è¯·æ±‚**é€šè¿‡äº†èº«ä»½éªŒè¯æ£€æŸ¥**ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡ï¼Œæˆ‘ä»¬å°†åªä¼šæ”¶åˆ°ä¸€ä¸ª`æœªç»æˆæƒ`çš„æ¶ˆæ¯ã€‚
* æˆ‘ä»¬å¯ä»¥çœ‹åˆ°**ç”¨æˆ·å**ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ä»ä»¤ç‰Œä¸­è·å–çš„ï¼‰
* æ£€æŸ¥**èµ„æº**æ˜¯å¦‚ä½•**èŠ‚ç‚¹**ï¼Œ**å­èµ„æº**æ˜¯**ä»£ç†**ï¼ˆè¿™ä¸å…ˆå‰çš„ä¿¡æ¯ç›¸ç¬¦ï¼‰

## å‚è€ƒèµ„æ–™

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
