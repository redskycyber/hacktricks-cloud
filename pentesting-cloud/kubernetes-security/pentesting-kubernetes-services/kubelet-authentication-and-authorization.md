# Kubelet Kimlik DoÄŸrulama ve Yetkilendirme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Kubelet Kimlik DoÄŸrulama <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[DokÃ¼mantasyondan:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

VarsayÄ±lan olarak, diÄŸer yapÄ±landÄ±rÄ±lmÄ±ÅŸ kimlik doÄŸrulama yÃ¶ntemleri tarafÄ±ndan reddedilmeyen kubelet'in HTTPS uÃ§ noktasÄ±na yapÄ±lan istekler, anonim istekler olarak kabul edilir ve **`system:anonymous`** kullanÄ±cÄ± adÄ± ve **`system:unauthenticated`** grubu verilir.

3 kimlik doÄŸrulama yÃ¶ntemi ÅŸunlardÄ±r:

* **Anonim** (varsayÄ±lan): Parametreyi **`--anonymous-auth=true`** olarak ayarlayÄ±n veya yapÄ±landÄ±rmayÄ± kullanÄ±n:
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Bu, kubectl **API taÅŸÄ±yÄ±cÄ± belirteÃ§lerini** yetkilendirme olarak **etkinleÅŸtirecektir** (herhangi bir geÃ§erli belirteÃ§ geÃ§erli olacaktÄ±r). AÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyerek bunu etkinleÅŸtirin:
* API sunucusunda `authentication.k8s.io/v1beta1` API grubunun etkin olduÄŸundan emin olun
* kubelet'i **`--authentication-token-webhook`** ve **`--kubeconfig`** bayraklarÄ±yla baÅŸlatÄ±n veya aÅŸaÄŸÄ±daki ayarÄ± kullanÄ±n:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Kubelet, yapÄ±landÄ±rÄ±lmÄ±ÅŸ API sunucusuna **`TokenReview` API'sini** Ã§aÄŸÄ±rarak taÅŸÄ±yÄ±cÄ± belirteÃ§lerden kullanÄ±cÄ± bilgilerini **belirler**.
{% endhint %}

* **X509 istemci sertifikalarÄ±:** X509 istemci sertifikalarÄ± aracÄ±lÄ±ÄŸÄ±yla kimlik doÄŸrulamasÄ±na izin verir.
* Daha fazla ayrÄ±ntÄ± iÃ§in [apiserver kimlik doÄŸrulama belgelerine](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) bakÄ±n.
* Kubelet'i `--client-ca-file` bayraÄŸÄ±yla baÅŸlatÄ±n ve istemci sertifikalarÄ±nÄ± doÄŸrulamak iÃ§in bir CA paketi saÄŸlayÄ±n. Veya yapÄ±landÄ±rmayla:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet Yetkilendirme <a href="#kubelet-authentication" id="kubelet-authentication"></a>

BaÅŸarÄ±lÄ± bir ÅŸekilde kimlik doÄŸrulanan herhangi bir istek (anonim bir istek dahil) **ardÄ±ndan yetkilendirilir**. **VarsayÄ±lan** yetkilendirme modu **`AlwaysAllow`**'dur ve **tÃ¼m isteklere izin verir**.

Ancak, diÄŸer olasÄ± deÄŸer **`webhook`** (genellikle **orada bulabileceÄŸiniz** deÄŸerdir). Bu mod, bir eyleme izin vermek veya izin vermemek iÃ§in kimlik doÄŸrulanmÄ±ÅŸ kullanÄ±cÄ±nÄ±n izinlerini kontrol eder.

{% hint style="warning" %}
UnutmayÄ±n ki, **anonim kimlik doÄŸrulama etkin olsa bile**, **anonim eriÅŸimin** herhangi bir eylem gerÃ§ekleÅŸtirmek iÃ§in **herhangi bir izni olmayabilir**.
{% endhint %}

Webhook aracÄ±lÄ±ÄŸÄ±yla yetkilendirme, **`--authorization-mode=Webhook`** parametresi kullanÄ±larak veya yapÄ±landÄ±rma dosyasÄ± aracÄ±lÄ±ÄŸÄ±yla yapÄ±landÄ±rÄ±labilir:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubelet, her isteÄŸi yetkilendirip yetkilendirmediÄŸini belirlemek iÃ§in yapÄ±landÄ±rÄ±lmÄ±ÅŸ API sunucusunda **`SubjectAccessReview`** API'sini Ã§aÄŸÄ±rÄ±r.

Kubelet, apiserver ile aynÄ± [istek Ã¶znitelikleri](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) yaklaÅŸÄ±mÄ±nÄ± kullanarak API isteklerini yetkilendirir:

* **Eylem**

| HTTP fiili | istek fiili                                                                                                                                                   |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | oluÅŸtur                                                                                                                                                       |
| GET, HEAD  | al (bireysel kaynaklar iÃ§in), listele (koleksiyonlar iÃ§in, tam nesne iÃ§eriÄŸi dahil), izle (bireysel bir kaynak veya kaynak koleksiyonu iÃ§in)                  |
| PUT        | gÃ¼ncelle                                                                                                                                                      |
| PATCH      | yama                                                                                                                                                          |
| DELETE     | sil (bireysel kaynaklar iÃ§in), deletecollection (koleksiyonlar iÃ§in)                                                                                           |

* Kubelet API'sine yÃ¶nelik **kaynak**, her zaman **nodes** ve **alt kaynak**, gelen isteÄŸin yolundan **belirlenir**:

| Kubelet API  | kaynak | alt kaynak |
| ------------ | ------ | ---------- |
| /stats/\*    | nodes  | stats      |
| /metrics/\*  | nodes  | metrics    |
| /logs/\*     | nodes  | log        |
| /spec/\*     | nodes  | spec       |
| _diÄŸerleri_  | nodes  | proxy      |

Ã–rneÄŸin, aÅŸaÄŸÄ±daki istek, izin olmadan kubelet'in pod bilgilerine eriÅŸmeye Ã§alÄ±ÅŸtÄ±:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* **YasaklandÄ±** hatasÄ± aldÄ±k, bu yÃ¼zden istek **Kimlik DoÄŸrulama kontrolÃ¼nÃ¼ geÃ§ti**. Aksi takdirde, sadece bir `Yetkisiz` mesajÄ± alÄ±rdÄ±k.
* **KullanÄ±cÄ± adÄ±nÄ±** (bu durumda belirteÃ§ten) gÃ¶rebiliriz.
* **KaynaÄŸÄ±n** dÃ¼ÄŸÃ¼mler olduÄŸunu ve **alt kaynaÄŸÄ±n** proxy olduÄŸunu kontrol edin (bu Ã¶nceki bilgilerle uyumlu).

## Referanslar

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **tanÄ±tmak isterseniz** veya HackTricks'i **PDF olarak indirmek isterseniz**, [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin.
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
