# Kubeletèº«ä»½éªŒè¯å’Œæˆæƒ

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Kubeletèº«ä»½éªŒè¯ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹kubeletçš„HTTPSç«¯ç‚¹çš„è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰è¢«å…¶ä»–é…ç½®çš„èº«ä»½éªŒè¯æ–¹æ³•æ‹’ç»ï¼Œå°†è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ï¼Œå¹¶è¢«èµ‹äºˆ**ç”¨æˆ·å`system:anonymous`**å’Œ**ç»„`system:unauthenticated`**ã€‚

æœ‰**3**ç§èº«ä»½éªŒè¯**æ–¹æ³•**ï¼š

* **åŒ¿å**ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨è®¾ç½®å‚æ•°**`--anonymous-auth=true`æˆ–é…ç½®ï¼š**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: è¿™å°†å¯ç”¨ kubectl çš„ API ä»¤ç‰Œä½œä¸ºæˆæƒï¼ˆä»»ä½•æœ‰æ•ˆçš„ä»¤ç‰Œéƒ½å°†è¢«æ¥å—ï¼‰ã€‚ä½¿ç”¨ä»¥ä¸‹è®¾ç½®å…è®¸å®ƒï¼š
* ç¡®ä¿ API æœåŠ¡å™¨ä¸­å¯ç”¨äº† `authentication.k8s.io/v1beta1` API ç»„
* ä½¿ç”¨ `--authentication-token-webhook` å’Œ `--kubeconfig` æ ‡å¿—å¯åŠ¨ kubeletï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletè°ƒç”¨é…ç½®çš„APIæœåŠ¡å™¨ä¸Šçš„**`TokenReview` API**æ¥ä»ä»¤ç‰Œä¸­ç¡®å®šç”¨æˆ·ä¿¡æ¯
{% endhint %}

* **X509å®¢æˆ·ç«¯è¯ä¹¦ï¼š**å…è®¸é€šè¿‡X509å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯
* æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[apiserverèº«ä»½éªŒè¯æ–‡æ¡£](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)
* ä½¿ç”¨`--client-ca-file`æ ‡å¿—å¯åŠ¨kubeletï¼Œæä¾›CAæ†ç»‘åŒ…ä»¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚æˆ–è€…ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubeletæˆæƒ <a href="#kubelet-authentication" id="kubelet-authentication"></a>

ä»»ä½•æˆåŠŸè®¤è¯çš„è¯·æ±‚ï¼ˆåŒ…æ‹¬åŒ¿åè¯·æ±‚ï¼‰**éšåä¼šè¢«æˆæƒ**ã€‚**é»˜è®¤**çš„æˆæƒæ¨¡å¼æ˜¯**`AlwaysAllow`**ï¼Œå®ƒ**å…è®¸æ‰€æœ‰è¯·æ±‚**ã€‚

ç„¶è€Œï¼Œå¦ä¸€ä¸ªå¯èƒ½çš„å€¼æ˜¯**`webhook`**ï¼ˆè¿™æ˜¯ä½ **å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæ‰¾åˆ°çš„**ï¼‰ã€‚è¿™ç§æ¨¡å¼å°†**æ£€æŸ¥å·²è®¤è¯ç”¨æˆ·çš„æƒé™**ï¼Œä»¥å…è®¸æˆ–æ‹’ç»æŸä¸ªæ“ä½œã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œå³ä½¿**å¯ç”¨äº†åŒ¿åè®¤è¯**ï¼Œ**åŒ¿åè®¿é—®**å¯èƒ½**æ²¡æœ‰ä»»ä½•æƒé™**æ‰§è¡Œä»»ä½•æ“ä½œã€‚
{% endhint %}

é€šè¿‡Webhookè¿›è¡Œæˆæƒå¯ä»¥ä½¿ç”¨å‚æ•°**`--authorization-mode=Webhook`**è¿›è¡Œé…ç½®ï¼Œæˆ–è€…é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼š
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubeletè°ƒç”¨é…ç½®çš„APIæœåŠ¡å™¨ä¸Šçš„**`SubjectAccessReview`** APIæ¥**ç¡®å®š**æ¯ä¸ªè¯·æ±‚æ˜¯å¦**è¢«æˆæƒ**ã€‚

kubeletä½¿ç”¨ä¸apiserverç›¸åŒçš„[è¯·æ±‚å±æ€§](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)æ–¹æ³•æ¥æˆæƒAPIè¯·æ±‚ï¼š

* **åŠ¨ä½œ**

| HTTPåŠ¨è¯ | è¯·æ±‚åŠ¨è¯                                                                                                                                                      |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST     | create                                                                                                                                                        |
| GET, HEAD| getï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œlistï¼ˆç”¨äºé›†åˆï¼ŒåŒ…æ‹¬å®Œæ•´å¯¹è±¡å†…å®¹ï¼‰ï¼Œwatchï¼ˆç”¨äºç›‘è§†å•ä¸ªèµ„æºæˆ–èµ„æºé›†åˆï¼‰ |
| PUT      | update                                                                                                                                                        |
| PATCH    | patch                                                                                                                                                         |
| DELETE   | deleteï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œdeletecollectionï¼ˆç”¨äºé›†åˆï¼‰                                                                                         |

* ä¸Kubelet APIé€šä¿¡çš„**èµ„æº**å§‹ç»ˆæ˜¯**nodes**ï¼Œ**å­èµ„æº**ä»ä¼ å…¥è¯·æ±‚çš„è·¯å¾„ä¸­**ç¡®å®š**ï¼š

| Kubelet API  | èµ„æº    | å­èµ„æº     |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _å…¶ä»–æ‰€æœ‰_    | nodes    | proxy       |

ä¾‹å¦‚ï¼Œä»¥ä¸‹è¯·æ±‚å°è¯•æœªç»æˆæƒè®¿é—®kubeletçš„podsä¿¡æ¯ï¼š
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª**Forbidden**ï¼Œæ‰€ä»¥è¯·æ±‚**é€šè¿‡äº†èº«ä»½éªŒè¯æ£€æŸ¥**ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡ï¼Œæˆ‘ä»¬å°†åªä¼šå¾—åˆ°ä¸€ä¸ª`æœªç»æˆæƒ`çš„æ¶ˆæ¯ã€‚
* æˆ‘ä»¬å¯ä»¥çœ‹åˆ°**ç”¨æˆ·å**ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ä»ä»¤ç‰Œä¸­è·å–çš„ï¼‰
* æ£€æŸ¥ä¸€ä¸‹**èµ„æº**æ˜¯**nodes**ï¼Œè€Œ**å­èµ„æº**æ˜¯**proxy**ï¼ˆè¿™ä¸ä¹‹å‰çš„ä¿¡æ¯ç›¸ç¬¦ï¼‰

## å‚è€ƒèµ„æ–™

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF æ ¼å¼çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
