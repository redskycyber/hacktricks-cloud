# Kubernetes å¼ºåŒ–

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## å·¥å…·

### Kubescape

****[**Kubescape**](https://github.com/armosec/kubescape) æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œæä¾›äº†ä¸€ä¸ªå¤šäº‘ K8s å•ä¸€è§†å›¾ï¼ŒåŒ…æ‹¬é£é™©åˆ†æã€å®‰å…¨åˆè§„ã€RBAC å¯è§†åŒ–å’Œé•œåƒæ¼æ´æ‰«æã€‚Kubescape å¯ä»¥æ‰«æ K8s é›†ç¾¤ã€YAML æ–‡ä»¶å’Œ HELM å›¾è¡¨ï¼Œæ ¹æ®å¤šä¸ªæ¡†æ¶ï¼ˆå¦‚ [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)ã€[MITRE ATT\&CKÂ®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)ï¼‰æ£€æµ‹é…ç½®é”™è¯¯ã€è½¯ä»¶æ¼æ´å’Œ RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰è¿è§„ï¼Œå¹¶åœ¨ CI/CD æµæ°´çº¿çš„æ—©æœŸé˜¶æ®µè®¡ç®—é£é™©è¯„åˆ†å¹¶æ˜¾ç¤ºé£é™©è¶‹åŠ¿ã€‚

### Kube-bench

å·¥å…· [**kube-bench**](https://github.com/aquasecurity/kube-bench) æ˜¯ä¸€ä¸ªæ£€æŸ¥ Kubernetes æ˜¯å¦å®‰å…¨éƒ¨ç½²çš„å·¥å…·ï¼Œå®ƒè¿è¡Œäº†[**CIS Kubernetes åŸºå‡†**](https://www.cisecurity.org/benchmark/kubernetes/)ä¸­è®°å½•çš„æ£€æŸ¥é¡¹ã€‚\
æ‚¨å¯ä»¥é€‰æ‹©ï¼š

* åœ¨å®¹å™¨å†…è¿è¡Œ kube-benchï¼ˆä¸ä¸»æœºå…±äº« PID å‘½åç©ºé—´ï¼‰
* è¿è¡Œä¸€ä¸ªåœ¨ä¸»æœºä¸Šå®‰è£… kube-bench çš„å®¹å™¨ï¼Œç„¶åç›´æ¥åœ¨ä¸»æœºä¸Šè¿è¡Œ kube-bench
* ä»[å‘å¸ƒé¡µé¢](https://github.com/aquasecurity/kube-bench/releases)å®‰è£…æœ€æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
* ä»æºä»£ç ç¼–è¯‘ã€‚

### Kubeaudit

å·¥å…· [**kubeaudit**](https://github.com/Shopify/kubeaudit) æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å’Œ Go åŒ…ï¼Œç”¨äº**å®¡è®¡ Kubernetes é›†ç¾¤**çš„å„ç§å®‰å…¨é—®é¢˜ã€‚

Kubeaudit å¯ä»¥æ£€æµ‹æ˜¯å¦åœ¨é›†ç¾¤ä¸­çš„å®¹å™¨ä¸­è¿è¡Œã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œå®ƒå°†å°è¯•å®¡è®¡è¯¥é›†ç¾¤ä¸­çš„æ‰€æœ‰ Kubernetes èµ„æºï¼š
```
kubeaudit all
```
è¿™ä¸ªå·¥å…·è¿˜æœ‰ä¸€ä¸ªå‚æ•°`autofix`ï¼Œå¯ä»¥**è‡ªåŠ¨ä¿®å¤æ£€æµ‹åˆ°çš„é—®é¢˜**ã€‚

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) æ˜¯ä¸€ä¸ªå®ç”¨å·¥å…·ï¼Œç”¨äºæ‰«ææ´»åŠ¨çš„ Kubernetes é›†ç¾¤å¹¶**æŠ¥å‘Šå·²éƒ¨ç½²èµ„æºå’Œé…ç½®çš„æ½œåœ¨é—®é¢˜**ã€‚å®ƒæ ¹æ®å·²éƒ¨ç½²çš„å†…å®¹è€Œä¸æ˜¯ç£ç›˜ä¸Šçš„å†…å®¹æ¥æ¸…ç†é›†ç¾¤ã€‚é€šè¿‡æ‰«æé›†ç¾¤ï¼Œå®ƒå¯ä»¥æ£€æµ‹åˆ°é…ç½®é”™è¯¯ï¼Œå¹¶å¸®åŠ©æ‚¨ç¡®ä¿æœ€ä½³å®è·µå¾—åˆ°è½å®ï¼Œä»è€Œé¿å…æœªæ¥çš„éº»çƒ¦ã€‚å®ƒæ—¨åœ¨å‡å°‘åœ¨é‡å¤–æ“ä½œ Kubernetes é›†ç¾¤æ—¶æ‰€é¢ä¸´çš„è®¤çŸ¥è´Ÿæ‹…ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨çš„é›†ç¾¤ä½¿ç”¨äº†åº¦é‡æœåŠ¡å™¨ï¼Œå®ƒä¼šæŠ¥å‘Šæ½œåœ¨çš„èµ„æºè¿‡åº¦/ä¸è¶³åˆ†é…ï¼Œå¹¶åœ¨é›†ç¾¤å®¹é‡ä¸è¶³æ—¶å°è¯•è­¦å‘Šæ‚¨ã€‚

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) åœ¨ä»¥ä¸‹**åŸºç¡€è®¾æ–½å³ä»£ç è§£å†³æ–¹æ¡ˆ**ä¸­æŸ¥æ‰¾å®‰å…¨æ¼æ´ã€åˆè§„æ€§é—®é¢˜å’ŒåŸºç¡€è®¾æ–½é…ç½®é”™è¯¯ï¼šTerraformã€Kubernetesã€Dockerã€AWS CloudFormationã€Ansibleã€Helmã€Microsoft ARM å’Œ OpenAPI 3.0 è§„èŒƒã€‚

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) æ˜¯ä¸€ä¸ªç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå·¥å…·ã€‚

å®ƒå¯ä»¥æ‰«æä½¿ç”¨[Terraform](https://terraform.io)ã€Terraform planã€[Cloudformation](https://aws.amazon.com/cloudformation/)ã€[AWS SAM](https://aws.amazon.com/serverless/sam/)ã€[Kubernetes](https://kubernetes.io)ã€[Dockerfile](https://www.docker.com)ã€[Serverless](https://www.serverless.com) æˆ– [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) é…ç½®çš„äº‘åŸºç¡€è®¾æ–½ï¼Œå¹¶ä½¿ç”¨åŸºäºå›¾çš„æ‰«ææŠ€æœ¯æ£€æµ‹å®‰å…¨å’Œåˆè§„æ€§é…ç½®é”™è¯¯ã€‚

### **ä½¿ç”¨ Falco è¿›è¡Œç›‘æ§**

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

## æç¤º

### Kubernetes PodSecurityContext å’Œ SecurityContext

æ‚¨å¯ä»¥ä½¿ç”¨ _PodSecurityContext_ é…ç½®**Pod çš„å®‰å…¨ä¸Šä¸‹æ–‡**ï¼Œå¹¶ä½¿ç”¨ _SecurityContext_ é…ç½®å°†è¦è¿è¡Œçš„**å®¹å™¨**çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ï¼š

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API ç¡¬åŒ–

ä¿æŠ¤å¯¹ Kubernetes Api Server çš„è®¿é—®éå¸¸é‡è¦ï¼Œå› ä¸ºå…·æœ‰è¶³å¤Ÿæƒé™çš„æ¶æ„ç”¨æˆ·å¯èƒ½ä¼šæ»¥ç”¨å®ƒå¹¶å¯¹ç¯å¢ƒé€ æˆå„ç§æŸå®³ã€‚\
é‡è¦çš„æ˜¯è¦ä¿æŠ¤**è®¿é—®**ï¼ˆ**ç™½åå•**è®¿é—® API Server çš„æ¥æºå¹¶æ‹’ç»å…¶ä»–è¿æ¥ï¼‰å’Œ[**èº«ä»½éªŒè¯**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)ï¼ˆéµå¾ª**æœ€å°ç‰¹æƒ**åŸåˆ™ï¼‰ã€‚ç»å¯¹**ä¸è¦**å…è®¸**åŒ¿åè¯·æ±‚**ã€‚

**å¸¸è§çš„è¯·æ±‚æµç¨‹ï¼š**\
ç”¨æˆ·æˆ– K8s ServiceAccount â€“> èº«ä»½éªŒè¯ â€“> æˆæƒ â€“> å‡†å…¥æ§åˆ¶ã€‚

**æç¤º**ï¼š

* å…³é—­ç«¯å£ã€‚
* é¿å…åŒ¿åè®¿é—®ã€‚
* NodeRestrictionï¼›ç¦æ­¢ç‰¹å®šèŠ‚ç‚¹è®¿é—® APIã€‚
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* åŸºæœ¬ä¸Šé˜²æ­¢ kubelets æ·»åŠ /åˆ é™¤/æ›´æ–°å¸¦æœ‰ node-restriction.kubernetes.io/ å‰ç¼€çš„æ ‡ç­¾ã€‚æ­¤æ ‡ç­¾å‰ç¼€ä¿ç•™ç»™ç®¡ç†å‘˜ä¸ºäº†å·¥ä½œè´Ÿè½½éš”ç¦»ç›®çš„è€Œä¸ºå…¶èŠ‚ç‚¹å¯¹è±¡æ‰“æ ‡ç­¾ï¼Œkubelets å°†ä¸è¢«å…è®¸ä¿®æ”¹å¸¦æœ‰è¯¥å‰ç¼€çš„æ ‡ç­¾ã€‚
* åŒæ—¶ï¼Œå…è®¸ kubelets æ·»åŠ /åˆ é™¤/æ›´æ–°è¿™äº›æ ‡ç­¾å’Œæ ‡ç­¾å‰ç¼€ã€‚
* ä½¿ç”¨æ ‡ç­¾ç¡®ä¿å®‰å…¨çš„å·¥ä½œè´Ÿè½½éš”ç¦»ã€‚
* é¿å…ç‰¹å®šçš„ Pod è®¿é—® APIã€‚
* é¿å…å°† ApiServer æš´éœ²ç»™äº’è”ç½‘ã€‚
* é¿å…æœªç»æˆæƒçš„è®¿é—® RBACã€‚
* ä½¿ç”¨é˜²ç«å¢™å’Œ IP ç™½åå•å¯¹ ApiServer ç«¯å£è¿›è¡Œä¿æŠ¤ã€‚

### SecurityContext ç¡¬åŒ–

å¦‚æœæœªæŒ‡å®šå…¶ä»–ç”¨æˆ·ï¼ŒPod å¯åŠ¨æ—¶å°†ä½¿ç”¨ root ç”¨æˆ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹æ¨¡æ¿çš„æ–¹å¼åœ¨æ›´å®‰å…¨çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œåº”ç”¨ç¨‹åºï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kubernetesç½‘ç»œç­–ç•¥

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### ä¸€èˆ¬åŠ å›º

æ‚¨åº”è¯¥æ ¹æ®éœ€è¦å®šæœŸæ›´æ–°Kubernetesç¯å¢ƒï¼Œä»¥ç¡®ä¿ï¼š

* ä¾èµ–é¡¹æ˜¯æœ€æ–°çš„ã€‚
* ä¿®å¤äº†æ¼æ´å’Œå®‰å…¨è¡¥ä¸ã€‚

[**å‘å¸ƒå‘¨æœŸ**](https://kubernetes.io/docs/setup/release/version-skew-policy/)ï¼šæ¯3ä¸ªæœˆä¼šæœ‰ä¸€ä¸ªæ–°çš„æ¬¡è¦ç‰ˆæœ¬å‘å¸ƒ -- 1.20.3 = 1(ä¸»è¦).20(æ¬¡è¦).3(è¡¥ä¸)

**æ›´æ–°Kubernetesé›†ç¾¤çš„æœ€ä½³æ–¹æ³•æ˜¯ï¼ˆæ¥è‡ª** [**è¿™é‡Œ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**ï¼‰ï¼š**

* æŒ‰ç…§ä»¥ä¸‹é¡ºåºå‡çº§ä¸»èŠ‚ç‚¹ç»„ä»¶ï¼š
* etcdï¼ˆæ‰€æœ‰å®ä¾‹ï¼‰ã€‚
* kube-apiserverï¼ˆæ‰€æœ‰æ§åˆ¶å¹³é¢ä¸»æœºï¼‰ã€‚
* kube-controller-managerã€‚
* kube-schedulerã€‚
* å¦‚æœä½¿ç”¨äº†äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œåˆ™å‡çº§äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ã€‚
* å‡çº§å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼Œå¦‚kube-proxyã€kubeletã€‚

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
