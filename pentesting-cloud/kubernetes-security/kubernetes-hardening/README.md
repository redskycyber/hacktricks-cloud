# Fortalecimiento de Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Herramientas para analizar un cl√∫ster

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de c√≥digo abierto para K8s que proporciona una vista √∫nica de m√∫ltiples nubes de K8s, incluyendo an√°lisis de riesgos, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de im√°genes. Kubescape escanea cl√∫steres de K8s, archivos YAML y gr√°ficos HELM, detectando configuraciones incorrectas seg√∫n varios marcos (como el [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (control de acceso basado en roles) en las primeras etapas del pipeline de CI/CD, calcula el puntaje de riesgo al instante y muestra las tendencias de riesgo a lo largo del tiempo.
```bash
kubescape scan --verbose
```
### Kube-bench

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) es una herramienta que verifica si Kubernetes est√° implementado de manera segura ejecutando las verificaciones documentadas en el [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puedes elegir:

* ejecutar kube-bench desde dentro de un contenedor (compartiendo el espacio de nombres PID con el host)
* ejecutar un contenedor que instale kube-bench en el host y luego ejecutar kube-bench directamente en el host
* instalar los √∫ltimos binarios desde la [p√°gina de lanzamientos](https://github.com/aquasecurity/kube-bench/releases),
* compilarlo desde el c√≥digo fuente.

### Kubeaudit

La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de l√≠nea de comandos y un paquete Go para **auditar cl√∫steres de Kubernetes** en busca de diversas preocupaciones de seguridad.

Kubeaudit puede detectar si se est√° ejecutando dentro de un contenedor en un cl√∫ster. Si es as√≠, intentar√° auditar todos los recursos de Kubernetes en ese cl√∫ster:
```
kubeaudit all
```
Esta herramienta tambi√©n tiene el argumento `autofix` para **corregir autom√°ticamente los problemas detectados.**

### **Kube-hunter**

La herramienta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca debilidades de seguridad en cl√∫steres de Kubernetes. La herramienta fue desarrollada para aumentar la conciencia y visibilidad de los problemas de seguridad en entornos de Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[**Kubei**](https://github.com/Erezf-p/kubei) es una herramienta de escaneo de vulnerabilidades y benchmark de CIS Docker que permite a los usuarios obtener una evaluaci√≥n precisa e inmediata del riesgo de sus cl√∫steres de Kubernetes. Kubei escanea todas las im√°genes que se utilizan en un cl√∫ster de Kubernetes, incluyendo im√°genes de pods de aplicaciones y pods del sistema.

## **Auditar c√≥digo IaC**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) es una utilidad que escanea un cl√∫ster de Kubernetes en vivo y **reporta posibles problemas con los recursos y configuraciones implementados**. Limpia tu cl√∫ster en funci√≥n de lo que est√° implementado y no de lo que est√° en el disco. Al escanear tu cl√∫ster, detecta configuraciones incorrectas y te ayuda a asegurarte de que se sigan las mejores pr√°cticas, evitando as√≠ futuros dolores de cabeza. Su objetivo es reducir la sobrecarga cognitiva que uno enfrenta al operar un cl√∫ster de Kubernetes en la naturaleza. Adem√°s, si tu cl√∫ster utiliza un servidor de m√©tricas, informa posibles asignaciones de recursos excesivas o insuficientes e intenta advertirte si tu cl√∫ster se queda sin capacidad.

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) encuentra **vulnerabilidades de seguridad**, problemas de cumplimiento y configuraciones incorrectas de infraestructura en las siguientes soluciones de **Infraestructura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones OpenAPI 3.0.

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) es una herramienta de an√°lisis de c√≥digo est√°tico para infraestructura como c√≥digo.

Escanea la infraestructura en la nube provista utilizando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta configuraciones incorrectas de seguridad y cumplimiento utilizando un escaneo basado en gr√°ficos.

### Kube-score

[**kube-score**](https://github.com/zegl/kube-score) es una herramienta que realiza an√°lisis de c√≥digo est√°tico de las definiciones de objetos de Kubernetes.

Para instalar:

| Distribuci√≥n                                        | Comando / Enlace                                                                        |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binarios precompilados para macOS, Linux y Windows   | [Liberaciones de GitHub](https://github.com/zegl/kube-score/releases)                    |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS y Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS y Linux) | `kubectl krew install score`                                                            |

## Consejos

### Monitoreo con Falco

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContext y SecurityContext

Puedes configurar el **contexto de seguridad de los Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para obtener m√°s informaci√≥n, lee:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Reforzamiento de la API de Kubernetes

Es muy importante **proteger el acceso al servidor de API de Kubernetes**, ya que un actor malintencionado con suficientes privilegios podr√≠a abusar de √©l y da√±ar el entorno de muchas maneras.\
Es importante asegurar tanto el **acceso** (permitiendo solo el acceso de or√≠genes en la lista blanca y denegando cualquier otra conexi√≥n) como la [**autenticaci√≥n**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el principio de **privilegio m√≠nimo**). Y definitivamente **nunca permitas solicitudes an√≥nimas**.

**Proceso de solicitud com√∫n:**\
Usuario o cuenta de servicio de K8s ‚Äì> Autenticaci√≥n ‚Äì> Autorizaci√≥n ‚Äì> Control de admisi√≥n.

**Consejos**:

* Cierra los puertos.
* Evita el acceso an√≥nimo.
* Restricci√≥n de nodos; sin acceso desde nodos espec√≠ficos a la API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* B√°sicamente evita que los kubelets agreguen/eliminen/actualicen etiquetas con el prefijo node-restriction.kubernetes.io/. Este prefijo de etiqueta est√° reservado para que los administradores etiqueten sus objetos de nodo con fines de aislamiento de carga de trabajo, y los kubelets no podr√°n modificar etiquetas con ese prefijo.
* Y tambi√©n permite que los kubelets agreguen/eliminen/actualicen estas etiquetas y prefijos de etiquetas.
* Aseg√∫rate con etiquetas el aislamiento seguro de la carga de trabajo.
* Evita que pods espec√≠ficos accedan a la API.
* Evita la exposici√≥n del ApiServer a Internet.
* Evita el acceso no autorizado de RBAC.
* Puerto de ApiServer con firewall y lista blanca de IP.

### Reforzamiento del SecurityContext

Por defecto, se utilizar√° el usuario root cuando se inicie un Pod si no se especifica otro usuario. Puedes ejecutar tu aplicaci√≥n dentro de un contexto m√°s seguro utilizando una plantilla similar a la siguiente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Pol√≠ticas de red de Kubernetes

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### Fortalecimiento general

Deber√≠as actualizar tu entorno de Kubernetes con la frecuencia necesaria para tener:

* Dependencias actualizadas.
* Parches de errores y seguridad.

[**Ciclos de lanzamiento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Cada 3 meses hay un nuevo lanzamiento menor -- 1.20.3 = 1(Mayor).20(Menor).3(parche)

**La mejor manera de actualizar un cl√∫ster de Kubernetes es (desde** [**aqu√≠**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Actualiza los componentes del nodo maestro siguiendo esta secuencia:
* etcd (todas las instancias).
* kube-apiserver (todos los hosts del plano de control).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si lo usas.
* Actualiza los componentes del nodo trabajador como kube-proxy, kubelet.

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
