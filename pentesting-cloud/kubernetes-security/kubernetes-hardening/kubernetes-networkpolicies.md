# Kubernetes NetworkPolicies

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¦‹ãŸã„**å ´åˆã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ã”ç¢ºèªãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹**ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

**ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html) **ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã—ãŸ**

### ã‚·ãƒŠãƒªã‚ªæƒ…å ±

ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ã€Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’å±•é–‹ã—ã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¢ƒç•Œã‚’ä½œæˆã—ã¾ã™ã€‚

* ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€`NetworkPolicy`ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ã‚·ãƒŠãƒªã‚ªã®è§£æ±ºç­–

* ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã¯ã€[https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚

ç‰¹å®šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ï¼ˆOSIãƒ¬ã‚¤ãƒ¤ãƒ¼3ã¾ãŸã¯4ï¼‰ã§ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã—ãŸã„å ´åˆã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ç‰¹å®šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦Kubernetes NetworkPoliciesã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ NetworkPoliciesã¯ã€ãƒãƒƒãƒ‰ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã®ã•ã¾ã–ã¾ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã¨ã©ã®ã‚ˆã†ã«é€šä¿¡ã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸­å¿ƒã®æ§‹é€ ã§ã™ï¼ˆã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã¨ã„ã†è¨€è‘‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šä¸€èˆ¬çš„ãªç”¨èªã§ã‚ã‚‹ã€Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ã‚„ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã£ãŸç”¨èªã‚’éè² è·ã«ã™ã‚‹ã“ã¨ã‚’é¿ã‘ã¦ã„ã¾ã™ï¼‰ã€‚

ãƒãƒƒãƒ‰ãŒé€šä¿¡ã§ãã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã€æ¬¡ã®3ã¤ã®è­˜åˆ¥å­ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚

1. è¨±å¯ã•ã‚Œã‚‹ä»–ã®ãƒãƒƒãƒ‰ï¼ˆä¾‹å¤–ï¼šãƒãƒƒãƒ‰è‡ªä½“ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰è¨±å¯ã•ã‚Œã‚‹åå‰ç©ºé–“
2. IPãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¾‹å¤–ï¼šãƒãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã¨ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ã€ãƒãƒƒãƒ‰ã¾ãŸã¯ãƒãƒ¼ãƒ‰ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«é–¢ä¿‚ãªãå¸¸ã«è¨±å¯ã•ã‚Œã¾ã™ï¼‰
3. ãƒãƒƒãƒ‰ã¾ãŸã¯åå‰ç©ºé–“ãƒ™ãƒ¼ã‚¹ã®NetworkPolicyã‚’å®šç¾©ã™ã‚‹å ´åˆã€ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€ã‚»ãƒ¬ã‚¯ã‚¿ã«ä¸€è‡´ã™ã‚‹ãƒãƒƒãƒ‰ã¨ã®é–“ã§è¨±å¯ã•ã‚Œã‚‹ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æŒ‡å®šã—ã¾ã™ã€‚

ä¸€æ–¹ã€IPãƒ™ãƒ¼ã‚¹ã®NetworkPoliciesãŒä½œæˆã•ã‚Œã‚‹ã¨ã€CIDRç¯„å›²ã«åŸºã¥ã„ã¦ãƒãƒªã‚·ãƒ¼ãŒå®šç¾©ã•ã‚Œã¾ã™ã€‚

* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’DENYã™ã‚‹NetworkPolicyã‚’ä½œæˆã—ã¾ã™

> ã“ã®NetworkPolicyã¯ã€ãƒãƒƒãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ã¦é¸æŠã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒƒãƒ‰ã¸ã®ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼š

* ä¸€èˆ¬çš„ãªã‚±ãƒ¼ã‚¹ã§ã™ï¼šNetwork Policiesã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã¾ãšã“ã®ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
* ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã€ä»–ã®ãƒãƒƒãƒ‰ã¨ã®é€šä¿¡ã‚’é˜²æ­¢ã—ãŸã„å ´åˆã€‚
* ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ä»–ã®ãƒãƒƒãƒ‰ã‹ã‚‰åˆ†é›¢ã—ãŸã„å ´åˆã€‚

![ã‚·ãƒŠãƒªã‚ª20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### ä¾‹

* ãƒ©ãƒ™ãƒ«`app=web`ã‚’æŒã¤nginxãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒãƒ¼ãƒˆ80ã§å…¬é–‹ã—ã¾ã™
```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```
* ä¸€æ™‚çš„ãªPodã‚’å®Ÿè¡Œã—ã€`web`ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# You will see the below output
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```
* ã†ã¾ãã„ãã¾ã—ãŸã€‚æ¬¡ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ `web-deny-all.yaml` ã¨ã—ã¦ä¿å­˜ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«é©ç”¨ã—ã¦ãã ã•ã„ã€‚
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
name: web-deny-all
spec:
podSelector:
matchLabels:
app: web
ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```
#### è©¦ã—ã¦ã¿ã‚‹

* å†ã³ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã—ã€`web`ã«ã‚¯ã‚¨ãƒªã‚’è©¦ã¿ã¾ã™ã€‚
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# You will see the below output
#   wget: download timed out
```
* ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ

#### [å‚™è€ƒ](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* ä¸Šè¨˜ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã§ã¯ã€app=webãƒ©ãƒ™ãƒ«ã‚’æŒã¤Podã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯spec.ingressãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãŸã‚ã€Podã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
* ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ç›´æ¥ã¾ãŸã¯é–“æ¥çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹åˆ¥ã®NetworkPolicyã‚’ä½œæˆã™ã‚‹å ´åˆã€ã“ã®NetworkPolicyã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚
* ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ãƒãƒªã‚·ãƒ¼ãŒã‚ã‚‹å ´åˆã§ã‚‚ã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æŒã¤NetworkPolicyãŒå°‘ãªãã¨ã‚‚1ã¤å­˜åœ¨ã™ã‚‹å ´åˆã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ãƒãƒƒãƒ‰ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚
```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```
* ãã®ä»–ã®å‚è€ƒè³‡æ–™ã¯ã€https://github.com/ahmetb/kubernetes-network-policy-recipes ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Cilium Editor - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼

ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«/ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚åŸºæœ¬çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã®æ¦‚å¿µã‚’èª¬æ˜ã—ã€æœ›ã¾ã—ã„æœ€å°ç‰¹æ¨©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã®æ¦‚å¿µã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ‰‹é †ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚

* **Cilium Editorã«ç§»å‹•ã—ã¾ã™** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### ãã®ä»–

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksã®åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„å ´åˆã‚„ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã€ã¾ãŸã¯HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ã”ç¢ºèªãã ã•ã„ï¼**
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
