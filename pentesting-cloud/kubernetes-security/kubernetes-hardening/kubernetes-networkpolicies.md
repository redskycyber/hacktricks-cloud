# Kubernetesç½‘ç»œç­–ç•¥

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„è´¦å· ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**æœ¬æ•™ç¨‹æ‘˜è‡ª** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html)

### åœºæ™¯ä¿¡æ¯

æœ¬åœºæ™¯æ—¨åœ¨ä¸ºKubernetesèµ„æºéƒ¨ç½²ä¸€ä¸ªç®€å•çš„ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œä»¥åˆ›å»ºå®‰å…¨è¾¹ç•Œã€‚

* è¦å¼€å§‹ä½¿ç”¨æ­¤åœºæ™¯ï¼Œè¯·ç¡®ä¿æ‚¨æ­£åœ¨ä½¿ç”¨æ”¯æŒ`NetworkPolicy`çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆ

### åœºæ™¯è§£å†³æ–¹æ¡ˆ

* ä»¥ä¸‹åœºæ™¯æ¥è‡ª[https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)

å¦‚æœæ‚¨æƒ³åœ¨IPåœ°å€æˆ–ç«¯å£çº§åˆ«ï¼ˆOSIç¬¬3æˆ–ç¬¬4å±‚ï¼‰ä¸Šæ§åˆ¶æµé‡æµåŠ¨ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½è€ƒè™‘åœ¨é›†ç¾¤ä¸­çš„ç‰¹å®šåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Kubernetes NetworkPoliciesã€‚NetworkPoliciesæ˜¯ä¸€ç§ä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒçš„æ„é€ ï¼Œå…è®¸æ‚¨æŒ‡å®šä¸€ä¸ªPodå¦‚ä½•ä¸å„ç§ç½‘ç»œâ€œå®ä½“â€è¿›è¡Œé€šä¿¡ï¼ˆæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨â€œå®ä½“â€ä¸€è¯æ¥é¿å…è¿‡è½½æ›´å¸¸è§çš„æœ¯è¯­ï¼Œå¦‚â€œç«¯ç‚¹â€å’Œâ€œæœåŠ¡â€ï¼Œè¿™äº›æœ¯è¯­åœ¨Kubernetesä¸­å…·æœ‰ç‰¹å®šçš„å«ä¹‰ï¼‰ã€‚

Podå¯ä»¥ä¸çš„å®ä½“é€šè¿‡ä»¥ä¸‹3ä¸ªæ ‡è¯†ç¬¦çš„ç»„åˆè¿›è¡Œé€šä¿¡ï¼š

1. å…è®¸çš„å…¶ä»–Podï¼ˆä¾‹å¤–ï¼šä¸€ä¸ªPodä¸èƒ½é˜»æ­¢å¯¹è‡ªèº«çš„è®¿é—®ï¼‰å…è®¸çš„å‘½åç©ºé—´
2. IPå—ï¼ˆä¾‹å¤–ï¼šæ— è®ºPodæˆ–èŠ‚ç‚¹çš„IPåœ°å€å¦‚ä½•ï¼Œå§‹ç»ˆå…è®¸ä¸è¿è¡ŒPodçš„èŠ‚ç‚¹ä¹‹é—´çš„æµé‡ï¼‰
3. åœ¨å®šä¹‰åŸºäºPodæˆ–å‘½åç©ºé—´çš„NetworkPolicyæ—¶ï¼Œæ‚¨ä½¿ç”¨é€‰æ‹©å™¨æ¥æŒ‡å®šå…è®¸ä¸åŒ¹é…é€‰æ‹©å™¨çš„Podä¹‹é—´çš„æµé‡ã€‚

åŒæ—¶ï¼Œå½“åˆ›å»ºåŸºäºIPçš„NetworkPoliciesæ—¶ï¼Œæˆ‘ä»¬åŸºäºIPå—ï¼ˆCIDRèŒƒå›´ï¼‰å®šä¹‰ç­–ç•¥ã€‚

* æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ‹’ç»æ‰€æœ‰æµé‡åˆ°ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„NetworkPolicy

ç”¨ä¾‹ï¼š

* è¿™æ˜¯éå¸¸å¸¸è§çš„ï¼šè¦å¼€å§‹ä½¿ç”¨Network Policiesè¿›è¡Œæµé‡ç™½åå•ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨æ­¤ç­–ç•¥è¿›è¡Œæµé‡é»‘åå•ã€‚
* æ‚¨æƒ³è¿è¡Œä¸€ä¸ªPodï¼Œå¹¶ä¸”å¸Œæœ›é˜»æ­¢ä»»ä½•å…¶ä»–Podä¸å…¶é€šä¿¡ã€‚
* æ‚¨æš‚æ—¶å¸Œæœ›å°†æµé‡ä¸å…¶ä»–Podéš”ç¦»å¼€æ¥ï¼Œä»¥ä¾¿äºä¸€ä¸ªæœåŠ¡ã€‚

![Scenario 20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### ç¤ºä¾‹

* è¿è¡Œä¸€ä¸ªå¸¦æœ‰æ ‡ç­¾`app=web`çš„nginx Podï¼Œå¹¶å°†å…¶æš´éœ²åœ¨ç«¯å£80ä¸Š
```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```
* è¿è¡Œä¸€ä¸ªä¸´æ—¶çš„ Pod å¹¶å‘ `web` æœåŠ¡å‘å‡ºè¯·æ±‚
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# You will see the below output
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```
* ç°åœ¨å®ƒå¯ä»¥å·¥ä½œäº†ï¼Œå°†ä»¥ä¸‹æ¸…å•ä¿å­˜ä¸º `web-deny-all.yaml`ï¼Œç„¶ååº”ç”¨åˆ°é›†ç¾¤ä¸­ã€‚
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
name: web-deny-all
spec:
podSelector:
matchLabels:
app: web
ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```
#### è¯•ä¸€è¯•

* å†æ¬¡è¿è¡Œä¸€ä¸ªæµ‹è¯•å®¹å™¨ï¼Œå¹¶å°è¯•æŸ¥è¯¢ `web`
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# You will see the below output
#   wget: download timed out
```
* ä¸¢å¼ƒçš„æµé‡

#### [å¤‡æ³¨](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* åœ¨ä¸Šé¢çš„æ¸…å•ä¸­ï¼Œæˆ‘ä»¬é’ˆå¯¹å…·æœ‰app=webæ ‡ç­¾çš„Podè¿›è¡Œç½‘ç»œç­–ç•¥ã€‚è¯¥æ¸…å•æ–‡ä»¶ç¼ºå°‘spec.ingresså­—æ®µã€‚å› æ­¤ï¼Œå®ƒä¸å…è®¸ä»»ä½•æµé‡è¿›å…¥Podã€‚
* å¦‚æœæ‚¨åˆ›å»ºå¦ä¸€ä¸ªNetworkPolicyï¼Œä½¿ä¸€äº›Podç›´æ¥æˆ–é—´æ¥åœ°è®¿é—®æ­¤åº”ç”¨ç¨‹åºï¼Œåˆ™æ­¤NetworkPolicyå°†è¿‡æ—¶ã€‚
* å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªNetworkPolicyå…·æœ‰å…è®¸æµé‡çš„è§„åˆ™ï¼Œåˆ™æ„å‘³ç€æµé‡å°†è¢«è·¯ç”±åˆ°Podï¼Œè€Œä¸ç®¡é˜»æ­¢æµé‡çš„ç­–ç•¥å¦‚ä½•ã€‚

#### æ¸…ç†
```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```
* æ›´å¤šå‚è€ƒèµ„æ–™å’Œèµ„æºå¯ä»¥åœ¨https://github.com/ahmetb/kubernetes-network-policy-recipesæ‰¾åˆ°

### Cilium Editor - ç½‘ç»œç­–ç•¥ç¼–è¾‘å™¨

ä¸€ä¸ªç”¨äºæ•™æˆå¦‚ä½•ä½¿ç”¨ç¼–è¾‘å™¨åˆ›å»ºç½‘ç»œç­–ç•¥çš„å·¥å…·/æ¡†æ¶ã€‚å®ƒè§£é‡Šäº†åŸºæœ¬çš„ç½‘ç»œç­–ç•¥æ¦‚å¿µï¼Œå¹¶æŒ‡å¯¼æ‚¨å®Œæˆå®ç°æ‰€éœ€çš„æœ€å°ç‰¹æƒå®‰å…¨å’Œé›¶ä¿¡ä»»æ¦‚å¿µæ‰€éœ€çš„æ­¥éª¤ã€‚

* **è½¬åˆ°Cilium Editor** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### æ‚é¡¹

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
