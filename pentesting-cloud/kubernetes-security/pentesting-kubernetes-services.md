# Pentesting Servicios de Kubernetes

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utiliza varios **servicios de red espec铆ficos** que podr铆as encontrar **expuestos a Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podr铆a ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podr铆a ser buscar `"k8s.%.com"` en github y buscar archivos **YAML** que contengan la cadena.

## C贸mo expone Kubernetes los servicios

Podr铆a ser 煤til para ti entender c贸mo Kubernetes puede **exponer servicios p煤blicamente** para encontrarlos:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podr铆an estar abiertos en un cl煤ster de Kubernetes:

| Puerto          | Proceso        | Descripci贸n                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                          |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M茅tricas de contenedores                                                |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                          |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                            |
| 8080/TCP        | kube-apiserver | Puerto de la API insegura                                               |
| 10250/TCP       | kubelet        | API HTTPS que permite el acceso en modo completo                        |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura sin autenticaci贸n: pods, pods en ejecuci贸n y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de comprobaci贸n de salud de Kube Proxy                          |
| 9099/TCP        | calico-felix   | Servidor de comprobaci贸n de salud para Calico                            |
| 6782-4/TCP      | weave          | M茅tricas y puntos finales                                               |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                   |
| 44134/TCP       | Tiller         | Servicio de Helm escuchando                                              |

### Nmap

```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```

### Kube-apiserver

Este es el **servicio API de Kubernetes** con el que los administradores suelen hablar usando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero tambi茅n 8443 en minikube y 8080 como inseguro.

```
curl -k https://<direcci贸n IP>:(8|6)443/swaggerapi
curl -k https://<direcci贸n IP>:(8|6)443/healthz
curl -k https://<direcci贸n IP>:(8|6)443/api/v1
```

**Consulte la siguiente p谩gina para aprender c贸mo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Este servicio **se ejecuta en cada nodo del cl煤ster**. Es el servicio que **controlar谩** los pods dentro del **nodo**. Habla con el **kube-apiserver**.

Si encuentras este servicio expuesto, podr铆as haber encontrado una **RCE sin autenticaci贸n**.

#### Kubelet API

```
curl -k https://<direcci贸n IP>:10250/metrics
curl -k https://<direcci贸n IP>:10250/pods
```

Si la respuesta es `Unauthorized`, entonces requiere autenticaci贸n.

Si puedes listar nodos, puedes obtener una lista de los puntos finales de kubelets con:

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
    ip=$(echo $node | awk '{print $1}')
    port=$(echo $node | awk '{print $2}')
    echo "curl -k --max-time 30 https://$ip:$port/pods"
    echo "curl -k --max-time 30 https://$ip:2379/version" #Comprobar tambi茅n para etcd
done
```

#### kubelet (Solo lectura)

```
curl -k https://<direcci贸n IP>:10255
http://<external-IP>:10255/pods
```

### etcd API

```
curl -k https://<direcci贸n IP>:2379
curl -k https://<direcci贸n IP>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

Podr铆as abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio 煤til para recopilar m茅tricas.

```
curl -k https://<direcci贸n IP>:4194
```

### NodePort

Cuando un puerto se expone en todos los nodos a trav茅s de un **NodePort**, el mismo puerto se abre en todos los nodos proxificando el tr谩fico en el **Service** declarado. Por defecto, este puerto estar谩 en el rango **30000-32767**. Por lo tanto, los nuevos servicios no verificados podr铆an ser accesibles a trav茅s de esos puertos.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Vulnerabilidades de configuraci贸n
### **Comprobando la exposici贸n de informaci贸n de Kubelet (puerto de solo lectura)**

Cuando el **puerto de solo lectura de kubelet** est谩 expuesto, el atacante puede recuperar informaci贸n de la API. Esto expone **elementos de configuraci贸n del cl煤ster, como nombres de pods, ubicaci贸n de archivos internos y otras configuraciones**. Esta no es informaci贸n cr铆tica, pero a煤n as铆 no deber铆a estar expuesta a Internet.

Por ejemplo, un atacante remoto puede abusar de esto accediendo a la siguiente URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>