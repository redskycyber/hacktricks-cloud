# Pentesting Servicios de Kubernetes

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

Kubernetes utiliza varios **servicios de red espec铆ficos** que podr铆as encontrar **expuestos en Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podr铆a ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podr铆a ser buscar `"k8s.%.com"` en GitHub y buscar archivos **YAML** que contengan la cadena.

## C贸mo Kubernetes expone servicios

Podr铆a ser 煤til que entiendas c贸mo Kubernetes puede **exponer servicios p煤blicamente** para poder encontrarlos:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podr铆an estar abiertos en un cl煤ster de Kubernetes:

| Puerto          | Proceso        | Descripci贸n                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M茅tricas de contenedores                                               |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                           |
| 8080/TCP        | kube-apiserver | Puerto de la API insegura                                              |
| 10250/TCP       | kubelet        | API HTTPS que permite acceso en modo completo                          |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura sin autenticaci贸n: pods, pods en ejecuci贸n y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de verificaci贸n de estado de Kube Proxy                       |
| 9099/TCP        | calico-felix   | Servidor de verificaci贸n de estado para Calico                         |
| 6782-4/TCP      | weave          | M茅tricas y puntos finales                                              |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                  |
| 44134/TCP       | Tiller         | Servicio de Helm escuchando                                             |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

Este es el servicio **API de Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero tambi茅n 8443 en minikube y 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consulte la siguiente p谩gina para aprender c贸mo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio se **ejecuta en cada nodo del cl煤ster**. Es el servicio que **controlar谩** las vainas dentro del **nodo**. Habla con el **kube-apiserver**.

Si encuentra este servicio expuesto, es posible que haya encontrado una **RCE no autenticada**.

#### API de Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la respuesta es `Unauthorized`, entonces requiere autenticaci贸n.

Si puedes listar los nodos, puedes obtener una lista de los puntos finales de los kubelets con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Solo lectura)

El kubelet es un componente esencial en un cl煤ster de Kubernetes. Es responsable de la comunicaci贸n con el API server y gestiona los contenedores en los nodos del cl煤ster. El kubelet expone una interfaz de solo lectura que proporciona informaci贸n sobre el estado de los nodos y los contenedores en ejecuci贸n.

Durante una prueba de penetraci贸n, es importante evaluar la seguridad del kubelet y asegurarse de que no haya informaci贸n sensible expuesta a trav茅s de su interfaz de solo lectura. Esto incluye informaci贸n como nombres de contenedores, im谩genes utilizadas, variables de entorno y vol煤menes montados.

Algunas de las t茅cnicas comunes utilizadas para evaluar la seguridad del kubelet incluyen:

- Enumeraci贸n de la API del kubelet: Se puede utilizar herramientas como `kubectl` para enumerar los endpoints expuestos por el kubelet y obtener informaci贸n sobre los nodos y los contenedores en ejecuci贸n.

- Explotaci贸n de endpoints inseguros: Si se descubre un endpoint inseguro en el kubelet, se pueden realizar ataques como la enumeraci贸n de directorios, la ejecuci贸n remota de comandos o la divulgaci贸n de informaci贸n sensible.

- An谩lisis de metadatos: El kubelet expone metadatos sobre los nodos y los contenedores en ejecuci贸n. Estos metadatos pueden contener informaci贸n sensible que podr铆a ser utilizada para realizar ataques adicionales.

Es importante tener en cuenta que cualquier informaci贸n sensible obtenida a trav茅s del kubelet debe ser tratada con cuidado y no debe ser divulgada o utilizada de manera maliciosa.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API de etcd

El API de etcd es una interfaz de programaci贸n de aplicaciones que permite interactuar con el servicio de almacenamiento distribuido etcd. Este servicio es utilizado por Kubernetes para almacenar y recuperar informaci贸n de configuraci贸n, como datos de estado y metadatos.

El API de etcd proporciona una serie de endpoints que permiten realizar operaciones CRUD (crear, leer, actualizar y eliminar) en los datos almacenados en etcd. Estos endpoints incluyen:

- `/v2/keys`: Permite crear, leer, actualizar y eliminar claves y valores en etcd.
- `/v2/keys/{key}`: Permite realizar operaciones espec铆ficas en una clave determinada, como obtener su valor, actualizarlo o eliminarlo.
- `/v2/keys/{directory}`: Permite realizar operaciones en un directorio espec铆fico, como obtener una lista de claves contenidas en el directorio o eliminar el directorio y todas sus claves.

El API de etcd utiliza el formato JSON para representar los datos que se env铆an y reciben a trav茅s de las solicitudes HTTP. Esto permite una f谩cil integraci贸n con otras aplicaciones y herramientas.

Es importante tener en cuenta la seguridad al interactuar con el API de etcd. Se deben implementar medidas de autenticaci贸n y autorizaci贸n adecuadas para proteger los datos almacenados en etcd y prevenir posibles ataques.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller es el componente del servidor de Kubernetes que gestiona las operaciones de despliegue de las aplicaciones en el cl煤ster. Es responsable de recibir las solicitudes de despliegue de Helm y coordinar la instalaci贸n de los recursos en el cl煤ster.

Durante una evaluaci贸n de seguridad de Kubernetes, es importante realizar pruebas de penetraci贸n en el componente Tiller para identificar posibles vulnerabilidades. Algunas de las t茅cnicas comunes utilizadas en las pruebas de penetraci贸n de Tiller incluyen:

1. Enumeraci贸n de servicios Tiller: Identificar los servicios Tiller en el cl煤ster y recopilar informaci贸n sobre ellos, como las versiones utilizadas y los permisos asociados.

2. Escaneo de puertos: Realizar un escaneo de puertos en los servicios Tiller para identificar posibles puertos abiertos y servicios expuestos.

3. Prueba de credenciales d茅biles: Intentar autenticarse en los servicios Tiller utilizando credenciales d茅biles o predeterminadas para identificar posibles vulnerabilidades de autenticaci贸n.

4. Inyecci贸n de comandos: Intentar inyectar comandos maliciosos en las solicitudes de despliegue de Helm para ejecutar c贸digo arbitrario en el cl煤ster.

5. Ataques de denegaci贸n de servicio (DoS): Realizar ataques de denegaci贸n de servicio contra los servicios Tiller para evaluar su resistencia y capacidad de recuperaci贸n.

Es importante tener en cuenta que estas t茅cnicas deben ser realizadas con el permiso y la autorizaci贸n adecuados, y solo en entornos controlados y autorizados.
```
helm --host tiller-deploy.kube-system:44134 version
```
Puedes abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio 煤til para recopilar m茅tricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Cuando se expone un puerto en todos los nodos a trav茅s de un **NodePort**, el mismo puerto se abre en todos los nodos para redirigir el tr谩fico hacia el **Service** declarado. Por defecto, este puerto estar谩 en el **rango 30000-32767**. Por lo tanto, nuevos servicios no verificados podr铆an ser accesibles a trav茅s de esos puertos.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configuraciones vulnerables

### Acceso an贸nimo a Kube-apiserver

Por **defecto**, los puntos de acceso de la API de **kube-apiserver** est谩n **prohibidos** para el acceso **an贸nimo**. Pero siempre es una buena idea verificar si hay alg煤n punto de acceso **inseguro que exponga informaci贸n sensible**:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Verificaci贸n de acceso an贸nimo a ETCD

El ETCD almacena los secretos del cl煤ster, archivos de configuraci贸n y m谩s **datos sensibles**. Por **defecto**, el ETCD **no** puede ser accedido **an贸nimamente**, pero siempre es bueno verificar.

Si se puede acceder al ETCD de forma an贸nima, es posible que necesite **utilizar la** [**herramienta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). El siguiente comando obtendr谩 todas las claves almacenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **RCE de Kubelet**

La [**documentaci贸n de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que, de forma predeterminada, se permite el **acceso an贸nimo** al servicio:

> Habilita las solicitudes an贸nimas al servidor Kubelet. Las solicitudes que no son rechazadas por otro m茅todo de autenticaci贸n se tratan como solicitudes an贸nimas. Las solicitudes an贸nimas tienen un nombre de usuario `system:anonymous` y un nombre de grupo `system:unauthenticated`.

Para comprender mejor c贸mo funciona la **autenticaci贸n y autorizaci贸n de la API de Kubelet**, consulta esta p谩gina:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

El **servicio Kubelet** no est谩 **documentado**, pero el c贸digo fuente se puede encontrar aqu铆 y encontrar los puntos finales expuestos es tan f谩cil como **ejecutar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos ellos suenan interesantes.

Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con los Kubelets y sus puntos finales.


#### /pods

Este punto final lista los pods y sus contenedores:
```bash
kubeletctl pods
```
#### /exec

Este punto final permite ejecutar c贸digo dentro de cualquier contenedor de manera muy sencilla:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Comprobaci贸n de la exposici贸n de informaci贸n del puerto de solo lectura de Kubelet**

Cuando el puerto de solo lectura de **kubelet** est谩 expuesto, el atacante puede obtener informaci贸n de la API. Esto expone elementos de configuraci贸n del cl煤ster, como nombres de pods, ubicaci贸n de archivos internos y otras configuraciones. Esta informaci贸n no es cr铆tica, pero a煤n as铆 no deber铆a estar expuesta a Internet.

Por ejemplo, un atacante remoto puede abusar de esto accediendo a la siguiente URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, 隆consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
