# Pentestiranje Kubernetes usluga

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Kubernetes koristi nekoliko **specifi캜nih mre쬹ih usluga** koje mo쬰te prona캖i **izlo쬰ne na internetu** ili u **internoj mre쬴 nakon 코to ste kompromitovali jedan pod**.

## Pronala쬰nje izlo쬰nih podova putem OSINT-a

Jedan na캜in mo쬰 biti pretraga `Identity LIKE "k8s.%.com"` na [crt.sh](https://crt.sh) da biste prona코li poddomene povezane sa Kubernetes-om. Drugi na캜in mo쬰 biti pretraga `"k8s.%.com"` na github-u i pretraga **YAML fajlova** koji sadr쬰 taj string.

## Kako Kubernetes izla쬰 usluge

Mo쬰 vam biti korisno da razumete kako Kubernetes mo쬰 **javno izlo쬴ti usluge** kako biste ih prona코li:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Pronala쬰nje izlo쬰nih podova putem skeniranja porta

Slede캖i portovi mogu biti otvoreni u Kubernetes klasteru:

| Port            | Proces         | Opis                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API port                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Container metrike                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes API port                                                    |
| 8443/TCP        | kube-apiserver | Minikube API port                                                      |
| 8080/TCP        | kube-apiserver | Nesiguran API port                                                      |
| 10250/TCP       | kubelet        | HTTPS API koji omogu캖ava potpuni pristup                                |
| 10255/TCP       | kubelet        | Neautentifikovani samo-캜itaju캖i HTTP port: podovi, pokrenuti podovi i stanje 캜vora |
| 10256/TCP       | kube-proxy     | Kube Proxy server za proveru stanja                                    |
| 9099/TCP        | calico-felix   | Server za proveru stanja za Calico                                      |
| 6782-4/TCP      | weave          | Metrike i endpointi                                                     |
| 30000-32767/TCP | NodePort       | Proxy ka uslugama                                                      |
| 44134/TCP       | Tiller         | Helm servis za oslu코kivanje                                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Ovo je **API Kubernetes servis** sa kojim administratori obi캜no komuniciraju koriste캖i alat **`kubectl`**.

**Uobi캜ajeni portovi: 6443 i 443**, ali tako캠e i 8443 u minikube-u i 8080 kao nesiguran.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Proverite slede캖u stranicu da biste saznali kako da dobijete osetljive podatke i izvr코ite osetljive radnje komuniciraju캖i sa ovom uslugom:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ova usluga **radi na svakom 캜voru klastera**. To je usluga koja 캖e **kontrolisati** podove unutar **캜vora**. Komunicira sa **kube-apiserverom**.

Ako prona캠ete ovu izlo쬰nu uslugu, mo쬯a ste prona코li **neautentifikovani RCE**.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ako je odgovor `Unauthorized`, onda je potrebna autentifikacija.

Ako mo쬰te da nabrojite 캜vorove, mo쬰te dobiti listu kubelet endpointa sa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Samo 캜itanje)

Kubelet je agent koji se izvr코ava na svakom 캜voru u Kubernetes klasteru. On je odgovoran za upravljanje kontejnerima na 캜voru i komunicira sa kontrolnom ravni klastera. Kubelet pru쬬 REST API koji omogu캖ava 캜itanje informacija o kontejnerima i njihovim statusima na 캜voru.

Neki od na캜ina da se iskoristi kubelet (samo 캜itanje) uklju캜uju:

- Prikupljanje informacija o kontejnerima na 캜voru, uklju캜uju캖i njihove ID-ove, imena i status.
- Prikupljanje informacija o resursima koje kontejneri koriste, kao 코to su CPU i memorija.
- Prikupljanje informacija o mre쬹om prometu koji generi코u kontejneri.
- Prikupljanje informacija o logovima kontejnera.

Da biste iskoristili kubelet (samo 캜itanje), mo쬰te koristiti alate kao 코to su `kubectl` ili `kubeletctl`. Ovi alati omogu캖avaju pristup REST API-ju kubeleta i 캜itanje informacija o kontejnerima na 캜voru.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

Etcd je klju캜-vrednost skladi코te podataka koje se koristi u Kubernetes klasterima za 캜uvanje konfiguracija i stanja sistema. etcd API je RESTful API koji omogu캖ava pristup i manipulaciju podacima u etcd skladi코tu.

#### Autentifikacija

etcd API podr쬬va razli캜ite metode autentifikacije, uklju캜uju캖i klijentski sertifikat, korisni캜ko ime i lozinku, i token autentifikaciju. Ove metode se konfiguri코u u etcd konfiguracionom fajlu.

#### Autorizacija

etcd API tako캠e podr쬬va autorizaciju za kontrolu pristupa podacima. Mo쬰 se konfigurisati da koristi Role-Based Access Control (RBAC) ili Access Control Lists (ACL) za definisanje pravila pristupa.

#### Endpointi

etcd API ima nekoliko endpointa za upravljanje podacima u skladi코tu. Neki od naj캜e코캖e kori코캖enih endpointa su:

- `/v3/kv/put`: Koristi se za postavljanje vrednosti klju캜a u skladi코tu.
- `/v3/kv/range`: Koristi se za dobijanje vrednosti klju캜a iz skladi코ta.
- `/v3/kv/delete`: Koristi se za brisanje klju캜a iz skladi코ta.
- `/v3/lease/grant`: Koristi se za dodeljivanje zakupa za klju캜eve.
- `/v3/lease/revoke`: Koristi se za opozivanje zakupa za klju캜eve.

#### Napadi na etcd API

Kao i svaki drugi API, etcd API je podlo쬬n razli캜itim napadima. Neki od naj캜e코캖ih napada na etcd API uklju캜uju:

- Napad na autentifikaciju: Poku코aj kra캠e ili kompromitovanja autentifikacionih podataka kako bi se dobio neovla코캖en pristup etcd skladi코tu.
- Napad na autorizaciju: Poku코aj zaobila쬰nja ili kompromitovanja sistema autorizacije kako bi se dobio pristup podacima koje korisnik nema dozvolu da vidi ili menja.
- Napad na endpointe: Poku코aj izvr코avanja zlonamernih operacija putem etcd API endpointa, kao 코to su brisanje ili izmena klju캜eva.
- Napad na podatke: Poku코aj kra캠e ili modifikacije podataka u etcd skladi코tu.

Kako bi se spre캜ili ovi napadi, preporu캜uje se implementacija sigurnosnih mera kao 코to su kori코캖enje sigurnih autentifikacionih metoda, konfigurisanje pravilne autorizacije, i redovno a쬿riranje etcd API verzije radi ispravljanja poznatih sigurnosnih propusta.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller je server-side komponenta koja se koristi u Kubernetes Helm-u za upravljanje instalacijama Helm paketa. Tiller je zadu쬰n za komunikaciju sa Kubernetes API serverom i izvr코avanje operacija kao 코to su instalacija, nadogradnja i brisanje paketa.

Tiller je podlo쬬n odre캠enim sigurnosnim ranjivostima koje mogu biti iskori코캖ene za napade na Kubernetes klaster. Stoga je va쬹o preduzeti odre캠ene mere kako bi se osigurala sigurnost Tiller-a.

Neki od saveta za sigurno konfigurisanje Tiller-a uklju캜uju:

- Onemogu캖avanje Tiller-a da koristi privilegovane naloge
- Ograni캜avanje pristupa Tiller-u samo na odre캠ene namespace-ove
- Kori코캖enje Role-Based Access Control (RBAC) za kontrolu pristupa Tiller-u
- Redovno a쬿riranje Tiller-a na najnoviju verziju radi ispravljanja poznatih sigurnosnih propusta

Implementacija ovih mera poma쬰 u za코titi Tiller-a od potencijalnih napada i odr쬬vanju sigurnosti Kubernetes klastera.
```
helm --host tiller-deploy.kube-system:44134 version
```
Mo쬰te zloupotrebiti ovu uslugu da biste pove캖ali privilegije unutar Kubernetes-a:

### cAdvisor

Usluga korisna za prikupljanje metrika.
```
curl -k https://<IP Address>:4194
```
### NodePort

Kada je port izlo쬰n na svim 캜vorovima putem **NodePort**, isti port je otvoren na svim 캜vorovima koji preusmeravaju saobra캖aj ka deklarisanoj **Usluzi**. Prema podrazumevanim pode코avanjima, ovaj port 캖e biti u opsegu **30000-32767**. Dakle, nove neproverene usluge mogu biti dostupne putem tih portova.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Ranjive konfiguracije koje su podlo쬹e napadima

### Anonimni pristup kube-apiserver API endpointima

Anonimni pristup **kube-apiserver API endpointima nije dozvoljen**. Me캠utim, mo쬰te proveriti neke endpointe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Provera anonimnog pristupa ETCD-u

ETCD 캜uva tajne klastera, konfiguracione fajlove i druge **osetljive podatke**. Podrazumevano, ETCD **ne mo쬰** biti pristupljen anonimno, ali uvek je dobro proveriti.

Ako je anonimni pristup ETCD-u mogu캖, mo쬯a 캖e vam biti potrebno **koristiti** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **alat**. Slede캖a komanda 캖e dobiti sve sa캜uvane klju캜eve:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[**Dokumentacija za Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) obja코njava da je **podrazumevano dozvoljen anoniman pristup** servisu:

> Omogu캖ava anonimne zahteve ka Kubelet serveru. Zahtevi koji nisu odbijeni drugim metodama autentifikacije se tretiraju kao anonimni zahtevi. Anonimni zahtevi imaju korisni캜ko ime `system:anonymous` i ime grupe `system:unauthenticated`.

Da biste bolje razumeli kako **autentifikacija i autorizacija Kubelet API-ja** funkcioni코u, pogledajte ovu stranicu:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**API servisa Kubelet** nije dokumentovan, ali izvorni kod mo쬰te prona캖i ovde, a pronala쬰nje izlo쬰nih endpointa je jednostavno kao **pokretanje**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Svi zvu캜e interesantno.

Mo쬰te koristiti alat [**Kubeletctl**](https://github.com/cyberark/kubeletctl) za interakciju sa Kubeletima i njihovim endpointima.

#### /pods

Ovaj endpoint prikazuje liste podova i njihovih kontejnera:
```bash
kubeletctl pods
```
#### /exec

Ova ta캜ka omogu캖ava jednostavno izvr코avanje koda unutar bilo kog kontejnera:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Da biste izbegli ovaj napad, servis _**kubelet**_ treba pokrenuti sa `--anonymous-auth false` i servis treba izolovati na mre쬹om nivou.
{% endhint %}

### **Provera izlo쬰nosti informacija Kubelet (Read Only Port)**

Kada je **kubelet read-only port** izlo쬰n, postaje mogu캖e da neovla코캖ene strane povuku informacije sa API-ja. Izlo쬰nost ovog porta mo쬰 dovesti do otkrivanja razli캜itih **konfiguracionih elemenata klastera**. Iako informacije, uklju캜uju캖i **nazive podova, lokacije internih fajlova i druge konfiguracije**, mo쬯a nisu kriti캜ne, njihova izlo쬰nost i dalje predstavlja sigurnosni rizik i treba je izbe캖i.

Primer kako se ova ranjivost mo쬰 iskoristiti uklju캜uje udaljenog napada캜a koji pristupa odre캠enom URL-u. Navigiranjem na `http://<external-IP>:10255/pods`, napada캜 potencijalno mo쬰 povu캖i osetljive informacije sa kubeleta:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Reference

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
