# KubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

Kubernetesæ‹¥æœ‰ä¸€ä¸ªåä¸ºåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰çš„**æˆæƒæ¨¡å—**ï¼Œå®ƒå¯ä»¥å¸®åŠ©è®¾ç½®å¯¹APIæœåŠ¡å™¨çš„ä½¿ç”¨æƒé™ã€‚

RBACçš„æƒé™æ¨¡å‹ç”±**ä¸‰ä¸ªç‹¬ç«‹éƒ¨åˆ†**æ„æˆï¼š

1. **è§’è‰²/é›†ç¾¤è§’è‰²ï¼ˆRole/ClusterRoleï¼‰** - å®é™…çš„æƒé™ã€‚å®ƒåŒ…å«ä»£è¡¨ä¸€ç»„æƒé™çš„**è§„åˆ™**ã€‚æ¯ä¸ªè§„åˆ™åŒ…å«[èµ„æº](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types)å’Œ[åŠ¨è¯](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)ã€‚åŠ¨è¯æ˜¯å°†åº”ç”¨äºèµ„æºçš„æ“ä½œã€‚
2. **ä¸»ä½“ï¼ˆç”¨æˆ·ã€ç»„æˆ–ServiceAccountï¼‰** - å°†æ¥æ”¶æƒé™çš„å¯¹è±¡ã€‚
3. **è§’è‰²ç»‘å®š/é›†ç¾¤è§’è‰²ç»‘å®šï¼ˆRoleBinding/ClusterRoleBindingï¼‰** - è§’è‰²/é›†ç¾¤è§’è‰²ä¸ä¸»ä½“ä¹‹é—´çš„è¿æ¥ã€‚

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

â€œ**è§’è‰²ï¼ˆRolesï¼‰**â€å’Œâ€œ**é›†ç¾¤è§’è‰²ï¼ˆClusterRolesï¼‰**â€ä¹‹é—´çš„åŒºåˆ«ä»…åœ¨äºè§’è‰²å°†åº”ç”¨çš„ä½ç½® - â€œ**è§’è‰²ï¼ˆRoleï¼‰**â€å°†ä»…æˆäºˆå¯¹**ä¸€ä¸ªç‰¹å®šå‘½åç©ºé—´**çš„è®¿é—®æƒé™ï¼Œè€Œâ€œ**é›†ç¾¤è§’è‰²ï¼ˆClusterRoleï¼‰**â€å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„**æ‰€æœ‰å‘½åç©ºé—´**ä¸­ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œ**é›†ç¾¤è§’è‰²ï¼ˆClusterRolesï¼‰**è¿˜å¯ä»¥æˆäºˆå¯¹ä»¥ä¸‹å†…å®¹çš„è®¿é—®æƒé™ï¼š

* **é›†ç¾¤èŒƒå›´**çš„èµ„æºï¼ˆå¦‚èŠ‚ç‚¹ï¼‰ã€‚
* **éèµ„æº**ç«¯ç‚¹ï¼ˆå¦‚/healthzï¼‰ã€‚
* å‘½åç©ºé—´èµ„æºï¼ˆå¦‚Podsï¼‰ï¼Œè·¨æ‰€æœ‰å‘½åç©ºé—´ã€‚

ä»Kubernetes 1.6ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ç”¨äº†RBACç­–ç•¥ã€‚ä½†æ˜¯è¦å¯ç”¨RBACï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„æ–¹æ³•ï¼š
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## æ¨¡æ¿

åœ¨**è§’è‰²ï¼ˆRoleï¼‰**æˆ–**é›†ç¾¤è§’è‰²ï¼ˆClusterRoleï¼‰**çš„æ¨¡æ¿ä¸­ï¼Œæ‚¨éœ€è¦æŒ‡å®š**è§’è‰²çš„åç§°**ã€**å‘½åç©ºé—´**ï¼ˆåœ¨è§’è‰²ä¸­ï¼‰ï¼Œç„¶åæ˜¯è§’è‰²çš„**apiGroups**ã€**resources**å’Œ**verbs**ï¼š

* **apiGroups**æ˜¯ä¸€ä¸ªåŒ…å«æ­¤è§„åˆ™é€‚ç”¨äºçš„ä¸åŒ**APIå‘½åç©ºé—´**çš„æ•°ç»„ã€‚ä¾‹å¦‚ï¼ŒPodå®šä¹‰ä½¿ç”¨apiVersionï¼šv1ã€‚_å®ƒå¯ä»¥å…·æœ‰è¯¸å¦‚rbac.authorization.k8s.ioæˆ–\[\*\]çš„å€¼_ã€‚
* **resources**æ˜¯ä¸€ä¸ªå®šä¹‰æ­¤è§„åˆ™é€‚ç”¨äºçš„**èµ„æº**çš„æ•°ç»„ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`kubectl api-resources --namespaced=true`æ‰¾åˆ°æ‰€æœ‰èµ„æºã€‚
* **verbs**æ˜¯ä¸€ä¸ªåŒ…å«**å…è®¸çš„åŠ¨è¯**çš„æ•°ç»„ã€‚åœ¨Kubernetesä¸­ï¼ŒåŠ¨è¯å®šä¹‰äº†æ‚¨éœ€è¦å¯¹èµ„æºåº”ç”¨çš„**æ“ä½œç±»å‹**ã€‚ä¾‹å¦‚ï¼ŒliståŠ¨è¯ç”¨äºé›†åˆï¼Œè€Œ"get"åŠ¨è¯ç”¨äºå•ä¸ªèµ„æºã€‚

### è§„åˆ™åŠ¨è¯

ï¼ˆ_æ­¤ä¿¡æ¯æ¥è‡ª_ [_**æ­¤å¤„**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)ï¼‰

| HTTPåŠ¨è¯ | è¯·æ±‚åŠ¨è¯                                                                                                                                                      |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | getï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œlistï¼ˆç”¨äºé›†åˆï¼ŒåŒ…æ‹¬å®Œæ•´å¯¹è±¡å†…å®¹ï¼‰ï¼Œwatchï¼ˆç”¨äºç›‘è§†å•ä¸ªèµ„æºæˆ–èµ„æºé›†åˆï¼‰ |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | deleteï¼ˆç”¨äºå•ä¸ªèµ„æºï¼‰ï¼Œdeletecollectionï¼ˆç”¨äºé›†åˆï¼‰                                                                                         |

Kubernetesæœ‰æ—¶ä¼šä½¿ç”¨ä¸“é—¨çš„åŠ¨è¯æ£€æŸ¥å…¶ä»–æƒé™çš„æˆæƒã€‚ä¾‹å¦‚ï¼š

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* åœ¨`policy` APIç»„ä¸­çš„`podsecuritypolicies`èµ„æºä¸Šä½¿ç”¨`use`åŠ¨è¯ã€‚
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* åœ¨`rbac.authorization.k8s.io` APIç»„ä¸­çš„`roles`å’Œ`clusterroles`èµ„æºä¸Šä½¿ç”¨`bind`å’Œ`escalate`åŠ¨è¯ã€‚
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* åœ¨æ ¸å¿ƒAPIç»„ä¸­çš„`users`ã€`groups`å’Œ`serviceaccounts`ä¸Šä½¿ç”¨`impersonate`åŠ¨è¯ï¼Œå¹¶åœ¨`authentication.k8s.io` APIç»„ä¸­çš„`userextras`ä¸Šä½¿ç”¨ã€‚

{% hint style="warning" %}
æ‚¨å¯ä»¥ä½¿ç”¨`kubectl api-resources --sort-by name -o wide`å‘½ä»¤æ‰¾åˆ°**æ¯ä¸ªèµ„æºæ”¯æŒçš„æ‰€æœ‰åŠ¨è¯**ã€‚
{% endhint %}

### ç¤ºä¾‹

{% code title="è§’è‰²ï¼ˆRoleï¼‰" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**ClusterRole**æ¥å…è®¸ç‰¹å®šç”¨æˆ·è¿è¡Œï¼š
```
kubectl get pods --all-namespaces
```
### **RoleBindingå’ŒClusterRoleBinding**

**RoleBinding**æˆäºˆç”¨æˆ·æˆ–ä¸€ç»„ç”¨æˆ·åœ¨è§’è‰²ä¸­å®šä¹‰çš„æƒé™ã€‚å®ƒåŒ…å«ä¸€ä¸ªä¸»ä½“åˆ—è¡¨ï¼ˆç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦æˆ·ï¼‰å’Œå¯¹è¢«æˆäºˆè§’è‰²çš„å¼•ç”¨ã€‚**RoleBinding**åœ¨ç‰¹å®šçš„**å‘½åç©ºé—´**å†…æˆäºˆæƒé™ï¼Œè€Œ**ClusterRoleBinding**åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…æˆäºˆè®¿é—®æƒé™ã€‚

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**æƒé™æ˜¯å¯å åŠ çš„**ï¼Œå› æ­¤å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…·æœ‰â€œlistâ€å’Œâ€œdeleteâ€ secretsçš„clusterRoleï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…·æœ‰â€œgetâ€çš„Roleæ·»åŠ å®ƒã€‚å› æ­¤ï¼Œè¯·æ³¨æ„å¹¶å§‹ç»ˆæµ‹è¯•æ‚¨çš„è§’è‰²å’Œæƒé™ï¼Œå¹¶**æ˜ç¡®æŒ‡å®šå…è®¸çš„å†…å®¹ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ‹’ç»æ‰€æœ‰å†…å®¹**ã€‚

## **æšä¸¾RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### æ»¥ç”¨è§’è‰²/é›†ç¾¤è§’è‰²è¿›è¡Œç‰¹æƒå‡çº§

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[æ»¥ç”¨è§’è‰²/é›†ç¾¤è§’è‰²è¿›è¡Œç‰¹æƒå‡çº§](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
