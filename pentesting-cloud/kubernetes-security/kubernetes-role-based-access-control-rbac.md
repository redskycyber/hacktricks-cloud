# Kontrola dostÄ™pu oparta na rolach w Kubernetes (RBAC)

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Kontrola dostÄ™pu oparta na rolach (RBAC)

Kubernetes posiada moduÅ‚ **autoryzacji o nazwie Kontrola dostÄ™pu oparta na rolach** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)), ktÃ³ry pomaga w ustawianiu uprawnieÅ„ do serwera API.

Model uprawnieÅ„ RBAC skÅ‚ada siÄ™ z **trzech czÄ™Å›ci**:

1. **Rola/Rola klastra Â­â€“** Faktyczne uprawnienie. Zawiera _**reguÅ‚y**_, ktÃ³re reprezentujÄ… zestaw uprawnieÅ„. KaÅ¼da reguÅ‚a zawiera [zasoby](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) i [czasowniki](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Czasownik to dziaÅ‚anie, ktÃ³re zostanie zastosowane do zasobu.
2. **Podmiot (UÅ¼ytkownik, Grupa lub Konto usÅ‚ugi) â€“** Obiekt, ktÃ³ry otrzyma uprawnienia.
3. **RoleBinding/Rola klastra i powiÄ…zanie â€“** PoÅ‚Ä…czenie miÄ™dzy RolÄ…/RolÄ… klastra a podmiotem.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

RÃ³Å¼nica miÄ™dzy "**Rolami**" a "**Rolami klastra**" polega tylko na tym, gdzie rola zostanie zastosowana - "Rola" przyznaje dostÄ™p tylko do **jednego** **konkretnego** **namespace**, podczas gdy "Rola klastra" moÅ¼e byÄ‡ uÅ¼ywana we **wszystkich namespace'ach** w klastrze. Ponadto, **Role klastra** mogÄ… rÃ³wnieÅ¼ przyznawaÄ‡ dostÄ™p do:

* zasobÃ³w o **zasiÄ™gu klastra** (takich jak wÄ™zÅ‚y).
* punktÃ³w koÅ„cowych **bez zasobÃ³w** (takich jak /healthz).
* zasobÃ³w z przestrzeni nazw (takich jak Pod), **we wszystkich namespace'ach**.

Od wersji **Kubernetes** 1.6, polityki **RBAC** sÄ… **domyÅ›lnie wÅ‚Ä…czone**. Ale aby wÅ‚Ä…czyÄ‡ RBAC, moÅ¼na uÅ¼yÄ‡ czegoÅ› takiego jak:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Szablony

W szablonie **Role** lub **ClusterRole** musisz podaÄ‡ **nazwÄ™ roli**, **przestrzeÅ„ nazw** (w przypadku rÃ³l) oraz **apiGroups**, **resources** i **verbs** roli:

* **apiGroups** to tablica zawierajÄ…ca rÃ³Å¼ne **przestrzenie nazw API**, do ktÃ³rych ma zastosowanie ta reguÅ‚a. Na przykÅ‚ad, definicja Pod uÅ¼ywa apiVersion: v1. _MoÅ¼e mieÄ‡ wartoÅ›ci takie jak rbac.authorization.k8s.io lub \[\*]_.
* **resources** to tablica definiujÄ…ca, **do jakich zasobÃ³w ma zastosowanie ta reguÅ‚a**. MoÅ¼esz znaleÅºÄ‡ wszystkie zasoby za pomocÄ… polecenia: `kubectl api-resources --namespaced=true`
* **verbs** to tablica zawierajÄ…ca **dozwolone czasowniki**. Czasownik w Kubernetes definiuje **rodzaj dziaÅ‚ania**, ktÃ³re musisz zastosowaÄ‡ do zasobu. Na przykÅ‚ad, czasownik list jest uÅ¼ywany dla kolekcji, podczas gdy "get" jest uÅ¼ywany dla pojedynczego zasobu.

### Czasowniki reguÅ‚

(_Te informacje zostaÅ‚y zaczerpniÄ™te z_ [_**dokumentacji**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Czasownik HTTP | Czasownik Å¼Ä…dania                                                                                                                                             |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST           | create                                                                                                                                                        |
| GET, HEAD      | get (dla pojedynczych zasobÃ³w), list (dla kolekcji, w tym peÅ‚nej zawartoÅ›ci obiektu), watch (do obserwowania pojedynczego zasobu lub kolekcji zasobÃ³w)         |
| PUT            | update                                                                                                                                                        |
| PATCH          | patch                                                                                                                                                         |
| DELETE         | delete (dla pojedynczych zasobÃ³w), deletecollection (dla kolekcji)                                                                                             |

Kubernetes czasami sprawdza autoryzacjÄ™ dla dodatkowych uprawnieÅ„ za pomocÄ… specjalnych czasownikÃ³w. Na przykÅ‚ad:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* czasownik `use` dla zasobÃ³w `podsecuritypolicies` w grupie API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* czasowniki `bind` i `escalate` dla zasobÃ³w `roles` i `clusterroles` w grupie API `rbac.authorization.k8s.io`.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* czasownik `impersonate` dla zasobÃ³w `users`, `groups` i `serviceaccounts` w grupie API `core`, oraz `userextras` w grupie API `authentication.k8s.io`.

{% hint style="warning" %}
MoÅ¼esz znaleÅºÄ‡ **wszystkie czasowniki obsÅ‚ugiwane przez kaÅ¼dy zasÃ³b** wykonujÄ…c polecenie `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### PrzykÅ‚ady

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Na przykÅ‚ad, moÅ¼esz uÅ¼yÄ‡ **ClusterRole**, aby umoÅ¼liwiÄ‡ okreÅ›lonemu uÅ¼ytkownikowi uruchamianie:
```
kubectl get pods --all-namespaces
```
### **RoleBinding i ClusterRoleBinding**

**[Z dokumentacji:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** **RoleBinding** przyznaje uprawnienia zdefiniowane w roli uÅ¼ytkownikowi lub grupie uÅ¼ytkownikÃ³w. Przechowuje listÄ™ podmiotÃ³w (uÅ¼ytkownikÃ³w, grup lub kont usÅ‚ug) oraz odwoÅ‚anie do przyznanej roli. **RoleBinding** przyznaje uprawnienia w okreÅ›lonym **namespace**, podczas gdy **ClusterRoleBinding** przyznaje dostÄ™p na poziomie caÅ‚ego klastra.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Uprawnienia sÄ… dodawane**, wiÄ™c jeÅ›li masz clusterRole z uprawnieniami "list" i "delete" dla sekretÃ³w, moÅ¼esz dodaÄ‡ go z Role z uprawnieniem "get". BÄ…dÅº Å›wiadomy i zawsze testuj swoje role i uprawnienia oraz **okreÅ›l, co jest DOZWOLONE, poniewaÅ¼ domyÅ›lnie wszystko jest ZABRONIONE.**

## **Wyliczanie RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Wykorzystywanie rÃ³l/ClusterRoles do eskalacji uprawnieÅ„

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[wykorzystywanie-rÃ³l-clusterroles-w-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
