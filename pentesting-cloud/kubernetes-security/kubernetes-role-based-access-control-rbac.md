# Kubernetes Rol TabanlÄ± EriÅŸim KontrolÃ¼ (RBAC)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana dÃ¶nÃ¼ÅŸÃ¼n</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>ile Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek**.

</details>

## Rol TabanlÄ± EriÅŸim KontrolÃ¼ (RBAC)

Kubernetes, API sunucusuna kullanÄ±m izinleri belirlemeye yardÄ±mcÄ± olan bir **yetkilendirme modÃ¼lÃ¼ olan Rol TabanlÄ± EriÅŸim KontrolÃ¼** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) iÃ§erir.

RBAC'nin izin modeli **Ã¼Ã§ ayrÄ± parÃ§adan** oluÅŸur:

1. **Rol/KÃ¼me RolÃ¼** - GerÃ§ek izinleri iÃ§erir. Bir dizi izni temsil eden **kurallar** iÃ§erir. Her kural, [kaynaklarÄ±](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) ve [fiilleri](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) iÃ§erir. Fiil, kaynak Ã¼zerinde uygulanacak eylemdir.
2. **Ã–zne (KullanÄ±cÄ±, Grup veya Hizmet HesabÄ±)** - Ä°zinleri alacak nesne.
3. **RolBaÄŸlama/KÃ¼meRolÃ¼BaÄŸlama** - Rol/KÃ¼me RolÃ¼ ile Ã¶zne arasÄ±ndaki baÄŸlantÄ±.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

"**Roller**" ve "**KÃ¼me Roller**" arasÄ±ndaki fark, rolÃ¼n uygulanacaÄŸÄ± yerdir - "Rol", **yalnÄ±zca bir belirli ad alanÄ±na** eriÅŸim saÄŸlarken, "KÃ¼me RolÃ¼" kÃ¼medeki **tÃ¼m ad alanlarÄ±nda** kullanÄ±labilir. DahasÄ±, **KÃ¼me Roller** ayrÄ±ca ÅŸunlara da eriÅŸim saÄŸlayabilir:

* **KÃ¼me kapsamlÄ±** kaynaklar (Ã¶rneÄŸin dÃ¼ÄŸÃ¼mler).
* **Kaynak olmayan** uÃ§ noktalar (Ã¶rneÄŸin /healthz).
* Ad alanÄ±na ait kaynaklar (Ã¶rneÄŸin Pod'lar), **tÃ¼m ad alanlarÄ±na** yayÄ±lan.

Kubernetes 1.6'dan itibaren, RBAC politikalarÄ± **varsayÄ±lan olarak etkinleÅŸtirilmiÅŸtir**. Ancak RBAC'yi etkinleÅŸtirmek iÃ§in ÅŸuna benzer bir ÅŸey kullanabilirsiniz:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Åablonlar

Bir **Rol** veya **ClusterRole** ÅŸablonunda, **rolÃ¼n adÄ±nÄ±**, **namespace'i** (roller iÃ§in) ve ardÄ±ndan rolÃ¼n **apiGroups**, **resources** ve **verbs**'lerini belirtmeniz gerekecektir:

* **apiGroups**, bu kuralÄ±n uygulandÄ±ÄŸÄ± farklÄ± **API namespace'lerini** iÃ§eren bir dizi olarak tanÄ±mlanÄ±r. Ã–rneÄŸin, bir Pod tanÄ±mÄ± apiVersion: v1 kullanÄ±r. _DeÄŸerler arasÄ±nda rbac.authorization.k8s.io veya \[\*\] olabilir_.
* **resources**, bu kuralÄ±n uygulandÄ±ÄŸÄ± **hangi kaynaklara** uygulandÄ±ÄŸÄ±nÄ± tanÄ±mlayan bir dizi olarak belirtilir. TÃ¼m kaynaklarÄ± ÅŸu komutla bulabilirsiniz: `kubectl api-resources --namespaced=true`
* **verbs**, **izin verilen fiilleri** iÃ§eren bir dizi olarak tanÄ±mlanÄ±r. Kubernetes'te fiil, kaynaÄŸa uygulamanÄ±z gereken **eylemin tÃ¼rÃ¼nÃ¼** tanÄ±mlar. Ã–rneÄŸin, list fiili koleksiyonlara karÅŸÄ± kullanÄ±lÄ±rken "get" tek bir kaynaÄŸa karÅŸÄ± kullanÄ±lÄ±r.

### KurallarÄ±n Fiilleri

(_Bu bilgi_ [_**dokÃ¼mantasyondan**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) _alÄ±nmÄ±ÅŸtÄ±r_)

| HTTP fiili | istek fiili                                                                                                                                                   |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (bireysel kaynaklar iÃ§in), list (koleksiyonlar iÃ§in, tam nesne iÃ§eriÄŸi dahil), watch (bireysel bir kaynak veya kaynak koleksiyonu iÃ§in izleme)           |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (bireysel kaynaklar iÃ§in), deletecollection (koleksiyonlar iÃ§in)                                                                                         |

Kubernetes bazen Ã¶zel fiiller kullanarak ek izinler iÃ§in yetkilendirme kontrolÃ¼ yapar. Ã–rneÄŸin:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `policy` API grubundaki `podsecuritypolicies` kaynaklarÄ± Ã¼zerinde `use` fiili.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `rbac.authorization.k8s.io` API grubundaki `roles` ve `clusterroles` kaynaklarÄ± Ã¼zerinde `bind` ve `escalate` fiilleri.
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* Ã‡ekirdek API grubundaki `users`, `groups` ve `serviceaccounts` Ã¼zerinde `impersonate` fiili ve `authentication.k8s.io` API grubundaki `userextras` Ã¼zerinde.

{% hint style="warning" %}
Her kaynaÄŸÄ±n desteklediÄŸi **tÃ¼m fiilleri** `kubectl api-resources --sort-by name -o wide` komutunu kullanarak bulabilirsiniz.
{% endhint %}

### Ã–rnekler

{% code title="Rol" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Ã–rneÄŸin, belirli bir kullanÄ±cÄ±nÄ±n ÅŸunlarÄ± Ã§alÄ±ÅŸtÄ±rmasÄ±na izin vermek iÃ§in bir **ClusterRole** kullanabilirsiniz:
```
kubectl get pods --all-namespaces
```
### **RoleBinding ve ClusterRoleBinding**

**[DokÃ¼mantasyondan:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Bir **role binding**, bir kullanÄ±cÄ±ya veya kullanÄ±cÄ± grubuna tanÄ±mlanan bir role'deki izinleri saÄŸlar. Bu, bir dizi subject (kullanÄ±cÄ±lar, gruplar veya servis hesaplarÄ±) ve verilen role referansÄ± iÃ§erir. **RoleBinding**, belirli bir **namespace** iÃ§inde izinleri saÄŸlarken, **ClusterRoleBinding** bu eriÅŸimi **kÃ¼me genelinde** saÄŸlar.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Ä°zinler eklenir** bu yÃ¼zden "list" ve "delete" sÄ±rlarÄ± olan bir clusterRole'u "get" ile bir Role ile ekleyebilirsiniz. Bu yÃ¼zden her zaman rollerinizi ve izinlerinizi test edin ve **NEYE Ä°ZÄ°N VERÄ°LDÄ°ÄÄ°NÄ° belirtin, Ã§Ã¼nkÃ¼ varsayÄ±lan olarak HER ÅEY REDDEDÄ°LÄ°R.**

## **RBAC NumaralandÄ±rma**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Yetkilendirme RolÃ¼/KÃ¼me Rollerini Ä°stismar Etme

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
