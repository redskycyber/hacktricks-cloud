# AWS - KMSåæ¸—é€

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## KMS

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### åŠ å¯†/è§£å¯†ä¿¡æ¯

* ä½¿ç”¨**å¯¹ç§°**å¯†é’¥
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* ä½¿ç”¨**éå¯¹ç§°**å¯†é’¥ï¼š
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### é”€æ¯å¯†é’¥

To destroy keys in AWS Key Management Service (KMS), you can use the `schedule-key-deletion` API call. This allows you to set a waiting period before the key is permanently deleted. During this waiting period, you can cancel the deletion if needed.

To destroy a key, follow these steps:

1. Open the AWS Management Console and go to the KMS service.
2. Select the key you want to destroy.
3. Choose the "Key actions" dropdown menu and click on "Schedule key deletion".
4. Set the waiting period (in days) before the key is permanently deleted.
5. Click on "Schedule deletion" to initiate the process.

Once the waiting period is over, the key will be permanently deleted and cannot be recovered. It is important to note that destroying a key will also render any encrypted data using that key permanently inaccessible.

### é”€æ¯å¯†é’¥

è¦åœ¨AWSå¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆKMSï¼‰ä¸­é”€æ¯å¯†é’¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`schedule-key-deletion` APIè°ƒç”¨ã€‚è¿™å…è®¸æ‚¨åœ¨å¯†é’¥è¢«æ°¸ä¹…åˆ é™¤ä¹‹å‰è®¾ç½®ç­‰å¾…æœŸã€‚åœ¨ç­‰å¾…æœŸé—´ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥å–æ¶ˆåˆ é™¤æ“ä½œã€‚

è¦é”€æ¯å¯†é’¥ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

1. æ‰“å¼€AWSç®¡ç†æ§åˆ¶å°å¹¶è½¬åˆ°KMSæœåŠ¡ã€‚
2. é€‰æ‹©è¦é”€æ¯çš„å¯†é’¥ã€‚
3. é€‰æ‹©â€œå¯†é’¥æ“ä½œâ€ä¸‹æ‹‰èœå•ï¼Œç„¶åå•å‡»â€œè®¡åˆ’å¯†é’¥åˆ é™¤â€ã€‚
4. è®¾ç½®å¯†é’¥è¢«æ°¸ä¹…åˆ é™¤ä¹‹å‰çš„ç­‰å¾…æœŸï¼ˆä»¥å¤©ä¸ºå•ä½ï¼‰ã€‚
5. å•å‡»â€œè®¡åˆ’åˆ é™¤â€ä»¥å¯åŠ¨è¯¥è¿‡ç¨‹ã€‚

ç­‰å¾…æœŸç»“æŸåï¼Œå¯†é’¥å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ— æ³•æ¢å¤ã€‚é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œé”€æ¯å¯†é’¥è¿˜å°†ä½¿ä½¿ç”¨è¯¥å¯†é’¥åŠ å¯†çš„ä»»ä½•æ•°æ®æ°¸ä¹…æ— æ³•è®¿é—®ã€‚
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7

# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—å¥½å¤„ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¿›è¡Œå¹¿å‘Š**ï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“ï¼Œ[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
