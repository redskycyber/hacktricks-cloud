# AWS - S3, Athena & Glacier æšä¸¾

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## S3

Amazon S3æ˜¯ä¸€ä¸ªå…è®¸æ‚¨**å­˜å‚¨å¤§é‡æ•°æ®**çš„æœåŠ¡ã€‚

Amazon S3æä¾›å¤šç§é€‰é¡¹æ¥å®ç°æ•°æ®**ä¿æŠ¤**ã€‚è¿™äº›é€‰é¡¹åŒ…æ‹¬**æƒé™**ï¼ˆç­–ç•¥ï¼‰ã€**åŠ å¯†**ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼‰ã€**å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶**å’Œ**åŸºäºMFAçš„åˆ é™¤**ã€‚**ç”¨æˆ·å¯ä»¥å¯ç”¨**è¿™äº›é€‰é¡¹ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¥å®ç°æ•°æ®ä¿æŠ¤ã€‚**æ•°æ®å¤åˆ¶**æ˜¯AWSçš„å†…éƒ¨è®¾æ–½ï¼Œå…¶ä¸­**S3ä¼šè‡ªåŠ¨å°†æ¯ä¸ªå¯¹è±¡å¤åˆ¶åˆ°æ‰€æœ‰å¯ç”¨åŒº**ï¼Œç»„ç»‡åœ¨è¿™ç§æƒ…å†µä¸‹ä¸éœ€è¦å¯ç”¨å®ƒã€‚

ä½¿ç”¨åŸºäºèµ„æºçš„æƒé™ï¼Œæ‚¨å¯ä»¥åˆ†åˆ«ä¸ºå­˜å‚¨æ¡¶çš„å­ç›®å½•å®šä¹‰æƒé™ã€‚

### å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶å’ŒåŸºäºMFAçš„åˆ é™¤

å¯ç”¨å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶æ—¶ï¼Œä»»ä½•è¯•å›¾æ›´æ”¹æ–‡ä»¶å†…éƒ¨æ–‡ä»¶çš„æ“ä½œéƒ½ä¼šç”Ÿæˆè¯¥æ–‡ä»¶çš„æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¹Ÿä¿ç•™ç›¸åŒçš„æ—§å†…å®¹ã€‚å› æ­¤ï¼Œå®ƒä¸ä¼šè¦†ç›–å…¶å†…å®¹ã€‚

æ­¤å¤–ï¼ŒåŸºäºMFAçš„åˆ é™¤å°†é˜²æ­¢S3å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶ç‰ˆæœ¬è¢«åˆ é™¤ï¼Œä¹Ÿé˜²æ­¢å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶è¢«ç¦ç”¨ï¼Œå› æ­¤æ”»å‡»è€…å°†æ— æ³•æ›´æ”¹è¿™äº›æ–‡ä»¶ã€‚

### S3è®¿é—®æ—¥å¿—

å¯ä»¥**å¯ç”¨S3è®¿é—®æ—¥å¿—**ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ï¼‰ï¼Œå°†æ—¥å¿—ä¿å­˜åœ¨ä¸åŒçš„å­˜å‚¨æ¡¶ä¸­ï¼Œä»¥äº†è§£è°åœ¨è®¿é—®å­˜å‚¨æ¡¶ï¼ˆä¸¤ä¸ªå­˜å‚¨æ¡¶å¿…é¡»åœ¨åŒä¸€åŒºåŸŸå†…ï¼‰ã€‚

### S3é¢„ç­¾åURL

å¯ä»¥ç”Ÿæˆä¸€ä¸ªé¢„ç­¾åURLï¼Œé€šå¸¸ç”¨äº**è®¿é—®å­˜å‚¨æ¡¶ä¸­æŒ‡å®šçš„æ–‡ä»¶**ã€‚**é¢„ç­¾åURLçœ‹èµ·æ¥åƒè¿™æ ·**ï¼š
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
ä¸€ä¸ªé¢„ç­¾åURLå¯ä»¥**ä½¿ç”¨å…·æœ‰å¯¹è±¡è®¿é—®æƒé™çš„ä¸»ä½“çš„å‡­è¯ä»cliåˆ›å»º**ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„å¸æˆ·æ²¡æœ‰è®¿é—®æƒé™ï¼Œå°†åˆ›å»ºä¸€ä¸ªè¾ƒçŸ­çš„é¢„ç­¾åURLï¼Œä½†å®ƒå°†æ˜¯æ— ç”¨çš„ï¼‰
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
ç”Ÿæˆé¢„ç­¾å URL å”¯ä¸€éœ€è¦çš„æƒé™å°±æ˜¯è¢«æˆæƒçš„æƒé™ï¼Œå› æ­¤å¯¹äºå‰é¢çš„å‘½ä»¤ï¼Œä¸»ä½“å”¯ä¸€éœ€è¦çš„æƒé™æ˜¯ `s3:GetObject`
{% endhint %}

ä¹Ÿå¯ä»¥ä½¿ç”¨**å…¶ä»–æƒé™**åˆ›å»ºé¢„ç­¾å URLï¼š
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 åŠ å¯†æœºåˆ¶

**DEK æŒ‡çš„æ˜¯æ•°æ®åŠ å¯†å¯†é’¥**ï¼Œè¿™æ˜¯å§‹ç»ˆç”Ÿæˆå¹¶ç”¨äºåŠ å¯†æ•°æ®çš„å¯†é’¥ã€‚

<details>

<summary><strong>ä½¿ç”¨ S3 ç®¡ç†çš„å¯†é’¥è¿›è¡ŒæœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-S3</strong></summary>

æ­¤é€‰é¡¹éœ€è¦æœ€å°‘çš„é…ç½®ï¼Œæ‰€æœ‰ä½¿ç”¨çš„åŠ å¯†å¯†é’¥éƒ½ç”± AWS ç®¡ç†ã€‚æ‚¨éœ€è¦åšçš„å°±æ˜¯**ä¸Šä¼ æ‚¨çš„æ•°æ®ï¼ŒS3 å°†å¤„ç†æ‰€æœ‰å…¶ä»–æ–¹é¢**ã€‚S3 è´¦æˆ·ä¸­çš„æ¯ä¸ªå­˜å‚¨æ¡¶éƒ½è¢«åˆ†é…äº†ä¸€ä¸ªå­˜å‚¨æ¡¶å¯†é’¥ã€‚

* åŠ å¯†ï¼š
* å¯¹è±¡æ•°æ® + åˆ›å»ºçš„æ˜æ–‡ DEK --> åŠ å¯†æ•°æ®ï¼ˆå­˜å‚¨åœ¨ S3 å†…ï¼‰
* åˆ›å»ºçš„æ˜æ–‡ DEK + S3 ä¸»å¯†é’¥ --> åŠ å¯† DEKï¼ˆå­˜å‚¨åœ¨ S3 å†…ï¼‰ï¼Œæ˜æ–‡ä»å†…å­˜ä¸­åˆ é™¤
* è§£å¯†ï¼š
* åŠ å¯† DEK + S3 ä¸»å¯†é’¥ --> æ˜æ–‡ DEK
* æ˜æ–‡ DEK + åŠ å¯†æ•°æ® --> å¯¹è±¡æ•°æ®

è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹**å¯†é’¥ç”± AWS ç®¡ç†**ï¼ˆä»…æ¯ä¸‰å¹´æ—‹è½¬ä¸€æ¬¡ï¼‰ã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„å¯†é’¥ï¼Œæ‚¨å°†èƒ½å¤Ÿæ—‹è½¬ã€ç¦ç”¨å¹¶åº”ç”¨è®¿é—®æ§åˆ¶ã€‚

</details>

<details>

<summary><strong>ä½¿ç”¨ KMS ç®¡ç†çš„å¯†é’¥è¿›è¡ŒæœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-KMS</strong></summary>

æ­¤æ–¹æ³•å…è®¸ S3 ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡æ¥ç”Ÿæˆæ‚¨çš„æ•°æ®åŠ å¯†å¯†é’¥ã€‚KMS ä¸ºæ‚¨çš„å¯†é’¥ç®¡ç†æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç¦ç”¨ã€æ—‹è½¬å’Œåº”ç”¨è®¿é—®æ§åˆ¶åˆ° CMKï¼Œå¹¶ä½¿ç”¨ AWS Cloud Trail è®¢å•æ¥é˜²æ­¢å®ƒä»¬çš„ä½¿ç”¨ã€‚

* åŠ å¯†ï¼š
* S3 ä» KMS CMK è¯·æ±‚æ•°æ®å¯†é’¥
* KMS ä½¿ç”¨ CMK ç”Ÿæˆ DEK æ˜æ–‡å’Œ DEK åŠ å¯†å¯¹ï¼Œå¹¶å°†å®ƒä»¬å‘é€ç»™ SÂ£
* S3 ä½¿ç”¨æ˜æ–‡å¯†é’¥åŠ å¯†æ•°æ®ï¼Œå­˜å‚¨åŠ å¯†æ•°æ®å’ŒåŠ å¯†å¯†é’¥ï¼Œå¹¶ä»å†…å­˜ä¸­åˆ é™¤æ˜æ–‡å¯†é’¥
* è§£å¯†ï¼š
* S3 è¦æ±‚ KMS è§£å¯†å¯¹è±¡çš„åŠ å¯†æ•°æ®å¯†é’¥
* KMS ä½¿ç”¨ CMK è§£å¯†æ•°æ®å¯†é’¥å¹¶å°†å…¶å‘é€å› S3
* S3 è§£å¯†å¯¹è±¡æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥è¿›è¡ŒæœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-C</strong></summary>

æ­¤é€‰é¡¹ä¸ºæ‚¨æä¾›äº†æä¾›è‡ªå·±çš„ä¸»å¯†é’¥çš„æœºä¼šï¼Œæ‚¨å¯èƒ½å·²ç»åœ¨ AWS å¤–éƒ¨ä½¿ç”¨è¯¥å¯†é’¥ã€‚ç„¶åï¼Œæ‚¨æä¾›çš„å®¢æˆ·å¯†é’¥å°†ä¸æ‚¨çš„æ•°æ®ä¸€èµ·å‘é€åˆ° S3ï¼Œåœ¨é‚£é‡Œ S3 å°†ä¸ºæ‚¨æ‰§è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* ç”¨æˆ·å°†å¯¹è±¡æ•°æ® + å®¢æˆ·å¯†é’¥å‘é€åˆ° S3
* å®¢æˆ·å¯†é’¥ç”¨äºåŠ å¯†æ•°æ®ï¼ŒåŠ å¯†æ•°æ®è¢«å­˜å‚¨
* å®¢æˆ·å¯†é’¥çš„ç›åŒ– HMAC å€¼ä¹Ÿè¢«å­˜å‚¨ï¼Œç”¨äºå°†æ¥çš„å¯†é’¥éªŒè¯
* å®¢æˆ·å¯†é’¥ä»å†…å­˜ä¸­åˆ é™¤
* è§£å¯†ï¼š
* ç”¨æˆ·å‘é€å®¢æˆ·å¯†é’¥
* å¯†é’¥ä¸å­˜å‚¨çš„ HMAC å€¼è¿›è¡ŒéªŒè¯
* ç„¶åä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥è§£å¯†æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨ KMS çš„å®¢æˆ·ç«¯åŠ å¯†ï¼ŒCSE-KMS</strong></summary>

ä¸ SSE-KMS ç±»ä¼¼ï¼Œè¿™ä¹Ÿä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡æ¥ç”Ÿæˆæ‚¨çš„æ•°æ®åŠ å¯†å¯†é’¥ã€‚ç„¶è€Œï¼Œè¿™æ¬¡æ˜¯é€šè¿‡å®¢æˆ·ç«¯è€Œä¸æ˜¯ S3 è°ƒç”¨ KMSã€‚ç„¶ååœ¨å®¢æˆ·ç«¯è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†æ•°æ®éšåå‘é€åˆ° S3 è¿›è¡Œå­˜å‚¨ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯å‘ KMS è¯·æ±‚æ•°æ®å¯†é’¥
* KMS è¿”å›æ˜æ–‡ DEK å’Œä½¿ç”¨ CMK åŠ å¯†çš„ DEK
* ä¸¤ä¸ªå¯†é’¥éƒ½è¢«å‘é€å›æ¥
* å®¢æˆ·ç«¯éšåä½¿ç”¨æ˜æ–‡ DEK åŠ å¯†æ•°æ®ï¼Œå¹¶å°†åŠ å¯†æ•°æ® + åŠ å¯† DEK å‘é€åˆ° S3ï¼ˆä½œä¸º S3 å†…åŠ å¯†æ•°æ®çš„å…ƒæ•°æ®ä¿å­˜ï¼‰
* è§£å¯†ï¼š
* åŠ å¯†æ•°æ®ä¸åŠ å¯† DEK å‘é€ç»™å®¢æˆ·ç«¯
* å®¢æˆ·ç«¯è¦æ±‚ KMS ä½¿ç”¨ CMK è§£å¯†åŠ å¯†å¯†é’¥ï¼ŒKMS å‘å›æ˜æ–‡ DEK
* å®¢æˆ·ç«¯ç°åœ¨å¯ä»¥è§£å¯†åŠ å¯†æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥è¿›è¡Œå®¢æˆ·ç«¯åŠ å¯†ï¼ŒCSE-C</strong></summary>

ä½¿ç”¨æ­¤æœºåˆ¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è‡ªå·±æä¾›çš„å¯†é’¥ï¼Œå¹¶ä½¿ç”¨ AWS-SDK å®¢æˆ·ç«¯åœ¨å°†æ•°æ®å‘é€åˆ° S3 å­˜å‚¨ä¹‹å‰å¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯ç”Ÿæˆ DEK å¹¶åŠ å¯†æ˜æ–‡æ•°æ®
* ç„¶åï¼Œä½¿ç”¨å®ƒè‡ªå·±çš„è‡ªå®šä¹‰ CMK åŠ å¯† DEK
* å°†åŠ å¯†æ•°æ® + åŠ å¯† DEK æäº¤åˆ° S3ï¼Œå…¶ä¸­å­˜å‚¨
* è§£å¯†ï¼š
* S3 å‘é€åŠ å¯†æ•°æ®å’Œ DEK
* ç”±äºå®¢æˆ·ç«¯å·²ç»æ‹¥æœ‰ç”¨äºåŠ å¯† DEK çš„ CMKï¼Œå®ƒè§£å¯† DEKï¼Œç„¶åä½¿ç”¨æ˜æ–‡ DEK è§£å¯†æ•°æ®

</details>

### **æšä¸¾**

ä¾µå®³ AWS ç»„ç»‡çš„ä¼ ç»Ÿä¸»è¦æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡å…¬å¼€å¯è®¿é—®çš„å­˜å‚¨æ¡¶å¼€å§‹ã€‚**æ‚¨å¯ä»¥åœ¨æ­¤é¡µé¢æ‰¾åˆ°**[**å…¬å…±å­˜å‚¨æ¡¶æšä¸¾å™¨**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**ã€‚**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### åŒæ ˆ <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨è™šæ‹Ÿæ‰˜ç®¡å¼æˆ–è·¯å¾„å¼ç«¯ç‚¹åç§°ï¼Œé€šè¿‡åŒæ ˆç«¯ç‚¹è®¿é—®S3å­˜å‚¨æ¡¶ã€‚è¿™äº›å¯¹äºé€šè¿‡IPv6è®¿é—®S3å¾ˆæœ‰ç”¨ã€‚

åŒæ ˆç«¯ç‚¹ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### æƒé™æå‡

åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å¦‚ä½•**æ»¥ç”¨S3æƒé™ä»¥æå‡æƒé™**ï¼š

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### æœªç»è®¤è¯çš„è®¿é—®

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 æ“ä½œååˆ©ç”¨

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## å…¶ä»–S3æ¼æ´

### S3 HTTPç¼“å­˜æŠ•æ¯’é—®é¢˜ <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**æ ¹æ®è¿™é¡¹ç ”ç©¶**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue)ï¼Œå¯ä»¥ç¼“å­˜ä»»æ„å­˜å‚¨æ¡¶çš„å“åº”ï¼Œå°±å¥½åƒå®ƒå±äºå¦ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸€æ ·ã€‚è¿™å¯èƒ½è¢«æ»¥ç”¨æ¥æ›´æ”¹ä¾‹å¦‚JavaScriptæ–‡ä»¶å“åº”ï¼Œå¹¶é€šè¿‡ä½¿ç”¨S3å­˜å‚¨é™æ€ä»£ç æ¥å¦¥åä»»æ„é¡µé¢ã€‚

## Amazon Athena

Amazon Athenaæ˜¯ä¸€ä¸ªäº¤äº’å¼æŸ¥è¯¢æœåŠ¡ï¼Œå®ƒå¯ä»¥è½»æ¾åœ°**åˆ†æ**ç›´æ¥åœ¨Amazonç®€å•å­˜å‚¨æœåŠ¡ï¼ˆAmazon **S3**ï¼‰ä¸­çš„æ•°æ®ï¼Œ**ä½¿ç”¨**æ ‡å‡†**SQL**ã€‚

æ‚¨éœ€è¦**å‡†å¤‡ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“è¡¨**ï¼Œæ ¼å¼ä¸å°†å‡ºç°åœ¨ç›‘æ§çš„S3å­˜å‚¨æ¡¶ä¸­çš„å†…å®¹ç›¸åŒ¹é…ã€‚ç„¶åï¼ŒAmazon Athenaå°†èƒ½å¤Ÿä»æ—¥å¿—ä¸­å¡«å……æ•°æ®åº“ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æŸ¥è¯¢å®ƒã€‚

Amazon Athenaæ”¯æŒ**æŸ¥è¯¢å·²åŠ å¯†çš„S3æ•°æ®çš„èƒ½åŠ›**ï¼Œå¦‚æœè¿›è¡Œäº†é…ç½®ï¼Œ**Athenaè¿˜å¯ä»¥åŠ å¯†æŸ¥è¯¢ç»“æœï¼Œç„¶åå¯ä»¥å­˜å‚¨åœ¨S3ä¸­**ã€‚

**è¿™ç§ç»“æœåŠ å¯†ä¸æŸ¥è¯¢çš„åº•å±‚S3æ•°æ®æ— å…³**ï¼Œè¿™æ„å‘³ç€å³ä½¿S3æ•°æ®æœªåŠ å¯†ï¼ŒæŸ¥è¯¢ç»“æœä¹Ÿå¯ä»¥åŠ å¯†ã€‚éœ€è¦æ³¨æ„çš„å‡ ç‚¹æ˜¯ï¼ŒAmazon Athenaä»…æ”¯æŒå·²ä½¿ç”¨ä»¥ä¸‹S3åŠ å¯†æ–¹æ³•åŠ å¯†çš„æ•°æ®ï¼Œ**SSE-S3ã€SSE-KMSå’ŒCSE-KMS**ã€‚

ä¸æ”¯æŒSSE-Cå’ŒCSE-Eã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ï¼ŒAmazon Athenaåªä¼šå¯¹ä¸æŸ¥è¯¢æœ¬èº«ä½äºåŒä¸€åŒºåŸŸçš„**åŠ å¯†å¯¹è±¡**è¿è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæ‚¨éœ€è¦æŸ¥è¯¢ä½¿ç”¨KMSåŠ å¯†çš„S3æ•°æ®ï¼Œåˆ™Athenaç”¨æˆ·éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½æ‰§è¡ŒæŸ¥è¯¢ã€‚

### æšä¸¾
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## å‚è€ƒèµ„æ–™

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
