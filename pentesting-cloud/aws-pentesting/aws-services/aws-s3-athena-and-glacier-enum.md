# AWS - S3, Athena & Glacier Enum

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## S3

Amazon S3 je usluga koja vam omoguÄ‡ava **skladiÅ¡tenje velike koliÄine podataka**.

Amazon S3 pruÅ¾a viÅ¡e opcija za postizanje **zaÅ¡tite** podataka u mirovanju. Opcije ukljuÄuju **dozvole** (Politika), **enkripciju** (klijentsku i serversku stranu), **verzioniranje kante** i **MFA** **bazirano brisanje**. **Korisnik moÅ¾e omoguÄ‡iti** bilo koju od ovih opcija kako bi postigao zaÅ¡titu podataka. **Replikacija podataka** je interna moguÄ‡nost od strane AWS-a gde **S3 automatski replikira svaki objekat preko svih zona dostupnosti** i organizacija ne mora da je omoguÄ‡i u ovom sluÄaju.

Sa dozvolama zasnovanim na resursima, moÅ¾ete definisati dozvole za poddirektorijume vaÅ¡e kante posebno.

### Verzioniranje kante i MFA bazirano brisanje

Kada je verzioniranje kante omoguÄ‡eno, svaka akcija koja pokuÅ¡ava da izmeni fajl unutar fajla Ä‡e generisati novu verziju fajla, ÄuvajuÄ‡i takoÄ‘e prethodni sadrÅ¾aj istog. Stoga, neÄ‡e prepisati njegov sadrÅ¾aj.

Osim toga, MFA bazirano brisanje Ä‡e spreÄiti brisanje verzija fajla u S3 kanti i takoÄ‘e onemoguÄ‡iti verzioniranje kante, tako da napadaÄ neÄ‡e moÄ‡i da izmeni ove fajlove.

### S3 pristupni logovi

MoguÄ‡e je **omoguÄ‡iti pristupne logove S3** (koji su po defaultu onemoguÄ‡eni) za neku kantu i saÄuvati logove u drugoj kanti kako bi se saznalo ko pristupa kanti (obe kante moraju biti u istom regionu).

### S3 prethodno potpisani URL-ovi

MoguÄ‡e je generisati prethodno potpisani URL koji se obiÄno moÅ¾e koristiti za **pristupanje odreÄ‘enom fajlu** u kanti. **Prethodno potpisani URL izgleda ovako**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Jedan prethodno potpisani URL moÅ¾e biti **kreiran iz komandne linije koristeÄ‡i akreditive principala sa pristupom objektu** (ako nalog koji koristite nema pristup, biÄ‡e kreiran kraÄ‡i prethodno potpisani URL, ali Ä‡e biti beskoristan).
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Jedina potrebna dozvola za generisanje prethodno potpisane URL adrese je dozvola koja se daje, tako da za prethodnu komandu jedina dozvola koja je potrebna od strane principala je `s3:GetObject`.
{% endhint %}

TakoÄ‘e je moguÄ‡e kreirati prethodno potpisane URL adrese sa **drugim dozvolama**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### Mekanizmi Å¡ifrovanja S3

**DEK znaÄi Data Encryption Key** i kljuÄ koji se uvek generiÅ¡e i koristi za Å¡ifrovanje podataka.

<details>

<summary><strong>Server-side enkripcija sa upravljanjem kljuÄevima od strane S3, SSE-S3</strong></summary>

Ova opcija zahteva minimalnu konfiguraciju i svi kljuÄevi za Å¡ifrovanje koje koristite se upravljaju od strane AWS-a. Sve Å¡to treba da uradite je da **otprenirate svoje podatke i S3 Ä‡e se pobrinuti za sve ostale aspekte**. Svaka kanta u S3 nalogu dobija kljuÄ kante.

* Å ifrovanje:
* Podaci objekta + kreirani plaintext DEK --> Å ifrovani podaci (smeÅ¡teni unutar S3)
* Kreirani plaintext DEK + S3 Master kljuÄ --> Å ifrovani DEK (smeÅ¡ten unutar S3) i plaintext se briÅ¡e iz memorije
* Dekripcija:
* Å ifrovani DEK + S3 Master kljuÄ --> Plaintext DEK
* Plaintext DEK + Å ifrovani podaci --> Podaci objekta

Molimo, imajte na umu da u ovom sluÄaju **kljuÄem upravlja AWS** (rotacija se vrÅ¡i samo svake 3 godine). Ako koristite svoj kljuÄ, moÄ‡i Ä‡ete da vrÅ¡ite rotaciju, onemoguÄ‡avanje i primenu kontrole pristupa.

</details>

<details>

<summary><strong>Server-side enkripcija sa upravljanjem kljuÄevima od strane KMS-a, SSE-KMS</strong></summary>

Ovaj metod omoguÄ‡ava S3-u da koristi uslugu upravljanja kljuÄevima za generisanje kljuÄeva za Å¡ifrovanje podataka. KMS vam pruÅ¾a mnogo veÄ‡u fleksibilnost u upravljanju kljuÄevima. Na primer, moÅ¾ete onemoguÄ‡iti, rotirati i primeniti kontrole pristupa na CMK, i pratiti njihovu upotrebu pomoÄ‡u AWS Cloud Trail-a.

* Å ifrovanje:
* S3 zahteva kljuÄeve podataka od KMS CMK
* KMS koristi CMK da generiÅ¡e par plaintext DEK i Å¡ifrovanog DEK-a i Å¡alje ih S3-u
* S3 koristi plaintext kljuÄ za Å¡ifrovanje podataka, smeÅ¡ta Å¡ifrovane podatke i Å¡ifrovani kljuÄ i briÅ¡e plaintext kljuÄ iz memorije
* Dekripcija:
* S3 traÅ¾i od KMS-a da deÅ¡ifruje Å¡ifrovani kljuÄ podatka objekta
* KMS deÅ¡ifruje kljuÄ podataka sa CMK-om i Å¡alje ga nazad S3-u
* S3 deÅ¡ifruje podatke objekta

</details>

<details>

<summary><strong>Server-side enkripcija sa kljuÄevima koje obezbeÄ‘uje korisnik, SSE-C</strong></summary>

Ova opcija vam omoguÄ‡ava da koristite svoj sopstveni glavni kljuÄ koji veÄ‡ moÅ¾da koristite van AWS-a. VaÅ¡ kljuÄ koji obezbeÄ‘uje korisnik biÄ‡e zatim poslat sa vaÅ¡im podacima u S3, gde Ä‡e S3 obaviti Å¡ifrovanje za vas.

* Å ifrovanje:
* Korisnik Å¡alje podatke objekta + KljuÄ korisnika S3-u
* KljuÄ korisnika se koristi za Å¡ifrovanje podataka i Å¡ifrovani podaci se smeÅ¡taju
* takoÄ‘e se Äuva soljeni HMAC vrednost kljuÄa korisnika za buduÄ‡u proveru kljuÄa
* kljuÄ korisnika se briÅ¡e iz memorije
* Dekripcija:
* Korisnik Å¡alje kljuÄ korisnika
* KljuÄ se proverava protiv saÄuvane HMAC vrednosti
* KljuÄ koji obezbeÄ‘uje korisnik se zatim koristi za deÅ¡ifrovanje podataka

</details>

<details>

<summary><strong>Klijentska enkripcija sa KMS-om, CSE-KMS</strong></summary>

SliÄno kao SSE-KMS, i ovde se koristi usluga upravljanja kljuÄevima za generisanje kljuÄeva za Å¡ifrovanje podataka. MeÄ‘utim, ovog puta se KMS poziva putem klijenta, a ne S3. Enkripcija se zatim vrÅ¡i na strani klijenta, a Å¡ifrovani podaci se zatim Å¡alju S3-u radi smeÅ¡tanja.

* Å ifrovanje:
* Klijent zahteva kljuÄ podataka od KMS-a
* KMS vraÄ‡a plaintext DEK i Å¡ifrovani DEK sa CMK-om
* Oba kljuÄa se Å¡alju nazad
* Klijent zatim Å¡ifruje podatke sa plaintext DEK-om i Å¡alje S3-u Å¡ifrovane podatke + Å¡ifrovani DEK (koji se Äuva kao metapodatak Å¡ifrovanih podataka unutar S3)
* Dekripcija:
* Å ifrovani podaci sa Å¡ifrovanim DEK-om se Å¡alju klijentu
* Klijent traÅ¾i od KMS-a da deÅ¡ifruje Å¡ifrovani kljuÄ koristeÄ‡i CMK i KMS vraÄ‡a plaintext DEK
* Klijent sada moÅ¾e deÅ¡ifrovati Å¡ifrovane podatke

</details>

<details>

<summary><strong>Klijentska enkripcija sa kljuÄevima koje obezbeÄ‘uje korisnik, CSE-C</strong></summary>

KoristeÄ‡i ovaj mehanizam, moÅ¾ete koristiti svoje sopstvene kljuÄeve i koristiti AWS-SDK klijent za Å¡ifrovanje podataka pre slanja u S3 radi smeÅ¡tanja.

* Å ifrovanje:
* Klijent generiÅ¡e DEK i Å¡ifruje plaintext podatke
* Zatim, koristeÄ‡i sopstveni prilagoÄ‘eni CMK, Å¡ifruje DEK
* Å¡alje Å¡ifrovane podatke + Å¡ifrovani DEK S3-u gde se smeÅ¡taju
* Dekripcija:
* S3 Å¡alje Å¡ifrovane podatke i DEK
* Kako klijent veÄ‡ ima CMK koji se koristi za Å¡ifrovanje DEK-a, deÅ¡ifruje DEK, a zatim koristi plaintext DEK za deÅ¡ifrovanje podataka

</details>

### **Enumeracija**

Jedan od tradicionalnih naÄina kompromitovanja AWS organizacija poÄinje kompromitovanjem javno dostupnih kanti. **MoÅ¾ete pronaÄ‡i** [**alate za enumeraciju javnih kanti na ovoj stranici**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### Dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

MoÅ¾ete pristupiti S3 kanti putem dual-stack endpointa koristeÄ‡i virtualni hosted-style ili path-style endpoint ime. Ovi endpointi su korisni za pristup S3 putem IPv6.

Dual-stack endpointi koriste sledeÄ‡u sintaksu:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Na sledeÄ‡oj stranici moÅ¾ete proveriti kako **zloupotrebiti S3 dozvole da biste poveÄ‡ali privilegije**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Neautentifikovan pristup

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 post eksploatacija

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Ostale S3 ranjivosti

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Prema ovom istraÅ¾ivanju**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) bilo je moguÄ‡e keÅ¡irati odgovor proizvoljne kante kao da pripada drugoj kanti. Ovo bi moglo biti zloupotrebljeno da se promene, na primer, odgovori javascript fajlova i kompromituju proizvoljne stranice koje koriste S3 za skladiÅ¡tenje statiÄkog koda.

## Amazon Athena

Amazon Athena je interaktivna upitna usluga koja olakÅ¡ava **analizu podataka** direktno u Amazon Simple Storage Service (Amazon **S3**) **koristeÄ‡i** standardni **SQL**.

Potrebno je **pripremiti tabelu relacijske baze podataka** sa formatom sadrÅ¾aja koji Ä‡e se pojaviti u praÄ‡enim S3 kantama. Zatim, Amazon Athena Ä‡e moÄ‡i da popuni bazu podacima iz logova, tako da ih moÅ¾ete upitati.

Amazon Athena podrÅ¾ava **moguÄ‡nost upita nad S3 podacima koji su veÄ‡ enkriptovani**, i ako je konfigurisana da to radi, **Athena takoÄ‘e moÅ¾e enkriptovati rezultate upita koji se mogu Äuvati u S3**.

**Ova enkripcija rezultata je nezavisna od enkriptovanih S3 podataka koji se upituju**, Å¡to znaÄi da Äak i ako S3 podaci nisu enkriptovani, rezultati upita mogu biti enkriptovani. Neke vaÅ¾ne taÄke koje treba imati na umu su da Amazon Athena podrÅ¾ava samo podatke koji su **enkriptovani** sa **sledeÄ‡im metodama enkripcije S3**, **SSE-S3, SSE-KMS i CSE-KMS**.

SSE-C i CSE-E nisu podrÅ¾ani. Pored toga, vaÅ¾no je razumeti da Ä‡e Amazon Athena izvrÅ¡avati upite samo nad **enkriptovanim objektima koji se nalaze u istoj regiji kao i sam upit**. Ako Å¾elite da upitate S3 podatke koji su enkriptovani pomoÄ‡u KMS, tada su potrebne odreÄ‘ene dozvole od strane korisnika Athene da bi omoguÄ‡ili izvrÅ¡avanje upita.

### Enumeracija
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Reference

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
