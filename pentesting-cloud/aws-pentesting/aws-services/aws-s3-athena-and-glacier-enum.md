# AWS - S3ã€Athenaå’ŒGlacieræšä¸¾

<details>

<summary><strong>æ”¯æŒHackTrickså¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—®PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricksï¼Œè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## S3

Amazon S3æ˜¯ä¸€é¡¹å…è®¸æ‚¨**å­˜å‚¨å¤§é‡æ•°æ®**çš„æœåŠ¡ã€‚

Amazon S3æä¾›äº†å¤šç§é€‰é¡¹æ¥å®ç°æ•°æ®åœ¨RESTçŠ¶æ€ä¸‹çš„**ä¿æŠ¤**ã€‚è¿™äº›é€‰é¡¹åŒ…æ‹¬**æƒé™**ï¼ˆç­–ç•¥ï¼‰ã€**åŠ å¯†**ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼‰ã€**å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶**å’Œ**åŸºäºMFAçš„åˆ é™¤**ã€‚ç”¨æˆ·å¯ä»¥å¯ç”¨è¿™äº›é€‰é¡¹ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¥å®ç°æ•°æ®ä¿æŠ¤ã€‚**æ•°æ®å¤åˆ¶**æ˜¯AWSçš„ä¸€ä¸ªå†…éƒ¨è®¾æ–½ï¼Œå…¶ä¸­S3ä¼šè‡ªåŠ¨å°†æ¯ä¸ªå¯¹è±¡å¤åˆ¶åˆ°æ‰€æœ‰å¯ç”¨åŒºåŸŸï¼Œå¹¶ä¸”ç»„ç»‡æ— éœ€åœ¨æ­¤æƒ…å†µä¸‹å¯ç”¨å®ƒã€‚

é€šè¿‡åŸºäºèµ„æºçš„æƒé™ï¼Œæ‚¨å¯ä»¥ä¸ºå­˜å‚¨æ¡¶çš„å­ç›®å½•å•ç‹¬å®šä¹‰æƒé™ã€‚

### å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶å’ŒåŸºäºMFAçš„åˆ é™¤

å½“å¯ç”¨å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶æ—¶ï¼Œä»»ä½•è¯•å›¾æ›´æ”¹æ–‡ä»¶å†…éƒ¨æ–‡ä»¶çš„æ“ä½œéƒ½ä¼šç”Ÿæˆæ–‡ä»¶çš„æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¿ç•™ç›¸åŒæ–‡ä»¶çš„å…ˆå‰å†…å®¹ã€‚å› æ­¤ï¼Œå®ƒä¸ä¼šè¦†ç›–å…¶å†…å®¹ã€‚

æ­¤å¤–ï¼ŒåŸºäºMFAçš„åˆ é™¤å°†é˜»æ­¢åˆ é™¤S3å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶ç‰ˆæœ¬ï¼Œè¿˜å°†é˜»æ­¢ç¦ç”¨å­˜å‚¨æ¡¶ç‰ˆæœ¬æ§åˆ¶ï¼Œå› æ­¤æ”»å‡»è€…æ— æ³•æ›´æ”¹è¿™äº›æ–‡ä»¶ã€‚

### S3è®¿é—®æ—¥å¿—

å¯ä»¥**å¯ç”¨S3è®¿é—®æ—¥å¿—è®°å½•**ï¼ˆé»˜è®¤æƒ…å†µä¸‹ç¦ç”¨ï¼‰ä»¥è®°å½•æŸä¸ªå­˜å‚¨æ¡¶çš„è®¿é—®æ—¥å¿—ï¼Œå¹¶å°†æ—¥å¿—ä¿å­˜åœ¨ä¸åŒçš„å­˜å‚¨æ¡¶ä¸­ï¼Œä»¥äº†è§£è°è®¿é—®äº†è¯¥å­˜å‚¨æ¡¶ï¼ˆä¸¤ä¸ªå­˜å‚¨æ¡¶å¿…é¡»ä½äºåŒä¸€åŒºåŸŸï¼‰ã€‚

### S3é¢„ç­¾åURL

å¯ä»¥ç”Ÿæˆä¸€ä¸ªé¢„ç­¾åURLï¼Œé€šå¸¸ç”¨äº**è®¿é—®å­˜å‚¨æ¡¶ä¸­æŒ‡å®šçš„æ–‡ä»¶**ã€‚**é¢„ç­¾åURLçš„æ ¼å¼å¦‚ä¸‹**ï¼š
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
å¯ä»¥ä½¿ç”¨å…·æœ‰å¯¹å¯¹è±¡è®¿é—®æƒé™çš„ä¸»ä½“çš„å‡­æ®ä»cliåˆ›å»ºé¢„ç­¾åURLï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„å¸æˆ·æ²¡æœ‰è®¿é—®æƒé™ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªè¾ƒçŸ­çš„é¢„ç­¾åURLï¼Œä½†å®ƒå°†æ— ç”¨ï¼‰
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
ç”Ÿæˆé¢„ç­¾å URL æ‰€éœ€çš„å”¯ä¸€æƒé™æ˜¯æ­£åœ¨æˆäºˆçš„æƒé™ï¼Œå› æ­¤å¯¹äºå‰é¢çš„å‘½ä»¤ï¼Œä¸»ä½“æ‰€éœ€çš„å”¯ä¸€æƒé™æ˜¯ `s3:GetObject`
{% endhint %}

è¿˜å¯ä»¥ä½¿ç”¨**å…¶ä»–æƒé™**åˆ›å»ºé¢„ç­¾å URLï¼š
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3åŠ å¯†æœºåˆ¶

**DEKä»£è¡¨æ•°æ®åŠ å¯†å¯†é’¥**ï¼Œå®ƒæ˜¯å§‹ç»ˆç”Ÿæˆå’Œç”¨äºåŠ å¯†æ•°æ®çš„å¯†é’¥ã€‚

<details>

<summary><strong>ä½¿ç”¨S3æ‰˜ç®¡å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-S3</strong></summary>

æ­¤é€‰é¡¹éœ€è¦æœ€å°‘çš„é…ç½®ï¼Œå¹¶ä¸”æ‰€æœ‰ç”¨äºåŠ å¯†çš„å¯†é’¥ç®¡ç†éƒ½ç”±AWSç®¡ç†ã€‚æ‚¨åªéœ€è¦**ä¸Šä¼ æ•°æ®ï¼ŒS3å°†å¤„ç†å…¶ä»–æ‰€æœ‰æ–¹é¢**ã€‚S3å¸æˆ·ä¸­çš„æ¯ä¸ªå­˜å‚¨æ¡¶éƒ½åˆ†é…äº†ä¸€ä¸ªå­˜å‚¨æ¡¶å¯†é’¥ã€‚

* åŠ å¯†ï¼š
* å¯¹è±¡æ•°æ® + åˆ›å»ºçš„æ˜æ–‡DEK --> åŠ å¯†æ•°æ®ï¼ˆå­˜å‚¨åœ¨S3å†…ï¼‰
* åˆ›å»ºçš„æ˜æ–‡DEK + S3ä¸»å¯†é’¥ --> åŠ å¯†çš„DEKï¼ˆå­˜å‚¨åœ¨S3å†…ï¼‰ï¼Œæ˜æ–‡ä»å†…å­˜ä¸­åˆ é™¤
* è§£å¯†ï¼š
* åŠ å¯†çš„DEK + S3ä¸»å¯†é’¥ --> æ˜æ–‡DEK
* æ˜æ–‡DEK + åŠ å¯†æ•°æ® --> å¯¹è±¡æ•°æ®

è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**å¯†é’¥ç”±AWSç®¡ç†**ï¼ˆæ¯3å¹´ä»…è¿›è¡Œä¸€æ¬¡è½®æ¢ï¼‰ã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„å¯†é’¥ï¼Œæ‚¨å°†èƒ½å¤Ÿè½®æ¢ã€ç¦ç”¨å’Œåº”ç”¨è®¿é—®æ§åˆ¶ã€‚

</details>

<details>

<summary><strong>ä½¿ç”¨KMSæ‰˜ç®¡å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-KMS</strong></summary>

æ­¤æ–¹æ³•å…è®¸S3ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ç”Ÿæˆæ•°æ®åŠ å¯†å¯†é’¥ã€‚KMSä½¿æ‚¨èƒ½å¤Ÿæ›´çµæ´»åœ°ç®¡ç†å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç¦ç”¨ã€è½®æ¢å’Œåº”ç”¨è®¿é—®æ§åˆ¶åˆ°CMKï¼Œå¹¶ä½¿ç”¨AWS Cloud Trailæ¥é˜²æ­¢å…¶ä½¿ç”¨ã€‚

* åŠ å¯†ï¼š
* S3å‘KMS CMKè¯·æ±‚æ•°æ®å¯†é’¥
* KMSä½¿ç”¨CMKç”ŸæˆDEKæ˜æ–‡å’ŒDEKåŠ å¯†ï¼Œå¹¶å°†å®ƒä»¬å‘é€ç»™S3
* S3ä½¿ç”¨æ˜æ–‡å¯†é’¥åŠ å¯†æ•°æ®ï¼Œå­˜å‚¨åŠ å¯†æ•°æ®å’ŒåŠ å¯†å¯†é’¥ï¼Œå¹¶ä»å†…å­˜ä¸­åˆ é™¤æ˜æ–‡å¯†é’¥
* è§£å¯†ï¼š
* S3è¦æ±‚KMSè§£å¯†å¯¹è±¡çš„åŠ å¯†æ•°æ®å¯†é’¥
* KMSä½¿ç”¨CMKè§£å¯†æ•°æ®å¯†é’¥ï¼Œå¹¶å°†å…¶å‘é€å›S3
* S3è§£å¯†å¯¹è±¡æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥çš„æœåŠ¡å™¨ç«¯åŠ å¯†ï¼ŒSSE-C</strong></summary>

æ­¤é€‰é¡¹ä½¿æ‚¨æœ‰æœºä¼šæä¾›è‡ªå·±çš„ä¸»å¯†é’¥ï¼Œæ‚¨å¯èƒ½å·²ç»åœ¨AWSä¹‹å¤–ä½¿ç”¨ã€‚ç„¶åï¼Œæ‚¨æä¾›çš„å®¢æˆ·å¯†é’¥å°†ä¸æ‚¨çš„æ•°æ®ä¸€èµ·å‘é€åˆ°S3ï¼ŒS3å°†ä¸ºæ‚¨æ‰§è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* ç”¨æˆ·å°†å¯¹è±¡æ•°æ® + å®¢æˆ·å¯†é’¥å‘é€åˆ°S3
* ä½¿ç”¨å®¢æˆ·å¯†é’¥åŠ å¯†æ•°æ®ï¼Œå¹¶å­˜å‚¨åŠ å¯†æ•°æ®
* è¿˜å­˜å‚¨äº†å®¢æˆ·å¯†é’¥çš„ç›å€¼HMACå€¼ï¼Œä»¥ä¾›å°†æ¥å¯†é’¥éªŒè¯ä½¿ç”¨
* ä»å†…å­˜ä¸­åˆ é™¤å®¢æˆ·å¯†é’¥
* è§£å¯†ï¼š
* ç”¨æˆ·å‘é€å®¢æˆ·å¯†é’¥
* éªŒè¯å¯†é’¥ä¸å­˜å‚¨çš„HMACå€¼
* ç„¶åä½¿ç”¨æä¾›çš„å®¢æˆ·å¯†é’¥è§£å¯†æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨KMSçš„å®¢æˆ·ç«¯ç«¯åŠ å¯†ï¼ŒCSE-KMS</strong></summary>

ä¸SSE-KMSç±»ä¼¼ï¼Œæ­¤æ–¹æ³•ä¹Ÿä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ç”Ÿæˆæ•°æ®åŠ å¯†å¯†é’¥ã€‚ä½†æ˜¯ï¼Œè¿™æ¬¡æ˜¯é€šè¿‡å®¢æˆ·ç«¯è€Œä¸æ˜¯S3è°ƒç”¨KMSã€‚ç„¶ååœ¨å®¢æˆ·ç«¯è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå°†åŠ å¯†çš„æ•°æ®å‘é€åˆ°S3è¿›è¡Œå­˜å‚¨ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯å‘KMSè¯·æ±‚æ•°æ®å¯†é’¥
* KMSè¿”å›æ˜æ–‡DEKå’Œä½¿ç”¨CMKåŠ å¯†çš„DEK
* ä¸¤ä¸ªå¯†é’¥éƒ½è¢«å‘é€å›æ¥
* ç„¶åå®¢æˆ·ç«¯ä½¿ç”¨æ˜æ–‡DEKåŠ å¯†æ•°æ®ï¼Œå¹¶å°†åŠ å¯†æ•°æ®+åŠ å¯†çš„DEKï¼ˆä½œä¸ºS3å†…åŠ å¯†æ•°æ®çš„å…ƒæ•°æ®ï¼‰å‘é€åˆ°S3è¿›è¡Œå­˜å‚¨
* è§£å¯†ï¼š
* å°†å¸¦æœ‰åŠ å¯†çš„DEKçš„åŠ å¯†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯
* å®¢æˆ·ç«¯è¦æ±‚KMSä½¿ç”¨CMKè§£å¯†åŠ å¯†å¯†é’¥ï¼ŒKMSå°†æ˜æ–‡DEKå‘é€å›å®¢æˆ·ç«¯
* å®¢æˆ·ç«¯ç°åœ¨å¯ä»¥è§£å¯†åŠ å¯†çš„æ•°æ®

</details>

<details>

<summary><strong>ä½¿ç”¨å®¢æˆ·æä¾›çš„å¯†é’¥çš„å®¢æˆ·ç«¯ç«¯åŠ å¯†ï¼ŒCSE-C</strong></summary>

ä½¿ç”¨æ­¤æœºåˆ¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è‡ªå·±æä¾›çš„å¯†é’¥ï¼Œå¹¶ä½¿ç”¨AWS-SDKå®¢æˆ·ç«¯åœ¨å°†æ•°æ®å‘é€åˆ°S3è¿›è¡Œå­˜å‚¨ä¹‹å‰å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚

* åŠ å¯†ï¼š
* å®¢æˆ·ç«¯ç”ŸæˆDEKå¹¶åŠ å¯†æ˜æ–‡æ•°æ®
* ç„¶åï¼Œä½¿ç”¨è‡ªå®šä¹‰CMKåŠ å¯†DEK
* æäº¤åŠ å¯†æ•°æ®+åŠ å¯†çš„DEKåˆ°S3è¿›è¡Œå­˜å‚¨
* è§£å¯†ï¼š
* S3å‘é€åŠ å¯†çš„æ•°æ®å’ŒDEK
* ç”±äºå®¢æˆ·ç«¯å·²ç»æ‹¥æœ‰ç”¨äºåŠ å¯†DEKçš„CMKï¼Œå®ƒè§£å¯†DEKï¼Œç„¶åä½¿ç”¨æ˜æ–‡DEKè§£å¯†æ•°æ®

</details>

### **æšä¸¾**

å…¥ä¾µAWSç»„ç»‡çš„ä¼ ç»Ÿä¸»è¦æ–¹æ³•ä¹‹ä¸€æ˜¯é€šè¿‡å…¥ä¾µå…¬å¼€è®¿é—®çš„å­˜å‚¨æ¡¶ã€‚**æ‚¨å¯ä»¥åœ¨æ­¤é¡µé¢æ‰¾åˆ°**[**å…¬å¼€å­˜å‚¨æ¡¶æšä¸¾å·¥å…·**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**ã€‚**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name â€“-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Ownerâ€™s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### åŒæ ˆ <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨è™šæ‹Ÿä¸»æœºæ ·å¼æˆ–è·¯å¾„æ ·å¼çš„ç«¯ç‚¹åç§°æ¥è®¿é—®S3å­˜å‚¨æ¡¶çš„åŒæ ˆç«¯ç‚¹ï¼Œè¿™äº›ç«¯ç‚¹å¯¹äºé€šè¿‡IPv6è®¿é—®S3éå¸¸æœ‰ç”¨ã€‚

åŒæ ˆç«¯ç‚¹ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### ææƒ

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é¡µé¢ä¸­æŸ¥çœ‹å¦‚ä½•æ»¥ç”¨S3æƒé™ä»¥æå‡ç‰¹æƒï¼š

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### æœªç»èº«ä»½éªŒè¯çš„è®¿é—®

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3åæ¸—é€

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### æŒä¹…æ€§

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## å…¶ä»–S3æ¼æ´

### S3 HTTPç¼“å­˜æ±¡æŸ“é—®é¢˜ <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**æ ¹æ®è¿™é¡¹ç ”ç©¶**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue)ï¼Œå¯ä»¥å°†ä»»æ„å­˜å‚¨æ¡¶çš„å“åº”ç¼“å­˜ä¸ºå±äºä¸åŒå­˜å‚¨æ¡¶çš„å“åº”ã€‚è¿™å¯èƒ½è¢«æ»¥ç”¨æ¥æ›´æ”¹ä¾‹å¦‚JavaScriptæ–‡ä»¶çš„å“åº”ï¼Œå¹¶åˆ©ç”¨S3å­˜å‚¨é™æ€ä»£ç çš„ä»»æ„é¡µé¢ã€‚

## Amazon Athena

Amazon Athenaæ˜¯ä¸€ç§äº¤äº’å¼æŸ¥è¯¢æœåŠ¡ï¼Œå¯é€šè¿‡æ ‡å‡†SQLç›´æ¥åœ¨Amazon Simple Storage Serviceï¼ˆAmazon S3ï¼‰ä¸­åˆ†ææ•°æ®ã€‚

æ‚¨éœ€è¦å‡†å¤‡ä¸€ä¸ªå…·æœ‰å°†å‡ºç°åœ¨ç›‘è§†çš„S3å­˜å‚¨æ¡¶ä¸­çš„å†…å®¹æ ¼å¼çš„å…³ç³»å‹æ•°æ®åº“è¡¨ã€‚ç„¶åï¼ŒAmazon Athenaå°†èƒ½å¤Ÿä»æ—¥å¿—ä¸­å¡«å……æ•°æ®åº“ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æŸ¥è¯¢å®ƒã€‚

Amazon Athenaæ”¯æŒæŸ¥è¯¢å·²ç»åŠ å¯†çš„S3æ•°æ®çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å¦‚æœé…ç½®ä¸ºè¿™æ ·åšï¼ŒAthenaè¿˜å¯ä»¥åŠ å¯†æŸ¥è¯¢ç»“æœï¼Œç„¶åå°†å…¶å­˜å‚¨åœ¨S3ä¸­ã€‚

æŸ¥è¯¢ç»“æœçš„åŠ å¯†ä¸åº•å±‚æŸ¥è¯¢çš„S3æ•°æ®æ— å…³ï¼Œè¿™æ„å‘³ç€å³ä½¿S3æ•°æ®æœªåŠ å¯†ï¼ŒæŸ¥è¯¢ç»“æœä¹Ÿå¯ä»¥åŠ å¯†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAmazon Athenaä»…æ”¯æŒä½¿ç”¨ä»¥ä¸‹S3åŠ å¯†æ–¹æ³•åŠ å¯†çš„æ•°æ®ï¼Œå³SSE-S3ã€SSE-KMSå’ŒCSE-KMSã€‚

ä¸æ”¯æŒSSE-Cå’ŒCSE-Eã€‚æ­¤å¤–ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ï¼ŒAmazon Athenaä»…å¯¹ä¸æŸ¥è¯¢æœ¬èº«ä½äºåŒä¸€åŒºåŸŸçš„åŠ å¯†å¯¹è±¡è¿è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæ‚¨éœ€è¦æŸ¥è¯¢ä½¿ç”¨KMSåŠ å¯†çš„S3æ•°æ®ï¼Œåˆ™Athenaç”¨æˆ·éœ€è¦ç‰¹å®šçš„æƒé™æ‰èƒ½æ‰§è¡ŒæŸ¥è¯¢ã€‚

### æšä¸¾
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## å‚è€ƒèµ„æ–™

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>æ”¯æŒ HackTricks å¹¶è·å¾—ç¦åˆ©ï¼</strong></summary>

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šï¼Œæˆ–è€…å¦‚æœæ‚¨æƒ³è®¿é—® PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ PDF ç‰ˆçš„ HackTricksï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS å’Œ HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFT**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) **å’Œ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
