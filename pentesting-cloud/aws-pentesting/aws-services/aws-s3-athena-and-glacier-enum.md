# AWS - S3, Athena & Glacier Enum

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## S3

Amazon S3 is 'n diens wat jou toelaat om **groot hoeveelhede data te stoor**.

Amazon S3 bied verskeie opsies om die **beskerming** van data by rus te verseker. Die opsies sluit in **Toestemming** (Beleid), **Versleuteling** (Kli√´nt- en Bedienerkant), **Emmerversiebeheer** en **MFA-gebaseerde uitwissing**. Die **gebruiker kan enige van hierdie opsies aktiveer** om data beskerming te verseker. **Data-replikasie** is 'n interne fasiliteit deur AWS waar S3 outomaties elke voorwerp oor alle beskikbaarheidssones repliseer en die organisasie hoef dit nie in hierdie geval te aktiveer nie.

Met hulpbrongebaseerde toestemmings kan jy toestemmings vir subgidsies van jou emmer afsonderlik definieer.

### Emmerversiebeheer en MFA-gebaseerde uitwissing

Wanneer emmerversiebeheer geaktiveer is, sal enige aksie wat probeer om 'n l√™er binne 'n l√™er te wysig, 'n nuwe weergawe van die l√™er genereer, terwyl die vorige inhoud ook behou word. Dit sal dus nie die inhoud oorskryf nie.

Verder sal MFA-gebaseerde uitwissing voorkom dat weergawes van l√™ers in die S3-emmer uitgewis word en ook dat emmerversiebeheer gedeaktiveer word, sodat 'n aanvaller nie hierdie l√™ers kan wysig nie.

### S3-toegangsjoernale

Dit is moontlik om **S3-toegangsjoernale te aktiveer** (wat standaard gedeaktiveer is) vir 'n sekere emmer en die joernale in 'n ander emmer te stoor om te weet wie toegang tot die emmer verkry (beide emmers moet in dieselfde streek wees).

### S3-voorafondertekende URL's

Dit is moontlik om 'n voorafondertekende URL te genereer wat gewoonlik gebruik kan word om toegang tot die gespesifiseerde l√™er in die emmer te verkry. 'n **Voorafondertekende URL lyk soos hierdie**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
'n Voorafondertekende URL kan **geskep word vanaf die opdraglyn deur gebruik te maak van geloofsbriewe van 'n hoof met toegang tot die voorwerp** (as die rekening wat jy gebruik nie toegang het nie, sal 'n korter voorafondertekende URL geskep word, maar dit sal nutteloos wees)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Die enigste vereiste toestemming om 'n vooraf ondertekende URL te genereer, is die toestemming wat gegee word, so vir die vorige opdrag is die enigste toestemming wat deur die hoofakteur benodig word, `s3:GetObject`
{% endhint %}

Dit is ook moontlik om vooraf ondertekende URL's te skep met **ander toestemmings**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Versleutelingsmeganismes

**DEK beteken Data Encryption Key** en is die sleutel wat altyd gegenereer en gebruik word om data te versleutel.

<details>

<summary><strong>Bedienerkant-versleuteling met S3-bestuurde sleutels, SSE-S3</strong></summary>

Hierdie opsie vereis minimale konfigurasie en alle bestuur van versleutelingssleutels wat gebruik word, word deur AWS bestuur. Al wat jy hoef te doen, is om **jou data op te laai en S3 sal al die ander aspekte hanteer**. Elke emmer in 'n S3-rekening word toegewys aan 'n emmersleutel.

* Versleuteling:
* Objectdata + geskep plain text DEK --> Versleutelde data (gestoor binne S3)
* Geskep plain text DEK + S3 Meestersleutel --> Versleutelde DEK (gestoor binne S3) en plain text word uit die geheue verwyder
* Dekripsie:
* Versleutelde DEK + S3 Meestersleutel --> Plain text DEK
* Plain text DEK + Versleutelde data --> Objectdata

Let asseblief daarop dat in hierdie geval **die sleutel deur AWS bestuur word** (rotasie slegs elke 3 jaar). As jy jou eie sleutel gebruik, sal jy in staat wees om te roteer, deaktiveer en toegangskontrole toe te pas.

</details>

<details>

<summary><strong>Bedienerkant-versleuteling met KMS-bestuurde sleutels, SSE-KMS</strong></summary>

Hierdie metode stel S3 in staat om die sleutelbestuurdienste te gebruik om jou data-versleutelingssleutels te genereer. KMS gee jou 'n veel groter buigsaamheid oor hoe jou sleutels bestuur word. Byvoorbeeld, jy kan die CMK deaktiveer, roteer en toegangskontroles toepas, en teen hul gebruik beskerm deur gebruik te maak van AWS Cloud Trail.

* Versleuteling:
* S3 versoek data-sleutels van KMS CMK
* KMS gebruik 'n CMK om die paar DEK plain text en DEK versleutel te genereer en stuur dit na S3
* S3 gebruik die plain text sleutel om die data te versleutel, stoor die versleutelde data en die versleutelde sleutel en verwyder die plain text sleutel uit die geheue
* Dekripsie:
* S3 vra KMS om die versleutelde data sleutel van die objek te ontsleutel
* KMS ontsleutel die data sleutel met die CMK en stuur dit terug na S3
* S3 ontsleutel die objekdata

</details>

<details>

<summary><strong>Bedienerkant-versleuteling met kli√´ntverskafte sleutels, SSE-C</strong></summary>

Hierdie opsie gee jou die geleentheid om jou eie hoofsleutel te voorsien wat jy moontlik al buite AWS gebruik. Jou kli√´ntverskafte sleutel word dan saam met jou data na S3 gestuur, waar S3 dan die versleuteling vir jou uitvoer.

* Versleuteling:
* Die gebruiker stuur die objekdata + Kli√´nt sleutel na S3
* Die kli√´nt sleutel word gebruik om die data te versleutel en die versleutelde data word gestoor
* 'n Gesoute HMAC-waarde van die kli√´nt sleutel word ook gestoor vir toekomstige sleutelvalidering
* Die kli√´nt sleutel word uit die geheue verwyder
* Dekripsie:
* Die gebruiker stuur die kli√´nt sleutel
* Die sleutel word gevalideer teen die gestoorde HMAC-waarde
* Die kli√´ntverskafte sleutel word dan gebruik om die data te ontsleutel

</details>

<details>

<summary><strong>Kli√´ntkant-versleuteling met KMS, CSE-KMS</strong></summary>

Soortgelyk aan SSE-KMS, gebruik dit ook die sleutelbestuurdienste om jou data-versleutelingssleutels te genereer. Hierdie keer word KMS egter deur die kli√´nt en nie S3 geroep. Die versleuteling vind dan plaas aan die kli√´ntkant en die versleutelde data word dan na S3 gestuur om gestoor te word.

* Versleuteling:
* Kli√´nt versoek 'n data sleutel van KMS
* KMS stuur die plain text DEK en die versleutelde DEK met die CMK terug
* Beide sleutels word teruggestuur
* Die kli√´nt versleutel dan die data met die plain text DEK en stuur die versleutelde data + die versleutelde DEK na S3 (wat as metadata van die versleutelde data binne S3 gestoor word)
* Dekripsie:
* Die versleutelde data met die versleutelde DEK word na die kli√´nt gestuur
* Die kli√´nt vra KMS om die versleutelde sleutel met die CMK te ontsleutel en KMS stuur die plain text DEK terug
* Die kli√´nt kan nou die versleutelde data ontsleutel

</details>

<details>

<summary><strong>Kli√´ntkant-versleuteling met kli√´ntverskafte sleutels, CSE-C</strong></summary>

Met hierdie meganisme kan jy jou eie voorsiene sleutels gebruik en 'n AWS-SDK-kli√´nt gebruik om jou data te versleutel voordat dit na S3 vir berging gestuur word.

* Versleuteling:
* Die kli√´nt genereer 'n DEK en versleutel die plain text data
* Dan, deur sy eie aangepaste CMK te gebruik, versleutel hy die DEK
* Stuur die versleutelde data + versleutelde DEK na S3 waar dit gestoor word
* Dekripsie:
* S3 stuur die versleutelde data en DEK
* Aangesien die kli√´nt reeds die CMK wat gebruik is om die DEK te versleutel, het, ontsleutel hy die DEK en gebruik dan die plain text DEK om die data te ontsleutel

</details>

### **Opsomming**

Een van die tradisionele hoofmaniere om AWS-organisasies te kompromitteer, begin deur openlik toeganklike emmers te kompromitteer. **Jy kan** [**openbare emmeropsporingstoerusting op hierdie bladsy vind**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name ‚Äì-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner‚Äôs displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dubbel-stapel <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Jy kan toegang verkry tot 'n S3-emmer deur 'n dubbel-stapel eindpunt te gebruik deur 'n virtuele gehoste-styl of 'n pad-styl eindpunt naam. Dit is nuttig om toegang tot S3 te verkry deur IPv6.

Dubbel-stapel eindpunte gebruik die volgende sintaks:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Op die volgende bladsy kan jy sien hoe om S3-toestemmings te misbruik om voorregte te verhoog:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Ongeagte Toegang

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 Na-uitbuiting

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Volharding

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Ander S3 kwesbaarhede

### S3 HTTP Cache Vergiftigingsprobleem <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Volgens hierdie navorsing**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) was dit moontlik om die respons van 'n willekeurige emmer te kas asof dit aan 'n ander een behoort het. Dit kon misbruik word om byvoorbeeld javascript-l√™er-responsies te verander en willekeurige bladsye te kompromitteer deur S3 te gebruik om statiese kode te stoor.

## Amazon Athena

Amazon Athena is 'n interaktiewe navraagdiens wat dit maklik maak om data direk in Amazon Simple Storage Service (Amazon **S3**) te **analiseer deur** standaard **SQL** te gebruik.

Jy moet 'n verhoudingsdatabasis-tabel **voorberei met die formaat van die inhoud** wat in die gemonitorde S3-emmers sal verskyn. En dan sal Amazon Athena in staat wees om die databasis vanuit die logboeke te vul, sodat jy dit kan navraag.

Amazon Athena ondersteun die **vermo√´ om S3-data te ondervra wat reeds versleutel is** en as dit so gekonfigureer is, **kan Athena ook die resultate van die navraag versleutel wat dan in S3 gestoor kan word**.

**Hierdie versleuteling van resultate is onafhanklik van die onderliggende ondervraagde S3-data**, wat beteken dat selfs as die S3-data nie versleutel is nie, kan die ondervraagde resultate versleutel word. 'n Paar punte om bewus van te wees, is dat Amazon Athena slegs data ondersteun wat versleutel is met die **volgende S3-versleutelingsmetodes**, **SSE-S3, SSE-KMS, en CSE-KMS**.

SSE-C en CSE-E word nie ondersteun nie. Daarbenewens is dit belangrik om te verstaan dat Amazon Athena slegs navrae sal uitvoer teen **versleutelde voorwerpe wat in dieselfde streek as die navraag self** is. As jy S3-data wat met KMS versleutel is, wil ondervra, is spesifieke toestemmings vereis deur die Athena-gebruiker om hulle in staat te stel om die navraag uit te voer.

### Enumerasie
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Verwysings

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
