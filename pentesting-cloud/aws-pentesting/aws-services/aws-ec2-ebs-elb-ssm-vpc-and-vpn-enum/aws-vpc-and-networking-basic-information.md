# AWS - VPC & Informa√ß√µes B√°sicas de Rede

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Rede na AWS em Resumo

Um **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Esta rede VPC √© dividida em **sub-redes**, ent√£o uma **sub-rede** est√° diretamente **relacionada** com o **VPC**, **roteamento**, **tabela** e **ACL de rede**.

Ent√£o, **Interfaces de Rede** anexadas a servi√ßos (como inst√¢ncias EC2) s√£o **conectadas** √†s **sub-redes** com **grupo(s) de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das interfaces de rede **usando-o**, **independentemente da sub-rede**. E uma **ACL de rede** limitar√° as portas expostas para a **rede inteira**.

Al√©m disso, para **acessar a Internet**, existem algumas configura√ß√µes interessantes a verificar:

* Uma **sub-rede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway de Internet** precisa ser **anexado** ao **VPC**
* Voc√™ tamb√©m pode usar **gateways de Internet somente de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **sub-rede privada** para que seja poss√≠vel **conectar-se a servi√ßos externos** a partir dessa sub-rede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los de fora**.
* O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outros VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) permite que voc√™ **inicie recursos da AWS em uma rede virtual** que voc√™ definiu. Esta rede virtual ter√° v√°rias sub-redes, Gateways de Internet para acesso √† Internet, ACLs, Grupos de seguran√ßa, IPs...

### Sub-redes

Sub-redes ajudam a impor um maior n√≠vel de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda a manter uma **facilidade de gest√£o** em sua infraestrutura.

* CIDRs v√°lidos v√£o de uma m√°scara de rede /16 a uma /28.
* Uma sub-rede n√£o pode estar em zonas de disponibilidade diferentes ao mesmo tempo.
* **A AWS reserva os tr√™s primeiros endere√ßos IP de host** de cada sub-rede **para uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* S√£o chamadas **sub-redes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto sub-redes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabelas de Roteamento

Tabelas de roteamento determinam o roteamento de tr√°fego para uma sub-rede dentro de um VPC. Elas determinam qual tr√°fego de rede √© encaminhado para a internet ou para uma conex√£o VPN. Voc√™ geralmente encontrar√° acesso ao:

* VPC local
* NAT
* Gateways de Internet / Gateways de Internet somente de sa√≠da (necess√°rios para dar acesso √† Internet a um VPC).
* Para tornar uma sub-rede p√∫blica, voc√™ precisa **criar** e **anexar** um **gateway de Internet** ao seu VPC.
* Pontos de extremidade VPC (para acessar S3 de redes privadas)

Nas seguintes imagens, voc√™ pode verificar as diferen√ßas em uma rede p√∫blica padr√£o e uma privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Controle de Acesso √† Rede (ACLs)**: ACLs de rede s√£o regras de firewall que controlam o tr√°fego de rede de entrada e sa√≠da para uma sub-rede. Elas podem ser usadas para permitir ou negar tr√°fego para endere√ßos IP espec√≠ficos ou faixas.

* √â mais frequente permitir/negar acesso usando grupos de seguran√ßa, mas esta √© a √∫nica maneira de cortar completamente shells reversos estabelecidos. Uma regra modificada em um grupo de seguran√ßa n√£o interrompe conex√µes j√° estabelecidas
* No entanto, isso se aplica a toda a sub-rede, tenha cuidado ao proibir coisas porque a funcionalidade necess√°ria pode ser perturbada

### Grupos de Seguran√ßa

Grupos de seguran√ßa s√£o um **firewall virtual** que controla o tr√°fego de rede de entrada e sa√≠da para inst√¢ncias em um VPC. Rela√ß√£o 1 SG para M inst√¢ncias (geralmente 1 para 1).\
Geralmente, isso √© usado para abrir portas perigosas em inst√¢ncias, como a porta 22, por exemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Endere√ßos IP El√°sticos

Um _Endere√ßo IP El√°stico_ √© um **endere√ßo IPv4 est√°tico** projetado para computa√ß√£o em nuvem din√¢mica. Um Endere√ßo IP El√°stico √© alocado √† sua conta AWS e √© seu at√© voc√™ liber√°-lo. Ao usar um Endere√ßo IP El√°stico, voc√™ pode mascarar a falha de uma inst√¢ncia ou software remapeando rapidamente o endere√ßo para outra inst√¢ncia em sua conta.

### Conex√£o entre sub-redes

Por padr√£o, todas as sub-redes t√™m a **atribui√ß√£o autom√°tica de endere√ßos IP p√∫blicos desativada**, mas isso pode ser ativado.

**Uma rota local dentro de uma tabela de roteamento permite a comunica√ß√£o entre sub-redes VPC.**

Se voc√™ est√° **conectando uma sub-rede com uma sub-rede diferente, voc√™ n√£o pode acessar as sub-redes conectadas** com a outra sub-rede, voc√™ precisa criar conex√£o com elas diretamente. **Isso tamb√©m se aplica a gateways de Internet**. Voc√™ n√£o pode passar por uma conex√£o de sub-rede para acessar a internet, voc√™ precisa atribuir o gateway de Internet √† sua sub-rede.

### VPC Peering

O peering de VPC permite que voc√™ **conecte dois ou mais VPCs juntos**, usando IPV4 ou IPV6, como se fossem parte da mesma rede.

Uma vez que a conectividade de pares √© estabelecida, **recursos em um VPC podem acessar recursos no outro**. A conectividade entre os VPCs √© implementada atrav√©s da infraestrutura de rede existente da AWS, e por isso √© altamente dispon√≠vel sem gargalo de largura de banda. Como **conex√µes de pares operam como se fossem parte da mesma rede**, existem restri√ß√µes quando se trata de seus blocos de CIDR que podem ser usados.\
Se voc√™ tem **blocos de CIDR sobrepostos ou duplicados** para o seu VPC, ent√£o **voc√™ n√£o poder√° fazer o peering dos VPCs** juntos.\
Cada VPC da AWS **comunicar√° apenas com seu par**. Por exemplo, se voc√™ tem uma conex√£o de peering entre VPC 1 e VPC 2, e outra conex√£o entre VPC 2 e VPC 3 como mostrado, ent√£o VPC 1 e 2 poderiam se comunicar um com o outro diretamente, assim como VPC 2 e VPC 3, no entanto, VPC 1 e VPC 3 n√£o poderiam. **Voc√™ n√£o pode rotear atrav√©s de um VPC para chegar a outro.**

### **VPC Flow Logs**

Dentro do seu VPC, voc√™ pode potencialmente ter centenas ou at√© milhares de recursos todos se comunicando entre diferentes sub-redes p√∫blicas e privadas e tamb√©m entre diferentes VPCs atrav√©s de conex√µes de peering de VPC. **VPC Flow Logs permitem que voc√™ capture informa√ß√µes de tr√°fego IP que fluem entre suas interfaces de rede de seus recursos dentro do seu VPC**.

Ao contr√°rio dos logs de acesso S3 e CloudFront, os **dados de log gerados pelos VPC Flow Logs n√£o s√£o armazenados no S3. Em vez disso, os dados de log capturados s√£o enviados para os logs do CloudWatch**.

Limita√ß√µes:

* Se voc√™ est√° executando uma conex√£o peered de VPC, ent√£o voc√™ s√≥ poder√° ver os logs de fluxo de VPCs peered que est√£o dentro da mesma conta.
* Se voc√™ ainda est√° executando recursos dentro do ambiente EC2-Classic, ent√£o infelizmente voc√™ n√£o √© capaz de recuperar informa√ß√µes de suas interfaces
* Uma vez que um VPC Flow Log foi criado, ele n√£o pode ser alterado. Para alterar a configura√ß√£o do VPC Flow Log, voc√™ precisa exclu√≠-lo e depois recriar um novo.
* O seguinte tr√°fego n√£o √© monitorado e capturado pelos logs. Tr√°fego DHCP dentro do VPC, tr√°fego de inst√¢ncias destinado ao Servidor DNS da Amazon.
* Qualquer tr√°fego destinado ao endere√ßo IP do roteador padr√£o do VPC e tr√°fego para e dos seguintes endere√ßos, 169.254.169.254 que √© usado para coletar metadados da inst√¢ncia, e 169.254.169.123 que √© usado para o Servi√ßo de Sincroniza√ß√£o de Tempo da Amazon.
* Tr√°fego relacionado a uma licen√ßa de ativa√ß√£o do Windows da Amazon de uma inst√¢ncia Windows
* Tr√°fego entre uma interface de balanceador de carga de rede e uma interface de rede de ponto final

Para cada interface de rede que publica dados no grupo de logs do CloudWatch, ela usar√° um fluxo de log diferente. E dentro de cada um desses fluxos, haver√° os dados do evento de log de fluxo que mostram o conte√∫do das entradas de log. Cada um desses **logs captura dados durante uma janela de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B√°sicos da VPN da AWS

1. **Customer Gateway**:
* Um Customer Gateway √© um recurso que voc√™ cria na AWS para representar seu lado de uma conex√£o VPN.
* √â essencialmente um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-to-Site.
* Voc√™ fornece informa√ß√µes de roteamento e o endere√ßo IP p√∫blico do seu dispositivo de rede (como um roteador ou firewall) para a AWS para criar um Customer Gateway.
* Ele serve como ponto de refer√™ncia para configurar a conex√£o VPN e n√£o incorre em custos adicionais.
2. **Virtual Private Gateway**:
* Um Virtual Private Gateway (VPG) √© o concentrador VPN do lado da Amazon da conex√£o VPN Site-to-Site.
* Ele √© anexado ao seu VPC e serve como alvo para sua conex√£o VPN.
* VPG √© o ponto final do lado da AWS para a conex√£o VPN.
* Ele lida com a comunica√ß√£o segura entre o seu VPC e sua rede local.
3. **Conex√£o VPN Site-to-Site**:
* Uma conex√£o VPN Site-to-Site conecta sua rede local a um VPC atrav√©s de um t√∫nel VPN seguro, IPsec.
* Esse tipo de conex√£o requer um Customer Gateway e um Virtual Private Gateway.
* √â usado para comunica√ß√£o segura, est√°vel e consistente entre seu data center ou rede e seu ambiente AWS.
* Normalmente usado para conex√µes regulares e de longo prazo e √© cobrado com base na quantidade de dados transferidos pela conex√£o.
4. **Client VPN Endpoint**:
* Um Client VPN Endpoint √© um recurso que voc√™ cria na AWS para habilitar e gerenciar sess√µes de VPN de clientes.
* √â usado para permitir que dispositivos individuais (como laptops, smartphones, etc.) se conectem de forma segura aos recursos da AWS ou √† sua rede local.
* Difere da VPN Site-to-Site no sentido de que √© projetado para clientes individuais em vez de conectar redes inteiras.
* Com o Client VPN, cada dispositivo cliente usa um software de cliente VPN para estabelecer uma conex√£o segura.

### VPN Site-to-Site

**Conecte sua rede local com seu VPC.**

* **Conex√£o VPN**: Uma conex√£o segura entre seu equipamento local e seus VPCs.
*   **T√∫nel VPN**: Um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Customer gateway**: Um recurso da AWS que fornece informa√ß√µes √† AWS sobre o seu dispositivo de gateway do cliente.
* **Dispositivo de gateway do cliente**: Um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-to-Site.
* **Virtual private gateway**: O concentrador VPN do lado da Amazon da conex√£o VPN Site-to-Site. Voc√™ usa um virtual private gateway ou um transit gateway como o gateway para o lado da Amazon da conex√£o VPN Site-to-Site.
* **Transit gateway**: Um hub de tr√¢nsito que pode ser usado para interconectar seus VPCs e redes locais. Voc√™ usa um transit gateway ou virtual private gateway como o gateway para o lado da Amazon da conex√£o VPN Site-to-Site.

#### Limita√ß√µes

* Tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um virtual private gateway.
* Uma conex√£o VPN da AWS n√£o suporta Path MTU Discovery.

Al√©m disso, leve em considera√ß√£o o seguinte quando usar VPN Site-to-Site.

* Ao conectar seus V
