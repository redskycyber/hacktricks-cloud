# AWS - Zloupotreba Lambda ekstenzija

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Lambda Ekstenzije

Lambda ekstenzije poboljÅ¡avaju funkcije integriÅ¡uÄ‡i se sa razliÄitim **alatima za praÄ‡enje, posmatranje, bezbednost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva koriÅ¡Ä‡enjem Lambda slojeva](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili ukljuÄene u [implementacije kontejnerskih slika](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), funkcioniÅ¡u u dva moda: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa procesom izvrÅ¡avanja, manipuliÅ¡uÄ‡i njegovim pokretanjem koriÅ¡Ä‡enjem **specifiÄnih okruÅ¾nih promenljivih za jezik** i **omotaÄkih skripti**. Ova prilagoÄ‘avanja se primenjuju na razliÄite runtime-ove, ukljuÄujuÄ‡i **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.
* **Eksterni ekstenzije** se izvrÅ¡avaju kao odvojeni procesi, odrÅ¾avajuÄ‡i usklaÄ‘enost operacija sa Å¾ivotnim ciklusom Lambda funkcije. Kompatibilne su sa razliÄitim runtime-ovima poput **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **prilagoÄ‘enim runtime-ovima**.

Za viÅ¡e informacija o [**radu lambda ekstenzija proverite dokumentaciju**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterna Ekstenzija za Upornost, KraÄ‘u Zahteva i Modifikaciju Zahteva

Ovo je saÅ¾etak tehnike predloÅ¾ene u ovom postu: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Otkriveno je da je podrazumevano Linux jezgro u Lambda okruÅ¾enju za izvrÅ¡avanje kompajlirano sa "process\_vm\_readv" i "process\_vm\_writev" sistemskim pozivima. I svi procesi se izvrÅ¡avaju sa istim korisniÄkim ID-om, Äak i novi proces kreiran za eksternu ekstenziju. **To znaÄi da eksterna ekstenzija ima pun pristup Äitanju i pisanju u Rapid-ovu heap memoriju, po dizajnu.**

Osim toga, iako Lambda ekstenzije imaju moguÄ‡nost da se **pretplate na dogaÄ‘aje poziva**, AWS ne otkriva sirove podatke ovim ekstenzijama. Ovo osigurava da **ekstenzije ne mogu pristupiti osetljivim informacijama** prenetim putem HTTP zahteva.

Proces Init (Rapid) nadgleda sve API zahteve na [http://127.0.0.1:9001](http://127.0.0.1:9001/) dok se Lambda ekstenzije inicijalizuju i pokreÄ‡u pre izvrÅ¡avanja bilo kog runtime koda, ali posle Rapid-a.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Promenljiva **`AWS_LAMBDA_RUNTIME_API`** pokazuje **IP** adresu i **broj porta** Rapid API-ja **dete runtime procesima** i dodatnim ekstenzijama.

{% hint style="warning" %}
Menjanjem **`AWS_LAMBDA_RUNTIME_API`** okruÅ¾ne promenljive u **`port`** do kojeg imamo pristup, moguÄ‡e je presresti sve akcije unutar Lambda runtime-a (**Äovek-u-sredini**). Ovo je moguÄ‡e jer ekstenzija radi sa istim privilegijama kao Rapid Init, a jezgro sistema omoguÄ‡ava **modifikaciju memorije procesa**, omoguÄ‡avajuÄ‡i promenu broja porta.
{% endhint %}

Zato Å¡to **ekstenzije rade pre bilo kog runtime koda**, modifikacija okruÅ¾ne promenljive Ä‡e uticati na proces runtime-a (npr. Python, Java, Node, Ruby) prilikom pokretanja. Nadalje, **ekstenzije uÄitane nakon** naÅ¡e, koje se oslanjaju na ovu promenljivu, takoÄ‘e Ä‡e prolaziti kroz naÅ¡u ekstenziju. Ova postavka bi mogla omoguÄ‡iti malveru da potpuno zaobiÄ‘e sigurnosne mere ili ekstenzije za beleÅ¾enje direktno unutar okruÅ¾enja za izvrÅ¡avanje.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Alat [**lambda-spy**](https://github.com/clearvector/lambda-spy) je kreiran da izvrÅ¡i tu **modifikaciju memorije** i **ukrade osetljive informacije** iz lambda zahteva, drugih **ekstenzija zahteve** i Äak ih **modifikuje**.

## Reference

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
