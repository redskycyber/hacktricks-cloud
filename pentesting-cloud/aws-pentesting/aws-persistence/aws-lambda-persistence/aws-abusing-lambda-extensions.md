# AWS - Abusando de las extensiones de Lambda

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Extensiones de Lambda

Las extensiones de Lambda te permiten aumentar tus funciones. Por ejemplo, puedes usar extensiones para integrar tus funciones con tus herramientas preferidas de monitoreo, observabilidad, seguridad y gobernanza. Agregas extensiones a los archivos .zip de las funciones usando [capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), o las incluyes en la imagen para [funciones implementadas como im谩genes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* Las **extensiones internas** se ejecutan como **parte** del proceso de **tiempo de ejecuci贸n**, **en proceso** con tu c贸digo. Te permiten modificar el **inicio del proceso de tiempo de ejecuci贸n** usando variables de entorno espec铆ficas del lenguaje y scripts de envoltura. Las extensiones internas permiten casos de uso como la instrumentaci贸n autom谩tica de c贸digo.
* Las **extensiones externas** te permiten **ejecutar procesos separados** del tiempo de ejecuci贸n pero a煤n dentro del **mismo entorno de ejecuci贸n** que la funci贸n Lambda. Las extensiones externas pueden **iniciarse antes del proceso de tiempo de ejecuci贸n**, y pueden **continuar despu茅s de que el tiempo de ejecuci贸n** se detenga. Las extensiones externas permiten casos de uso como la obtenci贸n de secretos antes de la invocaci贸n, o el env铆o de telemetr铆a a un destino personalizado fuera de la invocaci贸n de la funci贸n. Estas extensiones se ejecutan como procesos compa帽eros de las funciones Lambda.

Para obtener m谩s informaci贸n sobre [**c贸mo funcionan las extensiones de Lambda, consulta la documentaci贸n**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extensi贸n externa para persistencia, robo de solicitudes y modificaci贸n de solicitudes

**Esto ser谩 un resumen de la t茅cnica propuesta en esta publicaci贸n:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

Los investigadores descubrieron que el kernel de Linux predeterminado en el entorno de tiempo de ejecuci贸n de Lambda se compila con las llamadas al sistema "process_vm_readv" y "process_vm_writev". Y todos los procesos se ejecutan con el mismo ID de usuario, incluso el nuevo proceso creado para la extensi贸n externa. **Esto significa que una extensi贸n externa tiene acceso completo de lectura y escritura a la memoria heap de Rapid, por dise帽o.**

Adem谩s, las **extensiones** de Lambda pueden **suscribirse** a los **eventos de invocaci贸n**; sin embargo, AWS no expone los datos en bruto a la extensi贸n. Por lo tanto, la extensi贸n no podr谩 recopilar informaci贸n confidencial enviada en la solicitud HTTP.

El proceso **Init** (Rapid) escucha todas las solicitudes de API en **http://127.0.0.1:9001**. Las **extensiones** de Lambda se cargan y se **ejecutan** antes de cualquier c贸digo de tiempo de ejecuci贸n, pero **despu茅s de Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

La **variable** llamada "**AWS\_LAMBDA\_RUNTIME\_API**" **informa** a los procesos secundarios de **tiempo de ejecuci贸n** y otras extensiones de la **direcci贸n IP y el n煤mero de puerto de la API de Rapid**.

{% hint style="warning" %}
**Sobrescribir** esta variable de entorno con un **n煤mero de puerto que controlemos** nos permitir谩 **interceptar toda la actividad** dentro del tiempo de ejecuci贸n de Lambda.\
Y debido a que el kernel se compila con esas llamadas al sistema y la **extensi贸n** se **ejecuta** con el **mismo ID de usuario** que Rapid Init, es posible **sobrescribir** la **memoria del proceso** y **cambiar el puerto**.
{% endhint %}

Dado que las **extensiones se ejecutan antes de cualquier c贸digo de tiempo de ejecuci贸n**, la **variable de entorno actualizada tendr谩 efecto cuando se ejecute el proceso de tiempo de ejecuci贸n** (Python, Java, Node, Ruby, etc.). Adem谩s, cualquier extensi贸n que se cargue despu茅s de la nuestra y use esta variable, tambi茅n se proxy a trav茅s de nuestra extensi贸n. Esto podr铆a permitir que el malware **desactive completamente los productos de seguridad o las extensiones de registro desde el propio tiempo de ejecuci贸n**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

La herramienta [**lambda-spy**](https://github.com/clearvector/lambda-spy) fue creada para realizar esa **escritura de memoria** y **robar informaci贸n confidencial** de las solicitudes de lambda, otras **solicitudes de extensiones** e incluso **modificarlas**.