# AWS - Persistencia de Lambda

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Lambda

Para obtener m谩s informaci贸n, consulta:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Persistencia de capa Lambda

Es posible **introducir/crear una capa para ejecutar c贸digo arbitrario** cuando se ejecuta la lambda de manera sigilosa:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Persistencia de extensi贸n Lambda

Abusando de las capas Lambda, tambi茅n es posible abusar de las extensiones y persistir en la lambda, as铆 como robar y modificar solicitudes.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### A trav茅s de pol铆ticas de recursos

Es posible otorgar acceso a diferentes acciones de lambda (como invocar o actualizar c贸digo) a cuentas externas:

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Versiones, Alias y Pesos

Una Lambda puede tener **diferentes versiones** (con un c贸digo diferente en cada versi贸n).\
Luego, puedes crear **diferentes alias con diferentes versiones** de la lambda y asignar diferentes pesos a cada una.\
De esta manera, un atacante podr铆a crear una **versi贸n 1 con puerta trasera** y una **versi贸n 2 con solo el c贸digo leg铆timo** y **solo ejecutar la versi贸n 1 en el 1%** de las solicitudes para mantenerse sigiloso.

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### Puerta trasera de versi贸n + API Gateway

1. Copia el c贸digo original de la Lambda.
2. **Crea una nueva versi贸n con una puerta trasera** del c贸digo original (o solo con c贸digo malicioso). Publica y **implementa esa versi贸n** en $LATEST.
1. Llama a la API Gateway relacionada con la lambda para ejecutar el c贸digo.
3. **Crea una nueva versi贸n con el c贸digo original**, publica e implementa esa **versi贸n** en $LATEST.
1. Esto ocultar谩 el c贸digo con puerta trasera en una versi贸n anterior.
4. Ve a la API Gateway y **crea un nuevo m茅todo POST** (o elige cualquier otro m茅todo) que ejecutar谩 la versi贸n con puerta trasera de la lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Toma nota del :1 final del arn **que indica la versi贸n de la funci贸n** (la versi贸n 1 ser谩 la que tiene la puerta trasera en este escenario).
5. Selecciona el m茅todo POST creado y en Acciones selecciona **`Implementar API`**.
6. Ahora, cuando **llames a la funci贸n a trav茅s de POST, se invocar谩 tu puerta trasera**.

### Actuador Cron/Evento

El hecho de que puedas hacer que las **funciones lambda se ejecuten cuando algo sucede o cuando pasa cierto tiempo** hace que lambda sea una forma agradable y com煤n de obtener persistencia y evitar la detecci贸n.\
Aqu铆 tienes algunas ideas para hacer que tu **presencia en AWS sea m谩s sigilosa creando lambdas**.

* Cada vez que se crea un nuevo usuario, la lambda genera una nueva clave de usuario y la env铆a al atacante.
* Cada vez que se crea un nuevo rol, la lambda otorga permisos de asumir el rol a usuarios comprometidos.
* Cada vez que se generan nuevos registros de cloudtrail, eliminar/alterarlos

<details>

<summary><strong>隆Apoya a HackTricks y obt茅n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop).
* Obt茅n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
